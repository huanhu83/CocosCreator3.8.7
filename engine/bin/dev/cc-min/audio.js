System.register(["./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js","./node-event-BDYemSfE.js","./scene-D5fG1En6.js","./prefab-CJahvMeV.js","./pipeline-state-manager-C4BAah3w.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./touch-Ch03mDFP.js","./debug-view-zRQBd5E1.js","./deprecated-BaebfHhU.js"],(function(t){"use strict";var e,n,i,o,r,u,a,s,c,d,h,l,f,p,_,y,v,m,g,E,T,P,N,I,A,w,D;return{setters:[function(t){e=t.a,n=t.Z,i=t.a3,o=t.O,r=t.b,u=t.n,a=t.w,s=t.F,c=t._,d=t.I,h=t.k},function(t){l=t.b,f=t.P,p=t.c,_=t.a,y=t.I,v=t.s,m=t.t,g=t.r,E=t.q},function(t){T=t.g,P=t.G},null,null,function(t){N=t.c},function(t){I=t.A,A=t.C},function(t){w=t.m,D=t.n},null,null,null,null,null,null,null],execute:function(){var O,S,R;!function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(O||(O={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(S||(S={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(R||(R={}));var C=t("AudioPCMDataView",function(){function t(){this._bufferView=void 0,this._normalizeFactor=1;for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(2===e.length)this._bufferView=e[0],this._normalizeFactor=e[1];else{var i=e[0],o=e[1],r=e[2];this._bufferView=new o(i),this._normalizeFactor=r}}return t.prototype.getData=function(t){return this._bufferView[t]*this._normalizeFactor},e(t,[{key:"length",get:function(){return this._bufferView.length}}]),t}());function k(t){for(var e=t._operationQueue.length,n=t._operationQueue.slice(),i=[],o=!1,r=e-1;r>=0;r--){var u=n[r];if("stop"===u.op){i.push(u);break}if("seek"===u.op)o||(i.push(u),o=!0);else{if(o){i.push(u);break}0===i.length&&i.push(u)}}t._operationQueue=i.reverse()}var L,b=0;function B(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString()),t._eventTarget.off(e.id.toString()),k(t);var n=t._operationQueue[0];n&&B(t,n)})).catch((function(){})))}function U(t,e,n){var i=n.value;n.value=function(){for(var t=this,n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return new Promise((function(n){var r=b++,u=t;u._operationQueue.push({op:e,id:r,func:i,args:o,invoking:!1}),u._eventTarget.once(r.toString(),n),B(u,u._operationQueue[0])}))}}function M(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function n(){t.play().then((function(){null==i||i.removeEventListener("touchend",n,{capture:!0}),null==i||i.removeEventListener("mouseup",n,{capture:!0})})).catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{capture:!0}),null==i||i.addEventListener("mouseup",n,{capture:!0})})),null)}))}var x,G,j=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var n=t.prototype;return n.play=function(){var t=this;M(this._domAudio).then((function(){null==t.onPlay||t.onPlay()})).catch((function(){}))},n.stop=function(){this._domAudio.pause()},e(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),V=(L=function(){function t(t){var e=this;this._domAudio=void 0,this._state=R.INIT,this._onEnded=void 0,this._eventTarget=new u,this._operationQueue=[],this._domAudio=t,T.on(P.EVENT_PAUSE,this._onInterruptedBegin,this),T.on(P.EVENT_RESUME,this._onInterruptedEnd,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=R.INIT,e._eventTarget.emit(O.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var r=t.prototype;return r.destroy=function(){T.off(P.EVENT_PAUSE,this._onInterruptedBegin,this),T.off(P.EVENT_RESUME,this._onInterruptedEnd,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n,i){t.loadNative(e).then((function(e){n(new t(e))})).catch(i)}))},t.loadNative=function(t){return new Promise((function(e,r){var u=document.createElement("audio"),a="canplaythrough";n.os===i.IOS?a="loadedmetadata":n.browserType===o.FIREFOX&&(a="canplay");var s=setTimeout((function(){0===u.readyState?h():d()}),8e3),c=function(){clearTimeout(s),u.removeEventListener(a,d,!1),u.removeEventListener("error",h,!1)},d=function(){c(),e(u)},h=function(){c(),r(new Error("load audio failure - "+t))};u.addEventListener(a,d,!1),u.addEventListener("error",h,!1),u.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,o){t.loadNative(e).then((function(t){var e=new j(t,n);i(e)})).catch(o)}))},r._onInterruptedBegin=function(){var t=this;this._state===R.PLAYING&&this.pause().then((function(){t._state=R.INTERRUPTED,t._eventTarget.emit(O.INTERRUPTION_BEGIN)})).catch((function(){}))},r._onInterruptedEnd=function(){var t=this;this._state===R.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(O.INTERRUPTION_END)})).catch((function(){}))},r.getPCMData=function(){},r.seek=function(t){return t=l(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},r.play=function(){var t=this;return new Promise((function(e){M(t._domAudio).then((function(){t._state=R.PLAYING,e()})).catch((function(){}))}))},r.pause=function(){return this._domAudio.pause(),this._state=R.PAUSED,Promise.resolve()},r.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=R.STOPPED,e()}))},r.onInterruptionBegin=function(t){this._eventTarget.on(O.INTERRUPTION_BEGIN,t)},r.offInterruptionBegin=function(t){this._eventTarget.off(O.INTERRUPTION_BEGIN,t)},r.onInterruptionEnd=function(t){this._eventTarget.on(O.INTERRUPTION_END,t)},r.offInterruptionEnd=function(t){this._eventTarget.off(O.INTERRUPTION_END,t)},r.onEnded=function(t){this._eventTarget.on(O.ENDED,t)},r.offEnded=function(t){this._eventTarget.off(O.ENDED,t)},e(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return S.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=f(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}},{key:"sampleRate",get:function(){return 0}}]),t}(),r(L.prototype,"seek",[U],Object.getOwnPropertyDescriptor(L.prototype,"seek"),L.prototype),r(L.prototype,"play",[U],Object.getOwnPropertyDescriptor(L.prototype,"play"),L.prototype),r(L.prototype,"pause",[U],Object.getOwnPropertyDescriptor(L.prototype,"pause"),L.prototype),r(L.prototype,"stop",[U],Object.getOwnPropertyDescriptor(L.prototype,"stop"),L.prototype),L),Y=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var n=t.prototype;return n.destroy=function(){this._nativeAudio=void 0},n._now=function(){return performance.now()/1e3},n._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},n.start=function(){this._isPaused=!1,this._startTime=this._now()},n.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},n.stop=function(){this._isPaused=!0,this._startOffset=0},n.seek=function(t){this._startTime=this._now(),this._startOffset=l(t,0,this.duration)},e(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),Q=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?a(5204,t):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:a(5203,t)},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:a(5203,t)},t}()),K=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,W="on-context-running",F=function(){function t(){var t=this;this._eventTarget=void 0,this._context=void 0,this._isRunning=!1,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),this._eventTarget=new u,this._context.onstatechange=function(){"running"===t._context.state?(t._isRunning=!0,t._eventTarget.emit(W)):t._isRunning=!1}}var n=t.prototype;return n.onceRunning=function(t,e){this._eventTarget.once(W,t,e)},n.offRunning=function(t,e){this._eventTarget.off(W,t,e)},n.decodeAudioData=function(t){var e=this;return new Promise((function(n,i){var o=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==o||o.catch(i)}))},n.runContext=function(){var t=this;return new Promise((function(e){if(t.isRunning)e();else{var n=t._context;if(n.resume){if("suspended"===n.state)n.resume().catch((function(t){s("runContext error",t)}));else if("running"===n.state)return void e();var i=document.getElementById("GameCanvas"),o=function t(){n.resume().then((function(){null==i||i.removeEventListener("touchend",t,{capture:!0}),null==i||i.removeEventListener("mouseup",t,{capture:!0}),e()})).catch((function(t){s("onGesture resume error",t)}))};null==i||i.addEventListener("touchend",o,{capture:!0}),null==i||i.addEventListener("mouseup",o,{capture:!0})}else e()}}))},n.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},n.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},n.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},n.connectContext=function(t){this._context&&t.connect(this._context.destination)},e(t,[{key:"isRunning",get:function(){return this._isRunning}},{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();F.support=!!K,F.support&&(G=new F);var z,q,X,H,Z=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=G.createBufferSource(t,!1);var i=G.createGain(e);this._bufferSourceNode.connect(i),G.connectContext(i)}var n=t.prototype;return n.play=function(){var t=this;this._bufferSourceNode.start(),G.runContext().then((function(){null==t.onPlay||t.onPlay(),t._currentTimer=window.setTimeout((function(){Q.tryReleasingCache(t._url),null==t.onEnd||t.onEnd()}),1e3*t._duration)})).catch((function(t){s("play error",t)}))},n.stop=function(){clearTimeout(this._currentTimer),Q.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.disconnect(),this._bufferSourceNode.buffer=null},e(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),J=(x=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=R.INIT,this._audioTimer=void 0,this._runningCallback=void 0,this._eventTarget=new u,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new Y(t),this._gainNode=G.createGain(),G.connectContext(this._gainNode),this._src=e,T.on(P.EVENT_PAUSE,this._onInterruptedBegin,this),T.on(P.EVENT_RESUME,this._onInterruptedEnd,this)}var n=t.prototype;return n.destroy=function(){window.clearTimeout(this._currentTimer),this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),Q.tryReleasingCache(this._src),T.off(P.EVENT_PAUSE,this._onInterruptedBegin,this),T.off(P.EVENT_RESUME,this._onInterruptedEnd,this),this.offRunning()},t.load=function(e){return new Promise((function(n,i){t.loadNative(e).then((function(i){n(new t(i,e))})).catch(i)}))},t.loadNative=function(t){return new Promise((function(e,n){var i=Q.getCache(t);if(i)return Q.retainCache(t),void e(i);var o=new XMLHttpRequest,r="load audio failed: "+t+", status: ";o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){200===o.status||0===o.status?G.decodeAudioData(o.response).then((function(n){Q.addCache(t,n),e(n)})).catch((function(e){s("loadNative error",t,e)})):n(new Error(""+r+o.status+"(no response)"))},o.onerror=function(){n(new Error(""+r+o.status+"(error)"))},o.ontimeout=function(){n(new Error(""+r+o.status+"(time out)"))},o.onabort=function(){n(new Error(""+r+o.status+"(abort)"))},o.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,o){t.loadNative(e).then((function(t){var o=new Z(t,n,e);i(o)})).catch(o)}))},n.getPCMData=function(t){return new C(this._audioBuffer.getChannelData(t),1)},n._onInterruptedBegin=function(){var t=this;this._state===R.PLAYING&&this.pause().then((function(){t._state=R.INTERRUPTED,t._eventTarget.emit(O.INTERRUPTION_BEGIN)})).catch((function(t){s("_onInterruptedBegin error",t)}))},n._onInterruptedEnd=function(){var t=this;this._state===R.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(O.INTERRUPTION_END)})).catch((function(t){s("_onInterruptedEnd error",t)}))},n.offRunning=function(){this._runningCallback&&(G.offRunning(this._runningCallback),this._runningCallback=void 0)},n.seek=function(t){var e=this;return new Promise((function(n){e.offRunning(),e._audioTimer.seek(t),e._state===R.PLAYING?e._doPlay().then(n).catch((function(t){s("seek error",t)})):n()}))},n.play=function(){return this.offRunning(),this._doPlay()},n._doPlay=function(){var t=this;return new Promise((function(e){G.isRunning?(t._startSourceNode(),e()):(t.offRunning(),t._runningCallback=function(){t._startSourceNode(),e()},G.onceRunning(t._runningCallback),G.runContext().catch((function(t){s("doPlay error",t)})))}))},n._startSourceNode=function(){var t=this;this._stopSourceNode(),this._sourceNode=G.createBufferSource(this._audioBuffer,this.loop),this._sourceNode.connect(this._gainNode),this._sourceNode.loop=this._loop,this._sourceNode.start(0,this._audioTimer.currentTime),this._state=R.PLAYING,this._audioTimer.start(),window.clearTimeout(this._currentTimer),this._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(O.ENDED),t._state=R.INIT)}),1e3*(this._audioBuffer.duration-this._audioTimer.currentTime))},n._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.disconnect(),this._sourceNode.buffer=null,this._sourceNode=void 0)}catch(t){}},n.pause=function(){return this.offRunning(),this._state===R.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=R.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},n.stop=function(){return this.offRunning(),this._sourceNode?(this._audioTimer.stop(),this._state=R.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):(this._audioTimer.stop(),this._state=R.STOPPED,Promise.resolve())},n.onInterruptionBegin=function(t){this._eventTarget.on(O.INTERRUPTION_BEGIN,t)},n.offInterruptionBegin=function(t){this._eventTarget.off(O.INTERRUPTION_BEGIN,t)},n.onInterruptionEnd=function(t){this._eventTarget.on(O.INTERRUPTION_END,t)},n.offInterruptionEnd=function(t){this._eventTarget.off(O.INTERRUPTION_END,t)},n.onEnded=function(t){this._eventTarget.on(O.ENDED,t)},n.offEnded=function(t){this._eventTarget.off(O.ENDED,t)},e(t,[{key:"sampleRate",get:function(){return this._audioBuffer.sampleRate}},{key:"src",get:function(){return this._src}},{key:"type",get:function(){return S.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=f(t),this._volume=t,G.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}(),r(x.prototype,"seek",[U],Object.getOwnPropertyDescriptor(x.prototype,"seek"),x.prototype),r(x.prototype,"play",[U],Object.getOwnPropertyDescriptor(x.prototype,"play"),x.prototype),r(x.prototype,"pause",[U],Object.getOwnPropertyDescriptor(x.prototype,"pause"),x.prototype),r(x.prototype,"stop",[U],Object.getOwnPropertyDescriptor(x.prototype,"stop"),x.prototype),x),$=function(){function t(t){this._audio=void 0,this._audio=t}var n=t.prototype;return n.play=function(){this._audio.play()},n.stop=function(){this._audio.stop()},e(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),tt=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i,o){(null==n?void 0:n.audioLoadMode)!==S.DOM_AUDIO&&F.support?J.load(e).then((function(e){i(new t(e))})).catch(o):(F.support||a(5201),V.load(e).then((function(e){i(new t(e))})).catch(o))}))};var n=t.prototype;return n.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==S.DOM_AUDIO&&F.support?J.loadNative(t):(F.support||a(5201),V.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,o){(null==n?void 0:n.audioLoadMode)!==S.DOM_AUDIO&&F.support?J.loadOneShotAudio(t,e).then((function(t){i(new $(t))})).catch(o):(F.support||a(5201),V.loadOneShotAudio(t,e).then((function(t){i(new $(t))})).catch(o))}))},n.getPCMData=function(t){return this._player.getPCMData(t)},n.seek=function(t){return this._player.seek(t)},n.play=function(){return this._player.play()},n.pause=function(){return this._player.pause()},n.stop=function(){return this._player.stop()},n.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},n.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},n.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},n.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},n.onEnded=function(t){this._player.onEnded(t)},n.offEnded=function(t){this._player.offEnded(t)},e(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}},{key:"sampleRate",get:function(){return this._player.sampleRate}}]),t}();tt.maxAudioChannel=24;var et=t("AudioClip",p("cc.AudioClip")((H=function(t){function n(e){var n;return(n=t.call(this,e)||this)._duration=X&&X(),n._loadMode=S.UNKNOWN_AUDIO,n._meta=null,n._player=null,n}c(n,t);var i=n.prototype;return i.destroy=function(){var e,n=t.prototype.destroy.call(this);return null==(e=this._player)||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},i.validate=function(){return!!this._meta},i.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},i.getCurrentTime=function(){return this._player?this._player.currentTime:0},i.getVolume=function(){return this._player?this._player.volume:0},i.getLoop=function(){return!!this._player&&this._player.loop},i.setCurrentTime=function(t){var e;null==(e=this._player)||e.seek(t).catch((function(){}))},i.setVolume=function(t){this._player&&(this._player.volume=t)},i.setLoop=function(t){this._player&&(this._player.loop=t)},i.play=function(){var t;null==(t=this._player)||t.play().catch((function(){}))},i.pause=function(){var t;null==(t=this._player)||t.pause().catch((function(){}))},i.stop=function(){var t;null==(t=this._player)||t.stop().catch((function(){}))},i.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&tt.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},e(n,[{key:"duration",set:function(t){this._duration=t}},{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=S.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:R.INIT}}]),n}(I),H.AudioType=S,X=_((q=H).prototype,"_duration",[v],(function(){return 0})),r(q.prototype,"_nativeDep",[y],Object.getOwnPropertyDescriptor(q.prototype,"_nativeDep"),q.prototype),z=q))||z);function nt(t,e,n){tt.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function it(t,e,n,i){var o=new et;o._nativeUrl=t,o._nativeAsset=e,o.duration=e.duration,i(null,o)}N.AudioClip=et,w.register({".mp3":nt,".ogg":nt,".wav":nt,".m4a":nt}),D.register({".mp3":it,".ogg":it,".wav":it,".m4a":it});var ot,rt,ut,at,st,ct,dt,ht,lt,ft,pt,_t,yt=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);if(n>-1)return t[n].playTime=performance.now(),!1;var i={audio:e,playTime:performance.now()};return t.push(i),!0},e.addPlaying=function(t){t instanceof tt?this._tryAddPlaying(this._audioPlayerInfoList,t):this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(d(t,n),!0)},e.removePlaying=function(t){t instanceof tt?this._tryRemovePlaying(this._audioPlayerInfoList,t):this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<tt.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},e.pause=function(){this._oneShotAudioInfoList.forEach((function(t){t.audio.stop()})),this._audioPlayerInfoList.forEach((function(t){t.audio.pause().catch((function(){}))}))},e.resume=function(){this._audioPlayerInfoList.forEach((function(t){t.audio.play().catch((function(){}))}))},t}()),vt="audiosource-loaded";!function(t){t.STARTED="started",t.ENDED="ended"}(pt||(pt={})),function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.SEEK="seek"}(_t||(_t={}));var mt=(ot=p("cc.AudioSource"),rt=m(et),ut=m(et),ot((ft=function(t){function n(){var e;return(e=t.call(this)||this)._clip=ct&&ct(),e._player=null,e._hasRegisterListener=!1,e._loop=dt&&dt(),e._playOnAwake=ht&&ht(),e._volume=lt&&lt(),e._cachedCurrentTime=-1,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}c(n,t);var i=n.prototype;return i._resetPlayer=function(){this._player&&(yt.removePlaying(this._player),this._unregisterListener(),this._player.destroy(),this._player=null)},i._syncPlayer=function(){var t=this,e=this._clip;if(this._lastSetClip!==e)return e?void(e._nativeAsset?(this._isLoaded=!1,this._lastSetClip=e,this._operationsBeforeLoading.length=0,tt.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){var i;t._lastSetClip===e?(t._isLoaded=!0,t._resetPlayer(),t._player=n,t._syncStates(),null==(i=t.node)||i.emit(vt)):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip")):(this._lastSetClip=null,void this._resetPlayer())},i._registerListener=function(){var t=this;if(!this._hasRegisterListener&&this._player){var e=this._player;e.onEnded((function(){var n;yt.removePlaying(e),null==(n=t.node)||n.emit(pt.ENDED,t)})),e.onInterruptionBegin((function(){yt.removePlaying(e)})),e.onInterruptionEnd((function(){t._player===e&&yt.addPlaying(e)})),this._hasRegisterListener=!0}},i._unregisterListener=function(){this._player&&this._hasRegisterListener&&(this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._hasRegisterListener=!1)},i.onLoad=function(){this._syncPlayer()},i.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},i.onDisable=function(){var t=this._getRootNode();null!=t&&t._persistNode||this.pause()},i.onDestroy=function(){this.stop(),this.clip=null},i.getPCMData=function(t){var e=this;return new Promise((function(n){if(0!==t&&1!==t)return s("Only support channel index 0 or 1 to get buffer"),void n(void 0);var i;e._player?n(e._player.getPCMData(t)):null==(i=e.node)||i.once(vt,(function(){var i;n(null==(i=e._player)?void 0:i.getPCMData(t))}))}))},i.getSampleRate=function(){var t=this;return new Promise((function(e){var n;t._player?e(t._player.sampleRate):null==(n=t.node)||n.once(vt,(function(){e(t._player.sampleRate)}))}))},i._getRootNode=function(){for(var t,e,n=this.node,i=null==(t=n)||null==(e=t.parent)?void 0:e.parent;i;){var o,r,u;i=null==(r=n=null==(o=n)?void 0:o.parent)||null==(u=r.parent)?void 0:u.parent}return n},i.play=function(){var t=this;if(this._isLoaded||!this.clip){var e;this._registerListener(),yt.discardOnePlayingIfNeeded(),this.state===R.PLAYING&&(null==(e=this._player)||e.stop().catch((function(){})));var n=this._player;n&&(n.play().then((function(){var e;null==(e=t.node)||e.emit(pt.STARTED,t)})).catch((function(){yt.removePlaying(n)})),yt.addPlaying(n))}else this._operationsBeforeLoading.push({op:_t.PLAY,params:null})},i.pause=function(){var t;this._isLoaded||!this.clip?null==(t=this._player)||t.pause().catch((function(){})):this._operationsBeforeLoading.push({op:_t.PAUSE,params:null})},i.stop=function(){this._isLoaded||!this.clip?this._player&&(this._player.stop().catch((function(){})),yt.removePlaying(this._player)):this._operationsBeforeLoading.push({op:_t.STOP,params:null})},i.playOneShot=function(t,e){var n;void 0===e&&(e=1),t._nativeAsset?tt.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){n=t,yt.discardOnePlayingIfNeeded(),t.onEnd=function(){yt.removePlaying(t)},t.play(),yt.addPlaying(t)})).catch((function(){n&&yt.removePlaying(n)})):console.error("Invalid audio clip")},i._syncStates=function(){var t=this;this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((function(e){var n;e.op===_t.SEEK?(t._cachedCurrentTime=e.params&&e.params[0],t._player&&t._player.seek(t._cachedCurrentTime).catch((function(){}))):null==(n=t[e.op])||n.call(t)})),this._operationsBeforeLoading.length=0)},e(n,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?s("illegal audio volume!"):(t=l(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime<0?0:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?s("illegal audio time!"):(t=l(t,0,this.duration),this._isLoaded||!this.clip?(this._cachedCurrentTime=t,null==(e=this._player)||e.seek(this._cachedCurrentTime).catch((function(){}))):this._operationsBeforeLoading.push({op:_t.SEEK,params:[t]}))}},{key:"duration",get:function(){var t,e;return null!==(t=null==(e=this._clip)?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:R.INIT}},{key:"playing",get:function(){return this.state===n.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return tt.maxAudioChannel}}]),n}(A),ft.AudioState=R,ft.EventType=pt,ct=_((st=ft).prototype,"_clip",[rt],(function(){return null})),dt=_(st.prototype,"_loop",[v],(function(){return!1})),ht=_(st.prototype,"_playOnAwake",[v],(function(){return!0})),lt=_(st.prototype,"_volume",[v],(function(){return 1})),r(st.prototype,"clip",[ut],Object.getOwnPropertyDescriptor(st.prototype,"clip"),st.prototype),at=st))||at);t({AudioSource:mt,AudioSourceComponent:mt}),g(et,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:mt,targetName:"AudioSource"}]),E(et.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),N.AudioSourceComponent=mt,h(mt,"cc.AudioSourceComponent")}}}));
//# sourceMappingURL=audio.js.map
