System.register(["./index-aAbfWlxb.js","./_virtual_internal_constants-CVZmBipG.js","./debug-view-zRQBd5E1.js","./deprecated-BaebfHhU.js","./scene-D5fG1En6.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./index-BcjqSS2q.js","./gc-object-BD6DANSw.js","./node-event-BDYemSfE.js","./pipeline-state-manager-C4BAah3w.js","./global-exports-ZavlJGEN.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./prefab-CJahvMeV.js","./camera-component-DK1ym1MK.js","./deprecated-B2PZGYTz.js","./model-renderer-KnEZ5pPV.js","./renderer-DVTO-7-w.js","./deprecated-BfPl6EQ2.js","./zlib.min-CyXMsivM.js","./render-types-DTmbYHic.js","./touch-Ch03mDFP.js"],(function(e){"use strict";var t,a,r,s,i,n,o,l,h,p,u,c,d,m,f,P,g,S,y,_,v,w,b,R,C,N,T,O,A,E,x,k,D,B,M,I,F,V,L,j,G,H,U,z,X,J,Q,W,Y,K,q,Z,$,ee,te,ae,re,se,ie,ne,oe,le,he,pe,ue,ce,de,me,fe;return{setters:[function(e){t=e.S,a=e.L,r=e.g,s=e.R,i=e.Q,n=e.a,o=e.b,l=e.s},function(e){h=e.E},function(e){p=e.S,u=e.R,c=e.x,d=e.v,m=e.C,f=e.P},null,function(e){P=e.b,g=e.w,S=e.M,y=e.d,_=e.i,v=e.P,w=e.I,b=e.j,R=e.W,C=e.F},null,function(e){N=e.C,T=e.ab,O=e.ac,A=e.bo,E=e.F,x=e.aP,k=e.y,D=e.ad,B=e.v,M=e.ae},function(e){I=e._,F=e.G,V=e.g,L=e.o,j=e.c,G=e.K,H=e.d,U=e.a,z=e.p,X=e.s,J=e.V,Q=e.M,W=e.t,Y=e.b,K=e.h,q=e.f,Z=e.u},function(e){$=e.a,ee=e.z,te=e._,ae=e.j,re=e.b,se=e.F,ie=e.o,ne=e.C,oe=e.m,le=e.w},function(e){he=e.C},function(e){pe=e.F},function(e){ue=e.c},function(e){ce=e.g},function(e){de=e.d},null,function(e){me=e.P,fe=e.C},null,null,null,null,null,null,null],execute:function(){var Pe=I.create(0,0,0,1),ge=new F,Se=new F(0,0,0,.5,.5,.5),ye=new(function(){function e(){this.clearFlag=N.COLOR,this.clearColor=new T,this.clearDepthColor=new T,this.ppl=void 0,this.camera=void 0,this.material=void 0,this.pass=void 0,this.rasterWidth=0,this.rasterHeight=0,this.layoutName="",this.shadingScale=1,this.viewport=new O,this.passViewport=new O,this.passPathName="",this.passVersion=0,this.isFinalCamera=!1,this.isFinalPass=!1,this.depthSlotName="",this.shadowPass=void 0,this.forwardPass=void 0,this.postProcess=void 0,this.maxSpotLights=4294967295,this.maxSphereLights=4294967295,this.maxPointLights=4294967295,this.maxRangedDirLights=4294967295}var n=e.prototype;return n.setClearFlag=function(e){return this.clearFlag=e,this},n.setClearColor=function(e,t,a,r){return V.set(this.clearColor,e,t,a,r),this},n.setClearDepthColor=function(e,t,a,r){return V.set(this.clearDepthColor,e,t,a,r),this},n.version=function(){return this.passPathName+="_"+this.pass.name+"_"+this.layoutName,this.pass.setVersion(this.passPathName,this.passVersion),this},n.clearBlack=function(){this.clearFlag=N.COLOR,V.set(ye.clearColor,0,0,0,1)},n.addRenderPass=function(e,t){var a=this.passViewport,r=this.ppl.addRenderPass(a.width,a.height,e);return r.name=t,this.pass=r,this.layoutName=e,this.rasterWidth=a.width,this.rasterHeight=a.height,r.setViewport(new A(a.x,a.y,a.width,a.height)),this},n.addSceneLights=function(e,r,s){if(void 0===s&&(s=t.BLEND),0!==this.maxPointLights||0!==this.maxSphereLights||0!==this.maxSpotLights||0!==this.maxRangedDirLights){for(var i=r.scene,n=i.spotLights,o=i.sphereLights,l=i.pointLights,h=i.rangedDirLights,p=Math.min(n.length,this.maxSpotLights),u=Math.min(o.length,this.maxSphereLights),c=Math.min(l.length,this.maxPointLights),d=Math.min(h.length,this.maxRangedDirLights),m=0;m<p;m++){var f=n[m];f.baked||(I.set(Pe,f.position.x,f.position.y,f.position.z,f.range),L.sphereFrustum(Pe,r.frustum)&&e.addSceneOfCamera(r,new a(f),s))}for(var P=0;P<u;P++){var g=o[P];g.baked||(I.set(Pe,g.position.x,g.position.y,g.position.z,g.range),L.sphereFrustum(Pe,r.frustum)&&e.addSceneOfCamera(r,new a(g),s))}for(var S=0;S<c;S++){var y=l[S];y.baked||(I.set(Pe,y.position.x,y.position.y,y.position.z,y.range),L.sphereFrustum(Pe,r.frustum)&&e.addSceneOfCamera(r,new a(y),s))}for(var _=0;_<d;_++){var v=h[_];F.transform(ge,Se,v.node.getWorldMatrix()),L.aabbFrustum(ge,r.frustum)&&e.addSceneOfCamera(r,new a(v),s)}}},n.updateViewPort=function(){var e=this.camera;if(e){var t=1;this.postProcess&&!h&&(t*=this.postProcess.shadingScale),this.shadingScale=t;var a=r(e,e.window.width*t,e.window.height*t,null,0,this.viewport);a.width=Math.floor(a.width),a.height=Math.floor(a.height)}},n.updatePassViewPort=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=0),this.passViewport.width=this.viewport.width*e,this.passViewport.height=this.viewport.height*e,this.passViewport.x=this.viewport.x*t,this.passViewport.y=this.viewport.y*t,this},n.addRasterView=function(e,t,a,r){void 0===a&&(a=!0),void 0===r&&(r=s.MANAGED);var i=this.ppl,n=this.camera,o=this.pass;if(!i||!n||!o)return this;if(i.containsResource(e)||(t===E.DEPTH_STENCIL?i.addDepthStencil(e,t,this.rasterWidth,this.rasterHeight,s.MANAGED):a?i.addRenderTarget(e,t,this.rasterWidth,this.rasterHeight,r||s.MANAGED):i.addRenderWindow(e,t,this.rasterWidth,this.rasterHeight,n.window)),t!==E.DEPTH_STENCIL?a?i.updateRenderTarget(e,this.rasterWidth,this.rasterHeight):i.updateRenderWindow(e,n.window):i.updateDepthStencil(e,this.rasterWidth,this.rasterHeight),t===E.DEPTH_STENCIL){var l=this.clearFlag&N.DEPTH_STENCIL,h=x.CLEAR;l===N.NONE&&(h=x.LOAD),o.addDepthStencil(e,h,k.STORE,this.clearDepthColor.x,this.clearDepthColor.y,l)}else{var u=new T;u.copy(this.clearColor);var c=this.clearFlag&N.COLOR,d=x.CLEAR;c!==N.NONE||this.clearFlag&p.VALUE?this.clearFlag&p.VALUE&&u.set(0,0,0,1):d=x.LOAD,o.addRenderTarget(e,d,k.STORE,u)}return this},n.setPassInput=function(e,t){return this.ppl.containsResource(e)&&this.pass.addTexture(e,t),this},n.blitScreen=function(e){return void 0===e&&(e=0),this.pass.addQueue(i.RENDER_TRANSPARENT).addCameraQuad(this.camera,this.material,e,t.NONE),this},e}()),_e=0,ve=null,we=new D(B.POINT,B.POINT,B.NONE,M.CLAMP,M.CLAMP,M.CLAMP);function be(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");return e.pipelineSceneData.isHDR&&t&&pe(e.device)?E.RGBA16F:E.RGBA8}function Re(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");if(e.pipelineSceneData.isHDR&&!t){var a=pe(e.device);e.setMacroBool("CC_USE_FLOAT_OUTPUT",a),ee.ENABLE_FLOAT_OUTPUT=a,t=a}return t}function Ce(){return ue.director.root.debugView.singleMode>0}function Ne(){if(!ve){var e=ue.director.root.pipeline.device;ve=e.getSampler(we)}return ve||void 0}var Te,Oe,Ae,Ee,xe,ke,De,Be,Me,Ie,Fe=function(){function e(){this.name=void 0,this.effectName="pipeline/post-process/blit-screen",this._id=0,this.context=ye,this.getCameraUniqueID=n,this._material=void 0,this.enable=!0,this.outputNames=[],this.lastPass=void 0,this.enableInAllEditorCamera=!1,this._id=_e++}var t=e.prototype;return t.slotName=function(e,t){return void 0===t&&(t=0),this.outputNames[t]+this.name+"_"+this._id+"_"+n(e)},t.checkEnable=function(){return this.enable},t.renderProfiler=function(){ye.isFinalCamera&&!h&&(ye.pass.showStatistics=!0)},$(e,[{key:"material",get:function(){if(!this._material){var e=new P;e._uuid=this.name+"-"+this.effectName+"-material",e.initialize({effectName:this.effectName}),this._material=e}return this._material}}]),e}(),Ve=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ForwardFinalPass",t.outputNames=["ForwardFinalColor"],t.enableInAllEditorCamera=!0,t}return te(t,e),t.prototype.render=function(e){if(this.lastPass){ye.clearFlag=e.clearFlag&N.COLOR|e.clearFlag&p.VALUE,V.set(ye.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),ye.material=this.material;var t=n(e),a=this.lastPass.slotName(e,0),r=this.slotName(e,0),s=e.window.framebuffer,i=s&&s.colorTextures[0],o=i?i.format:E.RGBA8,l=ye.shadingScale;ye.updatePassViewPort(1/l,1/l).addRenderPass("post-process",""+this.name+t).setPassInput(a,"inputTexture").addRasterView(r,o,!1).blitScreen(0),this.renderProfiler(e)}},t}(Fe),Le=function(e){function r(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ForwardPass",t.outputNames=["ForwardColor","ForwardDS"],t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}te(r,e);var s=r.prototype;return s.calcDepthSlot=function(t){var a=!!ye.depthSlotName,r=!(t.clearFlag&N.DEPTH_STENCIL);(r=r&&ye.shadingScale===this.depthBufferShadingScale)?a||(ye.depthSlotName=e.prototype.slotName.call(this,t,1)):(this.depthBufferShadingScale=ye.shadingScale,ye.depthSlotName=e.prototype.slotName.call(this,t,1))},s.slotName=function(t,a){return void 0===a&&(a=0),1===a?ye.depthSlotName:e.prototype.slotName.call(this,t,a)},s.render=function(e,r){var s;ye.clearFlag=N.COLOR|e.clearFlag&N.DEPTH_STENCIL|e.clearFlag&p.VALUE,V.set(ye.clearColor,0,0,0,0),V.set(ye.clearDepthColor,e.clearDepth,e.clearStencil,0,0),this.calcDepthSlot(e);var o=this.slotName(e,0),l=this.slotName(e,1),h=n(e),u=!0;ye.updatePassViewPort().addRenderPass("default",this.name+"_"+h).addRasterView(o,be(r),u).addRasterView(l,E.DEPTH_STENCIL,u).version();var c=ye.pass,d=ye.shadowPass;if(d){for(var m,f=ae(d.mainLightShadows);!(m=f()).done;){var P=m.value;r.containsResource(P)&&c.addTexture(P,"cc_shadowMap",Ne())}for(var S,y=ae(d.spotLightShadows);!(S=y()).done;){var _=S.value;r.containsResource(_)&&c.addTexture(_,"cc_spotShadowMap",Ne())}}c.addQueue(i.RENDER_OPAQUE).addSceneOfCamera(e,new a,t.OPAQUE_OBJECT|t.CUTOUT_OBJECT|t.GEOMETRY);var v=c.addQueue(i.RENDER_TRANSPARENT,"forward-add");ye.addSceneLights(v,e);var w,b=r.pipelineSceneData.shadows;null!=(s=e.scene)&&s.mainLight&&b.enabled&&b.type===g.Planar&&c.addQueue(i.RENDER_TRANSPARENT,"planar-shadow").addSceneOfCamera(e,new a(null==(w=e.scene)?void 0:w.mainLight),t.TRANSPARENT_OBJECT|t.SHADOW_CASTER|t.GEOMETRY),ye.forwardPass=this},r}(Fe),je=j("cc.PostProcessSetting")(Te=G(me)(Te=function(e){function t(){return e.apply(this,arguments)||this}te(t,e);var a=t.prototype;return a.onEnable=function(){var e=this.getComponent(me);null==e||e.addSetting(this)},a.onDisable=function(){var e=this.getComponent(me);null==e||e.removeSetting(this)},t}(he))||Te)||Te,Ge=j("cc.TAA")(Oe=H((Ae=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._sampleScale=Ee&&Ee(),t._feedback=xe&&xe(),t}return te(t,e),$(t,[{key:"sampleScale",get:function(){return this._sampleScale},set:function(e){this._sampleScale=e}},{key:"feedback",get:function(){return this._feedback},set:function(e){this._feedback=e}}]),t}(je),Ee=U(Ae.prototype,"_sampleScale",[X],(function(){return 1})),re(Ae.prototype,"sampleScale",[z],Object.getOwnPropertyDescriptor(Ae.prototype,"sampleScale"),Ae.prototype),xe=U(Ae.prototype,"_feedback",[X],(function(){return.95})),re(Ae.prototype,"feedback",[z],Object.getOwnPropertyDescriptor(Ae.prototype,"feedback"),Ae.prototype),Oe=Ae))||Oe)||Oe,He=(ke=j("TAAMask"),De=z(fe),ke((Me=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).maskCamera=Ie&&Ie(),t._mask=void 0,t}return te(t,e),t.prototype.start=function(){if(this.maskCamera){var e=new u;e.reset({width:ce.canvas.width,height:ce.canvas.height}),this._mask=e,this.maskCamera.targetTexture=e}else se("Can not find a Camera for TAAMask")},$(t,[{key:"mask",get:function(){if(this.maskCamera&&this.maskCamera.enabledInHierarchy&&this.enabledInHierarchy)return this._mask}}]),t}(he),Ie=U(Me.prototype,"maskCamera",[De],null),Be=Me))||Be);function Ue(e){var t=e;return ye.postProcess&&ye.postProcess.getSetting(t)}var ze=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).getSetting=Ue,t}return te(t,e),t.prototype.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t),r=this.setting;return a&&!!r&&r.enabledInHierarchy},$(t,[{key:"setting",get:function(){return this.getSetting(je)}}]),t}(Fe),Xe=new V,Je=[new J(.5,1/3),new J(.25,2/3),new J(.75,1/9),new J(.125,4/9),new J(.625,7/9),new J(.375,2/9),new J(.875,5/9),new J(.0625,8/9)];Je.forEach((function(e){e.x-=.5,e.y-=.5}));var Qe,We,Ye,Ke,qe,Ze,$e,et,tt,at,rt,st,it,nt,ot,lt,ht,pt,ut,ct,dt,mt,ft,Pt,gt,St,yt,_t,vt,wt,bt,Rt,Ct,Nt,Tt,Ot,At,Et,xt,kt,Dt,Bt,Mt,It,Ft,Vt,Lt,jt,Gt,Ht,Ut,zt,Xt,Jt,Qt,Wt,Yt,Kt,qt,Zt,$t,ea,ta,aa,ra,sa={x2:[new J(-.25,-.25),new J(.25,.25)],x3:[new J(-2/3,-2/3),new J(2/3,0),new J(0,2/3)],x4:[new J(-2/16,-6/16),new J(6/16,-2/16),new J(2/16,6/16),new J(-6/16,2/16)],x5:[new J(0,-.5),new J(.5,0),new J(0,.5),new J(-.5,0)],halton8:Je},ia=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="TAAPass",t.effectName="pipeline/post-process/taa",t.outputNames=["TAA_First","TAA_Second"],t.prevMatViewProj=new Q,t.taaTextureIndex=-2,t.samples=sa.halton8,t.sampleIndex=-1,t.sampleOffset=new J,t.forceRender=!0,t.dirty=!1,t.taaMaskMaterial=void 0,t.firstRender=!0,t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t);return Ce()&&(a=!1),a},a.slotName=function(t,a){return void 0===a&&(a=0),this.checkEnable(t)?this.taaTextureIndex<0?e.prototype.slotName.call(this,t,0):e.prototype.slotName.call(this,t,(this.taaTextureIndex+1)%2):this.lastPass.slotName(t,a)},a.applyCameraJitter=function(e){e._isProjDirty=!0,e.update(!0),e.matProj.m12+=this.sampleOffset.x,e.matProj.m13+=this.sampleOffset.y,Q.invert(e.matProjInv,e.matProj),Q.multiply(e.matViewProj,e.matProj,e.matView),Q.invert(e.matViewProjInv,e.matViewProj),e.frustum.update(e.matViewProj,e.matViewProjInv)},a.updateSample=function(){(this.dirty||this.forceRender)&&(this.sampleIndex++,this.taaTextureIndex++,this.dirty=!1);var e=this.samples[this.sampleIndex%this.samples.length];-1===this.sampleIndex&&(e=J.ZERO);var t=this.setting;this.sampleOffset.x=e.x*t.sampleScale/ce.canvas.width,this.sampleOffset.y=e.y*t.sampleScale/ce.canvas.height},a.render=function(t){var a=n(t);ye.clearFlag=N.COLOR,V.set(ye.clearColor,0,0,0,1);var r=this.firstRender;r&&(this.prevMatViewProj.set(t.matViewProj),this.firstRender=!1);var i=this.setting;ye.updatePassViewPort();var o,l=ye.passViewport.width,p=ye.passViewport.height,u=this.material,c=t.node.getComponent(He);if(c&&c.enabledInHierarchy&&(o=c.mask),o){if(!this.taaMaskMaterial){var d=new S({parent:u});d.recompileShaders({USE_TAA_MASK:!h}),this.taaMaskMaterial=d}(u=this.taaMaskMaterial).setProperty("motionMaskTex",o)}else o=y.get("black-texture"),u.setProperty("motionMaskTex",o);u.setProperty("taaParams1",Xe.set(this.sampleOffset.x,this.sampleOffset.y,i.feedback,0)),u.setProperty("taaTextureSize",Xe.set(1/l,1/p,1/l,1/p)),u.setProperty("taaPrevViewProj",this.prevMatViewProj),this.prevMatViewProj.set(t.matViewProj),ye.material=u;var m=this.lastPass.slotName(t,0),f=e.prototype.slotName.call(this,t,this.taaTextureIndex%2);r&&(f=m);var P=this.slotName(t,0),g=ye.depthSlotName,_="DeferredTAA"+(this.taaTextureIndex<0?-1:this.taaTextureIndex%2);ye.addRenderPass(_,"CameraTAAPass"+a).setPassInput(m,"inputTexture").setPassInput(g,"depthTex").setPassInput(f,"taaPrevTexture").addRasterView(P,E.RGBA16F,!0,s.PERSISTENT).blitScreen(0).version()},$(t,[{key:"setting",get:function(){return Ue(Ge)}}]),t}(ze),na=(Qe=j("cc.FSR"),We=W(ie),Qe(Ye=H((Ke=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._sharpness=qe&&qe(),t}return te(t,e),$(t,[{key:"sharpness",get:function(){return this._sharpness},set:function(e){this._sharpness=e}}]),t}(je),qe=U(Ke.prototype,"_sharpness",[X],(function(){return.8})),re(Ke.prototype,"sharpness",[We],Object.getOwnPropertyDescriptor(Ke.prototype,"sharpness"),Ke.prototype),Ye=Ke))||Ye)||Ye),oa=new V,la=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="FSRPass",t.effectName="pipeline/post-process/fsr",t.outputNames=["FSRColor"],t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},a.render=function(e){var t=n(e);ye.material=this.material,ye.clearBlack(),ye.updatePassViewPort(1/ye.shadingScale,0);var a=Math.floor(ye.passViewport.width*ye.shadingScale),r=Math.floor(ye.passViewport.height*ye.shadingScale),s=Math.floor(ye.passViewport.width),i=Math.floor(ye.passViewport.height),o=this.setting;this.material.setProperty("fsrParams",oa.set(Y(1-o.sharpness,.02,.98),0,0,0)),this.material.setProperty("texSize",oa.set(a,r,s,i));var l=this.lastPass.slotName(e,0),h="FSR_EASU"+t;ye.addRenderPass("post-process","CameraFSR_EASU_Pass"+t).setPassInput(l,"outputResultMap").addRasterView(h,E.RGBA8).blitScreen(0).version();var p=this.slotName(e,0);ye.addRenderPass("post-process","CameraFSR_RCAS_Pass"+t).setPassInput(h,"outputResultMap").addRasterView(p,E.RGBA8).blitScreen(1).version()},$(t,[{key:"setting",get:function(){return Ue(na)}}]),t}(ze),ha=(Ze=j("cc.BlitScreenMaterial"),$e=z(P),et=z(P),tt=z({serializable:!0}),Ze((rt=function(){function e(){this._material=st&&st(),this.enable=it&&it()}return $(e,[{key:"material",get:function(){return this._material},set:function(e){this._material=e}}]),e}(),st=U(rt.prototype,"_material",[$e,X],null),re(rt.prototype,"material",[et],Object.getOwnPropertyDescriptor(rt.prototype,"material"),rt.prototype),it=U(rt.prototype,"enable",[tt],(function(){return!0})),at=rt))||at),pa=(nt=j("cc.BlitScreen"),ot=z(P),lt=z({type:P,visible:!1}),ht=z(ha),pt=z(ha),nt(ut=H((ct=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._activeMaterials=dt&&dt(),t._materials=mt&&mt(),t}te(t,e);var a=t.prototype;return a.updateActiveMaterials=function(){var e=this._materials;this._activeMaterials.length=0;for(var t=0;t<e.length;t++){var a=e[t];a.enable&&a.material&&this._activeMaterials.push(a.material)}},a.onLoad=function(){this.updateActiveMaterials()},$(t,[{key:"activeMaterials",get:function(){return this._activeMaterials},set:function(e){this._activeMaterials=e;for(var t=0;t<this._materials.length;t++)for(var a=0;a<e.length;a++){var r;this._materials[t]&&e[a]&&(null==(r=this._materials[t].material)?void 0:r.uuid)===e[a].uuid&&(this._materials[t].material=e[a])}}},{key:"materials",get:function(){return this._materials},set:function(e){this._materials=e,this.updateActiveMaterials()}}]),t}(je),dt=U(ct.prototype,"_activeMaterials",[ot,X],(function(){return[]})),re(ct.prototype,"activeMaterials",[lt],Object.getOwnPropertyDescriptor(ct.prototype,"activeMaterials"),ct.prototype),mt=U(ct.prototype,"_materials",[ht,X],(function(){return[]})),re(ct.prototype,"materials",[pt],Object.getOwnPropertyDescriptor(ct.prototype,"materials"),ct.prototype),ut=ct))||ut)||ut),ua=["BlitScreenColor0","BlitScreenColor1"],ca=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="BlitScreenPass",t.effectName="pipeline/post-process/blit-screen",t.outputName=ua[0],t}te(t,e);var a=t.prototype;return a.slotName=function(){return this.outputName},a.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t),r=this.setting;return a&&r.activeMaterials.length>0},a.render=function(e){var t=n(e);ye.clearBlack();for(var a=this.lastPass.slotName(e,0),r=0,s=this.setting.activeMaterials,i=0;i<s.length;i++){var o=s[i];ye.material=o;var l=""+ua[r]+t;r=++r%2,ye.updatePassViewPort().addRenderPass("post-process",""+this.name+t+r).setPassInput(a,"inputTexture").addRasterView(l,E.RGBA8).blitScreen(0).version(),a=l}this.outputName=a},$(t,[{key:"setting",get:function(){return Ue(pa)}}]),t}(ze),da=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ShadowPass",t.mainLightShadows=[],t.spotLightShadows=[],t}return te(t,e),t.prototype.render=function(e,t){ye.shadowPass=this;var a=n(e),r=o("Camera"+a,e,t);this.mainLightShadows=r.mainLightShadowNames,this.spotLightShadows=r.spotLightShadowNames},t}(Fe),ma=(ft=j("cc.ColorGrading"),Pt=W(ie),gt=W(_),ft(St=H((yt=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._contribute=_t&&_t(),t._colorGradingMap=vt&&vt(),t}return te(t,e),$(t,[{key:"contribute",get:function(){return this._contribute},set:function(e){this._contribute=e}},{key:"colorGradingMap",get:function(){return this._colorGradingMap},set:function(e){this._colorGradingMap=e}}]),t}(je),_t=U(yt.prototype,"_contribute",[X],(function(){return 0})),vt=U(yt.prototype,"_colorGradingMap",[X],(function(){return null})),re(yt.prototype,"contribute",[Pt],Object.getOwnPropertyDescriptor(yt.prototype,"contribute"),yt.prototype),re(yt.prototype,"colorGradingMap",[gt],Object.getOwnPropertyDescriptor(yt.prototype,"colorGradingMap"),yt.prototype),St=yt))||St)||St),fa=(wt=j("cc.Bloom"),bt=W(ne),Rt=W(ne),Ct=W(ie),Nt=W(oe),Tt=W(ie),wt(Ot=H((At=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._enableAlphaMask=Et&&Et(),t._useHdrIlluminance=xt&&xt(),t._threshold=kt&&kt(),t._iterations=Dt&&Dt(),t._intensity=Bt&&Bt(),t}return te(t,e),$(t,[{key:"enableAlphaMask",get:function(){return this._enableAlphaMask},set:function(e){this._enableAlphaMask=e}},{key:"useHdrIlluminance",get:function(){return this._useHdrIlluminance},set:function(e){this._useHdrIlluminance=e}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=e}},{key:"iterations",get:function(){return this._iterations},set:function(e){this._iterations=e}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}}]),t}(je),Et=U(At.prototype,"_enableAlphaMask",[X],(function(){return!1})),xt=U(At.prototype,"_useHdrIlluminance",[X],(function(){return!1})),kt=U(At.prototype,"_threshold",[X],(function(){return.8})),Dt=U(At.prototype,"_iterations",[X],(function(){return 3})),Bt=U(At.prototype,"_intensity",[X],(function(){return 2.3})),re(At.prototype,"enableAlphaMask",[bt],Object.getOwnPropertyDescriptor(At.prototype,"enableAlphaMask"),At.prototype),re(At.prototype,"useHdrIlluminance",[Rt],Object.getOwnPropertyDescriptor(At.prototype,"useHdrIlluminance"),At.prototype),re(At.prototype,"threshold",[Ct],Object.getOwnPropertyDescriptor(At.prototype,"threshold"),At.prototype),re(At.prototype,"iterations",[Nt],Object.getOwnPropertyDescriptor(At.prototype,"iterations"),At.prototype),re(At.prototype,"intensity",[Tt],Object.getOwnPropertyDescriptor(At.prototype,"intensity"),At.prototype),Ot=At))||Ot)||Ot),Pa=(Mt=j("cc.HBAO"),It=W(ie),Ft=W(ie),Vt=W(oe),Lt=W(ie),jt=W(ne),Mt(Gt=H((Ht=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._radiusScale=Ut&&Ut(),t._angleBiasDegree=zt&&zt(),t._blurSharpness=Xt&&Xt(),t._aoSaturation=Jt&&Jt(),t._needBlur=Qt&&Qt(),t}return te(t,e),$(t,[{key:"radiusScale",get:function(){return this._radiusScale},set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",get:function(){return this._angleBiasDegree},set:function(e){this._angleBiasDegree=e}},{key:"blurSharpness",get:function(){return this._blurSharpness},set:function(e){this._blurSharpness=e}},{key:"aoSaturation",get:function(){return this._aoSaturation},set:function(e){this._aoSaturation=e}},{key:"needBlur",get:function(){return this._needBlur},set:function(e){this._needBlur=e}}]),t}(je),Ut=U(Ht.prototype,"_radiusScale",[X],(function(){return 1})),zt=U(Ht.prototype,"_angleBiasDegree",[X],(function(){return 10})),Xt=U(Ht.prototype,"_blurSharpness",[X],(function(){return 3})),Jt=U(Ht.prototype,"_aoSaturation",[X],(function(){return 1})),Qt=U(Ht.prototype,"_needBlur",[X],(function(){return!0})),re(Ht.prototype,"radiusScale",[It],Object.getOwnPropertyDescriptor(Ht.prototype,"radiusScale"),Ht.prototype),re(Ht.prototype,"angleBiasDegree",[Ft],Object.getOwnPropertyDescriptor(Ht.prototype,"angleBiasDegree"),Ht.prototype),re(Ht.prototype,"blurSharpness",[Vt],Object.getOwnPropertyDescriptor(Ht.prototype,"blurSharpness"),Ht.prototype),re(Ht.prototype,"aoSaturation",[Lt],Object.getOwnPropertyDescriptor(Ht.prototype,"aoSaturation"),Ht.prototype),re(Ht.prototype,"needBlur",[jt],Object.getOwnPropertyDescriptor(Ht.prototype,"needBlur"),Ht.prototype),Gt=Ht))||Gt)||Gt),ga=(Wt=j("cc.DOF"),Yt=W(ie),Kt=W(ie),qt=W(ie),Wt(Zt=H(($t=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this)._focusDistance=ea&&ea(),t._focusRange=ta&&ta(),t._bokehRadius=aa&&aa(),t}return te(t,e),$(t,[{key:"focusDistance",get:function(){return this._focusDistance},set:function(e){this._focusDistance=e}},{key:"focusRange",get:function(){return this._focusRange},set:function(e){this._focusRange=e}},{key:"bokehRadius",get:function(){return this._bokehRadius},set:function(e){this._bokehRadius=e}}]),t}(je),ea=U($t.prototype,"_focusDistance",[X],(function(){return 0})),ta=U($t.prototype,"_focusRange",[X],(function(){return 0})),aa=U($t.prototype,"_bokehRadius",[X],(function(){return 1})),re($t.prototype,"focusDistance",[Yt],Object.getOwnPropertyDescriptor($t.prototype,"focusDistance"),$t.prototype),re($t.prototype,"focusRange",[Kt],Object.getOwnPropertyDescriptor($t.prototype,"focusRange"),$t.prototype),re($t.prototype,"bokehRadius",[qt],Object.getOwnPropertyDescriptor($t.prototype,"bokehRadius"),$t.prototype),Zt=$t))||Zt)||Zt),Sa=new J,ya=function(){var e=t.prototype;function t(){this._uvDepthToEyePosParams=new V,this._radiusParam=new V,this._miscParam=new V,this._blurParam=new V,this._depthTexFullResolution=new J(1024),this._depthTexResolution=new J(1024),this._sceneScale=1,this._cameraFov=K(45),this._radiusScale=1,this._angleBiasDegree=10,this._aoStrength=1,this._blurSharpness=8,this._aoSaturation=1,this._randomDirAndJitter=[238,91,87,255,251,44,119,255,247,64,250,255,232,5,225,255,253,177,140,255,250,51,84,255,243,76,97,255,252,36,232,255,235,100,24,255,252,36,158,255,254,20,142,255,245,135,124,255,251,43,121,255,253,31,145,255,235,98,160,255,240,146,198,255],this._init(),this.update()}return e._init=function(){for(var e=v.RGBA8888,t=new Uint8Array(64),a=0;a<this._randomDirAndJitter.length;a++)t[a]=this._randomDirAndJitter[a];var r=new w({width:4,height:4,_data:t,_compressed:!1,format:e});this.randomTexture=new _,this.randomTexture.setFilters(b.NEAREST,b.NEAREST),this.randomTexture.setMipFilter(b.NONE),this.randomTexture.setWrapMode(R.REPEAT,R.REPEAT,R.REPEAT),this.randomTexture.image=r},e.update=function(){var e=this._radiusScale*this._sceneScale,t=e*e,a=-1/t,r=.1*Math.min(this._depthTexFullResolution.x,this._depthTexFullResolution.y);this._radiusParam.set(e,t,a,r);var s=new J(this._depthTexResolution.y/this._depthTexResolution.x,1),i=new J(s.x/Math.tan(.5*this._cameraFov),s.y/Math.tan(.5*this._cameraFov)),n=Math.tan(K(this._angleBiasDegree)),o=this._aoStrength;this._miscParam.set(i.x,i.y,n,o);var l=new J(2/i.x,-2/i.y),h=new J(-1/i.x,1/i.y);this._uvDepthToEyePosParams.set(l.x,l.y,h.x,h.y);var p=this._sceneScale/this._blurSharpness*1.6651092;this._blurParam.set(.11541560320000001,p,this._blurSharpness/8,this._aoSaturation)},$(t,[{key:"uvDepthToEyePosParams",get:function(){return this._uvDepthToEyePosParams}},{key:"radiusParam",get:function(){return this._radiusParam}},{key:"miscParam",get:function(){return this._miscParam}},{key:"blurParam",get:function(){return this._blurParam}},{key:"depthTexFullResolution",set:function(e){this._depthTexFullResolution.set(e)}},{key:"depthTexResolution",set:function(e){this._depthTexResolution.set(e)}},{key:"sceneScale",set:function(e){this._sceneScale=e}},{key:"cameraFov",set:function(e){this._cameraFov=e}},{key:"radiusScale",set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",set:function(e){this._angleBiasDegree=e}},{key:"aoStrength",set:function(e){this._aoStrength=e}},{key:"blurSharpness",set:function(e){this._blurSharpness=e}},{key:"aoSaturation",set:function(e){this._aoSaturation=e}}]),t}(),_a=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).HBAO_PASS_INDEX=0,t.HBAO_BLUR_X_PASS_INDEX=1,t.HBAO_BLUR_Y_PASS_INDEX=2,t.HBAO_COMBINED_PASS_INDEX=3,t._hbaoParams=null,t._initialize=!1,t.averageObjectSize=new Map,t.name="HBAOPass",t.effectName="pipeline/post-process/hbao",t.outputNames=["hbaoRTName","hbaoBluredRTName"],t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},a.onGlobalPipelineStateChanged=function(){ye.material=this.material;for(var e=ye.material.passes,t=0;t<e.length;t++){var a=e[t];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},a.getSceneScale=function(e){var t=e.nearClip;return this.averageObjectSize.has(e.node.scene)||this._calculateObjectSize(e.node.scene,e.visibility),this.averageObjectSize.has(e.node.scene)&&(t=.1*this.averageObjectSize.get(e.node.scene)),t},a.render=function(e){ye.updatePassViewPort();var t=ye.passViewport.width,a=ye.passViewport.height;this._hbaoParams||(this._hbaoParams=new ya);var r=this.setting;this._initialize||(ye.material=this.material,this.material.setProperty("RandomTex",this._hbaoParams.randomTexture,0));var s=this.getSceneScale(e);this._hbaoParams.depthTexFullResolution=Sa.set(t,a),this._hbaoParams.depthTexResolution=Sa.set(t,a),this._hbaoParams.sceneScale=s,this._hbaoParams.cameraFov=e.fov,this._hbaoParams.radiusScale=r.radiusScale,this._hbaoParams.angleBiasDegree=r.angleBiasDegree,this._hbaoParams.aoStrength=1,this._hbaoParams.blurSharpness=r.blurSharpness,this._hbaoParams.aoSaturation=r.aoSaturation,this._hbaoParams.update();var i=ue.director.root;if(!i.debugView||!i.debugView.isEnabled()||(i.debugView.singleMode===c.NONE||i.debugView.singleMode===c.AO)&&i.debugView.isCompositeModeEnabled(d.AO)){var n=this.lastPass.slotName(e,0),o=this.lastPass.slotName(e,1),l=this._renderHBAOPass(e,o),h=l.rtName;if(this.setting.needBlur){var p=this._renderHBAOBlurPass(e,l.rtName,o,!1);h=this._renderHBAOBlurPass(e,p.rtName,o,!0).rtName}this._renderHBAOCombinedPass(e,h,n)}},a._renderHBAOPass=function(t,a){var r=n(t),s=this.HBAO_PASS_INDEX;this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new V(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),ye.clearBlack();var i=e.prototype.slotName.call(this,t,0),o="CameraHBAOPass"+r;return ye.addRenderPass("hbao-pass",o).setPassInput(a,"DepthTex").addRasterView(i,E.RGBA8).blitScreen(s).version(),{rtName:i,dsName:a}},a._renderHBAOBlurPass=function(t,a,r,s){var i=n(t);ye.clearBlack();var o=s?this.HBAO_BLUR_Y_PASS_INDEX:this.HBAO_BLUR_X_PASS_INDEX;ye.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,o),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,o),this.material.setProperty("miscParam",this._hbaoParams.miscParam,o),this.material.setProperty("randomTexSize",new V(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),o),this.material.setProperty("blurParam",this._hbaoParams.blurParam,o);var l=e.prototype.slotName.call(this,t,1),h="blurx-pass",p="CameraHBAOBluredXPass"+i;return s&&(l=e.prototype.slotName.call(this,t,0),h="blury-pass",p="CameraHBAOBluredYPass"+i),ye.addRenderPass(h,p).setPassInput(a,"AOTexNearest").setPassInput(r,"DepthTex").addRasterView(l,E.RGBA8).blitScreen(o).version(),{rtName:l,dsName:r}},a._renderHBAOCombinedPass=function(e,t,a){var r=n(e),s=this.HBAO_COMBINED_PASS_INDEX;ye.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new V(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),ye.clearFlag=N.NONE;var i="CameraHBAOCombinedPass"+r;ye.addRenderPass("combine-pass",i).setPassInput(t,"AOTexNearest").addRasterView(a,E.RGBA8).blitScreen(s).version()},a._calculateObjectSize=function(e,t){if(e&&e.renderScene){for(var a=new q(0),r=0,s=e.renderScene.models,i=0;i<s.length;i++){var n=s[i];n.node&&n.worldBounds&&n.node.layer&t&&(a.add(n.worldBounds.halfExtents),r++)}if(r>0){a.divide(Z(r));var o=Math.min(a.x,a.y,a.z);this.averageObjectSize.set(e,o)}}},a.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},$(t,[{key:"setting",get:function(){return Ue(Pa)}}]),t}(ze),va=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ColorGradingPass",t.effectName="pipeline/post-process/color-grading",t.outputNames=["ColorGrading"],t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t);return Ce()&&(a=!1),a},a.render=function(e){var t=n(e);ye.clearFlag=N.COLOR,V.set(ye.clearColor,0,0,0,1),ye.material=this.material;var a=this.setting;this.material.setProperty("colorGradingMap",a.colorGradingMap),this.material.setProperty("contribute",a.contribute);var r=a.colorGradingMap?new J(a.colorGradingMap.width,a.colorGradingMap.height):new J(1,1);this.material.setProperty("lutTextureSize",r);var s=this.lastPass.slotName(e,0),i=this.slotName(e,0),o=a.colorGradingMap&&a.colorGradingMap.width===a.colorGradingMap.height,l=o?"color-grading-8x8":"color-grading-nx1",h=o?1:0;ye.updatePassViewPort().addRenderPass(l,"color-grading"+t).setPassInput(s,"sceneColorMap").addRasterView(i,E.RGBA8).blitScreen(h).version()},$(t,[{key:"setting",get:function(){return Ue(ma)}}]),t}(ze),wa=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="BloomPass",t.effectName="pipeline/post-process/bloom",t.outputNames=["BloomColor"],t._hdrInputName="",t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t);return Ce()&&(a=!1),a},a.render=function(e){var t=n(e),a="Camera"+t,r=ye.passViewport;ye.clearBlack(),ye.material=this.material;var s=this.setting,i=this.lastPass.slotName(e,0),o="BLOOM_PREFILTER_COLOR"+t,l=.5,h=s.enableAlphaMask,p=s.useHdrIlluminance;ye.material.setProperty("texSize",new V(p,0,s.threshold,h),0),ye.updatePassViewPort(l).addRenderPass("bloom-prefilter","bloom-prefilter"+t).setPassInput(i,"outputResultMap").setPassInput(this._hdrInputName,"hdrInputMap").addRasterView(o,E.RGBA8).blitScreen(0).version();for(var u=0;u<s.iterations;++u){var c=new V(r.width,r.height,0,0),d="dsBloomPassDownSampleColor"+a+u,m=0===u?o:"dsBloomPassDownSampleColor"+a+(u-1);ye.material.setProperty("texSize",c,1+u),l/=2,ye.updatePassViewPort(l).addRenderPass("bloom-upsample"+u,"bloom-upsample"+u+t).setPassInput(m,"bloomTexture").addRasterView(d,E.RGBA8).blitScreen(1+u).version()}for(var f=0;f<s.iterations;++f){var P=new V(r.width,r.height,0,0),g="dsBloomPassUpSampleColor"+a+(s.iterations-1-f),S=0===f?"dsBloomPassDownSampleColor"+a+(s.iterations-1):"dsBloomPassUpSampleColor"+a+(s.iterations-f);ye.material.setProperty("texSize",P,7+f),l*=2,ye.updatePassViewPort(l).addRenderPass("bloom-downsample"+f,"bloom-downsample"+f+t).setPassInput(S,"bloomTexture").addRasterView(g,E.RGBA8).blitScreen(7+f).version()}ye.material.setProperty("texSize",new V(0,0,0,s.intensity),13),ye.updatePassViewPort().addRenderPass("bloom-combine","bloom-combine"+t).setPassInput(i,"outputResultMap").setPassInput("dsBloomPassUpSampleColor"+a+0,"bloomTexture").addRasterView(this.slotName(e,0),E.RGBA8).blitScreen(13).version()},$(t,[{key:"setting",get:function(){return Ue(fa)}},{key:"hdrInputName",set:function(e){this._hdrInputName=e}}]),t}(ze),ba=j("cc.FXAA")(ra=H(ra=function(e){function t(){return e.apply(this,arguments)||this}return te(t,e),t}(je))||ra)||ra,Ra=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="FxaaPass",t.effectName="pipeline/post-process/fxaa-hq",t.outputNames=["FxaaColor"],t}return te(t,e),t.prototype.render=function(e){var t=n(e);ye.clearBlack(),ye.material=this.material,this.setting;var a=this.lastPass.slotName(e,0),r=this.slotName(e);ye.updatePassViewPort();var s=ye.passViewport.width,i=ye.passViewport.height;ye.material.setProperty("texSize",new V(s,i,1/s,1/i),0),ye.addRenderPass("fxaa","fxaa"+t).setPassInput(a,"sceneColorMap").addRasterView(r,E.RGBA8).blitScreen(0).version()},$(t,[{key:"setting",get:function(){return Ue(ba)}}]),t}(ze),Ca=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="FloatOutputProcessPass",t.effectName="pipeline/float-output-process",t.outputNames=["FloatOutputProcess"],t.hdrInputName="",t.enableInAllEditorCamera=!0,t.enable=!0,t}te(t,e);var a=t.prototype;return a.checkEnable=function(){return ue.director.root.pipeline.getMacroBool("CC_USE_FLOAT_OUTPUT")},a.getHDRInputName=function(){return this.hdrInputName},a.onGlobalPipelineStateChanged=function(){ye.material=this.material;for(var e=ye.material.passes,t=0;t<e.length;t++){var a=e[t];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},a.needDepthInput=function(e){return e.pipelineSceneData.fog.type!==C},a.render=function(e,t){var a=n(e);ye.material=this.material;var r="",s=0,i=ye.depthSlotName;if(this.needDepthInput(t)){r="floatOutputProcessCopyDS";var o="floatOutputProcessCopyDS-pass"+a;ye.updatePassViewPort().addRenderPass("copy-pass",o).setClearFlag(N.COLOR).setClearColor(1,0,0,0).setPassInput(i,"depthRaw").addRasterView(r,E.RGBA8).blitScreen(s).version()}s=1,this.hdrInputName=this.lastPass.slotName(e,0);var l=this.slotName(e,0),h="tone-mapping"+a;ye.clearFlag=N.COLOR,V.set(ye.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),ye.updatePassViewPort().addRenderPass("tone-mapping",h).setPassInput(this.hdrInputName,"u_texSampler").setPassInput(r,"DepthTex").addRasterView(l,E.RGBA8).blitScreen(s).version()},t}(ze),Na=function(e){function r(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ForwardTransparencyPass",t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}te(r,e);var s=r.prototype;return s.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},s.render=function(e,r){ye.clearFlag=N.NONE;var s=this.lastPass.slotName(e,0),o=ye.depthSlotName,l=n(e),h=!0;ye.updatePassViewPort().addRenderPass("default",this.name+"_"+l).addRasterView(s,be(r),h).addRasterView(o,E.DEPTH_STENCIL,h).version();var p=ye.pass,u=ye.shadowPass;if(u){for(var c,d=ae(u.mainLightShadows);!(c=d()).done;){var m=c.value;r.containsResource(m)&&p.addTexture(m,"cc_shadowMap",Ne())}for(var f,P=ae(u.spotLightShadows);!(f=P()).done;){var g=f.value;r.containsResource(g)&&p.addTexture(g,"cc_spotShadowMap",Ne())}}p.addQueue(i.RENDER_TRANSPARENT).addSceneOfCamera(e,new a,t.UI|t.TRANSPARENT_OBJECT|t.GEOMETRY)},r}(Fe),Ta=function(e){function r(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="ForwardTransparencySimplePass",t}te(r,e);var s=r.prototype;return s.slotName=function(e,t){return void 0===t&&(t=0),ye.forwardPass.slotName(e,t)},s.render=function(e){ye.pass.addQueue(i.RENDER_TRANSPARENT).addSceneOfCamera(e,new a,t.UI|t.TRANSPARENT_OBJECT|t.GEOMETRY)},r}(Fe);function Oa(e){var t=e.pipelineSceneData;return t.skin.enabled&&null!==t.skinMaterialModel}var Aa=[.0484,.187,.567,1.99,7.41],Ea=[.1,.118,.113,.358,.078],xa=new q,ka=new q,Da=new V,Ba=new V,Ma=function(){var e=t.prototype;function t(){this._v3SSSSStrength=new q(.48,.41,.28),this._v3SSSSFallOff=new q(1,.37,.3),this._kernel=[],this._init()}return e._gaussian=function(e,t,a){var r=a/(.001+this._v3SSSSFallOff.x);e.x=Math.exp(-r*r/(2*t))/(6.28*t);var s=a/(.001+this._v3SSSSFallOff.y);e.y=Math.exp(-s*s/(2*t))/(6.28*t);var i=a/(.001+this._v3SSSSFallOff.z);e.z=Math.exp(-i*i/(2*t))/(6.28*t)},e._profile=function(e,t){for(var a=0;a<5;a++)this._gaussian(ka,Aa[a],t),ka.multiplyScalar(Ea[a]),e.add(ka)},e._updateSampleCount=function(){for(var e=this._v3SSSSStrength,t=0;t<25;t++){var a=.25*t-3,r=a<0?-1:1;this._kernel[t].w=3*r*Math.abs(Math.pow(a,2))/Math.pow(3,2)}for(var s=0;s<25;s++){var i=((s>0?Math.abs(this._kernel[s].w-this._kernel[s-1].w):0)+(s<24?Math.abs(this._kernel[s].w-this._kernel[s+1].w):0))/2;xa.set(0),this._profile(xa,this._kernel[s].w),xa.multiplyScalar(i),this._kernel[s].x=xa.x,this._kernel[s].y=xa.y,this._kernel[s].z=xa.z}Da.set(this._kernel[12]);for(var n=12;n>0;n--)Ba.set(this._kernel[n-1]),this._kernel[n].set(Ba);this._kernel[0].set(Da),xa.set(0);for(var o=0;o<25;o++)xa.add3f(this._kernel[o].x,this._kernel[o].y,this._kernel[o].z);for(var l=0;l<25;l++)this._kernel[l].x/=xa.x,this._kernel[l].y/=xa.y,this._kernel[l].z/=xa.z;this._kernel[0].x=1*(1-e.x)+e.x*this._kernel[0].x,this._kernel[0].y=1*(1-e.y)+e.y*this._kernel[0].y,this._kernel[0].z=1*(1-e.z)+e.z*this._kernel[0].z;for(var h=1;h<25;h++)this._kernel[h].x*=e.x,this._kernel[h].y*=e.y,this._kernel[h].z*=e.z},e._init=function(){for(var e=0;e<25;e++)this._kernel[e]=new V;this._updateSampleCount()},$(t,[{key:"ssssStrength",get:function(){return this._v3SSSSStrength},set:function(e){this._v3SSSSStrength=e,this._updateSampleCount()}},{key:"ssssFallOff",get:function(){return this._v3SSSSFallOff},set:function(e){this._v3SSSSFallOff=e,this._updateSampleCount()}},{key:"kernel",get:function(){return this._kernel}}]),t}(),Ia=function(e){function r(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="SkinPass",t.effectName="pipeline/ssss-blur",t.outputNames=["SSSSBlur","SSSSBlurDS"],t.ssssBlurData=new Ma,t._activate=!1,t.enableInAllEditorCamera=!0,t}te(r,e);var s=r.prototype;return s.checkEnable=function(){var e=ue.director.root.pipeline,t=Oa(e);return t&&(this._activate||(e.getMacroBool("CC_USE_FLOAT_OUTPUT")||le(16303),e.pipelineSceneData.standardSkinModel||le(16304),this._activate=!0),t=Re(e)),t},s.render=function(e,t){var a;ye.material=this.material;var r=null==(a=this.lastPass)?void 0:a.slotName(e,0),s=ye.depthSlotName;this._buildSSSSBlurPass(e,t,r,s),this._buildSpecularPass(e,t,r,s)},s._buildSSSSBlurPass=function(t,a,r,s){var i=n(t),o=a.pipelineSceneData,l=new q(.2,.2,.2),h=o.standardSkinModel,p=o.skinMaterialModel;h&&h.worldBounds?l=h.worldBounds.halfExtents:p&&p.worldBounds&&(l=p.worldBounds.halfExtents);var u=2*Math.min(l.x,l.y,l.z),c=o.skin,d=e.prototype.slotName.call(this,t,0),m=e.prototype.slotName.call(this,t,1),f="copyDS-pass"+i,P=0;ye.updatePassViewPort().addRenderPass("copy-pass",f).setClearFlag(N.COLOR).setClearColor(1,0,0,0).setPassInput(s,"depthRaw").addRasterView(m,E.RGBA8).blitScreen(P).version(),P=1;var g="ssss-blurX"+i;this.material.setProperty("blurInfo",new V(t.fov,c.blurRadius,u,c.sssIntensity),P),this.material.setProperty("kernel",this.ssssBlurData.kernel,P),ye.updatePassViewPort().addRenderPass("ssss-blurX",g).setPassInput(r,"colorTex").setPassInput(m,"depthTex").setClearFlag(N.COLOR).setClearColor(0,0,0,1).addRasterView(d,be(a)).blitScreen(P).version(),P=2;var S="ssss-blurY"+i;this.material.setProperty("blurInfo",new V(t.fov,c.blurRadius,u,c.sssIntensity),P),this.material.setProperty("kernel",this.ssssBlurData.kernel,P),ye.updatePassViewPort().addRenderPass("ssss-blurY",S).setPassInput(d,"colorTex").setPassInput(m,"depthTex").setClearFlag(N.NONE).setClearColor(0,0,0,1).addRasterView(r,be(a)).blitScreen(P).version()},s._buildSpecularPass=function(e,r,s,o){var l="specular-pass"+n(e);ye.updatePassViewPort().addRenderPass("specular-pass",l).setClearFlag(N.NONE).setClearColor(0,0,0,1).addRasterView(s,be(r),!0).setClearFlag(N.NONE).setClearDepthColor(e.clearDepth,e.clearStencil,0,1).addRasterView(o,E.DEPTH_STENCIL,!0).version();var h=ye.pass,p=ye.shadowPass;if(p){for(var u,c=ae(p.mainLightShadows);!(u=c()).done;){var d=u.value;r.containsResource(d)&&h.addTexture(d,"cc_shadowMap",Ne())}for(var m,f=ae(p.spotLightShadows);!(m=f()).done;){var P=m.value;r.containsResource(P)&&h.addTexture(P,"cc_spotShadowMap",Ne())}}h.addQueue(i.RENDER_OPAQUE,"default").addSceneOfCamera(e,new a,t.TRANSPARENT_OBJECT|t.CUTOUT_OBJECT),h.addQueue(i.RENDER_TRANSPARENT,"forward-add").addSceneOfCamera(e,new a,t.TRANSPARENT_OBJECT|t.CUTOUT_OBJECT)},s.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},r}(ze),Fa=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="PostFinalPass",t.outputNames=["PostFinalColor"],t.effectName="pipeline/post-process/post-final",t.enableInAllEditorCamera=!0,t}return te(t,e),t.prototype.render=function(e){if(this.lastPass){ye.clearFlag=e.clearFlag&N.COLOR,V.set(ye.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),ye.material=this.material;var t=n(e),a=this.lastPass.slotName(e,0),r=this.slotName(e,0),s=e.window.framebuffer,i=s&&s.colorTextures[0],o=i?i.format:E.RGBA8,l=ye.shadingScale;ye.updatePassViewPort(1/l,1/l).addRenderPass("post-final",""+this.name+t).setPassInput(a,"inputTexture").addRasterView(r,o,!1).blitScreen(0),this.renderProfiler(e)}},t}(Fe),Va=function(e){function t(){for(var t,a=arguments.length,r=new Array(a),s=0;s<a;s++)r[s]=arguments[s];return(t=e.call.apply(e,[this].concat(r))||this).name="DOFPass",t.effectName="pipeline/post-process/dof",t.outputNames=["DOFColor"],t}te(t,e);var a=t.prototype;return a.checkEnable=function(t){var a=e.prototype.checkEnable.call(this,t);return Ce()&&(a=!1),a},a.render=function(e){var t=n(e);ye.clearFlag=N.COLOR,V.set(ye.clearColor,0,0,0,1);var a=ye.passViewport;ye.material=this.material;var r=this.setting,s=a.width,i=a.height,o=new V(r.focusDistance,r.focusRange,r.bokehRadius,0),l=new V(1/s,1/i,s,i);this.material.setProperty("cocParams",o),this.material.setProperty("mainTexTexelSize",l);var h=this.slotName(e,0),p=this.lastPass.slotName(e,0),u=this.lastPass.slotName(e,1),c="DOF_CIRCLE_OF_CONFUSION"+t;ye.updatePassViewPort().addRenderPass("dof-coc","dof-coc"+t).setPassInput(u,"DepthTex").addRasterView(c,E.RGBA8).blitScreen(0).version();var d="DOF_PREFILTER"+t;ye.updatePassViewPort(.5).addRenderPass("dof-prefilter","dof-prefilter"+t).setPassInput(p,"colorTex").setPassInput(c,"cocTex").addRasterView(d,E.RGBA8).blitScreen(1).version();var m="DOF_BOKEH"+t;ye.updatePassViewPort(.5).addRenderPass("dof-bokeh","dof-bokeh"+t).setPassInput(d,"prefilterTex").addRasterView(m,E.RGBA8).blitScreen(2).version();var f="DOF_FILTER"+t;ye.updatePassViewPort(.5).addRenderPass("dof-filter","dof-filter"+t).setPassInput(m,"bokehTex").addRasterView(f,E.RGBA8).blitScreen(3).version(),ye.updatePassViewPort().addRenderPass("dof-combine","dof-combine"+t).setPassInput(f,"filterTex").setPassInput(c,"cocTex").setPassInput(p,"colorTex").addRasterView(h,E.RGBA8).blitScreen(4).version()},$(t,[{key:"setting",get:function(){return Ue(ga)}}]),t}(ze),La=function(){function e(){this.pipelines=new Map,this.init()}var t=e.prototype;return t.onGlobalPipelineStateChanged=function(){var e=this.pipelines.get("forward");if(void 0!==e)for(var t=0;t<e.length;t++){var a=e[t];"function"==typeof a.onGlobalPipelineStateChanged&&a.onGlobalPipelineStateChanged()}},t.init=function(){var e=new Le,t=new Ve,a=new da;this.addPass(a,"default"),this.addPass(e,"default"),this.addPass(new Ta,"default"),this.addPass(t,"default"),this.addPass(a),this.addPass(e),this.addPass(new Ia),this.addPass(new _a),this.addPass(new Ca),this.addPass(new Na),this.addPass(new Va),this.addPass(new ia),this.addPass(new Ra),this.addPass(new va),this.addPass(new ca),this.addPass(new wa),this.addPass(new la),this.addPass(new Fa)},t.getPass=function(e,t){void 0===t&&(t="forward");var a=this.pipelines.get(t);return a&&a.find((function(t){return t instanceof e}))},t.addPass=function(e,t){void 0===t&&(t="forward");var a=this.pipelines.get(t);a||(a=[],this.pipelines.set(t,a));var r=a.findIndex((function(t){return t.name===e.name}));-1!==r&&a.splice(r,1),a.push(e)},t.insertPass=function(e,t,a){void 0===a&&(a="forward");var r=this.pipelines.get(a);if(r){var s=r.findIndex((function(t){return t.name===e.name}));-1!==s&&r.splice(s,1);var i=r.findIndex((function(e){return e instanceof t}));-1!==i&&r.splice(i+1,0,e)}},t.initEditor=function(){de.root.cameraList.forEach((function(e){"Editor Camera"===e.name&&(e.usePostProcess=e.projectionType===m.PERSPECTIVE)}))},t.applyPreviewCamera=function(e){if(e.node.parent){var t=e.node.parent.getComponent(fe),a=t&&t.camera;a&&(e.postProcess=a.postProcess,e.usePostProcess=a.usePostProcess)}},t.resortEditorCameras=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];"Editor Camera"!==r.name&&"Editor UIGizmoCamera"!==r.name&&"Scene Gizmo Camera"!==r.name||t.push(r)}for(var s=0;s<e.length;s++){var i=e[s];-1===t.indexOf(i)&&t.push(i)}return t},t.setup=function(e,t){var a;ye.ppl=t,ye.shadowPass=void 0,ye.forwardPass=void 0,ye.depthSlotName="",ye.isFinalCamera=!1,ye.isFinalPass=!1;for(var r=0;r<me.all.length;r++){var s=me.all[r];s.global&&(a=s)}for(var i=0;i<e.length;i++){var n=e[i];n.scene&&(t.update(n),i===e.length-1&&(ye.isFinalCamera=!0),t.addBuiltinReflectionProbePass(n),ye.postProcess=n.postProcess||a,de.root.pipelineEvent.emit(f.RENDER_CAMERA_BEGIN,n),this.renderCamera(n,t))}},t.getCameraPipelineName=function(e){var t=e.pipeline;return!t&&e.usePostProcess?"forward":"default"},t.getCameraPasses=function(e){var t=this.getCameraPipelineName(e);return this.pipelines.get(t)||[]},t.renderCamera=function(e,t){ye.passPathName=""+n(e),ye.camera=e,ye.updateViewPort();var a=this.getCameraPasses(e),r=a.find((function(e){return e instanceof ia}));r&&r.checkEnable(e)&&(r.applyCameraJitter(e),r.updateSample());for(var s,i=a.find((function(e){return e instanceof Ca})),o=0;o<a.length;o++){var l=a[o];l.checkEnable(e)&&(o===a.length-1&&(ye.isFinalPass=!0),"BloomPass"===l.name&&(l.hdrInputName=null==i?"":i.getHDRInputName()),l.lastPass=s,l.render(e,t),s=l)}},e}();l("Forward",new La),l("Custom",new La),e("postProcess",Object.freeze({__proto__:null,BasePass:Fe,BlitScreen:pa,BlitScreenPass:ca,Bloom:fa,BloomPass:wa,COPY_INPUT_DS_PASS_INDEX:0,ColorGrading:ma,ColorGradingPass:va,DOF:ga,DofPass:Va,EXPONENT:2,FSR:na,FSRPass:la,FloatOutputProcessPass:Ca,ForwardFinalPass:Ve,ForwardPass:Le,ForwardTransparencyPass:Na,ForwardTransparencySimplePass:Ta,FxaaPass:Ra,HBAO:Pa,I_SAMPLES_COUNT:25,PostFinalPass:Fa,PostProcess:me,PostProcessBuilder:La,PostProcessSetting:je,SSSSBlurData:Ma,SSSS_BLUR_X_PASS_INDEX:1,SSSS_BLUR_Y_PASS_INDEX:2,SettingPass:ze,ShadowPass:da,SkinPass:Ia,TAA:Ge,TAAPass:ia,disablePostProcessForDebugView:Ce,forceEnableFloatOutput:Re,getRTFormatBeforeToneMapping:be,getShadowMapSampler:Ne}))}}}));
//# sourceMappingURL=custom-pipeline-post-process.js.map
