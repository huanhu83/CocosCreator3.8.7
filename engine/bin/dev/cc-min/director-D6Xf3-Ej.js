System.register(["./gc-object-BD6DANSw.js","./_virtual_internal_constants-CVZmBipG.js","./debug-view-zRQBd5E1.js","./index-BcjqSS2q.js","./prefab-CJahvMeV.js","./deprecated-BaebfHhU.js","./scene-D5fG1En6.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./pipeline-state-manager-C4BAah3w.js","./global-exports-ZavlJGEN.js","./node-event-BDYemSfE.js"],(function(e){"use strict";var t,i,n,s,r,o,a,_,c,h,u,l,d,E,f,m,p,R,g,v,T,N,S,y,I,A,P,D,w,F,C,b,M,L,O,W,H,B,V,k,G,U,x,j,z,X,Y,J,q,K,Q,Z,$;return{setters:[function(e){t=e.s,i=e.S,n=e.h,s=e.G,r=e.z,o=e.P,a=e.w,_=e.a,c=e.j,h=e.H,u=e.I,l=e.y,d=e._,E=e.D,f=e.J,m=e.d,p=e.K,R=e.L,g=e.M,v=e.n},null,function(e){T=e.L,N=e.h,S=e.D,y=e.f,I=e.T,A=e.e,P=e.i},function(e){D=e.B,w=e.S},function(e){F=e.i,C=e.C,b=e.N},function(e){M=e.a,L=e.c},function(e){O=e.e,W=e.k,H=e.r,B=e.N,V=e.l},function(e){k=e.d,G=e.L},function(e){U=e.w,x=e.x,j=e.y,z=e.R},function(e){X=e.U,Y=e.a,J=e.b,q=e.c,K=e.d,Q=e.l},function(e){Z=e.c},function(e){$=e.N}],execute:function(){var ee,te,ie;e("X",ee),function(e){e[e.NONE=-1]="NONE",e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT"}(ee||e("X",ee={})),function(e){e[e.SESSION_RUNNING=2]="SESSION_RUNNING",e[e.VIEW_COUNT=6]="VIEW_COUNT",e[e.SWAPCHAIN_WIDTH=7]="SWAPCHAIN_WIDTH",e[e.SWAPCHAIN_HEIGHT=8]="SWAPCHAIN_HEIGHT",e[e.DEVICE_IPD=37]="DEVICE_IPD",e[e.SPLIT_AR_GLASSES=42]="SPLIT_AR_GLASSES"}(te||(te={})),function(e){e[e.VIEW_LEFT=0]="VIEW_LEFT",e[e.HAND_LEFT=1]="HAND_LEFT",e[e.AIM_LEFT=2]="AIM_LEFT",e[e.VIEW_RIGHT=3]="VIEW_RIGHT",e[e.HAND_RIGHT=4]="HAND_RIGHT",e[e.AIM_RIGHT=5]="AIM_RIGHT",e[e.HEAD_MIDDLE=6]="HEAD_MIDDLE"}(ie||(ie={}));var ne=e("R",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=new N,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new S,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._cumulativeTime=0,this._frameTime=0,this._cameraList=[],this._device=e,this._dataPoolMgr=Z.internal.DataPoolManager&&new Z.internal.DataPoolManager(e),M.registerCreateFunc(this),L.registerCreateFunc(this),this._cameraPool=new o((function(){return new y(t._device)}),4,(function(e){return e.destroy()}))}var h=e.prototype;return h.initialize=function(){var e,n=k.swapchain,s=new U;s.format=n.colorTexture.format;var r=new x;r.format=n.depthStencilTexture.format,r.depthStoreOp=j.DISCARD,r.stencilStoreOp=j.DISCARD;var o=new z([s],r);this._mainWindow=this.createWindow({title:"rootMainWindow",width:n.width,height:n.height,renderPassInfo:o,swapchain:n}),this._curWindow=this._mainWindow;var a=t.querySettings(i.ANIMATION,"customJointTextureLayouts")||[];null==(e=this._dataPoolMgr)||e.jointTexturePool.registerCustomTextureLayouts(a),this._resizeMaxJointForDS()},h.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),Z.rendering&&Z.rendering.destroy()},h.resize=function(e,t){this._windows.forEach((function(i){i.swapchain&&i.resize(e,t)}))},h.setRenderPipeline=function(e){var o=Z.internal,a=Z.director,_=Z.rendering,c=Z.legacy_rendering;if(void 0===_&&void 0===c)return n(1223),!1;var h=!1;if(e)this._customPipeline=_.createCustomPipeline(),h=!0,this._pipeline=this._customPipeline,s("Using custom pipeline: "+r.CUSTOM_PIPELINE_NAME);else{var u=c.createDefaultPipeline();h=!0,s("Using legacy pipeline"),this._classicPipeline=u,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1}if((t.querySettings(i.RENDERING,"renderMode")!==G.HEADLESS||this._classicPipeline)&&!this._pipeline.activate(this._mainWindow.swapchain))return h&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var l=a.getScene();return l&&l.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&o.Batcher2D&&(this._batcher=new o.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},h.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();O().skybox.enabled&&O().skybox.model.onGlobalPipelineStateChanged(),this._pipeline.onGlobalPipelineStateChanged()},h.activeWindow=function(e){this._curWindow=e},h.resetCumulativeTime=function(){this._cumulativeTime=0},h.frameMove=function(e){var t;this._frameTime=e,++this._frameCount,this._cumulativeTime+=e,this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),null!=(t=globalThis.__globalXR)&&t.isWebXR?this._doWebXRFrameMove():(this._frameMoveBegin(),this._frameMoveProcess(),this._frameMoveEnd())},h.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},h.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},h.destroyWindows=function(){this._windows.forEach((function(e){e.destroy()})),this._windows.length=0},h.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},h.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},h.destroyScenes=function(){this._scenes.forEach((function(e){e.destroy()})),this._scenes.length=0},h.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new o((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i},h.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):a(1300,e.constructor.name),e.destroy()},h.createCamera=function(){return this._cameraPool.alloc()},h.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new o((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i},h.destroyLight=function(e){if(e.scene)switch(e.type){case T.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case T.SPHERE:e.scene.removeSphereLight(e);break;case T.SPOT:e.scene.removeSpotLight(e);break;case T.POINT:e.scene.removePointLight(e);break;case T.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}e.destroy()},h.recycleLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case T.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case T.SPHERE:e.scene.removeSphereLight(e);break;case T.SPOT:e.scene.removeSpotLight(e);break;case T.POINT:e.scene.removePointLight(e);break;case T.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}},h._doWebXRFrameMove=function(){var e=this,t=globalThis.__globalXR;if(t){var i=this._windows,n=this._cameraList,s=t.webXRMatProjs?t.webXRMatProjs.length:1;t.webXRWindowMap||(t.webXRWindowMap=new Map);for(var r=[],o=t.webxrHmdPoseInfos,a=function(){for(var s,a=c(i);!(s=a()).done;){var h=s.value;r=r.concat(h.cameras),h.swapchain&&t.webXRWindowMap.set(h,_)}if(o){for(var u=[0,0,0],l=0;l<o.length;l++){var d=o[l];if(d.code===ie.VIEW_LEFT&&_===ee.LEFT||d.code===ie.VIEW_RIGHT&&_===ee.RIGHT){u[0]=d.position.x,u[1]=d.position.y,u[2]=d.position.z;break}}r.forEach((function(e){e.trackingType!==I.NO_TRACKING&&e.node&&(e.trackingType===I.ROTATION&&(u=[0,0,0]),e.node.setPosition(u[0],u[1],u[2]))}))}r.length=0,e._frameMoveBegin(),e._frameMoveProcess();for(var E=n.length-1;E>=0;E--){var f=n[E];(_===ee.LEFT&&f.cameraType===A.RIGHT_EYE||_===ee.RIGHT&&f.cameraType===A.LEFT_EYE)&&n.splice(E,1)}e._frameMoveEnd()},_=0;_<s;_++)a()}},h._frameMoveBegin=function(){for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();this._cameraList.length=0},h._frameMoveProcess=function(){for(var e=Z.director,t=this._windows,i=this._cameraList,n=0;n<t.length;n++)t[n].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([k.swapchain]);var s=this._scenes,r=e.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var o=0;o<s.length;o++)s[o].update(r)}},h._frameMoveEnd=function(){var e=Z.director,t=Z.Director,i=this._cameraList;if(this._pipeline&&i.length>0){e.emit(t.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority}));for(var n=0;n<i.length;++n){var s;null==(s=i[n].geometryRenderer)||s.update()}e.emit(t.EVENT_BEFORE_RENDER),this._pipeline.render(i),e.emit(t.EVENT_AFTER_RENDER),this._device.present()}this._batcher&&this._batcher.reset()},h._resizeMaxJointForDS=function(){var e=Math.max((X.COUNT+Y.COUNT+J.COUNT+q.COUNT+K.COUNT)/4,100),t=Math.floor((k.gfxDevice.capabilities.maxVertexUniformVectors-e)/3);Q(t=t<256?t:256)},_(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0&&(this._fixedFPS=e)}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}},{key:"cameraList",get:function(){return this._cameraList}}]),e}());Z.Root=ne;var se,re=function(){function e(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}var t=e.prototype;return t.addRenderer=function(e){-1===e._internalId&&(e._internalId=this._allRenderers.length,this._allRenderers.push(e))},t.removeRenderer=function(e){if(-1!==e._internalId){h(this._allRenderers[e._internalId]===e);var t=e._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=t,u(this._allRenderers,t),e._internalId=-1,e._dirtyVersion===this._dirtyVersion&&(l(this._dirtyRenderers,e),e._dirtyVersion=-1)}},t.markDirtyRenderer=function(e){e._dirtyVersion!==this._dirtyVersion&&-1!==e._internalId&&(this._dirtyRenderers.push(e),e._dirtyVersion=this._dirtyVersion)},t.updateAllDirtyRenderers=function(){for(var e=this._dirtyRenderers,t=0;t<this._dirtyRenderers.length;t++)h(-1!==e[t]._internalId),e[t].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++},e}(),oe=e("u",new re);e("D",se),function(e){e.INIT="director_init",e.RESET="director_reset",e.BEFORE_SCENE_LOADING="director_before_scene_loading",e.BEFORE_SCENE_LAUNCH="director_before_scene_launch",e.AFTER_SCENE_LAUNCH="director_after_scene_launch",e.BEFORE_UPDATE="director_before_update",e.AFTER_UPDATE="director_after_update",e.BEFORE_DRAW="director_before_draw",e.AFTER_DRAW="director_after_draw",e.BEFORE_COMMIT="director_before_commit",e.BEFORE_RENDER="director_before_render",e.AFTER_RENDER="director_after_render",e.BEFORE_PHYSICS="director_before_physics",e.AFTER_PHYSICS="director_after_physics",e.BEGIN_FRAME="director_begin_frame",e.END_FRAME="director_end_frame"}(se||e("D",se={}));var ae=e("a",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=new C,t._nodeActivator=new b,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new D,t._systems=[],t._persistRootNodes={},t}d(t,e);var i=t.prototype;return i.end=function(){var e=this;this.once(se.END_FRAME,(function(){e.purgeDirector()}))},i.pause=function(){this._paused=!0},i.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),E(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),W.releaseAll()},i.reset=function(){for(var e in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[e]);var t=this.getScene();t&&t.destroy(),this.emit(se.RESET),this.startAnimation()},i.runSceneImmediate=function(e,t,i){var n=this;e instanceof P&&(e=e.scene),f(e instanceof V,1216),console.time("InitScene"),e._load(),console.timeEnd("InitScene"),console.time("AttachPersist");for(var s=Object.keys(this._persistRootNodes).map((function(e){return n._persistRootNodes[e]})),r=0;r<s.length;r++){var o=s[r];o.emit($.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var _=a.siblingIndex;o.hideFlags&=~m.DontSave,o.hideFlags|=m.DontSave&a.hideFlags,a._destroyImmediate(),e.insertChild(o,_)}else o.hideFlags|=m.DontSave,o.parent=e}console.timeEnd("AttachPersist");var c=this._scene;console.time("Destroy"),E(c)&&c.destroy(),console.time("AutoRelease"),H._autoRelease(c,e,this._persistRootNodes),console.timeEnd("AutoRelease"),this._scene=null,p._deferredDestroy(),console.timeEnd("Destroy"),t&&t(),this.emit(se.BEFORE_SCENE_LAUNCH,e),this._scene=e,console.time("Activate"),e._activate(),console.timeEnd("Activate"),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(se.AFTER_SCENE_LAUNCH,e)},i.runScene=function(e,t,i){var n=this;e instanceof P&&(e=e.scene),f(Boolean(e),1205),f(e instanceof V,1216),this.once(se.END_FRAME,(function(){n.runSceneImmediate(e,t,i)}))},i.loadScene=function(e,t,i){var s=this;if(this._loadingScene)return a(1208,e,this._loadingScene),!1;var r=W.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(se.BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(n,r){console.timeEnd("LoadScene "+e),s._loadingScene="",n?(R(n),t&&t(n)):s.runSceneImmediate(r,i,t)})),!0):(n(1209,e),!1)},i.preloadScene=function(e,t,i){var n=W.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(n)n.preloadScene(e,null,t,i);else{var s='Can not preload the scene "'+e+'" because it is not in the build settings.';i&&i(new Error(s)),R("preloadScene: "+s)}},i.resume=function(){this._paused=!1},i.getScene=function(){return this._scene},i.getDeltaTime=function(){return Z.game.deltaTime},i.getTotalTime=function(){return Z.game.totalTime},i.getCurrentTime=function(){return Z.game.frameStartTime},i.getTotalFrames=function(){return this._totalFrames},i.isPaused=function(){return this._paused},i.getScheduler=function(){return this._scheduler},i.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(D.ID,e,200))},i.registerSystem=function(e,t,i){t.id=e,t.priority=i,this._systems.push(t),this._systems.sort(w.sortByPriority)},i.unregisterSystem=function(e){l(this._systems,e),this._systems.sort(w.sortByPriority)},i.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},i.getAnimationManager=function(){return this.getSystem(Z.AnimationManager.ID)},i.startAnimation=function(){this._invalid=!1},i.stopAnimation=function(){this._invalid=!0},i.mainLoop=function(){var e;e=Z.game._calculateDT(!1),this.tick(e)},i.tick=function(e){if(!this._invalid){if(this.emit(se.BEGIN_FRAME),F._frameDispatchEvents(),!this._paused){this.emit(se.BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(se.AFTER_UPDATE),p._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(se.BEFORE_DRAW),oe.updateAllDirtyRenderers(),this._root.frameMove(e),this.emit(se.AFTER_DRAW),B.resetHasChangedFlags(),B.clearNodeArray(),g.update(e),this.emit(se.END_FRAME),this._totalFrames++}},i.buildRenderPipeline=function(){if(this._root){var e=this._root.customPipeline,t=this._root.cameraList;e.beginSetup();var i=Z.rendering.getCustomPipeline(r.CUSTOM_PIPELINE_NAME);Z.rendering.dispatchResizeEvents(t,i,e),i.setup(t,e),e.endSetup()}},i.setupRenderPipelineBuilder=function(){""!==r.CUSTOM_PIPELINE_NAME&&Z.rendering&&this._root&&this._root.usesCustomPipeline&&this.on(se.BEFORE_SCENE_LAUNCH,Z.rendering.forceResizeAllWindows,Z.rendering)},i.init=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(D.ID,this._scheduler,200),this._root=new ne(k.gfxDevice),this._root.initialize({}),this.setupRenderPipelineBuilder();for(var e=0;e<this._systems.length;e++)this._systems[e].init();this.emit(se.INIT)},i.addPersistRootNode=function(e){if(B.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=this._scene;if(E(i))if(e.parent){if(!(e.parent instanceof V))return void a(3801);if(e.parent!==i)return void a(3802);e._originalSceneId=i.uuid}else e.parent=i,e._originalSceneId=i.uuid;this._persistRootNodes[t]=e,e._persistNode=!0,H._addPersistNodeRef(e)}}else a(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",H._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},_(t,[{key:"root",get:function(){return this._root}}]),t}(v));ae.EVENT_INIT=se.INIT,ae.EVENT_RESET=se.RESET,ae.EVENT_BEFORE_SCENE_LOADING=se.BEFORE_SCENE_LOADING,ae.EVENT_BEFORE_SCENE_LAUNCH=se.BEFORE_SCENE_LAUNCH,ae.EVENT_AFTER_SCENE_LAUNCH=se.AFTER_SCENE_LAUNCH,ae.EVENT_BEFORE_UPDATE=se.BEFORE_UPDATE,ae.EVENT_AFTER_UPDATE=se.AFTER_UPDATE,ae.EVENT_BEFORE_DRAW=se.BEFORE_DRAW,ae.EVENT_AFTER_DRAW=se.AFTER_DRAW,ae.EVENT_BEFORE_COMMIT=se.BEFORE_COMMIT,ae.EVENT_BEFORE_RENDER=se.BEFORE_RENDER,ae.EVENT_AFTER_RENDER=se.AFTER_RENDER,ae.EVENT_BEFORE_PHYSICS=se.BEFORE_PHYSICS,ae.EVENT_AFTER_PHYSICS=se.AFTER_PHYSICS,ae.EVENT_BEGIN_FRAME=se.BEGIN_FRAME,ae.EVENT_END_FRAME=se.END_FRAME,ae.instance=void 0,Z.Director=ae,Z.DirectorEvent=se,e("d",ae.instance=Z.director=new ae)}}}));
//# sourceMappingURL=director-D6Xf3-Ej.js.map
