System.register(["./gc-object-BD6DANSw.js","./buffer-barrier-CZBuOw0V.js","./device-manager-BCOP-4pU.js","./index-BcjqSS2q.js","./wasm-web-DpHjq6qw.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js"],(function(e,t){"use strict";var r,i,s,n,a,u,o,l,c,h,f,p,d,g,_,m,v,x,T,R,b,y,S,B,A,E,C,G,P,w,F,I,D,U,L,M,O,N,k,z,V,X,W,H,q,Y,Q,j,$,K,Z,J,ee,te,re,ie,se,ne,ae,ue,oe,le,ce,he,fe,pe,de,ge,_e,me,ve,xe,Te,Re,be,ye,Se,Be,Ae,Ee,Ce,Ge,Pe,we;return{setters:[function(e){r=e.a,i=e._,s=e.F,n=e.ar,a=e.as,u=e.L,o=e.G,l=e.a5,c=e.j,h=e.w,f=e.h,p=e.at,d=e.x},function(e){g=e.B,_=e.b,m=e.M,v=e.ak,x=e.F,T=e.am,R=e.ac,b=e.D,y=e.v,S=e.c,B=e.p,A=e.h,E=e.br,C=e.aH,G=e.bq,P=e.S,w=e.d,F=e.e,I=e.ar,D=e.au,U=e.at,L=e.V,M=e.W,O=e.aN,N=e.H,k=e.bo,z=e.ao,V=e.ax,X=e._,W=e.Q,H=e.N,q=e.as,Y=e.X,Q=e.Y,j=e.ai,$=e.P,K=e.aq,Z=e.Z,J=e.$,ee=e.aP,te=e.y,re=e.O,ie=e.K,se=e.L,ne=e.a3,ae=e.a6,ue=e.a4,oe=e.T,le=e.aO,ce=e.aI,he=e.J,fe=e.f,pe=e.G,de=e.a0,ge=e.a1,_e=e.a2,me=e.o,ve=e.ad,xe=e.g,Te=e.r,Re=e.E,be=e.a7,ye=e.a_,Se=e.a$,Be=e.an,Ae=e.q,Ee=e.ay},null,function(e){Ce=e.n},function(e){Ge=e.e,Pe=e.i},null,function(e){we=e.l}],execute:function(){var Fe=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function Ie(e,t){return t^2654435769+(e>>>0)+(t<<6)+(t>>2)}function De(e,t){return Ie(177573^e,t)}function Ue(e,t){for(var r=5381,i=e.length,s=0;s<i;s++)r=33*r^e.charCodeAt(s);return Ie(r,t)}Fe._instance=null;var Le={glslang:void 0,twgsl:void 0};function Me(e){"compileGLSL"in e?Le.glslang=e:"convertSpirV2WGSL"in e&&(Le.twgsl=e)}var Oe,Ne=function(){function e(){this.buffersDescLayout=new Map,this.texturesDescLayout=new Map,this.samplersDescLayout=new Map,this.buffer=void 0,this.storageBuffers=[],this.texture=void 0,this.cubeTexture=void 0,this.sampler=void 0,this.setLayout=void 0,this.descSet=void 0}return e.prototype.getStorageBuffer=function(e){if(this.storageBuffers[e])return this.storageBuffers[e];var t=new g(_.STORAGE,m.DEVICE,16,16,v.NONE),r=Fe.instance.createBuffer(t);return this.storageBuffers[e]=r,r},e}();!function(e){e[e.LOW=0]="LOW",e[e.NORMAL=1]="NORMAL"}(Oe||(Oe={}));var ke=["repeat","mirror-repeat","clamp-to-edge","clamp-to-edge"],ze=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"];function Ve(e){var t=0;if(e&P.VERTEX&&(t|=GPUShaderStage.VERTEX),e&P.FRAGMENT&&(t|=GPUShaderStage.FRAGMENT),e&P.COMPUTE&&(t|=GPUShaderStage.COMPUTE),e===P.ALL&&(t|=GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE),0===t)throw new Error("shader stage not supported by webGPU!");return t}function Xe(e){switch(e){case x.R32F:return"float32";case x.R32UI:return"uint32";case x.R32I:return"sint32";case x.RG8:return"unorm8x2";case x.RG8SN:return"snorm8x2";case x.RG8UI:return"uint8x2";case x.RG8I:return"sint8x2";case x.RG16F:return"float16x2";case x.RG16UI:return"uint16x2";case x.RG16I:return"sint16x2";case x.RG32F:return"float32x2";case x.RG32UI:return"uint32x2";case x.RG32I:return"sint32x2";case x.RGB32F:return"float32x3";case x.RGB32UI:return"uint32x3";case x.RGB32I:return"sint32x3";case x.BGRA8:case x.RGBA8:return"unorm8x4";case x.SRGB8_A8:return"uint8x4";case x.RGBA8SN:return"snorm8x4";case x.RGBA8UI:return"uint8x4";case x.RGBA8I:return"sint8x4";case x.RGBA16F:return"float16x4";case x.RGBA16UI:return"uint16x4";case x.RGBA16I:return"sint16x4";case x.RGBA32F:return"float32x4";case x.RGBA32UI:return"uint32x4";case x.RGBA32I:return"sint32x4";default:return s("Unsupported Format, return sint8x4 in default."),"sint8x4"}}function We(e){switch(e){case x.R8:return"r8unorm";case x.R8SN:return"r8snorm";case x.R8UI:return"r8uint";case x.R8I:return"r8sint";case x.RG8:return"rg8unorm";case x.RG8SN:return"rg8snorm";case x.RG8UI:return"rg8uint";case x.RG8I:return"rg8sint";case x.BGRA8:return"bgra8unorm";case x.RGBA8:return"rgba8unorm";case x.SRGB8_A8:return"rgba8unorm-srgb";case x.RGBA8SN:return"rgba8snorm";case x.RGBA8UI:return"rgba8uint";case x.RGBA8I:return"rgba8sint";case x.R16I:return"r16sint";case x.R16UI:return"r16uint";case x.R16F:return"r16sint";case x.RG16I:return"rg16sint";case x.RG16UI:return"rg16uint";case x.RG16F:return"rg16float";case x.RGBA16I:return"rgba16sint";case x.RGBA16UI:return"rgba16uint";case x.RGBA16F:return"rgba16float";case x.R32I:return"r32sint";case x.R32UI:return"r32uint";case x.R32F:return"r32float";case x.RG32I:return"rg32sint";case x.RG32UI:return"rg32uint";case x.RG32F:return"rg32float";case x.RGBA32I:return"rgba32sint";case x.RGBA32UI:return"rgba32uint";case x.RGBA32F:return"rgba32float";case x.RGB10A2:return"rgb10a2unorm";case x.DEPTH:return"depth24plus";case x.DEPTH_STENCIL:return"depth24plus-stencil8";case x.BC1_ALPHA:return"bc1-rgba-unorm";case x.BC1_SRGB_ALPHA:return"bc1-rgba-unorm-srgb";case x.BC2:return"bc2-rgba-unorm";case x.BC2_SRGB:return"bc2-rgba-unorm-srgb";case x.BC3:return"bc3-rgba-unorm";case x.BC3_SRGB:return"bc3-rgba-unorm-srgb";case x.BC4_SNORM:return"bc4-r-snorm";case x.BC6H_SF16:return"bc6h-rgb-float";case x.BC6H_UF16:return"bc6h-rgb-ufloat";case x.BC7:return"bc7-rgba-unorm";case x.BC7_SRGB:return"bc7-rgba-unorm-srgb";default:return s("Unsupported Format, return rgba8unorm indefault."),"rgba8unorm"}}function He(e){return We(e)}function qe(e){switch(e){case"r8unorm":return x.R8;case"r8snorm":return x.R8SN;case"r8uint":return x.R8UI;case"r8sint":return x.R8I;case"rg8unorm":return x.RG8;case"rg8snorm":return x.RG8SN;case"rg8uint":return x.RG8UI;case"rg8sint":return x.RG8I;case"bgra8unorm":return x.BGRA8;case"rgba8unorm":default:return x.RGBA8;case"rgba8unorm-srgb":return x.SRGB8_A8;case"rgba8snorm":return x.RGBA8SN;case"rgba8uint":return x.RGBA8UI;case"rgba8sint":return x.RGBA8I;case"r16sint":return x.R16I;case"r16uint":return x.R16UI;case"r16float":return x.R16F;case"rg16sint":return x.RG16I;case"rg16uint":return x.RG16UI;case"rg16float":return x.RG16F;case"rgba16sint":return x.RGBA16I;case"rgba16uint":return x.RGBA16UI;case"rgba16float":return x.RGBA16F;case"r32sint":return x.R32I;case"r32uint":return x.R32UI;case"r32float":return x.R32F;case"rg32sint":return x.RG32I;case"rg32uint":return x.RG32UI;case"rg32float":return x.RG32F;case"rgba32sint":return x.RGBA32I;case"rgba32uint":return x.RGBA32UI;case"rgba32float":return x.RGBA32F;case"rgb10a2unorm":return x.RGB10A2;case"depth24plus":return x.DEPTH;case"depth24plus-stencil8":return x.DEPTH_STENCIL;case"bc1-rgba-unorm":return x.BC1_ALPHA;case"bc1-rgba-unorm-srgb":return x.BC1_SRGB_ALPHA;case"bc2-rgba-unorm":return x.BC2;case"bc2-rgba-unorm-srgb":return x.BC2_SRGB;case"bc3-rgba-unorm":return x.BC3;case"bc3-rgba-unorm-srgb":return x.BC3_SRGB;case"bc4-r-snorm":return x.BC4_SNORM;case"bc6h-rgb-float":return x.BC6H_SF16;case"bc6h-rgb-ufloat":return x.BC6H_UF16;case"bc7-rgba-unorm":return x.BC7;case"bc7-rgba-unorm-srgb":return x.BC7_SRGB}}function Ye(e){return qe(e)}function Qe(e){switch(e){case w.TEX1D:return"1d";case w.TEX2D:return"2d";case w.TEX2D_ARRAY:return"2d-array";case w.TEX3D:return"3d";case w.CUBE:return"cube";default:return u("Unsupported textureType, convert to WebGPUTexture failed."),"2d"}}var je=["zero","keep","replace","increment-clamp","decrement-clamp","invert","increment-wrap","decrement-wrap"],$e=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],Ke=["add","subtract","reverse-subtract","min","max"];function Ze(e){switch(e){case T.R:return GPUColorWrite.RED;case T.G:return GPUColorWrite.GREEN;case T.B:return GPUColorWrite.BLUE;case T.A:return GPUColorWrite.ALPHA;default:return GPUColorWrite.ALL}}var Je,et=["zero","one","src-alpha","dst-alpha","one-minus-src-alpha","one-minus-dst-alpha","src","dst","one-minus-src","one-minus-dst","src-alpha-saturated","constant","one-minus-constant","src-alpha","one-minus-src-alpha"];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Je||(Je={}));var tt=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},rt=function(e){function t(){var t;return(t=e.call(this,Je.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new R,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return i(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(tt),it=function(e){function t(){var t;return(t=e.call(this,Je.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.viewport=null,t.scissor=null,t.lineWidth=null,t.depthBias=null,t.blendConstants=[],t.depthBounds=null,t.stencilWriteMask=null,t.stencilCompareMask=null,t}return i(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null},t}(tt),st=function(e){function t(){var t;return(t=e.call(this,Je.DRAW)||this).drawInfo=new b,t}return i(t,e),t.prototype.clear=function(){},t}(tt),nt=function(e){function t(){var t;return(t=e.call(this,Je.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return i(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(tt),at=function(e){function t(){var t;return(t=e.call(this,Je.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return i(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(tt),ut=function(){function e(){this.cmds=new l(1),this.beginRenderPassCmds=new l(1),this.bindStatesCmds=new l(1),this.drawCmds=new l(1),this.updateBufferCmds=new l(1),this.copyBufferToTextureCmds=new l(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function ot(e,t){var r=e.nativeDevice,i={};i.size=t.size;var n=0;!(t.usage&_.INDEX||t.usage&_.VERTEX)||t.usage&_.TRANSFER_DST||(t.usage|=_.TRANSFER_DST),t.usage&_.VERTEX&&(n|=GPUBufferUsage.VERTEX),t.usage&_.INDEX&&(n|=GPUBufferUsage.INDEX),t.usage&_.UNIFORM&&(n|=GPUBufferUsage.UNIFORM),t.usage&_.INDIRECT&&(n|=GPUBufferUsage.INDIRECT),t.usage&_.TRANSFER_SRC&&(n|=GPUBufferUsage.COPY_SRC),t.usage&_.TRANSFER_DST&&(n|=GPUBufferUsage.COPY_DST),t.usage&_.STORAGE&&(n|=GPUBufferUsage.STORAGE),0===n&&(s("Unsupported GFXBufferType yet, create UNIFORM buffer in default."),n|=GPUBufferUsage.UNIFORM),n&GPUBufferUsage.COPY_DST||(n|=GPUBufferUsage.COPY_DST),i.usage=n,t.gpuTarget=n,t.gpuBuffer=r.createBuffer(i)}function lt(e,t){t.gpuBuffer&&t.gpuBuffer.destroy()}function ct(e,t){lt(0,t),ot(e,t)}function ht(e,t,r,i,s){if(t.usage&_.INDIRECT)t.indirects.length=i,Array.prototype.push.apply(t.indirects,r.drawInfos);else{var n,a=e.nativeDevice,u=r;(n="buffer"in(u=u.slice(0,s))?u.buffer:u).byteLength!==s&&(n=n.slice(0,s));var o=a.createBuffer({label:"staging buffer "+s,size:s,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),l=o.getMappedRange();new Uint8Array(l).set(new Uint8Array(n)),o.unmap();var c=a.createCommandEncoder();c.copyBufferToBuffer(o,0,t.gpuBuffer,i,s);var h=c.finish();a.queue.submit([h]),o.destroy()}}function ft(e,t){var r,i;t.gpuTarget=Qe(t.type),t.gpuInternalFmt=We(t.format),t.gpuFormat=He(t.format),t.gpuUsage=(i=0,(r=t.usage)&F.TRANSFER_SRC&&(i|=GPUTextureUsage.COPY_SRC),r&F.TRANSFER_DST&&(i|=GPUTextureUsage.COPY_DST),r&F.SAMPLED&&(i|=GPUTextureUsage.TEXTURE_BINDING),r&F.STORAGE&&(i|=GPUTextureUsage.STORAGE_BINDING),(r&F.COLOR_ATTACHMENT||r&F.DEPTH_STENCIL_ATTACHMENT)&&(i|=GPUTextureUsage.RENDER_ATTACHMENT),i||(i=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT),i&GPUTextureUsage.TEXTURE_BINDING&&!(i&GPUTextureUsage.RENDER_ATTACHMENT)&&(i|=GPUTextureUsage.RENDER_ATTACHMENT),i),t.gpuWrapS=t.isPowerOf2?"repeat":"clamp-to-edge",t.gpuWrapT=t.isPowerOf2?"repeat":"clamp-to-edge",t.gpuMinFilter="linear",t.gpuMagFilter="linear",t.samples=Number(t.samples)>1?4:1;var s={size:[t.width,t.height,t.arrayLayer],mipLevelCount:t.mipLevel,sampleCount:t.samples,format:t.gpuFormat,usage:t.gpuUsage};t.gpuTexture=e.nativeDevice.createTexture(s)}function pt(e){e.gpuTexture&&e.gpuTexture.destroy()}function dt(e,t){t.gpuTexture&&pt(t),ft(e,t)}function gt(e,t){var r=e.nativeDevice;t.gpuMinFilter=t.minFilter===y.LINEAR||t.minFilter===y.ANISOTROPIC?"linear":"nearest",t.gpuMagFilter=t.magFilter===y.LINEAR||t.magFilter===y.ANISOTROPIC?"linear":"nearest",t.gpuMipFilter=t.mipFilter===y.LINEAR||t.mipFilter===y.ANISOTROPIC?"linear":"nearest",t.gpuWrapS=ke[t.addressU],t.gpuWrapT=ke[t.addressV],t.gpuWrapR=ke[t.addressW];var i={};i.addressModeU=t.gpuWrapS,i.addressModeV=t.gpuWrapT,i.addressModeW=t.gpuWrapR,i.minFilter=t.gpuMinFilter,i.magFilter=t.gpuMagFilter,i.mipmapFilter=t.gpuMipFilter,i.lodMinClamp=0,i.lodMaxClamp=t.mipLevel,"always"!==ze[t.compare]&&(i.compare=ze[t.compare]),i.maxAnisotropy=t.maxAnisotropy||1;var s=r.createSampler(i);t.gpuSampler=s}var _t={},mt=[];function vt(e,t,r,i){return xt.apply(this,arguments)}function xt(){return(xt=n(a().mark((function e(t,r,i,s){var n,u,o,l,c,h,f,p,d,g;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0,u=0,o=1,l=1,c=t.nativeDevice,h=c.createCommandEncoder({}),f=s.length,p=0;case 8:if(!(p<f)){e.next=27;break}return mt[p]&&i[p].set(new Uint8Array(mt[p]),0),_t.size=i[p].byteLength,_t.usage=GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST,d=c.createBuffer(_t),g=s[p],n=g.texOffset.x,u=g.texOffset.y,o=g.texExtent.width,l=g.texExtent.height,h.copyTextureToBuffer({texture:r.gpuTexture,mipLevel:0,origin:{x:n,y:u}},{buffer:d,offset:0,bytesPerRow:4*o,rowsPerImage:l},{width:o,height:l}),c.queue.submit([h.finish()]),e.next=22,d.mapAsync(GPUMapMode.READ);case 22:mt[p]=d.getMappedRange(),i[p].set(new Uint8Array(mt[p]),0);case 24:p++,e.next=8;break;case 27:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Tt(e){for(var t=/.*?(\(set = \d+, binding = )(\d+)\) uniform[^;]+sampler(\w*) (\w+);/g,r=t.exec(e),i=new Map;r;){var s=r[4],n=r[3];i.set(s,n),r=t.exec(e)}for(var a=e,u=/.*?(\(set = \d+, binding = )(\d+)\) uniform[^;]+sampler(\w*) (\w+);/g,o=u.exec(a);o;)a=a.replace(u,"layout$1 $2) uniform texture$3 $4;\n\n        layout$1 $2 + 16) uniform sampler $4_sampler;\n"),o=u.exec(a);for(var l=["texture","textureSize","texelFetch","textureLod"],c=function(e,t,r){return l.forEach((function(i){for(var s=new RegExp(i+"\\s*\\(\\s*"+e+"\\s*,"),n=s.exec(r);n;)r=r.replace(n[0],i+"(sampler"+t+"("+e+", "+e+"_sampler),"),n=s.exec(r)})),r},h=/\s([\S]+)\s*\(([\w\s,]+)\)[\s|\\|n]*{/g,f=h.exec(a),p=new Set,d=new Map,g=function(){d.clear();var e=f[2],t=e.slice();if(e.includes("sampler")){for(var r=new Set,i=e.split(","),s=i.length,n=0;n<s;++n){var u=i[n].split(" "),o=u[u.length-2];if(o.includes("sampler")&&"sampler"!==o){var l=o.replace("sampler",""),g=u[u.length-1];t=t.replace(i[n]," texture"+l+" "+g+", sampler "+g+"_sampler"),r.add(n),d.set(g,l)}}a=a.replace(e,t);var _=f[1];if(!p.has(_))for(var m,v=new RegExp(_+"\\s*?\\((\\s*[^;\\{]+)","g");null!==(m=v.exec(a));)if(!m[1].match(/\b\w+\b\s*\b\w+\b/g)){for(var x=")"===m[1][m[1].length-1]?m[1].slice(0,-1):m[1],T=x.split(","),R=0,b=0,y=T.length,S=0;S<y;++S)T[S].includes("(")&&++R,T[S].includes(")")&&--R,R&&S!==y-1||(r.has(b)&&(T[S]+=", "+T[S]+"_sampler"),++b);var B=T.join(","),A=m[0].replace(x,B);a=a.replace(m[0],A)}var E=1,C=a.indexOf(f[1],f.index);C=a.indexOf("{",C)+1;for(var G=0;E;){if("{"===a.charAt(C)?++E:"}"===a.charAt(C)&&--E,0===E){G=C;break}var P=a.indexOf("{",C+1),w=a.indexOf("}",C+1);C=-1===P?w:Math.min(P,w)}var F=a.slice(f.index,G),I=F;d.forEach((function(e,t){I=c(t,e,I)})),a=a.replace(F,I),p.add(f[1])}f=h.exec(a)};f;)g();i.forEach((function(e,t){a=c(t,e,a)}));var _="";-1!==a.indexOf("isnan")&&(_+="\n\n         bool isNan(highp float val) {\n             return (val < 0.0 || 0.0 < val || val == 0.0) ? false : true;\n         }\n         \n",a=a.replace(/isnan\(/gi,"isNan(")),-1!==a.indexOf("isinf")&&(_+="\n\n         bool isInf(highp float x) {\n             return x == x * 2.0 && x != 0.0;\n         }\n         \n",a=a.replace(/isinf\(/gi,"isInf("));var m=a.indexOf("precision");return m=a.indexOf(";",m),m+=1,a=a.slice(0,m)+"\n"+_+"\n"+a.slice(m)}function Rt(e){for(var t,r=[],i=c(e);!(t=i()).done;)for(var s=t.value,n=/@group\((\d)\)\s+@binding\((\d+)\)/g,a=n.exec(s);a;){for(var u=+a[1],o=+a[2];r.length<=u;)r.push([]);r[u][r[u].length]=o,a=n.exec(s)}return r}var bt={vertShader:null,fragShader:null,bindGroupLayout:null,pipelineLayout:null,pipeline:null};function yt(e,t,r,i){var s,n=t.gpuTexture.format;t.gpuTarget;var a=e.nativeDevice;if(!bt.vertShader){var u=a.createShaderModule({code:"\n        struct VertexOutput {\n            @builtin(position) Position: vec4<f32>,\n        }\n\n        @vertex\n        fn main(@builtin(vertex_index) VertexIndex: u32) -> VertexOutput {\n            var pos = array<vec2<f32>, 6>(\n            vec2<f32>(1.0, 1.0),\n            vec2<f32>(1.0, -1.0),\n            vec2<f32>(-1.0, -1.0),\n            vec2<f32>(1.0, 1.0),\n            vec2<f32>(-1.0, -1.0),\n            vec2<f32>(-1.0, 1.0)\n            );\n\n            var output: VertexOutput;\n            output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n            return output;\n        }\n        "}),o=a.createShaderModule({code:"\n        struct ClearColor {\n            color: vec4<f32>,\n        }\n\n        @group(0) @binding(0) var<uniform> uClearColor: ClearColor;\n\n        @fragment\n        fn main() -> @location(0) vec4<f32> {\n            return uClearColor.color;\n        }\n        "});bt.vertShader=u,bt.fragShader=o;var l={label:"clearPassBGLayout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform",hasDynamicOffset:!1,minBindingSize:16}}]},c=a.createBindGroupLayout(l);bt.bindGroupLayout=c;var h={label:"clearPassPipelineLayout",bindGroupLayouts:[bt.bindGroupLayout]},f=a.createPipelineLayout(h);bt.pipelineLayout=f;var p={module:bt.vertShader,entryPoint:"main"},d={format:n,writeMask:15},g={module:bt.fragShader,entryPoint:"main",targets:[d]},_={label:"clearPassPipeline",layout:bt.pipelineLayout,vertex:p,primitive:{topology:"triangle-list",frontFace:"ccw",cullMode:"none"},fragment:g,multisample:{count:1,alphaToCoverageEnabled:!1,mask:4294967295}},m=a.createRenderPipeline(_);bt.pipeline=m}var v=a.createCommandEncoder(),x={format:n,dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,aspect:"all"},T=null==(s=t.gpuTexture)?void 0:s.createView(x),R={usage:GPUBufferUsage.UNIFORM,size:16,mappedAtCreation:!0},b=a.createBuffer(R),y=[i.x,i.y,i.z,i.w],S=b.getMappedRange(0,16);new Float32Array(S).set(y),b.unmap();var B={binding:0,resource:{buffer:b,offset:0,size:16}},A={layout:bt.bindGroupLayout,entries:[B]},E=a.createBindGroup(A),C={colorAttachments:[{view:T,loadOp:"load",storeOp:"store",clearValue:[.88,.88,.88,1]}]},G=v.beginRenderPass(C);G.setPipeline(bt.pipeline),G.setBindGroup(0,E),G.setViewport(r.x,r.y,r.width,r.height,0,1),G.setScissorRect(r.x,r.y,r.width,r.height),G.draw(6,1,0,0),G.end();var P=v.finish();a.queue.submit([P]),b.destroy()}function St(e){if(e.type===P.VERTEX){var t=e.source.match(/@location\(\d+\)[ ]+\w+/g);t&&t.forEach((function(t){var r=t.match(/@location\((\d+)\)/g),i=r[0].slice(r[0].indexOf("(")+1,r[0].indexOf(")")).trim(),s=t.replace(/@location\(\d+\)/,"").trim(),n=new RegExp(",*[ ]*@location\\(\\d+\\)[ ]+"+s+"+\\b\\s*:\\s*\\w+\\<\\w+\\>\\s*"),a=new RegExp("\\b(\\w+)\\s*=[ ]*"+s+"\\b\\s*;","g"),u=e.source.match(a)[0],o=u.slice(0,u.indexOf("=")).trim(),l=new RegExp("\\.*\\b"+o+"\\b\\.*","g"),c=e.source.match(l);if((c?c.length:0)<=2){e.source=e.source.replace(n,""),e.source=e.source.replace(a,"");var h=new RegExp("var\\<\\w+\\>\\s+"+o+"+\\s*:\\s*\\w+\\<\\w+\\>\\s*;");e.source=e.source.replace(h,"")}else e.attrs.set(parseInt(i),s)}))}}function Bt(e,t){for(var r=e.nativeDevice,i=e.glslang,s=e.twgsl,n=[],a=t.gpuStages.length,l=function(){n.length=0;var e=t.gpuStages[c],a=Tt(e.source),l=e.type===P.VERTEX?"vertex":e.type===P.FRAGMENT?"fragment":"compute",h="#version 450\n#define CC_USE_WGPU 1\n"+a,f=i.compileGLSL(h,l,!1,"1.3"),p=s.convertSpirV2WGSL(f);""===p&&u("empty wgsl"),e.source=p,St(e),p=e.source;var d=null==r?void 0:r.createShaderModule({code:p});d.getCompilationInfo().then((function(e){e.messages.forEach((function(e){o(h,p,e.lineNum,e.linePos,e.type,e.message)}))})).catch((function(e){e.messages.forEach((function(e){o(h,p,e.lineNum,e.linePos,e.type,e.message)}))}));var g={module:d,entryPoint:"main"};e.gpuShader=g,n.push(p);var _=Rt(n);e.bindings=_;for(var m=_.length,v=0;v<m;v++){var x=_[v].length;if(x){t.bindings.has(v)||t.bindings.set(v,[]);for(var T=t.bindings.get(v),R=0;R<x;R++)T.includes(_[v][R])||T.push(_[v][R])}}},c=0;c<a;++c)l()}function At(e,t){var r=t.attributes.length;t.gpuAttribs=new Array(r);for(var i=[0,0,0,0,0,0,0,0],s=0;s<r;++s){var n=t.attributes[s],a=void 0!==n.stream?n.stream:0,u=t.gpuVertexBuffers[a],o=S[n.format].size;t.gpuAttribs[s]={name:n.name,gpuBuffer:u.gpuBuffer,gpuType:0,size:o,count:S[n.format].count,stride:u.stride,componentCount:4,isNormalized:void 0!==n.isNormalized&&n.isNormalized,isInstanced:void 0!==n.isInstanced&&n.isInstanced,offset:i[a]},i[a]+=o}}function Et(e,t,r,i){for(var s=e.nativeDevice,n=i.length,a=0;a<n;a++){var u=i[a],o=t[a];s.queue.copyExternalImageToTexture({source:o},{texture:r.gpuTexture,mipLevel:u.texSubres.mipLevel,origin:{x:u.texOffset.x,y:u.texOffset.y,z:u.texSubres.baseArrayLayer}},[i[a].texExtent.width,i[a].texExtent.height,i[a].texExtent.depth])}r.flags&B.GEN_MIPMAP&&Ut(e,r,1,r.mipLevel-1,0)}var Ct,Gt=["float","unfilterable-float","sint","uint"],Pt=["2d","2d","1d","1d","2d","2d-array","2d","2d-array","3d","cube","cube-array","2d"],wt=["read-only","read-only","write-only","read-write"];function Ft(e){var t=e.binding,r=Ve(e.stageFlags),i=[],s={binding:t,visibility:r};i.push(s);var n=Fe.instance,a=null,u=Gt[e.sampleType];"float"!==u||n.floatFilterable||(u="unfilterable-float");var o="unfilterable-float"===u,l=Pt[e.viewDimension],c=e.descriptorType,h=e.viewDimension>5&&e.viewDimension<8;switch(c){case A.UNIFORM_BUFFER:case A.DYNAMIC_UNIFORM_BUFFER:s.buffer={type:"uniform",hasDynamicOffset:c===A.DYNAMIC_UNIFORM_BUFFER,minBindingSize:void 0};break;case A.STORAGE_BUFFER:case A.DYNAMIC_STORAGE_BUFFER:s.buffer={type:"storage",hasDynamicOffset:c===A.DYNAMIC_STORAGE_BUFFER,minBindingSize:void 0};break;case A.SAMPLER_TEXTURE:s.texture={sampleType:u,viewDimension:l,multisampled:h},(a={binding:t+16,visibility:r}).sampler={type:o?"non-filtering":"filtering"},i.push(a);break;case A.SAMPLER:s.sampler={type:o?"non-filtering":"filtering"};break;case A.TEXTURE:s.texture={sampleType:u,viewDimension:l,multisampled:h};break;case A.STORAGE_IMAGE:s.storageTexture={access:wt[e.access],format:He(e.format),viewDimension:l};break;case A.INPUT_ATTACHMENT:s.texture={sampleType:u,viewDimension:l,multisampled:h};break;default:throw new Error("Unsupported descriptor type: "+c)}return i}function It(e){switch(e){case x.R8:case x.R8SN:case x.RG8:case x.RGBA8:case x.BGRA8:case x.RG8SN:case x.SRGB8_A8:case x.RGB10A2:case x.RGBA16F:return"float";case x.R8UI:case x.R16UI:case x.RG8UI:case x.R32UI:case x.RG16UI:case x.RGBA8UI:case x.RG32UI:case x.RGBA32UI:case x.RGBA16UI:case x.DEPTH_STENCIL:return"uint";case x.R8I:case x.R16I:case x.RG8I:case x.RG16I:case x.RGBA8I:case x.RG32I:case x.RGBA16I:case x.RGBA32I:case x.R32I:return"sint";case x.R16F:case x.R32F:case x.RG16F:case x.R11G11B10F:case x.RG32F:case x.RGBA32F:return"unfilterable-float";case x.DEPTH:return"depth";default:return s("Unsupported texture sample type yet. Please refer to the documentation for supported formats."),"float"}}function Dt(e){return e===x.DEPTH_STENCIL?"unfilterable-float":It(e)}function Ut(e,t,r,i,s){var n=t.gpuFormat;t.gpuTarget;var a=e.nativeDevice;if(!Ct){(Ct={}).sampler=a.createSampler({label:"filterSampler",addressModeU:"mirror-repeat",addressModeV:"mirror-repeat",addressModeW:"mirror-repeat",magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",lodMinClamp:0,lodMaxClamp:32,maxAnisotropy:1});var u=a.createShaderModule({code:"\n        struct VertexOutput {\n            @builtin(position) Position : vec4<f32>,\n            @location(0) fragUV : vec2<f32>,\n          }\n\n          @vertex\n          fn vert_main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\n            var pos = array<vec2<f32>, 6>(\n              vec2<f32>( 1.0,  1.0),\n              vec2<f32>( 1.0, -1.0),\n              vec2<f32>(-1.0, -1.0),\n              vec2<f32>( 1.0,  1.0),\n              vec2<f32>(-1.0, -1.0),\n              vec2<f32>(-1.0,  1.0)\n            );\n\n            var uv = array<vec2<f32>, 6>(\n              vec2<f32>(1.0, 0.0),\n              vec2<f32>(1.0, 1.0),\n              vec2<f32>(0.0, 1.0),\n              vec2<f32>(1.0, 0.0),\n              vec2<f32>(0.0, 1.0),\n              vec2<f32>(0.0, 0.0)\n            );\n\n            var output : VertexOutput;\n            output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n            output.fragUV = uv[VertexIndex];\n            return output;\n          }\n        "});Ct.vertShader=u;var o=a.createShaderModule({code:"\n        @group(0) @binding(0) var mySampler : sampler;\n        @group(0) @binding(1) var myTexture : texture_2d<f32>;\n\n        @fragment\n        fn frag_main(@location(0) fragUV : vec2<f32>) -> @location(0) vec4<f32> {\n        return textureSample(myTexture, mySampler, fragUV);\n        }\n        "});Ct.fragShader=o;var l={label:"fullscreenTexturedQuadBGLayout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:It(t.format),viewDimension:"2d",multisampled:!1}}]},c=a.createBindGroupLayout(l);Ct.bindGroupLayout=c;var h={label:"fullscreenTexturedQuadPipelineLayout",bindGroupLayouts:[c]},f=a.createPipelineLayout(h);Ct.pipelineLayout=f;var p={format:n,writeMask:15},d={label:"fullscreenTexturedQuadPipeline",layout:f,vertex:{module:Ct.vertShader,entryPoint:"vert_main",buffers:[]},primitive:{topology:"triangle-list",frontFace:"ccw",cullMode:"none"},fragment:{module:Ct.fragShader,entryPoint:"frag_main",targets:[p]},multisample:{count:1,alphaToCoverageEnabled:!1,mask:4294967295}},g=a.createRenderPipeline(d);Ct.pipeline=g}for(var _={format:n,dimension:"2d",baseMipLevel:r,mipLevelCount:1,baseArrayLayer:s,arrayLayerCount:1,aspect:"all"},m=a.createCommandEncoder(),v=r;v<r+i;++v){_.baseMipLevel=v-1;var x=t.gpuTexture.createView(_);_.baseMipLevel=v,_.baseArrayLayer=s,_.arrayLayerCount=1;var T=t.gpuTexture.createView(_),R=[{binding:0,resource:Ct.sampler},{binding:1,resource:x}],b={layout:Ct.bindGroupLayout,entries:R},y=a.createBindGroup(b),S={colorAttachments:[{view:T,loadOp:"clear",storeOp:"store",clearValue:[.88,.88,.88,1]}]},B=m.beginRenderPass(S);B.setPipeline(Ct.pipeline),B.setBindGroup(0,y),B.draw(6,1,0,0),B.end()}var A=m.finish();a.queue.submit([A])}function Lt(e,t,r,i){for(var s=e.nativeDevice,n=r.format,a=E(n),u=i.length,o=0;o<u;++o){var l=i[o],c=l.buffStride>0?l.buffStride:l.texExtent.width,h=l.buffTexHeight>0?l.buffTexHeight:l.texExtent.height;C(n,l.texExtent.width,1,1);for(var f=C(n,c,1,1),p=C(n,c,h,1),d=C(n,c,h,l.texExtent.depth),g=0===l.texExtent.width?0:G(l.texExtent.width,a.width),_=0===l.texExtent.height?0:G(l.texExtent.height,a.height),m={offset:0,bytesPerRow:f,rowsPerImage:h},v=c===l.texExtent.width,x=l.texSubres.baseArrayLayer;x<l.texSubres.layerCount+l.texSubres.baseArrayLayer;x++){for(var T=l.texOffset.z;T<l.texExtent.depth+l.texOffset.z;T++)if(v){var R,b=t[o];R="buffer"in b?new Uint8Array(b.buffer,b.byteOffset,b.byteLength):new Uint8Array(b);var y=new Uint8Array(R,R.byteOffset+l.buffOffset+(x-l.texSubres.baseArrayLayer)*d+(T-l.texOffset.z)*p),S={texture:r.gpuTexture,mipLevel:l.texSubres.mipLevel,origin:{x:l.texOffset.x,y:l.texOffset.y,z:x}};s.queue.writeTexture(S,y,m,[g,_,l.texExtent.depth])}else for(var A=l.texOffset.y;A<l.texExtent.height+l.texOffset.y;A+=a.height){var P=new Uint8Array(t[o].buffer,t[o].byteOffset+l.buffOffset+(x-l.texSubres.baseArrayLayer)*d+((T-l.texOffset.z)*p+(A-l.texOffset.y)/a.height*f)),w={texture:r.gpuTexture,mipLevel:l.texSubres.mipLevel,origin:{x:l.texOffset.x,y:A,z:x}};s.queue.writeTexture(w,P,m,[g,a.height,l.texExtent.depth])}r.flags&B.GEN_MIPMAP&&Ut(e,r,1,r.mipLevel-1,0)}}}var Mt,Ot=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t._bindGroupEntries=new Map,t._dynamicOffsets=[],t}i(t,e);var s=t.prototype;return s.initialize=function(e){var t=(this._layout=e.layout).gpuDescriptorSetLayout,r=t.bindings,i=t.descriptorIndices,s=t.descriptorCount;this._buffers=Array(s).fill(null),this._textures=Array(s).fill(null),this._samplers=Array(s).fill(null);var n=[];this._gpuDescriptorSet={gpuDescriptors:n,descriptorIndices:i,bindGroup:null,bindGroupLayout:null};for(var a=r.length,u=0;u<a;++u)for(var o=r[u],l=o.count,c=0;c<l;c++)n.push({type:o.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},s.destroy=function(){this._layout=null,this._gpuDescriptorSet=null,this._buffers.length=0,this._textures.length=0,this._samplers.length=0,this._bindGroupEntries.clear()},s._bindBufferEntry=function(e,t){var r=this._gpuDescriptorSet.gpuDescriptors[e.binding];r&&(r.gpuBuffer=t.gpuBuffer);var i=t.gpuBuffer.gpuBuffer,s={binding:e.binding,resource:{buffer:i,offset:t.gpuBuffer.gpuOffset,size:t.gpuBuffer.size}};this._bindGroupEntries.set(s.binding,s),t.resetChange()},s._bindTextureEntry=function(e,t){this._gpuDescriptorSet.gpuDescriptors[e.binding].gpuTexture=t.gpuTexture;var r=t.getNativeTextureView(),i={binding:e.binding,resource:r};this._bindGroupEntries.set(i.binding,i),t.resetChange()},s._bindSamplerEntry=function(e,t){var r=e.binding+16;this._gpuDescriptorSet.gpuDescriptors[e.binding].gpuSampler=t.gpuSampler;var i=Fe.instance,s=this._textures[e.binding]||i.defaultResource.texture,n=s.levelCount,a=s.format;("unfilterable-float"===Dt(a)||"float"===Dt(a)&&!i.floatFilterable)&&(t.gpuSampler.minFilter=y.POINT,t.gpuSampler.magFilter=y.POINT,t.gpuSampler.mipFilter=y.POINT);var u={binding:r,resource:t.createGPUSampler(n)};this._bindGroupEntries.set(r,u),t.resetChange()},s._applyBindGroup=function(){if(this._isDirty&&this._gpuDescriptorSet){var e=this._layout;this._bindGroupEntries.clear(),this._dynamicOffsets.length=0;for(var t=this._gpuDescriptorSet.gpuDescriptors,r=e.gpuDescriptorSetLayout.bindings,i=r.length,s=Fe.instance,n=0;n<i;++n){var a=r[n],u=a.binding,o=t[n].type;if(o&I){var l=s.defaultResource.buffer,c=this._buffers[n]||l;c===l&&o&D&&(c=s.defaultResource.getStorageBuffer(u)),this._bindBufferEntry(a,c),o&(A.DYNAMIC_STORAGE_BUFFER|A.DYNAMIC_UNIFORM_BUFFER)&&this._dynamicOffsets.push(u)}else if(o&U){if((o&A.SAMPLER)!==A.SAMPLER){var h=this._textures[n];(!h||h.hasChange&&!h.gpuTexture)&&(h=a.viewDimension===L.TEXCUBE?s.defaultResource.cubeTexture:s.defaultResource.texture),this._bindTextureEntry(a,h)}if((o&A.STORAGE_IMAGE)!==A.STORAGE_IMAGE&&(o&A.INPUT_ATTACHMENT)!==A.INPUT_ATTACHMENT&&(o&A.TEXTURE)!==A.TEXTURE){var f=this._samplers[n]||s.defaultResource.sampler;this._bindSamplerEntry(a,f)}}}this._isDirty=!1,this._createBindGroup()}},s._hasResourceChange=function(e){return!(!e||!e.hasChange)},s._isResourceChange=function(){var e=this,t=this._layout;return!!t&&t.gpuDescriptorSetLayout.bindings.some((function(t){var r=t.binding,i=e._buffers[r]||e._textures[r]||e._samplers[r];return e._hasResourceChange(i)}))},s.prepare=function(e){void 0===e&&(e=!1),!this._isResourceChange()&&!e||(this._isDirty=!0,this._applyBindGroup())},s._createBindGroup=function(){var e=Fe.instance.nativeDevice,t=this._layout,r=null==e?void 0:e.createBindGroup({layout:t.gpuDescriptorSetLayout.bindGroupLayout,entries:this._bindGroupEntries.values()});this._gpuDescriptorSet.bindGroupLayout=t.gpuDescriptorSetLayout.bindGroupLayout,this._gpuDescriptorSet.bindGroup=r},s.update=function(){this._applyBindGroup()},r(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}},{key:"dynamicOffsets",get:function(){return this._dynamicOffsets}},{key:"dynamicOffsetCount",get:function(){return this._dynamicOffsets.length}}]),t}(M),Nt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._indirectBuffer=null,t._hasChange=!1,t}i(t,e);var s=t.prototype;return s.resetChange=function(){this._hasChange=!1},s.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=4*Math.ceil(e.range/4),this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,gpuTarget:t.gpuBuffer.gpuTarget,gpuBuffer:t.gpuBuffer.gpuBuffer,gpuOffset:e.offset,flags:this._flags,drawIndirectByIndex:!1}}else{this._usage=e.usage,this._memUsage=e.memUsage,this._size=4*Math.ceil(e.size/4),this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&_.INDIRECT&&(this._indirectBuffer=new O),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:[],gpuTarget:0,flags:this._flags,gpuBuffer:null,gpuOffset:0,drawIndirectByIndex:!1},e.usage&_.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos);var r=Fe.instance;ot(r,this._gpuBuffer),r.memoryStatus.bufferSize+=this._size}},s.destroy=function(){if(this._gpuBuffer){if(!this._isBufferView){var e=Fe.instance;lt(0,this._gpuBuffer),e.memoryStatus.bufferSize-=this._size}this._hasChange=!0,this._gpuBuffer=null}},s.resize=function(e){if(this._isBufferView)h(16379);else{var t=this._size;if(t!==e&&(this._size=e,this._count=this._size/this._stride,this._hasChange=!0,this._gpuBuffer&&(this._gpuBuffer.size=this._size,this._size>0))){var r=Fe.instance;ct(r,this._gpuBuffer),r.memoryStatus.bufferSize-=t,r.memoryStatus.bufferSize+=this._size}}},s.update=function(e,t){var r;this._isBufferView?h(16380):(r=void 0!==t?t:this._usage&_.INDIRECT?0:e.byteLength,r=4*Math.ceil(r/4),this.size<r&&this.resize(r),this._hasChange=!0,ht(Fe.instance,this._gpuBuffer,e,0,r))},r(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"hasChange",get:function(){return this._hasChange}}]),t}(N),kt=null,zt=[],Vt=[0,1,2],Xt=[],Wt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new ut,t._webGPUAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curWebGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=[],t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateValid=!1,t._globalDescriptors=[],t._nativeCommandBuffer=null,t._encoder=void 0,t._descSetDirtyIndex=p,t._nativePassDesc=null,t._wgpuRenderPass=void 0,t._renderPassFuncQueue=[],t}i(t,e);var r=t.prototype;return r.pipelineBarrier=function(){throw new Error("Method not implemented.")},r.blitTexture=function(){throw new Error("Method not implemented.")},r.initialize=function(e){this._type=e.type,this._queue=e.queue;var t=Fe.instance;this._webGPUAllocator=t.cmdAllocator,this._encoder={};for(var r=t.bindingMappings.blockOffsets.length,i=0;i<r;i++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0},r.destroy=function(){this._webGPUAllocator&&(this._webGPUAllocator.clearCmds(this.cmdPackage),this._webGPUAllocator=null)},r.begin=function(){this._webGPUAllocator.clearCmds(this.cmdPackage),Xt.length=0,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var e=this._curDynamicOffsets.length,t=0;t<e;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},r.end=function(){this._isStateValid=!1,this._isInRenderPass=!1},r.beginRenderPass=function(e,t,r,i,s,n){var a,u=Fe.instance,o=u;this._wgpuRenderPass=e,this._nativePassDesc=this._wgpuRenderPass.gpuRenderPass.nativeRenderPass;var l=this._wgpuRenderPass.gpuRenderPass.originalRP,c=t.gpuFramebuffer;Xt.push(r);for(var h=!1,f=c.gpuColorTextures.every((function(e){return 0===r.x&&0===r.y&&r.width===e.width&&r.height===e.height})),p=o.getSwapchains()[0],d=i.length,g=0;g<d;g++){var _=c.isOffscreen?c.gpuColorTextures[g].getTextureView():p.colorGPUTextureView;_.label=c.isOffscreen?"offscreen":"swapchain",f||(h="clear"===l.colorAttachments[g].loadOp,Xt.length>1&&(this._nativePassDesc.colorAttachments[g].loadOp="load")),this._nativePassDesc.colorAttachments[g].view=_,this._nativePassDesc.colorAttachments[g].clearValue=[i[g].x,i[g].y,i[g].z,i[g].w]}if((null==(a=this._wgpuRenderPass.depthStencilAttachment)?void 0:a.format)!==x.UNKNOWN){var m,v=null==(m=c.gpuDepthStencilTexture)?void 0:m.gpuTexture,T=v?v.createView():p.gpuDepthStencilTextureView,R=this._nativePassDesc.depthStencilAttachment;R.view=T,R.depthClearValue=s,R.stencilClearValue=n}if(r.x=Math.floor(r.x),r.y=Math.floor(r.y),r.width=Math.floor(r.width),r.height=Math.floor(r.height),this._renderPassFuncQueue.push((function(e){e.setViewport(r.x,r.y,r.width,r.height,0,1)})),this._renderPassFuncQueue.push((function(e){e.setScissorRect(r.x,r.y,r.width,r.height)})),!f&&h){var b=0;c.gpuColorTextures.forEach((function(e){yt(u,e,r,i[b]),b++}))}this._isInRenderPass=!0},r.endRenderPass=function(){var e=Fe.instance.nativeDevice,t=e.createCommandEncoder(),r=t.beginRenderPass(this._nativePassDesc);this._renderPassFuncQueue.forEach((function(e){e(r)})),r.end(),null==e||e.queue.submit([t.finish()]);for(var i,s=0,n=c(this._nativePassDesc.colorAttachments);!(i=n()).done;)i.value.loadOp=this._wgpuRenderPass.gpuRenderPass.originalRP.colorAttachments[s].loadOp,s++;this._isInRenderPass=!1,this._isStateValid=!1,this._renderPassFuncQueue.length=0},r.bindPipelineState=function(e){var t=e,r=t.gpuPipelineState;r!==this._curGPUPipelineState&&(this._curWebGPUPipelineState=t,this._curGPUPipelineState=r,kt=t,this._isStateValid=!0)},r.bindDescriptorSet=function(e,t,r){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,zt[e]=t,this._isStateValid=!0),r&&r.length){for(var s=this._curDynamicOffsets[e],n=r.length,a=0;a<n;a++)s[a]=r[a];s.length=n,this._isStateValid=!0}},r.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateValid=!0},r.setViewport=function(e){e.left=Math.floor(e.left),e.top=Math.floor(e.top),e.width=Math.floor(e.width),e.height=Math.floor(e.height),e.minDepth=Math.floor(e.minDepth),e.maxDepth=Math.floor(e.maxDepth),this._curViewport=new k(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth),this._renderPassFuncQueue.push((function(t){t.setViewport(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth)})),this._isStateValid=!0},r.setScissor=function(e){e.x=Math.floor(e.x),e.y=Math.floor(e.y),e.width=Math.floor(e.width),e.height=Math.floor(e.height),this._renderPassFuncQueue.push((function(t){t.setScissorRect(e.x,e.y,e.width,e.height)})),this._isStateValid=!0},r.setLineWidth=function(){u("line width not supproted by webGPU")},r.setDepthBias=function(e,t,r){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===r||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=r,this._isStateValid=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:r},this._isStateValid=!0)},r.setBlendConstants=function(e){this._curBlendConstants[0]===e.x&&this._curBlendConstants[1]===e.y&&this._curBlendConstants[2]===e.z&&this._curBlendConstants[3]===e.w||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,[e.x,e.y,e.z,e.w]),this._isStateValid=!0)},r.setDepthBound=function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateValid=!0)},r.setStencilWriteMask=function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateValid=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateValid=!0)},r.setStencilCompareMask=function(e,t,r){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===r||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=r,this._isStateValid=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:r},this._isStateValid=!0)},r.draw=function(e){var t=Fe.instance;if(this._type!==z.PRIMARY||this._isInRenderPass){this._isStateValid&&this.bindStates();var r=e,i=r.gpuInputAssembler,s=t;if(r.indirectBuffer){var n=i.gpuIndirectBuffer;if(s.multiDrawIndirectSupport);else{var a,u=null==(a=i.gpuIndirectBuffer)?void 0:a.indirects.length;n.drawIndirectByIndex?this._renderPassFuncQueue.push((function(e){for(var t=Object.keys(b).length,r=0;r<u;r++)null==e||e.drawIndexedIndirect(n.gpuBuffer,n.gpuOffset+r*t)})):this._renderPassFuncQueue.push((function(e){for(var t=Object.keys(b).length,r=0;r<u;r++)null==e||e.drawIndirect(n.gpuBuffer,n.gpuOffset+r*t)}))}}else!(e.instanceCount>0)||e.instanceCount,e.indexBuffer&&r.indexCount>0?this._renderPassFuncQueue.push((function(e){var t=Math.max(r.instanceCount,1);null==e||e.drawIndexed(r.indexCount,t,r.firstIndex,r.firstVertex,r.firstInstance)})):this._renderPassFuncQueue.push((function(e){var t=Math.max(r.instanceCount,1);null==e||e.draw(r.vertexCount,t,r.firstVertex,r.firstInstance)}));++this._numDrawCalls,this._numInstances+=e.instanceCount;var o=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.gpuPrimitive){case"triangle-strip":this._numTris+=(o-2)*Math.max(e.instanceCount,1);break;case"triangle-list":this._numTris+=o/3*Math.max(e.instanceCount,1)}}else f(16328)},r.updateBuffer=function(e,t,r,i){if(this._type===z.PRIMARY&&this._isInRenderPass)f(16329);else{var s=e.gpuBuffer;if(s){this._webGPUAllocator.updateBufferCmdPool.alloc(nt);var n;e.usage&_.INDIRECT||void 0!==i||t.byteLength,n=t;var a=Fe.instance.nativeDevice;null==a||a.queue.writeBuffer(s.gpuBuffer,s.gpuOffset,n)}}},r.copyBuffersToTexture=function(e,t,r){if(this._type===z.PRIMARY&&this._isInRenderPass)f(16330);else{var i=t.gpuTexture;if(i){var s=this._webGPUAllocator.copyBufferToTextureCmdPool.alloc(at);s.gpuTexture=i,s.regions=r,s.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(Je.COPY_BUFFER_TO_TEXTURE)}}},r.execute=function(e,t){for(var r=0;r<t;++r){for(var i=e[r],s=i.cmdPackage,n=s.beginRenderPassCmds.length,a=0;a<n;++a){var u=s.beginRenderPassCmds.array[a];++u.refCount,this.cmdPackage.beginRenderPassCmds.push(u)}for(var o=s.bindStatesCmds,l=o.length,c=0;c<l;++c){var h=o.array[c];++h.refCount,this.cmdPackage.bindStatesCmds.push(h)}for(var f=s.drawCmds,p=f.length,d=0;d<p;++d){var g=f.array[d];++g.refCount,this.cmdPackage.drawCmds.push(g)}for(var _=s.updateBufferCmds.length,m=0;m<_;++m){var v=s.updateBufferCmds.array[m];++v.refCount,this.cmdPackage.updateBufferCmds.push(v)}for(var x=s.copyBufferToTextureCmds.length,T=0;T<x;++T){var R=s.copyBufferToTextureCmds.array[T];++R.refCount,this.cmdPackage.copyBufferToTextureCmds.push(R)}this.cmdPackage.cmds.concat(s.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},r.bindStates=function(){var e,t,r=this;if(this._curGPUPipelineState){this._curGPUPipelineState.gpuPipelineLayout;for(var i=null==(e=kt)?void 0:e.pipelineLayout,s=Fe.instance,n=0;n<Vt.length;n++){var a=Vt[n],u=zt[a];if(u&&u.gpuDescriptorSet)u.prepare();else{var o=i.setLayouts[a],l=new V(o),c=s.createDescriptorSet(l);zt[a]=c,c.prepare(!0)}}this._curWebGPUPipelineState.prepare(this._curGPUInputAssembler);var h=this._curGPUPipelineState.nativePipeline;if(this._renderPassFuncQueue.push((function(e){e.setPipeline(h)})),null!=(t=this._curGPUPipelineState.pipelineState)&&t.depthStencil){var f=this._curGPUPipelineState.stencilRef;this._renderPassFuncQueue.push((function(e){e.setStencilReference(f)}))}for(var p=Vt.length,d=new Array(p),g=new Array(p),_=0;_<p;_++){var m=Vt[_],v=zt[m],x=v.gpuDescriptorSet;if(d[m]=x.bindGroup,g[m]=[].concat(this._curDynamicOffsets[m]),v.dynamicOffsetCount){if(v&&v.dynamicOffsetCount!==g[m].length){g[m].length=v.dynamicOffsetCount;for(var T=0;T<v.dynamicOffsetCount;T++){var R=g[m][T];if(R){var b=v.dynamicOffsets[T],y=v.gpuDescriptorSet.gpuDescriptors[b];y&&y.gpuBuffer&&R>y.gpuBuffer.gpuBuffer.size&&(g[m][T]=0)}else g[m][T]=0}}}else g[m]=[]}this._renderPassFuncQueue.push((function(e){for(var t=d.length,r=0;r<t;r++){var i=d[r];i||(i=s.defaultResource.descSet.gpuDescriptorSet.bindGroup),e.setBindGroup(r,i,g[r])}}));for(var S=this._curGPUInputAssembler,B=new Array(S.gpuVertexBuffers.length),A=S.gpuVertexBuffers.length,E=0;E<A;E++)B[E]={slot:E,buffer:S.gpuVertexBuffers[E].gpuBuffer,offset:S.gpuVertexBuffers[E].gpuOffset};if(this._renderPassFuncQueue.push((function(e){for(var t=B.length,r=0;r<t;r++)e.setVertexBuffer(B[r].slot,B[r].buffer,B[r].offset)})),S.gpuIndexBuffer){var C={indexType:S.gpuIndexType,buffer:S.gpuIndexBuffer.gpuBuffer,offset:S.gpuIndexBuffer.gpuOffset,size:S.gpuIndexBuffer.size};this._renderPassFuncQueue.push((function(e){e.setIndexBuffer(C.buffer,C.indexType,C.offset,C.size)}))}this._curBlendConstants.length&&this._renderPassFuncQueue.push((function(e){e.setBlendConstant([r._curBlendConstants[0],r._curBlendConstants[1],r._curBlendConstants[2],r._curBlendConstants[3]])})),this._isStateValid=!1}},t}(X),Ht=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}i(t,e);var s=t.prototype;return s.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],r=!0,i=e.colorTextures.length,s=0;s<i;s++){var n=e.colorTextures[s];if(n){var a=n.gpuTexture;t.push(a),a.isSwapchainTexture&&(r=!1)}}var u=null;e.depthStencilTexture&&(u=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,l=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:u,gpuFramebuffer:null,isOffscreen:r,get width(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].width:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.width:o},set width(e){o=e},get height(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].height:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.height:l},set height(e){l=e}},this._width=this._gpuFramebuffer.width,this._height=this._gpuFramebuffer.height},s.destroy=function(){this._gpuFramebuffer&&(this._gpuFramebuffer=null)},r(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(W),qt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}i(t,e);var s=t.prototype;return s.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this.drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this.drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this.drawInfo.vertexCount=t.size/t.stride,this.drawInfo.firstVertex=0,this.drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=e.vertexBuffers.length,i=new Array(r),s=0;s<r;++s){var n=e.vertexBuffers[s];n.gpuBuffer&&(i[s]=n.gpuBuffer)}var a=null,u="uint16";if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 2:u="uint16";break;case 4:u="uint32";break;default:f(16332)}var o=null;e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,gpuAttribs:[],gpuIndexType:u},At(Fe.instance,this._gpuInputAssembler)}else f(16331)},s.destroy=function(){Fe.instance,this._gpuInputAssembler&&this._gpuInputAssembler,this._gpuInputAssembler=null},r(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(H),Yt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t._bindGrpLayoutEntries=new Map,t._hasChange=!1,t._currBinds=[],t._prepareEntries=[],t.buffers=new Map,t.textures=new Map,t.samplers=new Map,t.references=[],t}i(t,e);var s=t.prototype;return s.resetChanged=function(){this._hasChange=!1},s.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);var t=Fe.instance;this._bindings.length||this._bindings.push(t.defaultResource.setLayout.bindings[0]);for(var r=0,i=-1,s=[],n=this._bindings.length,a=0;a<n;a++){var u=this._bindings[a];s.push(r),r+=u.count,u.binding>i&&(i=u.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var o=this._descriptorIndices=Array(i+1).fill(-1),l=0;l<n;l++){var c=this._bindings[l];this._bindingIndices[c.binding]=l,o[c.binding]=s[l]}for(var h=[],f=0;f<n;f++){var p=this._bindings[f];if(p.descriptorType&q)for(var d=0;d<p.count;d++)h.push(p.binding)}var g=[];this._bindings.forEach((function(e){g.push.apply(g,Ft(e))}));var _=t.nativeDevice.createBindGroupLayout({entries:g});this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:h,descriptorIndices:o,descriptorCount:r,entries:g,bindGroupLayout:_}},s.clear=function(){this.buffers.clear(),this.textures.clear(),this.samplers.clear(),this._bindGrpLayoutEntries.clear()},s.destroy=function(){this._bindings.length=0,this.clear(),this._gpuDescriptorSetLayout=null},r(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}},{key:"currBinds",get:function(){return this._currBinds}},{key:"prepareEntries",get:function(){return this._prepareEntries}},{key:"bindGrpLayoutEntries",get:function(){return this._bindGrpLayoutEntries}},{key:"hasChanged",get:function(){return this._hasChange}}]),t}(Y),Qt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t._nativePipelineLayout=void 0,t._bindGrpLayouts=[],t}i(t,e);var s=t.prototype;return s.fetchPipelineLayout=function(e){void 0===e&&(e=!0);var t=this._gpuPipelineLayout;e&&(t.gpuSetLayouts.length=0,t.dynamicOffsetIndices.length=0);var r=Fe.instance.nativeDevice;this._bindGrpLayouts.length=0;for(var i=this._setLayouts.length,s=0;s<i;s++){var n=this._setLayouts[s],a=n.gpuDescriptorSetLayout.bindGroupLayout;if(a){if(e){for(var u=n.gpuDescriptorSetLayout.dynamicBindings,o=Array(n.bindingIndices.length).fill(-1),l=u.length,c=0;c<l;c++){var h=u[c];o[h]<0&&(o[h]=t.dynamicOffsetCount+c)}t.gpuSetLayouts.push(n.gpuDescriptorSetLayout),t.dynamicOffsetIndices.push(o),t.dynamicOffsetCount+=l}this._bindGrpLayouts[s]=a}}return this._nativePipelineLayout=null==r?void 0:r.createPipelineLayout({bindGroupLayouts:this._bindGrpLayouts}),this._nativePipelineLayout},s.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);var t=this;return this._gpuPipelineLayout={setLayouts:this._setLayouts,gpuSetLayouts:[],dynamicOffsetIndices:[],dynamicOffsetCount:0,gpuBindGroupLayouts:this._bindGrpLayouts,get nativePipelineLayout(){return t._nativePipelineLayout}},this.fetchPipelineLayout(),!0},s.changeSetLayout=function(e,t){this._setLayouts[e]=t},s.destroy=function(){this._setLayouts.length=0},r(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Q),jt=["point-list","line-list","line-strip","line-strip","line-list","line-strip","line-list","triangle-list","triangle-strip","triangle-strip","triangle-list","triangle-strip","triangle-strip","triangle-strip"],$t=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t._locations=new Map,t}i(t,e);var s=t.prototype;return s.initialize=function(e){var t;this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],i=0;i<31;i++)this._dynamicStates&1<<i&&r.push(1<<i);for(var s,n,a=this._renderPass.colorAttachments,u=[],o=a.length,l=e.pipelineLayout,c=0;c<o;c++){var h={format:He(a[c].format),writeMask:Ze(this._bs.targets[c].blendColorMask)};this._bs.targets[c].blend&&(h.blend={color:{dstFactor:et[this._bs.targets[c].blendDst],operation:Ke[this._bs.targets[c].blendEq===j.MAX?j.ADD:this._bs.targets[c].blendEq],srcFactor:et[this._bs.targets[c].blendSrc]},alpha:{dstFactor:et[this._bs.targets[c].blendDstAlpha],operation:Ke[this._bs.targets[c].blendAlphaEq===j.MAX?j.ADD:this._bs.targets[c].blendAlphaEq],srcFactor:et[this._bs.targets[c].blendSrcAlpha]}}),u.push(h)}for(var f=this._shader.gpuShader.gpuStages,p=f.length,d=0;d<p;d++)f[d].type===P.VERTEX&&(s=f[d].gpuShader),f[d].type===P.FRAGMENT&&(n=f[d].gpuShader);for(var g=e.shader,_=g.attributes,m=_.length,v=0;v<m;v++)this._locations.set(_[v].name,_[v].location);var T=e.primitive===$.LINE_STRIP||e.primitive===$.TRIANGLE_STRIP,R={layout:l.gpuPipelineLayout.nativePipelineLayout,vertex:{module:s.module,entryPoint:"main",buffers:[]},primitive:{topology:jt[e.primitive],frontFace:this._rs.isFrontFaceCCW?"ccw":"cw",cullMode:this._rs.cullMode===K.NONE?"none":this._rs.cullMode===K.FRONT?"front":"back"},fragment:{module:n.module,entryPoint:"main",targets:u}};T&&(R.primitive.stripIndexFormat="uint16");var b=0;if((null==(t=this._renderPass.depthStencilAttachment)?void 0:t.format)!==x.UNKNOWN){var y={};y.format=He(this._renderPass.depthStencilAttachment.format),y.depthWriteEnabled=this._dss.depthWrite,y.depthCompare=this._dss.depthTest?$e[this._dss.depthFunc]:"always";var S=0,B=0;this._dss.stencilTestFront&&(y.stencilFront={compare:$e[this._dss.stencilFuncFront],depthFailOp:je[this._dss.stencilZFailOpFront],passOp:je[this._dss.stencilPassOpFront],failOp:je[this._dss.stencilFailOpFront]},S|=this._dss.stencilReadMaskFront,B|=this._dss.stencilWriteMaskFront,b|=this._dss.stencilRefFront),this._dss.stencilTestBack&&(y.stencilBack={compare:$e[this._dss.stencilFuncBack],depthFailOp:je[this._dss.stencilZFailOpBack],passOp:je[this._dss.stencilPassOpBack],failOp:je[this._dss.stencilFailOpBack]},S|=this._dss.stencilReadMaskBack,B|=this._dss.stencilWriteMaskBack,b|=this._dss.stencilRefBack),y.stencilReadMask=S,y.stencilWriteMask=B,y.depthBias=this._rs.depthBias,y.depthBiasSlopeScale=this._rs.depthBiasSlop,y.depthBiasClamp=this._rs.depthBiasClamp,R.depthStencil=y}this._gpuPipelineState={gpuPrimitive:jt[e.primitive],gpuShader:g.gpuShader,gpuPipelineLayout:l.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,stencilRef:b,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r,pipelineState:R,nativePipeline:void 0}},s._getShaderLocation=function(e){return this._locations.get(e)},s.updatePipelineLayout=function(){this._gpuPipelineState&&this._gpuPipelineState.pipelineState&&(this._gpuPipelineState.pipelineState.layout=this._pipelineLayout.gpuPipelineLayout.nativePipelineLayout)},s.prepare=function(e,t){if(void 0===t&&(t=!1),!this._gpuPipelineState.nativePipeline||t){for(var r=this.shader.attributes,i=this._gpuPipelineState.pipelineState,s=[],n=[],a=e.gpuVertexBuffers.length,u=0;u<a;u++){for(var o={arrayStride:0,attributes:[]},l=[],c=r.length,h=0;h<c;h++){for(var f=r[h],p=!1,d=e.gpuAttribs.length,g=0;g<d;g++){var _=e.gpuAttribs[g],m=e.attributes[g];if(m.name===f.name){p=!0;var v=f.location;if(m.stream===u){o.arrayStride=_.stride,o.stepMode=m.isInstanced?"instance":"vertex";var x={format:Xe(m.format),offset:_.offset,shaderLocation:v};l.push(x)}break}}var T=f.format;if(!p&&!n.includes(f.name)&&S[T].size<=e.gpuVertexBuffers[u].stride){n.push(f.name);var R={format:Xe(T),offset:0,shaderLocation:f.location};l.push(R)}}l.length&&(o.attributes=l,s.push(o))}i.vertex.buffers=s;var b=Fe.instance.nativeDevice,y=null==b?void 0:b.createRenderPipeline(i);this._gpuPipelineState.nativePipeline=y}},s.destroy=function(){this._gpuPipelineState=null},r(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Z),Kt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t._nativeQueue=null,t._isAsync=!1,t}i(t,e);var r=t.prototype;return r.initialize=function(e){return this._type=e.type,!0},r.destroy=function(){},r.submit=function(e){if(!this._isAsync)for(var t=e.length,r=0;r<t;r++){var i=e[r];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},r.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(J),Zt=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}i(t,e);var s=t.prototype;return s._generateColorAttachment=function(e){return{view:{},loadOp:e.loadOp===ee.LOAD?"load":"clear",storeOp:e.storeOp===te.STORE?"store":"discard"}},s._generateDSAttachment=function(e){var t={depthClearValue:1};return t.depthLoadOp=e.depthLoadOp===ee.CLEAR?"clear":"load",t.depthStoreOp=e.depthStoreOp===te.STORE?"store":"discard",t.stencilClearValue=0,t.stencilLoadOp=e.stencilLoadOp===ee.CLEAR?"clear":"load",t.stencilStoreOp=e.stencilStoreOp===te.STORE?"store":"discard",t.view={},t},s.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses;for(var t,r=[],i=[],s=c(e.colorAttachments);!(t=s()).done;){var n=t.value;i[r.length]=this._generateColorAttachment(n),r[r.length]=this._generateColorAttachment(n)}var a={colorAttachments:r},u={colorAttachments:i};if(e.depthStencilAttachment.format!==x.UNKNOWN){var o=this._generateDSAttachment(e.depthStencilAttachment),l=this._generateDSAttachment(e.depthStencilAttachment);a.depthStencilAttachment=o,u.depthStencilAttachment=l}this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo,nativeRenderPass:a,originalRP:u}},s.destroy=function(){this._gpuRenderPass=null},r(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(re),Jt=new Map,er=function(e){i(s,e);var t=s.prototype;function s(t,r){var i;return(i=e.call(this,t,r)||this)._gpuSampler=null,i._hasChange=!1,i._gpuSampler={gpuSampler:null,compare:t.cmpFunc,minFilter:t.minFilter,magFilter:t.magFilter,mipFilter:t.mipFilter,addressU:t.addressU,addressV:t.addressV,addressW:t.addressW,maxAnisotropy:t.maxAnisotropy,mipLevel:1,gpuMinFilter:"linear",gpuMagFilter:"linear",gpuMipFilter:"linear",gpuWrapS:"clamp-to-edge",gpuWrapT:"clamp-to-edge",gpuWrapR:"clamp-to-edge"},i}return t.resetChange=function(){this._hasChange=!1},t._computeSamplerKey=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,t|=e.maxAnisotropy<<12,(t|=e.compare<<16)|e.mipLevel<<18},t.createGPUSampler=function(e){if(void 0===e&&(e=1),!this._gpuSampler)return null;this._gpuSampler.mipLevel=e;var t=this._computeSamplerKey(this._gpuSampler),r=Jt.get(t);if(r)return r;var i=Fe.instance;return this._hasChange=!0,gt(i,this._gpuSampler),r=this._gpuSampler.gpuSampler,Jt.set(t,r),r},t.destroy=function(){var e;this._gpuSampler&&(this._hasChange=!0,Fe.instance,(e=this._gpuSampler).gpuSampler&&(e.gpuSampler=null),this._gpuSampler=null)},r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}},{key:"samplerInfo",get:function(){return this._info}},{key:"hasChange",get:function(){return this._hasChange}}]),s}(ie),tr=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}i(t,e);var s=t.prototype;return s.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers;var t=e.stages.length;this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplers:e.samplers,gpuStages:new Array(t),gpuProgram:null,gpuInputs:[],gpuUniforms:[],gpuBlocks:[],gpuSamplers:[],bindings:new Map};for(var r=0;r<t;++r){var i=e.stages[r];this._gpuShader.gpuStages[r]={type:i.stage,source:i.source,gpuShader:null,bindings:[],attrs:new Map}}Bt(Fe.instance,this._gpuShader)},s.destroy=function(){var e;this._gpuShader&&(Fe.instance,(e=this._gpuShader).gpuProgram&&(e.gpuProgram=null),this._gpuShader=null)},r(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(se),rr=function(){function e(){this.gpuArrayBuffer=null,this.gpuElementArrayBuffer=null,this.gpuUniformBuffer=null,this.gpuBindUBOs=[],this.gpuBindUBOOffsets=[],this.texUnit=0,this.gpuTexUnits=[],this.gpuSamplerUnits=[],this.gpuFramebuffer=null,this.gpuReadFramebuffer=null,this.gpuInputAssembler=null,this.viewport=new k,this.scissorRect=new R(0,0,0,0),this.rs=new ne,this.dss=new ae,this.bs=new ue,this.gpuEnabledAttribLocs=[],this.gpuCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var i=0;i<e;++i)this.gpuTexUnits.push({gpuTexture:null});this.gpuSamplerUnits.length=e,this.gpuSamplerUnits.fill(null),this.gpuBindUBOs.length=t,this.gpuBindUBOs.fill(null),this.gpuBindUBOOffsets.length=t,this.gpuBindUBOOffsets.fill(0),this.gpuEnabledAttribLocs.length=r,this.gpuEnabledAttribLocs.fill(!1),this.gpuCurrentAttribLocs.length=r,this.gpuCurrentAttribLocs.fill(!1)},e}(),ir=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._texDescriptor=null,t._lodLevel=0,t._hasChange=!1,t}i(t,e);var s=t.prototype;return s.getTextureHandle=function(){var e=this._gpuTexture;return e&&e.gpuTexture?e.gpuTexture:0},s.initAsSwapchainTexture=function(e){var t=new oe;t.format=e.format,t.usage=S[e.format].hasDepth?F.DEPTH_STENCIL_ATTACHMENT:F.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},s.resetChange=function(){this._hasChange=!1},s.initialize=function(e,t){var r=e,i=e;if("texture"in e&&(r=i.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=le(this._info.width)&&le(this._info.height),this._size=ce(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView)this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture;else{if(this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,gpuTarget:"2d",gpuInternalFmt:"rgba8unorm",gpuFormat:"rgba8unorm",gpuType:0,gpuUsage:GPUTextureUsage.RENDER_ATTACHMENT,gpuTexture:void 0,gpuRenderbuffer:null,gpuWrapS:"clamp-to-edge",gpuWrapT:"clamp-to-edge",gpuMinFilter:"linear",gpuMagFilter:"linear",getTextureView:this.getNativeTextureView.bind(this),isSwapchainTexture:t||!1},t)this._gpuTexture.gpuInternalFmt=He(this._gpuTexture.format),this._gpuTexture.gpuFormat=this._gpuTexture.gpuInternalFmt;else{var s=Fe.instance;ft(s,this._gpuTexture),s.memoryStatus.textureSize+=this._size}this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount}},s.getNativeTextureView=function(){return this._gpuTexture&&this._gpuTexture.gpuTexture?this._gpuTexture.gpuTexture.createView({format:this.gpuTexture.gpuFormat,dimension:this._gpuTexture.gpuTarget,mipLevelCount:this._gpuTexture.mipLevel,arrayLayerCount:this.viewInfo.layerCount,baseMipLevel:0,baseArrayLayer:0}):null},s.destroy=function(){this._hasChange=!0,this._isTextureView||!this._isTextureView&&!this._gpuTexture||(pt(this._gpuTexture),Fe.instance.memoryStatus.textureSize-=this._size),this._gpuTexture=null},s.resize=function(e,r){if(this._info.width!==e||this._info.height!==r){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,r):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,r))),this._hasChange=!0;var i=this._size;if(this._info.width=e,this._info.height=r,this._size=ce(this.info.format,this.width,this.height,this.depth,this.info.levelCount)*this.info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=r,this._gpuTexture.size=this._size,!this._gpuTexture.isSwapchainTexture)){var s=Fe.instance;dt(s,this._gpuTexture),s.memoryStatus.textureSize-=i,s.memoryStatus.textureSize+=this._size}}},r(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}},{key:"hasChange",get:function(){return this._hasChange}},{key:"gpuFormat",set:function(e){if(!this._isTextureView&&this._gpuTexture&&!this._gpuTexture.isSwapchainTexture){pt(this._gpuTexture);var t=Fe.instance;this._gpuTexture.format=Ye(e),ft(t,this._gpuTexture),this._hasChange=!0}}}]),t}(he),sr=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new l(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var i=t-r.length,s=0;s<i;++s)this._frees[s]=new e;for(var n=i,a=0;n<t;++n,++a)this._frees[n]=r[a];this._freeIdx+=i}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=e.length,r=0;r<t;++r)0==--e.array[r].refCount&&this._freeCmds.push(e.array[r])},t.release=function(){for(var e=this._freeCmds.length,t=0;t<e;++t){var r=this._freeCmds.array[t];r.clear(),this._frees[++this._freeIdx]=r}this._freeCmds.clear()},e}(),nr=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new sr(rt,1),this.bindStatesCmdPool=new sr(it,1),this.drawCmdPool=new sr(st,1),this.updateBufferCmdPool=new sr(nt,1),this.copyBufferToTextureCmdPool=new sr(at,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),ar=function(){function e(){this._srcFramebuffer=null,this._dstFramebuffer=null,Fe.instance}return e.prototype.destroy=function(){},r(e,[{key:"srcFramebuffer",get:function(){return this._srcFramebuffer}},{key:"dstFramebuffer",get:function(){return this._dstFramebuffer}}]),e}(),ur=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._blitManager=null,t._webGPUDeviceLostHandler=null,t}i(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle;var t=e.width,r=e.height;this._canvas.width=t,this._canvas.height=r,this._webGPUDeviceLostHandler=this._onWebGPUDeviceLost.bind(this);var i=Fe.instance;i.nativeDevice.lost.then(this._webGPUDeviceLostHandler).catch((function(){}));var s=i.capabilities;i.stateCache.initialize(s.maxTextureUnits,s.maxUniformBufferBindings,s.maxVertexAttributes),this._createTexture(t,r),this._depthStencilTexture=this._createDepthStencilTexture(t,r),this.nullTex2D=i.createTexture(new oe(w.TEX2D,F.SAMPLED|F.TRANSFER_DST,x.RGBA8,2,2,B.NONE)),this.nullTexCube=i.createTexture(new oe(w.CUBE,F.SAMPLED|F.TRANSFER_DST,x.RGBA8,2,2,B.NONE,6));var n=new fe;n.texExtent.width=2,n.texExtent.height=2;var a=new Uint8Array(this.nullTex2D.size);a.fill(0),i.copyBuffersToTexture([a],this.nullTex2D,[n]),n.texSubres.layerCount=6,i.copyBuffersToTexture([a,a,a,a,a,a],this.nullTexCube,[n]),this._blitManager=new ar},n.resize=function(e,t){var r=Fe.instance.nativeDevice;e=Math.max(1,Math.min(e,r.limits.maxTextureDimension2D)),t=Math.max(1,Math.min(t,r.limits.maxTextureDimension2D)),this._colorTexture.width===e&&this._colorTexture.height===t||(d("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n.destroy=function(){this._canvas&&this._webGPUDeviceLostHandler&&(this._webGPUDeviceLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._canvas=null},n._createTexture=function(e,t){var r=Fe.instance,i=r.swapchainFormat,s=He(i);if(!this._colorTexture){var n={device:r.nativeDevice,format:s,alphaMode:"opaque"};r.gpuConfig=n,r.context.configure(n)}return this._colorTexture=new ir,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e,height:t}),this._colorTexture.gpuTexture.gpuTexture=r.context.getCurrentTexture(),this._colorTexture},n._createDepthStencilTexture=function(e,t){var r=Fe.instance,i=new oe(w.TEX2D,F.DEPTH_STENCIL_ATTACHMENT|F.SAMPLED,x.DEPTH_STENCIL,e,t);return r.createTexture(i)},n._onWebGPUDeviceLost=function(){h(11e3),s("webgpu device lost")},r(t,[{key:"blitManager",get:function(){return this._blitManager}},{key:"colorTexture",get:function(){return this._colorTexture.gpuTexture.gpuTexture=Fe.instance.context.getCurrentTexture(),this._colorTexture}},{key:"colorGPUTexture",get:function(){return this._colorTexture.gpuTexture.gpuTexture=Fe.instance.context.getCurrentTexture(),this._colorTexture.gpuTexture.gpuTexture}},{key:"colorGPUTextureView",get:function(){return this._colorTexture.gpuTexture.gpuTexture=Fe.instance.context.getCurrentTexture(),this._colorTexture.gpuTexture.gpuTexture.createView()}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"gpuDepthStencilTexture",get:function(){return this._depthStencilTexture.gpuTexture.gpuTexture}},{key:"gpuDepthStencilTextureView",get:function(){return this._depthStencilTexture.gpuTexture.gpuTexture.createView()}}]),t}(pe),or=null,lr=[];function cr(e,t){return new Promise((function(r,i){var s=function(e){return"[WebGPU]: WebGPU wasm load failed: "+e};e({instantiateWasm:function(e,r){Pe(t,e).then((function(e){r(e.instance,e.module)})).catch((function(e){return i(s(e))}))}}).then((function(e){or=e,lr.forEach((function(e){e(or)}))})).then(r).catch((function(e){return i(s(e))}))}))}function hr(){return fr.apply(this,arguments)}function fr(){return(fr=n(a().mark((function e(){var r,i,s,n,o,l,c,h,f,p;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=function(e){u("Error during WebGPU Wasm instantiation:",e)},e.prev=1,e.next=4,Ge();case 4:if(!Ce.hasFeature(Ce.Feature.WASM)){e.next=20;break}return e.next=7,Promise.all([t.import("./glslang-Cg8KV_9v.js"),t.import("./glslang-BO1uls6Y.js"),t.import("./twgsl-COsveuAQ.js"),t.import("./twgsl-tWnHapYS.js")]);case 7:return i=e.sent,s=i[0],n=i[1],o=i[2],l=i[3],c=s.default,h=n.default,f=o.default,p=l.default,e.next=18,Promise.all([cr(c,h),cr(f,p)]);case 18:e.next=21;break;case 20:throw new Error("Wasm module is not supported in this environment.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(1),r(e.t0);case 26:case"end":return e.stop()}}),e,null,[[1,23]])})))).apply(this,arguments)}lr.push((function(e){Me(e)}));var pr=e("WebGPUDevice",function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new rr,t.cmdAllocator=new nr,t.nullTex2D=null,t.nullTexCube=null,t.defaultResource=new Ne,t._adapter=null,t._device=null,t._context=null,t._swapchain=null,t._glslang=void 0,t._twgsl=void 0,t._bindingMappings=null,t._multiDrawIndirect=!1,t._gpuConfig=null,t._textureExclusive=new Array(x.COUNT),t}i(t,e);var u,o,l,c=t.prototype;return c.createSwapchain=function(e){var t=new ur;return this._swapchain=t,t.initialize(e),t},c.getSampler=function(e){var t=ie.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new er(e,t)),this._samplers.get(t)},c.getSwapchains=function(){return[this._swapchain]},c.getGeneralBarrier=function(e){var t=de.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new de(e,t)),this._generalBarrierss.get(t)},c.getTextureBarrier=function(e){var t=ge.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new ge(e,t)),this._textureBarriers.get(t)},c.getBufferBarrier=function(e){var t=_e.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new _e(e,t)),this._bufferBarriers.get(t)},c.copyTextureToBuffers=(u=n(a().mark((function e(t,r,i){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,vt(this,t.gpuTexture,r,i);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return u.apply(this,arguments)}),c.flushCommands=function(){},c.initialize=(o=n(a().mark((function e(t){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Fe.setInstance(this),e.abrupt("return",this.initDevice(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)}),c.initFormatFeatures=function(e){this._formatFeatures.fill(me.NONE),this._textureExclusive.fill(!0);var t=me.RENDER_TARGET|me.SAMPLED_TEXTURE|me.STORAGE_TEXTURE|me.LINEAR_FILTER|me.VERTEX_ATTRIBUTE;this._formatFeatures[x.R8]=t,this._formatFeatures[x.RG8]=t,this._formatFeatures[x.RGB8]=t,this._formatFeatures[x.RGBA8]=t,t=me.RENDER_TARGET|me.SAMPLED_TEXTURE|me.STORAGE_TEXTURE|me.LINEAR_FILTER,this._formatFeatures[x.R8SN]=t,this._formatFeatures[x.RG8SN]=t,this._formatFeatures[x.RGB8SN]=t,this._formatFeatures[x.RGBA8SN]=t,this._formatFeatures[x.R5G6B5]=t,this._formatFeatures[x.RGBA4]=t,this._formatFeatures[x.RGB5A1]=t,this._formatFeatures[x.RGB10A2]=t,this._formatFeatures[x.SRGB8]=t,this._formatFeatures[x.SRGB8_A8]=t,this._formatFeatures[x.R11G11B10F]=t,this._formatFeatures[x.RGB9E5]=t,this._formatFeatures[x.DEPTH]=t,this._formatFeatures[x.DEPTH_STENCIL]=t,this._formatFeatures[x.RGB10A2UI]=me.RENDER_TARGET|me.STORAGE_TEXTURE|me.SAMPLED_TEXTURE|me.LINEAR_FILTER,t=me.RENDER_TARGET|me.SAMPLED_TEXTURE|me.STORAGE_TEXTURE|me.VERTEX_ATTRIBUTE,this._formatFeatures[x.R16F]=t,this._formatFeatures[x.RG16F]=t,this._formatFeatures[x.RGB16F]=t,this._formatFeatures[x.RGBA16F]=t,t=me.STORAGE_TEXTURE|me.RENDER_TARGET|me.SAMPLED_TEXTURE|me.VERTEX_ATTRIBUTE,this._formatFeatures[x.R32F]=t,this._formatFeatures[x.RG32F]=t,this._formatFeatures[x.RGB32F]=t,this._formatFeatures[x.RGBA32F]=t,this._formatFeatures[x.RGB10A2UI]=me.RENDER_TARGET|me.STORAGE_TEXTURE|me.SAMPLED_TEXTURE|me.LINEAR_FILTER,t=me.RENDER_TARGET|me.STORAGE_TEXTURE|me.SAMPLED_TEXTURE|me.LINEAR_FILTER|me.VERTEX_ATTRIBUTE,this._formatFeatures[x.R8I]=t,this._formatFeatures[x.R8UI]=t,this._formatFeatures[x.R16I]=t,this._formatFeatures[x.R16UI]=t,this._formatFeatures[x.R32I]=t,this._formatFeatures[x.R32UI]=t,this._formatFeatures[x.RG8I]=t,this._formatFeatures[x.RG8UI]=t,this._formatFeatures[x.RG16I]=t,this._formatFeatures[x.RG16UI]=t,this._formatFeatures[x.RG32I]=t,this._formatFeatures[x.RG32UI]=t,this._formatFeatures[x.RGB8I]=t,this._formatFeatures[x.RGB8UI]=t,this._formatFeatures[x.RGB16I]=t,this._formatFeatures[x.RGB16UI]=t,this._formatFeatures[x.RGB32I]=t,this._formatFeatures[x.RGB32UI]=t,this._formatFeatures[x.RGBA8I]=t,this._formatFeatures[x.RGBA8UI]=t,this._formatFeatures[x.RGBA16I]=t,this._formatFeatures[x.RGBA16UI]=t,this._formatFeatures[x.RGBA32I]=t,this._formatFeatures[x.RGBA32UI]=t,this._textureExclusive[x.R8]=!1,this._textureExclusive[x.RG8]=!1,this._textureExclusive[x.RGB8]=!1,this._textureExclusive[x.R5G6B5]=!1,this._textureExclusive[x.RGBA4]=!1,this._textureExclusive[x.RGB5A1]=!1,this._textureExclusive[x.RGBA8]=!1,this._textureExclusive[x.RGB10A2]=!1,this._textureExclusive[x.RGB10A2UI]=!1,this._textureExclusive[x.SRGB8_A8]=!1,this._textureExclusive[x.R8I]=!1,this._textureExclusive[x.R8UI]=!1,this._textureExclusive[x.R16I]=!1,this._textureExclusive[x.R16UI]=!1,this._textureExclusive[x.R32I]=!1,this._textureExclusive[x.R32UI]=!1,this._textureExclusive[x.RG8I]=!1,this._textureExclusive[x.RG8UI]=!1,this._textureExclusive[x.RG16I]=!1,this._textureExclusive[x.RG16UI]=!1,this._textureExclusive[x.RG32I]=!1,this._textureExclusive[x.RG32UI]=!1,this._textureExclusive[x.RGBA8I]=!1,this._textureExclusive[x.RGBA8UI]=!1,this._textureExclusive[x.RGBA16I]=!1,this._textureExclusive[x.RGBA16UI]=!1,this._textureExclusive[x.RGBA32I]=!1,this._textureExclusive[x.RGBA32UI]=!1,this._textureExclusive[x.DEPTH]=!1,this._textureExclusive[x.DEPTH_STENCIL]=!1,e.has("float32-filterable")&&(this._formatFeatures[x.R32F]|=me.RENDER_TARGET,this._formatFeatures[x.RG32F]|=me.RENDER_TARGET,this._formatFeatures[x.RGBA32F]|=me.RENDER_TARGET,this._textureExclusive[x.R32F]=!1,this._textureExclusive[x.RG32F]=!1,this._textureExclusive[x.RGBA32F]=!1,this._formatFeatures[x.RGB32F]|=me.LINEAR_FILTER,this._formatFeatures[x.RGBA32F]|=me.LINEAR_FILTER,this._formatFeatures[x.R32F]|=me.LINEAR_FILTER,this._formatFeatures[x.RG32F]|=me.LINEAR_FILTER),e.has("shader-f16")&&(this._textureExclusive[x.R16F]=!1,this._textureExclusive[x.RG16F]=!1,this._textureExclusive[x.RGBA16F]=!1,this._formatFeatures[x.RGB16F]|=me.LINEAR_FILTER,this._formatFeatures[x.RGBA16F]|=me.LINEAR_FILTER,this._formatFeatures[x.R16F]|=me.LINEAR_FILTER,this._formatFeatures[x.RG16F]|=me.LINEAR_FILTER);var r=me.SAMPLED_TEXTURE|me.LINEAR_FILTER;e.has("texture-compression-etc2")&&(this._formatFeatures[x.ETC2_RGB8]=r,this._formatFeatures[x.ETC2_RGBA8]=r,this._formatFeatures[x.ETC2_SRGB8]=r,this._formatFeatures[x.ETC2_SRGB8_A8]=r,this._formatFeatures[x.ETC2_RGB8_A1]=r,this._formatFeatures[x.ETC2_SRGB8_A1]=r),e.has("texture-compression-bc")&&(this._formatFeatures[x.BC1]=r,this._formatFeatures[x.BC1_ALPHA]=r,this._formatFeatures[x.BC1_SRGB]=r,this._formatFeatures[x.BC1_SRGB_ALPHA]=r,this._formatFeatures[x.BC2]=r,this._formatFeatures[x.BC2_SRGB]=r,this._formatFeatures[x.BC3]=r,this._formatFeatures[x.BC3_SRGB]=r),e.has("texture-compression-astc")&&(this._formatFeatures[x.ASTC_RGBA_4X4]=r,this._formatFeatures[x.ASTC_RGBA_5X4]=r,this._formatFeatures[x.ASTC_RGBA_5X5]=r,this._formatFeatures[x.ASTC_RGBA_6X5]=r,this._formatFeatures[x.ASTC_RGBA_6X6]=r,this._formatFeatures[x.ASTC_RGBA_8X5]=r,this._formatFeatures[x.ASTC_RGBA_8X6]=r,this._formatFeatures[x.ASTC_RGBA_8X8]=r,this._formatFeatures[x.ASTC_RGBA_10X5]=r,this._formatFeatures[x.ASTC_RGBA_10X6]=r,this._formatFeatures[x.ASTC_RGBA_10X8]=r,this._formatFeatures[x.ASTC_RGBA_10X10]=r,this._formatFeatures[x.ASTC_RGBA_12X10]=r,this._formatFeatures[x.ASTC_RGBA_12X12]=r,this._formatFeatures[x.ASTC_SRGBA_4X4]=r,this._formatFeatures[x.ASTC_SRGBA_5X4]=r,this._formatFeatures[x.ASTC_SRGBA_5X5]=r,this._formatFeatures[x.ASTC_SRGBA_6X5]=r,this._formatFeatures[x.ASTC_SRGBA_6X6]=r,this._formatFeatures[x.ASTC_SRGBA_8X5]=r,this._formatFeatures[x.ASTC_SRGBA_8X6]=r,this._formatFeatures[x.ASTC_SRGBA_8X8]=r,this._formatFeatures[x.ASTC_SRGBA_10X5]=r,this._formatFeatures[x.ASTC_SRGBA_10X6]=r,this._formatFeatures[x.ASTC_SRGBA_10X8]=r,this._formatFeatures[x.ASTC_SRGBA_10X10]=r,this._formatFeatures[x.ASTC_SRGBA_12X10]=r,this._formatFeatures[x.ASTC_SRGBA_12X12]=r)},c.getDefaultDescResources=function(e,t){var r=De(e.visibility,0),i=this.defaultResource;if(e.buffer){if(r=Ue(e.buffer.type,r),e.buffer.hasDynamicOffset&&(r=De(e.buffer.hasDynamicOffset?1:0,r)),void 0!==e.buffer.minBindingSize&&(r=De(e.buffer.minBindingSize,r)),i.buffersDescLayout.has(r))return i.buffersDescLayout.get(r);var s=new g;return s.usage=t.usage,s.size=s.stride=16,s.memUsage=t.memUsage,s.flags=t.flags,i.buffersDescLayout.set(r,this.createBuffer(s)),i.buffersDescLayout.get(r)}if(e.texture){if(r=Ue(e.texture.sampleType,r),r=Ue(e.texture.viewDimension,r),r=De(e.texture.multisampled?1:0,r),r=De(t.mipLevel,r),r=De(t.arrayLayer,r),i.texturesDescLayout.has(r))return i.texturesDescLayout.get(r);var n=new oe(t.type,t.usage,t.format,Math.pow(2,t.mipLevel-1),Math.pow(2,t.mipLevel-1),t.flags,t.arrayLayer,t.mipLevel,t.samples,1);return i.texturesDescLayout.set(r,this.createTexture(n)),i.texturesDescLayout.get(r)}if(e.sampler){if(r=Ue(e.sampler.type,r),i.samplersDescLayout.has(r))return i.samplersDescLayout.get(r);var a=new ve;return a.minFilter=t.minFilter,a.magFilter=t.magFilter,a.mipFilter=t.mipFilter,a.addressU=t.addressU,a.addressV=t.addressV,a.addressW=t.addressW,i.samplersDescLayout.set(r,this.getSampler(a)),i.samplersDescLayout.get(r)}},c._createDefaultDescSet=function(){var e=this.defaultResource,t=new Ee,r=new xe;r.binding=0,r.count=1,r.descriptorType=A.UNIFORM_BUFFER,r.stageFlags=P.VERTEX,t.bindings.push(r),e.setLayout=this.createDescriptorSetLayout(t);var i=new V;i.layout=e.setLayout,e.descSet=this.createDescriptorSet(i),e.descSet.bindBuffer(0,e.buffer),e.descSet.update()},c.initDevice=(l=n(a().mark((function e(t){var r,i,n,u,o,l,c,h,f,p,T,R,b,y,S,A,E,C,G,P,I,D,U,L,M,O,N,k,z,V;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=navigator.gpu,e.next=3,null==i?void 0:i.requestAdapter();case 3:return this._adapter=e.sent,n=this._adapter.limits.maxVertexAttributes,u=this._adapter.limits.maxSampledTexturesPerShaderStage,o=[],this._adapter.features.has("float32-filterable")?o.push("float32-filterable"):s("Filterable 32-bit float textures support is not available"),e.next=10,null==(r=this._adapter)?void 0:r.requestDevice({requiredLimits:{maxVertexAttributes:n,maxSampledTexturesPerShaderStage:u},requiredFeatures:o});case 10:return this._device=e.sent,e.next=13,Mt||(Mt=Promise.resolve().then((function(){return hr()})));case 13:for(this._glslang=Le.glslang,this._twgsl=Le.twgsl,this._gfxAPI=Te.WEBGPU,this._swapchainFormat=Ye(navigator.gpu.getPreferredCanvasFormat()),l=this._bindingMappingInfo=t.bindingMappingInfo,c=[],h=[],f=l.setIndices[0],c[f]=0,h[f]=0,p=l.setIndices.length,T=1;T<p;++T)R=l.setIndices[T],b=l.setIndices[T-1],c[R]=l.maxBlockCounts[b]+c[b],h[R]=l.maxSamplerTextureCounts[b]+h[b];for(y=0;y<p;++y)S=l.setIndices[y],h[S]-=l.maxBlockCounts[S];return this._bindingMappings={blockOffsets:c,samplerTextureOffsets:h,flexibleSet:l.setIndices[p-1]},A=Re.canvas,this._context=A.getContext("webgpu"),this._device,E=this._adapter.info,this._vendor=E.vendor,this._renderer=E.device,C=E.description,G=this._adapter.limits,this._caps.clipSpaceMinZ=0,this._caps.screenSpaceSignY=-1,this._caps.uboOffsetAlignment=256,this._caps.maxUniformBufferBindings=12,this._caps.maxVertexAttributes=G.maxVertexAttributes,this._caps.maxUniformBufferBindings=G.maxUniformBufferBindingSize,this._caps.maxTextureSize=G.maxTextureDimension2D,this._caps.maxArrayTextureLayers=G.maxTextureArrayLayers,this._caps.max3DTextureSize=G.maxTextureDimension3D,this._caps.uboOffsetAlignment=G.minUniformBufferOffsetAlignment,P=this._adapter.features,this._multiDrawIndirect=!1,this._features.fill(!1),this._features[be.ELEMENT_INDEX_UINT]=!0,this._features[be.INSTANCED_ARRAYS]=!0,this._features[be.MULTIPLE_RENDER_TARGETS]=!0,this.initFormatFeatures(P),this._queue=this.createQueue(new ye(Se.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Be(this._queue)),I=new oe(w.TEX2D,F.STORAGE|F.SAMPLED|F.TRANSFER_DST,x.RGBA8,16,16,B.NONE,1,1,Ae.X1,1),D=this.createTexture(I),U=new oe(w.CUBE,F.STORAGE|F.SAMPLED|F.TRANSFER_DST,x.RGBA8,16,16,B.NONE,6),L=this.createTexture(U),M=new g(_.UNIFORM,m.DEVICE,16,16,v.NONE),O=this.createBuffer(M),N=new ve,k=this.getSampler(N),(z=this.defaultResource).buffer=O,z.texture=D,z.sampler=k,z.cubeTexture=L,this._createDefaultDescSet(),V="",this.getFormatFeatures(x.ETC_RGB8)&&(V+="etc1 "),this.getFormatFeatures(x.ETC2_RGB8)&&(V+="etc2 "),this.getFormatFeatures(x.BC1)&&(V+="dxt "),this.getFormatFeatures(x.PVRTC_RGB2)&&(V+="pvrtc "),this.getFormatFeatures(x.ASTC_RGBA_4X4)&&(V+="astc "),d("WebGPU device initialized."),d("RENDERER: "+this._renderer),d("VENDOR: "+this._vendor),d("DESCRIPTION: "+C),d("COMPRESSED_FORMAT: "+V),e.abrupt("return",Promise.resolve(!0));case 80:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)}),c.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},c.resize=function(){},c.acquire=function(){},c.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},c.createCommandBuffer=function(e){var t=new Wt;return t.initialize(e)?t:null},c.createBuffer=function(e){var t=new Nt;return t.initialize(e),t},c.createTexture=function(e){var t=new ir;return t.initialize(e),t},c.createDescriptorSet=function(e){var t=new Ot;return t.initialize(e),t},c.createShader=function(e){var t=new tr;return t.initialize(e),t},c.createInputAssembler=function(e){var t=new qt;return t.initialize(e),t},c.createRenderPass=function(e){var t=new Zt;return t.initialize(e),t},c.createFramebuffer=function(e){var t=new Ht;return t.initialize(e),t},c.createDescriptorSetLayout=function(e){var t=new Yt;return t.initialize(e),t},c.createPipelineLayout=function(e){var t=new Qt;return t.initialize(e)?t:null},c.createPipelineState=function(e){var t=new $t;return t.initialize(e),t},c.createQueue=function(e){var t=new Kt;return t.initialize(e)?t:null},c.copyBuffersToTexture=function(e,t,r){Lt(this,e,t.gpuTexture,r)},c.copyTexImagesToTexture=function(e,t,r){Et(this,e,t.gpuTexture,r)},c.copyFramebufferToBuffer=function(){},c.blitFramebuffer=function(){},r(t,[{key:"isPremultipliedAlpha",get:function(){return!!this._gpuConfig&&"premultiplied"===this._gpuConfig.alphaMode}},{key:"multiDrawIndirectSupport",get:function(){return this._multiDrawIndirect}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"context",get:function(){return this._context}},{key:"gpuConfig",get:function(){return this._gpuConfig},set:function(e){this._gpuConfig=e}},{key:"floatFilterable",get:function(){return this._adapter.features.has("float32-filterable")}},{key:"nativeDevice",get:function(){return this._device}},{key:"glslang",get:function(){return this._glslang}},{key:"twgsl",get:function(){return this._twgsl}}]),t}(Re));we.WebGPUDevice=pr}}}));
//# sourceMappingURL=gfx-webgpu.js.map
