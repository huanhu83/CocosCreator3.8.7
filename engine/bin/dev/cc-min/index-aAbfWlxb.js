System.register(["./zlib.min-CyXMsivM.js","./gc-object-BD6DANSw.js","./_virtual_internal_constants-CVZmBipG.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./index-BcjqSS2q.js","./debug-view-zRQBd5E1.js","./deprecated-BaebfHhU.js","./scene-D5fG1En6.js","./pipeline-state-manager-C4BAah3w.js","./render-types-DTmbYHic.js","./global-exports-ZavlJGEN.js","./deprecated-BfPl6EQ2.js","./prefab-CJahvMeV.js","./node-event-BDYemSfE.js"],(function(e){"use strict";var t,r,i,s,n,a,o,u,c,h,d,l,p,f,v,g,_,m,y,S,E,w,D,T,I,R,N,A,P,L,b,C,x,B,O,G,M,V,F,U,k,H,Q,z,W,j,q,X,Y,K,Z,J,$,ee,te,re,ie,se,ne,ae,oe,ue,ce,he,de,le,pe,fe,ve,ge,_e,me,ye,Se,Ee,we,De,Te,Ie,Re,Ne,Ae,Pe,Le,be,Ce,xe,Be,Oe,Ge,Me,Ve,Fe,Ue,ke,He,Qe,ze,We,je,qe,Xe,Ye,Ke,Ze,Je,$e,et,tt,rt,it,st,nt,at,ot,ut,ct,ht,dt,lt,pt,ft,vt,gt,_t,mt,yt,St,Et,wt;return{setters:[function(e){t=e._},function(e){r=e.R,i=e.j,s=e.a,n=e.F,a=e.L,o=e.H,u=e._,c=e.Z,h=e.a3,d=e.z,l=e.h,p=e.t},function(e){f=e.D},function(e){v=e.d},function(e){g=e.b0,_=e.F,m=e.q,y=e.p,S=e.d,E=e.ag,w=e.bo,D=e.aP,T=e.y,I=e.C,R=e.S,N=e.ab,A=e.g,P=e.i,L=e.j,b=e.l,C=e.V,x=e.b2,B=e.ay,O=e.U,G=e.ac,M=e.H,V=e.J,F=e.K,U=e.B,k=e.b,H=e.M,Q=e.ax,z=e.r,W=e.aW,j=e.h,q=e.o,X=e.a7,Y=e.aM,K=e.al,Z=e.e,J=e.T,$=e.aJ,ee=e.Q,te=e.bc,re=e.A,ie=e.I,se=e.t,ne=e.aV,ae=e.aB,oe=e.x,ue=e.w,ce=e.aL,he=e.R,de=e.ad,le=e.v,pe=e.ae,fe=e.ap,ve=e.b4,ge=e.b5,_e=e.k,me=e.bm,ye=e.bj,Se=e.bl,Ee=e.bn,we=e.bk,De=e.ar,Te=e.at},function(e){Ie=e.G,Re=e.g,Ne=e.h,Ae=e._,Pe=e.o,Le=e.f,be=e.M,Ce=e.Q,xe=e.C,Be=e.V,Oe=e.b3},function(e){Ge=e.L,Me=e.f,Ve=e.S,Fe=e.n,Ue=e.v,ke=e.t},null,function(e){He=e.C,Qe=e.w,ze=e.d,We=e.t,je=e._,qe=e.ar,Xe=e.B,Ye=e.g,Ke=e.b,Ze=e.as,Je=e.at,$e=e.au,et=e.L,tt=e.av,rt=e.aw,it=e.ax,st=e.ay,nt=e.az,at=e.aA},function(e){ot=e.z,ut=e.A,ct=e.P,ht=e.S,dt=e.o,lt=e.L,pt=e.B,ft=e.D,vt=e.E,gt=e.c,_t=e.F,mt=e.G,yt=e.H},function(e){St=e.P},function(e){Et=e.c,wt=e.l},null,null,null],execute:function(){var Dt;e({a:function(e){return e.cameraId},b:function(e,t,r){Oi(r,t);var i=r,s=i.pipelineSceneData.shadows,n=r.pipelineSceneData.validPunctualLights;Ui.reset();var a=r.pipelineSceneData.shadows;if(!s.enabled||s.type!==Qe.ShadowMap)return Ui;Ui.shadowEnabled=!0;for(var o=0,u=0;o<s.maxReceived&&u<n.length;){var c=n[u];c.type===Ge.SPOT&&c.shadowEnabled&&(Ui.validLights.push(c),o++),u++}var h=t.scene.mainLight,d=a.size.x,l=a.size.y;if(h&&h.shadowEnabled)if(Ui.mainLightShadowNames[0]="MainLightShadow"+e,h.shadowFixedArea)Vi(Ui.mainLightShadowNames[0],r,t,h,0,d,l);else{var p=i.pipelineSceneData.csmSupported?h.csmLevel:1;Ui.mainLightShadowNames[0]="MainLightShadow"+e;for(var f=0;f<p;f++)Vi(Ui.mainLightShadowNames[0],r,t,h,f,d,l)}for(var v=0;v<Ui.validLights.length;v++){var g=Ui.validLights[v],_="SpotLightShadow"+v.toString()+e;Ui.spotLightShadowNames[v]=_,Vi(_,r,t,g,0,d,l)}return Ui},g:Mi,s:wo}),function(e){e[e.PER_INSTANCE=0]="PER_INSTANCE",e[e.PER_BATCH=1]="PER_BATCH",e[e.PER_PHASE=2]="PER_PHASE",e[e.PER_PASS=3]="PER_PASS",e[e.COUNT=4]="COUNT"}(Dt||(Dt={}));var Tt,It,Rt,Nt,At,Pt={CONSTANTS:0,CBV:1,UAV:2,SRV:3,TABLE:4,SSV:5};e("R",Tt),function(e){e[e.MANAGED=0]="MANAGED",e[e.MEMORYLESS=1]="MEMORYLESS",e[e.PERSISTENT=2]="PERSISTENT",e[e.EXTERNAL=3]="EXTERNAL",e[e.BACKBUFFER=4]="BACKBUFFER"}(Tt||e("R",Tt={})),e("Q",It),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=3]="BLEND",e[e.RENDER_OPAQUE=1]="RENDER_OPAQUE",e[e.RENDER_CUTOUT=2]="RENDER_CUTOUT",e[e.RENDER_TRANSPARENT=3]="RENDER_TRANSPARENT"}(It||e("Q",It={})),function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE1D=1]="TEXTURE1D",e[e.TEXTURE2D=2]="TEXTURE2D",e[e.TEXTURE3D=3]="TEXTURE3D"}(Rt||(Rt={})),function(e){e[e.NONE=0]="NONE",e[e.UNIFORM=1]="UNIFORM",e[e.INDIRECT=2]="INDIRECT",e[e.STORAGE=4]="STORAGE",e[e.SAMPLED=8]="SAMPLED",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT",e[e.SHADING_RATE=128]="SHADING_RATE",e[e.TRANSFER_SRC=256]="TRANSFER_SRC",e[e.TRANSFER_DST=512]="TRANSFER_DST"}(Nt||(Nt={})),e("S",At),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=4]="BLEND",e[e.OPAQUE_OBJECT=1]="OPAQUE_OBJECT",e[e.CUTOUT_OBJECT=2]="CUTOUT_OBJECT",e[e.TRANSPARENT_OBJECT=4]="TRANSPARENT_OBJECT",e[e.SHADOW_CASTER=8]="SHADOW_CASTER",e[e.UI=16]="UI",e[e.DEFAULT_LIGHTING=32]="DEFAULT_LIGHTING",e[e.VOLUMETRIC_LIGHTING=64]="VOLUMETRIC_LIGHTING",e[e.CLUSTERED_LIGHTING=128]="CLUSTERED_LIGHTING",e[e.PLANAR_SHADOW=256]="PLANAR_SHADOW",e[e.GEOMETRY=512]="GEOMETRY",e[e.PROFILER=1024]="PROFILER",e[e.DRAW_INSTANCING=2048]="DRAW_INSTANCING",e[e.DRAW_NON_INSTANCING=4096]="DRAW_NON_INSTANCING",e[e.REFLECTION_PROBE=8192]="REFLECTION_PROBE",e[e.GPU_DRIVEN=16384]="GPU_DRIVEN",e[e.NON_BUILTIN=32768]="NON_BUILTIN",e[e.ALL=4294967295]="ALL"}(At||e("S",At={}));var Lt,bt={NONE:0,DEFAULT:1,CLUSTERED:2},Ct={RENDER_TARGET:0,DEPTH_STENCIL:1,SHADING_RATE:2};!function(e){e[e.READ=0]="READ",e[e.READ_WRITE=1]="READ_WRITE",e[e.WRITE=2]="WRITE"}(Lt||(Lt={}));var xt={NONE:0,FLOAT_TYPE:1,INT_TYPE:2},Bt=e("L",function(){function e(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=!1),void 0===i&&(i=null),this.light=e,this.probe=i,this.level=t,this.culledByLight=r}return e.prototype.reset=function(e,t,r,i){this.light=e,this.probe=i,this.level=t,this.culledByLight=r},e}()),Ot={NONE:0,COLOR:1,DEPTH:2,STENCIL:4},Gt=function(){function e(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=Ot.NONE),void 0===i&&(i=g.SAMPLE_ZERO),void 0===s&&(s=g.SAMPLE_ZERO),this.source=e,this.target=t,this.resolveFlags=r,this.mode=i,this.mode1=s}return e.prototype.reset=function(e,t,r,i,s){this.source=e,this.target=t,this.resolveFlags=r,this.mode=i,this.mode1=s},e}(),Mt=function(){function e(e,t,r,i,s,n,a,o,u,c){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===n&&(n=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===c&&(c=0),this.source=e,this.target=t,this.mipLevels=r,this.numSlices=i,this.sourceMostDetailedMip=s,this.sourceFirstSlice=n,this.sourcePlaneSlice=a,this.targetMostDetailedMip=o,this.targetFirstSlice=u,this.targetPlaneSlice=c}return e.prototype.reset=function(e,t,r,i,s,n,a,o,u,c){this.source=e,this.target=t,this.mipLevels=r,this.numSlices=i,this.sourceMostDetailedMip=s,this.sourceFirstSlice=n,this.sourcePlaneSlice=a,this.targetMostDetailedMip=o,this.targetFirstSlice=u,this.targetPlaneSlice=c},e}(),Vt=function(){function e(e,t,r,i,s,n,a){void 0===e&&(e=new Uint8Array(0)),void 0===t&&(t=""),void 0===r&&(r=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===n&&(n=0),void 0===a&&(a=0),this.source=e,this.target=t,this.mipLevels=r,this.numSlices=i,this.targetMostDetailedMip=s,this.targetFirstSlice=n,this.targetPlaneSlice=a}return e.prototype.reset=function(e,t,r,i,s,n){this.target=e,this.mipLevels=t,this.numSlices=r,this.targetMostDetailedMip=i,this.targetFirstSlice=s,this.targetPlaneSlice=n},e}(),Ft=function(){function e(e,t,r,i,s,n,a){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===n&&(n=0),void 0===a&&(a=0),this.source=e,this.target=t,this.mipLevels=r,this.numSlices=i,this.targetMostDetailedMip=s,this.targetFirstSlice=n,this.targetPlaneSlice=a}return e.prototype.reset=function(e,t,r,i,s,n,a){this.source=e,this.target=t,this.mipLevels=r,this.numSlices=i,this.targetMostDetailedMip=s,this.targetFirstSlice=n,this.targetPlaneSlice=a},e}(),Ut=function(){function e(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0}return e.prototype.reset=function(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0},e}();function kt(e){return new r((function(){return new e}),16)}var Ht,Qt,zt,Wt=function(){function e(){this.li=kt(Bt),this.rp=kt(Gt),this.cp=kt(Mt),this.up=kt(Vt),this.mp=kt(Ft),this.ps=kt(Ut)}var t=e.prototype;return t.reset=function(){this.li.reset(),this.rp.reset(),this.cp.reset(),this.up.reset(),this.mp.reset(),this.ps.reset()},t.createLightInfo=function(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=!1),void 0===i&&(i=null);var s=this.li.add();return s.reset(e,t,r,i),s},t.createResolvePair=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=Ot.NONE),void 0===i&&(i=g.SAMPLE_ZERO),void 0===s&&(s=g.SAMPLE_ZERO);var n=this.rp.add();return n.reset(e,t,r,i,s),n},t.createCopyPair=function(e,t,r,i,s,n,a,o,u,c){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===n&&(n=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===c&&(c=0);var h=this.cp.add();return h.reset(e,t,r,i,s,n,a,o,u,c),h},t.createUploadPair=function(e,t,r,i,s,n){void 0===e&&(e=""),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),void 0===i&&(i=0),void 0===s&&(s=0),void 0===n&&(n=0);var a=this.up.add();return a.reset(e,t,r,i,s,n),a},t.createMovePair=function(e,t,r,i,s,n,a){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===n&&(n=0),void 0===a&&(a=0);var o=this.mp.add();return o.reset(e,t,r,i,s,n,a),o},t.createPipelineStatistics=function(){var e=this.ps.add();return e.reset(),e},e}(),jt=function(){function e(e,t){this.source=void 0,this.target=void 0,this.source=e,this.target=t}return e.prototype.equals=function(e){return this.source===e.source&&this.target===e.target},e}(),qt=function(){function e(e){this.target=void 0,this.target=e}return e.prototype.equals=function(e){return this.target===e.target},e}();Ht=Symbol.iterator;var Xt=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[Ht]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new jt(this.source,e.value.target),done:!1}},e}();Qt=Symbol.iterator;var Yt=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[Qt]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new jt(e.value.target,this.source),done:!1}},e}();zt=Symbol.iterator;var Kt=function(){function e(e,t){this.graph=void 0,this.iterator=void 0,this.graph=e,this.iterator=t}var t=e.prototype;return t[zt]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:this.graph.target(e.value),done:!1}},e}();function Zt(e,t){if(t===e.N)return"";for(var r=[];t!==e.N;t=e.getParent(t))r.push(e.vertexName(t));for(var i="",s=r.length;s-- >0;)i+="/",i+=r[s];return i}function Jt(e,t,r){var i=e.N,s=r.split("/");if(0===s.length)return t;var n=t,a=0;""===s[0]&&(n=i,++a);for(var o=a;o!==s.length;++o){var u=s[o];if(""!==u&&"."!==u)if(".."!==u){if((n=e.locateChild(n,u))===i)return i}else{if(n===i)return i;n=e.getParent(n)}}return n}var $t,er=function(){function e(){}return e.prototype.terminate=function(){return!1},e}();function tr(e){var t=e.v().next();return t.done?e.N:t.value}!function(e){e[e.WHITE=0]="WHITE",e[e.GRAY=1]="GRAY",e[e.GREEN=2]="GREEN",e[e.RED=3]="RED",e[e.BLACK=4]="BLACK"}($t||($t={}));var rr=function(e,t,r){this.v=void 0,this.e=void 0,this.iter=void 0,this.v=e,this.e=t,this.iter=r};function ir(e,t,r,i,s){var n=null,a=null,o=new Array;for(i.put(t,$t.GRAY),r.discoverVertex(t,e),a=e.oe(t),s.terminate(t,e)?o.push(new rr(t,null,null)):o.push(new rr(t,null,a));o.length;){var u=o.pop();if(t=u.v,n=u.e,a=u.iter,null!==n&&r.finishEdge(n,e),a)for(var c=a.next();!c.done;c=a.next()){var h=c.value,d=h.target;r.examineEdge(h,e);var l=i.get(d);if(l===$t.WHITE){if(r.treeEdge(h,e),n=h,o.push(new rr(t,n,a)),t=d,i.put(t,$t.GRAY),r.discoverVertex(t,e),a=e.oe(t),s.terminate(t,e))break}else l===$t.GRAY?r.backEdge(h,e):r.forwardOrCrossEdge(h,e),r.finishEdge(h,e)}i.put(t,$t.BLACK),r.finishVertex(t,e)}}function sr(e,t,r,s){if(void 0===s&&(s=null),null!==(s=s||tr(e))&&0!==e.nv()){for(var n,a=i(e.v());!(n=a()).done;){var o=n.value;r.put(o,$t.WHITE),t.initializeVertex(o,e)}var u=new er;s!==tr(e)&&(t.startVertex(s,e),ir(e,s,t,r,u));for(var c,h=i(e.v());!(c=h()).done;){var d=c.value;r.get(d)===$t.WHITE&&(t.startVertex(d,e),ir(e,d,t,r,u))}}}var nr=function(){function e(){}var t=e.prototype;return t.initializeVertex=function(){},t.startVertex=function(){},t.discoverVertex=function(){},t.examineEdge=function(){},t.treeEdge=function(){},t.backEdge=function(){},t.forwardOrCrossEdge=function(){},t.finishEdge=function(){},t.finishVertex=function(){},e}(),ar=function(){function e(e){this.g=void 0,this.g=e,this.N=e.N}var t=e.prototype;return t.edge=function(e,t){return this.g.reference(e,t)},t.source=function(e){return this.g.parent(e)},t.target=function(e){return this.g.child(e)},t.oe=function(e){return this.g.children(e)},t.od=function(e){return this.g.numChildren(e)},t.v=function(){return this.g.v()},t.nv=function(){return this.g.nv()},e}();function or(e){e.x=0,e.y=0,e.z=0,e.w=0}function ur(e){e.left=0,e.top=0,e.width=0,e.height=0,e.minDepth=0,e.maxDepth=1}var cr=function(){function e(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=r,this.w=i}return e.prototype.reset=function(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i},e}(),hr=function(){function e(e,t,r,i,s,n,a,o){void 0===e&&(e=""),void 0===t&&(t=Lt.WRITE),void 0===r&&(r=Ct.RENDER_TARGET),void 0===i&&(i=D.LOAD),void 0===s&&(s=T.STORE),void 0===n&&(n=I.ALL),void 0===a&&(a=new N),void 0===o&&(o=R.NONE),this.slotName1="",this.slotID=0,this.slotName=e,this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=n,this.clearColor=a,this.shaderStageFlags=o}return e.prototype.reset=function(e,t,r,i,s,n,a){this.slotName=e,this.slotName1="",this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=n,or(this.clearColor),this.slotID=0,this.shaderStageFlags=a},e}(),dr=function(){function e(e,t,r,i,s,n){void 0===e&&(e=""),void 0===t&&(t=Lt.READ),void 0===r&&(r=I.NONE),void 0===i&&(i=xt.NONE),void 0===s&&(s=new cr),void 0===n&&(n=R.NONE),this.plane=0,this.name=e,this.accessType=t,this.clearFlags=r,this.clearValueType=i,this.clearValue=s,this.shaderStageFlags=n}return e.prototype.reset=function(e,t,r,i,s){this.name=e,this.accessType=t,this.plane=0,this.clearFlags=r,this.clearValueType=i,this.clearValue.reset(0,0,0,0),this.shaderStageFlags=s},e}(),lr=function(){function e(){this.dimension=Rt.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=_.UNKNOWN,this.sampleCount=m.X1,this.textureFlags=y.NONE,this.flags=Nt.NONE,this.viewType=S.TEX2D}return e.prototype.reset=function(){this.dimension=Rt.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=_.UNKNOWN,this.sampleCount=m.X1,this.textureFlags=y.NONE,this.flags=Nt.NONE,this.viewType=S.TEX2D},e}(),pr=function(){function e(e){void 0===e&&(e=Tt.MANAGED),this.residency=e}return e.prototype.reset=function(e){this.residency=e},e}(),fr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=!1),this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.swapchain=e,this.isDepthStencil=t}return e.prototype.reset=function(e,t){this.swapchain=e,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.isDepthStencil=t},e}(),vr=function(){function e(){this.states=E.NONE}return e.prototype.reset=function(){this.states=E.NONE},e}(),gr=function(){function e(e){void 0===e&&(e=null),this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){this.buffer=e,this.fenceValue=0},e}(),_r=function(){function e(e){void 0===e&&(e=null),this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){this.buffer=e,this.fenceValue=0},e}(),mr=function(){function e(e){void 0===e&&(e=null),this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){this.texture=e,this.fenceValue=0},e}(),yr=function(){function e(e){void 0===e&&(e=null),this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){this.texture=e,this.fenceValue=0},e}(),Sr=function(){function e(){this.unused=0}return e.prototype.reset=function(){this.unused=0},e}(),Er=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[]}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0},e}(),wr=function(){this.o=[],this.i=[]},Dr=function(){function e(){this.N=4294967295,this.x=[],this._names=[],this._subpasses=[]}var t=e.prototype;return t.edge=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.source=function(e){return e.source},t.target=function(e){return e.target},t.oe=function(e){return new Xt(this.x[e].o.values(),e)},t.od=function(e){return this.x[e].o.length},t.ie=function(e){return new Yt(this.x[e].i.values(),e)},t.id=function(e){return this.x[e].i.length},t.d=function(e){return this.od(e)+this.id(e)},t.adj=function(e){return new Kt(this,this.oe(e))},t.v=function(){return this.x.keys()},t.nv=function(){return this.x.length},t.ne=function(){for(var e,t=0,r=i(this.v());!(e=r()).done;){var s=e.value;t+=this.od(s)}return t},t.clear=function(){this._names.length=0,this._subpasses.length=0,this.x.length=0},t.addVertex=function(e,t){var r=new wr,i=this.x.length;return this.x.push(r),this._names.push(e),this._subpasses.push(t),i},t.addEdge=function(e,t){return this.x[e].o.push(new qt(t)),this.x[t].i.push(new qt(e)),new jt(e,t)},t.vertexName=function(e){return this._names[e]},t.getName=function(e){return this._names[e]},t.setName=function(e,t){this._names[e]=t},t.getSubpass=function(e){return this._subpasses[e]},e}(),Tr=function(){function e(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0),this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[],this.viewport=new w,this.showStatistics=!1,this.subpassID=e,this.count=t,this.quality=r}return e.prototype.reset=function(e,t,r){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0,ur(this.viewport),this.subpassID=e,this.count=t,this.quality=r,this.showStatistics=!1},e}(),Ir=function(){function e(e){void 0===e&&(e=4294967295),this.rasterViews=new Map,this.computeViews=new Map,this.subpassID=e}return e.prototype.reset=function(e){this.rasterViews.clear(),this.computeViews.clear(),this.subpassID=e},e}(),Rr=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.attachmentIndexMap=new Map,this.textures=new Map,this.subpassGraph=new Dr,this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport=new w,this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.attachmentIndexMap.clear(),this.textures.clear(),this.subpassGraph.clear(),this.width=0,this.height=0,this.count=1,this.quality=0,ur(this.viewport),this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1},e}(),Nr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.clearColors=[],this.clearDepth=0,this.clearStencil=0,this.renderPass=e,this.framebuffer=t}return e.prototype.reset=function(e,t){this.renderPass=e,this.framebuffer=t,this.clearColors.length=0,this.clearDepth=0,this.clearStencil=0},e}(),Ar=function(){function e(){this.format=_.UNKNOWN}return e.prototype.reset=function(){this.format=_.UNKNOWN},e}(),Pr=function(){function e(){this.textureView=null,this.format=_.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0}return e.prototype.reset=function(){this.textureView=null,this.format=_.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0},e}(),Lr=function(e,t){this.o=[],this.i=[],this.t=void 0,this.j=void 0,this.id=e,this.object=t,this.t=e,this.j=t},br=function(){function e(){this.N=4294967295,this.x=[],this._names=[],this._descs=[],this._traits=[],this._states=[],this._samplerInfo=[],this._valueIndex=new Map,this.renderPasses=new Map,this.nextFenceValue=0,this.version=0}var t=e.prototype;return t.edge=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.source=function(e){return e.source},t.target=function(e){return e.target},t.oe=function(e){return new Xt(this.x[e].o.values(),e)},t.od=function(e){return this.x[e].o.length},t.ie=function(e){return new Yt(this.x[e].i.values(),e)},t.id=function(e){return this.x[e].i.length},t.d=function(e){return this.od(e)+this.id(e)},t.adj=function(e){return new Kt(this,this.oe(e))},t.v=function(){return this.x.keys()},t.nv=function(){return this.x.length},t.ne=function(){for(var e,t=0,r=i(this.v());!(e=r()).done;){var s=e.value;t+=this.od(s)}return t},t.clear=function(){this.renderPasses.clear(),this.nextFenceValue=0,this.version=0,this._valueIndex.clear(),this._names.length=0,this._descs.length=0,this._traits.length=0,this._states.length=0,this._samplerInfo.length=0,this.x.length=0},t.addVertex=function(e,t,r,i,s,n,a,o){void 0===o&&(o=4294967295);var u=new Lr(e,t),c=this.x.length;return this.x.push(u),this._names.push(r),this._descs.push(i),this._traits.push(s),this._states.push(n),this._samplerInfo.push(a),this._valueIndex.set(r,c),4294967295!==o&&this.addEdge(o,c),c},t.addEdge=function(e,t){return this.x[e].o.push(new qt(t)),this.x[t].i.push(new qt(e)),new jt(e,t)},t.vertexName=function(e){return this._names[e]},t.getName=function(e){return this._names[e]},t.setName=function(e,t){this._names[e]=t},t.getDesc=function(e){return this._descs[e]},t.getTraits=function(e){return this._traits[e]},t.getStates=function(e){return this._states[e]},t.getSampler=function(e){return this._samplerInfo[e]},t.h=function(e,t){return this.x[t].t===e},t.w=function(e){return this.x[e].t},t.object=function(e){return this.x[e].j},t.value=function(e,t){if(this.x[t].t===e)return this.x[t].j;throw Error("value id not match")},t.visitVertex=function(e,t){var r=this.x[t];switch(r.t){case 0:return e.managed(r.j);case 1:return e.managedBuffer(r.j);case 2:return e.managedTexture(r.j);case 3:return e.persistentBuffer(r.j);case 4:return e.persistentTexture(r.j);case 5:return e.framebuffer(r.j);case 6:return e.swapchain(r.j);case 7:return e.formatView(r.j);case 8:return e.subresourceView(r.j);default:throw Error("polymorphic type not found")}},t.j=function(e){return this.x[e].j},t.reference=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.parent=function(e){return e.source},t.child=function(e){return e.target},t.children=function(e){return new Xt(this.x[e].o.values(),e)},t.numChildren=function(e){return this.x[e].o.length},t.getParent=function(e){if(4294967295===e)return 4294967295;var t=this.x[e].i;return 0===t.length?4294967295:t[0].target},t.addReference=function(e,t){return this.addEdge(e,t)},t.contains=function(e){return this._valueIndex.has(e)},t.vertex=function(e){return this._valueIndex.get(e)},t.find=function(e){var t=this._valueIndex.get(e);return void 0===t?4294967295:t},e}(),Cr=function(){function e(){this.computeViews=new Map,this.textures=new Map}return e.prototype.reset=function(){this.computeViews.clear(),this.textures.clear()},e}(),xr=function(){function e(){this.resolvePairs=[]}return e.prototype.reset=function(){this.resolvePairs.length=0},e}(),Br=function(){function e(){this.copyPairs=[],this.uploadPairs=[]}return e.prototype.reset=function(){this.copyPairs.length=0,this.uploadPairs.length=0},e}(),Or=function(){function e(){this.movePairs=[]}return e.prototype.reset=function(){this.movePairs.length=0},e}(),Gr=function(){function e(){this.computeViews=new Map}return e.prototype.reset=function(){this.computeViews.clear()},e}(),Mr=function(){function e(e,t,r){void 0===e&&(e=""),void 0===t&&(t=I.ALL),void 0===r&&(r=new N),this.slotName=e,this.clearFlags=t,this.clearColor=r}return e.prototype.reset=function(e,t){this.slotName=e,this.clearFlags=t,or(this.clearColor)},e}(),Vr=function(){function e(e,t,r){void 0===e&&(e=It.RENDER_OPAQUE),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),this.viewport=null,this.hint=e,this.phaseID=t,this.passLayoutID=r}return e.prototype.reset=function(e,t,r){this.hint=e,this.phaseID=t,this.passLayoutID=r,this.viewport=null},e}(),Fr=function(){function e(e,t,r,i,s,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=At.NONE),void 0===i&&(i=new Bt),void 0===s&&(s=1),void 0===n&&(n=null),this.scene=e,this.camera=t,this.light=i,this.flags=r,this.cullingFlags=s,this.shadingLight=n}return e.prototype.reset=function(e,t,r,i,s){this.scene=e,this.camera=t,this.light.reset(null,0,!1,null),this.flags=r,this.cullingFlags=i,this.shadingLight=s},e}(),Ur=function(){function e(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s}return e.prototype.reset=function(e,t,r,i,s){this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s},e}(),kr=function(){function e(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=At.NONE),void 0===i&&(i=null),void 0===s&&(s=0),this.models=[],this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i,this.blitType=s}return e.prototype.reset=function(e,t,r,i,s){this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i,this.blitType=s,this.models.length=0},e}(),Hr=function(){function e(){this.constants=new Map,this.buffers=new Map,this.textures=new Map,this.samplers=new Map,this.custom=""}return e.prototype.reset=function(){this.constants.clear(),this.buffers.clear(),this.textures.clear(),this.samplers.clear(),this.custom=""},e}(),Qr=10,zr=function(e,t){this.o=[],this.i=[],this.c=[],this.p=[],this.t=void 0,this.j=void 0,this.id=e,this.object=t,this.t=e,this.j=t},Wr=function(){function e(){this.N=4294967295,this.x=[],this._names=[],this._layoutNodes=[],this._data=[],this._valid=[],this.index=new Map,this.sortedVertices=[],this.globalRenderData=new Hr}var t=e.prototype;return t.edge=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.source=function(e){return e.source},t.target=function(e){return e.target},t.oe=function(e){return new Xt(this.x[e].o.values(),e)},t.od=function(e){return this.x[e].o.length},t.ie=function(e){return new Yt(this.x[e].i.values(),e)},t.id=function(e){return this.x[e].i.length},t.d=function(e){return this.od(e)+this.id(e)},t.adj=function(e){return new Kt(this,this.oe(e))},t.v=function(){return this.x.keys()},t.nv=function(){return this.x.length},t.ne=function(){for(var e,t=0,r=i(this.v());!(e=r()).done;){var s=e.value;t+=this.od(s)}return t},t.clear=function(){this.index.clear(),this.sortedVertices.length=0,this.globalRenderData.reset(),this._names.length=0,this._layoutNodes.length=0,this._data.length=0,this._valid.length=0,this.x.length=0},t.addVertex=function(e,t,r,i,s,n,a){void 0===a&&(a=4294967295);var o=new zr(e,t),u=this.x.length;return this.x.push(o),this._names.push(r),this._layoutNodes.push(i),this._data.push(s),this._valid.push(n),4294967295!==a&&(this.x[a].c.push(new qt(u)),o.p.push(new qt(a))),u},t.addEdge=function(e,t){return this.x[e].o.push(new qt(t)),this.x[t].i.push(new qt(e)),new jt(e,t)},t.vertexName=function(e){return this._names[e]},t.getName=function(e){return this._names[e]},t.setName=function(e,t){this._names[e]=t},t.getLayout=function(e){return this._layoutNodes[e]},t.setLayout=function(e,t){this._layoutNodes[e]=t},t.getData=function(e){return this._data[e]},t.getValid=function(e){return this._valid[e]},t.setValid=function(e,t){this._valid[e]=t},t.h=function(e,t){return this.x[t].t===e},t.w=function(e){return this.x[e].t},t.object=function(e){return this.x[e].j},t.value=function(e,t){if(this.x[t].t===e)return this.x[t].j;throw Error("value id not match")},t.visitVertex=function(e,t){var r=this.x[t];switch(r.t){case 0:return e.rasterPass(r.j);case 1:return e.rasterSubpass(r.j);case 2:return e.computeSubpass(r.j);case 3:return e.compute(r.j);case 4:return e.resolve(r.j);case 5:return e.copy(r.j);case 6:return e.move(r.j);case 7:return e.raytrace(r.j);case 8:return e.queue(r.j);case 9:return e.scene(r.j);case Qr:return e.blit(r.j);case 11:return e.dispatch(r.j);case 12:return e.clear(r.j);case 13:return e.viewport(r.j);default:throw Error("polymorphic type not found")}},t.j=function(e){return this.x[e].j},t.reference=function(e,t){for(var r,s=i(this.x[e].c);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.parent=function(e){return e.source},t.child=function(e){return e.target},t.children=function(e){return new Xt(this.x[e].c.values(),e)},t.numChildren=function(e){return this.x[e].c.length},t.getParent=function(e){if(4294967295===e)return 4294967295;var t=this.x[e].p;return 0===t.length?4294967295:t[0].target},t.addReference=function(e,t){return this.x[e].c.push(new qt(t)),this.x[t].p.push(new qt(e)),new jt(e,t)},e}();function jr(e){return new r((function(){return new e}),16)}var qr,Xr,Yr=function(){function e(e){this.renderCommon=void 0,this.cv=jr(cr),this.rv=jr(hr),this.cv1=jr(dr),this.rd=jr(lr),this.rt=jr(pr),this.rs=jr(fr),this.rs1=jr(vr),this.mb=jr(gr),this.pb=jr(_r),this.mt=jr(mr),this.pt=jr(yr),this.mr=jr(Sr),this.s=jr(Er),this.sg=jr(Dr),this.rs2=jr(Tr),this.cs=jr(Ir),this.rp=jr(Rr),this.prpaf=jr(Nr),this.fv=jr(Ar),this.sv=jr(Pr),this.rg=jr(br),this.cp=jr(Cr),this.rp1=jr(xr),this.cp1=jr(Br),this.mp=jr(Or),this.rp2=jr(Gr),this.cv2=jr(Mr),this.rq=jr(Vr),this.sd=jr(Fr),this.d=jr(Ur),this.b=jr(kr),this.rd1=jr(Hr),this.rg1=jr(Wr),this.renderCommon=e}var t=e.prototype;return t.reset=function(){this.cv.reset(),this.rv.reset(),this.cv1.reset(),this.rd.reset(),this.rt.reset(),this.rs.reset(),this.rs1.reset(),this.mb.reset(),this.pb.reset(),this.mt.reset(),this.pt.reset(),this.mr.reset(),this.s.reset(),this.sg.reset(),this.rs2.reset(),this.cs.reset(),this.rp.reset(),this.prpaf.reset(),this.fv.reset(),this.sv.reset(),this.rg.reset(),this.cp.reset(),this.rp1.reset(),this.cp1.reset(),this.mp.reset(),this.rp2.reset(),this.cv2.reset(),this.rq.reset(),this.sd.reset(),this.d.reset(),this.b.reset(),this.rd1.reset(),this.rg1.reset()},t.createClearValue=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this.cv.add();return s.reset(e,t,r,i),s},t.createRasterView=function(e,t,r,i,s,n,a){void 0===e&&(e=""),void 0===t&&(t=Lt.WRITE),void 0===r&&(r=Ct.RENDER_TARGET),void 0===i&&(i=D.LOAD),void 0===s&&(s=T.STORE),void 0===n&&(n=I.ALL),void 0===a&&(a=R.NONE);var o=this.rv.add();return o.reset(e,t,r,i,s,n,a),o},t.createComputeView=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=Lt.READ),void 0===r&&(r=I.NONE),void 0===i&&(i=xt.NONE),void 0===s&&(s=R.NONE);var n=this.cv1.add();return n.reset(e,t,r,i,s),n},t.createResourceDesc=function(){var e=this.rd.add();return e.reset(),e},t.createResourceTraits=function(e){void 0===e&&(e=Tt.MANAGED);var t=this.rt.add();return t.reset(e),t},t.createRenderSwapchain=function(e,t){void 0===e&&(e=null),void 0===t&&(t=!1);var r=this.rs.add();return r.reset(e,t),r},t.createResourceStates=function(){var e=this.rs1.add();return e.reset(),e},t.createManagedBuffer=function(e){void 0===e&&(e=null);var t=this.mb.add();return t.reset(e),t},t.createPersistentBuffer=function(e){void 0===e&&(e=null);var t=this.pb.add();return t.reset(e),t},t.createManagedTexture=function(e){void 0===e&&(e=null);var t=this.mt.add();return t.reset(e),t},t.createPersistentTexture=function(e){void 0===e&&(e=null);var t=this.pt.add();return t.reset(e),t},t.createManagedResource=function(){var e=this.mr.add();return e.reset(),e},t.createSubpass=function(){var e=this.s.add();return e.reset(),e},t.createSubpassGraph=function(){var e=this.sg.add();return e.clear(),e},t.createRasterSubpass=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0);var i=this.rs2.add();return i.reset(e,t,r),i},t.createComputeSubpass=function(e){void 0===e&&(e=4294967295);var t=this.cs.add();return t.reset(e),t},t.createRasterPass=function(){var e=this.rp.add();return e.reset(),e},t.createPersistentRenderPassAndFramebuffer=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=this.prpaf.add();return r.reset(e,t),r},t.createFormatView=function(){var e=this.fv.add();return e.reset(),e},t.createSubresourceView=function(){var e=this.sv.add();return e.reset(),e},t.createResourceGraph=function(){var e=this.rg.add();return e.clear(),e},t.createComputePass=function(){var e=this.cp.add();return e.reset(),e},t.createResolvePass=function(){var e=this.rp1.add();return e.reset(),e},t.createCopyPass=function(){var e=this.cp1.add();return e.reset(),e},t.createMovePass=function(){var e=this.mp.add();return e.reset(),e},t.createRaytracePass=function(){var e=this.rp2.add();return e.reset(),e},t.createClearView=function(e,t){void 0===e&&(e=""),void 0===t&&(t=I.ALL);var r=this.cv2.add();return r.reset(e,t),r},t.createRenderQueue=function(e,t,r){void 0===e&&(e=It.RENDER_OPAQUE),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295);var i=this.rq.add();return i.reset(e,t,r),i},t.createSceneData=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=At.NONE),void 0===i&&(i=1),void 0===s&&(s=null);var n=this.sd.add();return n.reset(e,t,r,i,s),n},t.createDispatch=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0);var n=this.d.add();return n.reset(e,t,r,i,s),n},t.createBlit=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=At.NONE),void 0===i&&(i=null),void 0===s&&(s=0);var n=this.b.add();return n.reset(e,t,r,i,s),n},t.createRenderData=function(){var e=this.rd1.add();return e.reset(),e},t.createRenderGraph=function(){var e=this.rg1.add();return e.clear(),e},e}();!function(e){e[e.BASIC=0]="BASIC",e[e.STANDARD=1]="STANDARD"}(qr||(qr={})),function(e){e[e.NONE=0]="NONE",e[e.INPUT_DEPTH_STENCIL=1]="INPUT_DEPTH_STENCIL",e[e.INPUT_COLOR=2]="INPUT_COLOR",e[e.INPUT_COLOR_MRT=4]="INPUT_COLOR_MRT",e[e.HETEROGENEOUS_SAMPLE_COUNT=8]="HETEROGENEOUS_SAMPLE_COUNT"}(Xr||(Xr={}));var Kr=function(){this.subpass=Xr.NONE};function Zr(e,t){t.name=e.s(),t.type=e.n(),t.count=e.n()}function Jr(e,t){var r;t.set=e.n(),t.binding=e.n(),t.name=e.s(),r=e.n(),t.members.length=r;for(var i=0;i!==r;++i){var s=new P;Zr(e,s),t.members[i]=s}t.count=e.n()}function $r(e,t){t.binding=e.n(),t.descriptorType=e.n(),t.count=e.n(),t.stageFlags=e.n()}function ei(e,t){var r=e.n();t.bindings.length=r;for(var i=0;i!==r;++i){var s=new A;$r(e,s),t.bindings[i]=s}}var ti=function(){};ti.type=0,ti.isWebGPU=!1;var ri=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=L.UNKNOWN),void 0===r&&(r=1),this.descriptorID=e,this.type=t,this.count=r}return e.prototype.reset=function(e,t,r){this.descriptorID=e,this.type=t,this.count=r},e}(),ii=function(){function e(e,t,r,i,s,n,a){void 0===e&&(e=0),void 0===t&&(t=R.NONE),void 0===r&&(r=0),void 0===i&&(i=b.READ_ONLY),void 0===s&&(s=C.UNKNOWN),void 0===n&&(n=x.FLOAT),void 0===a&&(a=_.UNKNOWN),this.offset=0,this.descriptors=[],this.type=e,this.visibility=t,this.capacity=r,this.accessType=i,this.viewDimension=s,this.sampleType=n,this.format=a}return e.prototype.reset=function(e,t,r,i,s,n,a){this.type=e,this.visibility=t,this.offset=0,this.capacity=r,this.accessType=i,this.viewDimension=s,this.sampleType=n,this.format=a,this.descriptors.length=0},e}(),si=function(){function e(e,t,r,i,s){void 0===e&&(e=4294967295),void 0===t&&(t=0),void 0===r&&(r=[]),void 0===i&&(i=new Map),void 0===s&&(s=new Map),this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.slot=e,this.capacity=t,this.descriptorBlocks=r,this.uniformBlocks=i,this.bindingMap=s}return e.prototype.reset=function(e,t){this.slot=e,this.capacity=t,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks.length=0,this.uniformBlocks.clear(),this.bindingMap.clear()},e}(),ni=function(){function e(e,t,r){void 0===e&&(e=new si),void 0===t&&(t=null),void 0===r&&(r=null),this.descriptorSetLayoutInfo=new B,this.descriptorSetLayoutData=e,this.descriptorSetLayout=t,this.descriptorSet=r}return e.prototype.reset=function(e,t){this.descriptorSetLayoutData.reset(4294967295,0),this.descriptorSetLayoutInfo.bindings.length=0,this.descriptorSetLayout=e,this.descriptorSet=t},e}(),ai=function(){function e(){this.descriptorSets=new Map,this.descriptorGroups=new Map}var t=e.prototype;return t.reset=function(){this.descriptorSets.clear(),this.descriptorGroups.clear()},t.getSets=function(){return ti.isWebGPU?this.descriptorGroups:this.descriptorSets},t.getSet=function(e){return ti.isWebGPU?this.descriptorGroups.get(e):this.descriptorSets.get(e)},e}(),oi=function(){function e(){this.descriptorBindings=new Map}return e.prototype.reset=function(){this.descriptorBindings.clear()},e}(),ui=function(){function e(){this.layoutData=new Map,this.bindingData=new Map}return e.prototype.reset=function(){this.layoutData.clear(),this.bindingData.clear()},e}(),ci=function(){function e(){this.passes=[]}return e.prototype.reset=function(){this.passes.length=0},e}(),hi=function(){function e(){this.techniques=new Map}return e.prototype.reset=function(){this.techniques.clear()},e}(),di=function(){function e(){this.layout=new ai,this.pipelineLayout=null}return e.prototype.reset=function(){this.layout.reset(),this.pipelineLayout=null},e}(),li=function(){function e(){this.descriptorVisibility=new Map}return e.prototype.reset=function(){this.descriptorVisibility.clear()},e}(),pi=function(){function e(){this.rootSignature="",this.shaderPrograms=[],this.shaderIndex=new Map,this.pipelineLayout=null}return e.prototype.reset=function(){this.rootSignature="",this.shaderPrograms.length=0,this.shaderIndex.clear(),this.pipelineLayout=null},e}(),fi=function(e,t){this.o=[],this.i=[],this.t=void 0,this.j=void 0,this.id=e,this.object=t,this.t=e,this.j=t},vi=function(){function e(){this.N=4294967295,this.x=[],this._names=[],this._updateFrequencies=[],this._layouts=[],this.valueNames=[],this.attributeIndex=new Map,this.constantIndex=new Map,this.shaderLayoutIndex=new Map,this.effects=new Map,this.constantMacros=""}var t=e.prototype;return t.edge=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.source=function(e){return e.source},t.target=function(e){return e.target},t.oe=function(e){return new Xt(this.x[e].o.values(),e)},t.od=function(e){return this.x[e].o.length},t.ie=function(e){return new Yt(this.x[e].i.values(),e)},t.id=function(e){return this.x[e].i.length},t.d=function(e){return this.od(e)+this.id(e)},t.adj=function(e){return new Kt(this,this.oe(e))},t.v=function(){return this.x.keys()},t.nv=function(){return this.x.length},t.ne=function(){for(var e,t=0,r=i(this.v());!(e=r()).done;){var s=e.value;t+=this.od(s)}return t},t.clear=function(){this.valueNames.length=0,this.attributeIndex.clear(),this.constantIndex.clear(),this.shaderLayoutIndex.clear(),this.effects.clear(),this.constantMacros="",this._names.length=0,this._updateFrequencies.length=0,this._layouts.length=0,this.x.length=0},t.addVertex=function(e,t,r,i,s,n){void 0===n&&(n=4294967295);var a=new fi(e,t),o=this.x.length;return this.x.push(a),this._names.push(r),this._updateFrequencies.push(i),this._layouts.push(s),4294967295!==n&&this.addEdge(n,o),o},t.addEdge=function(e,t){return this.x[e].o.push(new qt(t)),this.x[t].i.push(new qt(e)),new jt(e,t)},t.vertexName=function(e){return this._names[e]},t.getName=function(e){return this._names[e]},t.getUpdate=function(e){return this._updateFrequencies[e]},t.setUpdate=function(e,t){this._updateFrequencies[e]=t},t.getLayout=function(e){return this._layouts[e]},t.h=function(e,t){return this.x[t].t===e},t.w=function(e){return this.x[e].t},t.object=function(e){return this.x[e].j},t.value=function(e,t){if(this.x[t].t===e)return this.x[t].j;throw Error("value id not match")},t.visitVertex=function(e,t){var r=this.x[t];switch(r.t){case 0:return e.renderStage(r.j);case 1:return e.renderPhase(r.j);default:throw Error("polymorphic type not found")}},t.j=function(e){return this.x[e].j},t.reference=function(e,t){for(var r,s=i(this.x[e].o);!(r=s()).done;)if(t===r.value.target)return!0;return!1},t.parent=function(e){return e.source},t.child=function(e){return e.target},t.children=function(e){return new Xt(this.x[e].o.values(),e)},t.numChildren=function(e){return this.x[e].o.length},t.getParent=function(e){if(4294967295===e)return 4294967295;var t=this.x[e].i;return 0===t.length?4294967295:t[0].target},t.addReference=function(e,t){return this.addEdge(e,t)},t.locateChild=function(e,t){if(4294967295===e){for(var r,s=i(this.x.keys());!(r=s()).done;){var n=r.value;if(0===this.x[n].i.length&&this._names[n]===t)return n}return 4294967295}for(var a,o=i(this.x[e].o);!(a=o()).done;){var u=a.value.target;if(t===this._names[u])return u}return 4294967295},t.locate=function(e){return Jt(this,4294967295,e)},t.locateRelative=function(e,t){return void 0===t&&(t=4294967295),Jt(this,t,e)},t.path=function(e){return Zt(this,e)},e}();function gi(e,t){t.descriptorID=e.n(),t.type=e.n(),t.count=e.n()}function _i(e,t){var r;t.type=e.n(),t.visibility=e.n(),t.offset=e.n(),t.capacity=e.n(),t.accessType=e.n(),t.viewDimension=e.n(),t.sampleType=e.n(),t.format=e.n(),r=e.n(),t.descriptors.length=r;for(var i=0;i!==r;++i){var s=new ri;gi(e,s),t.descriptors[i]=s}}function mi(e,t){t.slot=e.n(),t.capacity=e.n(),t.uniformBlockCapacity=e.n(),t.samplerTextureCapacity=e.n();var r=0;r=e.n(),t.descriptorBlocks.length=r;for(var i=0;i!==r;++i){var s=new ii;_i(e,s),t.descriptorBlocks[i]=s}r=e.n();for(var n=0;n!==r;++n){var a=e.n(),o=new O;Jr(e,o),t.uniformBlocks.set(a,o)}r=e.n();for(var u=0;u!==r;++u){var c=e.n(),h=e.n();t.bindingMap.set(c,h)}}function yi(e,t){mi(e,t.descriptorSetLayoutData),ei(e,t.descriptorSetLayoutInfo)}function Si(e,t){var r=0;r=e.n();for(var i=0;i!==r;++i){var s=e.n(),n=new ni;yi(e,n),t.descriptorSets.set(s,n)}r=e.n();for(var a=0;a!==r;++a){var o=e.n(),u=new ni;yi(e,u),t.descriptorGroups.set(o,u)}}function Ei(e,t){var r;r=e.n();for(var i=0;i!==r;++i){var s=e.n(),n=e.n();t.descriptorBindings.set(s,n)}}function wi(e,t){var r=0;r=e.n();for(var i=0;i!==r;++i){var s=e.n(),n=new si;mi(e,n),t.layoutData.set(s,n)}r=e.n();for(var a=0;a!==r;++a){var o=e.n(),u=new oi;Ei(e,u),t.bindingData.set(o,u)}}function Di(e,t){var r;r=e.n(),t.passes.length=r;for(var i=0;i!==r;++i){var s=new ui;wi(e,s),t.passes[i]=s}}function Ti(e,t){var r;r=e.n();for(var i=0;i!==r;++i){var s=e.s(),n=new ci;Di(e,n),t.techniques.set(s,n)}}function Ii(e,t){Si(e,t.layout)}function Ri(e,t){var r;r=e.n();for(var i=0;i!==r;++i){var s=e.n(),n=e.n();t.descriptorVisibility.set(s,n)}}function Ni(e,t){t.rootSignature=e.s();var r=0;r=e.n(),t.shaderPrograms.length=r;for(var i=0;i!==r;++i){var s=new di;Ii(e,s),t.shaderPrograms[i]=s}r=e.n();for(var n=0;n!==r;++n){var a=e.s(),o=e.n();t.shaderIndex.set(a,o)}}function Ai(e,t){var r=e.n();e.n(),e.n(),e.n();for(var i=0;i!==r;++i){var s=e.n(),n=e.n(),a=e.s(),o=e.n(),u=new ai;switch(Si(e,u),s){case 0:var c=new li;Ri(e,c),t.addVertex(0,c,a,o,u,n);break;case 1:var h=new pi;Ni(e,h),t.addVertex(1,h,a,o,u,n)}}var d=0;d=e.n(),t.valueNames.length=d;for(var l=0;l!==d;++l)t.valueNames[l]=e.s();d=e.n();for(var p=0;p!==d;++p){var f=e.s(),v=e.n();t.attributeIndex.set(f,v)}d=e.n();for(var g=0;g!==d;++g){var _=e.s(),m=e.n();t.constantIndex.set(_,m)}d=e.n();for(var y=0;y!==d;++y){var S=e.s(),E=e.n();t.shaderLayoutIndex.set(S,E)}d=e.n();for(var w=0;w!==d;++w){var D=e.s(),T=new hi;Ti(e,T),t.effects.set(D,T)}}var Pi=function(){function e(e){this.colors=void 0,this.colors=new Array(e)}var t=e.prototype;return t.get=function(e){return this.colors[e]},t.put=function(e,t){this.colors[e]=t},e}();function Li(e){switch(e){case L.BOOL:case L.INT:case L.UINT:case L.FLOAT:return 1;case L.INT2:case L.FLOAT2:case L.UINT2:case L.BOOL2:return 2;case L.FLOAT3:case L.BOOL3:case L.UINT3:case L.INT3:return 3;case L.BOOL4:case L.FLOAT4:case L.UINT4:case L.INT4:case L.MAT2:return 4;case L.MAT2X3:case L.MAT3X2:return 6;case L.MAT2X4:case L.MAT4X2:return 8;case L.MAT3:return 9;case L.MAT3X4:case L.MAT4X3:return 12;case L.MAT4:return 16;default:return 0}}var bi,Ci,xi=new Ie(0,0,0,.5,.5,.5),Bi=new Ie;function Oi(e,t){var r=e.pipelineSceneData,i=r.validPunctualLights;i.length=0;for(var s=Ae.create(0,0,0,1),n=t.scene.spotLights,a=t.node.scene.globals.disableLightmap,o=0;o<n.length;o++){var u=n[o];u.baked&&!a||(Ae.set(s,u.position.x,u.position.y,u.position.z,u.range),Pe.sphereFrustum(s,t.frustum)&&i.push(u))}for(var c=t.scene.sphereLights,h=0;h<c.length;h++){var d=c[h];d.baked&&!a||(Ae.set(s,d.position.x,d.position.y,d.position.z,d.range),Pe.sphereFrustum(s,t.frustum)&&i.push(d))}for(var l=t.scene.pointLights,p=0;p<l.length;p++){var f=l[p];f.baked||(Ae.set(s,f.position.x,f.position.y,f.position.z,f.range),Pe.sphereFrustum(s,t.frustum)&&i.push(f))}for(var v=t.scene.rangedDirLights,g=0;g<v.length;g++){var _=v[g];Ie.transform(Bi,xi,_.node.getWorldMatrix()),Pe.aabbFrustum(Bi,t.frustum)&&i.push(_)}r.validPunctualLights=i}function Gi(e,t){var r=D.CLEAR;return e&I.COLOR||t!==Ct.RENDER_TARGET||(r=e&Ve.VALUE?D.CLEAR:D.LOAD),(e&I.DEPTH_STENCIL)!==I.DEPTH_STENCIL&&t===Ct.DEPTH_STENCIL&&(e&I.DEPTH||(r=D.LOAD),e&I.STENCIL||(r=D.LOAD)),r}function Mi(e,t,r,i,s,n){void 0===i&&(i=null),void 0===s&&(s=0),void 0===n&&(n=void 0),n=n||new G;var a=e?e.viewport:new G(0,0,1,1),o=t,u=r;if(n.x=a.x*o,n.y=a.y*u,n.width=a.width*o,n.height=a.height*u,i)switch(i.type){case Ge.DIRECTIONAL:var c=i;if(c.shadowFixedArea||c.csmLevel===He.LEVEL_1)n.x=0,n.y=0,n.width=o,n.height=u;else{var h=Et.director.root.device.capabilities.screenSpaceSignY;n.x=s%2*.5*o,n.y=h>0?.5*(1-Math.floor(s/2))*u:.5*Math.floor(s/2)*u,n.width=.5*o,n.height=.5*u}break;case Ge.SPOT:n.x=0,n.y=0,n.width=o,n.height=u}return n}function Vi(e,t,r,i,s,n,a){var o=n,u=a,c=Mi(r,n,a,i,s);n=c.width,a=c.height;var h=t.device,d=e;if(!t.containsResource(d)){var l=ot(h)?_.R32F:_.RGBA8;t.addRenderTarget(d,l,o,u,Tt.MANAGED),t.addDepthStencil(d+"Depth",_.DEPTH_STENCIL,o,u,Tt.MANAGED)}t.updateRenderTarget(d,o,u),t.updateDepthStencil(d+"Depth",o,u),s||((Ci=t.addRenderPass(n,a,"default")).name=e,Ci.setViewport(new w(0,0,o,u)),Ci.addRenderTarget(d,D.CLEAR,T.STORE,new N(1,1,1,r.clearColor.w)),Ci.addDepthStencil(d+"Depth",D.CLEAR,T.DISCARD,r.clearDepth,r.clearStencil,I.DEPTH_STENCIL));var p=Ci.addQueue(It.RENDER_OPAQUE,"shadow-caster");p.addScene(r,At.SHADOW_CASTER|At.OPAQUE_OBJECT|At.MASK).useLightFrustum(i,i.type!==Ge.DIRECTIONAL?0:s),p.setViewport(new w(c.x,c.y,c.width,c.height))}function Fi(e,t,r,i,s){var n="Camera"+s,a=r.renderArea(),o=a.x,u=a.y,c=r.camera,h="reflectionProbePassColor"+n,d="reflectionProbePassDS"+n;t.containsResource(h)||(t.addRenderWindow(h,_.RGBA8,o,u,i),t.addDepthStencil(d,_.DEPTH_STENCIL,o,u,Tt.EXTERNAL)),t.updateRenderWindow(h,i),t.updateDepthStencil(d,o,u);var l=t.addRenderPass(o,u,"default");l.name="ReflectionProbePass"+s,l.setViewport(new w(0,0,o,u)),l.addRenderTarget(h,Gi(c.clearFlag,Ct.RENDER_TARGET),T.STORE,new N(c.clearColor.x,c.clearColor.y,c.clearColor.z,c.clearColor.w)),l.addDepthStencil(d,Gi(c.clearFlag,Ct.DEPTH_STENCIL),T.STORE,c.clearDepth,c.clearStencil,c.clearFlag);var p=l.addQueue(It.RENDER_OPAQUE,"reflect-map"),f=new Bt;f.probe=r,p.addSceneOfCamera(e,f,At.REFLECTION_PROBE|At.OPAQUE_OBJECT),ki(p,c,t)}!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA",e[e.FXAAHQ=2]="FXAAHQ"}(bi||(bi={}));var Ui=new(function(){function e(){this.shadowEnabled=!1,this.mainLightShadowNames=[],this.spotLightShadowNames=[],this.validLights=[]}return e.prototype.reset=function(){this.shadowEnabled=!1,this.mainLightShadowNames.length=0,this.spotLightShadowNames.length=0,this.validLights.length=0},e}());function ki(e,t,r){var i=Et.director.root.pipeline,s=r.pipelineSceneData,n=s.skybox;e.setMat4("cc_matView",t.matView),e.setMat4("cc_matViewInv",t.node.worldMatrix),e.setMat4("cc_matProj",t.matProj),e.setMat4("cc_matProjInv",t.matProjInv),e.setMat4("cc_matViewProj",t.matViewProj),e.setMat4("cc_matViewProjInv",t.matViewProjInv),e.setVec4("cc_cameraPos",new Re(t.position.x,t.position.y,t.position.z,i.getCombineSignY())),e.setVec4("cc_surfaceTransform",new Re(t.surfaceTransform,0,Math.cos(Ne(n.getRotationAngle())),Math.sin(Ne(n.getRotationAngle())))),e.setVec4("cc_screenScale",new Re(s.shadingScale,s.shadingScale,1/s.shadingScale,1/s.shadingScale)),e.setVec4("cc_exposure",new Re(t.exposure,1/t.exposure,s.isHDR?1:0,1/Me.standardExposureValue))}function Hi(e,t,r){r instanceof M?e.bindBuffer(t,r):r instanceof V?e.bindTexture(t,r):r instanceof F&&e.bindSampler(t,r)}function Qi(e,t,r){Hi(e,t,r)}function zi(e,t){for(var r,s=i(t.descriptorSetLayoutData.descriptorBlocks);!(r=s()).done;)for(var n=r.value,a=0;a!==n.descriptors.length;++a)if(e===n.descriptors[a].descriptorID)return n.offset+a;return-1}var Wi=function(){function e(e,t){void 0===t&&(t=2),this.buffers=[],this.currBuffIdx=0,this.device=void 0,this.currUniform=void 0,this._root=void 0;var r=(this._root=Et.director.root).device;this.device=r,this.currUniform=new Float32Array(e/4);for(var i=0;i<t;i++){var s=new U(k.UNIFORM|k.TRANSFER_DST,H.HOST|H.DEVICE,e,e);this.buffers.push(this.device.createBuffer(s))}}var t=e.prototype;return t.getCurrentBuffer=function(){var e=Et.director;return this.currBuffIdx=e.getTotalFrames()%this.buffers.length,this.buffers[this.currBuffIdx]},t.updateData=function(e){this.currUniform.set(e)},t.updateBuffer=function(e,t){var r=t.descriptorSet,i=this.getCurrentBuffer();i.update(this.currUniform),Qi(r,e,i)},e}(),ji=new Map,qi=new Map,Xi=new Map;function Yi(e){var t=Xi.get(e);if(t)return t;var r=Et.director.root.pipeline,i=r.layoutGraph.locateChild(r.layoutGraph.N,e),s=r.layoutGraph.getLayout(i).getSet(Dt.PER_PASS);return Xi.set(e,s),s}function Ki(e,t,r,i){void 0===i&&(i="default"),os(i,t,r,e)}function Zi(e,t){var r=Et.director.root.pipeline.layoutGraph,i=r.locateChild(4294967295,t),s=r.getLayout(i).getSet(Dt.PER_PASS).descriptorSetLayoutData,n=r.attributeIndex.get(e);return s.uniformBlocks.get(n)}function Ji(e,t,r){var s=Zi(t,r);if(!s)return-1;for(var n,a=0,o=i(s.members);!(n=o()).done;){var u=n.value,c=Li(u.type);if(u.name===e)return a;a+=c*u.count}return-1}var $i=new Map,es=function(){this.offset=-1,this.buffer=[],this.blockId=-1},ts=new Map;function rs(e,t,r){var i=!1;if(r<0||r>e.length)return i;for(var s=Math.min(t.length,e.length-r),n=0;n<s;n++)e[r+n]!==t[n]&&(e[r+n]=t[n],i=!0);return i}function is(e,t){var r=$i.get(e);if(r)return r;r=[],Et.director.root.pipeline.layoutGraph;var s=0,n=Zi(e,t);if(!n)return null;for(var a,o=i(n.members);!(a=o()).done;){var u=a.value;s+=Li(u.type)*u.count}return r.length=s,r.fill(0),$i.set(e,r),r}function ss(e,t){var r=ji.get(e);r||(ji.set(e,new Wi(4*t.length,2)),r=ji.get(e)),r.updateData(t)}function ns(e,t,r,i,s){var n=e.blockId,a=e.buffer,o=rs(a,t,e.offset),u=zi(n,r),c=r.descriptorSet;if(o||!c.getBuffer(u)&&-1!==u){var h=""+n+u+s+i;qi.set(h,u),ss(h,a)}}function as(e,t,r,i,s){var n=zi(e,s);if(-1!==n){var a=""+e+n+r+t;qi.set(a,n),ss(a,i)}}function os(e,t,r,s){var n=s.constants,a=s.samplers,o=s.textures,u=s.buffers,c=Et.director.root.pipeline.layoutGraph,h=Yi(e);qi.clear();for(var d,l=function(){var s=d.value,n=s[0],a=s[1],o=ts.get(n);if(o)ns(o,a,h,t,r);else for(var u,l=Array.from(c.constantIndex).find((function(e){return e[0],e[1]===n}))[0],p=i(c.attributeIndex);!(u=p()).done;){var f=u.value,v=f[0],g=f[1],_=is(v,e);if(_){var m=Ji(l,v,e);-1!==m?(ts.set(n,new es),(o=ts.get(n)).buffer=_,o.blockId=g,o.offset=m,ns(o,a,h,t,r)):as(g,t,r,_,h)}}},p=i(n);!(d=p()).done;)l();for(var f,v=h.descriptorSet,g=i(o);!(f=g()).done;){var _=f.value,m=_[0],y=_[1],S=zi(m,h);if(-1!==S){var E=v.getTexture(S);y===E&&(E.gpuTexture||E.gpuTextureView&&E.gpuTextureView.gpuTexture)||Qi(v,S,y)}}for(var w,D=i(a);!(w=D()).done;){var T=w.value,I=T[0],R=T[1],N=zi(I,h);-1!==N&&v.getSampler(N)!==R&&Qi(v,N,R)}for(var A,P=i(qi);!(A=P()).done;){var L=A.value,b=L[0],C=L[1];ji.get(b).updateBuffer(C,h)}for(var x,B=i(u);!(x=B()).done;){var O=x.value,G=O[0],M=O[1],V=zi(G,h);-1!==V&&(v.getBuffer(V)||Qi(v,V,M))}}function us(e){return e+"-"}function cs(e){for(var t=0,r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return t}function hs(e){return!!e}function ds(e,t,r,i,s,n){var a=new Float32Array(4),o=0,u=0,c=0,h=0;if(e&&e.type===Ge.SPHERE){var d=e;a[0]=d.position.x,a[1]=d.position.y,a[2]=d.position.z,a[3]=Ge.SPHERE,o=d.size,u=d.range,c=d.luminanceHDR,h=d.luminanceLDR}else if(e&&e.type===Ge.SPOT){var l=e;a[0]=l.position.x,a[1]=l.position.y,a[2]=l.position.z,a[3]=Ge.SPOT,o=l.size,u=l.range,c=l.luminanceHDR,h=l.luminanceLDR}else if(e&&e.type===Ge.POINT){var p=e;a[0]=p.position.x,a[1]=p.position.y,a[2]=p.position.z,a[3]=Ge.POINT,o=0,u=p.range,c=p.luminanceHDR,h=p.luminanceLDR}else if(e&&e.type===Ge.RANGED_DIRECTIONAL){var f=e;a[0]=f.position.x,a[1]=f.position.y,a[2]=f.position.z,a[3]=Ge.RANGED_DIRECTIONAL,o=0,u=0,c=f.illuminanceHDR,h=f.illuminanceLDR}var v=n+ut.LIGHT_POS_OFFSET;s.set(a,v),v=n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET,a.set([o,u,0,0]),s.set(a,v),v=n+ut.LIGHT_COLOR_OFFSET;var g=e?e.color:new N;if(e&&e.useColorTemperature){var _=e.colorTemperatureRGB;s[v++]=g.x*_.x,s[v++]=g.y*_.y,s[v++]=g.z*_.z}else s[v++]=g.x,s[v++]=g.y,s[v++]=g.z;switch(s[v]=t?c*r*1e4:h,e?e.type:Ge.UNKNOWN){case Ge.SPHERE:s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=0,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;break;case Ge.SPOT:var m=e;s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=m.spotAngle,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=i&&i.enabled&&m.shadowEnabled&&i.type===Qe.ShadowMap?1:0,v=n+ut.LIGHT_DIR_OFFSET;var y=m.direction;s[v++]=y.x,s[v++]=y.y,s[v]=y.z,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+0]=0,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+1]=0,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+2]=0,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+3]=m.angleAttenuationStrength;break;case Ge.POINT:s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=0,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;break;case Ge.RANGED_DIRECTIONAL:var S=e,E=S.right;s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+0]=E.x,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+1]=E.y,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=E.z,s[n+ut.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;var w=S.direction;s[n+ut.LIGHT_DIR_OFFSET+0]=w.x,s[n+ut.LIGHT_DIR_OFFSET+1]=w.y,s[n+ut.LIGHT_DIR_OFFSET+2]=w.z,s[n+ut.LIGHT_DIR_OFFSET+3]=0;var D=S.scale;s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+0]=.5*D.x,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+1]=.5*D.y,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+2]=.5*D.z,s[n+ut.LIGHT_BOUNDING_SIZE_VS_OFFSET+3]=0}}function ls(e){for(var t,r="",s=i(e.rasterViews);!(t=s()).done;){var n=t.value,a=n[0],o=n[1];r+=us(a),r+=us(o.slotName),r+=us(o.accessType),r+=us(o.attachmentType),r+=us(o.loadOp),r+=us(o.storeOp),r+=us(o.clearFlags),r+=us(o.clearColor.x),r+=us(o.clearColor.y),r+=us(o.clearColor.z),r+=us(o.clearColor.w),r+=us(o.slotID),r+=us(o.shaderStageFlags)}for(var u,c=i(e.computeViews);!(u=c()).done;){var h=u.value,d=h[0],l=h[1];r+=us(d);for(var p,f=i(l);!(p=f()).done;){var v=p.value;r+=us(v.name),r+=us(v.accessType),r+=us(v.clearFlags),r+=us(v.clearValueType),r+=us(v.clearValue.x),r+=us(v.clearValue.y),r+=us(v.clearValue.z),r+=us(v.clearValue.w),r+=us(v.shaderStageFlags)}}r+=us(e.showStatistics?1:0),e.hashValue=cs(r)}var ps=new Re,fs=new Le,vs=new N,gs=new be,_s=new be;function ms(e,t){var r=t.skybox,i=Et.director.root,s=i.pipeline;if(r.reflectionMap){var n=r.reflectionMap.getGFXTexture(),a=i.device.getSampler(r.reflectionMap.getSamplerInfo());e.setTexture("cc_environment",n),e.setSampler("cc_environment",a)}else{var o=r.envmap?r.envmap:ze.get("default-cube-texture");if(o){var u=o.getGFXTexture(),c=i.device.getSampler(o.getSamplerInfo());e.setTexture("cc_environment",u),e.setSampler("cc_environment",c)}}var h=r.diffuseMap?r.diffuseMap:ze.get("default-cube-texture");if(h){var d=h.getGFXTexture(),l=i.device.getSampler(h.getSamplerInfo());e.setTexture("cc_diffuseMap",d),e.setSampler("cc_diffuseMap",l)}e.hasSampler("cc_shadowMap")||e.setSampler("cc_shadowMap",s.defaultSampler),e.hasTexture("cc_shadowMap")||e.setTexture("cc_shadowMap",s.defaultShadowTexture),e.hasSampler("cc_spotShadowMap")||e.setSampler("cc_spotShadowMap",s.defaultSampler),e.hasTexture("cc_spotShadowMap")||e.setTexture("cc_spotShadowMap",s.defaultShadowTexture)}function ys(e,t,r,i){var s,n=Et.director.root.pipeline,a=r.shadows,o=r.skybox,u=r.shadingScale;t&&(e.setMat4("cc_matView",t.matView),e.setMat4("cc_matViewInv",t.node.worldMatrix),e.setMat4("cc_matProj",t.matProj),e.setMat4("cc_matProjInv",t.matProjInv),e.setMat4("cc_matViewProj",t.matViewProj),e.setMat4("cc_matViewProjInv",t.matViewProjInv),ps.set(t.surfaceTransform,t.cameraUsage,Math.cos(Ne(o.getRotationAngle())),Math.sin(Ne(o.getRotationAngle()))),e.setVec4("cc_surfaceTransform",ps),ps.set(t.exposure,1/t.exposure,r.isHDR?1:0,1/Me.standardExposureValue),e.setVec4("cc_exposure",ps)),t?ps.set(t.position.x,t.position.y,t.position.z,n.getCombineSignY()):ps.set(0,0,0,n.getCombineSignY()),e.setVec4("cc_cameraPos",ps),ps.set(r.shadingScale,r.shadingScale,1/r.shadingScale,1/r.shadingScale),e.setVec4("cc_screenScale",ps);var c=i&&i.mainLight;if(c){var h=c.shadowEnabled&&a.type===Qe.ShadowMap?1:0;ps.set(c.direction.x,c.direction.y,c.direction.z,h),e.setVec4("cc_mainLitDir",ps);var d=c.color.x,l=c.color.y,p=c.color.z;c.useColorTemperature&&(d*=c.colorTemperatureRGB.x,l*=c.colorTemperatureRGB.y,p*=c.colorTemperatureRGB.z);var f=c.illuminance;r.isHDR&&t&&(f*=t.exposure),ps.set(d,l,p,f),e.setVec4("cc_mainLitColor",ps)}else ps.set(0,0,1,0),e.setVec4("cc_mainLitDir",ps),ps.set(0,0,0,0),e.setVec4("cc_mainLitColor",ps);var v=r.ambient,g=v.skyColor;r.isHDR?g.w=v.skyIllum*(t?t.exposure:1):g.w=v.skyIllum,ps.set(g.x,g.y,g.z,g.w),e.setVec4("cc_ambientSky",ps),ps.set(v.groundAlbedo.x,v.groundAlbedo.y,v.groundAlbedo.z,o.envmap?null==(s=o.envmap)?void 0:s.mipmapLevel:1),e.setVec4("cc_ambientGround",ps);var _=r.fog,m=_.colorArray;ps.set(m.x,m.y,m.z,m.z),e.setVec4("cc_fogColor",ps),ps.set(_.fogStart,_.fogEnd,_.fogDensity,0),e.setVec4("cc_fogBase",ps),ps.set(_.fogTop,_.fogRange,_.fogAtten,0),e.setVec4("cc_fogAdd",ps),t&&(ps.set(t.nearClip,t.farClip,t.getClipSpaceMinz(),0),e.setVec4("cc_nearFar",ps),ps.set(t.viewport.x,t.viewport.y,u*t.window.width*t.viewport.z,u*t.window.height*t.viewport.w),e.setVec4("cc_viewPort",ps))}var Ss=function(){function e(e,t,r,i,s,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===n&&(n=0),this.subModel=void 0,this.priority=void 0,this.hash=void 0,this.depth=void 0,this.shaderID=void 0,this.passIndex=void 0,this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=n}return e.prototype.update=function(e,t,r,i,s,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===n&&(n=0),this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=n},e}(),Es=new r((function(){return new Ss}),8),ws="CC_USE_RGBE_OUTPUT";function Ds(e,t){for(var r=e.passes,i=0;i<r.length;i++)if(r[i].phaseID===t)return i;return-1}var Ts=function(){function e(){var e;this.probeMap=new Array,this.defaultId=(e=Et.rendering).getPhaseID(e.getPassID("default"),"default")}var t=e.prototype;return t.clear=function(){this.probeMap.length=0},t.applyMacro=function(){for(var e,t=i(this.probeMap);!(e=t()).done;){var r=e.value,s=[{name:ws,value:!0}];r.patches&&(s=s.concat(r.patches)),r.onMacroPatchesStateChanged(s)}},t.removeMacro=function(){for(var e,t=i(this.probeMap);!(e=t()).done;){var r=e.value;if(r.patches){var s=r.patches.filter((function(e){return e.name!==ws}));0===s.length?r.onMacroPatchesStateChanged(null):r.onMacroPatchesStateChanged(s)}}},t.addToProbeQueue=function(e,t){for(var r=e.subModels,i=0;i<r.length;i++){var s=r[i];if(!s.passes[0].blendState.targets[0].blend){var n=Ds(s,t),a=!0;n<0&&(n=Ds(s,t=this.defaultId),a=!1),n<0||a||this.probeMap.push(s)}}},e}();function Is(e,t,r,i){var s=Et.director.root.pipeline,n=s.device,a=s.pipelineSceneData,o=a.shadows;if(o.type!==Qe.Planar){var u=a.csmLayers,c=ot(n)?0:1,h=s.device.capabilities;switch(o.enabled&&o.type===Qe.ShadowMap&&r&&r.node&&r.type===Ge.DIRECTIONAL&&u.update(a,t),r.type){case Ge.DIRECTIONAL:var d=r;if(o.enabled&&d&&d.shadowEnabled&&o.type===Qe.ShadowMap){var l,p,f,v=.1,g=0,_=0;if(d.shadowFixedArea||d.csmLevel===He.LEVEL_1)l=u.specialLayer.matShadowView,p=u.specialLayer.matShadowProj,f=u.specialLayer.matShadowViewProj,d.shadowFixedArea?(v=d.shadowNear,g=d.shadowFar,_=0):(v=.1,g=u.specialLayer.shadowCameraFar,_=1),ps.set(Ge.DIRECTIONAL,c,d.shadowNormalBias,0),e.setVec4("cc_shadowLPNNInfo",ps);else{var m=u.layers[i];l=m.matShadowView,p=m.matShadowProj,f=m.matShadowViewProj,v=m.splitCameraNear,g=m.splitCameraFar,_=d.csmLevel}e.setMat4("cc_matLightView",l),ps.set(p.m10,p.m14,p.m11,p.m15),e.setVec4("cc_shadowProjDepthInfo",ps),ps.set(p.m00,p.m05,1/p.m00,1/p.m05),e.setVec4("cc_shadowProjInfo",ps),e.setMat4("cc_matLightViewProj",f),ps.set(v,g,0,1-d.shadowSaturation),e.setVec4("cc_shadowNFLSInfo",ps),ps.set(Ge.DIRECTIONAL,c,d.shadowNormalBias,_),e.setVec4("cc_shadowLPNNInfo",ps),ps.set(o.size.x,o.size.y,d.shadowPcf,d.shadowBias),e.setVec4("cc_shadowWHPBInfo",ps)}break;case Ge.SPOT:var y=r;if(o.enabled&&y&&y.shadowEnabled){be.invert(gs,y.node.getWorldMatrix()),e.setMat4("cc_matLightView",gs),be.perspective(_s,y.angle,1,.001,y.range,!0,h.clipSpaceMinZ,h.clipSpaceSignY,0);var S=_s.clone().invert(),E=_s.clone();be.multiply(gs,_s,gs),e.setMat4("cc_matLightViewProj",gs),ps.set(.01,r.range,0,0),e.setVec4("cc_shadowNFLSInfo",ps),ps.set(o.size.x,o.size.y,y.shadowPcf,y.shadowBias),e.setVec4("cc_shadowWHPBInfo",ps),ps.set(Ge.SPOT,c,y.shadowNormalBias,0),e.setVec4("cc_shadowLPNNInfo",ps),ps.set(E.m10,E.m14,E.m11,E.m15),e.setVec4("cc_shadowProjDepthInfo",ps),ps.set(S.m10,S.m14,S.m11,S.m15),e.setVec4("cc_shadowInvProjDepthInfo",ps),ps.set(E.m00,E.m05,1/E.m00,1/E.m05),e.setVec4("cc_shadowProjInfo",ps)}break;case Ge.SPHERE:ps.set(o.size.x,o.size.y,1,0),e.setVec4("cc_shadowWHPBInfo",ps),ps.set(Ge.SPHERE,c,0,0),e.setVec4("cc_shadowLPNNInfo",ps);break;case Ge.POINT:ps.set(o.size.x,o.size.y,1,0),e.setVec4("cc_shadowWHPBInfo",ps),ps.set(Ge.POINT,c,0,0),e.setVec4("cc_shadowLPNNInfo",ps)}vs.set(o.shadowColor.x,o.shadowColor.y,o.shadowColor.z,o.shadowColor.w),e.setColor("cc_shadowColor",vs)}}function Rs(e,t){var r=e.size.x;switch(t.shadowPcf){case We.HARD:return 0;case We.SOFT:return 1/(.5*r);case We.SOFT_2X:return 2/(.5*r);case We.SOFT_4X:return 3/(.5*r)}return 0}function Ns(e,t){var r=Et.director,i=r.root.pipeline,s=i.device,n=r.getScene(),a=t&&t.scene?t.scene.mainLight:n?n.renderScene.mainLight:null,o=i.pipelineSceneData,u=o.shadows,c=o.csmLayers,h=o.csmSupported,d=ot(s)?0:1;if(a&&u.enabled){if(u.type===Qe.ShadowMap){if(a.shadowEnabled){if(a.shadowFixedArea||a.csmLevel===He.LEVEL_1||!h){var l=c.specialLayer.matShadowView,p=c.specialLayer.matShadowProj,f=c.specialLayer.matShadowViewProj,v=a.shadowNear,g=a.shadowFar;e.setMat4("cc_matLightView",l),ps.set(p.m10,p.m14,p.m11,p.m15),e.setVec4("cc_shadowProjDepthInfo",ps),ps.set(p.m00,p.m05,1/p.m00,1/p.m05),e.setVec4("cc_shadowProjInfo",ps),e.setMat4("cc_matLightViewProj",f),ps.set(v,g,0,1-a.shadowSaturation),e.setVec4("cc_shadowNFLSInfo",ps),ps.set(Ge.DIRECTIONAL,d,a.shadowNormalBias,0),e.setVec4("cc_shadowLPNNInfo",ps)}else{for(var _=Rs(u,a),m=0;m<a.csmLevel;m++){var y=c.layers[m],S=y.matShadowView;ps.set(S.m00,S.m04,S.m08,_),e.setVec4("cc_csmViewDir0",ps,m),ps.set(S.m01,S.m05,S.m09,y.splitCameraNear),e.setVec4("cc_csmViewDir1",ps,m),ps.set(S.m02,S.m06,S.m10,y.splitCameraFar),e.setVec4("cc_csmViewDir2",ps,m);var E=y.csmAtlas;e.setVec4("cc_csmAtlas",E,m);var w=y.matShadowViewProj;e.setMat4("cc_matCSMViewProj",w,m);var D=y.matShadowProj;ps.set(D.m10,D.m14,D.m11,D.m15),e.setVec4("cc_csmProjDepthInfo",ps,m),ps.set(D.m00,D.m05,1/D.m00,1/D.m05),e.setVec4("cc_csmProjInfo",ps,m)}ps.set(a.csmTransitionRange,0,0,0),e.setVec4("cc_csmSplitsInfo",ps),ps.set(.1,a.shadowDistance,0,1-a.shadowSaturation),e.setVec4("cc_shadowNFLSInfo",ps),ps.set(Ge.DIRECTIONAL,d,a.shadowNormalBias,a.csmLevel),e.setVec4("cc_shadowLPNNInfo",ps)}ps.set(u.size.x,u.size.y,a.shadowPcf,a.shadowBias),e.setVec4("cc_shadowWHPBInfo",ps)}}else Le.normalize(fs,u.normal),ps.set(fs.x,fs.y,fs.z,-u.distance),e.setVec4("cc_planarNDInfo",ps),ps.set(0,0,0,u.planeBias),e.setVec4("cc_shadowWHPBInfo",ps);e.setMathColor("cc_shadowColor",u.shadowColor)}}var As=function(){function e(e,t){this._data=void 0,this._lg=void 0,this._vertID=-1,this._currBlock=void 0,this._currStage="",this._currFrequency=Dt.PER_PASS,this._currCount=void 0,this._currConstant=[],this._data=e,this._lg=t}var t=e.prototype;return t.setMat4=function(t,r,i){void 0===i&&(i=0),e.setMat4(this._lg,this._data,t,r,i)},e.setMat4=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);be.toArray(a.dataArr,s,16*n),r.constants.set(a.constantID,a.dataArr)},t.setQuaternion=function(t,r,i){void 0===i&&(i=0),e.setQuaternion(this._lg,this._data,t,r,i)},e.setQuaternion=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);Ce.toArray(a.dataArr,s,4*n),r.constants.set(a.constantID,a.dataArr)},t.setColor=function(t,r,i){void 0===i&&(i=0),e.setColor(this._lg,this._data,t,r,i)},e.setColor=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i),o=4*n;a.dataArr[0+o]=s.x,a.dataArr[1+o]=s.y,a.dataArr[2+o]=s.z,a.dataArr[3+o]=s.w,r.constants.set(a.constantID,a.dataArr)},t.setMathColor=function(t,r,i){void 0===i&&(i=0),e.setMathColor(this._lg,this._data,t,r,i)},e.setMathColor=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);xe.toArray(a.dataArr,s,4*n),r.constants.set(a.constantID,a.dataArr)},e.getConstantInfo=function(e,t,r){var i=e.constantIndex.get(r);if(void 0===i)throw new Error("Constant with name "+r+" not found.");return{constantID:i,dataArr:t.constants.get(i)||[]}},t.setVec4=function(t,r,i){void 0===i&&(i=0),e.setVec4(this._lg,this._data,t,r,i)},e.setVec4=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);Re.toArray(a.dataArr,s,4*n),r.constants.set(a.constantID,a.dataArr)},t.setVec2=function(t,r,i){void 0===i&&(i=0),e.setVec2(this._lg,this._data,t,r,i)},e.setVec2=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);Be.toArray(a.dataArr,s,2*n),r.constants.set(a.constantID,a.dataArr)},t.setFloat=function(t,r,i){void 0===i&&(i=0),e.setFloat(this._lg,this._data,t,r,i)},e.setFloat=function(t,r,i,s,n){void 0===n&&(n=0);var a=e.getConstantInfo(t,r,i);a.dataArr[0+n]=s,r.constants.set(a.constantID,a.dataArr)},t.setArrayBuffer=function(t,r){e.setArrayBuffer(this._lg,this._data,t,r)},e.setArrayBuffer=function(){throw new Error("Method not implemented.")},t.setBuffer=function(t,r){e.setBuffer(this._lg,this._data,t,r)},e.setBuffer=function(e,t,r,i){var s=e.attributeIndex.get(r);t.buffers.set(s,i)},t.setTexture=function(t,r){e.setTexture(this._lg,this._data,t,r)},e.setTexture=function(e,t,r,i){var s=e.attributeIndex.get(r);t.textures.set(s,i)},t.setReadWriteBuffer=function(t,r){e.setReadWriteBuffer(this._lg,this._data,t,r)},e.setReadWriteBuffer=function(e,t,r,i){var s=e.attributeIndex.get(r);t.buffers.set(s,i)},t.setReadWriteTexture=function(t,r){e.setReadWriteTexture(this._lg,this._data,t,r)},e.setReadWriteTexture=function(e,t,r,i){var s=e.attributeIndex.get(r);t.textures.set(s,i)},t.setSampler=function(t,r){e.setSampler(this._lg,this._data,t,r)},e.setSampler=function(e,t,r,i){var s=e.attributeIndex.get(r);t.samplers.set(s,i)},t.getParentLayout=function(){var e=Et.director.root.pipeline,t=e.renderGraph.getParent(this._vertID);return e.renderGraph.getLayout(t)},t.getCurrentLayout=function(){return Et.director.root.pipeline.renderGraph.getLayout(this._vertID)},t.setBuiltinCameraConstants=function(e){var t=Et.director.root.pipeline;this.getParentLayout(),ys(this,e,t.pipelineSceneData,e.scene)},t.setBuiltinDirectionalLightFrustumConstants=function(e,t,r){void 0===r&&(r=0),Is(this,e,t,r)},t.setBuiltinSpotLightFrustumConstants=function(e){Is(this,null,e,0)},t.setBuiltinDirectionalLightConstants=function(){Ns(this,null,this.getParentLayout())},t.setBuiltinSphereLightConstants=function(e,t){var r=Et.director.root.pipeline.pipelineSceneData;ps.set(e.position.x,e.position.y,e.position.z,Ge.SPHERE),this.setVec4("cc_lightPos",ps),ps.set(e.size,e.range,0,0),this.setVec4("cc_lightSizeRangeAngle",ps);var i=r.isHDR;if(ps.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var s=e.finalColor;ps.x=s.x,ps.y=s.y,ps.z=s.z}ps.w=i?e.luminance*t.exposure*1e4:e.luminance,this.setVec4("cc_lightColor",ps)},t.setBuiltinSpotLightConstants=function(e,t){var r=Et.director.root.pipeline.pipelineSceneData,i=r.shadows;ps.set(e.position.x,e.position.y,e.position.z,Ge.SPOT),this.setVec4("cc_lightPos",ps),ps.set(e.size,e.range,e.spotAngle,i.enabled&&e.shadowEnabled&&i.type===Qe.ShadowMap?1:0),this.setVec4("cc_lightSizeRangeAngle",ps),ps.set(e.direction.x,e.direction.y,e.direction.z,0),this.setVec4("cc_lightDir",ps);var s=r.isHDR;if(ps.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var n=e.finalColor;ps.x=n.x,ps.y=n.y,ps.z=n.z}ps.w=s?e.luminance*t.exposure*1e4:e.luminance,this.setVec4("cc_lightColor",ps),ps.set(0,0,0,e.angleAttenuationStrength),this.setVec4("cc_lightBoundingSizeVS",ps)},t.setBuiltinPointLightConstants=function(e,t){var r=Et.director.root.pipeline.pipelineSceneData;ps.set(e.position.x,e.position.y,e.position.z,Ge.POINT),this.setVec4("cc_lightPos",ps),ps.set(0,e.range,0,0),this.setVec4("cc_lightSizeRangeAngle",ps);var i=r.isHDR;if(e.useColorTemperature){var s=e.finalColor;ps.x=s.x,ps.y=s.y,ps.z=s.z}ps.w=i?e.luminance*t.exposure*1e4:e.luminance,ps.set(e.color.x,e.color.y,e.color.z,0),this.setVec4("cc_lightColor",ps)},t.setBuiltinRangedDirectionalLightConstants=function(e,t){var r=Et.director.root.pipeline.pipelineSceneData;ps.set(e.position.x,e.position.y,e.position.z,Ge.RANGED_DIRECTIONAL),this.setVec4("cc_lightPos",ps),ps.set(e.right.x,e.right.y,e.right.z,0),this.setVec4("cc_lightSizeRangeAngle",ps),ps.set(e.direction.x,e.direction.y,e.direction.z,0),this.setVec4("cc_lightDir",ps);var i=e.scale;ps.set(.5*i.x,.5*i.y,.5*i.z,0),this.setVec4("cc_lightBoundingSizeVS",ps);var s=r.isHDR;if(ps.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var n=e.finalColor;ps.x=n.x,ps.y=n.y,ps.z=n.z}ps.w=s?e.illuminance*t.exposure:e.illuminance,this.setVec4("cc_lightColor",ps)},t.hasSampler=function(e){var t=this._lg.constantIndex.get(e);return void 0!==t&&this._data.samplers.has(t)},t.hasTexture=function(e){var t=this._lg.constantIndex.get(e);return void 0!==t&&this._data.textures.has(t)},t.setCustomBehavior=function(){throw new Error("Method not implemented.")},s(e,[{key:"name",get:function(){return""},set:function(){}}]),e}(),Ps=function(){function e(){this.instances=new Array}var t=e.prototype;return t.empty=function(){return 0===this.instances.length},t.clear=function(){this.instances.length=0},t.add=function(e,t,r,i){var s=e.subModels[r],n=s.passes[i].priority,a=s.priority,o=s.shaders[i].typedID,u=n<<16|a<<8|i,c=e.priority,h=Es.add();h.update(s,c,u,t,o,i),this.instances.push(h)},t.sortOpaqueOrCutout=function(){this.instances.sort((function(e,t){return e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?e.depth-t.depth:e.shaderID-t.shaderID}))},t.sortTransparent=function(){this.instances.sort((function(e,t){return e.priority!==t.priority?e.priority-t.priority:e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?t.depth-e.depth:e.shaderID-t.shaderID}))},t.recordCommandBuffer=function(e,t,r,s,n,a){void 0===s&&(s=null),void 0===n&&(n=0),void 0===a&&(a=null);for(var o,u=i(this.instances);!(o=u()).done;){var c=o.value,h=c.subModel,d=c.passIndex,l=h.inputAssembler,p=h.passes[d],f=h.shaders[d],v=ct.getOrCreatePipelineState(e,p,f,t,l);r.bindPipelineState(v),r.bindDescriptorSet(ht.MATERIAL,p.descriptorSet),s&&r.bindDescriptorSet(ht.GLOBAL,s,[n]),a?r.bindDescriptorSet(ht.LOCAL,h.descriptorSet,a):r.bindDescriptorSet(ht.LOCAL,h.descriptorSet),r.bindInputAssembler(l),r.draw(l)}},e}(),Ls=function(){function e(){this.passInstances=new Map,this.instanceBuffers=new Array}var t=e.prototype;return t.empty=function(){return 0===this.passInstances.size},t.add=function(e,t,r){if(void 0===this.passInstances.get(e)){var i=this.passInstances.size;i>=this.instanceBuffers.length&&this.instanceBuffers.push(new je(e)),this.passInstances.set(e,i);var s=this.instanceBuffers[i];s.pass=e,s.instances}this.instanceBuffers[this.passInstances.get(e)].merge(t,r)},t.clear=function(){this.passInstances.clear(),this.instanceBuffers.forEach((function(e){e.clear()}))},t.sort=function(){this.instanceBuffers=this.instanceBuffers.sort(qe)},t.uploadBuffers=function(e){for(var t,r=i(this.passInstances.entries());!(t=r()).done;){var s=t.value;s[0];var n=s[1],a=this.instanceBuffers[n];a.hasPendingModels&&a.uploadBuffers(e)}},t.recordCommandBuffer=function(e,t,r,s,n){void 0===r&&(r=null),void 0===s&&(s=0),void 0===n&&(n=null);for(var a,o=this.instanceBuffers,u=i(o);!(a=u()).done;){var c=a.value;if(c.hasPendingModels){var h=c.instances,d=c.pass;t.bindDescriptorSet(ht.MATERIAL,d.descriptorSet);for(var l,p=null,f=i(h);!(l=f()).done;){var g=l.value;if(g.count){var _=ct.getOrCreatePipelineState(v.gfxDevice,d,g.shader,e,g.ia);p!==_&&(t.bindPipelineState(_),p=_),r&&t.bindDescriptorSet(ht.GLOBAL,r,[s]),n?t.bindDescriptorSet(ht.LOCAL,g.descriptorSet,n):t.bindDescriptorSet(ht.LOCAL,g.descriptorSet,c.dynamicOffsets),t.bindInputAssembler(g.ia),t.draw(g.ia)}}}}},e}(),bs=function(){function e(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),this.frustumCulledResultID=void 0,this.lightBoundsCulledResultID=void 0,this.renderQueueTarget=void 0,this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r}return e.prototype.update=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r},e}();function Cs(e,t,r,i,s,n){var a;if(s&&n&&(a=ct.getOrCreatePipelineState(v.gfxDevice,r,s,t,n)),a){var o=n;e.bindPipelineState(a),e.bindDescriptorSet(ht.MATERIAL,r.descriptorSet),e.bindDescriptorSet(ht.LOCAL,i),e.bindInputAssembler(o),e.draw(o)}}var xs=function(){function e(){this.probeQueue=new Ts,this.opaqueQueue=new Ps,this.transparentQueue=new Ps,this.opaqueInstancingQueue=new Ls,this.transparentInstancingQueue=new Ls,this.camera=null,this.sceneFlags=At.NONE,this.lightByteOffset=4294967295}var t=e.prototype;return t.sort=function(){this.opaqueQueue.sortOpaqueOrCutout(),this.transparentQueue.sortTransparent(),this.opaqueInstancingQueue.sort(),this.transparentInstancingQueue.sort()},t.update=function(){this.probeQueue.clear(),this.opaqueQueue.clear(),this.transparentQueue.clear(),this.opaqueInstancingQueue.clear(),this.transparentInstancingQueue.clear(),this.camera=null,this.sceneFlags=At.NONE,this.lightByteOffset=4294967295},t.empty=function(){return this.opaqueQueue.empty()&&this.transparentQueue.empty()&&this.opaqueInstancingQueue.empty()&&this.transparentInstancingQueue.empty()},t.recordCommands=function(e,t,r){var i=4294967295===this.lightByteOffset?null:[this.lightByteOffset];r&(At.OPAQUE|At.MASK)&&(this.opaqueQueue.recordCommandBuffer(v.gfxDevice,t,e,null,0,i),this.opaqueInstancingQueue.recordCommandBuffer(t,e,null,0,i)),r&At.BLEND&&(this.transparentInstancingQueue.recordCommandBuffer(t,e,null,0,i),this.transparentQueue.recordCommandBuffer(v.gfxDevice,t,e,null,0,i))},e}(),Bs=4294967295;function Os(e){switch(e){case 0:return j.UNIFORM_BUFFER;case 1:return j.DYNAMIC_UNIFORM_BUFFER;case 2:return j.SAMPLER_TEXTURE;case 3:return j.SAMPLER;case 4:return j.TEXTURE;case 5:return j.STORAGE_BUFFER;case 6:return j.DYNAMIC_STORAGE_BUFFER;case 7:return j.STORAGE_IMAGE;case 8:return j.INPUT_ATTACHMENT;default:return a("DescriptorType not found"),j.INPUT_ATTACHMENT}}function Gs(e){switch(e){case j.UNIFORM_BUFFER:return 0;case j.DYNAMIC_UNIFORM_BUFFER:return 1;case j.SAMPLER_TEXTURE:return 2;case j.SAMPLER:return 3;case j.TEXTURE:return 4;case j.STORAGE_BUFFER:return 5;case j.DYNAMIC_STORAGE_BUFFER:return 6;case j.STORAGE_IMAGE:return 7;case j.INPUT_ATTACHMENT:return 8;case j.UNKNOWN:default:return a("DescriptorTypeOrder not found"),8}}function Ms(e,t){return e.locateChild(e.N,t||"default")}function Vs(e,t,r){return e.locateChild(t,r)}function Fs(e,t,r){return void 0===r?e.locateChild(t,"default"):"number"==typeof r?e.locateChild(t,r.toString()):e.locateChild(t,r)}var Us,ks,Hs=new Map([["cc_lightPos",ut.LIGHTS_PER_PASS],["cc_lightColor",ut.LIGHTS_PER_PASS],["cc_lightSizeRangeAngle",ut.LIGHTS_PER_PASS],["cc_lightDir",ut.LIGHTS_PER_PASS],["cc_lightBoundingSizeVS",ut.LIGHTS_PER_PASS]]);function Qs(e){for(var t,r=0,s=i(e);!(t=s()).done;){var n=t.value;if(n.count)r+=Y(n.type)*n.count;else{var u=Hs.get(n.name);if(void 0===u)if("cc_joints"!==n.name)a("Invalid uniform count: "+n.name);else{var c=Y(n.type)*dt.LAYOUT.members[0].count;o(c!==dt.SIZE),r+=c}else r+=Y(n.type)*u}}return o(!!r),r}function zs(e,t){var r=JSON.parse(e[0]),i=JSON.parse(t[0]);return 1e4*r.updateFrequency+1e3*r.parameterType+100*r.descriptorType+r.visibility-(1e4*i.updateFrequency+1e3*i.parameterType+100*i.descriptorType+i.visibility)}function Ws(e,t){var r=JSON.parse(e[0]),i=JSON.parse(t[0]);return 1e9*r.updateFrequency+1e8*r.parameterType+1e7*r.descriptorType+1e6*r.visibility+1e5*r.accessType+1e4*r.viewDimension+1e3*r.sampleType+r.format-(1e9*i.updateFrequency+1e8*i.parameterType+1e7*i.descriptorType+1e6*i.visibility+1e5*i.accessType+1e4*i.viewDimension+1e3*i.sampleType+i.format)}function js(e,t){var r=e.attributeIndex.get(t);if(void 0===r){var i=e.valueNames.length;return e.attributeIndex.set(t,i),e.valueNames.push(t),i}return r}function qs(e,t){t.bindings.length=0;for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,n=0;n<i.descriptors.length;++n){var a=i.descriptors[n],o=new A;o.binding=s,o.descriptorType=Os(i.type),o.count=a.count,o.stageFlags=i.visibility,o.access=i.accessType,o.viewDimension=i.viewDimension,o.sampleType=i.sampleType,o.format=i.format,o.immutableSamplers=[],t.bindings.push(o),s+=a.count}}function Xs(e,t){var r=new B;return qs(t,r),e?e.createDescriptorSetLayout(r):null}function Ys(e,t){for(var r=0;r<t._layouts.length;++r)t.getLayout(r).getSets().forEach((function(t){var r=t,i=r.descriptorSetLayoutData;if(e){var s=Xs(e,i);s&&(r.descriptorSetLayout=s,r.descriptorSet=e.createDescriptorSet(new Q(s)))}else qs(i,r.descriptorSetLayoutInfo)}))}function Ks(e,t){var r=JSON.stringify(t),i=e.get(r);if(i)return i;var s=new ii(t.descriptorType,t.visibility,0);return e.set(r,s),s}function Zs(e,t){var r=JSON.stringify(t),i=e.get(r);if(i)return i;var s=new ii(t.descriptorType,t.visibility,0,t.accessType,t.viewDimension,t.sampleType,t.format);return e.set(r,s),s}function Js(e){switch(e){case L.SAMPLER1D:case L.TEXTURE1D:case L.IMAGE1D:return C.TEX1D;case L.SAMPLER2D:case L.TEXTURE2D:case L.IMAGE2D:return C.TEX2D;case L.SAMPLER2D_ARRAY:case L.TEXTURE2D_ARRAY:case L.IMAGE2D_ARRAY:return C.TEX2D_ARRAY;case L.SAMPLER_CUBE:case L.TEXTURE_CUBE:case L.IMAGE_CUBE:return C.TEXCUBE;case L.SAMPLER3D:case L.TEXTURE3D:case L.IMAGE3D:return C.TEX3D;default:return C.UNKNOWN}}function $s(e,t,r,s){for(var n=new Map,u=new Map,c=0;c<s.blocks.length;c++){var h=s.blocks[c],d=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:0,visibility:h.stageFlags,accessType:b.READ_ONLY,viewDimension:C.BUFFER,sampleType:x.FLOAT,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:0,visibility:h.stageFlags}),l=js(e,h.name);d.descriptors.push(new ri(l,L.UNKNOWN,1)),u.set(l,new O(r,4294967295,h.name,h.members,1))}for(var p=0;p<s.samplerTextures.length;p++){var f=s.samplerTextures[p],v=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:2,visibility:f.stageFlags,accessType:b.READ_ONLY,viewDimension:Js(f.type),sampleType:f.sampleType,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:2,visibility:f.stageFlags}),g=js(e,f.name);v.descriptors.push(new ri(g,f.type,f.count))}for(var m=0;m<s.samplers.length;m++){var y=s.samplers[m],S=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:3,visibility:y.stageFlags,accessType:b.READ_ONLY,viewDimension:C.UNKNOWN,sampleType:x.FLOAT,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:3,visibility:y.stageFlags}),E=js(e,y.name);S.descriptors.push(new ri(E,L.SAMPLER,y.count))}for(var w=0;w<s.textures.length;w++){var D=s.textures[w],T=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:4,visibility:D.stageFlags,accessType:b.READ_ONLY,viewDimension:Js(D.type),sampleType:D.sampleType,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:4,visibility:D.stageFlags}),I=js(e,D.name);T.descriptors.push(new ri(I,D.type,D.count))}for(var R=0;R<s.buffers.length;R++){var N=s.buffers[R],A=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:5,visibility:N.stageFlags,accessType:b.READ_ONLY,viewDimension:C.BUFFER,sampleType:x.FLOAT,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:5,visibility:N.stageFlags}),P=js(e,N.name);A.descriptors.push(new ri(P,L.UNKNOWN,1))}for(var B=0;B<s.images.length;B++){var G=s.images[B],M=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:7,visibility:G.stageFlags,accessType:b.READ_ONLY,viewDimension:Js(G.type),sampleType:x.FLOAT,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:7,visibility:G.stageFlags}),V=js(e,G.name);M.descriptors.push(new ri(V,G.type,G.count))}for(var F=0;F<s.subpassInputs.length;F++){var U=s.subpassInputs[F],k=ti.isWebGPU?Zs(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:8,visibility:U.stageFlags,accessType:b.READ_ONLY,viewDimension:C.TEX2D,sampleType:x.FLOAT,format:_.UNKNOWN}):Ks(n,{updateFrequency:t,parameterType:Pt.TABLE,descriptorType:8,visibility:U.stageFlags}),H=js(e,U.name);k.descriptors.push(new ri(H,L.UNKNOWN,U.count))}for(var Q,z=ti.isWebGPU?Array.from(n).sort(Ws):Array.from(n).sort(zs),W=new si(r,0),j=0,q=i(z);!(Q=q()).done;){var X=Q.value,Y=X[0],K=X[1],Z=JSON.parse(Y);K.offset=j;for(var J,$=i(K.descriptors);!(J=$()).done;){var ee=J.value;if(0===Z.descriptorType){var te=u.get(ee.descriptorID);if(!te){a("Uniform block not found for "+ee.descriptorID);continue}o(4294967295===te.binding),te.binding=K.capacity,W.uniformBlocks.set(ee.descriptorID,te)}void 0!==W.bindingMap.get(ee.descriptorID)&&a("Duplicated descriptor "+ee.descriptorID),W.bindingMap.set(ee.descriptorID,K.offset+K.capacity),K.capacity+=ee.count}j+=K.capacity,W.capacity+=K.capacity,0===Z.descriptorType||1===Z.descriptorType?W.uniformBlockCapacity+=K.capacity:2===Z.descriptorType&&(W.samplerTextureCapacity+=K.capacity),W.descriptorBlocks.push(K)}return W}function en(e,t){t.bindings.length=0;for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,n=0;n<i.descriptors.length;++n){var a=i.descriptors[n],o=new A;o.binding=s,o.descriptorType=Os(i.type),o.count=a.count,o.stageFlags=i.visibility,o.access=i.accessType,o.viewDimension=i.viewDimension,o.sampleType=i.sampleType,o.format=i.format,o.immutableSamplers=[],t.bindings.push(o),s+=a.count}}function tn(e,t,r){var i=e.getSet(t);i&&i.descriptorSetLayout?r.setLayouts.push(i.descriptorSetLayout):r.setLayouts.push(Us)}function rn(e,t){ti.type=e.gfxAPI===z.WEBGPU?1:0,ti.isWebGPU=e.gfxAPI===z.WEBGPU,Us=e.createDescriptorSetLayout(new B),ks=e.createPipelineLayout(new W);for(var r,s=i(t.v());!(r=s()).done;)for(var a,o=r.value,u=t.getLayout(o).getSets(),c=i(u);!(a=c()).done;){var h=a.value;h[0];var d=h[1];null!==d.descriptorSetLayout&&n("descriptor set layout already initialized. It will be overwritten"),en(d.descriptorSetLayoutData,d.descriptorSetLayoutInfo),d.descriptorSetLayout=e.createDescriptorSetLayout(d.descriptorSetLayoutInfo)}for(var l,p=i(t.v());!(l=p()).done;){var f=l.value;if(t.h(1,f)){var v=t.getParent(f),g=f,_=t.getLayout(v),m=t.getLayout(g),y=new W;tn(_,Dt.PER_PASS,y),tn(m,Dt.PER_PHASE,y),tn(m,Dt.PER_BATCH,y),tn(m,Dt.PER_INSTANCE,y),t.j(g).pipelineLayout=e.createPipelineLayout(y)}}}function sn(e){for(var t,r=i(e.v());!(t=r()).done;)for(var s,n=t.value,a=e.getLayout(n).getSets(),o=i(a);!(s=o()).done;){var u=s.value;u[0];var c=u[1];null!==c.descriptorSetLayout&&c.descriptorSetLayout.destroy()}ks.destroy(),Us.destroy()}function nn(){return Us}function an(){return ks}function on(e,t,r,i){if(i<Dt.PER_PASS){var s=e.getLayout(r).getSet(i);return s?s.descriptorSetLayout?s.descriptorSetLayout:(a("descriptor set layout not initialized"),Us):Us}o(i===Dt.PER_PASS),o(t===e.getParent(r));var n=e.getLayout(t).getSet(i);return n?n.descriptorSetLayout?n.descriptorSetLayout:(a("descriptor set layout not initialized"),Us):Us}function un(e,t,r,i){if(i<Dt.PER_PASS){var s=e.getLayout(r).getSet(i);return s?s.descriptorSetLayout?s.descriptorSetLayout:(a("descriptor set layout not initialized"),null):null}o(i===Dt.PER_PASS),o(t===e.getParent(r));var n=e.getLayout(t).getSet(i);return n?n.descriptorSetLayout?n.descriptorSetLayout:(a("descriptor set layout not initialized"),null):null}function cn(e,t,r){o(t!==e.N);var i=e.j(t).shaderIndex.get(r);return void 0===i?Bs:i}function hn(e,t){var r=e.attributeIndex.get(t);return void 0===r?Bs:r}function dn(e,t){return t>=e.valueNames.length?"":e.valueNames[t]}var ln=function(){this.frustumCullingKeyRecycle=new r((function(){return new Sn}),8),this.frustumCullingsRecycle=new r((function(){return new Rn}),8),this.lightBoundsCullingRecycle=new r((function(){return new wn}),8),this.lightBoundsCullingResultRecycle=new r((function(){return new Dn}),8),this.lightBoundsCullingKeyRecycle=new r((function(){return new En}),8),this.renderQueueRecycle=new r((function(){return new xs}),8),this.renderQueueQueryRecycle=new r((function(){return new bs}),8)},pn=lt.makeMaskExclude([lt.BitMask.UI_2D,lt.BitMask.UI_3D,lt.BitMask.GIZMOS,lt.BitMask.EDITOR,lt.BitMask.SCENE_GIZMO,lt.BitMask.PROFILER]),fn=new WeakMap,vn="",gn=0;function _n(e){return fn.has(e)||fn.set(e,++gn),fn.get(e)}function mn(e,t,r){void 0===r&&(r=-1),vn="";var i=e.camera,s=e.light.light,n=e.light.level,a=e.light.probe,o=e.shadingLight;return vn+=us(i?_n(i):0),vn+=us(a?_n(a):0),vn+=us(-1===r&&s?_n(s):0),vn+=us(-1!==r&&o?_n(o):0),vn+=us(-1===r?n:0),vn+=us(t?1:0),vn+=us(r)}var yn,Sn=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=!1),this.sceneData=null,this.castShadows=!1,this.sceneData=e,this.castShadows=t}return e.prototype.update=function(e,t){this.sceneData=e,this.castShadows=t},e}(),En=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=null,this.frustumCullingID=-1,this.sceneData=e,this.frustumCullingID=t}return e.prototype.update=function(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=e,this.frustumCullingID=t},e}(),wn=function(){function e(){this.resultKeyIndex=new Map,this.resultIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}(),Dn=function(){function e(){this.instances=[],this.lightByteOffset=4294967295}return e.prototype.update=function(){return this.instances.length=0,this.lightByteOffset=4294967295,this},e}();function Tn(e,t,r){return e+"-"+t+"-"+r}function In(e){var t=e.split("-");return[parseInt(t[0]),parseInt(t[1]),parseInt(t[2])]}var Rn=function(){function e(){this.resultIndex=new Map,this.resultKeyIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}();function Nn(e,t){return e&&(t&e.layer)===e.layer}function An(e,t){return!!(t&e.visFlags)}function Pn(e,t){return Nn(e.node,t)||An(e,t)}function Ln(e){return hs((e.node.layer&pn)===e.node.layer||pn&e.visFlags)}var bn=new Ie;function Cn(e,t,r){var i=e.worldBounds,s=yn.shadows;return r&&s.type===Qe.Planar?(Ie.transform(bn,i,s.matLight),!Pe.aabbFrustum(bn,t)):!Pe.aabbFrustum(i,t)}function xn(e,t,r,s,n,a){var o,u,c=yn.skybox,h=c.model,d=t.visibility,l=t.clearFlag&Ve.VALUE;!s&&c&&c.enabled&&h&&l&&a.push(h);for(var p,f=i(e.models);!(p=f()).done;){var v=p.value;if(v.enabled&&v.node&&(!s||v.castShadow)&&!e.isCulledByLod(t,v)){var g=v.worldBounds;if(n)if(n.probeType===Fe.CUBE){if(!Pn(v,d))continue;if(g&&(o=g,u=n.boundingBox,!Pe.aabbWithAABB(o,u)))continue;a.push(v)}else Ln(v)&&a.push(v);else{if(!Pn(v,d))continue;if(g&&Cn(v,r,s))continue;a.push(v)}}}}var Bn=new Le;function On(e,t){var r=0;return t.node&&(Le.subtract(Bn,t.worldBounds?t.worldBounds.center:t.node.worldPosition,e.position),r=Le.dot(Bn,e.forward)),r}function Gn(e,t,r,i,s,n,a){var o=a.probeQueue;i&&o.addToProbeQueue(n,e);for(var u=n.subModels,c=u.length,h=yn.skybox.model,d=On(s,n),l=0;l<c;++l){var p=u[l],f=p.passes,v=f.length;o.probeMap.includes(p)&&(e=o.defaultId);for(var g=0;g<v;++g)if(n!==h||l||g||!t){var _=f[g];if(e===_.phaseID){var m=_.blendState.targets[0].blend;!r&&m||!t&&!m||(_.batchingScheme===Xe.INSTANCING?m?a.transparentInstancingQueue.add(_,p,g):a.opaqueInstancingQueue.add(_,p,g):m?a.transparentQueue.add(n,d,l,g):a.opaqueQueue.add(n,d,l,g))}}else a.opaqueQueue.add(n,d,l,g)}}var Mn,Vn=new Ie(0,0,0,.5,.5,.5),Fn=new Ie,Un=function(){function e(){this.frustumCullings=new Map,this.frustumCullingResults=[],this.lightBoundsCullings=new Map,this.lightBoundsCullingResults=[],this.renderQueueIndex=new Map,this.renderQueues=[],this.renderQueueQueryIndex=new Map,this.cullingPools=new ln,this.numFrustumCulling=0,this.numLightBoundsCulling=0,this.numRenderQueues=0,this.layoutGraph=void 0,this.renderGraph=void 0,this.enableLightCulling=!0,this.kFilterMask=At.SHADOW_CASTER|At.REFLECTION_PROBE,this.kDrawMask=At.OPAQUE|At.MASK|At.BLEND,this.kAllMask=this.kFilterMask|this.kDrawMask}var t=e.prototype;return t.resetPool=function(){var e=this.cullingPools;e.frustumCullingKeyRecycle.reset(),e.frustumCullingsRecycle.reset(),e.lightBoundsCullingRecycle.reset(),e.lightBoundsCullingResultRecycle.reset(),e.lightBoundsCullingKeyRecycle.reset(),e.renderQueueRecycle.reset(),e.renderQueueQueryRecycle.reset(),Es.reset()},t.clear=function(){this.resetPool(),this.frustumCullings.clear(),this.frustumCullingResults.length=0,this.lightBoundsCullings.clear(),this.lightBoundsCullingResults.length=0,this.renderQueueIndex.clear(),this.renderQueues.length=0,this.renderQueueQueryIndex.clear(),this.numLightBoundsCulling=0,this.numFrustumCulling=0,this.numRenderQueues=0},t.buildRenderQueues=function(e,t,r){this.layoutGraph=t,this.renderGraph=e,yn=r,this.collectCullingQueries(e),this.batchFrustumCulling(r),this.batchLightBoundsCulling(),this.fillRenderQueues()},t.getOrCreateLightBoundsCulling=function(e,t){var r;if(!(4&e.cullingFlags))return 4294967295;if((null==(r=e.shadingLight)?void 0:r.type)===Ge.DIRECTIONAL)return 4294967295;if(!this.enableLightCulling)return 4294967295;var i=e.scene,s=this.lightBoundsCullings.get(i);if(!s){var n=this.cullingPools.lightBoundsCullingRecycle.add();n.update(),this.lightBoundsCullings.set(i,n),s=this.lightBoundsCullings.get(i)}var a=mn(e,!1,t),o=s.resultIndex.get(a);if(void 0!==o)return o;var u=this.numLightBoundsCulling++;this.numLightBoundsCulling>this.lightBoundsCullingResults.length&&this.lightBoundsCullingResults.push(this.cullingPools.lightBoundsCullingResultRecycle.add().update()),s.resultIndex.set(a,u);var c=this.cullingPools.lightBoundsCullingKeyRecycle.add();return c.update(e,t),s.resultKeyIndex.set(a,c),u},t.getOrCreateFrustumCulling=function(e){var t=this.renderGraph.j(e),r=t.scene,i=this.frustumCullings.get(r);if(!i){var s=this.cullingPools.frustumCullingsRecycle.add();s.update(),this.frustumCullings.set(r,s),i=this.frustumCullings.get(r)}var n=hs(t.flags&At.SHADOW_CASTER),a=mn(t,n),o=i.resultIndex.get(a);if(void 0!==o)return o;var u=this.numFrustumCulling++;this.numFrustumCulling>this.frustumCullingResults.length&&this.frustumCullingResults.push([]),i.resultIndex.set(a,u);var c=this.cullingPools.frustumCullingKeyRecycle.add();return c.update(t,n),i.resultKeyIndex.set(a,c),u},t.getOrCreateRenderQueue=function(e,t,r){var i=this.renderQueueIndex.get(e);if(void 0!==i){var s=this.renderQueues[i];return o(s.camera===r),o((s.sceneFlags&this.kFilterMask)==(t&this.kFilterMask)),s.sceneFlags|=t&this.kDrawMask,i}var n=this.numRenderQueues++;if(this.numRenderQueues>this.renderQueues.length){var a=this.cullingPools.renderQueueRecycle.add();a.update(),this.renderQueues.push(a)}var u=this.renderQueues[n];return this.renderQueueIndex.set(e,n),o(u.empty()),o(null===u.camera),o(u.sceneFlags===At.NONE),o(null!==r),o(this.renderQueueIndex.size===this.numRenderQueues),u.camera=r,u.sceneFlags=t&this.kAllMask,n},t.collectCullingQueries=function(e){for(var t,r=i(e.v());!(t=r()).done;){var s=t.value;if(e.h(9,s)&&e.getValid(s)){var n=e.j(s);if(n.scene){var a=this.getOrCreateFrustumCulling(s),u=this.getOrCreateLightBoundsCulling(n,a),c=e.getParent(s);o(4294967295!==c),o(e.h(8,c));var h=Tn(a,u,e.j(c).phaseID),d=this.getOrCreateRenderQueue(h,n.flags,n.camera),l=this.cullingPools.renderQueueQueryRecycle.add();l.update(a,u,d),this.renderQueueQueryIndex.set(s,l)}}}},t.uploadInstancing=function(e){for(var t=0;t!==this.numRenderQueues;++t){var r=this.renderQueues[t];r.opaqueInstancingQueue.uploadBuffers(e),r.transparentInstancingQueue.uploadBuffers(e)}},t._getPhaseIdFromScene=function(e){var t=this.renderGraph,r=t.getParent(e);return t.j(r).phaseID},t.getBuiltinShadowFrustum=function(e,t,r,i){var s=e.csmLayers,n=r.csmLevel,a=e.shadows;return a.type===Qe.Planar?t.frustum:(a.enabled&&a.type===Qe.ShadowMap&&r&&r.node&&s.update(e,t),r.shadowFixedArea||n===He.LEVEL_1?s.specialLayer.validFrustum:s.layers[i].validFrustum)},t.batchFrustumCulling=function(e){for(var t,r=i(this.frustumCullings);!(t=r()).done;)for(var s,n=t.value,a=n[0],o=n[1],u=i(o.resultIndex);!(s=u()).done;){var c=s.value,h=c[0],d=c[1],l=o.resultKeyIndex.get(h),p=l.sceneData,f=p.light.light,v=p.light.level,g=l.castShadows,_=p.light.probe,m=_?_.camera:p.camera,y=this.frustumCullingResults[d];if(_)xn(a,m,m.frustum,g,_,y);else if(f)switch(f.type){case Ge.SPOT:xn(a,m,f.frustum,g,null,y);break;case Ge.DIRECTIONAL:xn(a,m,this.getBuiltinShadowFrustum(e,m,f,v),g,null,y)}else xn(a,m,m.frustum,g,null,y)}},t.executeSphereLightCulling=function(e,t,r){for(var s,n=e.aabb,a=i(t);!(s=a()).done;){var o=s.value,u=o.worldBounds;u&&!Pe.aabbWithAABB(u,n)||r.push(o)}},t.executeSpotLightCulling=function(e,t,r){for(var s,n=e.aabb,a=e.frustum,o=i(t);!(s=o()).done;){var u=s.value,c=u.worldBounds;(!c||Pe.aabbWithAABB(n,c)&&Pe.aabbFrustum(c,a))&&r.push(u)}},t.executePointLightCulling=function(e,t,r){for(var s,n=e.aabb,a=i(t);!(s=a()).done;){var o=s.value,u=o.worldBounds;u&&!Pe.aabbWithAABB(n,u)||r.push(o)}},t.executeRangedDirectionalLightCulling=function(e,t,r){Vn.transform(e.node.worldMatrix,null,null,null,Fn);for(var s,n=i(t);!(s=n()).done;){var a=s.value,o=a.worldBounds;o&&!Pe.aabbWithAABB(Fn,o)||r.push(a)}},t.batchLightBoundsCulling=function(){for(var e,t=i(this.lightBoundsCullings);!(e=t()).done;){var r=e.value;r[0];for(var s,n=r[1],a=i(n.resultIndex);!(s=a()).done;){var o=s.value,u=o[0],c=o[1],h=n.resultKeyIndex.get(u),d=h.sceneData,l=h.frustumCullingID,p=this.frustumCullingResults[l],f=this.lightBoundsCullingResults[c];switch(d.shadingLight.type){case Ge.SPHERE:var v=d.shadingLight;this.executeSphereLightCulling(v,p,f.instances);break;case Ge.SPOT:var g=d.shadingLight;this.executeSpotLightCulling(g,p,f.instances);break;case Ge.POINT:var _=d.shadingLight;this.executePointLightCulling(_,p,f.instances);break;case Ge.RANGED_DIRECTIONAL:var m=d.shadingLight;this.executeRangedDirectionalLightCulling(m,p,f.instances);case Ge.DIRECTIONAL:case Ge.UNKNOWN:}}}},t._getModelsByCullingResults=function(e,t){return 4294967295!==e?e<this.lightBoundsCullingResults.length?this.lightBoundsCullingResults[e].instances:[]:t<this.frustumCullingResults.length?this.frustumCullingResults[t]:[]},t.fillRenderQueues=function(){for(var e,t=i(this.renderQueueIndex);!(e=t()).done;){var r=e.value,s=r[0],n=r[1],a=this.renderQueues[n];o(n<this.renderQueues.length),o(a.empty());var u=In(s),c=u[0],h=u[1],d=u[2],l=hs(a.sceneFlags&At.BLEND),p=hs(a.sceneFlags&(At.OPAQUE|At.MASK)),f=hs(a.sceneFlags&At.SHADOW_CASTER),v=hs(a.sceneFlags&At.REFLECTION_PROBE);if(f||l||p||v){for(var g,_=this._getModelsByCullingResults(h,c),m=a.camera,y=i(_);!(g=y()).done;)Gn(d,p,l,v,m,g.value,a);a.sort()}}},e}(),kn=function(){function e(){this.cpuBuffer=void 0,this.programLibrary=void 0,this.device=null,this.elementSize=0,this.maxNumLights=16,this.binding=4294967295,this.resized=!1,this.lightBuffer=void 0,this.firstLightBufferView=null,this.lights=[],this.lightIndex=new Map}var t=e.prototype;return t.init=function(e,t,r){this.device=t,this.programLibrary=e;var i,s=this.programLibrary.localLayoutData,n=e.layoutGraph.attributeIndex.get("CCForwardLight"),a=s.uniformBlocks.get(n);this.elementSize=Qs(a.members)+((i=this.device.capabilities.uboOffsetAlignment)-1)&~(i-1),this.maxNumLights=r,this.binding=e.localLayoutData.bindingMap.get(n);var o=this.elementSize*this.maxNumLights;this.lightBuffer=this.device.createBuffer(new U(k.UNIFORM|k.TRANSFER_DST,H.HOST|H.DEVICE,o,this.elementSize)),this.firstLightBufferView=this.device.createBuffer(new K(this.lightBuffer,0,this.elementSize)),this.cpuBuffer=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),this.resized=!0},t.buildLights=function(e,t,r){for(var s,n=i(e.lightBoundsCullings);!(s=n()).done;){var a=s.value;a[0];for(var o,u=a[1],c=i(u.resultIndex);!(o=c()).done;){var h=o.value,d=h[0],l=h[1],p=u.resultKeyIndex.get(d).sceneData,f=1;if(p.camera)f=p.camera.exposure;else{if(!p.light.probe||!p.light.probe.camera)throw new Error("Unexpected situation: No camera or probe found.");f=p.light.probe.camera.exposure}var v=this.addLight(p.shadingLight,t,f,r);e.lightBoundsCullingResults[l].lightByteOffset=v}}for(var g,_=i(e.renderQueueQueryIndex);!(g=_()).done;){var m=g.value;m[0];var y=m[1];if(4294967295!==y.lightBoundsCulledResultID){var S=e.lightBoundsCullingResults[y.lightBoundsCulledResultID].lightByteOffset;e.renderQueues[y.renderQueueTarget].lightByteOffset=S}}},t.tryUpdateRenderSceneLocalDescriptorSet=function(e){if(e.lightBoundsCullings.size){for(var t,r=i(e.frustumCullings);!(t=r()).done;){var s=t.value,n=s[0];s[1];for(var a,o=i(n.models);!(a=o()).done;){var u=a.value;if(!u)throw new Error("Unexpected null model.");for(var c,h=i(u.subModels);!(c=h()).done;){var d=c.value.descriptorSet,l=d.getBuffer(this.binding);(this.resized||l!==this.firstLightBufferView)&&(d.bindBuffer(this.binding,this.firstLightBufferView),d.update())}}}this.resized=!1}},t.clear=function(){this.cpuBuffer.fill(0),this.lights.length=0,this.lightIndex.clear()},t.addLight=function(e,t,r,i){var s=this.lightIndex.get(e);if(void 0!==s)return s;if(this.lights.length===this.maxNumLights){this.resized=!0,this.maxNumLights*=2;var n=this.elementSize*this.maxNumLights;this.lightBuffer.resize(n),this.firstLightBufferView=this.device.createBuffer(new K(this.lightBuffer,0,this.elementSize));var a=this.cpuBuffer;this.cpuBuffer=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this.cpuBuffer.set(a)}var o=this.lights.length;this.lights[o]=e,this.lightIndex.set(e,o);var u=this.elementSize/Float32Array.BYTES_PER_ELEMENT*o;return ds(e,t,r,i,this.cpuBuffer,u,this.elementSize),o*this.elementSize},t.buildLightBuffer=function(e){e.updateBuffer(this.lightBuffer,this.cpuBuffer,this.lights.length*this.elementSize/Float32Array.BYTES_PER_ELEMENT)},e}(),Hn=function(){function e(e){void 0===e&&(e=""),this.name=void 0,this.name=e,Mn&&Mn.pipeline.resourceUses.push(e)}var t=e.prototype;return t.checkTexture=function(e){var t=Mn.deviceTextures.get(e);if(!t)return!1;var r=Mn.resourceGraph.getDesc(Mn.resourceGraph.vertex(e)),i=r.width,s=r.height,n=function(e,t){return e===i&&t===s};return t.texture?n(t.texture.width,t.texture.height):!!t.swapchain&&n(t.swapchain.width,t.swapchain.height)},t.createDeviceTex=function(e){var t,r=Mn.deviceTextures.get(this.name);r&&this.checkTexture(this.name)||(null!=(t=r)&&t.texture&&r.texture.destroy(),r=new zn(this.name,e),Mn.deviceTextures.set(this.name,r))},t.checkBuffer=function(e){var t=Mn.deviceBuffers.get(e),r=Mn.resourceGraph.vertex(this.name),i=Mn.resourceGraph.getDesc(r);return t.buffer.size>=i.width},t.createDeviceBuf=function(e){var t,r=Mn.deviceBuffers.get(this.name);r&&this.checkBuffer(this.name)||(null!=(t=r)&&t.buffer&&r.buffer.destroy(),r=new Xn(this.name,e),Mn.deviceBuffers.set(this.name,r))},t.managed=function(e){this.createDeviceTex(e)},t.managedBuffer=function(e){this.createDeviceBuf(e)},t.managedTexture=function(){},t.persistentBuffer=function(e){this.createDeviceBuf(e)},t.persistentTexture=function(e){this.createDeviceTex(e)},t.framebuffer=function(e){this.createDeviceTex(e)},t.swapchain=function(e){this.createDeviceTex(e)},t.formatView=function(){},t.subresourceView=function(){},s(e,[{key:"resName",set:function(e){this.name=e}}]),e}(),Qn=function(){function e(e){this._name=void 0,this._name=e}return s(e,[{key:"name",get:function(){return this._name}}]),e}(),zn=function(e){function t(t,r){var i;(i=e.call(this,t)||this)._texture=null,i._swapchain=null,i._framebuffer=null,i._desc=null,i._trait=null;var s=Mn.resourceGraph,n=s.vertex(t);return i._desc=s.getDesc(n),i._trait=s.getTraits(n),r instanceof V?i._texture=r:r instanceof ee?i._framebuffer=r:r instanceof fr?i._swapchain=r.swapchain:i.createTextureFromDesc(i._desc),i}u(t,e);var r=t.prototype;return r.createTextureFromDesc=function(e){var t=S.TEX2D;switch(e.dimension){case Rt.TEXTURE1D:t=S.TEX1D;break;case Rt.TEXTURE3D:t=S.TEX3D}var r=[[Nt.COLOR_ATTACHMENT,Z.COLOR_ATTACHMENT],[Nt.DEPTH_STENCIL_ATTACHMENT,Z.DEPTH_STENCIL_ATTACHMENT],[Nt.INPUT_ATTACHMENT,Z.INPUT_ATTACHMENT],[Nt.SAMPLED,Z.SAMPLED],[Nt.STORAGE,Z.STORAGE],[Nt.TRANSFER_SRC,Z.TRANSFER_SRC],[Nt.TRANSFER_DST,Z.TRANSFER_DST]].reduce((function(t,r){var i=r[0],s=r[1];return e.flags&i?t|s:t}),Z.NONE);this._texture=Mn.device.createTexture(new J(t,r,e.format,e.width,e.height))},r.release=function(){var e,t;null==(e=this.framebuffer)||e.destroy(),this._framebuffer=null,null==(t=this.texture)||t.destroy(),this._texture=null},s(t,[{key:"texture",get:function(){return this._texture}},{key:"framebuffer",get:function(){return this._framebuffer},set:function(e){this._framebuffer=e}},{key:"description",get:function(){return this._desc}},{key:"trait",get:function(){return this._trait}},{key:"swapchain",get:function(){return this._swapchain}}]),t}(Qn);function Wn(e){var t=Et.director.root.pipeline.pipelineSceneData;return!!(t.shadows.enabled&&t.shadows.type===Qe.ShadowMap&&e&&e.flags&At.SHADOW_CASTER)}var jn,qn,Xn=function(e){function t(t){var r;(r=e.call(this,t)||this)._buffer=null;var i=Mn.resourceGraph,s=i.vertex(t),n=i.getDesc(s),a=new U(r.calculateBufferUsage(n.flags),H.DEVICE,n.width);return r._buffer=Mn.device.createBuffer(a),r}u(t,e);var r=t.prototype;return r.calculateBufferUsage=function(e){return[[Nt.INDIRECT,k.INDIRECT],[Nt.UNIFORM,k.UNIFORM],[Nt.STORAGE,k.STORAGE],[Nt.TRANSFER_SRC,k.TRANSFER_SRC],[Nt.TRANSFER_DST,k.TRANSFER_DST]].reduce((function(t,r){var i=r[0],s=r[1];return e&i?t|s:t}),k.NONE)},r.release=function(){var e;null==(e=this._buffer)||e.destroy(),this._buffer=null},s(t,[{key:"buffer",get:function(){return this._buffer}}]),t}(Qn),Yn=new Float32Array(4),Kn=function(){function e(e){this._isUpdate=!1,this._isGatherLight=!1,this._blit=void 0,this._screenQuad=null,this._stageDesc=void 0,this._lightVolumeBuffer=null,this._lightMeterScale=1e4,this._lightBufferData=void 0,this._blit=e}var t=e.prototype;return t._createQuadInputAssembler=function(){return Mn.blit.pipelineIAData},t.createScreenQuad=function(){this._screenQuad||(this._screenQuad=this._createQuadInputAssembler())},t._gatherVolumeLights=function(e){var t=this;if(e.scene){for(var r,s=Mn.pipeline,n=Mn.commandBuffer,a=e.scene.sphereLights,o=e.scene.spotLights,u=e.exposure,c=vt.LIGHTS_PER_PASS,h=Re.length,d=h*c,l=Ae.create(0,0,0,1),p=0,f=function(r,i){if(!(p>=c)&&(Ae.set(l,r.position.x,r.position.y,r.position.z,r.range),Pe.sphereFrustum(l,e.frustum))){if(Le.toArray(Yn,r.position),Yn[3]=i?1:0,t._lightBufferData.set(Yn,p*h+0*d),Le.toArray(Yn,r.color),r.useColorTemperature){var n=r.colorTemperatureRGB;Yn[0]*=n.x,Yn[1]*=n.y,Yn[2]*=n.z}Yn[3]=s.pipelineSceneData.isHDR?r.luminance*u*t._lightMeterScale:r.luminance,t._lightBufferData.set(Yn,p*h+1*d),Yn[0]=r.size,Yn[1]=r.range,Yn[2]=i?r.spotAngle:0,t._lightBufferData.set(Yn,p*h+2*d),i&&(Le.toArray(Yn,r.direction),t._lightBufferData.set(Yn,p*h+3*d)),p++}},v=i(a);!(r=v()).done;)f(r.value,!1);for(var g,_=i(o);!(g=_()).done;)f(g.value,!0);var m=3*d+3;this._lightBufferData.set([p],m),n.updateBuffer(this._lightVolumeBuffer,this._lightBufferData)}},t.update=function(){this.blit.sceneFlags&At.VOLUMETRIC_LIGHTING&&this.blit.camera&&!this._isGatherLight&&(this._gatherVolumeLights(this.blit.camera),this._isGatherLight=!0,this._isUpdate=!1),this._isUpdate||(this._stageDesc.update(),this._isUpdate=!0)},t.reset=function(){this._isUpdate=!1,this._isGatherLight=!1},t.createStageDescriptor=function(){var e=this.blit,t=e.material.passes[e.passID],r=Mn.device;if(this._stageDesc=Mn.blit.stageDescs.get(t)||r.createDescriptorSet(new Q(t.localSetLayout)),Mn.blit.stageDescs.set(t,this._stageDesc),this.blit.sceneFlags&At.VOLUMETRIC_LIGHTING){this._lightVolumeBuffer=Mn.blit.lightVolumeBuffer;var i=Mn.blit.deferredLitsBufView;this._lightBufferData=Mn.blit.lightBufferData,this._lightBufferData.fill(0),this._stageDesc.bindBuffer(pt.BINDING,i)}this._stageDesc.bindBuffer(ft.BINDING,Mn.blit.emptyLocalUBO)},s(e,[{key:"screenQuad",get:function(){return this._screenQuad}},{key:"blit",get:function(){return this._blit},set:function(e){this._blit=e}},{key:"stageDesc",get:function(){return this._stageDesc}}]),e}(),Zn=function(){function e(){this._devicePass=void 0,this._hint=It.NONE,this._phaseID=Ye("default"),this._renderPhase=null,this._descSetData=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._queueId=-1}var t=e.prototype;return t.preRecord=function(){},t.postRecord=function(){},t.init=function(e,t,r){this.reset(),this.queueHint=t.hint,this.queueId=r,this._devicePass=e,this._phaseID=Et.rendering.getPhaseID(e.passID,Mn.renderGraph.getLayout(r))},t.reset=function(){this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1},t.record=function(){this._descSetData&&this._descSetData.descriptorSet&&Mn.commandBuffer.bindDescriptorSet(ht.COUNT,this._descSetData.descriptorSet)},s(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=Mn.layoutGraph;this._renderPhase=t.h(1,e)?t.j(e):null;var r=t.getLayout(e);this._descSetData=r.getSet(Dt.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}}]),e}(),Jn=function(){function e(){this._renderScenes=[],this._devicePass=void 0,this._hint=It.NONE,this._graphQueue=void 0,this._phaseID=Ye("default"),this._renderPhase=null,this._descSetData=null,this._viewport=null,this._scissor=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._blitDesc=null,this._queueId=-1}var t=e.prototype;return t.init=function(e,t,r){this.reset(),this._graphQueue=t,this.queueHint=t.hint;var i=this._viewport=t.viewport;i&&(this._scissor=new G(i.left,i.top,i.width,i.height)),this.queueId=r,this._devicePass=e,this._phaseID=Et.rendering.getPhaseID(e.passID,Mn.renderGraph.getLayout(r))},t.createBlitDesc=function(e){this._blitDesc||(this._blitDesc=new Kn(e)),this._blitDesc.createScreenQuad(),this._blitDesc.createStageDescriptor()},t.setScene=function(e,t,r){var i=Mn.pools.addDeviceScene();return i.init(this,e,t,r),this._renderScenes.push(i),i},t.reset=function(){var e;this._renderScenes.length=0,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,null==(e=this._blitDesc)||e.reset()},t.preRecord=function(){},t.record=function(){this._descSetData&&this._descSetData.descriptorSet&&Mn.commandBuffer.bindDescriptorSet(ht.COUNT,this._descSetData.descriptorSet),this._renderScenes.forEach((function(e){e.record()}))},t.postRecord=function(){},s(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=Mn.layoutGraph;this._renderPhase=t.h(1,e)?t.j(e):null;var r=t.getLayout(e);this._descSetData=r.getSet(Dt.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"viewport",get:function(){return this._viewport}},{key:"scissor",get:function(){return this._scissor}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"graphQueue",get:function(){return this._graphQueue}},{key:"blitDesc",get:function(){return this._blitDesc}},{key:"renderScenes",get:function(){return this._renderScenes}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}}]),e}(),$n=function(){function e(e,t,r){this._layoutID=0,this._vertID=-1,this._resID=-1,this._stage=null,this._layout=void 0,this._inputName=void 0,this._descriptorSet=null,this._inputName=r[0],this._layoutID=e,this._vertID=t;var s=Mn.layoutGraph;this._stage=s.j(e),this._layout=s.getLayout(e);var n=this._layout.getSet(Dt.PER_PASS);if(n){var a=n.descriptorSet,o=Mn.deviceTextures.get(this._inputName),u=null==o?void 0:o.texture,c=Mn.deviceBuffers.get(this._inputName),h=null==c?void 0:c.buffer;if(!u&&!h)throw Error("Could not find texture with resource name "+this._inputName);this._resID=Mn.resourceGraph.vertex(this._inputName);for(var d,l=Mn.resourceGraph.getSampler(this._resID),p=i(r[1]);!(d=p()).done;){var f=d.value.name,v=s.attributeIndex.get(f);void 0!==v&&this.bindDescriptor(a,v,u,h,l,r[1][0].accessType)}}}return e.prototype.bindDescriptor=function(e,t,r,s,n,a){for(var o,u=this._layout.getSet(Dt.PER_PASS),c=Mn.resourceGraph.getDesc(this._resID),h=i(u.descriptorSetLayoutData.descriptorBlocks);!(o=h()).done;)for(var d=o.value,l=0;l<d.descriptors.length;++l)if(t===d.descriptors[l].descriptorID){var p=d.offset;if(r){e.bindTexture(p+l,r);var f=Mn.renderGraph.getData(this._vertID).samplers.get(t)||Mn.device.getSampler(n);e.bindSampler(p+l,f)}else if(c.flags&Nt.STORAGE){var v=a!==Lt.READ?E.COMPUTE_SHADER_WRITE:E.COMPUTE_SHADER_READ_OTHER;e.bindBuffer(d.offset+l,s,0,v)}else e.bindBuffer(p+l,s);this._descriptorSet||(this._descriptorSet=e);break}},s(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"layoutID",get:function(){return this._layoutID}},{key:"vertID",get:function(){return this._vertID}},{key:"stage",get:function(){return this._stage}},{key:"layout",get:function(){return this._layout}}]),e}(),ea=new w,ta=new G,ra=new Hn,ia=function(){function e(e,t){this._renderPass=void 0,this._framebuffer=void 0,this._clearColor=[],this._deviceQueues=new Map,this._clearDepth=1,this._clearStencil=0,this._passID=void 0,this._rasterID=void 0,this._rasterPass=void 0,this._layoutName=void 0,this._viewport=null,this._layout=null,this._idxOfRenderData=0,this._rasterID=e,this._rasterPass=t;var r=Mn.device;this._layoutName=Mn.renderGraph.getLayout(e),this._passID=Et.rendering.getPassID(this._layoutName);var s=new oe;s.format=_.DEPTH_STENCIL;for(var n,a=[],o=[],u=null,c=null,h=null,d=i(t.rasterViews);!(n=d()).done;){var l=n.value,p=l[0],f=l[1],v=Mn.deviceTextures.get(p);if(v){var g=Mn.resourceGraph,m=g.vertex(p),y=g.object(m);if(v.framebuffer&&y instanceof ee&&v.framebuffer!==y)v.framebuffer=y;else if(v.texture){var S=g.getDesc(m);v.texture.width===S.width&&v.texture.height===S.height||v.texture.resize(S.width,S.height)}}else this.visitResource(p),v=Mn.deviceTextures.get(p);if(c||(c=v.swapchain),h||(h=v.framebuffer),f.attachmentType===Ct.RENDER_TARGET){v.swapchain||v.framebuffer||o.push(v.texture);var w=new ue;w.format=v.description.format,w.sampleCount=v.description.sampleCount,w.loadOp=f.loadOp,w.storeOp=f.storeOp,w.barrier=r.getGeneralBarrier(new ce(f.loadOp===D.LOAD?E.COLOR_ATTACHMENT_WRITE:E.NONE,f.storeOp===T.STORE?E.COLOR_ATTACHMENT_WRITE:E.NONE));var I=new N;I.copy(f.clearColor),this._clearColor.push(I),a.push(w)}else f.attachmentType===Ct.DEPTH_STENCIL&&(s.depthStoreOp=f.storeOp,s.stencilStoreOp=f.storeOp,s.depthLoadOp=f.loadOp,s.stencilLoadOp=f.loadOp,s.barrier=r.getGeneralBarrier(new ce(f.loadOp===D.LOAD?E.DEPTH_STENCIL_ATTACHMENT_WRITE:E.NONE,f.storeOp===T.STORE?E.DEPTH_STENCIL_ATTACHMENT_WRITE:E.NONE)),v.swapchain||v.framebuffer?v.swapchain&&(u=v.swapchain.depthStencilTexture):u=v.texture,this._clearDepth=f.clearColor.x,this._clearStencil=f.clearColor.y)}if(0===a.length){var R=new ue;a.push(R)}if(0===o.length&&!c&&!h){var A=r.createTexture(new J);o.push(A)}var P=new he;P.colorAttachments=a,(c?c.depthStencilTexture:u)&&(P.depthStencilAttachment=s),this._renderPass=r.createRenderPass(P),this._createFramebuffer(h,c?[c.colorTexture]:o,c?c.depthStencilTexture:u)}var t=e.prototype;return t.addIdxOfRD=function(){this._idxOfRenderData++},t.visitResource=function(e){var t=Mn.resourceGraph,r=t.vertex(e);ra.resName=e,t.visitVertex(ra,r)},t.addQueue=function(e){this._deviceQueues.set(e.queueId,e)},t.preRecord=function(){Mn.passDescriptorSet=Yi(this.layoutName).descriptorSet},t._applyRenderLayout=function(e){var t=Mn.renderGraph.getLayout(this._rasterID);if(t){var r=Mn.layoutGraph,i=r.locateChild(r.N,t);4294967295!==i&&(this._layout=new $n(i,this._rasterID,e))}},t.getGlobalDescData=function(){var e=Mn.layoutGraph.locateChild(Mn.layoutGraph.N,"default");return Mn.layoutGraph.getLayout(e).getSet(Dt.PER_PASS)},t._applyViewport=function(){this._viewport=null;var e=this._rasterPass.viewport;0===e.left&&0===e.top&&0===e.width&&0===e.height||(this._viewport=e)},t.beginPass=function(){var e=this.framebuffer.colorTextures[0];this._applyViewport(e);var t=Mn.commandBuffer;this._viewport?(ta.x=this._viewport.left,ta.y=this._viewport.top,ta.width=this._viewport.width,ta.height=this._viewport.height):(ta.y=ta.x=0,ta.width=e.width,ta.height=e.height),t.beginRenderPass(this.renderPass,this.framebuffer,ta,this.clearColor,this.clearDepth,this.clearStencil),Mn.passDescriptorSet&&t.bindDescriptorSet(ht.GLOBAL,Mn.passDescriptorSet)},t.endPass=function(){Mn.commandBuffer.endRenderPass()},t.record=function(){this.beginPass();for(var e,t=i(this._deviceQueues.values());!(e=t()).done;)e.value.record();this.endPass()},t.postRecord=function(){},t._processRenderLayout=function(e){for(var t,r=i(e.computeViews);!(t=r()).done;){var s=t.value;this._applyRenderLayout(s)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()},t.processRenderLayout=function(){this._processRenderLayout(this._rasterPass)},t._createFramebuffer=function(e,t,r){(e||t.length)&&(this._framebuffer&&e!==this._framebuffer&&this._framebuffer.destroy(),this._framebuffer=e||Mn.device.createFramebuffer(new $(this._renderPass,t,r)))},t.resetResource=function(e,t){var r,s,n,a;this._rasterID=e,this._rasterPass=t,this._layoutName=Mn.renderGraph.getLayout(e),this._passID=Et.rendering.getPassID(this._layoutName),this._deviceQueues.clear(),this._idxOfRenderData=0;for(var o,u=null,c=[],h=this._framebuffer,d=null!==(r=null==h?void 0:h.depthStencilTexture)&&void 0!==r?r:null,l=h?d:null,p=null!==(s=null==h?void 0:h.width)&&void 0!==s?s:0,f=null!==(n=null==h?void 0:h.height)&&void 0!==n?n:0,v=0,g=0,_=i(t.rasterViews);!(o=_()).done;){var m=o.value,y=m[0];if(m[1].attachmentType!==Ct.SHADING_RATE){var S=Mn.resourceGraph.getDesc(Mn.resourceGraph.vertex(y));v=S.width,g=S.height;break}}for(var E,w=(null==h?void 0:h.colorTextures.some((function(e){return!e||0===e.getTextureHandle()})))||d&&0===d.getTextureHandle(),D=v!==p||g!==f||null!==(a=null==h?void 0:h.needRebuild)&&void 0!==a&&a||w,T=i(t.rasterViews);!(E=T()).done;){var I=E.value,R=I[0],N=I[1],A=Mn.deviceTextures.get(R);A||(this.visitResource(R),A=Mn.deviceTextures.get(R));var P=Mn.resourceGraph,L=P.vertex(R),b=P.object(L),C=P.getDesc(L);if(A.framebuffer&&b instanceof ee&&(A.framebuffer!==b||b!==this._framebuffer))u=this._framebuffer=A.framebuffer=b;else if(A.texture&&D){var x=A.texture;x.resize(C.width,C.height),N.attachmentType===Ct.RENDER_TARGET?c.push(x):N.attachmentType===Ct.DEPTH_STENCIL&&(l=x)}}this._createFramebuffer(u,c,l)},s(e,[{key:"indexOfRD",get:function(){return this._idxOfRenderData}},{key:"rasterID",get:function(){return this._rasterID}},{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"clearColor",get:function(){return this._clearColor}},{key:"clearDepth",get:function(){return this._clearDepth}},{key:"clearStencil",get:function(){return this._clearStencil}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"viewport",get:function(){return this._viewport}}]),e}(),sa=function(){function e(){this._id=void 0,this._pass=void 0}return e.prototype.applyInfo=function(e,t){this._id=e,this._pass=t},s(e,[{key:"id",get:function(){return this._id}},{key:"pass",get:function(){return this._pass}}]),e}(),na=function(){function e(e){this._deviceQueues=[],this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._computeInfo=void 0,this._layout=null,this._computeInfo=e,this._layoutName=Mn.renderGraph.getLayout(e.id),this._passID=Et.rendering.getPassID(this._layoutName);for(var t,r=i(e.pass.computeViews);!(t=r()).done;){var s=t.value,n=Mn.deviceTextures.get(s[0]);n||(this.visitResource(s[0]),n=Mn.deviceTextures.get(s[0])),this._applyRenderLayout(s)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}var t=e.prototype;return t.preRecord=function(){Mn.passDescriptorSet=Yi(this.layoutName).descriptorSet},t.postRecord=function(){},t.visitResource=function(e){var t=Mn.resourceGraph,r=t.vertex(e);ra.resName=e,t.visitVertex(ra,r)},t.addQueue=function(e){this._deviceQueues.push(e)},t._applyRenderLayout=function(e){var t=Mn.renderGraph.getLayout(this._computeInfo.id);if(t){var r=Mn.layoutGraph,i=r.locateChild(r.N,t);4294967295!==i&&(this._layout=new $n(i,this._computeInfo.id,e))}},t.getGlobalDescData=function(){var e=Mn.layoutGraph.locateChild(Mn.layoutGraph.N,"default");return Mn.layoutGraph.getLayout(e).getSet(Dt.PER_PASS)},t.record=function(){var e=Mn.commandBuffer;Mn.passDescriptorSet&&e.bindDescriptorSet(ht.GLOBAL,Mn.passDescriptorSet);for(var t,r=i(this._deviceQueues);!(t=r()).done;)t.value.record();Ki(Mn.renderGraph.getData(this._computeInfo.id),-1,0,Mn.renderGraph.getLayout(this._computeInfo.id))},t.resetResource=function(e,t){this._computeInfo.applyInfo(e,t),this._layoutName=Mn.renderGraph.getLayout(e),this._passID=Et.rendering.getPassID(this._layoutName),this._deviceQueues.length=0;for(var r,s=i(this._computeInfo.pass.computeViews);!(r=s()).done;){var n=r.value;this._applyRenderLayout(n)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()},s(e,[{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"computePassInfo",get:function(){return this._computeInfo}}]),e}(),aa=new w,oa=function(){function e(){this._currentQueue=void 0,this._renderPass=void 0,this._scene=null,this._camera=null,this._sceneData=void 0,this._blit=void 0,this._sceneID=-1}var t=e.prototype;return t.preRecord=function(){this._blit&&0===this._blit.blitType&&(this._currentQueue.createBlitDesc(this._blit),this._currentQueue.blitDesc.update()),Mn.lightResource.buildLightBuffer(Mn.commandBuffer),Mn.lightResource.tryUpdateRenderSceneLocalDescriptorSet(Mn.culling)},t.postRecord=function(){},t.init=function(e,t,r,i){this._currentQueue=e,this._sceneData=r,this._blit=i,this._sceneID=t,this._renderPass=e.devicePass.renderPass;var s=r&&r.camera?r.camera:i&&i.camera?i.camera:null;s&&(this._scene=s.scene,this._camera=s)},t._record3D=function(){for(var e,t=this._blit,r=Mn.device,s=Mn.commandBuffer,n=i(t.models);!(e=n()).done;)for(var a,o=e.value,u=i(o.subModels);!(a=u()).done;)for(var c=a.value,h=c.inputAssembler,d=c.passes.length,l=0;l<d;++l){var p=c.passes[l],f=c.shaders[l],v=ct.getOrCreatePipelineState(r,p,f,this._renderPass,h);s.bindPipelineState(v),s.bindDescriptorSet(ht.MATERIAL,p.descriptorSet),s.bindDescriptorSet(ht.LOCAL,c.descriptorSet),s.bindInputAssembler(h),s.draw(h)}},t._recordUI=function(){for(var e=this.camera.scene.batches,t=0;t<e.length;t++){var r=e[t],i=!1;if(this.camera.visibility&r.visFlags&&(i=!0),i)for(var s=r.shaders.length,n=0;n<s;n++){var a=r.passes[n];if(a.phaseID===this._currentQueue.phaseID){var o=r.shaders[n],u=r.inputAssembler,c=r.descriptorSet;Cs(Mn.commandBuffer,this._renderPass,a,c,o,u)}}}},t._showProfiler=function(){var e=ta,t=Mn.pipeline.profiler;if(t&&t.enabled&&Mn.passShowStatistics){var r=Mn.profilerDescriptorSet,i=this._renderPass,s=Mn.commandBuffer,n=t.subModels[0],a=n.passes[0],o=n.inputAssembler;ea.width=e.width,ea.height=e.height,s.setViewport(ea),s.setScissor(e),s.bindDescriptorSet(ht.GLOBAL,r),Cs(s,i,a,n.descriptorSet,n.shaders[0],o)}},t._recordBlit=function(){if(this.blit){var e=this.blit,t=e.material.passes[e.passID];t.update();var r=t.getShaderVariant(),i=this._currentQueue.blitDesc,s=i.screenQuad.quadIA;Cs(Mn.commandBuffer,this._renderPass,t,i.stageDesc,r,s)}},t._updateGlobal=function(e,t){var r=this._currentQueue.devicePass;r.addIdxOfRD(),Ki(e,t,r.indexOfRD,Mn.renderGraph.getLayout(r.rasterID))},t._updateRenderData=function(){var e;if(!this._currentQueue.isUpdateUBO){var t=this._currentQueue.devicePass,r=t.rasterID,i=Mn.renderGraph.getData(r),s=this.sceneID;this._updateGlobal(Mn.renderGraph.globalRenderData,s),this._updateGlobal(i,s);var n=this._currentQueue.queueId,a=Mn.renderGraph.getData(n);this._updateGlobal(a,s);var o=Mn.renderGraph.getData(s);o&&this._updateGlobal(o,s),t.processRenderLayout(),null==(e=Mn.passDescriptorSet)||e.update(),this._currentQueue.isUpdateUBO=!0}},t._applyViewport=function(){var e=this._currentQueue.viewport;if(e)Mn.commandBuffer.setViewport(e),Mn.commandBuffer.setScissor(this._currentQueue.scissor);else if(!this._currentQueue.devicePass.viewport){var t=this._currentQueue.devicePass.framebuffer.colorTextures[0],r=this.sceneData?this.sceneData.light:null,i=Wn(this.sceneData)&&this.sceneData&&r.light?Mi(this.camera,t.width,t.height,r.light,r.level):Mi(this.camera,t.width,t.height);aa.left=i.x,aa.top=i.y,aa.width=i.width,aa.height=i.height,Mn.commandBuffer.setViewport(aa),Mn.commandBuffer.setScissor(i)}},t.record=function(){var e=this._currentQueue.devicePass,t=Mn.culling;if(this._updateRenderData(),this._applyViewport(),this.blit)switch(this.blit.blitType){case 0:this._recordBlit();break;case 1:this._recordUI();break;case 2:this._showProfiler();break;case 3:this._record3D()}else{var r,i=t.renderQueueQueryIndex.get(this.sceneID),s=t.renderQueues[i.renderQueueTarget],n=this.sceneData,a=hs(n.flags&At.REFLECTION_PROBE);a&&s.probeQueue.applyMacro(),s.recordCommands(Mn.commandBuffer,this._renderPass,n.flags),a&&s.probeQueue.removeMacro(),n.flags&At.GEOMETRY&&(null==(r=this.camera.geometryRenderer)||r.render(e.renderPass,Mn.commandBuffer,Mn.pipeline.pipelineSceneData))}},s(e,[{key:"blit",get:function(){return this._blit}},{key:"sceneData",get:function(){return this._sceneData}},{key:"sceneID",get:function(){return this._sceneID}},{key:"camera",get:function(){return this._camera}}]),e}(),ua=function(){function e(){this.deviceQueuePool=void 0,this.computeQueuePool=void 0,this.passPool=void 0,this.deviceScenePool=void 0,this.deviceQueuePool=new r((function(){return new Jn}),16),this.deviceScenePool=new r((function(){return new oa}),16),this.computeQueuePool=new r((function(){return new Zn}),16),this.passPool=new r((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64)}var t=e.prototype;return t.addDeviceQueue=function(){return this.deviceQueuePool.add()},t.addComputeQueue=function(){return this.computeQueuePool.add()},t.addDeviceScene=function(){return this.deviceScenePool.add()},t.reset=function(){this.deviceQueuePool.reset(),this.computeQueuePool.reset(),this.deviceScenePool.reset()},e}(),ca=new G,ha=function(){function e(e){this._pipelineIAData=void 0,this._context=void 0,this._width=void 0,this._height=void 0,this._lightVolumeBuffer=void 0,this._lightBufferData=void 0,this._deferredLitsBufView=void 0,this._localUBO=void 0,this._stageDescs=new Map,this._context=e,this._width=e.width,this._height=e.height,this._pipelineIAData=this._createQuadInputAssembler();var t=this._genQuadVertexData(te.IDENTITY,new G(0,0,e.width,e.height));this._pipelineIAData.quadVB.update(t),this._createLightVolumes();var r=gt.SIZE;this._localUBO=e.device.createBuffer(new U(k.UNIFORM|k.TRANSFER_DST,H.DEVICE,r,r))}var t=e.prototype;return t.resize=function(e,t){if(e!==this._width||t!==this._height){ca.y=ca.x=0,ca.width=e,ca.height=t;var r=this._genQuadVertexData(te.IDENTITY,ca);this._pipelineIAData.quadVB.update(r)}},t._createLightVolumes=function(){var e=this._context.root.device,t=20*Float32Array.BYTES_PER_ELEMENT*vt.LIGHTS_PER_PASS;t=Math.ceil(t/e.capabilities.uboOffsetAlignment)*e.capabilities.uboOffsetAlignment,this._lightVolumeBuffer=e.createBuffer(new U(k.UNIFORM|k.TRANSFER_DST,H.HOST|H.DEVICE,t,e.capabilities.uboOffsetAlignment)),this._deferredLitsBufView=e.createBuffer(new K(this._lightVolumeBuffer,0,t)),this._lightBufferData=new Float32Array(t/Float32Array.BYTES_PER_ELEMENT)},t._genQuadVertexData=function(e,t){var r=t.x/this._context.width,i=(t.x+t.width)/this._context.width,s=t.y/this._context.height,n=(t.y+t.height)/this._context.height;if(this._context.root.device.capabilities.screenSpaceSignY>0){var a=[n,s];s=a[0],n=a[1]}var o=new Float32Array(16),u=function(e,t,r,i,s,n,a,u,c,h,d,l,p,f,v,g){o.set([e,t,r,i,s,n,a,u,c,h,d,l,p,f,v,g])};switch(e){case te.IDENTITY:u(-1,-1,r,n,1,-1,i,n,-1,1,r,s,1,1,i,s);break;case te.ROTATE_90:u(-1,-1,i,n,1,-1,i,s,-1,1,r,n,1,1,r,s);break;case te.ROTATE_180:u(-1,-1,r,s,1,-1,i,s,-1,1,r,n,1,1,i,n);break;case te.ROTATE_270:u(-1,-1,r,s,1,-1,r,n,-1,1,i,s,1,1,i,n)}return o},t._createQuadInputAssembler=function(){var e=new St,t=4*Float32Array.BYTES_PER_ELEMENT,r=4*t,i=Et.director.root.device,s=i.createBuffer(new U(k.VERTEX|k.TRANSFER_DST,H.DEVICE|H.HOST,r,t));if(!s)return e;var n=Uint16Array.BYTES_PER_ELEMENT,a=6*n,o=i.createBuffer(new U(k.INDEX|k.TRANSFER_DST,H.DEVICE,a,n));if(!o)return e;var u=new Uint16Array(6);u[0]=0,u[1]=1,u[2]=2,u[3]=1,u[4]=3,u[5]=2,o.update(u.buffer);var c=new Array(2);c[0]=new re("a_position",_.RG32F),c[1]=new re("a_texCoord",_.RG32F);var h=i.createInputAssembler(new ie(c,[s],o));return e.quadIB=o,e.quadVB=s,e.quadIA=h,e},s(e,[{key:"pipelineIAData",get:function(){return this._pipelineIAData}},{key:"deferredLitsBufView",get:function(){return this._deferredLitsBufView}},{key:"lightVolumeBuffer",get:function(){return this._lightVolumeBuffer}},{key:"lightBufferData",get:function(){return this._lightBufferData}},{key:"stageDescs",get:function(){return this._stageDescs}},{key:"emptyLocalUBO",get:function(){return this._localUBO}}]),e}(),da=function(){function e(e,t,r,i,s,n,a,o){void 0===o&&(o=null),this.device=void 0,this.pipeline=void 0,this.commandBuffer=void 0,this.pipelineSceneData=void 0,this.resourceGraph=void 0,this.devicePasses=new Map,this.deviceTextures=new Map,this.deviceBuffers=new Map,this.layoutGraph=void 0,this.root=void 0,this.pools=void 0,this.blit=void 0,this.culling=void 0,this.lightResource=new kn,this.renderGraph=void 0,this.width=void 0,this.height=void 0,this.cullCamera=void 0,this.passDescriptorSet=void 0,this.profilerDescriptorSet=void 0,this.passShowStatistics=!1,this.pipeline=e,this.device=t,this.commandBuffer=t.commandBuffer,this.pipelineSceneData=e.pipelineSceneData,this.resourceGraph=r,this.renderGraph=i,this.root=wt.director.root,this.layoutGraph=s,this.width=n,this.height=a,this.pools=new ua,this.blit=new ha(this),this.culling=new Un,this.passDescriptorSet=o,this.profilerDescriptorSet=Yi("default").descriptorSet}var t=e.prototype;return t.reset=function(){this.culling.clear(),this.pools.reset(),this.cullCamera=null,this.lightResource.clear(),this.passShowStatistics=!1},t.resize=function(e,t){this.width=e,this.height=t,this.blit.resize(e,t)},e}(),la=function(){function e(e,t,r,i,s,n){this._context=void 0,this._visitor=void 0,Mn=this._context=new da(e,t,r,new Wr,i,s,n);var a=Et.rendering.programLib;Mn.lightResource.init(a,t,16)}var t=e.prototype;return t.resize=function(e,t){Mn.resize(e,t)},t._removeDeviceResource=function(){for(var e,t=Mn.pipeline.resourceUses,r=[],s=Mn.deviceTextures,n=i(s);!(e=n()).done;){var a=e.value,o=a[0];a[1];var u=Mn.resourceGraph.vertex(o),c=Mn.resourceGraph.getTraits(u);t.includes(o)||c.residency!==Tt.MANAGED||r.push(o)}for(var h=0,d=r;h<d.length;h++){var l=d[h];s.get(l).release(),s.delete(l)}for(var p,f=[],v=Mn.deviceBuffers,g=i(v);!(p=g()).done;){var _=p.value,m=_[0];_[1];var y=Mn.resourceGraph.vertex(m),S=Mn.resourceGraph.getTraits(y);t.includes(m)||S.residency!==Tt.MANAGED||f.push(m)}for(var E=0,w=f;E<w.length;E++){var D=w[E];v.get(D).release(),v.delete(D)}t.length=0},t.execute=function(e){Mn.renderGraph=e,Mn.reset();var t=Mn.commandBuffer,r=Mn.culling;r.buildRenderQueues(e,Mn.layoutGraph,Mn.pipelineSceneData),Mn.lightResource.buildLights(r,Mn.pipelineSceneData.isHDR,Mn.pipelineSceneData.shadows),this._removeDeviceResource(),t.begin(),r.uploadInstancing(t),this._visitor||(this._visitor=new ga),sr(this._visitor.graphView,this._visitor,this._visitor.colorMap),t.end(),Mn.device.queue.submit([t])},t.release=function(){Mn.devicePasses.clear();for(var e,t=i(Mn.deviceTextures);!(e=t()).done;){var r=e.value;r[0],r[1].release()}Mn.deviceTextures.clear();for(var s,n=i(Mn.deviceBuffers);!(s=n()).done;){var a=s.value;a[0],a[1].release()}Mn.deviceBuffers.clear()},e}(),pa=function(){function e(){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.currPass=void 0,this.currQueue=void 0,this.rg=void 0,this.rg=Mn.renderGraph}var t=e.prototype;return t._isRasterPass=function(e){return Mn.renderGraph.h(0,e)},t.isComputePass=function(e){return Mn.renderGraph.h(3,e)},t.isDispatch=function(e){return Mn.renderGraph.h(11,e)},t._isQueue=function(e){return Mn.renderGraph.h(8,e)},t._isScene=function(e){return Mn.renderGraph.h(9,e)},t._isBlit=function(e){return Mn.renderGraph.h(Qr,e)},t.applyID=function(e){this._isRasterPass(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this.isComputePass(e)?this.passID=e:this.isDispatch(e)&&(this.dispatchID=e)},e}(),fa=function(e){function t(){return e.call(this)||this}u(t,e);var r=t.prototype;return r.clear=function(){},r.viewport=function(){},r.rasterPass=function(e){if(this.rg.getValid(this.passID)){var t=Mn.devicePasses,r=e.hashValue;this.currPass=t.get(r),this.currPass?this.currPass.resetResource(this.passID,e):(this.currPass=new ia(this.passID,e),t.set(r,this.currPass)),this.currPass.preRecord()}},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.resolve=function(){},r.move=function(){},r.raytrace=function(){},r.compute=function(e){if(this.rg.getValid(this.passID)){Mn.devicePasses;var t=new sa;t.applyInfo(this.passID,e),this.currPass=new na(t),this.currPass.preRecord(),this.currPass.record()}},r.copy=function(e){if(e.uploadPairs.length)for(var t,r=i(e.uploadPairs);!(t=r()).done;){var s=t.value,n=Mn.deviceBuffers,a=Mn.resourceGraph,o=a.vertex(s.target);ra.resName=s.target,a.visitVertex(ra,o);var u=n.get(s.target);Mn.device.commandBuffer.updateBuffer(u.buffer,s.source,s.source.byteLength)}},r.queue=function(e){if(this.rg.getValid(this.queueID)){var t;this.currPass instanceof ia?((t=Mn.pools.addDeviceQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t)):((t=Mn.pools.addComputeQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t));var r=this.rg.getLayout(this.queueID);if(r){var i=Mn.layoutGraph;if(this.currPass.renderLayout){var s=i.locateChild(this.currPass.renderLayout.layoutID,r);this.currQueue.layoutID=s}}this.currQueue.preRecord()}},r.scene=function(e){this.rg.getValid(this.sceneID)&&this.currQueue.setScene(this.sceneID,e).preRecord()},r.blit=function(e){this.rg.getValid(this.sceneID)&&this.currQueue.setScene(this.sceneID,void 0,e).preRecord()},r.dispatch=function(e){var t,r=null,i=this.currPass,s=null==(t=e.material)?void 0:t.passes[e.passID];null==s||s.update();var n=null==s?void 0:s.getShaderVariant();if(null!==s&&null!==n){var a=new se(n,null==s?void 0:s.pipelineLayout);a.bindPoint=ne.COMPUTE,r=v.gfxDevice.createPipelineState(a)}var o=Mn.commandBuffer;if(r){o.bindPipelineState(r);var u=i.renderLayout.descriptorSet;o.bindDescriptorSet(ht.GLOBAL,u)}var c=e.threadGroupCountX,h=e.threadGroupCountY,d=e.threadGroupCountZ;o.dispatch(new ae(c,h,d))},t}(pa),va=function(e){function t(){return e.call(this)||this}u(t,e);var r=t.prototype;return r.clear=function(){},r.viewport=function(){},r.rasterPass=function(e){var t=Mn.devicePasses,r=e.hashValue,i=t.get(r);i&&(this.currPass=i,Mn.passShowStatistics=e.showStatistics,this.currPass.record())},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.resolve=function(){},r.compute=function(){},r.copy=function(){},r.move=function(){},r.raytrace=function(){},r.queue=function(){},r.scene=function(){},r.blit=function(){},r.dispatch=function(){},t}(pa),ga=function(e){function t(){var t;return(t=e.call(this)||this)._preVisitor=void 0,t._postVisitor=void 0,t._graphView=void 0,t._colorMap=void 0,t._preVisitor=new fa,t._postVisitor=new va,t._graphView=new ar(Mn.renderGraph),t._colorMap=new Pi(Mn.renderGraph.nv()),t}u(t,e);var r=t.prototype;return r.discoverVertex=function(e,t){var r=t.g;this._preVisitor.applyID(e),r.visitVertex(this._preVisitor,e)},r.finishVertex=function(e,t){t.g.visitVertex(this._postVisitor,e)},s(t,[{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(nr),_a=new Map,ma=function(){function e(e){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.resID=4294967295,this.context=void 0,this._currPass=null,this._resVisitor=void 0,this.context=e,this._resVisitor=new Sa(this.context)}var t=e.prototype;return t._isRasterPass=function(e){return this.context.renderGraph.h(0,e)},t._isCopyPass=function(e){return this.context.renderGraph.h(5,e)},t._isCompute=function(e){return this.context.renderGraph.h(3,e)},t._isDispatch=function(e){return this.context.renderGraph.h(11,e)},t._isQueue=function(e){return this.context.renderGraph.h(8,e)},t._isShadowMap=function(e){var t=this._getSceneData(e);return!!t&&t.light&&!!t.light.light&&!!(t.flags&At.SHADOW_CASTER)},t._getSceneData=function(e){return this.context.renderGraph.h(9,e)?this.context.renderGraph.j(e):null},t._isScene=function(e){return this.context.renderGraph.h(9,e)},t._isBlit=function(e){return this.context.renderGraph.h(Qr,e)},t._useResourceInfo=function(e,t){var r=this.context.resourceContext,s=r.get(e),n=this.context.resourceGraph;if(s){var a=s.rasters;if(a.get(this.passID)===t)return;for(var o,u=s.computes,c=i(a);!(o=c()).done;){var h=o.value;h[0],h[1],this.passID}for(var d,l=i(u);!(d=l()).done&&!(d.value[0]>this.passID););a.set(this.passID,t)}else{var p=n.vertex(e);n.getTraits(p).residency,Tt.PERSISTENT;var f=new Ea;r.set(e,f),f.rasters.set(this.passID,t)}},t._fetchValidPass=function(){var e=this.context.renderGraph,t=this.context.resourceContext,r=this.resID,s=this.context.resourceGraph.vertexName(r);_a.clear();for(var n,a=this._currPass,o=e.getValid(this.passID),u=i(a.rasterViews);!(n=u()).done;){var c=n.value,h=c[0],d=c[1];h!==s||d.accessType===Lt.READ?d.accessType!==Lt.WRITE&&_a.set(h,d):(this._useResourceInfo(h,d),e.setValid(this.passID,!0),e.setValid(this.queueID,!0),e.setValid(this.sceneID,!0))}if(!o&&e.getValid(this.sceneID)){for(var l,p=i(a.rasterViews);!(l=p()).done;){var f=l.value,v=f[0];f[1],Ta.pipeline.resourceUses.push(v)}for(var g,_,m,y=i(_a);!(m=y()).done;){var S=m.value,E=S[0];S[1],4294967295!==(_=(g=this.context.resourceGraph).find(E))&&(this._resVisitor.resID=_,g.visitVertex(this._resVisitor,_))}for(var w,D=i(a.computeViews);!(w=D()).done;){var T=w.value,I=T[0],R=T[1],N=t.get(I);N||(N=new Ea,t.set(I,N));var A=N.computes,P=A.get(this.passID);P?P.push(R):A.set(this.passID,[R]),4294967295!==(_=(g=this.context.resourceGraph).find(I))&&(this._resVisitor.resID=_,g.visitVertex(this._resVisitor,_))}ls(a)}},t.applyID=function(e,t){this.resID=t,this._isRasterPass(e)||this._isCopyPass(e)||this._isCompute(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this._isDispatch(e)&&(this.dispatchID=e)},t.rasterPass=function(e){this._currPass=e},t.rasterSubpass=function(){},t.computeSubpass=function(){},t.compute=function(e){this._currPass=e,Ta.renderGraph.setValid(this.passID,!0)},t.resolve=function(){},t.copy=function(e){var t=Ta.renderGraph;if(!t.getValid(this.passID)){var r=this.context.resourceGraph;this._currPass=e;for(var s,n,a=this.resID,o=r.vertexName(a),u=i(e.copyPairs);!(n=u()).done;){var c=n.value;c.target===o&&(t.setValid(this.passID,!0),4294967295!==(s=r.find(c.source))&&(this._resVisitor.resID=s,r.visitVertex(this._resVisitor,s)))}}},t.move=function(){},t.raytrace=function(){},t.queue=function(){},t.scene=function(){this._fetchValidPass()},t.blit=function(){this._fetchValidPass()},t.dispatch=function(){var e=this.context.renderGraph;e.setValid(this.queueID,!0),e.setValid(this.dispatchID,!0)},t.clear=function(){},t.viewport=function(){},e}(),ya=function(e){function t(t,r){var i;return(i=e.call(this)||this)._colorMap=void 0,i._graphView=void 0,i._passVisitor=void 0,i._resId=4294967295,i._resId=r,i._passVisitor=new ma(t),i._graphView=new ar(t.renderGraph),i._colorMap=new Pi(t.renderGraph.nv()),i}return u(t,e),t.prototype.discoverVertex=function(e,t){var r=t.g;this._passVisitor.applyID(e,this.resId),r.visitVertex(this._passVisitor,e)},s(t,[{key:"resId",get:function(){return this._resId},set:function(e){this._resId=e,this._colorMap.colors.length=Ta.renderGraph.nv()}},{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(nr),Sa=function(){function e(e){this._context=void 0,this.resID=4294967295,this._passManagerVis=void 0,this._context=e}var t=e.prototype;return t.managedBuffer=function(){},t.managedTexture=function(){},t.managed=function(){this.dependency()},t.persistentBuffer=function(){},t.dependency=function(){this._passManagerVis?this._passManagerVis.resId=this.resID:this._passManagerVis=new ya(this._context,this.resID),sr(this._passManagerVis.graphView,this._passManagerVis,this._passManagerVis.colorMap)},t.persistentTexture=function(){this.dependency()},t.framebuffer=function(){this.dependency()},t.swapchain=function(){this.dependency()},t.formatView=function(){},t.subresourceView=function(){},e}(),Ea=function(){this.rasters=new Map,this.computes=new Map},wa=function(){function e(){this.resourceGraph=void 0,this.pipeline=void 0,this.renderGraph=void 0,this.layoutGraph=void 0,this.resourceContext=void 0}return e.prototype.set=function(e,t,r,i){this.pipeline=e,this.resourceGraph=t,this.renderGraph=r,this.layoutGraph=i,this.resourceContext||(this.resourceContext=new Map),this.resourceContext.clear()},e}(),Da=function(){function e(e,t,r,i){this._resourceGraph=void 0,this._pipeline=void 0,this._layoutGraph=void 0,this._visitor=void 0,this._pipeline=e,this._resourceGraph=r,this._layoutGraph=i,Ta.set(this._pipeline,this._resourceGraph,t,this._layoutGraph),this._visitor=new Ia(Ta)}return e.prototype.compile=function(e){Ta.set(this._pipeline,this._resourceGraph,e,this._layoutGraph),Ta.pipeline.resourceUses.length=0,this._visitor.colorMap.colors.length=Ta.resourceGraph.nv(),sr(this._resourceGraph,this._visitor,this._visitor.colorMap)},e}(),Ta=new wa,Ia=function(e){function t(t){var r;return(r=e.call(this)||this)._colorMap=void 0,r._resourceGraph=void 0,r._resVisitor=void 0,r._colorMap=new Pi(t.resourceGraph.nv()),r._resourceGraph=t.resourceGraph,r._resVisitor=new Sa(t),r}return u(t,e),t.prototype.discoverVertex=function(e){var t=this._resourceGraph.getTraits(e);t.residency!==Tt.MANAGED&&t.residency!==Tt.MEMORYLESS&&(this._resVisitor.resID=e,this._resourceGraph.visitVertex(this._resVisitor,e))},s(t,[{key:"colorMap",get:function(){return this._colorMap}}]),t}(nr),Ra=new Re,Na=new de(le.POINT,le.POINT,le.NONE,pe.CLAMP,pe.CLAMP,pe.CLAMP),Aa=function(){function e(){var e=this;this.renderData=new Hr,this.layoutGraph=new vi,this.rg=new Wr,this.vertId=-1,this.sceneData=new Fr,this.resourceGraph=new br,this.computePass=new Cr,this.rasterPass=new Rr,this.rasterSubpass=new Tr,this.renderQueue=new Vr,this.sceneBuilder=new r((function(){return new xa(e.renderData,e.layoutGraph,e.rg,e.vertId,e.sceneData)}),16),this.renderPassBuilder=new r((function(){return new Ga(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.rasterPass,e.getPipelineSceneData())}),16),this.computeQueueBuilder=new r((function(){return new Ma(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderQueueBuilder=new r((function(){return new Ba(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderSubpassBuilder=new r((function(){return new Oa(e.renderData,e.rg,e.layoutGraph,e.vertId,e.rasterSubpass,e.getPipelineSceneData())}),16),this.computePassBuilder=new r((function(){return new Va(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.computePass,e.getPipelineSceneData())}),16),this.samplerInfo=new r((function(){return new de}),16),this.color=new r((function(){return new N}),16),this.renderCommonObjectPool=new Wt,this.renderGraphPool=new Yr(this.renderCommonObjectPool),this.viewport=new r((function(){return new w}),16)}var t=e.prototype;return t.getPipelineSceneData=function(){return wt.director.root.pipeline.pipelineSceneData},t.createColor=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this.color.add();return s.set(e,t,r,i),s},t.createSamplerInfo=function(e,t,r,i,s,n,a,o){void 0===e&&(e=le.LINEAR),void 0===t&&(t=le.LINEAR),void 0===r&&(r=le.NONE),void 0===i&&(i=pe.WRAP),void 0===s&&(s=pe.WRAP),void 0===n&&(n=pe.WRAP),void 0===a&&(a=0),void 0===o&&(o=fe.ALWAYS);var u=this.samplerInfo.add();return u.minFilter=e,u.magFilter=t,u.mipFilter=r,u.addressU=i,u.addressV=s,u.addressW=n,u.maxAnisotropy=a,u.cmpFunc=o,u},t.reset=function(){this.sceneBuilder.reset(),this.renderPassBuilder.reset(),this.computePassBuilder.reset(),this.computeQueueBuilder.reset(),this.renderCommonObjectPool.reset(),this.renderGraphPool.reset(),this.viewport.reset(),this.samplerInfo.reset(),this.color.reset(),this.renderQueueBuilder.reset(),this.renderSubpassBuilder.reset()},e}();function Pa(e,t){switch(e){case Rt.TEXTURE1D:return t>1?S.TEX1D_ARRAY:S.TEX1D;case Rt.TEXTURE2D:return t>1?S.TEX2D_ARRAY:S.TEX2D;case Rt.TEXTURE3D:return S.TEX3D;case Rt.BUFFER:return S.TEX2D}return S.TEX2D}function La(e){switch(e){case S.TEX1D:case S.TEX1D_ARRAY:return Rt.TEXTURE1D;case S.TEX2D:case S.TEX2D_ARRAY:case S.CUBE:return Rt.TEXTURE2D;case S.TEX3D:return Rt.TEXTURE3D}return Rt.TEXTURE2D}var ba=new Ke,Ca=new Hr,xa=function(e){function t(t,r,i,s,n){var a;return(a=e.call(this,t,r)||this)._renderGraph=void 0,a._scene=void 0,a._renderGraph=i,a._scene=n,a._vertID=s,a}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s){this._data=e,this._lg=t,this._renderGraph=r,this._scene=s,this._vertID=i},r.useLightFrustum=function(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=void 0),this._scene.light.light=e,this._scene.light.level=t,this._scene.light.culledByLight=!0,r&&(this._scene.camera=r),!(this._scene.flags&At.NON_BUILTIN)){var i=this._renderGraph.getParent(this._vertID),s=this._renderGraph.getParent(i);this._renderGraph.getLayout(s),Is(this,this._scene.camera,e,t)}},t}(As),Ba=function(e){function t(t,r,i,s,n,a){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=n,o._pipeline=a,o}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,n){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=n},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addSceneOfCamera=function(e,t,r){void 0===r&&(r=At.NONE);var i=t.light;this.addScene(e,r,i)},r.addScene=function(e,t,r,i){void 0===t&&(t=At.NONE),void 0===r&&(r=null),void 0===i&&(i=void 0);var s=qn.createSceneData(i||e.scene,e,t,!r||t&At.SHADOW_CASTER?1:5,r),n=qn.createRenderData(),a=this._renderGraph.addVertex(9,s,"Scene","",n,!f,this._vertID);t&At.NON_BUILTIN||(this.getParentLayout(),ys(this,e,this._pipeline,i||e.scene),r&&r.type!==Ge.DIRECTIONAL?Is(this,e,r,0):t&At.SHADOW_CASTER||Ns(this,e));var o=this._renderGraph.getParent(this._vertID);if(t&At.UI){var u=this._renderGraph.addVertex(8,this._queue,"UI Queue","default",this._data,!f,o);this._renderGraph.addVertex(Qr,qn.createBlit(ba,this._renderGraph.N,At.NONE,e,1),"UI","",Ca,!f,u)}t&At.PROFILER&&this.addProfiler(e);var c=jn.sceneBuilder.add();return c.update(n,this._lg,this._renderGraph,a,s),c},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=At.NONE),void 0===i&&(i="Quad"),this._renderGraph.addVertex(Qr,qn.createBlit(e,t,r,null),i,"",qn.createRenderData(),!f,this._vertID),this.getParentLayout();var s=Et.director.getScene();ys(this,null,this._pipeline,s?s.renderScene:null),r&At.SHADOW_CASTER||Ns(this,null)},r.addCameraQuad=function(e,t,r,i){void 0===i&&(i=At.NONE),this._renderGraph.addVertex(Qr,qn.createBlit(t,r,i,e),"CameraQuad","",qn.createRenderData(),!f,this._vertID),this.getParentLayout();var s=Et.director.getScene();ys(this,e,this._pipeline,e.scene||(s?s.renderScene:null)),i&At.SHADOW_CASTER||Ns(this,e)},r.addDraw3D=function(e,t,r){void 0===r&&(r=At.NON_BUILTIN);for(var s,n=qn.createBlit(ba,this._renderGraph.N,At.NONE,e,3),a=i(t);!(s=a()).done;){var o=s.value;n.models.push(o)}this._renderGraph.addVertex(Qr,n,"Draw3D","",qn.createRenderData(),!f,this._vertID),r&At.NON_BUILTIN||(this.getParentLayout(),ys(this,e,this._pipeline,e.scene),r&At.SHADOW_CASTER||Ns(this,e))},r.addDraw2D=function(e){this.getParentLayout(),ys(this,e,this._pipeline,e.scene),this._renderGraph.addVertex(Qr,qn.createBlit(ba,this._renderGraph.N,At.NONE,e,1),"Draw2D","",Ca,!f,this._vertID)},r.addProfiler=function(e){var t=this._renderGraph.getParent(this._vertID),r=this._renderGraph.addVertex(8,this._queue,"UI Queue","default",this._data,!f,t),i=this._renderGraph.addVertex(Qr,qn.createBlit(ba,this._renderGraph.N,At.NONE,e,2),"Profiler","",Ca,!f,r),s=this._renderGraph.getData(i);As.setMat4(this._lg,s,"cc_matProj",e.matProj)},r.clearRenderTarget=function(e,t){void 0===t&&(t=new N);var r=qn.createClearView(e,I.COLOR);r.clearColor.copy(t),this._renderGraph.addVertex(12,[r],"ClearRenderTarget","",qn.createRenderData(),!f,this._vertID)},r.setViewport=function(e){var t=jn.viewport.add();this._queue.viewport=t.copy(e)},r.addCustomCommand=function(){throw new Error("Method not implemented.")},s(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(As),Oa=function(e){function t(t,r,i,s,n,a){var o;(o=e.call(this,t,i)||this)._renderGraph=void 0,o._layoutID=void 0,o._subpass=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._subpass=n,o._pipeline=a;var u=o._renderGraph.getLayout(o._vertID);return o._layoutID=i.locateChild(i.N,u),o}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,n){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._subpass=s,this._pipeline=n;var a=this._renderGraph.getLayout(this._vertID);this._layoutID=r.locateChild(r.N,a)},r.addRenderTarget=function(){throw new Error("Method not implemented.")},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDepthStencil=function(e,t,r,i,s,n,a,o,u){throw void 0===s&&(s=D.CLEAR),void 0===n&&(n=T.STORE),void 0===u&&(u=I.DEPTH_STENCIL),new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(){throw new Error("Method not implemented.")},r.addStorageImage=function(){throw new Error("Method not implemented.")},r.setViewport=function(){throw new Error("Method not implemented.")},r.addQueue=function(e,t){void 0===e&&(e=It.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=qn.createRenderQueue(e,r),s=qn.createRenderData(),n=this._renderGraph.addVertex(8,i,"",t,s,!f,this._vertID),a=jn.renderQueueBuilder.add();return a.update(s,this._renderGraph,this._lg,n,i,this._pipeline),a},s(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._subpass.showStatistics},set:function(e){this._subpass.showStatistics=e}}]),t}(As),Ga=function(e){function t(t,r,i,s,n,a,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._resourceGraph=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=n,u._pass=a,u._pipeline=o;var c=u._renderGraph.getLayout(u._vertID);return u._layoutID=i.locateChild(i.N,c),u}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,n,a){this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=n,this._pipeline=a,this._data=e;var o=this._renderGraph.getLayout(this._vertID);this._layoutID=r.locateChild(r.N,o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.setVersion=function(e,t){this._pass.versionName=e,this._pass.version=t},r.addRenderTarget=function(e,t,r,i){void 0===t&&(t=D.CLEAR),void 0===r&&(r=T.STORE),void 0===i&&(i=new N);var s=I.COLOR;t===D.LOAD&&(s=I.NONE);var n=qn.createRasterView("",Lt.WRITE,Ct.RENDER_TARGET,t,r,s);n.clearColor.copy(i),this._pass.rasterViews.set(e,n)},r.addDepthStencil=function(e,t,r,i,s,n){void 0===t&&(t=D.CLEAR),void 0===r&&(r=T.STORE),void 0===i&&(i=1),void 0===s&&(s=0),void 0===n&&(n=I.DEPTH_STENCIL);var a=qn.createRasterView("",Lt.WRITE,Ct.DEPTH_STENCIL,t,r,n);a.clearColor.set(i,s,0,0),this._pass.rasterViews.set(e,a)},r.resolveRenderTarget=function(){},r.resolveDepthStencil=function(){},r._addComputeResource=function(e,t,r){var i,s=qn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null==(i=this._pass.computeViews.get(e))||i.push(s):this._pass.computeViews.set(e,[s])},r.addTexture=function(e,t,r){if(void 0===r&&(r=null),this._addComputeResource(e,Lt.READ,t),r){var i=this._lg.attributeIndex.get(t);this._data.samplers.set(i,r)}},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addRenderSubpass=function(e){void 0===e&&(e="");var t="Raster",r=this._pass.subpassGraph.nv();this._pass.subpassGraph.addVertex(t,qn.createSubpass());var i=qn.createRasterSubpass(r,1,0),s=qn.createRenderData(),n=this._renderGraph.addVertex(1,i,t,e,s,!f),a=jn.renderSubpassBuilder.add();return a.update(s,this._renderGraph,this._lg,n,i,this._pipeline),a},r.addQueue=function(e,t){void 0===e&&(e=It.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=qn.createRenderQueue(e,r),s=qn.createRenderData(),n=this._renderGraph.addVertex(8,i,"",t,s,!f,this._vertID),a=jn.renderQueueBuilder.add();return a.update(s,this._renderGraph,this._lg,n,i,this._pipeline),a},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=At.NONE),void 0===i&&(i="FullscreenQuad");var s=qn.createRenderQueue(It.RENDER_TRANSPARENT),n=this._renderGraph.addVertex(8,s,"Queue","",qn.createRenderData(),!f,this._vertID);this._renderGraph.addVertex(Qr,qn.createBlit(e,t,r,null),i,"",qn.createRenderData(),!f,n)},r.addCameraQuad=function(e,t,r,i,s){void 0===s&&(s="CameraQuad");var n=qn.createRenderQueue(It.RENDER_TRANSPARENT),a=this._renderGraph.addVertex(8,n,"Queue","",qn.createRenderData(),!f,this._vertID);this._renderGraph.addVertex(Qr,qn.createBlit(t,r,i,e),s,"",qn.createRenderData(),!f,a)},r.setViewport=function(e){this._pass.viewport.copy(e)},s(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._pass.showStatistics},set:function(e){this._pass.showStatistics=e}}]),t}(As),Ma=function(e){function t(t,r,i,s,n,a){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=n,o._pipeline=a,o}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,n){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=n},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDispatch=function(e,t,r,i,s,n){void 0===i&&(i=null),void 0===s&&(s=0),void 0===n&&(n="Dispatch"),this._renderGraph.addVertex(11,qn.createDispatch(i,s,e,t,r),n,"",qn.createRenderData(),!f,this._vertID)},s(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(As),Va=function(e){function t(t,r,i,s,n,a,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._resourceGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=n,u._pass=a,u._pipeline=o;var c=u._renderGraph.getLayout(u._vertID);return u._layoutID=i.locateChild(i.N,c),u}u(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,n,a){this._data=e,this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=n,this._pipeline=a;var o=this._renderGraph.getLayout(this._vertID);this._layoutID=r.locateChild(r.N,o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addMaterialTexture=function(){throw new Error("Method not implemented.")},r.addQueue=function(e){void 0===e&&(e="default");var t=this._lg.locateChild(this._layoutID,e),r=qn.createRenderQueue(It.RENDER_OPAQUE,t),i=qn.createRenderData(),s=this._renderGraph.addVertex(8,r,"",e,i,!f,this._vertID),n=jn.computeQueueBuilder.add();return n.update(i,this._renderGraph,this._lg,s,r,this._pipeline),n},r._addComputeResource=function(e,t,r){var i,s=qn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null==(i=this._pass.computeViews.get(e))||i.push(s):this._pass.computeViews.set(e,[s])},s(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(As);!function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.setCustomBehavior=function(){throw new Error("Method not implemented.")},t.addPair=function(e){this._pass.movePairs.push(e)},s(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}(),function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.addPair=function(){throw new Error("Method not implemented.")},t.setCustomBehavior=function(){throw new Error("Method not implemented.")},s(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}();var Fa=function(e){function t(t){var r;return(r=e.call(this,new Hr,t)||this).globalDSManager=void 0,r.descriptorSetLayout=void 0,r.descriptorSet=void 0,r._width=0,r._height=0,r._usesDeferredPipeline=!1,r._copyPassMat=new Ke,r._device=void 0,r._defaultSampler=void 0,r._profilerDescriptorSet=null,r._macros={},r._pipelineSceneData=new ke,r._constantMacros="",r._lightingMode=bt.DEFAULT,r._profiler=null,r._cameras=[],r._resourceUses=[],r._resourceGraph=new br,r._renderGraph=null,r._compiler=null,r._executor=null,r._customPipelineName="",r._globalDescSetData=void 0,r._combineSignY=0,r._renderGraph=new Wr,r._data=r._renderGraph.globalRenderData,r}u(t,e);var r=t.prototype;return r.addCustomBuffer=function(){throw new Error("Method not implemented.")},r.addCustomTexture=function(){throw new Error("Method not implemented.")},r.tryAddRenderWindowDepthStencil=function(e,t,r,i){r&&(i?this.addDepthStencilImpl(r,i.depthStencilTexture.format,e,t,Tt.BACKBUFFER,i):this.addDepthStencilImpl(r,_.DEPTH_STENCIL,e,t,Tt.MANAGED))},r.addRenderWindow=function(e,t,r,i,s,n){var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateRenderWindow(e,s,n),a;this.tryAddRenderWindowDepthStencil(r,i,n,s.swapchain);var o=new lr;return o.dimension=Rt.TEXTURE2D,o.width=r,o.height=i,o.depthOrArraySize=1,o.mipLevels=1,o.format=s.framebuffer.colorTextures[0].format,o.flags=Nt.COLOR_ATTACHMENT,s.swapchain?this._resourceGraph.addVertex(6,new fr(s.swapchain),e,o,new pr(Tt.BACKBUFFER),new vr,new de):(o.sampleCount=s.framebuffer.colorTextures[0].info.samples,this._resourceGraph.addVertex(5,s.framebuffer,e,o,new pr(Tt.EXTERNAL),new vr,new de))},r.updateRenderWindow=function(e,t,r){var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t.width,s.height=t.height,this.resourceGraph.object(i)!==t.framebuffer&&(this.resourceGraph.x[i].j=t.framebuffer),this.tryAddRenderWindowDepthStencil(t.width,t.height,r,t.swapchain)},r.updateStorageBuffer=function(e,t,r){void 0===r&&(r=_.UNKNOWN);var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,r!==_.UNKNOWN&&(s.format=r)},r.updateRenderTarget=function(e,t,r,i){void 0===i&&(i=_.UNKNOWN);var s=this.resourceGraph.vertex(e),n=this.resourceGraph.getDesc(s);n.width=t,n.height=r,i!==_.UNKNOWN&&(n.format=i)},r.updateDepthStencil=function(e,t,r,i){void 0===i&&(i=_.UNKNOWN);var s=this.resourceGraph.find(e);4294967295!==s&&this.updateDepthStencilImpl(s,t,r,i)},r.updateStorageTexture=function(e,t,r,i){void 0===i&&(i=_.UNKNOWN);var s=this.resourceGraph.vertex(e),n=this.resourceGraph.getDesc(s);n.width=t,n.height=r,i!==_.UNKNOWN&&(n.format=i)},r.updateShadingRateTexture=function(e,t,r){var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,s.height=r},r.addBuffer=function(e,t,r,i){var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateBuffer(e,t),s;var n=new lr;return n.dimension=Rt.BUFFER,n.width=t,n.flags=r,this._resourceGraph.addVertex(0,new Sr,e,n,new pr(i),new vr,new de(le.LINEAR,le.LINEAR,le.NONE,pe.CLAMP,pe.CLAMP,pe.CLAMP))},r.updateBuffer=function(e,t){this.updateResource(e,_.UNKNOWN,t,0,0,0,0,m.X1)},r.addExternalTexture=function(){throw new Error("Method not implemented.")},r.updateExternalTexture=function(){throw new Error("Method not implemented.")},r.addTexture=function(e,t,r,i,s,n,a,o,u,c,h){var d=this._resourceGraph.find(e);if(4294967295!==d)return this.updateTexture(e,r,i,s,n,a,o,u),d;var l=new lr;return l.dimension=La(t),l.width=i,l.height=s,l.depthOrArraySize=l.dimension===Rt.TEXTURE3D?n:a,l.mipLevels=o,l.format=r,l.sampleCount=u,l.flags=c,l.viewType=t,this._resourceGraph.addVertex(0,new Sr,e,l,new pr(h),new vr,new de(le.LINEAR,le.LINEAR,le.NONE,pe.CLAMP,pe.CLAMP,pe.CLAMP))},r.updateTexture=function(e,t,r,i,s,n,a,o){this.updateResource(e,t,r,i,s,n,a,o)},r.addResource=function(e,t,r,i,s,n,a,o,u,c,h){var d=this._resourceGraph.find(e);return 4294967295!==d?(this.updateResource(e,r,i,s,n,a,o,u),d):t===Rt.BUFFER?this.addBuffer(e,i,c,h):this.addTexture(e,Pa(t,a),r,i,s,n,a,o,u,c,h)},r.updateResource=function(e,t,r,i,s,n,a,o){var u=this.resourceGraph.vertex(e),c=this.resourceGraph.getDesc(u);c.width=r,c.height=i,c.depthOrArraySize=c.dimension===Rt.TEXTURE3D?s:n,c.mipLevels=a,t!==_.UNKNOWN&&(c.format=t),c.sampleCount=o},r.containsResource=function(e){return this._resourceGraph.contains(e)},r.addResolvePass=function(){throw new Error("Method not implemented.")},r.addComputePass=function(e){var t=qn.createComputePass(),r=qn.createRenderData(),i=this._renderGraph.addVertex(3,t,"Compute",e,r,!f),s=jn.computePassBuilder.add();return s.update(r,this._renderGraph,this._lg,this._resourceGraph,i,t,this._pipelineSceneData),Et.director.root.pipeline,s},r.addUploadPass=function(e){for(var t,r=qn.createCopyPass(),s=i(e);!(t=s()).done;){var n=t.value;r.uploadPairs.push(n)}this._renderGraph.addVertex(5,r,"UploadPass","",qn.createRenderData(),!f)},r.addCopyPass=function(e){for(var t,r=i(e);!(t=r()).done;){var s=t.value,n=s.target,a=this.resourceGraph.find(n),o=this.resourceGraph.getDesc(a),u=this.addRenderPass(o.width,o.height,"copy-pass");u.addRenderTarget(n,D.CLEAR,T.STORE,jn.createColor()),u.setFloat("flip",this.getCombineSignY()),u.addTexture(s.source,"outputResultMap"),u.addQueue(It.NONE).addFullscreenQuad(this._copyPassMat,0,At.NONE)}},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this._device.getFormatFeatures(_.RGBA32F)&(q.RENDER_TARGET|q.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this._device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this._device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this._device.hasFeature(X.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(c.os===h.ANDROID&&c.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(d.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+dt.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e,this._lg.constantMacros=this._constantMacros},r.setCustomPipelineName=function(e){this._customPipelineName=e,"Deferred"===this._customPipelineName&&(this._usesDeferredPipeline=!0)},r.getGlobalDescriptorSetData=function(){var e=this.layoutGraph.locateChild(this.layoutGraph.N,"default");return this.layoutGraph.getLayout(e).getSet(Dt.PER_PASS)},r._initCombineSignY=function(){var e=this._device;this._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},r.getCombineSignY=function(){return this._combineSignY},r._compileMaterial=function(){this._copyPassMat.initialize({effectName:"pipeline/copy-pass"});for(var e=0;e<this._copyPassMat.passes.length;++e)this._copyPassMat.passes[e].tryCompile()},r.activate=function(){this._device=v.gfxDevice,jn=new Aa,qn=jn.renderGraphPool,Ys(this._device,this._lg),this._compileMaterial(),this.setMacroBool("CC_USE_HDR",this._pipelineSceneData.isHDR),this.setMacroBool("CC_USE_FLOAT_OUTPUT",d.ENABLE_FLOAT_OUTPUT&&_t(this._device)),this._generateConstantMacros(!1),this._pipelineSceneData.activate(this._device),this._initCombineSignY();var e=ot(this._device)?0:1;this.setMacroInt("CC_SHADOWMAP_FORMAT",e);var r=this._device.gfxAPI===z.WEBGL?1:0;this.setMacroInt("CC_SHADOWMAP_USE_LINEAR_DEPTH",r);var i=Et.director.root;return this._defaultSampler=i.device.getSampler(Na),this.pipelineSceneData.csmSupported=this.device.capabilities.maxFragmentUniformVectors>=t.CSM_UNIFORM_VECTORS+t.GLOBAL_UNIFORM_VECTORS,this.setMacroBool("CC_SUPPORT_CASCADED_SHADOW_MAP",this.pipelineSceneData.csmSupported),this.setMacroInt("CC_SHADOW_TYPE",0),this.setMacroInt("CC_DIR_SHADOW_PCF_TYPE",We.HARD),this.setMacroInt("CC_DIR_LIGHT_SHADOW_TYPE",0),this.setMacroBool("CC_CASCADED_LAYERS_TRANSITION",!1),this.usesDeferredPipeline&&this.setMacroInt("CC_PIPELINE_TYPE",1),!0},r.destroy=function(){var e;return null==(e=this._pipelineSceneData)||e.destroy(),!0},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.getSamplerInfo=function(e){if(this.containsResource(e)){var t=this._resourceGraph.vertex(e);return this._resourceGraph.getSampler(t)}return null},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.onGlobalPipelineStateChanged=function(){var e=Et.rendering.getCustomPipeline(d.CUSTOM_PIPELINE_NAME);e&&("function"==typeof e.onGlobalPipelineStateChanged&&e.onGlobalPipelineStateChanged(),Et.rendering.forceResizeAllWindows())},r.beginSetup=function(){this._renderGraph||(this._renderGraph=new Wr,this._data=this._renderGraph.globalRenderData),jn.reset()},r.endSetup=function(){this.compile()},r.addStorageBuffer=function(e,t,r,i){void 0===i&&(i=Tt.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateStorageBuffer(e,r,t),s;var n=new lr;return n.dimension=Rt.BUFFER,n.width=r,n.height=1,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.flags=Nt.STORAGE,i===Tt.PERSISTENT?this._resourceGraph.addVertex(3,new _r,e,n,new pr(Tt.PERSISTENT),new vr,new de):this._resourceGraph.addVertex(1,new gr,e,n,new pr(i),new vr,new de)},r.addRenderTarget=function(e,t,r,i,s){void 0===s&&(s=Tt.MANAGED);var n=this._resourceGraph.find(e);if(4294967295!==n)return this.updateRenderTarget(e,r,i,t),n;var a=new lr;return a.dimension=Rt.TEXTURE2D,a.width=r,a.height=i,a.depthOrArraySize=1,a.mipLevels=1,a.format=t,a.sampleCount=m.X1,a.flags=Nt.COLOR_ATTACHMENT|Nt.SAMPLED,this._resourceGraph.addVertex(0,new Sr,e,a,new pr(s),new vr,new de(le.LINEAR,le.LINEAR,le.NONE,pe.CLAMP,pe.CLAMP,pe.CLAMP))},r.updateDepthStencilImpl=function(e,t,r,i,s){var n=this.resourceGraph.getDesc(e);if(n.width=t,n.height=r,s){var a=this.resourceGraph.j(e);a.swapchain=s,n.format=a.swapchain.depthStencilTexture.format}else i!==_.UNKNOWN&&(n.format=i)},r.addDepthStencilImpl=function(e,t,r,i,s,n){var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateDepthStencilImpl(a,r,i,t,n),a;var o=new lr;return o.dimension=Rt.TEXTURE2D,o.width=r,o.height=i,o.depthOrArraySize=1,o.mipLevels=1,o.format=t,o.sampleCount=m.X1,o.flags=Nt.DEPTH_STENCIL_ATTACHMENT|Nt.SAMPLED,n?this._resourceGraph.addVertex(6,new fr(n,!0),e,o,new pr(s),new vr,new de(le.POINT,le.POINT,le.NONE)):this._resourceGraph.addVertex(0,new Sr,e,o,new pr(s),new vr,new de(le.POINT,le.POINT,le.NONE))},r.addDepthStencil=function(e,t,r,i,s){return void 0===s&&(s=Tt.MANAGED),this.addDepthStencilImpl(e,t,r,i,s)},r.addStorageTexture=function(e,t,r,i,s){void 0===s&&(s=Tt.MANAGED);var n=this._resourceGraph.find(e);if(4294967295!==n)return this.updateStorageTexture(e,r,i,t),n;var a=new lr;return a.dimension=Rt.TEXTURE2D,a.width=r,a.height=i,a.depthOrArraySize=1,a.mipLevels=1,a.format=t,a.flags=Nt.STORAGE|Nt.SAMPLED,this._resourceGraph.addVertex(0,new Sr,e,a,new pr(s),new vr,new de(le.POINT,le.POINT,le.NONE))},r.addShadingRateTexture=function(e,t,r,i){void 0===i&&(i=Tt.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.addShadingRateTexture(e,t,r),s;var n=new lr;return n.dimension=Rt.TEXTURE2D,n.width=t,n.height=r,n.depthOrArraySize=1,n.mipLevels=1,n.format=_.R8UI,n.flags=Nt.SHADING_RATE|Nt.STORAGE|Nt.SAMPLED,this._resourceGraph.addVertex(0,new Sr,e,n,new pr(i),new vr,new de(le.LINEAR,le.LINEAR,le.NONE,pe.CLAMP,pe.CLAMP,pe.CLAMP))},r.beginFrame=function(){Et.director.buildRenderPipeline()},r.update=function(){},r.endFrame=function(){var e;null==(e=this.renderGraph)||e.clear()},r.compile=function(){if(!this._renderGraph)throw new Error("RenderGraph cannot be built without being created");this._compiler||(this._compiler=new Da(this,this._renderGraph,this._resourceGraph,this._lg)),this._compiler.compile(this._renderGraph)},r.execute=function(){if(!this._renderGraph)throw new Error("Cannot run without creating rendergraph");this._executor||(this._executor=new la(this,this._device,this._resourceGraph,this.layoutGraph,this.width,this.height)),this._executor.resize(this.width,this.height),this._executor.execute(this._renderGraph)},r._applySize=function(e){var t=this,r=this._width,i=this._height;e.forEach((function(e){var s=e.window;r=Math.max(s.width,r),i=Math.max(s.height,i),t._cameras.includes(e)||t._cameras.push(e)})),r===this._width&&i===this._height||(this._width=r,this._height=i)},r.render=function(e){0!==e.length&&(this._applySize(e),Ze(e),this.beginFrame(),this.execute(),this.endFrame())},r.addBuiltinReflectionProbePass=function(e){var t=Et.internal.reflectionProbeManager;if(t){var r=t.getProbes();if(0!==r.length)for(var i=0;i<r.length;i++){var s=r[i];s.needRender&&r[i].probeType===Fe.PLANAR&&Fi(e,this,s,s.realtimePlanarTexture.window,0)}}},r.addRenderPassImpl=function(e,t,r,i,s){void 0===i&&(i=1),void 0===s&&(s=0);var n=qn.createRasterPass();n.viewport.width=e,n.viewport.height=t,n.count=i,n.quality=s;var a=qn.createRenderData(),o=this._renderGraph.addVertex(0,n,"Raster",r,a,!f),u=jn.renderPassBuilder.add();return u.update(a,this._renderGraph,this._lg,this._resourceGraph,o,n,this._pipelineSceneData),this._updateRasterPassConstants(u,e,t,r),ms(u,this._pipelineSceneData),u},r.addRenderPass=function(e,t,r){return void 0===r&&(r="default"),this.addRenderPassImpl(e,t,r)},r.addMultisampleRenderPass=function(e,t,r,i,s){return void 0===s&&(s="default"),this.addRenderPassImpl(e,t,s,r,i)},r.getDescriptorSetLayout=function(e,t){var r=this._lg,i=r.shaderLayoutIndex.get(e);return r.getLayout(i).getSet(t).descriptorSetLayout},r._updateRasterPassConstants=function(e,t,r){var i=Et.director,s=i.root,n=t,a=r;s.pipeline.layoutGraph,Ra.set(s.cumulativeTime,s.frameTime,i.getTotalFrames()),e.setVec4("cc_time",Ra),Ra.set(n,a,1/n,1/a),e.setVec4("cc_screenSize",Ra),Ra.set(n,a,1/n,1/a),e.setVec4("cc_nativeSize",Ra);var o=s.debugView;if(Ra.set(0,0,0,0),o){for(var u=[o.singleMode,0,0,0],c=Ue.DIRECT_DIFFUSE;c<Ue.MAX_BIT_COUNT;c++){var h=c%8;u[1+(c>>3)]+=(o.isCompositeModeEnabled(c)?1:0)*Math.pow(10,h)}u[3]+=(o.lightingWithAlbedo?1:0)*Math.pow(10,6),u[3]+=(o.csmLayerColoration?1:0)*Math.pow(10,7),Ra.set(u[0],u[1],u[2],u[3])}e.setVec4("cc_debug_view_mode",Ra)},s(t,[{key:"type",get:function(){return qr.BASIC}},{key:"capabilities",get:function(){return new Kr}},{key:"enableCpuLightCulling",get:function(){return!this._executor||this._executor._context.culling.enableLightCulling},set:function(e){this._executor&&(this._executor._context.culling.enableLightCulling=e)}},{key:"name",get:function(){return"WebPipeline"}},{key:"globalDescriptorSetData",get:function(){return this._globalDescSetData}},{key:"defaultSampler",get:function(){return this._defaultSampler}},{key:"defaultShadowTexture",get:function(){return mt(this.device)}},{key:"device",get:function(){return this._device}},{key:"lightingMode",get:function(){return this._lightingMode},set:function(e){this._lightingMode=e}},{key:"usesDeferredPipeline",get:function(){return this._usesDeferredPipeline}},{key:"macros",get:function(){return this._macros}},{key:"profilerDescriptorSet",get:function(){return this._profilerDescriptorSet}},{key:"commandBuffers",get:function(){return[this._device.commandBuffer]}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){throw new Error("Method not implemented.")}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"renderGraph",get:function(){return this._renderGraph}},{key:"resourceGraph",get:function(){return this._resourceGraph}},{key:"layoutGraph",get:function(){return this._lg}},{key:"resourceUses",get:function(){return this._resourceUses}}]),t}(As);Fa.MAX_BLOOM_FILTER_PASS_NUM=6,Fa.CSM_UNIFORM_VECTORS=61,Fa.GLOBAL_UNIFORM_VECTORS=64,function(){function e(){this.capacity=0,this.size=0,this.buffer=void 0,this.dataView=void 0,this.capacity=4096,this.buffer=new Uint8Array(this.capacity),this.dataView=new DataView(this.buffer.buffer)}var t=e.prototype;t.b=function(e){var t=this.size+1;t>this.capacity&&this.reserve(t),this.dataView.setUint8(this.size,e?1:0),this.size=t},t.n=function(e){var t=this.size+8;t>this.capacity&&this.reserve(t),this.dataView.setFloat64(this.size,e,!0),this.size=t},t.s=function(e){this.n(e.length);var t=this.size+e.length;t>this.capacity&&this.reserve(t);for(var r=0;r<e.length;r++)this.dataView.setUint8(this.size+r,e.charCodeAt(r));this.size=t},t.reserve=function(e){var t=Math.max(e,2*this.capacity),r=this.buffer;this.buffer=new Uint8Array(t),this.buffer.set(r),this.dataView=new DataView(this.buffer.buffer),this.capacity=t},s(e,[{key:"data",get:function(){return this.buffer.buffer.slice(0,this.size)}}])}();var Ua=function(){function e(e,t){this.offset=0,this.dataView=void 0,this.dataView=new DataView(e,t)}var t=e.prototype;return t.b=function(){return 0!==this.dataView.getUint8(this.offset++)},t.n=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},t.s=function(){var e=this.n(),t=String.fromCharCode.apply(null,Array.from(new Uint8Array(this.dataView.buffer,this.offset,e)));return this.offset+=e,t},e}(),ka=function(e,t,r,i,s){this.programInfo=e,this.shaderInfo=t,this.attributes=r,this.blockSizes=i,this.handleMap=s},Ha=function(){this.programInfos=new Map,this.programProxies=new Map},Qa=[2,1,3,0];function za(e,t){var r=p({},t);return r.effectName=e,nt(r),r}function Wa(e,t){for(var r,s=i(e.blocks);!(r=s()).done;){var n=r.value;if(n.name===t)return{set:n.set,binding:n.binding}}for(var o,u=i(e.buffers);!(o=u()).done;){var c=o.value;if(c.name===t)return{set:c.set,binding:c.binding}}for(var h,d=i(e.samplerTextures);!(h=d()).done;){var l=h.value;if(l.name===t)return{set:l.set,binding:l.binding}}for(var p,f=i(e.samplers);!(p=f()).done;){var v=p.value;if(v.name===t)return{set:v.set,binding:v.binding}}for(var g,_=i(e.textures);!(g=_()).done;){var m=g.value;if(m.name===t)return{set:m.set,binding:m.binding}}for(var y,S=i(e.images);!(y=S()).done;){var E=y.value;if(E.name===t)return{set:E.set,binding:E.binding}}for(var w,D=i(e.subpassInputs);!(w=D()).done;){var T=w.value;if(T.name===t)return{set:T.set,binding:T.binding}}throw a("binding not found in shaderInfo!")}function ja(e,t){for(var r=t,i=/layout\s*\(([^)])+\)\s+uniform\s+(\b\w+\b\s+)?sampler(\w+)\s+(\b\w+\b)/g,s=i.exec(r);s;){var n=Wa(e,s[4]),a="layout(set = "+n.set+", binding = "+n.binding+") uniform "+(s[2]?s[2]:"")+" sampler"+s[3]+" "+s[4];r=r.replace(s[0],a),s=i.exec(r)}for(var o=/layout\s*\(([^)]+)\)\s*(readonly|writeonly)?\s*\b((uniform\s*|buffer\s*|image2D\s*){1,2})\b\s*(\b\w+\b)\s*[{;]/g,u=o.exec(r);u;){var c=Wa(e,u[5]),h=c.set,d=c.binding,l=u[2]?u[2]:"",p=" {";u[3].includes("image")&&(p=";");var f=u[1],v="layout("+(f=(f=f.replace(/set\s*=\s*\d+/g,"set = "+h)).replace(/binding\s*=\s*\d+/g,"binding = "+d))+") "+l+" "+u[3]+" "+u[5]+p;r=r.replace(u[0],v),u=o.exec(r)}return r}function qa(e,t){"glsl4"===et(v.gfxDevice)&&(t.glsl4.vert&&(t.glsl4.vert=ja(e,t.glsl4.vert)),t.glsl4.frag&&(t.glsl4.frag=ja(e,t.glsl4.frag)),t.glsl4.compute&&(t.glsl4.compute=ja(e,t.glsl4.compute)))}function Xa(e,t){qa(e,t);for(var r,s=Qa[Dt.PER_BATCH],n=i(t.blocks);!(r=n()).done;){for(var o,u=r.value,c=!1,h=i(e.blocks);!(o=h()).done;){var d=o.value;if(d.set===s&&d.name===u.name){u.binding=d.binding,c=!0;break}}c||a("Block "+u.name+" not found in shader "+e.name)}}function Ya(e,t,r,s,n){for(var a,o=i(e.descriptorBlocks);!(a=o()).done;){var u=a.value,c=u.visibility,h=u.offset;switch(u.type){case 0:for(var d,l=i(t.blocks);!(d=l()).done;){var p=d.value;p.stageFlags===c&&(n.push(at(p.members)),s.blocks.push(new O(r,h,p.name,p.members.map((function(e){return new P(e.name,e.type,e.count)})),1)),++h)}break;case 1:case 6:break;case 2:for(var f,v=i(t.samplerTextures);!(f=v()).done;){var g=f.value;g.stageFlags===c&&(s.samplerTextures.push(new _e(r,h,g.name,g.type,g.count)),++h)}break;case 3:for(var _,m=i(t.samplers);!(_=m()).done;){var y=_.value;y.stageFlags===c&&(s.samplers.push(new we(r,h,y.name,y.count)),++h)}break;case 4:for(var S,E=i(t.textures);!(S=E()).done;){var w=S.value;w.stageFlags===c&&(s.textures.push(new Ee(r,h,w.name,w.type,w.count)),++h)}break;case 5:for(var D,T=i(t.buffers);!(D=T()).done;){var I=D.value;I.stageFlags===c&&(s.buffers.push(new Se(r,h,I.name,1,I.memoryAccess)),++h)}break;case 7:for(var R,N=i(t.images);!(R=N()).done;){var A=R.value;A.stageFlags===c&&(s.images.push(new me(r,h,A.name,A.type,A.count,A.memoryAccess)),++h)}break;case 8:for(var L,b=i(t.subpassInputs);!(L=b()).done;){var C=L.value;C.stageFlags===c&&(s.subpassInputs.push(new ye(r,C.binding,C.name,C.count)),++h)}}}}function Ka(e,t,r,s,n){for(var o,u=i(t.descriptorBlocks);!(o=u()).done;){var c=o.value,h=c.offset;switch(c.type){case 0:for(var d,l=i(c.descriptors);!(d=l()).done;){var p=d.value,f=t.uniformBlocks.get(p.descriptorID);void 0!==f?(n.push(at(f.members)),s.blocks.push(new O(r,h,e[p.descriptorID],f.members.map((function(e){return new P(e.name,e.type,e.count)})),1)),++h):a("Failed to find uniform block "+p.descriptorID+" in layout")}h!==c.offset+c.capacity&&a("Uniform buffer binding mismatch for set "+r);break;case 1:case 6:break;case 2:for(var v,g=i(c.descriptors);!(v=g()).done;){var _=v.value;s.samplerTextures.push(new _e(r,h,e[_.descriptorID],_.type,_.count)),++h}break;case 3:for(var m,y=i(c.descriptors);!(m=y()).done;){var S=m.value;s.samplers.push(new we(r,h,e[S.descriptorID],S.count)),++h}break;case 4:for(var E,w=i(c.descriptors);!(E=w()).done;){var D=E.value;s.textures.push(new Ee(r,h,e[D.descriptorID],D.type,D.count)),++h}break;case 5:for(var T,I=i(c.descriptors);!(T=I()).done;){var R=T.value;s.buffers.push(new Se(r,h,e[R.descriptorID],1,b.READ_WRITE)),++h}break;case 7:for(var N,A=i(c.descriptors);!(N=A()).done;){var L=N.value;s.images.push(new me(r,h,e[L.descriptorID],L.type,L.count,b.READ_WRITE)),++h}break;case 8:for(var C,x=i(c.descriptors);!(C=x()).done;){var B=C.value;s.subpassInputs.push(new ye(r,h,e[B.descriptorID],B.count)),++h}}}}function Za(e,t,r,i){for(var s=Qa[Dt.PER_INSTANCE],n=function(){var n=e.blocks[a],o=t.layouts[n.name],u=o&&t.bindings.find((function(e){return e.binding===o.binding}));if(!(o&&u&&u.descriptorType&De))return console.warn("builtin UBO '"+n.name+"' not available!"),1;i.push(at(n.members)),r.blocks.push(new O(s,u.binding,n.name,n.members.map((function(e){return new P(e.name,e.type,e.count)})),1))},a=0;a<e.blocks.length;a++)n();for(var o=function(){var i=e.samplerTextures[_i13],n=t.layouts[i.name],a=n&&t.bindings.find((function(e){return e.binding===n.binding}));if(!(n&&a&&a.descriptorType&Te))return console.warn("builtin samplerTexture '"+i.name+"' not available!"),1;r.samplerTextures.push(new _e(s,a.binding,i.name,i.type,i.count))},u=0;u<e.samplerTextures.length;u++)o()}function Ja(e){for(var t,r=0,s=i(e.bindings);!(t=s()).done;){var n=t.value;n.descriptorType!==j.UNIFORM_BUFFER&&n.descriptorType!==j.DYNAMIC_UNIFORM_BUFFER||(r+=n.count)}return r}function $a(e){for(var t,r=0,s=i(e.bindings);!(t=s()).done;){var n=t.value;n.descriptorType!==j.UNIFORM_BUFFER&&n.descriptorType!==j.DYNAMIC_UNIFORM_BUFFER&&(r+=n.count)}return r}function eo(e,t){for(var r,s=i(t);!(r=s()).done;){var n=r.value;n.flattened=e[n.set]+n.binding}}function to(e,t,r){for(var s,n=i(r);!(s=n()).done;){var a=s.value;a.flattened=e[a.set]+a.binding-t[a.set]}}function ro(e,t,r){var i,s,n,a,o=new Array(4),u=(null==(i=e[Dt.PER_PASS])?void 0:i.uniformBlockCapacity)||0,c=(null==(s=e[Dt.PER_PHASE])?void 0:s.uniformBlockCapacity)||0,h=(null==(n=e[Dt.PER_BATCH])?void 0:n.uniformBlockCapacity)||0,d=t?Ja(t):(null==(a=e[Dt.PER_INSTANCE])?void 0:a.uniformBlockCapacity)||0;o[Qa[Dt.PER_PASS]]=u,o[Qa[Dt.PER_PHASE]]=c,o[Qa[Dt.PER_BATCH]]=h,o[Qa[Dt.PER_INSTANCE]]=d;var l=0+u,p=l+c,f=p+d,v=new Array(4);v[Qa[Dt.PER_PASS]]=0,v[Qa[Dt.PER_PHASE]]=l,v[Qa[Dt.PER_BATCH]]=f,v[Qa[Dt.PER_INSTANCE]]=p,eo(v,r.blocks);var g,_,m,y=0+((null==(g=e[Dt.PER_PASS])?void 0:g.samplerTextureCapacity)||0),S=y+((null==(_=e[Dt.PER_PHASE])?void 0:_.samplerTextureCapacity)||0),E=S+(t?$a(t):(null==(m=e[Dt.PER_INSTANCE])?void 0:m.samplerTextureCapacity)||0),w=new Array(4);w[Qa[Dt.PER_PASS]]=0,w[Qa[Dt.PER_PHASE]]=y,w[Qa[Dt.PER_BATCH]]=E,w[Qa[Dt.PER_INSTANCE]]=S,to(w,o,r.samplerTextures)}function io(e,t,r,i,s,n){var a=[null,null,null,null],o=null,u=new ve,c=[],h=t.getSet(Dt.PER_PASS);h&&(a[Dt.PER_PASS]=h.descriptorSetLayoutData,Ka(e.valueNames,h.descriptorSetLayoutData,Qa[Dt.PER_PASS],u,c));var d=r.getSet(Dt.PER_PHASE);d&&(a[Dt.PER_PHASE]=d.descriptorSetLayoutData,Ka(e.valueNames,d.descriptorSetLayoutData,Qa[Dt.PER_PHASE],u,c));var l=i.descriptors[Dt.PER_BATCH];if(s){var p=s.layout.getSet(Dt.PER_BATCH);p&&(a[Dt.PER_BATCH]=p.descriptorSetLayoutData,Ka(e.valueNames,p.descriptorSetLayoutData,Qa[Dt.PER_BATCH],u,c))}else{var f=r.getSet(Dt.PER_BATCH);f&&(a[Dt.PER_BATCH]=f.descriptorSetLayoutData,Ya(f.descriptorSetLayoutData,l,Qa[Dt.PER_BATCH],u,c))}var v=i.descriptors[Dt.PER_INSTANCE];if(s)if(n)o=yt,Za(v,yt,u,c);else{var g=s.layout.getSet(Dt.PER_INSTANCE);g&&(a[Dt.PER_INSTANCE]=g.descriptorSetLayoutData,Ka(e.valueNames,g.descriptorSetLayoutData,Qa[Dt.PER_INSTANCE],u,c))}else{var _=r.getSet(Dt.PER_INSTANCE);_&&(a[Dt.PER_INSTANCE]=_.descriptorSetLayoutData,Ya(_.descriptorSetLayoutData,v,Qa[Dt.PER_INSTANCE],u,c))}return ro(a,o,u),u.stages.push(new ge(R.VERTEX,"")),u.stages.push(new ge(R.FRAGMENT,"")),[u,c]}var so=function(){function e(e,t){void 0===t&&(t=null),this.shader=void 0,this.pipelineState=null,this.shader=e,this.pipelineState=t}return s(e,[{key:"name",get:function(){return this.shader.name}}]),e}();function no(e,t){for(var r in e.layouts){var i=e.layouts[r];if(i.binding===t){o(i.name===r);var s=L.UNKNOWN;return(i instanceof _e||i instanceof me)&&(s=i.type),[i.name,s]}}return a("descriptor not found"),["",L.UNKNOWN]}function ao(e,t){for(var r,s=new si,n=i(t.bindings);!(r=n()).done;){var o=r.value,u=no(t,o.binding),c=u[0],h=u[1],d=js(e,c),l=Gs(o.descriptorType),p=new ii(l,o.stageFlags,o.count,o.access,o.viewDimension,o.sampleType,o.format);p.offset=o.binding,p.descriptors.push(new ri(d,h,o.count)),s.descriptorBlocks.push(p),void 0!==s.bindingMap.get(d)&&a("duplicate descriptor name '"+c+"'"),s.bindingMap.set(d,o.binding);var f=t.layouts[c];f instanceof O&&s.uniformBlocks.set(d,f)}return s}function oo(e,t,r,i,s,n){var o=s.layout.getSets(),u=$s(r,Dt.PER_BATCH,Qa[Dt.PER_BATCH],t.descriptors[Dt.PER_BATCH]),c=new ni(u);if(en(c.descriptorSetLayoutData,c.descriptorSetLayoutInfo),o.set(Dt.PER_BATCH,c),n){var h=ao(r,yt),d=new ni(h);if(en(d.descriptorSetLayoutData,d.descriptorSetLayoutInfo),yt.bindings.length!==d.descriptorSetLayoutInfo.bindings.length)a("local descriptor set layout inconsistent");else for(var l=0;l!==yt.bindings.length;++l){var p=yt.bindings[l],f=d.descriptorSetLayoutInfo.bindings[l];p.binding===f.binding&&p.descriptorType===f.descriptorType&&p.count===f.count&&p.stageFlags===f.stageFlags||a("local descriptor set layout inconsistent")}o.set(Dt.PER_INSTANCE,d)}else{var v=$s(r,Dt.PER_INSTANCE,Qa[Dt.PER_INSTANCE],t.descriptors[Dt.PER_INSTANCE]),g=new ni(v);en(g.descriptorSetLayoutData,g.descriptorSetLayoutInfo),o.set(Dt.PER_INSTANCE,g)}var _=i.shaderPrograms.length;i.shaderIndex.set(e,_),i.shaderPrograms.push(s)}function uo(e,t,r,i,s){o(s<Dt.PER_PHASE);var n=t.j(r),a=n.shaderIndex.get(i);if(void 0===a)return nn();var u=n.shaderPrograms[a].layout.getSet(s);return void 0===u?nn():(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function co(e,t,r,i,s){o(s<Dt.PER_PHASE);var n=t.j(r),a=n.shaderIndex.get(i);if(void 0===a)return null;var u=n.shaderPrograms[a].layout.getSet(s);return void 0===u?null:(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function ho(e,t,r){var i=r.program,s=Ms(e,r.pass);if(s===Bs)return a("Invalid render pass, program: "+i),[Bs,Bs,Bs,null,Bs];var n=r.subpass&&""!==r.subpass&&!0,o=n?Vs(e,s,r.subpass):Bs;if(n&&o===Bs)return a("Invalid render subpass, program: "+i),[Bs,Bs,Bs,null,Bs];var u=Fs(e,o===Bs?s:o,r.phase);if(u===Bs)return a("Invalid render phase, program: "+i),[Bs,Bs,Bs,null,Bs];for(var c=null,h=Bs,d=0;d<t.shaders.length;++d){var l=t.shaders[d];if(l.name===i){c=l,h=d;break}}return[s,o,u,c,h]}function lo(e){return void 0===e.descriptors?(a("No descriptors in shader: "+e.name+", please reimport ALL effects"),1):0}var po=function(){function e(e){this.layoutGraph=void 0,this.phases=new Map,this.mergeHighFrequency=!1,this.fixedLocal=!0,this.localLayoutData=new si,this.localDescriptorSetLayout=null,this.pipeline=null,this.device=null,this.layoutGraph=e;for(var t,r=i(e.v());!(t=r()).done;){var s=t.value;e.h(1,s)&&this.phases.set(s,new Ha)}}var t=e.prototype;return t.init=function(e){if(this.device!==e){this.device=e;var t=Math.floor((this.device.capabilities.maxVertexUniformVectors-38)/3);t=t<256?t:256,dt.initLayout(t);for(var r,s=this.layoutGraph,n=i(s.v());!(r=n()).done;)for(var a,u=r.value,c=s.getLayout(u).getSets(),h=i(c);!(a=h()).done;){var d=a.value;d[0];var l=d[1];en(l.descriptorSetLayoutData,l.descriptorSetLayoutInfo),l.descriptorSetLayout=this.device.createDescriptorSetLayout(l.descriptorSetLayoutInfo),o(!!l.descriptorSetLayout),l.descriptorSet=this.device.createDescriptorSet(new Q(l.descriptorSetLayout)),o(!!l.descriptorSet)}for(var p,f=i(s.v());!(p=f()).done;){var v=p.value;if(s.h(1,v)){var g=v,m=s.getParent(g),y=s.getLayout(m),S=s.getLayout(g),E=new W;tn(y,Dt.PER_PASS,E),tn(S,Dt.PER_PHASE,E),tn(S,Dt.PER_BATCH,E),tn(S,Dt.PER_INSTANCE,E),s.j(g).pipelineLayout=this.device.createPipelineLayout(E)}}var w=yt;this.localLayoutData=ao(s,w);var D,T=new B;en(this.localLayoutData,T),this.localDescriptorSetLayout=this.device.createDescriptorSetLayout(T),o(!!this.localDescriptorSetLayout);for(var I,R=0,N=i(this.localLayoutData.descriptorBlocks);!(I=N()).done;){var A=I.value;if(0===A.type||1===A.type)for(var P,L=i(A.descriptors);!(P=L()).done;)R+=P.value.count}o(7===R),D=this.device,this.layoutGraph.constantMacros,D.getFormatFeatures(_.RGBA32F),q.RENDER_TARGET,q.SAMPLED_TEXTURE,D.capabilities.maxVertexUniformVectors,D.capabilities.maxFragmentUniformVectors,D.hasFeature(X.INPUT_ATTACHMENT_BENEFIT),dt.JOINT_UNIFORM_CAPACITY}},t.addEffect=function(e){for(var t,r=this,s=this.layoutGraph,n=i(e.techniques);!(t=n()).done;)for(var u,c=t.value,h=function(){var t=u.value,i=t.program,n=ho(s,e,t),c=n[0],h=n[1],d=n[2],l=n[3];if(null===l||lo(l))return a("program: "+i+" not found"),1;o(c!==Bs&&d!==Bs);var p=h===Bs?c:h,f=s.getLayout(p),v=s.getLayout(d),g=r.phases.get(d);void 0===g&&(g=new Ha,r.phases.set(d,g));var _=g.programInfos,m=za(e.name,l),y=null;if(!r.mergeHighFrequency){var S=s.j(d);y=new di,oo(i,l,s,S,y,r.fixedLocal)}var E=io(s,f,v,l,y,r.fixedLocal),w=E[0],D=E[1];Xa(w,m);var T=it(w),I=[];m.attributes.forEach((function(e){I.push(new re(e.name,e.format,e.isNormalized,0,e.isInstanced,e.location))}));var R=new ka(m,w,I,D,T);_.set(l.name,R)},d=i(c.passes);!(u=d()).done;)h()},t.precompileEffect=function(e,t){for(var r,s=this,n=this.layoutGraph,u=i(t.techniques);!(r=u()).done;)for(var c,h=r.value,d=function(){var r=c.value,i=r.program,u=ho(n,t,r),h=u[0];u[1];var d=u[2],l=u[3],p=u[4];if(null===l||lo(l))return a("program: "+i+" not valid"),0;o(h!==Bs&&d!==Bs&&p!==Bs);var f=t.combinations[p];if(!f)return 0;st(f).forEach((function(t){return s.getProgramVariant(e,d,i,t)}))},l=i(h.passes);!(c=l()).done;)d()},t.getProgramInfo=function(e,t){return o(e!==Bs),this.phases.get(e).programInfos.get(t).programInfo},t.getShaderInfo=function(e,t){return o(e!==Bs),this.phases.get(e).programInfos.get(t).shaderInfo},t.getKey=function(e,t,r){o(e!==Bs);var i=this.phases.get(e);if(void 0===i)return a("Invalid render phase, program: "+t),"";var s=i.programInfos.get(t);return void 0===s?(a("Invalid program, program: "+t),""):Je(s.programInfo,r)},t.getProgramVariant=function(e,t,r,i,s){var n;void 0===s&&(s=null),Object.assign(i,null==(n=this.pipeline)?void 0:n.macros),o(t!==Bs);var u=this.phases.get(t);if(void 0===u)return a("Invalid render phase, program: "+r),null;var c=u.programInfos.get(r);if(void 0===c)return a("Invalid program, program: "+r),null;var h=c.programInfo;null===s&&(s=Je(h,i));var d=u.programProxies,p=d.get(s);if(void 0!==p)return p;var f=$e(i,h.defines),v=this.layoutGraph.constantMacros+h.constantMacros+f.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),g=h.glsl3,_=et(e);_?g=h[_]:l(16346);var m=c.shaderInfo;g.compute?(m.stages[0].source=v+g.compute,m.stages[0].stage=R.COMPUTE,m.stages.length=1):(m.stages[0].source=v+g.vert,m.stages[1].source=v+g.frag),m.attributes=tt(h,c.attributes,i),m.name=rt(r,f);var y=e.createShader(m),S=new so(y);return d.set(s,S),S},t.getMaterialDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){o(t!==Bs);var i=this.layoutGraph.getParent(t);return on(this.layoutGraph,i,t,Dt.PER_BATCH)}return uo(e,this.layoutGraph,t,r,Dt.PER_BATCH)},t.getLocalDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){o(t!==Bs);var i=this.layoutGraph.getParent(t);return on(this.layoutGraph,i,t,Dt.PER_INSTANCE)}return uo(e,this.layoutGraph,t,r,Dt.PER_INSTANCE)},t.getBlockSizes=function(e,t){o(e!==Bs);var r=this.phases.get(e);if(!r)return a("Invalid render phase, program: "+t),[];var i=r.programInfos.get(t);return i?i.blockSizes:(a("Invalid program, program: "+t),[])},t.getHandleMap=function(e,t){o(e!==Bs);var r=this.phases.get(e);if(!r)return a("Invalid render phase, program: "+t),{};var i=r.programInfos.get(t);return i?i.handleMap:(a("Invalid program, program: "+t),{})},t.getPipelineLayout=function(e,t,r){if(this.mergeHighFrequency)return o(t!==Bs),this.layoutGraph.j(t).pipelineLayout;var i=this.layoutGraph,s=i.j(t),n=s.shaderIndex.get(r);if(void 0===n)return an();var a=s.shaderPrograms[n];if(a.pipelineLayout)return a.pipelineLayout;var u=i.getParent(t);if(u===Bs)return an();var c=new W,h=un(this.layoutGraph,u,t,Dt.PER_PASS);h&&c.setLayouts.push(h);var d=un(this.layoutGraph,u,t,Dt.PER_PHASE);d&&c.setLayouts.push(d);var l=co(e,i,t,r,Dt.PER_BATCH);l&&c.setLayouts.push(l);var p=co(e,i,t,r,Dt.PER_INSTANCE);return p&&c.setLayouts.push(p),a.pipelineLayout=e.createPipelineLayout(c),a.pipelineLayout},t.getProgramID=function(e,t){return cn(this.layoutGraph,e,t)},t.getDescriptorNameID=function(e){return hn(this.layoutGraph,e)},t.getDescriptorName=function(e){return dn(this.layoutGraph,e)},e}(),fo=null,vo=!1;function go(){vo=!0}var _o=[],mo=4294967295,yo=new vi,So=new po(yo),Eo=new Map;function wo(e,t){Eo.set(e,t),go()}e("r",Object.freeze({__proto__:null,get AccessType(){return Lt},AttachmentType:Ct,ClearValueType:xt,CopyPair:Mt,INVALID_ID:mo,LightInfo:Bt,LightingMode:bt,MovePair:Ft,ParameterType:Pt,PipelineCapabilities:Kr,PipelineStatistics:Ut,get PipelineType(){return qr},get QueueHint(){return It},RenderCommonObjectPool:Wt,ResolveFlags:Ot,ResolvePair:Gt,get ResourceDimension(){return Rt},get ResourceFlags(){return Nt},get ResourceResidency(){return Tt},get SceneFlags(){return At},get SubpassCapabilities(){return Xr},TaskType:{SYNC:0,ASYNC:1},get UpdateFrequency(){return Dt},UploadPair:Vt,completePhaseName:function(e){return"number"==typeof e?e.toString():"string"==typeof e?e:"default"},createCustomPipeline:function(){var e=new Fa(yo),t=d.CUSTOM_PIPELINE_NAME;return e.setCustomPipelineName(t),So.pipeline=e,e},customPipelineBuilderMap:Eo,defaultWindowResize:function(e,t,r,i){e.addRenderWindow(t.colorName,_.BGRA8,r,i,t),e.addDepthStencil(t.depthStencilName,_.DEPTH_STENCIL,r,i);var s=t.renderWindowId,n=ot(e.device)?_.R32F:_.RGBA8,a=e.pipelineSceneData.shadows.size;e.addRenderTarget("ShadowMap"+s,n,a.x,a.y),e.addDepthStencil("ShadowDepth"+s,_.DEPTH_STENCIL,a.x,a.y)},destroy:function(){sn(yo)},dispatchResizeEvents:function(e,t,r){if(t.windowResize){for(var s,n=i(e);!(s=n()).done;){var a=s.value;if(a.window.isRenderWindowResized()||vo){var o=Math.max(Math.floor(a.window.width),1),u=Math.max(Math.floor(a.window.height),1);t.windowResize(r,a.window,a,o,u),_o.push(a.window)}}for(var c,h=i(_o);!(c=h()).done;)c.value.setRenderWindowResizeHandled();_o.length=0,vo=!1}},enableEffectImport:!0,forceResizeAllWindows:go,getCustomPipeline:function(e){var t=Eo.get(e);return t||(t=Eo.get("Forward")),t},getEditorPipelineSettings:function(){return fo},getPassID:function(e){return Ms(yo,e)},getPhaseID:function(e,t){return Fs(yo,e,t)},getSubpassID:function(e,t){return Vs(yo,e,t)},init:function(e,r){if(r&&r.byteLength>=8){var i=new Uint8Array(r);if(new DataView(i.buffer,i.byteOffset,8).getUint32(0)===mo){var s=new t.Inflate(new Uint8Array(i.buffer,i.byteOffset+8)).decompress();Ai(new Ua(s.buffer,s.byteOffset),yo)}else Ai(new Ua(i.buffer,i.byteOffset),yo)}rn(e,yo)},loadCopyPair:function(e,t){t.source=e.s(),t.target=e.s(),t.mipLevels=e.n(),t.numSlices=e.n(),t.sourceMostDetailedMip=e.n(),t.sourceFirstSlice=e.n(),t.sourcePlaneSlice=e.n(),t.targetMostDetailedMip=e.n(),t.targetFirstSlice=e.n(),t.targetPlaneSlice=e.n()},loadLightInfo:function(e,t){t.level=e.n(),t.culledByLight=e.b()},loadMovePair:function(e,t){t.source=e.s(),t.target=e.s(),t.mipLevels=e.n(),t.numSlices=e.n(),t.targetMostDetailedMip=e.n(),t.targetFirstSlice=e.n(),t.targetPlaneSlice=e.n()},loadPipelineStatistics:function(e,t){t.numRenderPasses=e.n(),t.numManagedTextures=e.n(),t.totalManagedTextures=e.n(),t.numUploadBuffers=e.n(),t.numUploadBufferViews=e.n(),t.numFreeUploadBuffers=e.n(),t.numFreeUploadBufferViews=e.n(),t.numDescriptorSets=e.n(),t.numFreeDescriptorSets=e.n(),t.numInstancingBuffers=e.n(),t.numInstancingUniformBlocks=e.n()},loadResolvePair:function(e,t){t.source=e.s(),t.target=e.s(),t.resolveFlags=e.n(),t.mode=e.n(),t.mode1=e.n()},packRGBE:Oe,programLib:So,saveCopyPair:function(e,t){e.s(t.source),e.s(t.target),e.n(t.mipLevels),e.n(t.numSlices),e.n(t.sourceMostDetailedMip),e.n(t.sourceFirstSlice),e.n(t.sourcePlaneSlice),e.n(t.targetMostDetailedMip),e.n(t.targetFirstSlice),e.n(t.targetPlaneSlice)},saveLightInfo:function(e,t){e.n(t.level),e.b(t.culledByLight)},saveMovePair:function(e,t){e.s(t.source),e.s(t.target),e.n(t.mipLevels),e.n(t.numSlices),e.n(t.targetMostDetailedMip),e.n(t.targetFirstSlice),e.n(t.targetPlaneSlice)},savePipelineStatistics:function(e,t){e.n(t.numRenderPasses),e.n(t.numManagedTextures),e.n(t.totalManagedTextures),e.n(t.numUploadBuffers),e.n(t.numUploadBufferViews),e.n(t.numFreeUploadBuffers),e.n(t.numFreeUploadBufferViews),e.n(t.numDescriptorSets),e.n(t.numFreeDescriptorSets),e.n(t.numInstancingBuffers),e.n(t.numInstancingUniformBlocks)},saveResolvePair:function(e,t){e.s(t.source),e.s(t.target),e.n(t.resolveFlags),e.n(t.mode),e.n(t.mode1)},setCustomPipeline:wo,setEditorPipelineSettings:function(e){fo=e,vo=!0}}))}}}));
//# sourceMappingURL=index-aAbfWlxb.js.map
