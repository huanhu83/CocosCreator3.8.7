{"version":3,"file":"instantiate-B8jTMe8K.js","sources":["../../../cocos/serialization/instantiate.ts"],"sourcesContent":["/*\r\n Copyright (c) 2013-2016 Chukong Technologies Inc.\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n http://www.cocos.com\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { DEV, JSB } from 'internal:constants';\r\nimport {\r\n    CCObject,\r\n    CCObjectFlags,\r\n    isCCObject,\r\n    js,\r\n    ValueType,\r\n    isCCClassOrFastDefined,\r\n    getError,\r\n    warn,\r\n    misc,\r\n    cclegacy,\r\n    editorExtrasTag,\r\n} from '../core';\r\nimport { Prefab } from '../scene-graph/prefab';\r\nimport { Node } from '../scene-graph/node';\r\nimport { Component } from '../scene-graph/component';\r\nimport { updateChildrenForDeserialize } from '../core/utils/jsb-utils';\r\n\r\nconst Destroyed = CCObjectFlags.Destroyed;\r\nconst PersistentMask = CCObjectFlags.PersistentMask;\r\n\r\nconst objsToClearTmpVar: any[] = [];   // used to reset _iN$t variable\r\n\r\n/**\r\n * Invoke _instantiate method if supplied.\r\n * The _instantiate callback will be called only on the root object, its associated object will not be called.\r\n * @param instantiated If supplied, _instantiate just need to initialize the instantiated object, no need to create new object by itself.\r\n * @returns The instantiated object.\r\n */\r\ntype CustomInstantiation = <T>(this: T, instantiated?: T) => T;\r\n\r\nfunction hasImplementedInstantiate (original: any): original is { _instantiate (...args: unknown[]): unknown } {\r\n    return typeof original._instantiate === 'function';\r\n}\r\n\r\n// Used to detect whether the current node is a Mounted node in a PrefabInstance\r\nfunction isMountedChild (node: Node): boolean {\r\n    const editorExtras = node[editorExtrasTag];\r\n    if (typeof editorExtras === 'object') {\r\n        return !!((editorExtras as { mountedRoot: Node }).mountedRoot);\r\n    }\r\n    return false;\r\n}\r\n\r\n/**\r\n * @zh 从 Prefab 实例化出新节点。\r\n * @en Instantiate a node from the Prefab.\r\n * @param prefab The prefab.\r\n * @returns The instantiated node.\r\n * @example\r\n * ```ts\r\n * import { instantiate, director } from 'cc';\r\n * // Instantiate node from prefab.\r\n * const node = instantiate(prefabAsset);\r\n * node.parent = director.getScene();\r\n * ```\r\n */\r\nexport function instantiate (prefab: Prefab): Node;\r\n\r\n/**\r\n * @en Clones the object `original.\r\n * @zh 克隆指定的任意类型的对象。\r\n * @param original An existing object that you want to make a copy of.\r\n * It can be any JavaScript object(`typeof original === 'object'`) but:\r\n * - it shall not be array or null;\r\n * - it shall not be object of `Asset`;\r\n * - if it's an object of `CCObject`, it should not have been destroyed.\r\n * @returns The newly instantiated object.\r\n * @example\r\n * ```ts\r\n * import { instantiate, director } from 'cc';\r\n * // Clone a node.\r\n * const node = instantiate(targetNode);\r\n * node.parent = director.getScene();\r\n * ```\r\n */\r\nexport function instantiate<T> (original: T): T;\r\n\r\nexport function instantiate (original: any, internalForce?: boolean): any {\r\n    if (!internalForce) {\r\n        if (DEV) {\r\n            if (typeof original !== 'object' || Array.isArray(original)) {\r\n                throw new TypeError(getError(6900));\r\n            }\r\n            if (!original) {\r\n                throw new TypeError(getError(6901));\r\n            }\r\n            if (!cclegacy.isValid(original)) {\r\n                throw new TypeError(getError(6901));\r\n            }\r\n            if (original instanceof Component) {\r\n                warn('Should not instantiate a single cc.Component directly, you must instantiate the entire node.');\r\n            }\r\n        }\r\n    }\r\n\r\n    let clone;\r\n\r\n    if (isCCObject(original)) {\r\n        if (hasImplementedInstantiate(original)) {\r\n            cclegacy.game._isCloning = true;\r\n            clone = original._instantiate(null, true);\r\n            cclegacy.game._isCloning = false;\r\n            if (JSB) {\r\n                updateChildrenForDeserialize(clone as Node);\r\n            }\r\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n            return clone;\r\n        } else if (original instanceof cclegacy.Asset) {\r\n            throw new TypeError(getError(6903));\r\n        }\r\n    }\r\n\r\n    cclegacy.game._isCloning = true;\r\n    clone = doInstantiate(original);\r\n    cclegacy.game._isCloning = false;\r\n    if (JSB) {\r\n        updateChildrenForDeserialize(clone as Node);\r\n    }\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n    return clone;\r\n}\r\n\r\n/*\r\n * @en\r\n * Do instantiate object, the object to instantiate must be non-nil.\r\n * @zh\r\n * 这是一个通用的 instantiate 方法，可能效率比较低。\r\n * 之后可以给各种类型重写快速实例化的特殊实现，但应该在单元测试中将结果和这个方法的结果进行对比。\r\n * 值得注意的是，这个方法不可重入。\r\n * @param obj - 该方法仅供内部使用，用户需负责保证参数合法。什么参数是合法的请参考 cc.instantiate 的实现。\r\n * @param parent - 只有在该对象下的场景物体会被克隆。\r\n * @return {Object}\r\n * @private\r\n */\r\nfunction doInstantiate (obj, parent?): any {\r\n    if (DEV) {\r\n        if (Array.isArray(obj)) {\r\n            throw new TypeError(getError(6904));\r\n        }\r\n        if (misc.isDomNode(obj)) {\r\n            throw new TypeError(getError(6905));\r\n        }\r\n    }\r\n\r\n    let clone;\r\n    if (obj._iN$t) {\r\n        // User can specify an existing object by assigning the \"_iN$t\" property.\r\n        // enumerateObject will always push obj to objsToClearTmpVar\r\n        clone = obj._iN$t;\r\n    } else if (obj.constructor) {\r\n        const Klass = obj.constructor;\r\n        clone = new Klass();\r\n    } else {\r\n        clone = Object.create(null);\r\n    }\r\n\r\n    enumerateObject(obj, clone, parent);\r\n\r\n    for (let i = 0, len = objsToClearTmpVar.length; i < len; ++i) {\r\n        objsToClearTmpVar[i]._iN$t = null;\r\n    }\r\n    objsToClearTmpVar.length = 0;\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n    return clone;\r\n}\r\n\r\n// @param {Object} obj - The object to instantiate, typeof must be 'object' and should not be an array.\r\n\r\nfunction enumerateCCClass (klass, obj, clone, parent): void {\r\n    const props = klass.__values__;\r\n\r\n    for (let p = 0; p < props.length; p++) {\r\n        const key = props[p];\r\n        const value = obj[key];\r\n        if (typeof value === 'object' && value) {\r\n            const initValue = clone[key];\r\n            if (initValue instanceof ValueType\r\n                && initValue.constructor === value.constructor) {\r\n                initValue.set(value as ValueType);\r\n            } else {\r\n                clone[key] = value._iN$t || instantiateObj(value as any[], parent);\r\n            }\r\n        } else {\r\n            clone[key] = value;\r\n        }\r\n    }\r\n}\r\n\r\nfunction enumerateObject (obj, clone, parent): void {\r\n    // 目前使用“_iN$t”这个特殊字段来存实例化后的对象，这样做主要是为了防止循环引用\r\n    // 注意，为了避免循环引用，所有新创建的实例，必须在赋值前被设为源对象的_iN$t\r\n    js.value(obj as Record<string, any>, '_iN$t', clone, true);\r\n    objsToClearTmpVar.push(obj);\r\n    const klass: Constructor<unknown> = obj.constructor;\r\n    if (isCCClassOrFastDefined(klass)) {\r\n        enumerateCCClass(klass, obj, clone, parent);\r\n    } else {\r\n        // primitive javascript object\r\n        for (const key in obj) {\r\n            // eslint-disable-next-line no-prototype-builtins\r\n            if (!obj.hasOwnProperty(key)\r\n                || (key.charCodeAt(0) === 95 && key.charCodeAt(1) === 95   // starts with \"__\"\r\n                 && key !== '__type__'\r\n                 && key !== '__prefab')\r\n            ) {\r\n                continue;\r\n            }\r\n            const value = obj[key];\r\n            if (typeof value === 'object' && value) {\r\n                if (value === clone) {\r\n                    continue;   // value is obj._iN$t\r\n                }\r\n                clone[key] = value._iN$t || instantiateObj(value as any[], parent);\r\n            } else {\r\n                clone[key] = value;\r\n            }\r\n        }\r\n    }\r\n    if (isCCObject(obj)) {\r\n        clone._objFlags &= PersistentMask;\r\n    }\r\n}\r\n\r\n/*\r\n * @param {Object|Array} obj - the original non-nil object, typeof must be 'object'\r\n * @return {Object|Array} - the original non-nil object, typeof must be 'object'\r\n */\r\nfunction instantiateObj (obj: TypedArray | any[] | CCObject, parent: any): any {\r\n    if (obj instanceof ValueType) {\r\n        return obj.clone();\r\n    }\r\n    if (obj instanceof cclegacy.Asset) {\r\n        // 所有资源直接引用，不需要拷贝\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n        return obj;\r\n    }\r\n    let clone: any;\r\n    if (ArrayBuffer.isView(obj)) {\r\n        const len = obj.length;\r\n        clone = new (obj.constructor as TypedArrayConstructor)(len);\r\n        // NOTE: unknown  injected property `_iN$t`\r\n        (obj as any)._iN$t = clone;\r\n        objsToClearTmpVar.push(obj);\r\n        for (let i = 0; i < len; ++i) {\r\n            clone[i] = obj[i];\r\n        }\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n        return clone;\r\n    }\r\n    if (Array.isArray(obj)) {\r\n        const len = obj.length;\r\n        clone = new Array(len);\r\n        // NOTE: unknown  injected property `_iN$t`\r\n        (obj as any)._iN$t = clone;\r\n        objsToClearTmpVar.push(obj);\r\n        for (let i = 0; i < len; ++i) {\r\n            const value = obj[i];\r\n            if (typeof value === 'object' && value) {\r\n                clone[i] = value._iN$t || instantiateObj(value as any[], parent);\r\n            } else {\r\n                clone[i] = value;\r\n            }\r\n        }\r\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n        return clone;\r\n    } else if (obj._objFlags & Destroyed) {\r\n        // the same as cc.isValid(obj)\r\n        return null;\r\n    }\r\n\r\n    const ctor = obj.constructor as Constructor;\r\n    if (isCCClassOrFastDefined(ctor)) {\r\n        if (parent) {\r\n            if (parent instanceof Component) {\r\n                if (obj instanceof Node || obj instanceof Component) {\r\n                    // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n                    return obj;\r\n                }\r\n            } else if (parent instanceof Node) {\r\n                if (obj instanceof Node) {\r\n                    if (!obj.isChildOf(parent) && !isMountedChild(obj)) {\r\n                        // should not clone other nodes if not descendant and there is no mounted child\r\n                        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n                        return obj;\r\n                    }\r\n                } else if (obj instanceof Component) {\r\n                    if (obj.node && !obj.node.isChildOf(parent)) {\r\n                        // should not clone other component if not descendant\r\n                        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\r\n                        return obj;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        // eslint-disable-next-line new-cap\r\n        clone = new ctor();\r\n    } else if (ctor === Object) {\r\n        clone = {};\r\n    } else if (!ctor) {\r\n        clone = Object.create(null);\r\n    } else {\r\n        // unknown type\r\n        return obj;\r\n    }\r\n    enumerateObject(obj, clone, parent);\r\n    return clone;\r\n}\r\n\r\ninstantiate._clone = doInstantiate;\r\ncclegacy.instantiate = instantiate;\r\n"],"names":["Destroyed","CCObjectFlags","PersistentMask","objsToClearTmpVar","hasImplementedInstantiate","original","_instantiate","instantiate","clone","isCCObject","cclegacy","game","_isCloning","Asset","TypeError","getError","doInstantiate","obj","parent","enumerateObject","_iN$t","constructor","Klass","Object","create","i","len","length","enumerateCCClass","klass","props","__values__","p","key","value","initValue","ValueType","set","instantiateObj","js","push","isCCClassOrFastDefined","hasOwnProperty","charCodeAt","_objFlags","ArrayBuffer","isView","Array","isArray","editorExtras","ctor","Component","Node","isChildOf","editorExtrasTag","mountedRoot","node","_clone"],"mappings":"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"}