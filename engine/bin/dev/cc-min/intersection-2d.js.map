{"version":3,"file":"intersection-2d.js","sources":["../../../cocos/physics-2d/builtin/intersection-2d.ts"],"sourcesContent":["/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { Vec2, Rect } from '../../core';\r\n\r\n/**\r\n * @en Test line and line\r\n * @zh 测试线段与线段是否相交\r\n */\r\nfunction lineLine (a1: Readonly<Vec2>, a2: Readonly<Vec2>, b1: Readonly<Vec2>, b2: Vec2): boolean {\r\n    // jshint camelcase:false\r\n\r\n    const ua_t = (b2.x - b1.x) * (a1.y - b1.y) - (b2.y - b1.y) * (a1.x - b1.x);\r\n    const ub_t = (a2.x - a1.x) * (a1.y - b1.y) - (a2.y - a1.y) * (a1.x - b1.x);\r\n    const u_b = (b2.y - b1.y) * (a2.x - a1.x) - (b2.x - b1.x) * (a2.y - a1.y);\r\n\r\n    if (u_b !== 0) {\r\n        const ua = ua_t / u_b;\r\n        const ub = ub_t / u_b;\r\n\r\n        if (ua >= 0 && ua <= 1 && ub >= 0 && ub <= 1) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\nconst tempR1 = new Vec2();\r\nconst tempR2 = new Vec2();\r\nconst tempR3 = new Vec2();\r\nconst tempR4 = new Vec2();\r\n\r\n/**\r\n * @en Test line and rect\r\n * @zh 测试线段与矩形是否相交\r\n */\r\nfunction lineRect (a1: Readonly<Vec2>, a2: Readonly<Vec2>, b: Rect): boolean {\r\n    const r0 = tempR1.set(b.x, b.y);\r\n    const r1 = tempR2.set(b.x, b.yMax);\r\n    const r2 = tempR3.set(b.xMax, b.yMax);\r\n    const r3 = tempR4.set(b.xMax, b.y);\r\n\r\n    if (lineLine(a1, a2, r0, r1)) return true;\r\n\r\n    if (lineLine(a1, a2, r1, r2)) return true;\r\n\r\n    if (lineLine(a1, a2, r2, r3)) return true;\r\n\r\n    if (lineLine(a1, a2, r3, r0)) return true;\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test line and polygon\r\n * @zh 测试线段与多边形是否相交\r\n */\r\nfunction linePolygon (a1: Readonly<Vec2>, a2: Readonly<Vec2>, b: readonly Vec2[]): boolean {\r\n    const length = b.length;\r\n\r\n    for (let i = 0; i < length; ++i) {\r\n        const b1 = b[i];\r\n        const b2 = b[(i + 1) % length];\r\n\r\n        if (lineLine(a1, a2, b1, b2)) return true;\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test rect and rect\r\n * @zh 测试矩形与矩形是否相交\r\n */\r\nfunction rectRect (a: Rect, b: Rect): boolean {\r\n    // jshint camelcase:false\r\n\r\n    const a_min_x = a.x;\r\n    const a_min_y = a.y;\r\n    const a_max_x = a.x + a.width;\r\n    const a_max_y = a.y + a.height;\r\n\r\n    const b_min_x = b.x;\r\n    const b_min_y = b.y;\r\n    const b_max_x = b.x + b.width;\r\n    const b_max_y = b.y + b.height;\r\n\r\n    return a_min_x <= b_max_x\r\n        && a_max_x >= b_min_x\r\n        && a_min_y <= b_max_y\r\n        && a_max_y >= b_min_y;\r\n}\r\n\r\n/**\r\n * @en Test rect and polygon\r\n * @zh 测试矩形与多边形是否相交\r\n */\r\nfunction rectPolygon (a: Readonly<Rect>, b: readonly Vec2[]): boolean {\r\n    const r0 = tempR1.set(a.x, a.y);\r\n    const r1 = tempR2.set(a.x, a.yMax);\r\n    const r2 = tempR3.set(a.xMax, a.yMax);\r\n    const r3 = tempR4.set(a.xMax, a.y);\r\n\r\n    // intersection check\r\n    if (linePolygon(r0, r1, b)) return true;\r\n\r\n    if (linePolygon(r1, r2, b)) return true;\r\n\r\n    if (linePolygon(r2, r3, b)) return true;\r\n\r\n    if (linePolygon(r3, r0, b)) return true;\r\n\r\n    // check if a contains b\r\n    for (let i = 0, l = b.length; i < l; ++i) {\r\n        if (a.contains(b[i])) return true;\r\n    }\r\n\r\n    // check if b contains a\r\n    if (pointInPolygon(r0, b)) return true;\r\n\r\n    if (pointInPolygon(r1, b)) return true;\r\n\r\n    if (pointInPolygon(r2, b)) return true;\r\n\r\n    if (pointInPolygon(r3, b)) return true;\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test polygon and polygon\r\n * @zh 测试多边形与多边形是否相交\r\n */\r\nfunction polygonPolygon (a: readonly Vec2[], b: readonly Vec2[]): boolean {\r\n    let i; let l;\r\n\r\n    // check if a intersects b\r\n    for (i = 0, l = a.length; i < l; ++i) {\r\n        const a1 = a[i];\r\n        const a2 = a[(i + 1) % l];\r\n\r\n        if (linePolygon(a1, a2, b)) return true;\r\n    }\r\n\r\n    // check if a contains b\r\n    for (i = 0, l = b.length; i < l; ++i) {\r\n        if (pointInPolygon(b[i], a)) return true;\r\n    }\r\n\r\n    // check if b contains a\r\n    for (i = 0, l = a.length; i < l; ++i) {\r\n        if (pointInPolygon(a[i], b)) return true;\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test circle and circle\r\n * @zh 测试圆形与圆形是否相交\r\n */\r\nfunction circleCircle (c1p: Readonly<Vec2>, c1r: number, c2p: Readonly<Vec2>, c2r: number): boolean {\r\n    const distance = Vec2.distance(c1p, c2p);\r\n    return distance < (c1r + c2r);\r\n}\r\n\r\n/**\r\n * @en Test polygon and circle\r\n * @zh 测试多边形与圆形是否相交\r\n */\r\nfunction polygonCircle (polygon: readonly Vec2[], cp: Readonly<Vec2>, cr: number): boolean {\r\n    const position = cp;\r\n    if (pointInPolygon(position, polygon)) {\r\n        return true;\r\n    }\r\n\r\n    for (let i = 0, l = polygon.length; i < l; i++) {\r\n        const start = i === 0 ? polygon[polygon.length - 1] : polygon[i - 1];\r\n        const end = polygon[i];\r\n\r\n        if (pointLineDistance(position, start, end, true) < cr) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test rect and circle\r\n * @zh 测试矩形与圆形是否相交\r\n */\r\nfunction rectCircle (rect: Rect, cp: Readonly<Vec2>, cr: number): boolean {\r\n    const cx = cp.x;\r\n    const cy = cp.y;\r\n\r\n    const rx = rect.x;\r\n    const ry = rect.y;\r\n    const rw = rect.width;\r\n    const rh = rect.height;\r\n\r\n    // temporary variables to set edges for testing\r\n    let testX = cx;\r\n    let testY = cy;\r\n\r\n    // which edge is closest?\r\n    if (cx < rx) testX = rx;      // test left edge\r\n    else if (cx > rx + rw) testX = rx + rw;   // right edge\r\n    if (cy < ry) testY = ry;      // top edge\r\n    else if (cy > ry + rh) testY = ry + rh;   // bottom edge\r\n\r\n    // get distance from closest edges\r\n    const distX = cx - testX;\r\n    const distY = cy - testY;\r\n    const distance = Math.sqrt((distX * distX) + (distY * distY));\r\n\r\n    // if the distance is less than the radius, collision!\r\n    if (distance <= cr) {\r\n        return true;\r\n    }\r\n    return false;\r\n}\r\n\r\n/**\r\n * @en Test whether the point is in the polygon\r\n * @zh 测试一个点是否在一个多边形中\r\n */\r\nfunction pointInPolygon (point: Readonly<Vec2>, polygon: readonly Vec2[]): boolean {\r\n    let inside = false;\r\n    const x = point.x;\r\n    const y = point.y;\r\n\r\n    // use some raycasting to test hits\r\n    // https://github.com/substack/point-in-polygon/blob/master/index.js\r\n    const length = polygon.length;\r\n\r\n    for (let i = 0, j = length - 1; i < length; j = i++) {\r\n        const xi = polygon[i].x; const yi = polygon[i].y;\r\n        const xj = polygon[j].x; const yj = polygon[j].y;\r\n        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n\r\n        if (intersect) inside = !inside;\r\n    }\r\n\r\n    return inside;\r\n}\r\n\r\n/**\r\n * @en Calculate the distance of point to line.\r\n * @zh 计算点到直线的距离。如果这是一条线段并且垂足不在线段内，则会计算点到线段端点的距离。\r\n */\r\nfunction pointLineDistance (point: Readonly<Vec2>, start: Readonly<Vec2>, end: Readonly<Vec2>, isSegment: boolean): number {\r\n    let dx = end.x - start.x;\r\n    let dy = end.y - start.y;\r\n    const d = dx * dx + dy * dy;\r\n    const t = ((point.x - start.x) * dx + (point.y - start.y) * dy) / d;\r\n    let p;\r\n\r\n    if (!isSegment) {\r\n        p = tempR1.set(start.x + t * dx, start.y + t * dy);\r\n    } else if (d) {\r\n        if (t < 0) p = start;\r\n        else if (t > 1) p = end;\r\n        else p = tempR1.set(start.x + t * dx, start.y + t * dy);\r\n    } else {\r\n        p = start;\r\n    }\r\n\r\n    dx = point.x - p.x;\r\n    dy = point.y - p.y;\r\n    return Math.sqrt(dx * dx + dy * dy);\r\n}\r\n\r\n/**\r\n * @en Intersection2D helper class\r\n * @zh 辅助类，用于测试形状与形状是否相交\r\n * @class Intersection2D\r\n */\r\nexport default class Intersection2D {\r\n    static lineLine = lineLine;\r\n    static lineRect = lineRect;\r\n    static linePolygon = linePolygon;\r\n    static rectRect = rectRect;\r\n    static rectPolygon = rectPolygon;\r\n    static rectCircle = rectCircle;\r\n    static polygonPolygon = polygonPolygon;\r\n    static circleCircle = circleCircle;\r\n    static polygonCircle = polygonCircle;\r\n    static pointInPolygon = pointInPolygon;\r\n    static pointLineDistance = pointLineDistance;\r\n}\r\n"],"names":["lineLine","a1","a2","b1","b2","ua_t","x","y","ub_t","u_b","ua","ub","tempR1","Vec2","tempR2","tempR3","tempR4","linePolygon","b","length","i","pointInPolygon","point","polygon","inside","j","xi","yi","xj","yj","pointLineDistance","start","end","isSegment","p","dx","dy","d","t","set","Math","sqrt","Intersection2D","exports","lineRect","r0","r1","yMax","r2","xMax","r3","rectRect","a","a_min_x","a_min_y","a_max_x","width","a_max_y","height","b_min_x","b_min_y","b_max_x","b_max_y","rectPolygon","l","contains","rectCircle","rect","cp","cr","cx","cy","rx","ry","rw","rh","testX","testY","distX","distY","polygonPolygon","circleCircle","c1p","c1r","c2p","c2r","distance","polygonCircle","position"],"mappings":"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"}