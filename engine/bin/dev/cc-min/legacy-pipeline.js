System.register(["./global-exports-ZavlJGEN.js","./index-BcjqSS2q.js","./gc-object-BD6DANSw.js","./_virtual_internal_constants-CVZmBipG.js","./debug-view-zRQBd5E1.js","./pipeline-state-manager-C4BAah3w.js","./scene-D5fG1En6.js","./node-event-BDYemSfE.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./render-types-DTmbYHic.js","./touch-Ch03mDFP.js"],(function(e){"use strict";var t,r,i,a,s,n,o,h,d,l,u,_,p,c,f,S,g,O,T,A,E,m,F,I,v,w,D,b,B,y,R,P,N,C,L,M,H,U,x,G,W,Q,V,z,q,k,J,Z,j,X,Y,K,$,ee,te,re,ie,ae,se,ne,oe,he,de,le,ue,_e,pe,ce,fe,Se,ge,Oe,Te,Ae,Ee,me,Fe,Ie,ve,we,De,be,Be,ye,Re,Pe,Ne,Ce,Le,Me,He,Ue,xe,Ge,We,Qe,Ve,ze,qe,ke,Je,Ze,je,Xe,Ye,Ke,$e,et,tt,rt,it,at,st;return{setters:[function(e){t=e.c,r=e.l},function(e){i=e.f,a=e._,s=e.G,n=e.o,o=e.M,h=e.g,d=e.C,l=e.h,u=e.c,_=e.a,p=e.s,c=e.t,f=e.q,S=e.F,g=e.b3},function(e){O=e.P,T=e.w,A=e.a,E=e._,m=e.Z,F=e.a3,I=e.z,v=e.j,w=e.r,D=e.f,b=e.a5,B=e.h},null,function(e){y=e.S,R=e.j,P=e.v,N=e.f,C=e.L,L=e.P,M=e.h,H=e.R,U=e.n,x=e.t},function(e){G=e.b,W=e.J,Q=e.K,V=e.N,z=e.U,q=e.a,k=e.O,J=e.z,Z=e.i,j=e.Q,X=e.T,Y=e.V,K=e.W,$=e.G,ee=e.X,te=e.o,re=e.Y,ie=e.P,ae=e.S,se=e.A,ne=e.B,oe=e.L,he=e.Z,de=e._,le=e.c,ue=e.E,_e=e.$},function(e){pe=e.w,ce=e.o,fe=e.t,Se=e.C,ge=e.as,Oe=e.b,Te=e.g,Ae=e.ar,Ee=e.B,me=e.aF,Fe=e.aG,Ie=e.d},function(e){ve=e.A},function(e){we=e.d},function(e){De=e.ad,be=e.v,Be=e.ae,ye=e.ax,Re=e.B,Pe=e.b,Ne=e.M,Ce=e.ay,Le=e.w,Me=e.x,He=e.y,Ue=e.C,xe=e.aP,Ge=e.aL,We=e.ag,Qe=e.R,Ve=e.m,ze=e.aJ,qe=e.bc,ke=e.A,Je=e.F,Ze=e.I,je=e.o,Xe=e.a7,Ye=e.T,Ke=e.d,$e=e.e,et=e.ac,tt=e.bo,rt=e.al,it=e.ab,at=e.r},function(e){st=e.P},null],execute:function(){e("createDefaultPipeline",Ya);var nt=new i,ot=a.create(0,0,0,1),ht=new s(0,0,0,.5,.5,.5),dt=new s,lt=new O((function(){return{model:null,depth:0}}),128);function ut(e,t){var r=0;e.node&&(i.subtract(nt,e.worldBounds?e.worldBounds.center:e.node.worldPosition,t.position),r=i.dot(nt,t.forward));var a=lt.alloc();return a.model=e,a.depth=r,a}function _t(e,t){var r=e.validPunctualLights;r.length=0;for(var i=t.scene.spotLights,o=t.node.scene.globals.disableLightmap,h=0;h<i.length;h++){var d=i[h];d.baked&&!o||(a.set(ot,d.position.x,d.position.y,d.position.z,d.range),n.sphereFrustum(ot,t.frustum)&&r.push(d))}for(var l=t.scene.sphereLights,u=0;u<l.length;u++){var _=l[u];_.baked&&!o||(a.set(ot,_.position.x,_.position.y,_.position.z,_.range),n.sphereFrustum(ot,t.frustum)&&r.push(_))}for(var p=t.scene.pointLights,c=0;c<p.length;c++){var f=p[c];f.baked||(a.set(ot,f.position.x,f.position.y,f.position.z,f.range),n.sphereFrustum(ot,t.frustum)&&r.push(f))}for(var S=t.scene.rangedDirLights,g=0;g<S.length;g++){var O=S[g];s.transform(dt,ht,O.node.getWorldMatrix()),n.aabbFrustum(dt,t.frustum)&&r.push(O)}e.validPunctualLights=r}function pt(e,t,r){var i=e.scene.mainLight,a=t.csmLayers.layerObjects,s=r.validFrustum,o=r.shadowObjects;o.length=0;for(var h=e.visibility,d=a.length-1;d>=0;d--){var l=a.array[d];if(l){var u=l.model;u&&u.enabled&&u.node&&((h&u.node.layer)===u.node.layer||h&u.visFlags)&&u.worldBounds&&u.castShadow?n.aabbFrustum(u.worldBounds,s)&&(o.push(l),r.level<i.csmLevel&&i.csmOptimizationMode===ce.RemoveDuplicates&&n.aabbFrustumCompletelyInside(u.worldBounds,s)&&a.fastRemove(d)):a.fastRemove(d)}else a.fastRemove(d)}}function ct(e,t,r){var i=r.scene,a=i.mainLight,s=e.shadows,o=e.skybox,h=e.csmLayers,d=e.renderObjects;lt.freeArray(d),d.length=0;var l=h.castShadowObjects;l.length=0;var u=h.layerObjects;u.clear(),s.enabled&&(t.updateShadowUBORange(G.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===pe.ShadowMap&&a&&a.node&&h.update(e,r)),r.clearFlag&y.VALUE&&(o.enabled&&o.model?d.push(ut(o.model,r)):r.cameraUsage!==R.EDITOR&&r.cameraUsage!==R.SCENE_VIEW&&T(15100,r.name));var _=i.models,p=r.visibility;function c(e){if(e.enabled){if(i.isCulledByLod(r,e))return;if(e.castShadow&&(l.push(ut(e,r)),u.push(ut(e,r))),e.node&&(p&e.node.layer)===e.node.layer||p&e.visFlags){if(e.worldBounds&&!n.aabbFrustum(e.worldBounds,r.frustum))return;d.push(ut(e,r))}}}for(var f=0;f<_.length;f++)c(_[f])}var ft,St,gt,Ot,Tt,At=new De(be.LINEAR,be.LINEAR,be.NONE,Be.CLAMP,Be.CLAMP,Be.CLAMP),Et=new De(be.POINT,be.POINT,be.NONE,Be.CLAMP,Be.CLAMP,Be.CLAMP),mt=function(){function e(e){this._descriptorSetMap=new Map,this._device=e,this._linearSampler=this._device.getSampler(At),this._pointSampler=this._device.getSampler(Et);var t=new Ce(V.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new ye(this._descriptorSetLayout))}var t=e.prototype;return t.regenLayout=function(){var e=new Ce(V.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new ye(this._descriptorSetLayout))},t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindBuffer(e,t),i=r.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindSampler(e,t),i=r.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindTexture(e,t),i=r.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var r=this._globalDescriptorSet,i=t.createDescriptorSet(new ye(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var a=W.UBO_GLOBAL;a<W.COUNT;a++)i.bindBuffer(a,r.getBuffer(a)),i.bindSampler(a,r.getSampler(a)),i.bindTexture(a,r.getTexture(a));var s=t.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,G.SIZE,G.SIZE));i.bindBuffer(Q.BINDING,s),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},A(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet},set:function(e){this._globalDescriptorSet=e}}]),e}(),Ft=new o,It=new o,vt=new o,wt=new h,Dt=new h(0,0,1,0),bt=new i,Bt=o.toArray,yt=h.toArray,Rt=d.toArray,Pt=function(){function e(){this._globalUBO=new Float32Array(z.COUNT),this._cameraUBO=new Float32Array(q.COUNT),this._shadowUBO=new Float32Array(G.COUNT),this._csmUBO=new Float32Array(k.COUNT)}e.updateGlobalUBOView=function(e,r){var i=t.director,a=i.root,s=r,n=Math.floor(e.width),o=Math.floor(e.height);s[z.TIME_OFFSET]=a.cumulativeTime,s[z.TIME_OFFSET+1]=a.frameTime,s[z.TIME_OFFSET+2]=i.getTotalFrames(),s[z.TIME_OFFSET+3]=a.cumulativeTime-Math.floor(a.frameTime),s[z.SCREEN_SIZE_OFFSET]=n,s[z.SCREEN_SIZE_OFFSET+1]=o,s[z.SCREEN_SIZE_OFFSET+2]=1/n,s[z.SCREEN_SIZE_OFFSET+3]=1/o,s[z.NATIVE_SIZE_OFFSET]=n,s[z.NATIVE_SIZE_OFFSET+1]=o,s[z.NATIVE_SIZE_OFFSET+2]=1/s[z.NATIVE_SIZE_OFFSET],s[z.NATIVE_SIZE_OFFSET+3]=1/s[z.NATIVE_SIZE_OFFSET+1],t.internal.reflectionProbeManager&&(s[z.PROBE_INFO_OFFSET]=t.internal.reflectionProbeManager.getMaxProbeId()+1);for(var h=a.debugView,d=0;d<=3;d++)s[z.DEBUG_VIEW_MODE_OFFSET+d]=0;if(h.isEnabled()){s[z.DEBUG_VIEW_MODE_OFFSET]=h.singleMode;for(var l=P.DIRECT_DIFFUSE;l<P.MAX_BIT_COUNT;l++){var u=l>>3,_=l%8;s[z.DEBUG_VIEW_MODE_OFFSET+1+u]+=(h.isCompositeModeEnabled(l)?1:0)*Math.pow(10,_)}s[z.DEBUG_VIEW_MODE_OFFSET+3]+=(h.lightingWithAlbedo?1:0)*Math.pow(10,6),s[z.DEBUG_VIEW_MODE_OFFSET+3]+=(h.csmLayerColoration?1:0)*Math.pow(10,7)}},e.updateCameraUBOView=function(e,r,a){var s,n=(a.scene?a.scene:t.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,d=o.ambient,u=o.skybox,_=o.fog,p=o.shadows,c=r,f=a.exposure,S=o.isHDR;if(c[q.SCREEN_SCALE_OFFSET]=o.shadingScale,c[q.SCREEN_SCALE_OFFSET+1]=o.shadingScale,c[q.SCREEN_SCALE_OFFSET+2]=1/c[q.SCREEN_SCALE_OFFSET],c[q.SCREEN_SCALE_OFFSET+3]=1/c[q.SCREEN_SCALE_OFFSET+1],c[q.EXPOSURE_OFFSET]=f,c[q.EXPOSURE_OFFSET+1]=1/f,c[q.EXPOSURE_OFFSET+2]=S?1:0,c[q.EXPOSURE_OFFSET+3]=1/N.standardExposureValue,n){var g=n.shadowEnabled&&p.type===pe.ShadowMap?1:0,O=n.direction;if(Dt.set(O.x,O.y,O.z,g),yt(c,Dt,q.MAIN_LIT_DIR_OFFSET),i.toArray(c,n.color,q.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var T=n.colorTemperatureRGB;c[q.MAIN_LIT_COLOR_OFFSET]*=T.x,c[q.MAIN_LIT_COLOR_OFFSET+1]*=T.y,c[q.MAIN_LIT_COLOR_OFFSET+2]*=T.z}c[q.MAIN_LIT_COLOR_OFFSET+3]=S?n.illuminance*f:n.illuminance}else Dt.set(0,0,1,0),yt(c,Dt,q.MAIN_LIT_DIR_OFFSET),yt(c,h.ZERO,q.MAIN_LIT_COLOR_OFFSET);var A=d.skyColor;A.w=S?d.skyIllum*f:d.skyIllum,c[q.AMBIENT_SKY_OFFSET+0]=A.x,c[q.AMBIENT_SKY_OFFSET+1]=A.y,c[q.AMBIENT_SKY_OFFSET+2]=A.z,c[q.AMBIENT_SKY_OFFSET+3]=A.w,c[q.AMBIENT_GROUND_OFFSET+0]=d.groundAlbedo.x,c[q.AMBIENT_GROUND_OFFSET+1]=d.groundAlbedo.y,c[q.AMBIENT_GROUND_OFFSET+2]=d.groundAlbedo.z,c[q.AMBIENT_GROUND_OFFSET+3]=u.envmap?null==(s=u.envmap)?void 0:s.mipmapLevel:1,Bt(c,a.matView,q.MAT_VIEW_OFFSET),Bt(c,a.node.worldMatrix,q.MAT_VIEW_INV_OFFSET),i.toArray(c,a.position,q.CAMERA_POS_OFFSET),Bt(c,a.matProj,q.MAT_PROJ_OFFSET),Bt(c,a.matProjInv,q.MAT_PROJ_INV_OFFSET),Bt(c,a.matViewProj,q.MAT_VIEW_PROJ_OFFSET),Bt(c,a.matViewProjInv,q.MAT_VIEW_PROJ_INV_OFFSET),c[q.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),c[q.SURFACE_TRANSFORM_OFFSET]=a.surfaceTransform,c[q.SURFACE_TRANSFORM_OFFSET+1]=a.cameraUsage,c[q.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(l(o.skybox.getRotationAngle())),c[q.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(l(o.skybox.getRotationAngle()));var E=_.colorArray;c[q.GLOBAL_FOG_COLOR_OFFSET]=E.x,c[q.GLOBAL_FOG_COLOR_OFFSET+1]=E.y,c[q.GLOBAL_FOG_COLOR_OFFSET+2]=E.z,c[q.GLOBAL_FOG_COLOR_OFFSET+3]=E.z,c[q.GLOBAL_FOG_BASE_OFFSET]=_.fogStart,c[q.GLOBAL_FOG_BASE_OFFSET+1]=_.fogEnd,c[q.GLOBAL_FOG_BASE_OFFSET+2]=_.fogDensity,c[q.GLOBAL_FOG_ADD_OFFSET]=_.fogTop,c[q.GLOBAL_FOG_ADD_OFFSET+1]=_.fogRange,c[q.GLOBAL_FOG_ADD_OFFSET+2]=_.fogAtten,c[q.NEAR_FAR_OFFSET]=a.nearClip,c[q.NEAR_FAR_OFFSET+1]=a.farClip,c[q.NEAR_FAR_OFFSET+2]=a.getClipSpaceMinz(),c[q.VIEW_PORT_OFFSET]=o.shadingScale*a.window.width*a.viewport.x,c[q.VIEW_PORT_OFFSET+1]=o.shadingScale*a.window.height*a.viewport.y,c[q.VIEW_PORT_OFFSET+2]=o.shadingScale*a.window.width*a.viewport.z,c[q.VIEW_PORT_OFFSET+3]=o.shadingScale*a.window.height*a.viewport.w},e.getPCFRadius=function(e,t){var r=e.size.x;switch(t.shadowPcf){case fe.HARD:return 0;case fe.SOFT:return 1/(.5*r);case fe.SOFT_2X:return 2/(.5*r);case fe.SOFT_4X:return 3/(.5*r)}return 0},e.updatePlanarNormalAndDistance=function(e,t){i.normalize(bt,e.normal),t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=bt.x,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=bt.y,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=bt.z,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance},e.updateShadowUBOView=function(t,r,i,a){var s=t.device,n=a.scene.mainLight,o=t.pipelineSceneData,h=o.shadows,d=o.csmLayers,l=r,u=i,_=o.csmSupported,p=J(s)?0:1;if(n&&h.enabled){if(h.type===pe.ShadowMap){if(n.shadowEnabled){if(n.shadowFixedArea||n.csmLevel===Se.LEVEL_1||!_){var c=d.specialLayer.matShadowView,f=d.specialLayer.matShadowProj,S=d.specialLayer.matShadowViewProj,g=.1,O=0,T=0;n.shadowFixedArea?(g=n.shadowNear,O=n.shadowFar,T=0):(O=d.specialLayer.shadowCameraFar,T=1),Bt(l,c,G.MAT_LIGHT_VIEW_OFFSET),l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,l[G.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,l[G.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,l[G.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,l[G.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Bt(l,S,G.MAT_LIGHT_VIEW_PROJ_OFFSET),wt.set(g,O,0,1-n.shadowSaturation),yt(l,wt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),wt.set(C.DIRECTIONAL,p,n.shadowNormalBias,T),yt(l,wt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var A=this.getPCFRadius(h,n),E=0;E<n.csmLevel;E++){var m=d.layers[E],F=m.matShadowView;wt.set(F.m00,F.m04,F.m08,A),yt(u,wt,k.CSM_VIEW_DIR_0_OFFSET+4*E),wt.set(F.m01,F.m05,F.m09,m.splitCameraNear),yt(u,wt,k.CSM_VIEW_DIR_1_OFFSET+4*E),wt.set(F.m02,F.m06,F.m10,m.splitCameraFar),yt(u,wt,k.CSM_VIEW_DIR_2_OFFSET+4*E);var I=m.csmAtlas;yt(u,I,k.CSM_ATLAS_OFFSET+4*E);var v=m.matShadowViewProj;Bt(u,v,k.MAT_CSM_VIEW_PROJ_OFFSET+16*E);var w=m.matShadowProj;u[k.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*E]=w.m10,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*E]=w.m14,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*E]=w.m11,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*E]=w.m15,u[k.CSM_PROJ_INFO_OFFSET+0+4*E]=w.m00,u[k.CSM_PROJ_INFO_OFFSET+1+4*E]=w.m05,u[k.CSM_PROJ_INFO_OFFSET+2+4*E]=1/w.m00,u[k.CSM_PROJ_INFO_OFFSET+3+4*E]=1/w.m05}wt.set(n.csmTransitionRange,0,0,0),yt(u,wt,k.CSM_SPLITS_INFO_OFFSET),wt.set(.1,n.shadowDistance,0,1-n.shadowSaturation),yt(l,wt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),wt.set(C.DIRECTIONAL,p,n.shadowNormalBias,n.csmLevel),yt(l,wt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}wt.set(h.size.x,h.size.y,n.shadowPcf,n.shadowBias),yt(l,wt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(h,l),wt.set(0,0,0,h.planeBias),yt(l,wt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);Rt(l,h.shadowColor,G.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,r,i){var a=e.device,s=e.pipelineSceneData,n=s.shadows,h=s.csmLayers,d=t,l=J(a)?0:1,u=e.device.capabilities,_=s.csmSupported;switch(r.type){case C.DIRECTIONAL:var p=r;if(n.enabled&&p&&p.shadowEnabled&&n.type===pe.ShadowMap){var c,f,S,g=.1,O=0,T=0;if(p.shadowFixedArea||p.csmLevel===Se.LEVEL_1||!_)c=h.specialLayer.matShadowView,f=h.specialLayer.matShadowProj,S=h.specialLayer.matShadowViewProj,p.shadowFixedArea?(g=p.shadowNear,O=p.shadowFar,T=0):(g=.1,O=h.specialLayer.shadowCameraFar,T=1),wt.set(C.DIRECTIONAL,l,p.shadowNormalBias,0),yt(d,wt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var A=h.layers[i];c=A.matShadowView,f=A.matShadowProj,S=A.matShadowViewProj,g=A.splitCameraNear,O=A.splitCameraFar,T=p.csmLevel}Bt(d,c,G.MAT_LIGHT_VIEW_OFFSET),d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,d[G.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,d[G.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,d[G.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,d[G.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Bt(d,S,G.MAT_LIGHT_VIEW_PROJ_OFFSET),wt.set(g,O,0,1-p.shadowSaturation),yt(d,wt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),wt.set(C.DIRECTIONAL,l,p.shadowNormalBias,T),yt(d,wt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),wt.set(n.size.x,n.size.y,p.shadowPcf,p.shadowBias),yt(d,wt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case C.SPOT:var E=r;n.enabled&&E&&E.shadowEnabled&&(o.invert(Ft,r.node.getWorldMatrix()),Bt(d,Ft,G.MAT_LIGHT_VIEW_OFFSET),o.perspective(It,E.angle,1,.001,E.range,!0,u.clipSpaceMinZ,u.clipSpaceSignY,0),o.multiply(vt,It,Ft),Bt(d,vt,G.MAT_LIGHT_VIEW_PROJ_OFFSET),wt.set(.01,r.range,0,0),yt(d,wt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),wt.set(n.size.x,n.size.y,E.shadowPcf,E.shadowBias),yt(d,wt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),wt.set(C.SPOT,l,E.shadowNormalBias,0),yt(d,wt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}Rt(d,n.shadowColor,G.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var r=e.prototype;return r._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},r.activate=function(e,t){this._device=e,this._pipeline=t;var r=this._pipeline.descriptorSet;if(!Z()){this._initCombineSignY();var i=e.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,z.SIZE,z.SIZE));r.bindBuffer(j.BINDING,i);var a=e.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,q.SIZE,q.SIZE));r.bindBuffer(X.BINDING,a);var s=e.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,G.SIZE,G.SIZE));r.bindBuffer(Q.BINDING,s);var n=e.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,k.SIZE,k.SIZE));r.bindBuffer(Y.BINDING,n)}},r.updateGlobalUBO=function(t){var r=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,a=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),a[0].updateBuffer(i.getBuffer(j.BINDING),this._globalUBO),r.bindBuffer(j.BINDING,i.getBuffer(j.BINDING)),r.update()},r.updateCameraUBO=function(t){var r=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,a=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),a[0].updateBuffer(i.getBuffer(X.BINDING),this._cameraUBO),r.bindBuffer(X.BINDING,i.getBuffer(X.BINDING)),r.update()},r.updateShadowUBO=function(t){var r=this._pipeline.pipelineSceneData;if(r.shadows.enabled){var i=this._pipeline.globalDSManager,a=this._pipeline.descriptorSet,s=this._pipeline.commandBuffers,n=r.shadowFrameBufferMap,o=t.scene.mainLight;o&&n.has(o)&&i.bindTexture(K,n.get(o).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),i.update(),s[0].updateBuffer(a.getBuffer(Q.BINDING),this._shadowUBO),s[0].updateBuffer(a.getBuffer(Y.BINDING),this._csmUBO)}},r.updateShadowUBOLight=function(t,r,i){void 0===i&&(i=0),e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,r,i),t.bindTexture(K,$(this._pipeline.device)),t.bindTexture(ee,$(this._pipeline.device)),t.update(),this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(Q.BINDING),this._shadowUBO)},r.updateShadowUBORange=function(e,t){t instanceof o?Bt(this._shadowUBO,t,e):t instanceof d&&Rt(this._shadowUBO,t,e)},r.destroy=function(){},e}();Pt._combineSignY=0;var Nt,Ct,Lt,Mt,Ht,Ut,xt,Gt,Wt=e("RenderStage",u("RenderStage")((St=function(){function e(){this._name=gt&&gt(),this._priority=Ot&&Ot(),this._enabled=!0,this._tag=Tt&&Tt(),this._pipeline=void 0,this._flow=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},A(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),gt=_(St.prototype,"_name",[p],(function(){return""})),Ot=_(St.prototype,"_priority",[p],(function(){return 0})),Tt=_(St.prototype,"_tag",[p],(function(){return 0})),ft=St))||ft);t.RenderStage=Wt;var Qt,Vt,zt,qt,kt,Jt,Zt=e("RenderFlow",(Nt=u("RenderFlow"),Ct=c([Wt]),Nt((Mt=function(){function e(){this._name=Ht&&Ht(),this._priority=Ut&&Ut(),this._tag=xt&&xt(),this._stages=Gt&&Gt(),this._pipeline=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,r=this._stages.length;t<r;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,r=this._stages.length;t<r;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},A(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Ht=_(Mt.prototype,"_name",[p],(function(){return""})),Ut=_(Mt.prototype,"_priority",[p],(function(){return 0})),xt=_(Mt.prototype,"_tag",[p],(function(){return 0})),Gt=_(Mt.prototype,"_stages",[Ct,p],(function(){return[]})),Lt=Mt))||Lt));t.RenderFlow=Zt;var jt=new et,Xt=new tt,Yt=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null};function Kt(e){for(var t,r=666,i=v(e.colorTextures);!(t=i()).done;){var a=t.value,s=null==a?void 0:a.info,n=s.type+"_"+s.usage+"_"+s.format+"_"+s.width+"_"+s.height+"_"+s.flags+"_\n            "+s.layerCount+"_"+s.levelCount+"_"+s.samples+"_"+s.depth+"_"+s.externalRes;r=Ve(n,r)}if(e.depthStencilTexture){var o=e.depthStencilTexture.info,h=o.type+"_"+o.usage+"_"+o.format+"_"+o.width+"_"+o.height+"_"+o.flags+"_\n            "+o.layerCount+"_"+o.levelCount+"_"+o.samples+"_"+o.depth+"_"+o.externalRes;r=Ve(h,r)}return r}var $t,er,tr,rr,ir,ar,sr,nr,or,hr,dr,lr,ur,_r,pr,cr,fr,Sr,gr,Or,Tr,Ar,Er,mr,Fr,Ir,vr,wr,Dr,br,Br,yr,Rr,Pr,Nr,Cr,Lr,Mr,Hr,Ur,xr,Gr,Wr,Qr,Vr,zr,qr,kr,Jr,Zr,jr,Xr,Yr,Kr,$r,ei,ti,ri,ii,ai,si,ni,oi,hi,di,li,ui,_i,pi,ci,fi,Si,gi,Oi,Ti,Ai,Ei,mi,Fi,Ii,vi,wi,Di,bi,Bi=e("RenderPipeline",(Qt=u("cc.RenderPipeline"),Vt=c([Zt]),Qt((qt=function(e){function t(t){var r;return(r=e.call(this,t)||this)._tag=kt&&kt(),r._flows=Jt&&Jt(),r._quadIB=null,r._quadVBOnscreen=null,r._quadVBOffscreen=null,r._quadIAOnscreen=null,r._quadIAOffscreen=null,r._eventProcessor=new M,r._device=void 0,r._globalDSManager=void 0,r._descriptorSet=void 0,r._commandBuffers=[],r._pipelineUBO=new Pt,r._macros={},r._constantMacros="",r._profiler=null,r._geometryRenderer=null,r._pipelineRenderData=null,r._renderPasses=new Map,r._width=0,r._height=0,r._lastUsedRenderArea=new et,r._clusterEnabled=!1,r._bloomEnabled=!1,r}E(t,e);var r=t.prototype;return r.getPipelineRenderData=function(){return this._pipelineRenderData},r.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},r.createRenderPass=function(e,t,r){var i=this._device,a=new Le,s=new Me;a.format=t,s.format=r,s.stencilStoreOp=He.DISCARD,s.depthStoreOp=He.DISCARD,e&Ue.COLOR||(e&y.VALUE?a.loadOp=xe.CLEAR:(a.loadOp=xe.LOAD,a.barrier=i.getGeneralBarrier(new Ge(We.COLOR_ATTACHMENT_WRITE,We.COLOR_ATTACHMENT_WRITE)))),(e&Ue.DEPTH_STENCIL)!==Ue.DEPTH_STENCIL&&(e&Ue.DEPTH||(s.depthLoadOp=xe.LOAD),e&Ue.STENCIL||(s.stencilLoadOp=xe.LOAD)),s.barrier=i.getGeneralBarrier(new Ge(We.DEPTH_STENCIL_ATTACHMENT_WRITE,We.DEPTH_STENCIL_ATTACHMENT_WRITE));var n=new Qe([a],s);return i.createRenderPass(n)},r.getRenderPass=function(e,t){var r=Kt(t),i=Ve(r+"_"+e,666),a=this._renderPasses.get(i);return a||(a=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(i,a),a)},r.newFramebufferByRatio=function(e){for(var t=this.pipelineSceneData,r=this._width*t.shadingScale,i=this._height*t.shadingScale,a=e.colorTextures,s=0;s<a.length;s++)a[s].resize(r,i);e.depthStencilTexture&&e.depthStencilTexture.resize(r,i);var n=this._device.createFramebuffer(new ze(e.renderPass,a,e.depthStencilTexture));return e.destroy(),n},r.generateRenderArea=function(e,t){var r=e.viewport,i=e.window.width,a=e.window.height;t.x=r.x*i,t.y=r.y*a,t.width=r.width*i,t.height=r.height*a},r.generateViewport=function(e,t){this.generateRenderArea(e,jt),t||(t=Xt);var r=this.pipelineSceneData.shadingScale;return t.left=jt.x*r,t.top=jt.y*r,t.width=jt.width*r,t.height=jt.height*r,t},r.generateScissor=function(e,t){t||(t=jt),this.generateRenderArea(e,t);var r=this.pipelineSceneData.shadingScale;return t.x*=r,t.y*=r,t.width*=r,t.height*=r,t},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.activate=function(){this._device=we.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new mt(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},r._ensureEnoughSize=function(){},r.render=function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit(L.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),ge(e);for(var t=0;t<e.length;t++){var r=e[t];if(r.scene){this.emit(L.RENDER_CAMERA_BEGIN,r),_t(this.pipelineSceneData,r),ct(this.pipelineSceneData,this.pipelineUBO,r),this._pipelineUBO.updateGlobalUBO(r.window),this._pipelineUBO.updateCameraUBO(r);for(var i=0;i<this._flows.length;i++)this._flows[i].render(r);this.emit(L.RENDER_CAMERA_END,r)}}this.emit(L.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},r._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},r._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var r=0;r<t.downsampleTexs.length;++r)t.downsampleTexs[r].destroy(),t.downsampleFramebuffers[r].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null==(e=t.renderPass)||e.destroy(),this._pipelineRenderData.bloom=null}},r._genQuadVertexData=function(e,t){var r=new Float32Array(16),i=t.x/this._width,a=(t.x+t.width)/this._width,s=t.y/this._height,n=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=n;n=s,s=o}var h=0;switch(e){case qe.IDENTITY:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=n,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=s;break;case qe.ROTATE_90:h=0,r[h++]=-1,r[h++]=-1,r[h++]=a,r[h++]=n,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=s,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=1,r[h++]=i,r[h++]=s;break;case qe.ROTATE_180:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=s,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=n;break;case qe.ROTATE_270:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=-1,r[h++]=i,r[h++]=n,r[h++]=-1,r[h++]=1,r[h++]=a,r[h++]=s,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=n}return r},r._createQuadInputAssembler=function(){var e=new st,t=4*Float32Array.BYTES_PER_ELEMENT,r=4*t,i=this._device.createBuffer(new Re(Pe.VERTEX|Pe.TRANSFER_DST,Ne.DEVICE|Ne.HOST,r,t));if(!i)return e;var a=Uint8Array.BYTES_PER_ELEMENT,s=6*a,n=this._device.createBuffer(new Re(Pe.INDEX|Pe.TRANSFER_DST,Ne.DEVICE,s,a));if(!n)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,n.update(o);var h=new Array(2);h[0]=new ke("a_position",Je.RG32F),h[1]=new ke("a_texCoord",Je.RG32F);var d=this._device.createInputAssembler(new Ze(h,[i],n));return e.quadIB=n,e.quadVB=i,e.quadIA=d,e},r.updateQuadVertexData=function(e,t){var r=this._lastUsedRenderArea;if(r.x!==e.x||r.y!==e.y||r.width!==e.width||r.height!==e.height){var i=this._genQuadVertexData(qe.IDENTITY,e);this._quadVBOffscreen.update(i);var a=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||qe.IDENTITY,e);this._quadVBOnscreen.update(a),r.copy(e)}},r.destroy=function(){for(var t,r,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null==(t=this._globalDSManager)||t.destroy();for(var a=0;a<this._commandBuffers.length;a++)this._commandBuffers[a].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null==(r=this._pipelineSceneData)||r.destroy(),e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(Je.RGBA32F)&(je.RENDER_TARGET|je.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(Xe.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(m.os===F.ANDROID&&m.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(I.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+te.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e},r.updateGeometryRenderer=function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var r=e[t];if(r&&r.window&&r.window.swapchain)return r.initGeometryRenderer(),void(this._geometryRenderer=r.geometryRenderer)}},r.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Yt,t=this.device,r=new Le;r.format=Je.RGBA8,r.loadOp=xe.CLEAR,r.storeOp=He.STORE,r.barrier=t.getGeneralBarrier(new Ge(We.NONE,We.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Qe([r]));var i=this._width,a=this._height;e.prefiterTex=t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA8,i>>1,a>>1)),e.prefilterFramebuffer=t.createFramebuffer(new ze(e.renderPass,[e.prefiterTex])),i>>=1,a>>=1;for(var s=0;s<6;++s)e.downsampleTexs.push(t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA8,i>>1,a>>1))),e.downsampleFramebuffers[s]=t.createFramebuffer(new ze(e.renderPass,[e.downsampleTexs[s]])),e.upsampleTexs.push(t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA8,i,a))),e.upsampleFramebuffers[s]=t.createFramebuffer(new ze(e.renderPass,[e.upsampleTexs[s]])),i>>=1,a>>=1;e.combineTex=t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new ze(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},r.on=function(e,t,r,i){return this._eventProcessor.on(e,t,r,i)},r.once=function(e,t,r){return this._eventProcessor.once(e,t,r)},r.off=function(e,t,r){this._eventProcessor.off(e,t,r)},r.emit=function(e,t,r,i,a,s){this._eventProcessor.emit(e,t,r,i,a,s)},r.targetOff=function(e){this._eventProcessor.targetOff(e)},r.removeAll=function(e){this._eventProcessor.removeAll(e)},r.hasEventListener=function(e,t,r){return this._eventProcessor.hasEventListener(e,t,r)},A(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit(L.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(ve),kt=_(qt.prototype,"_tag",[p],(function(){return 0})),Jt=_(qt.prototype,"_flows",[Vt,p],(function(){return[]})),zt=qt))||zt));t.RenderPipeline=Bi,f(Bi.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]),function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}($t||($t={})),function(e){e[e.AR=5]="AR",e[e.FORWARD=10]="FORWARD"}(er||(er={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(tr||(tr={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(rr||(rr={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(ir||(ir={})),w(Ke),w($e),w(He),w(xe),w(We),w(Je),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(bi||(bi={})),w(bi),ar=u("RenderTextureDesc"),sr=c(Ke),nr=c($e),or=c(Je),ar((hr=function(){this.name=dr&&dr(),this.type=lr&&lr(),this.usage=ur&&ur(),this.format=_r&&_r(),this.width=pr&&pr(),this.height=cr&&cr()},dr=_(hr.prototype,"name",[p],(function(){return""})),lr=_(hr.prototype,"type",[sr],(function(){return Ke.TEX2D})),ur=_(hr.prototype,"usage",[nr],(function(){return $e.COLOR_ATTACHMENT})),_r=_(hr.prototype,"format",[or],(function(){return Je.UNKNOWN})),pr=_(hr.prototype,"width",[p],(function(){return-1})),cr=_(hr.prototype,"height",[p],(function(){return-1})),hr));var yi=(fr=u("RenderTextureConfig"),Sr=c(H),fr((Or=function(){this.name=Tr&&Tr(),this.texture=Ar&&Ar()},Tr=_(Or.prototype,"name",[p],(function(){return""})),Ar=_(Or.prototype,"texture",[Sr],(function(){return null})),gr=Or))||gr);Er=u("MaterialConfig"),mr=c(Oe),Er((Fr=function(){this.name=Ir&&Ir(),this.material=vr&&vr()},Ir=_(Fr.prototype,"name",[p],(function(){return""})),vr=_(Fr.prototype,"material",[mr],(function(){return null})),Fr)),wr=u("FrameBufferDesc"),Dr=c([D]),br=c(H),wr((Br=function(){this.name=yr&&yr(),this.renderPass=Rr&&Rr(),this.colorTextures=Pr&&Pr(),this.depthStencilTexture=Nr&&Nr(),this.texture=Cr&&Cr()},yr=_(Br.prototype,"name",[p],(function(){return""})),Rr=_(Br.prototype,"renderPass",[p],(function(){return 0})),Pr=_(Br.prototype,"colorTextures",[Dr],(function(){return[]})),Nr=_(Br.prototype,"depthStencilTexture",[p],(function(){return""})),Cr=_(Br.prototype,"texture",[br],(function(){return null})),Br));var Ri,Pi=(Lr=u("ColorDesc"),Mr=c(Je),Hr=c(xe),Ur=c(He),xr=c(We),Gr=c(We),Lr((Qr=function(){this.format=Vr&&Vr(),this.loadOp=zr&&zr(),this.storeOp=qr&&qr(),this.sampleCount=kr&&kr(),this.beginAccesses=Jr&&Jr(),this.endAccesses=Zr&&Zr()},Vr=_(Qr.prototype,"format",[Mr],(function(){return Je.UNKNOWN})),zr=_(Qr.prototype,"loadOp",[Hr],(function(){return xe.CLEAR})),qr=_(Qr.prototype,"storeOp",[Ur],(function(){return He.STORE})),kr=_(Qr.prototype,"sampleCount",[p],(function(){return 1})),Jr=_(Qr.prototype,"beginAccesses",[xr],(function(){return We.NONE})),Zr=_(Qr.prototype,"endAccesses",[Gr],(function(){return We.COLOR_ATTACHMENT_WRITE})),Wr=Qr))||Wr),Ni=(jr=u("DepthStencilDesc"),Xr=c(Je),Yr=c(xe),Kr=c(He),$r=c(xe),ei=c(He),ti=c(We),ri=c(We),jr((ai=function(){this.format=si&&si(),this.depthLoadOp=ni&&ni(),this.depthStoreOp=oi&&oi(),this.stencilLoadOp=hi&&hi(),this.stencilStoreOp=di&&di(),this.sampleCount=li&&li(),this.beginAccesses=ui&&ui(),this.endAccesses=_i&&_i()},si=_(ai.prototype,"format",[Xr],(function(){return Je.UNKNOWN})),ni=_(ai.prototype,"depthLoadOp",[Yr],(function(){return xe.CLEAR})),oi=_(ai.prototype,"depthStoreOp",[Kr],(function(){return He.STORE})),hi=_(ai.prototype,"stencilLoadOp",[$r],(function(){return xe.CLEAR})),di=_(ai.prototype,"stencilStoreOp",[ei],(function(){return He.STORE})),li=_(ai.prototype,"sampleCount",[p],(function(){return 1})),ui=_(ai.prototype,"beginAccesses",[ti],(function(){return We.NONE})),_i=_(ai.prototype,"endAccesses",[ri],(function(){return We.DEPTH_STENCIL_ATTACHMENT_WRITE})),ii=ai))||ii);pi=u("RenderPassDesc"),ci=c([Pi]),fi=c(Ni),pi((Si=function(){this.index=gi&&gi(),this.colorAttachments=Oi&&Oi(),this.depthStencilAttachment=Ti&&Ti()},gi=_(Si.prototype,"index",[p],(function(){return-1})),Oi=_(Si.prototype,"colorAttachments",[ci],(function(){return[]})),Ti=_(Si.prototype,"depthStencilAttachment",[fi],(function(){return new Ni})),Si)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(Ri||(Ri={})),w(Ri);var Ci=(Ai=u("RenderQueueDesc"),Ei=c(Ri),mi=c([D]),Ai((Ii=function(){this.isTransparent=vi&&vi(),this.sortMode=wi&&wi(),this.stages=Di&&Di()},vi=_(Ii.prototype,"isTransparent",[p],(function(){return!1})),wi=_(Ii.prototype,"sortMode",[Ei],(function(){return Ri.FRONT_TO_BACK})),Di=_(Ii.prototype,"stages",[mi],(function(){return[]})),Fi=Ii))||Fi);function Li(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Mi(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Hi=function(){function e(e){this._passDesc=e,this._passPool=re(),this.queue=new b(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,r){var i=e.model.subModels[t],a=i.passes[r],s=i.shaders[r];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(a.phase&this._passDesc.phases))return!1;var n=a.priority<<16|i.priority<<8|r,o=this._passPool.add();return o.priority=e.model.priority,o.hash=n,o.depth=e.depth||0,o.shaderId=s.typedID,o.subModel=i,o.passIdx=r,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,r){for(var i=0;i<this.queue.length;++i){var a=this.queue.array[i],s=a.subModel,n=a.passIdx,o=s.inputAssembler,h=s.passes[n],d=s.shaders[n],l=ie.getOrCreatePipelineState(e,h,d,t,o);r.bindPipelineState(l),r.bindDescriptorSet(ae.MATERIAL,h.descriptorSet),r.bindDescriptorSet(ae.LOCAL,s.descriptorSet),r.bindInputAssembler(o),r.draw(o)}},e}();function Ui(e){for(var t=0,r=0;r<e.stages.length;r++)t|=Te(e.stages[r]);var i=Li;switch(e.sortMode){case Ri.BACK_TO_FRONT:i=Mi;break;case Ri.FRONT_TO_BACK:i=Li}return new Hi({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function xi(e){e.clear()}function Gi(e){e.sort()}var Wi=function(){function e(){this.queue=new Set,this._renderQueue=[]}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue.length=0,this.queue.clear()},t.sort=function(){var e=this,t=Array.from(this.queue).sort(Ae);t.forEach((function(t){var r;null!=(r=t.pass.blendState.targets[0])&&r.blend||e._renderQueue.push(t)})),t.forEach((function(t){var r;null!=(r=t.pass.blendState.targets[0])&&r.blend&&e._renderQueue.push(t)}))},t.uploadBuffers=function(e){for(var t=this.queue.values(),r=t.next();!r.done;)r.value.hasPendingModels&&r.value.uploadBuffers(e),r=t.next()},t.recordCommandBuffer=function(e,t,r,i,a){void 0===i&&(i=null);for(var s=0===this._renderQueue.length?this.queue.values():this._renderQueue[Symbol.iterator](),n=s.next();!n.done;){var o=n.value,h=o.instances,d=o.pass;if(o.hasPendingModels){r.bindDescriptorSet(ae.MATERIAL,d.descriptorSet);for(var l=null,u=0;u<h.length;++u){var _=h[u];if(_.count){var p=_.shader,c=ie.getOrCreatePipelineState(e,d,p,t,_.ia);l!==c&&(r.bindPipelineState(c),l=c),i&&r.bindDescriptorSet(ae.GLOBAL,i),a?r.bindDescriptorSet(ae.LOCAL,_.descriptorSet,a):r.bindDescriptorSet(ae.LOCAL,_.descriptorSet,n.value.dynamicOffsets),r.bindInputAssembler(_.ia),r.draw(_.ia)}}}n=s.next()}},e}(),Qi=new O((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Vi=new i,zi=new Float32Array(4),qi=[],ki=[],Ji=new o,Zi=new o,ji=new s(0,0,0,.5,.5,.5),Xi=new s;function Yi(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb))}function Ki(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb)&&n.aabbFrustum(t.worldBounds,e.frustum))}function $i(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb))}function ea(e,t){return s.transform(Xi,ji,e.node.getWorldMatrix()),!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,Xi))}var ta="forward-add",ra=Te(ta),ia=[];function aa(e,r,i){void 0===i&&(i="default");var a=t.rendering;Z()&&(ra=a.getPhaseID(a.getPassID(i),ta)),r.length=0;for(var s=!1,n=0;n<e.length;n++){for(var o=e[n].passes,h=-1,d=0;d<o.length;d++)if((!a||!a.enableEffectImport)&&o[d].phase===ra||Z()&&o[d].phaseID===ra){h=d,s=!0;break}r.push(h)}return s}var sa=function(){function e(e){this._lightPasses=[],this._instancedLightPassPool=Qi.alloc(),this._shadowUBO=new Float32Array(G.COUNT),this._lightBufferCount=16,this._instancedQueues=[],this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(se.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new rt(this._lightBuffer,0,se.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueues.forEach((function(e){e.clear()})),this._instancedQueues.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Qi.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,r=0;r<t.length;r++){var i=t[r],a=e.get(i);a&&(a.getBuffer(Q.BINDING).destroy(),a.getTexture(K).destroy(),a.getTexture(ee).destroy(),a.destroy()),e.delete(i)}},t._bindForwardAddLight=function(e,t){void 0===t&&(t="default");for(var r=this._pipeline.pipelineSceneData.renderObjects,i=0;i<r.length;i++){var a=r[i].model,s=a.subModels;if(aa(s,ia,t)&&(ki.length=0,this._lightCulling(a,e),ki.length||!(e.length>0)))for(var n=0;n<s.length;n++){var o=ia[n];if(!(o<0)){var h=s[n],d=h.passes[o];h.passes[0].blendState.targets[0].blend||(h.descriptorSet.bindBuffer(ne.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(d,h,a,o))}}}},t.gatherLightPasses=function(e,t,r){void 0===r&&(r="default"),this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t),this._bindForwardAddLight(i,r);for(var a=0;a<i.length;a++){var s=i[a];this._instancedLightPassPool.lights.push(s),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*a)}this._instancedQueues.forEach((function(e){e.uploadBuffers(t)}))}else this._bindForwardAddLight(i,r)},t.recordCommandBuffer=function(e,t,r){for(var i=this._pipeline.globalDSManager,a=0;a<this._instancedQueues.length;++a){var s=this._instancedLightPassPool.lights[a];qi[0]=this._instancedLightPassPool.dynamicOffsets[a];var n=i.getOrCreateDescriptorSet(s);this._instancedQueues[a].recordCommandBuffer(e,t,r,n,qi)}for(var o=0;o<this._lightPasses.length;o++){var h=this._lightPasses[o],d=h.subModel,l=h.passIdx,u=h.dynamicOffsets,_=h.lights,p=d.passes[l],c=d.shaders[l],f=d.inputAssembler,S=ie.getOrCreatePipelineState(e,p,c,t,f),g=p.descriptorSet,O=d.descriptorSet;r.bindPipelineState(S),r.bindDescriptorSet(ae.MATERIAL,g),r.bindInputAssembler(f);for(var T=0;T<u.length;++T){var A=_[T],E=i.getOrCreateDescriptorSet(A);qi[0]=u[T],r.bindDescriptorSet(ae.GLOBAL,E),r.bindDescriptorSet(ae.LOCAL,O,qi),r.draw(f)}}},t._lightCulling=function(e,t){for(var r=!1,i=0;i<t.length;i++){var a=t[i];switch(a.type){case C.SPHERE:r=Yi(a,e);break;case C.SPOT:r=Ki(a,e);break;case C.POINT:r=$i(a,e);break;case C.RANGED_DIRECTIONAL:r=ea(a,e)}r||ki.push(i)}},t._addRenderQueue=function(e,t,r,i){var a=this._pipeline.pipelineSceneData.validPunctualLights,s=e.batchingScheme,n=null;s===Ee.NONE&&((n=Qi.alloc()).subModel=t,n.passIdx=i);for(var o=0;o<ki.length;o++){var h=ki[o],d=a[h];if((d.visibility&r.node.layer)===r.node.layer)if(s===Ee.INSTANCING){var l=e.getInstancedBuffer(o);l.merge(t,i),l.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueues[o]||(this._instancedQueues[o]=new Wi),this._instancedQueues[o].queue.add(l)}else n.lights.push(d),n.dynamicOffsets.push(this._lightBufferStride*h)}s===Ee.NONE&&this._lightPasses.push(n)},t._updateLightDescriptorSet=function(e,t){for(var r=this._pipeline.device,i=this._pipeline.pipelineSceneData,a=i.shadows,s=i.shadowFrameBufferMap,n=e.scene.mainLight,h=J(r)?0:1,l=this._pipeline.globalDSManager,u=i.validPunctualLights,_=this._pipeline.device.capabilities,p=0;p<u.length;p++){var c=u[p],f=l.getOrCreateDescriptorSet(c);if(f){var S=void 0,g=void 0;switch(c.type){case C.SPHERE:n&&Pt.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=C.SPHERE,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET);break;case C.SPOT:var O=c;if(n&&Pt.updatePlanarNormalAndDistance(a,this._shadowUBO),o.invert(Ji,c.node.getWorldMatrix()),o.perspective(Zi,c.angle,1,.001,c.range,!0,_.clipSpaceMinZ,_.clipSpaceSignY,0),S=Zi.clone(),g=Zi.clone().invert(),o.multiply(Zi,Zi,Ji),o.toArray(this._shadowUBO,Ji,G.MAT_LIGHT_VIEW_OFFSET),o.toArray(this._shadowUBO,Zi,G.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c.range,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=O.shadowPcf,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=O.shadowBias,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=C.SPOT,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=O.shadowNormalBias,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=S.m10,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=S.m14,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=S.m11,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=S.m15,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+0]=S.m00,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+1]=S.m05,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+2]=1/S.m00,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+3]=1/S.m05,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET),s.has(c)){var T,A=null==(T=s.get(c))?void 0:T.colorTextures[0];A&&l.bindTexture(ee,A)}break;case C.POINT:n&&Pt.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=C.POINT,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET)}l.update(),t.updateBuffer(f.getBuffer(Q.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var r=e.exposure,a=this._pipeline.pipelineSceneData,s=a.isHDR,n=a.shadows,o=a.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=S(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView=we.gfxDevice.createBuffer(new rt(this._lightBuffer,0,se.SIZE)));for(var h=0,d=0;h<o.length;h++,d+=this._lightBufferElementCount){var l=o[h];switch(l.type){case C.SPHERE:if(i.toArray(zi,l.position),zi[3]=C.SPHERE,this._lightBufferData.set(zi,d+se.LIGHT_POS_OFFSET),zi[0]=l.size,zi[1]=l.range,zi[2]=0,zi[3]=0,this._lightBufferData.set(zi,d+se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(zi,l.color),l.useColorTemperature){var u=l.finalColor;zi[0]=u.x,zi[1]=u.y,zi[2]=u.z}zi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(zi,d+se.LIGHT_COLOR_OFFSET);break;case C.SPOT:if(i.toArray(zi,l.position),zi[3]=C.SPOT,this._lightBufferData.set(zi,d+se.LIGHT_POS_OFFSET),zi[0]=l.size,zi[1]=l.range,zi[2]=l.spotAngle,zi[3]=n.enabled&&l.shadowEnabled&&n.type===pe.ShadowMap?1:0,this._lightBufferData.set(zi,d+se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(zi,l.direction),this._lightBufferData.set(zi,d+se.LIGHT_DIR_OFFSET),i.toArray(zi,l.color),l.useColorTemperature){var _=l.finalColor;zi[0]=_.x,zi[1]=_.y,zi[2]=_.z}zi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(zi,d+se.LIGHT_COLOR_OFFSET),zi[0]=0,zi[1]=0,zi[2]=0,zi[3]=l.angleAttenuationStrength,this._lightBufferData.set(zi,d+se.LIGHT_BOUNDING_SIZE_VS_OFFSET);break;case C.POINT:if(i.toArray(zi,l.position),zi[3]=C.POINT,this._lightBufferData.set(zi,d+se.LIGHT_POS_OFFSET),zi[0]=0,zi[1]=l.range,zi[2]=0,zi[3]=0,this._lightBufferData.set(zi,d+se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(zi,l.color),l.useColorTemperature){var p=l.finalColor;zi[0]=p.x,zi[1]=p.y,zi[2]=p.z}zi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(zi,d+se.LIGHT_COLOR_OFFSET);break;case C.RANGED_DIRECTIONAL:i.toArray(zi,l.position),zi[3]=C.RANGED_DIRECTIONAL,this._lightBufferData.set(zi,d+se.LIGHT_POS_OFFSET),i.toArray(zi,l.right),zi[3]=0,this._lightBufferData.set(zi,d+se.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(zi,l.direction),zi[3]=0,this._lightBufferData.set(zi,d+se.LIGHT_DIR_OFFSET);var c=l.scale;if(Vi.set(.5*c.x,.5*c.y,.5*c.z),i.toArray(zi,Vi),zi[3]=0,this._lightBufferData.set(zi,d+se.LIGHT_BOUNDING_SIZE_VS_OFFSET),i.toArray(zi,l.color),l.useColorTemperature){var f=l.finalColor;zi[0]=f.x,zi[1]=f.y,zi[2]=f.z}zi[3]=s?l.illuminance*r:l.illuminance,this._lightBufferData.set(zi,d+se.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),na=new s,oa=Te("planar-shadow");function ha(e){var r=e.passes,i=t.rendering;Z()&&(oa=i.getPhaseID(i.getPassID("default"),"planar-shadow"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===oa||Z()&&r[a].phaseID===oa)return a;return-1}var da,la,ua,_a,pa,ca,fa,Sa,ga=function(){function e(e){this._subModelArray=[],this._shaderArray=[],this._passArray=[],this._castModels=[],this._instancedQueue=new Wi,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.clear=function(){this._subModelArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._castModels.length=0},t.gatherShadowPasses=function(e,t){this.clear();var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===pe.Planar&&!(r.normal.length()<1e-6)){var i=e.scene,a=e.frustum,o=!!(e.visibility&oe.BitMask.DEFAULT);if(i.mainLight&&o){for(var h=i.models,d=e.visibility,l=0;l<h.length;l++){var u=h[l];i.isCulledByLod(e,u)||u.enabled&&u.node&&u.castShadow&&u.node&&(d&u.node.layer)===u.node.layer&&this._castModels.push(u)}for(var _=0;_<this._castModels.length;_++){var p=this._castModels[_];if(!p.worldBounds||(s.transform(na,p.worldBounds,r.matLight),n.aabbFrustum(na,a)))for(var c=p.subModels,f=0;f<c.length;f++){var S=c[f],g=ha(S);if(g<0){this._subModelArray.push(S);var O=r.getPlanarShader(S.patches);if(!O)continue;this._shaderArray.push(O),this._passArray.push(r.material.passes[0])}else{var T=S.passes[g];if(T.batchingScheme===Ee.INSTANCING){var A=T.getInstancedBuffer();A.merge(S,g),this._instancedQueue.queue.add(A)}else{var E=S.shaders[g];this._subModelArray.push(S),E&&this._shaderArray.push(E),this._passArray.push(T)}}}}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,r){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===pe.Planar){this._instancedQueue.recordCommandBuffer(e,t,r);for(var a=0;a<this._subModelArray.length;++a){var s=this._subModelArray[a],n=this._shaderArray[a],o=this._passArray[a],h=s.inputAssembler,d=ie.getOrCreatePipelineState(e,o,n,t,h),l=o.descriptorSet;r.bindPipelineState(d),r.bindDescriptorSet(ae.MATERIAL,l),r.bindDescriptorSet(ae.LOCAL,s.descriptorSet),r.bindInputAssembler(h),r.draw(h)}}},e}(),Oa=function(){function e(){this._phaseID=Te("default");var e=t.rendering;Z()&&(this._phaseID=e.getPhaseID(e.getPassID("default"),"default"))}var r=e.prototype;return r.activate=function(e){this._pipeline=e},r.render=function(e,t){for(var r=this._pipeline,i=r.device,a=r.commandBuffers[0],s=e.scene.batches,n=0;n<s.length;n++){var o=s[n],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var d=o.shaders.length,l=0;l<d;l++){var u=o.passes[l];if(u.phase===this._phaseID&&4294967295===u.passID){var _=o.shaders[l],p=o.inputAssembler,c=ie.getOrCreatePipelineState(i,u,_,t,p);a.bindPipelineState(c),a.bindDescriptorSet(ae.MATERIAL,u.descriptorSet);var f=o.descriptorSet;a.bindDescriptorSet(ae.LOCAL,f),a.bindInputAssembler(p),a.draw(p)}}}},e}(),Ta=[new it(0,0,0,1)],Aa=e("ForwardStage",(da=u("ForwardStage"),la=c([Ci]),da((ca=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=pa&&pa(),t._renderQueues=[],t._renderArea=new et,t._instancedQueue=new Wi,t._phaseID=Te("default"),t._clearFlag=4294967295,t._uiPhase=new Oa,t.additiveInstanceQueues=[],t}E(t,e);var r=t.prototype;return r.addRenderInstancedQueue=function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)},r.removeRenderInstancedQueue=function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)},r.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Ui(this.renderQueues[i]);this._additiveLightQueue=new sa(this._pipeline),this._planarQueue=new ga(this._pipeline),this._uiPhase.activate(t)},r.destroy=function(){},r.render=function(e){var t,r=this._pipeline,i=r.device;this._instancedQueue.clear(),this._renderQueues.forEach(xi);for(var a=r.pipelineSceneData.renderObjects,s=0,n=0,o=0,h=0;h<a.length;++h){var d=a[h],l=d.model.subModels;for(s=0;s<l.length;++s){var u=l[s],_=u.passes;for(n=0;n<_.length;++n){var p=_[n];if(p.phase===this._phaseID&&4294967295===p.passID)if(p.batchingScheme===Ee.INSTANCING){var c=p.getInstancedBuffer();c.merge(u,n),this._instancedQueue.queue.add(c)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(d,s,n)}}}this._instancedQueue.sort(),this._renderQueues.forEach(Gi);var f=r.commandBuffers[0];r.pipelineUBO.updateShadowUBO(e);for(var S=0;S<this.additiveInstanceQueues.length;S++)this.additiveInstanceQueues[S].uploadBuffers(f);this._instancedQueue.uploadBuffers(f),this._additiveLightQueue.gatherLightPasses(e,f),this._planarQueue.gatherShadowPasses(e,f),e.clearFlag&Ue.COLOR&&(Ta[0].x=e.clearColor.x,Ta[0].y=e.clearColor.y,Ta[0].z=e.clearColor.z,Ta[0].w=e.clearColor.w),r.generateRenderArea(e,this._renderArea);var g=e.window.framebuffer,O=r.getRenderPass(e.clearFlag&this._clearFlag,g);f.beginRenderPass(O,g,this._renderArea,Ta,e.clearDepth,e.clearStencil),f.bindDescriptorSet(ae.GLOBAL,r.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,O,f);for(var T=0;T<this.additiveInstanceQueues.length;T++)this.additiveInstanceQueues[T].recordCommandBuffer(i,O,f);this._instancedQueue.recordCommandBuffer(i,O,f),this._additiveLightQueue.recordCommandBuffer(i,O,f),f.bindDescriptorSet(ae.GLOBAL,r.descriptorSet),this._planarQueue.recordCommandBuffer(i,O,f),this._renderQueues[1].recordCommandBuffer(i,O,f),null==(t=e.geometryRenderer)||t.render(O,f,r.pipelineSceneData),this._uiPhase.render(e,O),me(i,O,f,r.profiler,e),f.endRenderPass()},t}(Wt),ca.initInfo={name:"ForwardStage",priority:er.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:Ri.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Ri.BACK_TO_FRONT,stages:["default","planarShadow"]}]},pa=_((_a=ca).prototype,"renderQueues",[la,p],(function(){return[]})),ua=_a))||ua)),Ea=e("ForwardFlow",u("ForwardFlow")((Sa=function(e){function t(){return e.apply(this,arguments)||this}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new Aa;r.initialize(Aa.initInfo),this._stages.push(r)}return!0},r.activate=function(t){e.prototype.activate.call(this,t)},r.render=function(t){e.prototype.render.call(this,t)},r.destroy=function(){e.prototype.destroy.call(this)},t}(Zt),Sa.initInfo={name:he,priority:tr.FORWARD,stages:[]},fa=Sa))||fa),ma=Te("shadow-caster");function Fa(e){var r=e.passes,i=t.rendering;Z()&&(ma=i.getPhaseID(i.getPassID("default"),"shadow-caster"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===ma||Z()&&r[a].phaseID===ma)return a;return-1}var Ia,va,wa,Da,ba=function(){function e(e){this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=new Wi,this._pipeline=e}var t=e.prototype;return t.gatherLightPasses=function(e,t,r,i){void 0===i&&(i=0),this.clear();var a=this._pipeline.pipelineSceneData,s=a.shadows;if(t&&s.enabled&&s.type===pe.ShadowMap){switch(t.type){case C.DIRECTIONAL:var o=t;if(o.shadowEnabled){var h,d=a.csmLayers;pt(e,a,h=o.shadowFixedArea?d.specialLayer:d.layers[i]);for(var l=h.shadowObjects,u=0;u<l.length;u++){var _=l[u].model;this.add(_,i)}}break;case C.SPOT:var p=t;if(p.shadowEnabled)for(var c=p.visibility,f=a.csmLayers.castShadowObjects,S=0;S<f.length;S++){var g=f[S].model;(!g.worldBounds||(c&g.node.layer)===g.node.layer&&n.aabbFrustum(g.worldBounds,p.frustum))&&this.add(g,i)}}this._instancedQueue.uploadBuffers(r)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear()},t.add=function(e,t){for(var r=e.subModels,i=0;i<r.length;i++){var a=r[i],s=Fa(a);if(!(s<0)){var n=a.passes[s];if(n.batchingScheme===Ee.INSTANCING){var o=n.getInstancedBuffer(t);o.merge(a,s),this._instancedQueue.queue.add(o)}else{var h=a.shaders[s];this._subModelsArray.push(a),h&&this._shaderArray.push(h),this._passArray.push(n)}}}},t.recordCommandBuffer=function(e,t,r){this._instancedQueue.recordCommandBuffer(e,t,r);for(var i=0;i<this._subModelsArray.length;++i){var a=this._subModelsArray[i],s=this._shaderArray[i],n=this._passArray[i],o=a.inputAssembler,h=ie.getOrCreatePipelineState(e,n,s,t,o),d=n.descriptorSet;r.bindPipelineState(h),r.bindDescriptorSet(ae.MATERIAL,d),r.bindDescriptorSet(ae.LOCAL,a.descriptorSet),r.bindInputAssembler(o),r.draw(o)}},e}(),Ba=[new it(1,1,1,1)],ya=e("ShadowStage",u("ShadowStage")((va=function(e){function t(){var t;return(t=e.call(this)||this)._additiveShadowQueue=void 0,t._shadowFrameBuffer=null,t._renderArea=new et,t._light=null,t._globalDS=null,t._level=0,t._isShadowMapCleared=!1,t}E(t,e);var r=t.prototype;return r.setUsage=function(e,t,r,i){void 0===i&&(i=0),this._globalDS=e,this._light=t,this._shadowFrameBuffer=r,this._level=i},r.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null==(e=this._additiveShadowQueue)||e.clear()},r.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer&&!this._isShadowMapCleared){Ba[0].w=e.clearColor.w;var t=this._pipeline,r=t.pipelineSceneData,i=r.shadingScale,a=r.shadows,s=e.viewport,n=a.size;this._renderArea.x=s.x*n.x,this._renderArea.y=s.y*n.y,this._renderArea.width=s.width*n.x*i,this._renderArea.height=s.height*n.y*i;var o=t.commandBuffers[0],h=this._shadowFrameBuffer.renderPass;o.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,Ba,e.clearDepth,e.clearStencil),o.endRenderPass(),this._isShadowMapCleared=!0}},r.render=function(e){var t=this._pipeline,r=t.pipelineSceneData,i=r.shadows,a=this._globalDS,s=t.commandBuffers[0],n=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light,n),this._additiveShadowQueue.gatherLightPasses(e,this._light,s,n);var h=i.size;switch(this._light.type){case C.DIRECTIONAL:var d=this._light;if(d.shadowFixedArea||d.csmLevel===Se.LEVEL_1||!r.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=n%2*.5*h.x,this._renderArea.y=l>0?.5*(1-Math.floor(n/2))*h.y:.5*Math.floor(n/2)*h.y,this._renderArea.width=.5*h.x,this._renderArea.height=.5*h.y}break;case C.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y}var u=this._shadowFrameBuffer.renderPass;s.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,Ba,e.clearDepth,e.clearStencil),s.bindDescriptorSet(ae.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(o,u,s),s.endRenderPass(),this._isShadowMapCleared=!1}},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._additiveShadowQueue=new ba(t),this._isShadowMapCleared=!1},t}(Wt),va.initInfo={name:"ShadowStage",priority:er.FORWARD,tag:0},Ia=va))||Ia),Ra=[],Pa=e("ShadowFlow",u("ShadowFlow")((Da=function(e){function t(){var t;return(t=e.call(this)||this)._shadowRenderPass=null,t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new ya;r.initialize(ya.initInfo),this._stages.push(r)}return!0},r.activate=function(t){e.prototype.activate.call(this,t);var r=J(t.device)?0:1;t.macros.CC_SHADOWMAP_FORMAT=r;var i=t.device.gfxAPI===at.WEBGL?1:0;t.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=i,t.pipelineSceneData.csmSupported=t.device.capabilities.maxFragmentUniformVectors>=(z.COUNT+q.COUNT+G.COUNT+k.COUNT)/4,t.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=t.pipelineSceneData.csmSupported,t.macros.CC_SHADOW_TYPE=0,t.macros.CC_DIR_SHADOW_PCF_TYPE=fe.HARD,t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.macros.CC_CASCADED_LAYERS_TRANSITION=0,t.onGlobalPipelineStateChanged()},r.render=function(e){var t=this._pipeline,r=t.pipelineSceneData.shadows,i=t.pipelineSceneData.csmLayers,a=t.pipelineSceneData.shadowFrameBufferMap,s=i.castShadowObjects,n=this._pipeline.pipelineSceneData.validPunctualLights;if(r.enabled&&r.type===pe.ShadowMap){for(var o=0,h=0;o<r.maxReceived&&h<n.length;){var d=n[h];d.type===C.SPOT&&d.shadowEnabled&&(Ra.push(d),o++),h++}if(0!==s.length){r.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var u=t.descriptorSet;a.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var _=a.get(l);if(l.shadowFixedArea)this._renderStage(e,l,_,u);else for(var p=t.pipelineSceneData.csmSupported?l.csmLevel:1,c=0;c<p;c++)this._renderStage(e,l,_,u,c)}for(var f=0;f<Ra.length;f++){var S=Ra[f],g=t.globalDSManager.getOrCreateDescriptorSet(S);a.has(S)||this._initShadowFrameBuffer(t,S,e.window.swapchain);var O=a.get(S);this._renderStage(e,S,O,g)}Ra.length=0}else this.clearShadowMap(Ra,e)}},r.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,r=Array.from(t.values()),i=0;i<r.length;i++){var a=r[i];if(a){for(var s=a.colorTextures,n=0;n<s.length;n++){var o=s[n];o&&o.destroy()}s.length=0;var h=a.depthStencilTexture;h&&h.destroy(),a.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},r._initShadowFrameBuffer=function(e,t){var r=e.device,i=e.pipelineSceneData.shadows.size,a=e.pipelineSceneData.shadowFrameBufferMap,s=J(r)?Je.R32F:Je.RGBA8;if(!this._shadowRenderPass){var n=new Le;n.format=s,n.loadOp=xe.CLEAR,n.storeOp=He.STORE,n.sampleCount=1;var o=new Me;o.format=Je.DEPTH_STENCIL,o.depthLoadOp=xe.CLEAR,o.depthStoreOp=He.DISCARD,o.stencilLoadOp=xe.CLEAR,o.stencilStoreOp=He.DISCARD,o.sampleCount=1;var h=new Qe([n],o);this._shadowRenderPass=r.createRenderPass(h)}var d=[];d.push(r.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,s,i.x,i.y)));var l=r.createTexture(new Ye(Ke.TEX2D,$e.DEPTH_STENCIL_ATTACHMENT,Je.DEPTH_STENCIL,i.x,i.y)),u=r.createFramebuffer(new ze(this._shadowRenderPass,d,l));a.set(t,u)},r._renderStage=function(e,t,r,i,a){void 0===a&&(a=0);for(var s=0;s<this._stages.length;s++){var n=this._stages[s];n.setUsage(i,t,r,a),n.render(e)}},r.clearShadowMap=function(e,t){var r=this._pipeline,i=r.pipelineSceneData,a=t.scene.mainLight;if(a){var s=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(a)||this._initShadowFrameBuffer(this._pipeline,a,t.window.swapchain);for(var n=i.shadowFrameBufferMap.get(a),o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(s,a,n),h.clearFramebuffer(t)}}for(var d=0;d<e.length;d++){var l=e[d],u=r.globalDSManager.getOrCreateDescriptorSet(l);i.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var _=i.shadowFrameBufferMap.get(l),p=0;p<this._stages.length;p++){var c=this._stages[p];c.setUsage(u,l,_),c.clearFramebuffer(t)}}},r.resizeShadowMap=function(){for(var e,t=this._pipeline.pipelineSceneData.shadows,r=t.size,i=this._pipeline,a=i.device,s=i.pipelineSceneData.shadowFrameBufferMap,n=J(a)?Je.R32F:Je.RGBA8,o=v(s.keys());!(e=o()).done;){var h=e.value,d=s.get(h);if(d){var l=[];l.push(i.device.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,n,r.x,r.y)));var u=d.depthStencilTexture;u&&u.resize(r.x,r.y);var _=d.renderPass;d.destroy();var p=a.createFramebuffer(new ze(_,l,u));s.set(h,p)}}t.shadowMapDirty=!1},t}(Zt),Da.initInfo={name:de,priority:tr.SHADOW,tag:bi.SCENE,stages:[]},wa=Da))||wa),Na="CC_USE_RGBE_OUTPUT",Ca=Te("default"),La=Te("reflect-map");function Ma(e){var r=e.passes,i=t.rendering;Z()&&(Ca=i.getPhaseID(i.getPassID("default"),"default"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===Ca||Z()&&r[a].phaseID===Ca)return a;return-1}function Ha(e){var r=e.passes,i=t.rendering;Z()&&(La=i.getPhaseID(i.getPassID("default"),"reflect-map"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===La||Z()&&r[a].phaseID===La)return a;return-1}var Ua,xa,Ga,Wa,Qa,Va,za,qa,ka,Ja=function(){function e(e){this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._rgbeSubModelsArray=[],this._instancedQueue=new Wi,this._patches=[],this._pipeline=e}var t=e.prototype;return t.gatherRenderObjects=function(e,t,r){this.clear();var i=t.scene,a=this._pipeline.pipelineSceneData.skybox;a.enabled&&a.model&&e.camera.clearFlag&y.VALUE&&this.add(a.model);for(var s=i.models,o=e.visibility,h=0;h<s.length;h++){var d=s[h];d.node&&!i.isCulledByLod(t,d)&&((o&d.node.layer)===d.node.layer||o&d.visFlags)&&d.enabled&&d.worldBounds&&d.bakeToReflectionProbe&&(e.probeType===U.CUBE?n.aabbWithAABB(d.worldBounds,e.boundingBox)&&this.add(d):n.aabbFrustum(d.worldBounds,e.camera.frustum)&&this.add(d))}this._instancedQueue.uploadBuffers(r)},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._rgbeSubModelsArray.length=0},t.add=function(e){for(var t=e.subModels,r=0;r<t.length;r++){var i=t[r];if(!i.passes[0].blendState.targets[0].blend){var a=Ha(i),s=!0;if(a<0&&(a=Ma(i),s=!1),!(a<0)){var n=i.passes[a],o=n.batchingScheme;if(!s){this._patches=[],this._patches=this._patches.concat(i.patches);var h=[{name:Na,value:!0}];this._patches=this._patches.concat(h),i.onMacroPatchesStateChanged(this._patches),this._rgbeSubModelsArray.push(i)}if(o===Ee.INSTANCING){var d=n.getInstancedBuffer();d.merge(i,a),this._instancedQueue.queue.add(d)}else{var l=i.shaders[a];this._subModelsArray.push(i),l&&this._shaderArray.push(l),this._passArray.push(n)}}}}},t.recordCommandBuffer=function(e,t,r){this._instancedQueue.recordCommandBuffer(e,t,r);for(var i=0;i<this._subModelsArray.length;++i){var a=this._subModelsArray[i],s=this._shaderArray[i],n=this._passArray[i],o=a.inputAssembler,h=ie.getOrCreatePipelineState(e,n,s,t,o),d=n.descriptorSet;r.bindPipelineState(h),r.bindDescriptorSet(ae.MATERIAL,d),r.bindDescriptorSet(ae.LOCAL,a.descriptorSet),r.bindInputAssembler(o),r.draw(o)}this.resetRGBEMacro(),this._instancedQueue.clear()},t.resetRGBEMacro=function(){for(var e=0;e<this._rgbeSubModelsArray.length;e++){this._patches=[];var t=this._rgbeSubModelsArray[e];if(this._patches=this._patches.concat(t.patches),this._patches){for(var r=0;r<this._patches.length;r++)if(this._patches[r].name===Na){this._patches.splice(r,1);break}t.onMacroPatchesStateChanged(this._patches)}}},e}(),Za=[new it(1,1,1,1)],ja=e("ReflectionProbeStage",u("ReflectionProbeStage")((xa=function(e){function t(){var t;return(t=e.call(this)||this)._frameBuffer=null,t._renderArea=new et,t._probe=null,t._probeRenderQueue=void 0,t._rgbeColor=new i,t}E(t,e);var r=t.prototype;return r.setUsageInfo=function(e,t){this._probe=e,this._frameBuffer=t},r.destroy=function(){var e;this._frameBuffer=null,null==(e=this._probeRenderQueue)||e.clear()},r.clearFramebuffer=function(e){if(this._frameBuffer){Za[0].w=e.clearColor.w;var t=this._pipeline,r=t.pipelineSceneData.shadingScale,i=e.viewport,a=this._probe.resolution;this._renderArea.x=i.x*a,this._renderArea.y=i.y*a,this._renderArea.width=i.width*a*r,this._renderArea.height=i.height*a*r;var s=t.commandBuffers[0],n=this._frameBuffer.renderPass;s.beginRenderPass(n,this._frameBuffer,this._renderArea,Za,e.clearDepth,e.clearStencil),s.endRenderPass()}},r.render=function(e){var t=this._pipeline,r=t.commandBuffers[0];this._probeRenderQueue.gatherRenderObjects(this._probe,e,r),t.pipelineUBO.updateCameraUBO(this._probe.camera),this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=this._probe.renderArea().x,this._renderArea.height=this._probe.renderArea().y;var i=this._frameBuffer.renderPass;if(this._probe.camera.clearFlag&Ue.COLOR){this._rgbeColor.x=this._probe.camera.clearColor.x,this._rgbeColor.y=this._probe.camera.clearColor.y,this._rgbeColor.z=this._probe.camera.clearColor.z;var a=g(this._rgbeColor);Za[0].x=a.x,Za[0].y=a.y,Za[0].z=a.z,Za[0].w=a.w}var s=t.device;r.beginRenderPass(i,this._frameBuffer,this._renderArea,Za,this._probe.camera.clearDepth,this._probe.camera.clearStencil),r.bindDescriptorSet(ae.GLOBAL,t.descriptorSet),this._probeRenderQueue.recordCommandBuffer(s,i,r),r.endRenderPass(),t.pipelineUBO.updateCameraUBO(e)},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._probeRenderQueue=new Ja(t)},t}(Wt),xa.initInfo={name:"ReflectionProbeStage",priority:er.FORWARD,tag:0},Ua=xa))||Ua),Xa=e("ReflectionProbeFlow",u("ReflectionProbeFlow")((Wa=function(e){function r(){return e.apply(this,arguments)||this}E(r,e);var i=r.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new ja;r.initialize(ja.initInfo),this._stages.push(r)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(e){if(t.internal.reflectionProbeManager)for(var r=t.internal.reflectionProbeManager.getProbes(),i=0;i<r.length;i++)r[i].needRender&&r[i].probeType===U.PLANAR&&this._renderStage(e,r[i])},i.destroy=function(){e.prototype.destroy.call(this)},i._renderStage=function(e,r){for(var i=0;i<this._stages.length;i++){var a=this._stages[i];if(r.probeType===U.PLANAR)t.internal.reflectionProbeManager.updatePlanarMap(r,null),a.setUsageInfo(r,r.realtimePlanarTexture.window.framebuffer),a.render(e),t.internal.reflectionProbeManager.updatePlanarMap(r,r.realtimePlanarTexture.getGFXTexture());else{for(var s=0;s<6;s++){var n=r.bakedCubeTextures[s];if(!n)return;r.updateCameraDir(s),a.setUsageInfo(r,n.window.framebuffer),a.render(e)}r.needRender=!1}}},r}(Zt),Wa.initInfo={name:"PIPELINE_FLOW_RELECTION_PROBE",priority:0,tag:bi.SCENE,stages:[]},Ga=Wa))||Ga);function Ya(){var e=new Es;return e.initialize({flows:[]}),e}var Ka,$a,es,ts,rs,is,as,ss,ns,os,hs,ds,ls,us,_s,ps,cs,fs,Ss,gs,Os,Ts,As,Es=e("ForwardPipeline",(Qa=u("ForwardPipeline"),Va=c([yi]),Qa((qa=function(e){function t(){var t;return(t=e.call(this)||this).renderTextures=ka&&ka(),t._postRenderPass=null,t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var r=new Pa;r.initialize(Pa.initInfo),this._flows.push(r);var i=new Xa;i.initialize(Xa.initInfo),this._flows.push(i);var a=new Ea;a.initialize(Ea.initInfo),this._flows.push(a)}return!0},r.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new x,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(B(2402),1))},r._ensureEnoughSize=function(e){for(var t=this._width,r=this._height,i=0;i<e.length;++i){var a=e[i].window;t=Math.max(a.width,t),r=Math.max(a.height,r)}t===this._width&&r===this._height||(this._width=t,this._height=r)},r.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),r=t.next();!r.done;)r.value.destroy(),r=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},r._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this._descriptorSet,r=this.globalDSManager.pointSampler;return t.bindSampler(K,r),t.bindTexture(K,$(this.device)),t.bindSampler(ee,r),t.bindTexture(ee,$(this.device)),t.update(),!0},r._destroyUBOs=function(){var e=this._descriptorSet;e&&(e.getBuffer(j.BINDING).destroy(),e.getBuffer(Q.BINDING).destroy(),e.getBuffer(X.BINDING).destroy(),e.getTexture(K).destroy(),e.getTexture(ee).destroy())},A(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(Bi),ka=_(qa.prototype,"renderTextures",[Va,p],(function(){return[]})),za=qa))||za)),ms=[new it(0,0,0,0),new it(0,0,0,0),new it(0,0,0,0)],Fs=e("GbufferStage",(Ka=u("GbufferStage"),$a=c([Ci]),Ka((is=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=rs&&rs(),t._renderQueues=[],t._renderArea=new et,t._instancedQueue=new Wi,t._phaseID=Te("default"),t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Ui(this.renderQueues[i])},r.destroy=function(){},r.render=function(e){this._instancedQueue.clear();var t=this._pipeline,r=t.device;this._renderQueues.forEach(xi),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,a=0,s=0,n=0,o=0;o<i.length;++o){var h=i[o],d=h.model.subModels;for(a=0;a<d.length;++a){var l=d[a],u=l.passes;for(s=0;s<u.length;++s){var _=u[s];if(_.phase===this._phaseID)if(_.batchingScheme===Ee.INSTANCING){var p=_.getInstancedBuffer();p.merge(l,s),this._instancedQueue.queue.add(p)}else for(n=0;n<this._renderQueues.length;n++)this._renderQueues[n].insertRenderPass(h,a,s)}}}this._renderQueues.forEach(Gi);var c=t.commandBuffers[0];this._instancedQueue.uploadBuffers(c),e.clearFlag&Ue.COLOR&&(t.pipelineSceneData.isHDR?Fe(ms[0],e.clearColor):(ms[0].x=e.clearColor.x,ms[0].y=e.clearColor.y,ms[0].z=e.clearColor.z)),ms[0].w=e.clearColor.w;var f=t.getPipelineRenderData().gbufferFrameBuffer,S=f.renderPass;c.beginRenderPass(S,f,this._renderArea,ms,e.clearDepth,e.clearStencil),c.setScissor(t.generateScissor(e)),c.setViewport(t.generateViewport(e)),c.bindDescriptorSet(ae.GLOBAL,t.descriptorSet);for(var g=0;g<this.renderQueues.length;g++)this._renderQueues[g].recordCommandBuffer(r,S,c);this._instancedQueue.recordCommandBuffer(r,S,c),c.endRenderPass()},t}(Wt),is.initInfo={name:"GbufferStage",priority:rr.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:Ri.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Ri.BACK_TO_FRONT,stages:["default"]}]},rs=_((ts=is).prototype,"renderQueues",[$a,p],(function(){return[]})),es=ts))||es)),Is=new i,vs=new s(0,0,0,.5,.5,.5),ws=new s,Ds=[new it(0,0,0,1)],bs=e("LightingStage",(as=u("LightingStage"),ss=c(Oe),ns=c([Ci]),as((us=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=ue.LIGHTS_PER_PASS,t._lightBufferData=null,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new et,t._planarQueue=null,t._uiPhase=new Oa,t._deferredMaterial=ds&&ds(),t.renderQueues=ls&&ls(),t._phaseID=Te("default"),t._renderQueues=[],t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var t=this._pipeline,r=t.pipelineSceneData.isHDR,o=t.commandBuffers[0],d=e.scene.sphereLights,l=e.scene.spotLights,u=e.scene.pointLights,_=e.scene.rangedDirLights,p=a.create(0,0,0,1),c=new Float32Array(4),f=e.exposure,S=0,g=h.length,O=g*this._maxDeferredLights,T=0;T<d.length&&S<this._maxDeferredLights;T++,++S){var A=d[T];if(a.set(p,A.position.x,A.position.y,A.position.z,A.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,A.position),c[3]=C.SPHERE,this._lightBufferData.set(c,S*g),i.toArray(c,A.color),A.useColorTemperature){var E=A.finalColor;c[0]=E.x,c[1]=E.y,c[2]=E.z}c[3]=r?A.luminance*f*this._lightMeterScale:A.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=A.size,c[1]=A.range,c[2]=0,this._lightBufferData.set(c,S*g+2*O)}}for(var m=0;m<l.length&&S<this._maxDeferredLights;m++,++S){var F=l[m];if(a.set(p,F.position.x,F.position.y,F.position.z,F.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,F.position),c[3]=C.SPOT,this._lightBufferData.set(c,S*g+0*O),i.toArray(c,F.color),F.useColorTemperature){var I=F.finalColor;c[0]=I.x,c[1]=I.y,c[2]=I.z}c[3]=r?F.luminance*f*this._lightMeterScale:F.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=F.size,c[1]=F.range,c[2]=F.spotAngle,this._lightBufferData.set(c,S*g+2*O),i.toArray(c,F.direction),this._lightBufferData.set(c,S*g+3*O)}}for(var v=0;v<u.length&&S<this._maxDeferredLights;v++,++S){var w=u[v];if(a.set(p,w.position.x,w.position.y,w.position.z,w.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,w.position),c[3]=C.POINT,this._lightBufferData.set(c,S*g),i.toArray(c,w.color),w.useColorTemperature){var D=w.finalColor;c[0]=D.x,c[1]=D.y,c[2]=D.z}c[3]=r?w.luminance*f*this._lightMeterScale:w.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=0,c[1]=w.range,c[2]=0,this._lightBufferData.set(c,S*g+2*O)}}for(var b=0;b<_.length&&S<this._maxDeferredLights;b++,++S){var B=_[b];if(s.transform(ws,vs,B.node.getWorldMatrix()),n.aabbFrustum(ws,e.frustum)){if(i.toArray(c,B.position),c[3]=C.RANGED_DIRECTIONAL,this._lightBufferData.set(c,S*g),i.toArray(c,B.color),B.useColorTemperature){var y=B.finalColor;c[0]=y.x,c[1]=y.y,c[2]=y.z}c[3]=r?B.illuminance*f:B.illuminance,this._lightBufferData.set(c,S*g+1*O),i.toArray(c,B.right),c[3]=0,this._lightBufferData.set(c,S*g+2*O),i.toArray(c,B.direction),c[3]=0,this._lightBufferData.set(c,S*g+3*O);var R=B.scale;Is.set(.5*R.x,.5*R.y,.5*R.z),i.toArray(c,Is),c[3]=0,this._lightBufferData.set(c,S*g+4*O)}}var P=3*O+3;this._lightBufferData.set([S],P),o.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r._createStageDescriptor=function(e){var t=this._pipeline.device,r=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;r=Math.ceil(r/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,r,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new rt(this._deferredLitsBufs,0,r));this._lightBufferData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new ye(e.localSetLayout)),this._descriptorSet.bindBuffer(ne.BINDING,i);var a=t.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.DEVICE,le.SIZE,le.SIZE));this._descriptorSet.bindBuffer(le.BINDING,a)},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Ui(this.renderQueues[i]);this._planarQueue=new ga(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},r.destroy=function(){var e;null==(e=this._deferredLitsBufs)||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t,r=this._pipeline,i=r.device,a=r.commandBuffers[0],s=r.pipelineSceneData,n=s.renderObjects;this._planarQueue.gatherShadowPasses(e,a),r.generateRenderArea(e,this._renderArea);for(var o=r.getPipelineRenderData(),h=s.deferredLightingMaterial.passes[0],d=h.getShaderVariant(),l=0;l<3;++l)h.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),h.descriptorSet.bindSampler(l,o.sampler);h.descriptorSet.bindTexture(3,o.outputDepth),h.descriptorSet.bindSampler(3,o.sampler),h.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(h),this.gatherLights(e),e.clearFlag&Ue.COLOR&&(Ds[0].x=e.clearColor.x,Ds[0].y=e.clearColor.y,Ds[0].z=e.clearColor.z),Ds[0].w=0;var u=o.outputFrameBuffer,_=u.renderPass;r.pipelineUBO.updateShadowUBO(e),a.beginRenderPass(_,u,this._renderArea,Ds,e.clearDepth,e.clearStencil),a.setScissor(r.generateScissor(e)),a.setViewport(r.generateViewport(e)),a.bindDescriptorSet(ae.GLOBAL,r.descriptorSet);var p=r.quadIAOffscreen,c=null;null!=h&&null!=d&&null!=p&&(c=ie.getOrCreatePipelineState(i,h,d,_,p)),null!=c&&(this._descriptorSet.update(),a.bindPipelineState(c),a.bindDescriptorSet(ae.MATERIAL,h.descriptorSet),a.bindDescriptorSet(ae.LOCAL,this._descriptorSet),a.bindInputAssembler(p),a.draw(p)),this._renderQueues.forEach(xi);for(var f=0,S=0,g=0,O=0;O<n.length;++O){var T=n[O],A=T.model.subModels;for(f=0;f<A.length;++f){var E=A[f].passes;for(S=0;S<E.length;++S)if(E[S].phase===this._phaseID)for(g=0;g<this._renderQueues.length;g++)this._renderQueues[g].insertRenderPass(T,f,S)}}if(n.length>0){this._renderQueues.forEach(Gi);for(var m=0;m<this._renderQueues.length;m++)this._renderQueues[m].recordCommandBuffer(i,_,a);this._planarQueue.recordCommandBuffer(i,_,a)}null==(t=e.geometryRenderer)||t.render(_,a,r.pipelineSceneData),this._uiPhase.render(e,_),a.endRenderPass()},t}(Wt),us.initInfo={name:"LightingStage",priority:rr.LIGHTING,tag:0},ds=_((hs=us).prototype,"_deferredMaterial",[ss,p],(function(){return null})),ls=_(hs.prototype,"renderQueues",[ns,p],(function(){return[]})),os=hs))||os)),Bs=[new it(0,0,0,1)],ys=e("PostProcessStage",(_s=u("PostProcessStage"),ps=c(Oe),cs=c([Ci]),_s((Ts=function(e){function t(){var t;return(t=e.call(this)||this)._postProcessMaterial=gs&&gs(),t.renderQueues=Os&&Os(),t._renderArea=new et,t._stageDesc=null,t._localUBO=null,t._uiPhase=new Oa,t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},r.destroy=function(){},r.render=function(e){var t=this._pipeline,r=t.device,i=t.pipelineSceneData,a=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var s=e.viewport;this._renderArea.x=s.x*e.window.width,this._renderArea.y=s.y*e.window.height,this._renderArea.width=s.width*e.window.width,this._renderArea.height=s.height*e.window.height;var n=t.getPipelineRenderData(),o=e.window.framebuffer,h=t.getRenderPass(e.clearFlag,o);e.clearFlag&Ue.COLOR&&(Bs[0].x=e.clearColor.x,Bs[0].y=e.clearColor.y,Bs[0].z=e.clearColor.z),Bs[0].w=e.clearColor.w,a.beginRenderPass(h,o,this._renderArea,Bs,e.clearDepth,e.clearStencil),a.bindDescriptorSet(ae.GLOBAL,t.descriptorSet);var d=i.postprocessMaterial.passes[0],l=d.getShaderVariant();t.bloomEnabled?d.descriptorSet.bindTexture(0,n.bloom.combineTex):d.descriptorSet.bindTexture(0,n.outputRenderTargets[0]),d.descriptorSet.bindSampler(0,n.sampler),d.descriptorSet.update();var u=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=d&&null!=l&&null!=u&&(_=ie.getOrCreatePipelineState(r,d,l,h,u));var p=t.pipelineSceneData.renderObjects;null!=_&&p.length>0&&(this._stageDesc||(this._stageDesc=r.createDescriptorSet(new ye(d.localSetLayout)),this._localUBO=r.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.DEVICE,le.SIZE,le.SIZE)),this._stageDesc.bindBuffer(le.BINDING,this._localUBO)),this._stageDesc.update(),a.bindPipelineState(_),a.bindDescriptorSet(ae.MATERIAL,d.descriptorSet),a.bindDescriptorSet(ae.LOCAL,this._stageDesc),a.bindInputAssembler(u),a.draw(u)),this._uiPhase.render(e,h),me(r,h,a,t.profiler,e),a.endRenderPass()},t}(Wt),Ts.initInfo={name:"PostProcessStage",priority:$t.POST_PROCESS,tag:0},gs=_((Ss=Ts).prototype,"_postProcessMaterial",[ps,p],(function(){return null})),Os=_(Ss.prototype,"renderQueues",[cs,p],(function(){return[]})),fs=Ss))||fs));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(As||(As={}));var Rs,Ps,Ns,Cs,Ls,Ms,Hs,Us=function(e){function t(){var t;return(t=e.call(this)||this)._antiAliasing=As.NONE,t}E(t,e);var i=t.prototype;return i.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var r=this._bloomMaterial.passes[1+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var i=this._bloomMaterial.passes[7+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var e=new Oe;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var r=new Oe;r._uuid="builtin-bloom-material",r.initialize({effectName:"pipeline/bloom"});for(var i=0;i<r.passes.length;++i)r.passes[i].tryCompile();this._bloomMaterial=r;var a=new Oe;a._uuid="builtin-post-process-material",a.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var s=0;s<a.passes.length;++s)a.passes[s].tryCompile();this._postprocessMaterial=a,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(t){return e.prototype.activate.call(this,t),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){r.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},A(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var r=new Oe;r.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<r.passes.length;++i)r.passes[i].tryCompile();this._postprocessMaterial=r}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(x),xs=[new it(0,0,0,1)],Gs=function(){};Rs=Gs,Gs.TEXTURE_SIZE_OFFSET=0,Gs.COUNT=Rs.TEXTURE_SIZE_OFFSET+4,Gs.SIZE=4*Rs.COUNT;var Ws,Qs,Vs,zs,qs,ks,Js,Zs=e("BloomStage",(Ps=u("BloomStage"),Ns=c(Oe),Ps((Hs=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,t._bloomMaterial=Ms&&Ms(),t._renderArea=new et,t._bloomUBO=[],t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},r.destroy=function(){},r.render=function(e){var t,r=this._pipeline;if(r.generateBloomRenderData(),(null!=(t=e.window)&&t.swapchain||r.macros.CC_PIPELINE_TYPE)&&r.bloomEnabled&&0!==r.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=r.device.createBuffer(new Re(Pe.UNIFORM|Pe.TRANSFER_DST,Ne.HOST|Ne.DEVICE,Gs.SIZE,Gs.SIZE));e.clearFlag&Ue.COLOR&&(xs[0].x=e.clearColor.x,xs[0].y=e.clearColor.y,xs[0].z=e.clearColor.z),xs[0].w=e.clearColor.w,this._prefilterPass(e,r),this._downsamplePass(e,r),this._upsamplePass(e,r),this._combinePass(e,r)}},r._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],a=t.getPipelineRenderData(),s=a.bloom,n=new Float32Array(Gs.COUNT);n[Gs.TEXTURE_SIZE_OFFSET+2]=this.threshold,r.updateBuffer(this._bloomUBO[0],n),r.beginRenderPass(s.renderPass,s.prefilterFramebuffer,this._renderArea,xs,0,0),r.bindDescriptorSet(ae.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,a.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,s.sampler),i.descriptorSet.update(),r.bindDescriptorSet(ae.MATERIAL,i.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,d=i.getShaderVariant();null!=i&&null!=d&&null!=o&&(h=ie.getOrCreatePipelineState(t.device,i,d,s.renderPass,o)),null!=h&&(r.bindPipelineState(h),r.bindInputAssembler(o),r.draw(o)),r.endRenderPass()},r._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,a=t.getPipelineRenderData().bloom,s=new Float32Array(Gs.COUNT),n=0;n<this.iterations;++n){s[Gs.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[Gs.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[n+1],s),this._renderArea.width>>=1,this._renderArea.height>>=1,r.beginRenderPass(a.renderPass,a.downsampleFramebuffers[n],this._renderArea,xs,0,0);var o=i.passes[1+n],h=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[n+1]),0===n?o.descriptorSet.bindTexture(1,a.prefiterTex):o.descriptorSet.bindTexture(1,a.downsampleTexs[n-1]),o.descriptorSet.bindSampler(1,a.sampler),o.descriptorSet.update(),r.bindDescriptorSet(ae.MATERIAL,o.descriptorSet);var d=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=h&&null!=d&&(l=ie.getOrCreatePipelineState(t.device,o,h,a.renderPass,d)),null!=l&&(r.bindPipelineState(l),r.bindInputAssembler(d),r.draw(d)),r.endRenderPass()}},r._upsamplePass=function(e,t){var r=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],a=t.pipelineSceneData.bloomMaterial,s=new Float32Array(Gs.COUNT),n=0;n<this.iterations;++n){var o=n+6+1;s[Gs.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[Gs.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[o],s),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(r.renderPass,r.upsampleFramebuffers[this.iterations-1-n],this._renderArea,xs,0,0);var h=a.passes[7+n],d=h.getShaderVariant();h.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===n?h.descriptorSet.bindTexture(1,r.downsampleTexs[this.iterations-1]):h.descriptorSet.bindTexture(1,r.upsampleTexs[this.iterations-n]),h.descriptorSet.bindSampler(1,r.sampler),h.descriptorSet.update(),i.bindDescriptorSet(ae.MATERIAL,h.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=h&&null!=d&&null!=l&&(u=ie.getOrCreatePipelineState(t.device,h,d,r.renderPass,l)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(l),i.draw(l)),i.endRenderPass()}},r._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,a=t.getPipelineRenderData(),s=a.bloom,n=new Float32Array(Gs.COUNT);n[Gs.TEXTURE_SIZE_OFFSET+3]=this.intensity,r.updateBuffer(this._bloomUBO[13],n),r.beginRenderPass(s.renderPass,s.combineFramebuffer,this._renderArea,xs,0,0),r.bindDescriptorSet(ae.GLOBAL,t.descriptorSet);var o=i.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,a.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,s.upsampleTexs[0]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.bindSampler(2,s.sampler),o.descriptorSet.update(),r.bindDescriptorSet(ae.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,d=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=h&&(d=ie.getOrCreatePipelineState(t.device,o,l,s.renderPass,h)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(h),r.draw(h)),r.endRenderPass()},t}(Wt),Hs.initInfo={name:"BloomStage",priority:$t.BLOOM,tag:0},Ms=_((Ls=Hs).prototype,"_bloomMaterial",[Ns,p],(function(){return null})),Cs=Ls))||Cs)),js=e("MainFlow",u("MainFlow")((Qs=function(e){function t(){return e.apply(this,arguments)||this}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new Fs;r.initialize(Fs.initInfo),this._stages.push(r);var i=new bs;i.initialize(bs.initInfo),this._stages.push(i);var a=new Zs;a.initialize(Zs.initInfo),this._stages.push(a);var s=new ys;s.initialize(ys.initInfo),this._stages.push(s)}return!0},r.activate=function(t){e.prototype.activate.call(this,t)},r.render=function(t){e.prototype.render.call(this,t)},r.destroy=function(){e.prototype.destroy.call(this)},t}(Zt),Qs.initInfo={name:_e,priority:ir.MAIN,stages:[]},Ws=Qs))||Ws),Xs=function(e){function t(){var t;return(t=e.call(this)||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return E(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),Ys=e("DeferredPipeline",(Vs=u("DeferredPipeline"),zs=c([yi]),Vs((ks=function(e){function t(){var t;return(t=e.call(this)||this)._gbufferRenderPass=null,t._lightingRenderPass=null,t.renderTextures=Js&&Js(),t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var r=new Pa;r.initialize(Pa.initInfo),this._flows.push(r);var i=new js;i.initialize(js.initInfo),this._flows.push(i)}return!0},r.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new Us,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(B(2402),1))},r.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),r=t.next();!r.done;)r.value.destroy(),r=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},r.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},r._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var r=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(K,r),this._descriptorSet.bindTexture(K,Ie.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ee,r),this._descriptorSet.bindTexture(ee,Ie.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new st;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var a=this._createQuadInputAssembler();if(!a.quadIB||!a.quadVB||!a.quadIA)return!1;if(this._quadVBOnscreen=a.quadVB,this._quadIAOnscreen=a.quadIA,!this._gbufferRenderPass){var s=new Le;s.format=Je.RGBA16F,s.loadOp=xe.CLEAR,s.storeOp=He.STORE;var n=new Le;n.format=Je.RGBA16F,n.loadOp=xe.CLEAR,n.storeOp=He.STORE;var o=new Le;o.format=Je.RGBA16F,o.loadOp=xe.CLEAR,o.storeOp=He.STORE;var h=new Me;h.format=Je.DEPTH_STENCIL,h.depthLoadOp=xe.CLEAR,h.depthStoreOp=He.STORE,h.stencilLoadOp=xe.CLEAR,h.stencilStoreOp=He.STORE;var d=new Qe([s,n,o],h);this._gbufferRenderPass=t.createRenderPass(d)}if(!this._lightingRenderPass){var l=new Le;l.format=Je.RGBA8,l.loadOp=xe.CLEAR,l.storeOp=He.STORE,l.barrier=t.getGeneralBarrier(new Ge(We.NONE,We.COLOR_ATTACHMENT_WRITE));var u=new Me;u.format=Je.DEPTH_STENCIL,u.depthLoadOp=xe.LOAD,u.depthStoreOp=He.DISCARD,u.stencilLoadOp=xe.LOAD,u.stencilStoreOp=He.DISCARD,l.barrier=t.getGeneralBarrier(new Ge(We.DEPTH_STENCIL_ATTACHMENT_WRITE,We.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Qe([l],u);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},r._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(j.BINDING).destroy(),this._descriptorSet.getBuffer(Q.BINDING).destroy(),this._descriptorSet.getBuffer(X.BINDING).destroy(),this._descriptorSet.getTexture(K).destroy(),this._descriptorSet.getTexture(ee).destroy())},r._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var r=0;r<e.outputRenderTargets.length;r++)e.outputRenderTargets[r].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},r._ensureEnoughSize=function(e){for(var t=this._width,r=this._height,i=0;i<e.length;++i){var a=e[i].window;t=Math.max(a.width,t),r=Math.max(a.height,r)}t===this._width&&r===this._height||(this._width=t,this._height=r,this._destroyDeferredData(),this._generateDeferredRenderData())},r._generateDeferredRenderData=function(){for(var e=this,t=this.device,r=this._pipelineRenderData=new Xs,i=this.pipelineSceneData,a=0;a<3;++a)r.gbufferRenderTargets.push(t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));r.outputDepth=t.createTexture(new Ye(Ke.TEX2D,$e.DEPTH_STENCIL_ATTACHMENT|$e.SAMPLED,Je.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),r.gbufferFrameBuffer=t.createFramebuffer(new ze(this._gbufferRenderPass,r.gbufferRenderTargets,r.outputDepth)),r.outputRenderTargets.push(t.createTexture(new Ye(Ke.TEX2D,$e.COLOR_ATTACHMENT|$e.SAMPLED,Je.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),r.outputFrameBuffer=t.createFramebuffer(new ze(this._lightingRenderPass,r.outputRenderTargets,null)),r.sampler=this.globalDSManager.pointSampler,this.on(L.ATTACHMENT_SCALE_CAHNGED,(function(t){r.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,r.gbufferFrameBuffer=e.newFramebufferByRatio(r.gbufferFrameBuffer),r.gbufferFrameBuffer=e.newFramebufferByRatio(r.outputFrameBuffer)}))},t}(Bi),Js=_(ks.prototype,"renderTextures",[zs,p],(function(){return[]})),qs=ks))||qs)),Ks=Object.freeze({__proto__:null,BloomStage:Zs,DeferredPipeline:Ys,ForwardFlow:Ea,ForwardPipeline:Es,ForwardStage:Aa,GbufferStage:Fs,LightingStage:bs,MainFlow:js,PostProcessStage:ys,ReflectionProbeFlow:Xa,ReflectionProbeStage:ja,RenderFlow:Zt,RenderPipeline:Bi,RenderStage:Wt,ShadowFlow:Pa,ShadowStage:ya,createDefaultPipeline:Ya});r.legacy_rendering=Ks}}}));
//# sourceMappingURL=legacy-pipeline.js.map
