System.register(["./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js","./node-event-BDYemSfE.js","./debug-view-zRQBd5E1.js","./scene-D5fG1En6.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./pipeline-state-manager-C4BAah3w.js","./wasm-web-DpHjq6qw.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./zlib.min-CyXMsivM.js"],(function(t,e){"use strict";var r,n,i,s,a,u,o,f,c,h,d,l,v,_,m,g,w,x,p,b,y,A,T,B,I,E,M,R,P,S,U,V,O,N,D,F,C,G,L,k,z,j,H,W,X,q,J,Q,Z,Y,K,$;return{setters:[function(t){r=t.a,n=t.l,i=t.Q,s=t.w,a=t.u,u=t.T,o=t.L,f=t._,c=t.j,h=t.h},function(t){d=t.F,l=t.n,v=t.f,_=t.G,m=t.c,g=t.u,w=t.Q,x=t.a,p=t.s,b=t.H},function(t){y=t.E},function(t){A=t.c},function(t){T=t.A},function(t){B=t.g},function(t){I=t.P,E=t.I,M=t.i,R=t.j,P=t.W},function(t){S=t.d},function(t){U=t.a,V=t.B,O=t.b,N=t.M,D=t.F,F=t.o,C=t.A,G=t.D,L=t.a7,k=t.c,z=t.u,j=t.aa,H=t.m},function(t){W=t.e,X=t.f,q=t.g,J=t.h,Q=t.j},function(t){Z=t.e,Y=t.i},function(t){K=t.g},null,function(t){$=t._}],execute:function(){t({d:Nt,i:Dt});var tt=t("B",function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var r=t-e;this._arrayBufferOrPaddings.push(r),this._length+=r}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(r){"number"==typeof r?e+=r:(t.set(new Uint8Array(r),e),e+=r.byteLength)})),t.buffer},t}());function et(t,e){return new rt(t,e)}var rt=function(){function t(t,e){if(this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var r=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(r).fill(null);for(var n=0;n<r;++n){var i=this._mesh.struct.morph.subMeshMorphs[n];i&&(i.targets.length>W.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[n]=new it(this._mesh,n,this._mesh.struct.morph,e):this._subMeshRenderings[n]=new nt(this._mesh,n,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,r=new Array(e),n=0;n<e;++n){var s,a;r[n]=null!==(s=null==(a=this._subMeshRenderings[n])?void 0:a.createInstance())&&void 0!==s?s:null}return{setWeights:function(t,e){var n;null==(n=r[t])||n.setWeights(e)},requiredPatches:function(e){i(t._mesh.struct.morph);var n=t._mesh.struct.morph.subMeshMorphs[e],s=r[e];if(null===s)return null;i(n);var a=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(U.ATTR_POSITION)&&a.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(U.ATTR_NORMAL)&&a.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(U.ATTR_TANGENT)&&a.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),a.push.apply(a,s.requiredPatches()),a},adaptPipelineState:function(t,e){var n;null==(n=r[t])||n.adaptPipelineState(e)},destroy:function(){r.forEach((function(t){t&&t.destroy()}))}}},t}(),nt=function(){function t(t,e,r,n){this._gfxDevice=n;var s=r.subMeshMorphs[e];i(s),this._subMeshMorph=s,ot(t,e,n);var a=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=a;var u=s.targets.length,o=ut(n,a*u);this._textureInfo={width:o.width,height:o.height},this._attributes=s.attributes.map((function(e,r){var n=o.create(),i=n.valueView;return s.targets.forEach((function(e,n){for(var s=e.displacements[r],u=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),o=a*n*4,f=0;f<a;++f)i[o+4*f+0]=u[3*f+0],i[o+4*f+1]=u[3*f+1],i[o+4*f+2]=u[3*f+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}var e=t.prototype;return e.destroy=function(){this._attributes.forEach((function(t){t.morphTexture.destroy()}))},e.createInstance=function(){var t=this,e=new at(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(r){for(var n=0;n<t._attributes.length;++n){var i=t._attributes[n],a=void 0;switch(i.name){case U.ATTR_POSITION:a=Q;break;case U.ATTR_NORMAL:a=J;break;case U.ATTR_TANGENT:a=q;break;default:s(16374)}void 0!==a&&(r.bindSampler(a,i.morphTexture.sampler),r.bindTexture(a,i.morphTexture.texture))}r.bindBuffer(X.BINDING,e.buffer),r.update()},destroy:function(){}}},t}(),it=function(){function t(t,e,r,n){this._attributes=[],this._gfxDevice=n;var s=r.subMeshMorphs[e];i(s),ot(t,e,n),this._attributes=s.attributes.map((function(e,r){return{name:e,targets:s.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[r].offset,e.displacements[r].count)}}))}}))}return t.prototype.createInstance=function(){return new st(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},r(t,[{key:"data",get:function(){return this._attributes}}]),t}(),st=function(){function t(t,e,r){this._owner=t,this._morphUniforms=new at(r,0);var n=ut(r,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=n.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var r=this._attributes[e],i=r.morphTexture.valueView,s=this._owner.data[e];n(t.length===s.targets.length);for(var a=0;a<s.targets.length;++a){var u=s.targets[a].displacements,o=t[a],f=u.length/3;if(0===a)for(var c=0;c<f;++c)i[4*c+0]=u[3*c+0]*o,i[4*c+1]=u[3*c+1]*o,i[4*c+2]=u[3*c+2]*o;else if(0!==o)for(var h=0;h<f;++h)i[4*h+0]+=u[3*h+0]*o,i[4*h+1]+=u[3*h+1]*o,i[4*h+2]+=u[3*h+2]*o}r.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e=0;e<this._attributes.length;++e){var r=this._attributes[e],n=void 0;switch(r.attributeName){case U.ATTR_POSITION:n=Q;break;case U.ATTR_NORMAL:n=J;break;case U.ATTR_TANGENT:n=q;break;default:s(16374)}void 0!==n&&(t.bindSampler(n,r.morphTexture.sampler),t.bindTexture(n,r.morphTexture.texture))}t.bindBuffer(X.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),at=function(){function t(t,e){this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(W.SIZE)),this._remoteBuffer=t.createBuffer(new V(O.UNIFORM|O.TRANSFER_DST,N.HOST|N.DEVICE,W.SIZE,W.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){n(t.length===this._targetCount);for(var e=A.sys.isLittleEndian,r=0;r<t.length;++r)this._localBuffer.setFloat32(W.OFFSET_OF_WEIGHTS+4*r,t[r],e)},e.setMorphTextureInfo=function(t,e){var r=A.sys.isLittleEndian;this._localBuffer.setFloat32(W.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,r),this._localBuffer.setFloat32(W.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,r)},e.setVerticesCount=function(t){var e=A.sys.isLittleEndian;this._localBuffer.setFloat32(W.OFFSET_OF_VERTICES_COUNT,t,e)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},r(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function ut(t,e){var r,i,a,u;t.getFormatFeatures(D.RGBA32F)&F.SAMPLED_TEXTURE?(r=e,a=16,i=I.RGBA32F,u=Float32Array):(r=4*e,a=4,i=I.RGBA8888,u=Uint8Array);var o=ft(r),f=o.width,c=o.height;return n(f*c>=r),{width:f,height:c,create:function(){var e=new ArrayBuffer(f*c*a),r=new Float32Array(e),n=u===Float32Array?r:new u(e),o=new E({width:f,height:c,_data:n,_compressed:!1,format:i}),h=new M;h.setFilters(R.NEAREST,R.NEAREST),h.setMipFilter(R.NONE),h.setWrapMode(P.CLAMP_TO_EDGE,P.CLAMP_TO_EDGE,P.CLAMP_TO_EDGE),h.image=o,h.getGFXTexture()||s(16375);var d=t.getSampler(h.getSamplerInfo());return{get texture(){return h.getGFXTexture()},get sampler(){return d},get valueView(){return r},destroy:function(){h.destroy()},updatePixels:function(){h.uploadData(n)}}}}}function ot(t,e,r){t.renderingSubMeshes[e].enableVertexIdChannel(r)}function ft(t){t<5&&(t=5);var e=d(t),r=a(e),n=r>>1;return{width:1<<(1&r?n+1:n),height:1<<n}}var ct,ht,dt,lt,vt,_t={};K.onPostInfrastructureInitDelegate.add((function(){return Z().then((function(){return l.hasFeature(l.Feature.WASM)?Promise.all([e.import("./meshopt_decoder.wasm-DKe5VOQW.js"),e.import("./meshopt_decoder.wasm-Cvy1kpGq.js")]).then((function(t){var e,r,n=t[0].default,i=t[1].default;return e=n,r=i,Promise.all([e.ready((function(t){return Y(r,t)}))]).then((function(){_t.supported=e.supported,_t.ready=Promise.resolve(),_t.decodeVertexBuffer=e.decodeVertexBuffer,_t.decodeIndexBuffer=e.decodeIndexBuffer,_t.decodeIndexSequence=e.decodeIndexSequence,_t.decodeGltfBuffer=e.decodeGltfBuffer,_t.useWorkers=e.useWorkers,_t.decodeGltfBufferAsync=e.decodeGltfBufferAsync,u(14203)}))})):e.import("./meshopt_decoder.asm-Cj9iSjTx.js").then((function(t){return t.m})).then((function(t){var e,r=t.default;return e=r,Promise.all([e.ready]).then((function(){_t.supported=e.supported,_t.ready=Promise.resolve(),_t.decodeVertexBuffer=e.decodeVertexBuffer,_t.decodeIndexBuffer=e.decodeIndexBuffer,_t.decodeIndexSequence=e.decodeIndexSequence,_t.decodeGltfBuffer=e.decodeGltfBuffer,_t.useWorkers=e.useWorkers,_t.decodeGltfBufferAsync=e.decodeGltfBufferAsync,u(14202)}))}))})).catch((function(t){o(t)}))}));var mt=v.add,gt=v.multiplyScalar,wt=v.subtract,xt=_.transform,pt=_.fromPoints,bt=v.max,yt=v.min,At=v.transformQuat,Tt=v.transformMat4;function Bt(t){switch(t){case 1:default:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}}var It=new v,Et=new v,Mt=new Uint8Array,Rt=t("M",m("cc.Mesh")((ht=function(t){function e(e){var r;return(r=t.call(this,e)||this).morphRendering=null,r._struct=dt&&dt(),r._hash=lt&&lt(),r._data=Mt,r._initialized=!1,r._allowDataAccess=vt&&vt(),r._isMeshDataUploaded=!1,r._renderingSubMeshes=null,r._boneSpaceBounds=new Map,r._jointBufferIndices=null,r}f(e,t);var i=e.prototype;return i.onLoaded=function(){this.initialize()},i.initialize=function(){if(!this._initialized){this._initialized=!0;var t={struct:this.struct,data:this.data};if(t.struct.compressed&&(t=Dt(t)),this.struct.encoded&&(t=Nt(t)),!this.struct.quantized||S.gfxDevice.getFormatFeatures(D.RGB16F)&F.VERTEX_ATTRIBUTE||(t=Ft(t)),this._struct=t.struct,this._data=t.data,this._struct.dynamic){for(var e=S.gfxDevice,r=[],n=[],i=0;i<this._struct.vertexBundles.length;i++){var a=this._struct.vertexBundles[i],u=e.createBuffer(new V(O.VERTEX|O.TRANSFER_DST,N.DEVICE,a.view.length,a.view.stride));r.push(u)}for(var o=0;o<this._struct.primitives.length;o++){var f=this._struct.primitives[o],c=f.indexView,h=null;c&&(h=e.createBuffer(new V(O.INDEX|O.TRANSFER_DST,N.DEVICE,c.length,c.stride)));for(var d=[],l=0;l<f.vertexBundelIndices.length;l++){var v=f.vertexBundelIndices[l];d.push(r[v])}for(var _=[],m=0;m<f.vertexBundelIndices.length;m++)for(var g=f.vertexBundelIndices[m],w=this._struct.vertexBundles[g].attributes,x=0;x<w.length;x++){var p=w[x],b=new C;b.copy(p),_.push(b)}var A=new B(d,_,f.primitiveMode,h);A.drawInfo=new G,A.mesh=this,A.subMeshIdx=o,n.push(A)}this._renderingSubMeshes=n}else{for(var T=this._data.buffer,I=S.gfxDevice,E=this._createVertexBuffers(I,T),M=[],R=[],P=0;P<this._struct.primitives.length;P++){var U=this._struct.primitives[P];if(0!==U.vertexBundelIndices.length){var k=null,z=void 0;if(U.indexView){var j=U.indexView,H=j.stride,W=j.length;if(4===H&&!I.hasFeature(L.ELEMENT_INDEX_UINT)){var X=this._struct.vertexBundles[U.vertexBundelIndices[0]].view.count;if(X>=65536){s(10001,X,65536);continue}H>>=1,W>>=1}k=I.createBuffer(new V(O.INDEX,N.DEVICE,W,H)),M.push(k),z=new(Bt(j.stride))(T,j.offset,j.count),j.stride!==H&&(z=Bt(H).from(z)),k.update(z)}var q=U.vertexBundelIndices.map((function(t){return E[t]})),J=[];if(U.vertexBundelIndices.length>0)for(var Q=U.vertexBundelIndices[0],Z=this._struct.vertexBundles[Q].attributes,Y=0;Y<Z.length;++Y){var K=Z[Y];J[Y]=new C(K.name,K.format,K.isNormalized,K.stream,K.isInstanced,K.location)}var $=new B(q,J,U.primitiveMode,k);$.mesh=this,$.subMeshIdx=P,R.push($)}}this._renderingSubMeshes=R,this._struct.morph&&(this.morphRendering=et(this,I)),this._isMeshDataUploaded=!0,this._allowDataAccess||y||this.releaseData()}}},i.updateSubMesh=function(t,e){if(this._struct.dynamic)if(t>=this._struct.primitives.length)s(14201);else{var r=[];if(e.positions.length>0&&r.push(e.positions),e.normals&&e.normals.length>0&&r.push(e.normals),e.uvs&&e.uvs.length>0&&r.push(e.uvs),e.tangents&&e.tangents.length>0&&r.push(e.tangents),e.colors&&e.colors.length>0&&r.push(e.colors),e.customAttributes)for(var i=0;i<e.customAttributes.length;i++)r.push(e.customAttributes[i].values);for(var a=this._struct.dynamic,u=a.info,o=this._struct.primitives[t],f=this._renderingSubMeshes[t],c=f.drawInfo,h=0;h<r.length;h++){var d=r[h],l=this._struct.vertexBundles[o.vertexBundelIndices[h]],v=l.view.stride,m=d.byteLength/v,w=d.byteLength,x=new Uint8Array(this._data.buffer,l.view.offset,w),p=new Uint8Array(d.buffer,d.byteOffset,w),b=f.vertexBuffers[h];n(m<=u.maxSubMeshVertices,"Too many vertices."),w>0&&(x.set(p),b.update(p,w)),l.view.count=m,c.vertexCount=m}if(o.indexView){var y=o.indexView,A=y.stride,T=2===A?e.indices16.length:e.indices32.length,B=T*A,I=new Uint8Array(this._data.buffer,y.offset,B),E=2===A?new Uint8Array(e.indices16.buffer,e.indices16.byteOffset,B):new Uint8Array(e.indices32.buffer,e.indices32.byteOffset,B),M=f.indexBuffer;n(T<=u.maxSubMeshIndices,"Too many indices."),B>0&&(I.set(E),M.update(E,B)),y.count=T,c.indexCount=T}if(e.minPos&&e.maxPos){var R=g(e.minPos.x,e.minPos.y,e.minPos.z),P=g(e.maxPos.x,e.maxPos.y,e.maxPos.z);a.bounds[t]||(a.bounds[t]=new _),pt(a.bounds[t],R,P);var S=g(),U=g();a.bounds.forEach((function(t){t&&(t.getBoundary(S,U),yt(R,S,R),bt(P,U,P))})),this._struct.minPosition=g(R.x,R.y,R.z),this._struct.maxPosition=g(P.x,P.y,P.z)}f.invalidateGeometricInfo()}else s(14200)},i.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},i.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1,this._isMeshDataUploaded=!1}},i.assign=function(t,e){this.reset({struct:t,data:e})},i.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},i.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var r=[],n=t.bindposes,i=0;i<n.length;i++)e.push(new _(1/0,1/0,1/0,-1/0,-1/0,-1/0)),r.push(!1);for(var s=this._struct.primitives,a=0;a<s.length;a++){var u=this.readAttribute(a,U.ATTR_JOINTS),o=this.readAttribute(a,U.ATTR_WEIGHTS),f=this.readAttribute(a,U.ATTR_POSITION);if(u&&o&&f)for(var c=Math.min(u.length/4,o.length/4,f.length/3),h=0;h<c;h++){v.set(It,f[3*h+0],f[3*h+1],f[3*h+2]);for(var d=0;d<4;++d){var l=4*h+d,m=u[l];if(!(0===o[l]||m>=n.length)){Tt(Et,It,n[m]),r[m]=!0;var g=e[m];yt(g.center,g.center,Et),bt(g.halfExtents,g.halfExtents,Et)}}}}for(var w=0;w<n.length;w++){var x=e[w];r[w]?pt(x,x.center,x.halfExtents):e[w]=null}return e},i.merge=function(t,e,r){if(r&&!this.validateMergingMesh(t))return!1;var n=new v,i=e&&new w,s=e&&new _;if(i&&e.getRotation(i),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),u=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(mt(s.center,a.maxPosition,a.minPosition),gt(s.center,s.center,.5),wt(s.halfExtents,a.maxPosition,a.minPosition),gt(s.halfExtents,s.halfExtents,.5),xt(s,s,e),mt(a.maxPosition,s.center,s.halfExtents),wt(a.minPosition,s.center,s.halfExtents));for(var o=0;o<a.vertexBundles.length;o++)for(var f=a.vertexBundles[o],h=0;h<f.attributes.length;h++)if(f.attributes[h].name===U.ATTR_POSITION||f.attributes[h].name===U.ATTR_NORMAL){var d=f.attributes[h].format,l=new DataView(u.buffer,f.view.offset+Pt(f.attributes,h)),m=Vt(l,d),g=Ot(l,d);if(!m||!g)continue;for(var x=f.view.count,p=f.view.stride,b=Ut(d),y=0;y<x;y++){var A=y*p,T=A+b,B=T+b;switch(n.set(m(A),m(T),m(B)),f.attributes[h].name){case U.ATTR_POSITION:n.transformMat4(e);break;case U.ATTR_NORMAL:At(n,n,i)}g(A,n.x),g(T,n.y),g(B,n.z)}}}return this.reset({struct:a,data:u}),this.initialize(),!0}for(var I,E,M,R,P,S=new tt,V=0,O=0,N=0,D=0,F=0,C=0,G=0,L=0,z=!1,j=new Array(this._struct.vertexBundles.length),H=0;H<this._struct.vertexBundles.length;++H){var W=this._struct.vertexBundles[H],X=t._struct.vertexBundles[H];N=W.view.offset,D=X.view.offset,O=W.view.stride,V=W.view.count+X.view.count,I=new ArrayBuffer(V*O),E=new Uint8Array(I),N+=(M=this._data.subarray(N,N+W.view.length)).length,D+=(R=t._data.subarray(D,D+X.view.length)).length,E.set(M),F=0;for(var q,J=c(W.attributes);!(q=J()).done;){var Q=q.value;G=0,z=!1;for(var Z,Y=c(X.attributes);!(Z=Y()).done;){var K=Z.value;if(Q.name===K.name&&Q.format===K.format){z=!0;break}G+=k[K.format].size}if(z){L=k[Q.format].size,C=W.view.length+F;for(var $=0;$<X.view.count;++$){if(P=R.subarray(G,G+L),E.set(P,C),(Q.name===U.ATTR_POSITION||Q.name===U.ATTR_NORMAL)&&e){var et=new Float32Array(E.buffer,C,3);switch(n.set(et[0],et[1],et[2]),Q.name){case U.ATTR_POSITION:n.transformMat4(e);break;case U.ATTR_NORMAL:At(n,n,i)}et[0]=n.x,et[1]=n.y,et[2]=n.z}C+=W.view.stride,G+=X.view.stride}}F+=k[Q.format].size}j[H]={attributes:W.attributes,view:{offset:S.getLength(),length:I.byteLength,count:V,stride:O}},S.addBuffer(I)}for(var rt,nt,it,st=0,at=2,ut=new Array(this._struct.primitives.length),ot=0;ot<this._struct.primitives.length;++ot){var ft=this._struct.primitives[ot],ct=t._struct.primitives[ot];ut[ot]={primitiveMode:ft.primitiveMode,vertexBundelIndices:ft.vertexBundelIndices};for(var ht,dt=0,lt=c(ft.vertexBundelIndices);!(ht=lt()).done;){var vt=ht.value;dt=Math.max(dt,this._struct.vertexBundles[vt].view.count)}if(ft.indexView&&ct.indexView){st=ft.indexView.count,st+=ct.indexView.count,N=ft.indexView.offset,D=ct.indexView.offset,at=st<256?1:st<65536?2:4;var _t=new ArrayBuffer(st*at);if(rt=2===at?new Uint16Array(_t):1===at?new Uint8Array(_t):new Uint32Array(_t),nt=2===ft.indexView.stride?new Uint16Array(this._data.buffer,N,ft.indexView.count):1===ft.indexView.stride?new Uint8Array(this._data.buffer,N,ft.indexView.count):new Uint32Array(this._data.buffer,N,ft.indexView.count),at===ft.indexView.stride)rt.set(nt);else for(var pt=0;pt<ft.indexView.count;++pt)rt[pt]=nt[pt];N+=ft.indexView.length,it=2===ct.indexView.stride?new Uint16Array(t._data.buffer,D,ct.indexView.count):1===ct.indexView.stride?new Uint8Array(t._data.buffer,D,ct.indexView.count):new Uint32Array(t._data.buffer,D,ct.indexView.count);for(var Tt=0;Tt<ct.indexView.count;++Tt)rt[ft.indexView.count+Tt]=dt+it[Tt];D+=ct.indexView.length,ut[ot].indexView={offset:S.getLength(),length:_t.byteLength,count:st,stride:at},S.setNextAlignment(at),S.addBuffer(_t)}}var Bt={vertexBundles:j,primitives:ut,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return Bt.minPosition&&t._struct.minPosition&&Bt.maxPosition&&t._struct.maxPosition&&(e?(mt(s.center,t._struct.maxPosition,t._struct.minPosition),gt(s.center,s.center,.5),wt(s.halfExtents,t._struct.maxPosition,t._struct.minPosition),gt(s.halfExtents,s.halfExtents,.5),xt(s,s,e),mt(n,s.center,s.halfExtents),bt(Bt.maxPosition,Bt.maxPosition,n),wt(n,s.center,s.halfExtents),yt(Bt.minPosition,Bt.minPosition,n)):(yt(Bt.minPosition,Bt.minPosition,t._struct.minPosition),bt(Bt.maxPosition,Bt.maxPosition,t._struct.maxPosition))),this.reset({struct:Bt,data:new Uint8Array(S.getCombined())}),this.initialize(),!0},i.validateMergingMesh=function(t){if(this._struct.dynamic||t._struct.dynamic)return!1;if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var r=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(r.attributes.length!==n.attributes.length)return!1;for(var i=0;i<r.attributes.length;++i)if(r.attributes[i].format!==n.attributes[i].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],u=t._struct.primitives[s];if(a.vertexBundelIndices.length!==u.vertexBundelIndices.length)return!1;for(var o=0;o<a.vertexBundelIndices.length;++o)if(a.vertexBundelIndices[o]!==u.vertexBundelIndices[o])return!1;if(a.primitiveMode!==u.primitiveMode)return!1;if(a.indexView){if(void 0===u.indexView)return!1}else if(u.indexView)return!1}return!0},i.readAttribute=function(t,e){var r=this,n=null;return this._accessAttribute(t,e,(function(t,e){var i=t.view.count,s=t.attributes[e].format,a=z(k[s]);if(0!==i){var u=new DataView(r._data.buffer,t.view.offset+Pt(t.attributes,e)),o=k[s],f=Vt(u,s);if(a&&f){for(var c=o.count,h=new a(i*c),d=t.view.stride,l=0;l<i;++l)for(var v=0;v<c;++v)h[c*l+v]=f(d*l+h.BYTES_PER_ELEMENT*v);n=h}}})),n},i.copyAttribute=function(t,e,r,n,i){var s=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var u=t.view.count;if(0!==u){var o=t.attributes[e].format,f=new DataView(s._data.buffer,t.view.offset+Pt(t.attributes,e)),c=new DataView(r,i),h=k[o],d=Vt(f,o),l=Ot(c,o);if(d&&l){for(var v=h.count,_=t.view.stride,m=Ut(o),g=n,w=m,x=0;x<u;++x)for(var p=0;p<v;++p)l(g*x+w*p,d(_*x+m*p));a=!0}}else a=!0})),a},i.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var r=e.indexView.stride;return new(1===r?Uint8Array:2===r?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},i.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var r=this._struct.primitives[t];if(!r.indexView)return!1;for(var n=r.indexView.count,i=1===r.indexView.stride?D.R8UI:2===r.indexView.stride?D.R16UI:D.R32UI,s=Vt(new DataView(this._data.buffer),i),a=0;a<n;++a)e[a]=s(r.indexView.offset+k[i].size*a);return!0},i.readAttributeFormat=function(t,e){var r=null;return this._accessAttribute(t,e,(function(t,e){var n=t.attributes[e].format;r=k[n]})),r},i._accessAttribute=function(t,e,r){if(!(t>=this._struct.primitives.length))for(var n=this._struct.primitives[t].vertexBundelIndices,i=0;i<n.length;i++){var s=n[i],a=this._struct.vertexBundles[s],u=a.attributes.findIndex((function(t){return t.name===e}));if(!(u<0)){r(a,u);break}}},i._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(r){var n=t.createBuffer(new V(O.VERTEX,N.DEVICE,r.view.length,r.view.stride)),i=new Uint8Array(e,r.view.offset,r.view.length);return n.update(i),n}))},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:Mt})},i.releaseData=function(){this._data=Mt},r(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=H(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}},{key:"allowDataAccess",get:function(){return this._allowDataAccess},set:function(t){this._allowDataAccess=t,!this._isMeshDataUploaded||this._allowDataAccess||y||this.releaseData()}}]),e}(T),dt=x(ht.prototype,"_struct",[p],(function(){return{vertexBundles:[],primitives:[]}})),lt=x(ht.prototype,"_hash",[p],(function(){return 0})),vt=x(ht.prototype,"_allowDataAccess",[p],(function(){return!0})),ct=ht))||ct);function Pt(t,e){for(var r=0,n=0;n<e;++n){var i=t[n];r+=k[i.format].size}return r}A.Mesh=Rt;var St=l.isLittleEndian;function Ut(t){var e=k[t];return e.size/e.count}function Vt(t,e){var r=k[e],n=r.size/r.count;switch(r.type){case j.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,St)};case 4:return function(e){return t.getUint32(e,St)}}break;case j.SNORM:case j.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,St)};case 4:return function(e){return t.getInt32(e,St)}}break;case j.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,St)};case 4:return function(e){return t.getUint32(e,St)}}break;case j.FLOAT:switch(n){case 2:return function(e){return t.getUint16(e,St)};case 4:return function(e){return t.getFloat32(e,St)}}}return null}function Ot(t,e){var r=k[e],n=r.size/r.count;switch(r.type){case j.UNORM:switch(n){case 1:return function(e,r){return t.setUint8(e,r)};case 2:return function(e,r){return t.setUint16(e,r,St)};case 4:return function(e,r){return t.setUint32(e,r,St)}}break;case j.SNORM:case j.INT:switch(n){case 1:return function(e,r){return t.setInt8(e,r)};case 2:return function(e,r){return t.setInt16(e,r,St)};case 4:return function(e,r){return t.setInt32(e,r,St)}}break;case j.UINT:switch(n){case 1:return function(e,r){return t.setUint8(e,r)};case 2:return function(e,r){return t.setUint16(e,r,St)};case 4:return function(e,r){return t.setUint32(e,r,St)}}break;case j.FLOAT:switch(n){case 2:return function(e,r){return t.setUint16(e,r,St)};case 4:return function(e,r){return t.setFloat32(e,r,St)}}}return null}function Nt(t){if(!t.struct.encoded)return t;var e=function(t){t<0&&h(14204,t)},r=JSON.parse(JSON.stringify(t.struct)),n=new tt;n.setNextAlignment(0);for(var i,s=c(r.vertexBundles);!(i=s()).done;){var a=i.value,u=a.view,o=u.count*u.stride,f=new Uint8Array(o),d=new Uint8Array(t.data.buffer,u.offset,u.length);e(_t.decodeVertexBuffer(f,u.count,u.stride,d)),n.setNextAlignment(u.stride);var l={offset:n.getLength(),length:f.byteLength,count:u.count,stride:u.stride};a.view=l,n.addBuffer(f)}for(var v,_=c(r.primitives);!(v=_()).done;){var m=v.value;if(void 0!==m.indexView){var g=m.indexView,w=g.count*g.stride,x=new Uint8Array(w),p=new Uint8Array(t.data.buffer,g.offset,g.length);e(_t.decodeIndexBuffer(x,g.count,g.stride,p)),n.setNextAlignment(g.stride);var b={offset:n.getLength(),length:x.byteLength,count:g.count,stride:g.stride};m.indexView=b,n.addBuffer(x)}}return{struct:r,data:new Uint8Array(n.getCombined())}}function Dt(t){var e=new $.Inflate(t.data).decompress();return t.data=e,t.struct.compressed=!1,t}function Ft(t){var e=JSON.parse(JSON.stringify(t.struct)),r=new tt;function n(t,e,r,n,i,s,a){for(var u=0;u<r;u++)for(var o=0;o<n;o++)e(a*u+i*o,t(s*u+i*o))}function i(t,e,r,n,i,s){for(var a=0;a<r;a++)for(var u=0;u<n;u++)e(s*a+4*u,b(t(i*a+2*u)))}r.setNextAlignment(0);for(var s=0;s<e.vertexBundles.length;++s){for(var a=e.vertexBundles[s],u=a.view,o=a.attributes,f=t.struct.vertexBundles[s].attributes,h=[],d=[],l=[],v=0;v<o.length;++v){var _=o[v],m=Vt(new DataView(t.data.buffer,u.offset+Pt(f,v)),_.format),g=!0;switch(_.format){case D.R16F:_.format=D.R32F;break;case D.RG16F:_.format=D.RG32F;break;case D.RGB16F:_.format=D.RGB32F;break;case D.RGBA16F:_.format=D.RGBA32F;break;default:g=!1}h.push(k[_.format].size),d.push(g),l.push(m)}for(var w=h.reduce((function(t,e){return t+e}),0),x=new Uint8Array(w*u.count),p=0;p<o.length;++p){var y=o[p],A=l[p],T=Ot(new DataView(x.buffer,Pt(o,p)),y.format),B=d[p],I=k[y.format];B?i(A,T,u.count,I.count,u.stride,w):n(A,T,u.count,I.count,I.size/I.count,u.stride,w)}r.setNextAlignment(w);var E={offset:r.getLength(),length:x.byteLength,count:u.count,stride:w};a.view=E,r.addBuffer(x)}for(var M,R=c(e.primitives);!(M=R()).done;){var P=M.value;if(void 0!==P.indexView){var S=P.indexView,U=new Uint8Array(t.data.buffer,S.offset,S.length);r.setNextAlignment(S.stride);var V={offset:r.getLength(),length:U.byteLength,count:S.count,stride:S.stride};P.indexView=V,r.addBuffer(U)}}var O=new Uint8Array(r.getCombined());return e.quantized=!1,{struct:e,data:O}}}}}));
//# sourceMappingURL=mesh-BsaPYlYJ.js.map
