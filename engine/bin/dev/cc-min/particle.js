System.register(["./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js","./scene-D5fG1En6.js","./node-event-BDYemSfE.js","./deprecated-BaebfHhU.js","./prefab-CJahvMeV.js","./create-mesh-CgNcAxLl.js","./debug-view-zRQBd5E1.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./deprecated-BfPl6EQ2.js","./deprecated-B2PZGYTz.js","./camera-component-DK1ym1MK.js","./model-renderer-KnEZ5pPV.js","./renderer-DVTO-7-w.js","./3d.js","./director-D6Xf3-Ej.js","./mesh-BsaPYlYJ.js","./util-BWh5q49O.js","./skeleton-hXUbiLKQ.js","./instantiate-B8jTMe8K.js","./pipeline-state-manager-C4BAah3w.js","./touch-Ch03mDFP.js","./mesh-renderer-B_2j2ns-.js","./deprecated-CWS71dkv.js","./deprecated-gv6rCJsk.js","./wasm-web-DpHjq6qw.js","./zlib.min-CyXMsivM.js","./capsule-C5D-FUD0.js"],(function(t){"use strict";var e,i,r,s,n,o,a,l,u,h,c,_,d,p,f,m,v,y,M,g,S,b,x,T,A,w,O,R,F,C,E,z,D,P,I,B,L,V,U,k,N,G,H,X,W,Y,j,Z,q,Q,K,J,$,tt,et,it,rt,st,nt,ot,at,lt,ut,ht,ct,_t,dt,pt,ft,mt,vt,yt,Mt,gt,St,bt,xt,Tt,At,wt,Ot,Rt,Ft,Ct,Et,zt,Dt,Pt,It,Bt,Lt;return{setters:[function(t){e=t._,i=t.a,r=t.b,s=t.j,n=t.ab,o=t.E,a=t.ag,l=t.aE,u=t.L,h=t.F,c=t.R,_=t.h,d=t.w,p=t.P,f=t.at,m=t.o,v=t.m,y=t.C,M=t.U,g=t.k},function(t){S=t.c,b=t.t,x=t.g,T=t.C,A=t.a,w=t.Y,O=t.h,R=t.s,F=t.f,C=t.a8,E=t.a7,z=t.b7,D=t.aA,P=t.N,I=t.b8,B=t.aJ,L=t.I,V=t.V,U=t.Q,k=t.M,N=t.aa,G=t.X,H=t.ab,X=t.ac,W=t.af,Y=t.k,j=t.ag,Z=t.b,q=t.u,Q=t.G,K=t.o,J=t.j,$=t.i,tt=t.r},function(t){et=t.E,it=t.a},function(t){rt=t.c},function(t){st=t.b,nt=t.d,ot=t.i,at=t.I,lt=t.P,ut=t.j,ht=t.W,ct=t.M,_t=t.H,dt=t.T,pt=t.N},function(t){ft=t.C},function(t){mt=t.M,vt=t.e},null,function(t){yt=t._},function(t){Mt=t.g},function(t){gt=t.d},function(t){St=t.P,bt=t.A,xt=t.a,Tt=t.F,At=t.c,wt=t.B,Ot=t.b,Rt=t.M,Ft=t.a7,Ct=t.r,Et=t.o},null,null,null,function(t){zt=t.M},function(t){Dt=t.R},null,function(t){Pt=t.d,It=t.D},function(t){Bt=t.M},null,null,function(t){Lt=t.i},null,null,null,null,null,null,null,null],execute:function(){var Vt,Ut,kt,Nt,Gt,Ht,Xt,Wt,Yt,jt,Zt=(Vt=S("cc.Billboard"),Ut=b(ot),kt=b(ot),Vt((Gt=function(t){e(s,t);var r=s.prototype;function s(){var e;return(e=t.call(this)||this)._texture=Ht&&Ht(),e._height=Xt&&Xt(),e._width=Wt&&Wt(),e._rotation=Yt&&Yt(),e._techIndex=jt&&jt(),e._model=null,e._mesh=null,e._material=null,e._uniform=new x(1,1,0,0),e}return r.updateTexture=function(){this._material&&this._material.setProperty("mainTexture",this._texture)},r.updateHeight=function(){this._material&&(this._uniform.y=this._height,this._material.setProperty("cc_size_rotation",this._uniform))},r.updateWidth=function(){this._material&&(this._uniform.x=this._width,this._material.setProperty("cc_size_rotation",this._uniform))},r.updateRotation=function(){this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))},r.updateTechnique=function(){this._model&&this._mesh&&this._material&&this._material.technique!==this._techIndex&&(this.detachFromScene(),this._model.destroy(),this._model=null,this._material.destroy(),this._material=null,this._mesh.destroy(),this._mesh=null,this.createModel(),this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.enabled?(this.attachToScene(),this._model.enabled=!0):this._model.enabled=!1)},r.onLoad=function(){this.createModel()},r.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.updateTechnique()},r.onDisable=function(){this.detachFromScene()},r.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},r.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},r.createModel=function(){this._mesh=yt({primitiveMode:St.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[T.WHITE.r,T.WHITE.g,T.WHITE.b,T.WHITE.a,T.WHITE.r,T.WHITE.g,T.WHITE.b,T.WHITE.a,T.WHITE.r,T.WHITE.g,T.WHITE.b,T.WHITE.a,T.WHITE.r,T.WHITE.g,T.WHITE.b,T.WHITE.a],attributes:[new bt(xt.ATTR_POSITION,Tt.RGB32F),new bt(xt.ATTR_TEX_COORD,Tt.RG32F),new bt(xt.ATTR_COLOR,Tt.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=rt.director.root.createModel(mt);t.node=t.transform=this.node,null==this._material&&(this._material=new st,this._material.copy(nt.get("default-billboard-material"),{technique:this._techIndex})),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},i(s,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this.updateTexture()}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this.updateHeight()}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this.updateWidth()}},{key:"rotation",get:function(){return Math.round(100*w(this._rotation))/100},set:function(t){this._rotation=O(t),this.updateRotation()}},{key:"technique",get:function(){return this._techIndex},set:function(t){var e,i;t=Math.floor(t);var r=null==(e=this._material)||null==(i=e.effectAsset)?void 0:i.techniques;r&&t>=r.length&&(t=r.length-1),t<0&&(t=0),this._techIndex=t,this.updateTechnique()}}]),s}(ft),Ht=A(Gt.prototype,"_texture",[Ut],(function(){return null})),r(Gt.prototype,"texture",[kt],Object.getOwnPropertyDescriptor(Gt.prototype,"texture"),Gt.prototype),Xt=A(Gt.prototype,"_height",[R],(function(){return 0})),Wt=A(Gt.prototype,"_width",[R],(function(){return 0})),Yt=A(Gt.prototype,"_rotation",[R],(function(){return 0})),jt=A(Gt.prototype,"_techIndex",[R],(function(){return 0})),Nt=Gt))||Nt);t({Billboard:Zt,BillboardComponent:Zt});var qt,Qt,Kt,Jt,$t,te,ee,ie,re,se,ne,oe,ae,le,ue,he,ce,_e,de=[new bt(xt.ATTR_POSITION,Tt.RGB32F),new bt(xt.ATTR_TEX_COORD,Tt.RGBA32F),new bt(xt.ATTR_TEX_COORD1,Tt.RGB32F),new bt(xt.ATTR_COLOR,Tt.RGBA8,!0)],pe=new F,fe=new F,me=function(t){function i(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e._iaVertCount=0,e._iaIndexCount=0,e.type=vt.LINE,e._capacity=100,e}e(i,t);var r=i.prototype;return r.setCapacity=function(t){this._capacity=t,this.createBuffer()},r.createBuffer=function(){this._vertSize=0;for(var t,e=s(de);!(t=e()).done;){var i=t.value;i.offset=this._vertSize,this._vertSize+=At[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},r.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},r.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new wt(Ot.VERTEX|Ot.TRANSFER_DST,Rt.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),r=0,s=0;s<this._capacity-1;++s){var n=2*s;i[r++]=n,i[r++]=n+1,i[r++]=n+2,i[r++]=n+3,i[r++]=n+2,i[r++]=n+1}var o=this._device.createBuffer(new wt(Ot.INDEX|Ot.TRANSFER_DST,Rt.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return o.update(i),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=(this._capacity-1)*this._indexCount,this._subMeshData=new Mt([t],de,St.TRIANGLE_LIST,o),this.initSubModel(0,this._subMeshData,this._material),e},r.addLineVertexData=function(t,e,i){if(t.length>1){var r=0;F.subtract(pe,t[1],t[0]),this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=0,this._vdataF32[r++]=pe.x,this._vdataF32[r++]=pe.y,this._vdataF32[r++]=pe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(0,1)),this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=1,this._vdataF32[r++]=pe.x,this._vdataF32[r++]=pe.y,this._vdataF32[r++]=pe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(0,1));for(var s=1;s<t.length-1;s++){F.subtract(pe,t[s-1],t[s]),F.subtract(fe,t[s+1],t[s]),F.subtract(fe,fe,pe);var n=s/t.length;this._vdataF32[r++]=t[s].x,this._vdataF32[r++]=t[s].y,this._vdataF32[r++]=t[s].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=0,this._vdataF32[r++]=fe.x,this._vdataF32[r++]=fe.y,this._vdataF32[r++]=fe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(n,1)),this._vdataF32[r++]=t[s].x,this._vdataF32[r++]=t[s].y,this._vdataF32[r++]=t[s].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=1,this._vdataF32[r++]=fe.x,this._vdataF32[r++]=fe.y,this._vdataF32[r++]=fe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(n,1))}F.subtract(pe,t[t.length-1],t[t.length-2]),this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=0,this._vdataF32[r++]=pe.x,this._vdataF32[r++]=pe.y,this._vdataF32[r++]=pe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(1,1)),this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=1,this._vdataF32[r++]=pe.x,this._vdataF32[r++]=pe.y,this._vdataF32[r++]=pe.z,this._vdataUint32[r++]=T.toUint32(i.evaluate(1,1))}this.updateIA(Math.max(0,t.length-1))},r.updateIA=function(t){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount},r.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},i}(mt),ve=n.Attr.setClassAttr,ye=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],Me=o({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),ge=t("CurveRange",S("cc.CurveRange")((Qt=function(){function t(){this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1,this._mode=Me.Constant}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){default:case Me.Constant:return this.constant;case Me.Curve:return this.spline.evaluate(t)*this.multiplier;case Me.TwoCurves:return C(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case Me.TwoConstants:return C(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this._mode){default:case Me.Constant:return this.constant;case Me.Curve:return this.multiplier;case Me.TwoConstants:return this.constantMax;case Me.TwoCurves:return this.multiplier}},e.isZero=function(){switch(this._mode){default:case Me.Constant:return E(this.constant,0,P);case Me.Curve:return E(this.multiplier,0,P);case Me.TwoConstants:return E(Math.max(Math.abs(this.constantMax),Math.abs(this.constantMin)),0,P);case Me.TwoCurves:return E(this.multiplier,0,P)}},e._onBeforeSerialize=function(){return ye[this._mode]},i(t,[{key:"mode",get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case Me.Constant:case Me.TwoConstants:break;case Me.Curve:this.spline||(this.spline=z());break;case Me.TwoCurves:this.splineMax||(this.splineMax=z()),this.splineMin||(this.splineMin=z())}}},{key:"curve",get:function(){var t;return null!==(t=this._curve)&&void 0!==t?t:this._curve=new I(this.spline)},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){var t;return null!==(t=this._curveMin)&&void 0!==t?t:this._curveMin=new I(this.splineMin)},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){var t;return null!==(t=this._curveMax)&&void 0!==t?t:this._curveMax=new I(this.splineMax)},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),Qt.Mode=Me,qt=Qt))||qt);function Se(t,e,i){switch(t.mode){case Me.Constant:return t.constant;case Me.Curve:return t.spline.evaluate(e)*t.multiplier;case Me.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case Me.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function be(t){switch(t.mode){case Me.TwoConstants:case Me.TwoCurves:return 2;default:return 1}}function xe(t,e,i){var r=new at({width:e,height:i,_data:t,_compressed:!1,format:lt.RGBA32F}),s=new ot;return s.setFilters(ut.NEAREST,ut.NEAREST),s.setMipFilter(ut.NONE),s.setWrapMode(ht.CLAMP_TO_EDGE,ht.CLAMP_TO_EDGE,ht.CLAMP_TO_EDGE),s.image=r,s}function Te(t,e,i,r){return null===t||i!==t.width||r!==t.height?(t&&t.destroy(),t=xe(e,i,r)):t.uploadData(e),t}function Ae(t,e,i,r){var s=be(r),n=i*s*4;null!==e&&e.length===n||(e=new Float32Array(i*s*4));for(var o=1/(i-1),a=0,l=0;l<s;l++)for(var u=0;u<i;u++){var h=Se(r,o*u,l);e[a+2]=h,a+=4}return{texture:Te(t,e,i,s),texdata:e}}function we(t,e,i,r){var s=be(r),n=i*s*4;null!==e&&e.length===n||(e=new Float32Array(i*s*4));for(var o=1/(i-1),a=0,l=0,u=0;u<s;u++)for(var h=0;h<i;h++)a=Se(r,o*h,u),e[l]=a,e[l+1]=a,e[l+2]=a,l+=4;return{texture:Te(t,e,i,s),texdata:e}}function Oe(t,e,i,r,s){var n=Math.max(be(r),be(s)),o=i*n*4;null!==e&&e.length===o||(e=new Float32Array(i*n*4));for(var a=[r,s],l=1/(i-1),u=0;u<n;u++)for(var h=0;h<2;h++)for(var c=a[h],_=0,d=0;d<i;d++)_=Se(c,l*d,u),e[4*(u*i+d)+h]=_;return{texture:Te(t,e,i,n),texdata:e}}function Re(t,e,i,r,s,n,o){var a=Math.max(be(r),be(s),be(n)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var u=[r,s,n],h=1/(i-1),c=0;c<a;c++)for(var _=0;_<3;_++)for(var d=u[_],p=0,f=0,m=0;m<i;m++){var v=Se(d,h*m,c);f=o?v:(p+=v)/(m+1),e[4*(c*i+m)+_]=f}return{texture:Te(t,e,i,a),texdata:e}}function Fe(t,e,i,r,s,n,o){var a=Math.max(be(r),be(s),be(n),be(o)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var u=[r,s,n,o],h=1/(i-1),c=0;c<a;c++)for(var _=0;_<4;_++)for(var d=u[_],p=0,f=0,m=0;m<i;m++)f=(p+=Se(d,h*m,c))/(m+1),e[4*(c*i+m)+_]=f;return{texture:Te(t,e,i,a),texdata:e}}n.fastDefine("cc.CurveRange",ge,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:Me.Constant,splineMax:Object.freeze(z()),splineMin:Object.freeze(z()),spline:Object.freeze(z())}),ve(ge,"multiplier","visible",!0),ve(ge,"constantMax","visible",!0),ve(ge,"constantMin","visible",!0),ve(ge,"constant","visible",!0),a(ge,"mode",Me),ve(ge,"mode","visible",!0),ve(ge,"splineMax","type","Object"),ve(ge,"splineMax","ctor",D),ve(ge,"splineMax","visible",!0),ve(ge,"splineMin","type","Object"),ve(ge,"splineMin","ctor",D),ve(ge,"splineMin","visible",!0),ve(ge,"spline","type","Object"),ve(ge,"spline","ctor",D),ve(ge,"spline","visible",!0);var Ce,Ee,ze,De,Pe,Ie,Be,Le,Ve,Ue,ke,Ne,Ge,He,Xe,We,Ye,je,Ze,qe,Qe=et,Ke=o({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Je=new T,$e=new T,ti=t("GradientRange",(Kt=S("cc.GradientRange"),Jt=b(Ke),$t=b(B),te=b(B),ee=b(B),ie=b(Ke),Kt((_e=function(){function t(){this.color=ne&&ne(),this.colorMin=oe&&oe(),this.colorMax=ae&&ae(),this.gradient=le&&le(),this.gradientMin=ue&&ue(),this.gradientMax=he&&he(),this._mode=ce&&ce(),this._color=T.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case Ke.Color:return this.color;case Ke.TwoColors:return T.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Ke.RandomColor:return this.gradient.getRandomColor(this._color);case Ke.Gradient:return this.gradient.evaluateFast(this._color,t);case Ke.TwoGradients:return T.lerp(this._color,this.gradientMin.evaluateFast(Je,t),this.gradientMax.evaluateFast($e,t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return Qe[this._mode]},i(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),_e.Mode=Ke,r((se=_e).prototype,"mode",[Jt],Object.getOwnPropertyDescriptor(se.prototype,"mode"),se.prototype),ne=A(se.prototype,"color",[R],(function(){return T.WHITE.clone()})),oe=A(se.prototype,"colorMin",[R],(function(){return T.WHITE.clone()})),ae=A(se.prototype,"colorMax",[R],(function(){return T.WHITE.clone()})),le=A(se.prototype,"gradient",[$t],(function(){return new B})),ue=A(se.prototype,"gradientMin",[te],(function(){return new B})),he=A(se.prototype,"gradientMax",[ee],(function(){return new B})),ce=A(se.prototype,"_mode",[ie],(function(){return Ke.Color})),re=se))||re));function ei(t,e,i){switch(t.mode){case Ke.Color:return t.color;case Ke.TwoColors:return 0===i?t.colorMin:t.colorMax;case Ke.RandomColor:return t.gradient.getRandomColor(Je);case Ke.Gradient:return t.gradient.evaluateFast(Je,e);case Ke.TwoGradients:return 0===i?t.gradientMin.evaluateFast(Je,e):t.gradientMax.evaluateFast(Je,e);default:return t.color}}function ii(t){switch(t.mode){case Ke.TwoColors:case Ke.TwoGradients:return 2;default:return 1}}function ri(t,e,i,r){var s=ii(r),n=i*s*4;null!==e&&e.length===n||(e=new Uint8Array(i*s*4));for(var o=1/(i-1),a=0,l=0;l<s;l++)for(var u=0;u<i;u++){var h=ei(r,o*u,l);e[a]=h.r,e[a+1]=h.g,e[a+2]=h.b,e[a+3]=h.a,a+=4}return null!==t&&i===t.width&&s===t.height||(t&&t.destroy(),(t=new ot).create(i,s,lt.RGBA8888),t.setFilters(ut.LINEAR,ut.LINEAR),t.setWrapMode(ht.CLAMP_TO_EDGE,ht.CLAMP_TO_EDGE)),t.uploadData(e),{texture:t,texdata:e}}var si="CC_USE_WORLD_SPACE",ni={CC_USE_WORLD_SPACE:!1,CC_USE_WORLD_SCALE:!0},oi=(Ce=S("cc.Line"),Ee=b(ot),ze=b(ot),De=b(st),Pe=b([F]),Ie=b([F]),Be=b(ge),Le=b(ti),Ve=b(V),Ue=b(V),Ce((Ne=function(t){function r(){var e;return(e=t.call(this)||this)._texture=Ge&&Ge(),e._material=He&&He(),e._worldSpace=Xe&&Xe(),e._positions=We&&We(),e._width=Ye&&Ye(),e._color=je&&je(),e._tile=Ze&&Ze(),e._tile_offset=new x,e._offset=qe&&qe(),e}e(r,t);var s=r.prototype;return s.onLoad=function(){var t=rt.director.root.createModel(me);if(0===this._models.length?this._models.push(t):this._models[0]=t,t.node=t.transform=this.node,this._material&&(this.lineMaterial=this._material,this._material=null),null===this.lineMaterial){var e=nt.get("default-trail-material");this.material=e}var i=this.getMaterialInstance(0);i&&(ni[si]=this.worldSpace,i.recompileShaders(ni),t.updateMaterial(i)),t.setCapacity(100)},s.onEnable=function(){t.prototype.onEnable.call(this),0!==this._models.length&&this._models[0]&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._models[0].addLineVertexData(this._positions,this.width,this.color))},s.onDisable=function(){this._models.length>0&&this._models[0]&&this._detachFromScene()},s._attachToScene=function(){if(t.prototype._attachToScene.call(this),this._models.length>0&&this._models[0]&&this.node&&this.node.scene){var e=this._models[0];e.scene&&this._detachFromScene(),this._getRenderScene().addModel(e)}},s._detachFromScene=function(){if(t.prototype._detachFromScene.call(this),this._models.length>0&&this._models[0]){var e=this._models[0];e.scene&&e.scene.removeModel(e)}},s._onMaterialModified=function(e,i){t.prototype._onMaterialModified.call(this,e,i);var r=this.getMaterialInstance(0);r&&(ni[si]=this.worldSpace,r.recompileShaders(ni),this._models[0]&&this._models[0].updateMaterial(r))},i(r,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this.material&&this.material.setProperty("mainTexture",t)}},{key:"lineMaterial",get:function(){return this.getSharedMaterial(0)},set:function(t){this.setSharedMaterial(t,0)}},{key:"sharedMaterials",get:function(){return t.prototype.sharedMaterials},set:function(t){this.sharedMaterials=t}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t;var e=this.getMaterialInstance(0);e&&(ni[si]=this.worldSpace,e.recompileShaders(ni),this._models[0]&&this._models[0].setSubModelMaterial(0,e))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this.width,this.color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this.material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this.material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}}]),r}(zt),Ge=A(Ne.prototype,"_texture",[Ee],(function(){return null})),r(Ne.prototype,"texture",[ze],Object.getOwnPropertyDescriptor(Ne.prototype,"texture"),Ne.prototype),He=A(Ne.prototype,"_material",[R],(function(){return null})),r(Ne.prototype,"lineMaterial",[De],Object.getOwnPropertyDescriptor(Ne.prototype,"lineMaterial"),Ne.prototype),r(Ne.prototype,"sharedMaterials",[L,R],Object.getOwnPropertyDescriptor(Ne.prototype,"sharedMaterials"),Ne.prototype),Xe=A(Ne.prototype,"_worldSpace",[R],(function(){return!1})),We=A(Ne.prototype,"_positions",[Pe],(function(){return[]})),r(Ne.prototype,"positions",[Ie],Object.getOwnPropertyDescriptor(Ne.prototype,"positions"),Ne.prototype),r(Ne.prototype,"width",[Be],Object.getOwnPropertyDescriptor(Ne.prototype,"width"),Ne.prototype),Ye=A(Ne.prototype,"_width",[R],(function(){return new ge})),r(Ne.prototype,"color",[Le],Object.getOwnPropertyDescriptor(Ne.prototype,"color"),Ne.prototype),je=A(Ne.prototype,"_color",[R],(function(){return new ti})),Ze=A(Ne.prototype,"_tile",[R],(function(){return new V(1,1)})),r(Ne.prototype,"tile",[Ve],Object.getOwnPropertyDescriptor(Ne.prototype,"tile"),Ne.prototype),qe=A(Ne.prototype,"_offset",[R],(function(){return new V(0,0)})),r(Ne.prototype,"offset",[Ue],Object.getOwnPropertyDescriptor(Ne.prototype,"offset"),Ne.prototype),ke=Ne))||ke);t({Line:oi,LineComponent:oi});var ai=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new F(0,0,0),this.velocity=new F(0,0,0),this.animatedVelocity=new F(0,0,0),this.ultimateVelocity=new F(0,0,0),this.angularVelocity=new F(0,0,0),this.axisOfRotation=new F(0,0,0),this.rotation=new F(0,0,0),this.startEuler=new F(0,0,0),this.startRotation=new U,this.startRotated=!1,this.deltaQuat=new U,this.deltaMat=new k,this.localMat=new k,this.startSize=new F(0,0,0),this.size=new F(0,0,0),this.startColor=T.WHITE.clone(),this.color=T.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();ai.INDENTIFY_NEG_QUAT=10,ai.R2D=180/Math.PI;var li,ui,hi,ci,_i,di,pi,fi,mi,vi,yi="noiseModule",Mi=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule","noiseModule"],gi=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_trailModule"],Si=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}();!function(t){t[t.World=0]="World",t[t.Local=1]="Local",t[t.Custom=2]="Custom"}(li||(li={})),o(li),function(t){t[t.Pause=0]="Pause",t[t.PauseAndCatchup=1]="PauseAndCatchup",t[t.AlwaysSimulate=2]="AlwaysSimulate"}(ui||(ui={})),o(ui),function(t){t[t.World=0]="World",t[t.Local=1]="Local",t[t.View=2]="View"}(hi||(hi={})),o(hi),function(t){t[t.Billboard=0]="Billboard",t[t.StrecthedBillboard=1]="StrecthedBillboard",t[t.HorizontalBillboard=2]="HorizontalBillboard",t[t.VerticalBillboard=3]="VerticalBillboard",t[t.Mesh=4]="Mesh"}(ci||(ci={})),o(ci),function(t){t[t.Box=0]="Box",t[t.Circle=1]="Circle",t[t.Cone=2]="Cone",t[t.Sphere=3]="Sphere",t[t.Hemisphere=4]="Hemisphere"}(_i||(_i={})),o(_i),function(t){t[t.Base=0]="Base",t[t.Edge=1]="Edge",t[t.Shell=2]="Shell",t[t.Volume=3]="Volume"}(di||(di={})),o(di),function(t){t[t.Random=0]="Random",t[t.Loop=1]="Loop",t[t.PingPong=2]="PingPong"}(pi||(pi={})),o(pi),function(t){t[t.Particles=0]="Particles"}(fi||(fi={})),o(fi),function(t){t[t.Stretch=0]="Stretch"}(mi||(mi={})),o(mi),function(t){t[t.LIMIT=23541]="LIMIT",t[t.SIZE=39825]="SIZE",t[t.TEXTURE=90794]="TEXTURE",t[t.COLOR=91041]="COLOR",t[t.FORCE=212165]="FORCE",t[t.ROTATION=125292]="ROTATION",t[t.VELOCITY_X=197866]="VELOCITY_X",t[t.VELOCITY_Y=156497]="VELOCITY_Y",t[t.VELOCITY_Z=984136]="VELOCITY_Z"}(vi||(vi={}));var bi,xi,Ti,Ai,wi,Oi,Ri=new F(0,0,-1);function Fi(t,e,i,r){return e!==t?(t===li.World||k.invert(i,i),k.getRotation(r,i),!0):(U.set(r,0,0,0,1),!1)}function Ci(t,e){V.set(t,Math.cos(e),Math.sin(e))}function Ei(t){var e=N(-1,1),i=N(0,2*Math.PI),r=Math.sqrt(1-e*e),s=r*Math.cos(i),n=r*Math.sin(i);F.set(t,s,n,e)}function zi(t,e,i){Ei(t),F.multiplyScalar(t,t,e+(i-e)*G())}function Di(t,e,i,r){Ci(t,r),t.z=0,F.multiplyScalar(t,t,e+(i-e)*G())}function Pi(t){for(var e=0;e<t.length;e++){var i=e+H(0,t.length-e),r=t[i];t[i]=t[e],t[e]=r}}function Ii(){var t=N(-1,1);return 0===t&&t++,l(t)}function Bi(t){var e=ge.Mode;switch(t.mode){case e.TwoCurves:case e.TwoConstants:return!0;default:return!1}}function Li(t){var e=ti.Mode;switch(t.mode){case e.TwoGradients:case e.TwoColors:return!0;default:return!1}}var Vi,Ui,ki,Ni,Gi,Hi,Xi,Wi,Yi,ji,Zi,qi,Qi,Ki,Ji,$i,tr,er,ir,rr,sr,nr,or,ar,lr,ur,hr,cr,_r,dr,pr,fr,mr,vr,yr,Mr,gr,Sr,br,xr=vi.COLOR,Tr=(bi=S("cc.ColorOvertimeModule"),xi=b(ti),bi((Ai=function(t){function r(){var e;return(e=t.call(this)||this)._enable=wi&&wi(),e.color=Oi&&Oi(),e.name="colorModule",e}return e(r,t),r.prototype.animate=function(t){t.color.set(t.startColor);var e=Li(this.color)?X(t.randomSeed+xr):0;t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,e))},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),r}(Si),wi=A(Ai.prototype,"_enable",[R],(function(){return!1})),Oi=A(Ai.prototype,"color",[xi,R],(function(){return new ti})),Ti=Ai))||Ti),Ar=vi.FORCE,wr=new F,Or=(Vi=S("cc.ForceOvertimeModule"),Ui=b(ge),ki=b(ge),Ni=b(ge),Gi=b(li),Vi((Xi=function(t){function r(){var e;return(e=t.call(this)||this)._enable=Wi&&Wi(),e.x=Yi&&Yi(),e.y=ji&&ji(),e.z=Zi&&Zi(),e.space=qi&&qi(),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new U,e.needTransform=!1,e.needUpdate=!0,e}e(r,t);var s=r.prototype;return s.update=function(t,e){this.needTransform=Fi(t,this.space,e,this.rotation)},s.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=Bi(this.x)?X(t.randomSeed+Ar):0,s=Bi(this.y)?X(t.randomSeed+Ar):0,n=Bi(this.z)?X(t.randomSeed+Ar):0,o=F.set(wr,this.x.evaluate(i,r),this.y.evaluate(i,s),this.z.evaluate(i,n));this.needTransform&&F.transformQuat(o,o,this.rotation),F.scaleAndAdd(t.velocity,t.velocity,o,e),F.copy(t.ultimateVelocity,t.velocity)},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),r}(Si),Wi=A(Xi.prototype,"_enable",[R],(function(){return!1})),Yi=A(Xi.prototype,"x",[Ui,R],(function(){return new ge})),ji=A(Xi.prototype,"y",[ki,R],(function(){return new ge})),Zi=A(Xi.prototype,"z",[Ni,R],(function(){return new ge})),qi=A(Xi.prototype,"space",[Gi,R],(function(){return li.Local})),Hi=Xi))||Hi),Rr=vi.LIMIT,Fr=new F,Cr=new F,Er=(Qi=S("cc.LimitVelocityOvertimeModule"),Ki=b(ge),Ji=b(ge),$i=b(ge),tr=b(ge),er=b(li),Qi((rr=function(t){function r(){var e;return(e=t.call(this)||this)._enable=sr&&sr(),e.limitX=nr&&nr(),e.limitY=or&&or(),e.limitZ=ar&&ar(),e.limit=lr&&lr(),e.dampen=ur&&ur(),e.separateAxes=hr&&hr(),e.space=cr&&cr(),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new U,e.needTransform=!1,e.needUpdate=!0,e}e(r,t);var s=r.prototype;return s.update=function(t,e){this.needTransform=Fi(t,this.space,e,this.rotation)},s.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Fr;if(this.separateAxes){var r=Bi(this.limitX)?X(t.randomSeed+Rr):0,s=Bi(this.limitY)?X(t.randomSeed+Rr):0,n=Bi(this.limitZ)?X(t.randomSeed+Rr):0;F.set(Cr,this.limitX.evaluate(e,r),this.limitY.evaluate(e,s),this.limitZ.evaluate(e,n)),this.needTransform&&F.transformQuat(Cr,Cr,this.rotation),F.set(i,zr(t.ultimateVelocity.x,Cr.x,this.dampen),zr(t.ultimateVelocity.y,Cr.y,this.dampen),zr(t.ultimateVelocity.z,Cr.z,this.dampen))}else{F.normalize(i,t.ultimateVelocity);var o=Bi(this.limit)?X(t.randomSeed+Rr):0;F.multiplyScalar(i,i,zr(t.ultimateVelocity.length(),this.limit.evaluate(e,o),this.dampen))}F.copy(t.ultimateVelocity,i),F.copy(t.velocity,t.ultimateVelocity)},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),r}(Si),sr=A(rr.prototype,"_enable",[R],(function(){return!1})),nr=A(rr.prototype,"limitX",[Ki,R],(function(){return new ge})),or=A(rr.prototype,"limitY",[Ji,R],(function(){return new ge})),ar=A(rr.prototype,"limitZ",[$i,R],(function(){return new ge})),lr=A(rr.prototype,"limit",[tr,R],(function(){return new ge})),ur=A(rr.prototype,"dampen",[R],(function(){return 3})),hr=A(rr.prototype,"separateAxes",[R],(function(){return!1})),cr=A(rr.prototype,"space",[er,R],(function(){return li.Local})),ir=rr))||ir);function zr(t,e,i){var r=Math.sign(t),s=Math.abs(t);if(s>e){var n=s-s*i;s=n>e?n:e}return s*r}var Dr,Pr,Ir,Br,Lr,Vr,Ur,kr,Nr,Gr,Hr,Xr,Wr,Yr,jr,Zr,qr,Qr,Kr,Jr,$r,ts,es,is,rs,ss,ns,os,as,ls,us,hs,cs,_s,ds,ps,fs,ms,vs,ys,Ms,gs,Ss,bs,xs,Ts,As,ws,Os,Rs,Fs,Cs,Es,zs,Ds,Ps,Is,Bs,Ls,Vs,Us,ks,Ns,Gs,Hs,Xs,Ws,Ys,js,Zs,qs,Qs,Ks,Js,$s,tn,en,rn,sn,nn,on,an,ln,un,hn,cn,_n=vi.ROTATION,dn=(_r=S("cc.RotationOvertimeModule"),dr=b(ge),pr=b(ge),fr=b(ge),_r((vr=function(t){function r(){var e;return(e=t.call(this)||this)._enable=yr&&yr(),e._separateAxes=Mr&&Mr(),e.x=gr&&gr(),e.y=Sr&&Sr(),e.z=br&&br(),e.name="rotationModule",e._startMat=new k,e._matRot=new k,e._quatRot=new U,e._otherEuler=new F,e}e(r,t);var s=r.prototype;return s._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==ci.Mesh&&e===ci.StrecthedBillboard&&this._quatRot.set(0,0,0,1),U.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=ai.INDENTIFY_NEG_QUAT)},s.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=Bi(this.z)?X(t.randomSeed+_n):0,s=t.particleSystem.processor.getInfo().renderMode;if(this._separateAxes&&s!==ci.VerticalBillboard&&s!==ci.HorizontalBillboard){var n=Bi(this.x)?X(t.randomSeed+_n):0,o=Bi(this.y)?X(t.randomSeed+_n):0;U.fromEuler(t.deltaQuat,this.x.evaluate(i,n)*e*ai.R2D,this.y.evaluate(i,o)*e*ai.R2D,this.z.evaluate(i,r)*e*ai.R2D)}else U.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,r)*e*ai.R2D);t.deltaMat=k.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(s!==ci.Mesh&&(s===ci.StrecthedBillboard?t.startEuler.set(0,0,0):s!==ci.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),U.fromEuler(t.startRotation,t.startEuler.x*ai.R2D,t.startEuler.y*ai.R2D,t.startEuler.z*ai.R2D),t.startRotated=!0),this._startMat=k.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),k.getRotation(this._quatRot,this._matRot),this._processRotation(t,ai.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),r}(Si),yr=A(vr.prototype,"_enable",[R],(function(){return!1})),Mr=A(vr.prototype,"_separateAxes",[R],(function(){return!1})),gr=A(vr.prototype,"x",[dr,R],(function(){return new ge})),Sr=A(vr.prototype,"y",[pr,R],(function(){return new ge})),br=A(vr.prototype,"z",[fr,R],(function(){return new ge})),mr=vr))||mr),pn=vi.SIZE,fn=(Dr=S("cc.SizeOvertimeModule"),Pr=b(ge),Ir=b(ge),Br=b(ge),Lr=b(ge),Dr((Ur=function(t){function r(){var e;return(e=t.call(this)||this)._enable=kr&&kr(),e.separateAxes=Nr&&Nr(),e.size=Gr&&Gr(),e.x=Hr&&Hr(),e.y=Xr&&Xr(),e.z=Wr&&Wr(),e.name="sizeModule",e}return e(r,t),r.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=Bi(this.x)?X(t.randomSeed+pn):0,r=Bi(this.y)?X(t.randomSeed+pn):0,s=Bi(this.z)?X(t.randomSeed+pn):0;t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,r),t.size.z=t.startSize.z*this.z.evaluate(e,s)}else{var n=Bi(this.size)?X(t.randomSeed+pn):0;F.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,n))}},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),r}(Si),kr=A(Ur.prototype,"_enable",[R],(function(){return!1})),Nr=A(Ur.prototype,"separateAxes",[R],(function(){return!1})),Gr=A(Ur.prototype,"size",[Pr,R],(function(){return new ge})),Hr=A(Ur.prototype,"x",[Ir,R],(function(){return new ge})),Xr=A(Ur.prototype,"y",[Br,R],(function(){return new ge})),Wr=A(Ur.prototype,"z",[Lr,R],(function(){return new ge})),Vr=Ur))||Vr),mn=vi.TEXTURE,vn=o({Grid:0}),yn=o({WholeSheet:0,SingleRow:1}),Mn=(Yr=S("cc.TextureAnimationModule"),jr=Y("numTilesX"),Zr=Y("numTilesY"),qr=b(vn),Qr=b(vn),Kr=b(yn),Jr=b(ge),$r=b(ge),Yr((es=function(t){function r(){var e;return(e=t.call(this)||this)._enable=is&&is(),e._numTilesX=rs&&rs(),e._numTilesY=ss&&ss(),e._mode=ns&&ns(),e.animation=os&&os(),e.frameOverTime=as&&as(),e.startFrame=ls&&ls(),e.cycleCount=us&&us(),e._flipU=hs&&hs(),e._flipV=cs&&cs(),e._uvChannelMask=_s&&_s(),e.randomRow=ds&&ds(),e.rowIndex=ps&&ps(),e.name="textureModule",e}e(r,t);var s=r.prototype;return s.init=function(t){t.startRow=Math.floor(G()*this.numTilesY)},s.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Bi(this.startFrame)?X(t.randomSeed+mn):0,r=Bi(this.frameOverTime)?X(t.randomSeed+mn):0,s=this.startFrame.evaluate(e,i)/(this.numTilesX*this.numTilesY);if(this.animation===yn.WholeSheet)t.frameIndex=W(this.cycleCount*(this.frameOverTime.evaluate(e,r)+s),1);else if(this.animation===yn.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var o=W(this.cycleCount*(this.frameOverTime.evaluate(e,r)+s),1),a=t.startRow*n,l=a+n;t.frameIndex=C(a,l,o)}else{var u=this.rowIndex*n,h=u+n;t.frameIndex=C(u,h,W(this.cycleCount*(this.frameOverTime.evaluate(e,r)+s),1))}}},s.scaleNumTilesXY=function(t){this._numTilesX*=t,this._numTilesY*=t},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==vn.Grid&&u("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){u("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){u("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){u("particle texture animation's uvChannelMask is not supported!")}}]),r}(Si),is=A(es.prototype,"_enable",[R],(function(){return!1})),rs=A(es.prototype,"_numTilesX",[jr],(function(){return 0})),ss=A(es.prototype,"_numTilesY",[Zr],(function(){return 0})),ns=A(es.prototype,"_mode",[qr],(function(){return vn.Grid})),r(es.prototype,"mode",[Qr],Object.getOwnPropertyDescriptor(es.prototype,"mode"),es.prototype),os=A(es.prototype,"animation",[Kr,R],(function(){return yn.WholeSheet})),as=A(es.prototype,"frameOverTime",[Jr,R],(function(){return new ge})),ls=A(es.prototype,"startFrame",[$r,R],(function(){return new ge})),us=A(es.prototype,"cycleCount",[R],(function(){return 0})),hs=A(es.prototype,"_flipU",[R],(function(){return 0})),cs=A(es.prototype,"_flipV",[R],(function(){return 0})),_s=A(es.prototype,"_uvChannelMask",[R],(function(){return-1})),ds=A(es.prototype,"randomRow",[R],(function(){return!1})),ps=A(es.prototype,"rowIndex",[R],(function(){return 0})),ts=es))||ts),gn=vi.VELOCITY_X,Sn=vi.VELOCITY_Y,bn=vi.VELOCITY_Z,xn=new F,Tn=(fs=S("cc.VelocityOvertimeModule"),ms=b(ge),vs=b(ge),ys=b(ge),Ms=b(ge),gs=b(li),fs((bs=function(t){function r(){var e;return(e=t.call(this)||this)._enable=xs&&xs(),e.x=Ts&&Ts(),e.y=As&&As(),e.z=ws&&ws(),e.speedModifier=Os&&Os(),e.space=Rs&&Rs(),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new U,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}e(r,t);var s=r.prototype;return s.update=function(t,e){this.needTransform=Fi(t,this.space,e,this.rotation)},s.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Bi(this.x)?X(t.randomSeed^gn):0,r=Bi(this.y)?X(t.randomSeed^Sn):0,s=Bi(this.z)?X(t.randomSeed^bn):0,n=Bi(this.speedModifier)?X(t.randomSeed+gn):0,o=F.set(xn,this.x.evaluate(e,i),this.y.evaluate(e,r),this.z.evaluate(e,s));this.needTransform&&F.transformQuat(o,o,this.rotation),F.add(t.animatedVelocity,t.animatedVelocity,o),F.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),F.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,n))},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),r}(Si),xs=A(bs.prototype,"_enable",[R],(function(){return!1})),Ts=A(bs.prototype,"x",[ms,R],(function(){return new ge})),As=A(bs.prototype,"y",[vs,R],(function(){return new ge})),ws=A(bs.prototype,"z",[ys,R],(function(){return new ge})),Os=A(bs.prototype,"speedModifier",[Ms,R],(function(){return new ge})),Rs=A(bs.prototype,"space",[gs,R],(function(){return li.Local})),Ss=bs))||Ss),An=t("Burst",(Fs=S("cc.Burst"),Cs=b(ge),Fs((zs=function(){function t(){this._time=Ds&&Ds(),this._repeatCount=Ps&&Ps(),this.repeatInterval=Is&&Is(),this.count=Bs&&Bs(),this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=W(t.time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var r=W(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<r&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(r-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},i(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),Ds=A(zs.prototype,"_time",[R],(function(){return 0})),Ps=A(zs.prototype,"_repeatCount",[R],(function(){return 1})),Is=A(zs.prototype,"repeatInterval",[R],(function(){return 1})),Bs=A(zs.prototype,"count",[Cs,R],(function(){return new ge})),Es=zs))||Es)),wn=new F(0,0,0),On=[0,0,0],Rn=new F(.5,.5,.5),Fn=(Ls=S("cc.ShapeModule"),Vs=b(_i),Us=Y("shapeType"),ks=b(_i),Ns=b(di),Gs=b(pi),Hs=b(ge),Ls((Ws=function(){function t(){this._enable=Ys&&Ys(),this._shapeType=js&&js(),this.emitFrom=Zs&&Zs(),this.alignToDirection=qs&&qs(),this.randomDirectionAmount=Qs&&Qs(),this.sphericalDirectionAmount=Ks&&Ks(),this.randomPositionAmount=Js&&Js(),this.radius=$s&&$s(),this.radiusThickness=tn&&tn(),this.arcMode=en&&en(),this.arcSpread=rn&&rn(),this.arcSpeed=sn&&sn(),this.length=nn&&nn(),this.boxThickness=on&&on(),this._position=an&&an(),this._rotation=ln&&ln(),this._scale=un&&un(),this._arc=hn&&hn(),this._angle=cn&&cn(),this.mat=new k,this.quat=new U,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem.time},e.emit=function(t){switch(this.shapeType){case _i.Box:Dn(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case _i.Circle:e=this.radius,i=this.radiusThickness,r=this.generateArcAngle(),s=t.position,n=t.velocity,Di(s,e*(1-i),e,r),F.normalize(n,s);break;case _i.Cone:zn(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case _i.Sphere:Cn(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case _i.Hemisphere:En(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:h(this.shapeType+" shapeType is not supported by ShapeModule.")}var e,i,r,s,n;if(this.randomPositionAmount>0&&(t.position.x+=N(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=N(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=N(-this.randomPositionAmount,this.randomPositionAmount)),F.transformQuat(t.velocity,t.velocity,this.quat),F.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var o=F.normalize(wn,t.position);F.lerp(t.velocity,t.velocity,o,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem.time},e.constructMat=function(){U.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),k.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===pi.Random)return N(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem.time,1)*(this.particleSystem.time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case pi.Loop:return W(t,this._arc);case pi.PingPong:return j(t,this._arc);default:return W(t,this._arc)}},i(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return w(this._arc)},set:function(t){this._arc=O(t)}},{key:"angle",get:function(){return Math.round(100*w(this._angle))/100},set:function(t){this._angle=O(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case _i.Box:this.emitFrom===di.Base&&(this.emitFrom=di.Volume);break;case _i.Cone:this.emitFrom===di.Edge&&(this.emitFrom=di.Base);break;case _i.Sphere:case _i.Hemisphere:this.emitFrom!==di.Base&&this.emitFrom!==di.Edge||(this.emitFrom=di.Volume)}}}]),t}(),Ys=A(Ws.prototype,"_enable",[R],(function(){return!1})),js=A(Ws.prototype,"_shapeType",[Vs,Us],(function(){return _i.Cone})),r(Ws.prototype,"shapeType",[ks],Object.getOwnPropertyDescriptor(Ws.prototype,"shapeType"),Ws.prototype),Zs=A(Ws.prototype,"emitFrom",[Ns,R],(function(){return di.Volume})),qs=A(Ws.prototype,"alignToDirection",[R],(function(){return!1})),Qs=A(Ws.prototype,"randomDirectionAmount",[R],(function(){return 0})),Ks=A(Ws.prototype,"sphericalDirectionAmount",[R],(function(){return 0})),Js=A(Ws.prototype,"randomPositionAmount",[R],(function(){return 0})),$s=A(Ws.prototype,"radius",[R],(function(){return 1})),tn=A(Ws.prototype,"radiusThickness",[R],(function(){return 1})),en=A(Ws.prototype,"arcMode",[Gs,R],(function(){return pi.Random})),rn=A(Ws.prototype,"arcSpread",[R],(function(){return 0})),sn=A(Ws.prototype,"arcSpeed",[Hs,R],(function(){return new ge})),nn=A(Ws.prototype,"length",[R],(function(){return 5})),on=A(Ws.prototype,"boxThickness",[R],(function(){return new F(0,0,0)})),an=A(Ws.prototype,"_position",[R],(function(){return new F(0,0,0)})),ln=A(Ws.prototype,"_rotation",[R],(function(){return new F(0,0,0)})),un=A(Ws.prototype,"_scale",[R],(function(){return new F(1,1,1)})),hn=A(Ws.prototype,"_arc",[R],(function(){return O(360)})),cn=A(Ws.prototype,"_angle",[R],(function(){return O(25)})),Xs=Ws))||Xs);function Cn(t,e,i,r,s){switch(t){case di.Volume:zi(r,e*(1-i),e),F.normalize(s,r);break;case di.Shell:Ei(r),F.multiplyScalar(r,r,e),F.normalize(s,r);break;default:h(t+" is not supported for sphere emitter.")}}function En(t,e,i,r,s){switch(t){case di.Volume:zi(r,e*(1-i),e),r.z>0&&(r.z*=-1),F.normalize(s,r);break;case di.Shell:Ei(r),F.multiplyScalar(r,r,e),r.z>0&&(r.z*=-1),F.normalize(s,r);break;default:h(t+" is not supported for hemisphere emitter.")}}function zn(t,e,i,r,s,n,o,a){switch(t){case di.Base:Di(o,e*(1-i),e,r),V.multiplyScalar(a,o,Math.sin(s)),a.z=-Math.cos(s)*e,F.normalize(a,a),o.z=0;break;case di.Shell:Ci(o,r),V.multiplyScalar(a,o,Math.sin(s)),a.z=-Math.cos(s),F.normalize(a,a),V.multiplyScalar(o,o,e),o.z=0;break;case di.Volume:Di(o,e*(1-i),e,r),V.multiplyScalar(a,o,Math.sin(s)),a.z=-Math.cos(s)*e,F.normalize(a,a),o.z=0,F.add(o,o,F.multiplyScalar(wn,a,n*G()/-a.z));break;default:h(t+" is not supported for cone emitter.")}}function Dn(t,e,i,r){switch(t){case di.Volume:s=i,n=Rn,F.set(s,N(-n.x,n.x),N(-n.y,n.y),N(-n.z,n.z));break;case di.Shell:On[0]=N(-.5,.5),On[1]=N(-.5,.5),On[2]=.5*Ii(),Pi(On),Pn(On,e),F.set(i,On[0],On[1],On[2]);break;case di.Edge:On[0]=N(-.5,.5),On[1]=.5*Ii(),On[2]=.5*Ii(),Pi(On),Pn(On,e),F.set(i,On[0],On[1],On[2]);break;default:h(t+" is not supported for box emitter.")}var s,n;F.copy(r,Ri)}function Pn(t,e){e.x>0&&(t[0]+=.5*N(-e.x,e.x),t[0]=Z(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*N(-e.y,e.y),t[1]=Z(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*N(-e.z,e.z),t[2]=Z(t[2],-.5,.5))}var In=[0,0,1,0,0,1,1,1],Bn=[0,0,0,1,0,0,0,1,0,1,1,0],Ln=function(t){function r(){var e;return(e=t.call(this)||this)._capacity=void 0,e._bufferSize=void 0,e._vertAttrs=void 0,e._vertAttribSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e._vertAttribSizeStatic=void 0,e._vertStaticAttrsFloatCount=void 0,e._insBuffers=void 0,e._insIndices=void 0,e._useInstance=void 0,e._iaVertCount=0,e._iaIndexCount=0,e.type=vt.PARTICLE_BATCH,e._capacity=0,e._bufferSize=16,e._vertAttrs=null,e._vertAttribSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._vertAttribSizeStatic=0,e._vertStaticAttrsFloatCount=0,e._insBuffers=[],e._insIndices=null,gt.gfxDevice.hasFeature(Ft.INSTANCED_ARRAYS)?e._useInstance=!0:e._useInstance=!1,e._subMeshData=null,e._mesh=null,e}e(r,t);var n=r.prototype;return n.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._bufferSize=Math.max(this._capacity,16),this._subMeshData&&e&&this.rebuild()},n.setVertexAttributes=function(t,e){if(this._useInstance)this.setVertexAttributesIns(t,e);else{if(this._mesh===t&&this._vertAttrs===e)return;this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0;for(var i,r=s(this._vertAttrs);!(i=r()).done;){var n=i.value;n.offset=this._vertAttribSize,this._vertAttribSize+=At[n.format].size}this._vertAttrsFloatCount=this._vertAttribSize/4,this.rebuild()}},n.setVertexAttributesIns=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0,this._vertAttribSizeStatic=0;for(var i,r=s(this._vertAttrs);!(i=r()).done;){var n=i.value;0===n.stream?(n.offset=this._vertAttribSize,this._vertAttribSize+=At[n.format].size):1===n.stream&&(n.offset=this._vertAttribSizeStatic,this._vertAttribSizeStatic+=At[n.format].size)}this._vertAttrsFloatCount=this._vertAttribSize/4,this._vertStaticAttrsFloatCount=this._vertAttribSizeStatic/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new wt(Ot.VERTEX|Ot.TRANSFER_DST,Rt.HOST|Rt.DEVICE,this._vertAttribSize*this._bufferSize*this._vertCount,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize*this._vertCount);if(this._mesh&&this._capacity>0){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===xt.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,xt.ATTR_TEX_COORD,e,this._vertAttribSize,i);var r=this._vertAttrs.findIndex((function(t){return t.name===xt.ATTR_TEX_COORD3}));if(i=this._vertAttrs[r++].offset,this._mesh.copyAttribute(0,xt.ATTR_POSITION,e,this._vertAttribSize,i),i=this._vertAttrs[r++].offset,this._mesh.copyAttribute(0,xt.ATTR_NORMAL,e,this._vertAttribSize,i),i=this._vertAttrs[r++].offset,!this._mesh.copyAttribute(0,xt.ATTR_COLOR,e,this._vertAttribSize,i))for(var s=new Uint32Array(e),n=0;n<this._vertCount;++n)s[n*this._vertAttrsFloatCount+i/4]=T.toUint32(T.WHITE);for(var o=new Float32Array(e),a=1;a<this._capacity;a++)o.copyWithin(a*this._vertAttribSize*this._vertCount/4,0,this._vertAttribSize*this._vertCount/4)}t.update(e);var l=new Uint16Array(this._bufferSize*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var h=0;h<this._indexCount;h++)l[u*this._indexCount+h]=l[h]+u*this._vertCount}else for(var c=0,_=0;_<this._capacity;++_){var d=4*_;l[c++]=d,l[c++]=d+1,l[c++]=d+2,l[c++]=d+3,l[c++]=d+2,l[c++]=d+1}var p=this._device.createBuffer(new wt(Ot.INDEX|Ot.TRANSFER_DST,Rt.DEVICE,this._bufferSize*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return p.update(l),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=this._capacity*this._indexCount,this._subMeshData=new Mt([t],this._vertAttrs,St.TRIANGLE_LIST,p),this.initSubModel(0,this._subMeshData,this._material),e},n.createSubMeshDataInsDynamic=function(){this._insBuffers.length=0,this.destroySubMeshData();var t=this._device.createBuffer(new wt(Ot.VERTEX|Ot.TRANSFER_DST,Rt.HOST|Rt.DEVICE,this._vertAttribSize*this._bufferSize,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize);return t.update(e),this._insBuffers.push(t),e},n.createSubMeshDataInsStatic=function(){this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new wt(Ot.VERTEX|Ot.TRANSFER_DST,Rt.HOST|Rt.DEVICE,this._vertAttribSizeStatic*this._vertCount,this._vertAttribSizeStatic)),e=new ArrayBuffer(this._vertAttribSizeStatic*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(t){return t.name===xt.ATTR_TEX_COORD})),r=this._vertAttrs[i].offset;if(this._mesh.copyAttribute(0,xt.ATTR_TEX_COORD,e,this._vertAttribSizeStatic,r),i=this._vertAttrs.findIndex((function(t){return t.name===xt.ATTR_TEX_COORD3})),r=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,xt.ATTR_POSITION,e,this._vertAttribSizeStatic,r),r=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,xt.ATTR_NORMAL,e,this._vertAttribSizeStatic,r),r=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,xt.ATTR_COLOR,e,this._vertAttribSizeStatic,r))for(var s=new Uint32Array(e),n=0;n<this._vertCount;++n)s[n*this._vertStaticAttrsFloatCount+r/4]=T.toUint32(T.WHITE)}else for(var o=new Float32Array(e),a=0;a<Bn.length;++a)o[a]=Bn[a];t.update(e);var l=new Uint16Array(this._indexCount);this._mesh?this._mesh.copyIndices(0,l):(l[0]=0,l[1]=1,l[2]=2,l[3]=3,l[4]=2,l[5]=1);var u=this._device.createBuffer(new wt(Ot.INDEX|Ot.TRANSFER_DST,Rt.DEVICE,this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));u.update(l),this._insIndices=u,this._iaVertCount=this._vertCount,this._iaIndexCount=this._indexCount,this._insBuffers.push(t)},n.createInsSubmesh=function(){this._subMeshData=new Mt(this._insBuffers,this._vertAttrs,St.TRIANGLE_LIST,this._insIndices),this.initSubModel(0,this._subMeshData,this._material)},n.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},n.addParticleVertexData=function(t,e){if(this._useInstance)this.addParticleVertexDataIns(t,e);else if(this._mesh)for(var i=0;i<this._vertCount;i++){var r=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[r++]=e.position.x,this._vdataF32[r++]=e.position.y,this._vdataF32[r++]=e.position.z,r+=2,this._vdataF32[r++]=e.texcoord.z,this._vdataF32[r++]=e.size.x,this._vdataF32[r++]=e.size.y,this._vdataF32[r++]=e.size.z,this._vdataF32[r++]=e.rotation.x,this._vdataF32[r++]=e.rotation.y,this._vdataF32[r++]=e.rotation.z,this._vdataUint32[r++]=e.color}else{var s=t*this._vertAttrsFloatCount;this._vdataF32[s++]=e.position.x,this._vdataF32[s++]=e.position.y,this._vdataF32[s++]=e.position.z,this._vdataF32[s++]=e.texcoord.x,this._vdataF32[s++]=e.texcoord.y,this._vdataF32[s++]=e.texcoord.z,this._vdataF32[s++]=e.size.x,this._vdataF32[s++]=e.size.y,this._vdataF32[s++]=e.size.z,this._vdataF32[s++]=e.rotation.x,this._vdataF32[s++]=e.rotation.y,this._vdataF32[s++]=e.rotation.z,this._vdataUint32[s++]=e.color,e.velocity&&(this._vdataF32[s++]=e.velocity.x,this._vdataF32[s++]=e.velocity.y,this._vdataF32[s++]=e.velocity.z)}},n.addParticleVertexDataIns=function(t,e){var i=t*this._vertAttrsFloatCount;this._mesh?(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color):(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color,e.velocity&&(this._vdataF32[i++]=e.velocity.x,this._vdataF32[i++]=e.velocity.y,this._vdataF32[i++]=e.velocity.z))},n.addGPUParticleVertexData=function(t,e,i){if(this._useInstance)this.addGPUParticleVertexDataIns(t,e,i);else for(var r=e*this._vertAttrsFloatCount*this._vertCount,s=0;s<this._vertCount;s++){var n=r;this._vdataF32[n++]=t.position.x,this._vdataF32[n++]=t.position.y,this._vdataF32[n++]=t.position.z,this._vdataF32[n++]=i,this._vdataF32[n++]=t.startSize.x,this._vdataF32[n++]=t.startSize.y,this._vdataF32[n++]=t.startSize.z,this._vdataF32[n++]=In[2*s],this._vdataF32[n++]=t.rotation.x,this._vdataF32[n++]=t.rotation.y,this._vdataF32[n++]=t.rotation.z,this._vdataF32[n++]=In[2*s+1],this._vdataF32[n++]=t.startColor.r/255,this._vdataF32[n++]=t.startColor.g/255,this._vdataF32[n++]=t.startColor.b/255,this._vdataF32[n++]=t.startColor.a/255,this._vdataF32[n++]=t.velocity.x,this._vdataF32[n++]=t.velocity.y,this._vdataF32[n++]=t.velocity.z,this._vdataF32[n++]=t.startLifetime,this._vdataF32[n++]=t.randomSeed,r+=this._vertAttrsFloatCount}},n.addGPUParticleVertexDataIns=function(t,e,i){var r=e*this._vertAttrsFloatCount,s=r;this._vdataF32[s++]=t.position.x,this._vdataF32[s++]=t.position.y,this._vdataF32[s++]=t.position.z,this._vdataF32[s++]=i,this._vdataF32[s++]=t.startSize.x,this._vdataF32[s++]=t.startSize.y,this._vdataF32[s++]=t.startSize.z,this._vdataF32[s++]=t.frameIndex,this._vdataF32[s++]=t.rotation.x,this._vdataF32[s++]=t.rotation.y,this._vdataF32[s++]=t.rotation.z,this._vdataF32[s++]=t.startColor.r/255,this._vdataF32[s++]=t.startColor.g/255,this._vdataF32[s++]=t.startColor.b/255,this._vdataF32[s++]=t.startColor.a/255,this._vdataF32[s++]=t.velocity.x,this._vdataF32[s++]=t.velocity.y,this._vdataF32[s++]=t.velocity.z,this._vdataF32[s++]=t.startLifetime,this._vdataF32[s++]=t.randomSeed,r+=this._vertAttrsFloatCount},n.updateGPUParticles=function(t,e,i){if(this._useInstance)return this.updateGPUParticlesIns(t,e,i);for(var r=this._vertAttrsFloatCount*this._vertCount,s=0,n=0,o=0,a=0;a<t;++a)s=a*r,n=this._vdataF32[s+this._startTimeOffset],this._vdataF32[s+this._lifeTimeOffset]-(e-n)<i&&(o=--t*r,this._vdataF32.copyWithin(s,o,o+r),a--);return t},n.updateGPUParticlesIns=function(t,e,i){for(var r=this._vertAttrsFloatCount,s=0,n=0,o=0,a=0;a<t;++a)s=a*r,n=this._vdataF32[s+this._startTimeOffset],this._vdataF32[s+this._lifeTimeOffset]-(e-n)<i&&(o=--t*r,this._vdataF32.copyWithin(s,o,o+r),a--);return t},n.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},n.updateIA=function(t){if(this._useInstance)this.updateIAIns(t);else{if(t<=0)return;var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount}},n.updateIAIns=function(t){if(!(t<=0)){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.instanceCount=t,e.firstIndex=0,e.indexCount=this._indexCount,e.instanceCount=t,e.vertexCount=this._iaVertCount}},n.clear=function(){this._useInstance?this.clearIns():this._subModels[0].inputAssembler.indexCount=0},n.clearIns=function(){this._subModels[0].inputAssembler.instanceCount=0},n.destroy=function(){t.prototype.destroy.call(this),this.doDestroy()},n.doDestroy=function(){this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._insBuffers=[],this._insIndices=null,this._vertAttrs=null,this._material=null,this._mesh=null,this.destroySubMeshData()},n.rebuild=function(){this._useInstance?this.rebuildIns():(this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer))},n.rebuildIns=function(){this._vBuffer=this.createSubMeshDataInsDynamic(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this.createSubMeshDataInsStatic(),this.createInsSubmesh()},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},i(r,[{key:"useInstance",get:function(){return this._useInstance},set:function(t){this._useInstance!==t&&(this._useInstance=t)}}]),r}(mt),Vn=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._useInstance=void 0,this._renderInfo=t,gt.gfxDevice.hasFeature(Ft.INSTANCED_ARRAYS)?this._useInstance=!0:this._useInstance=!1}var e=t.prototype;return e.getUseInstance=function(){return this._useInstance},e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(rt.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){var t;this._model&&(this._model.scene&&this.detachFromScene(),null==(t=this._particleSystem)||t._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&(this.updateVertexAttrib(),this._model.setVertexAttributes(this._renderInfo.renderMode===ci.Mesh?this._renderInfo.mesh:null,this._vertAttrs))},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){!this._model&&this._particleSystem&&(this._model=rt.director.root.createModel(Ln),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},i(t,[{key:"model",get:function(){return this._model}}]),t}(),Un=function(){function t(t){this.permutation=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.accSpeed=new F,this.noiseSpeed=new F,this.noiseFrequency=0,this.noiseAbs=new F,this.noiseAmplitude=new F,this.octaves=new F,this.dt=0,this.point=new F,this.result=new F,this.mixOut=new V,t&&(this.permutation=t)}var e=t.prototype;return e.noise=function(t,e,i,r,s){void 0===r&&(r=0),void 0===s&&(s=1);for(var n=new Array(512),o=0;o<256;o++)n[256+o]=n[o]=this.permutation[o];var a=255&Math.floor(t),l=255&Math.floor(e),u=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);var h=this.fade(t),c=this.fade(e),_=this.fade(i),d=n[a]+l,p=n[d]+u,f=n[d+1]+u,m=n[a+1]+l,v=n[m]+u,y=n[m+1]+u;return r+this.scale(this.lerp(_,this.lerp(c,this.lerp(h,this.grad(n[p],t,e,i),this.grad(n[v],t-1,e,i)),this.lerp(h,this.grad(n[f],t,e-1,i),this.grad(n[y],t-1,e-1,i))),this.lerp(c,this.lerp(h,this.grad(n[p+1],t,e,i-1),this.grad(n[v+1],t-1,e,i-1)),this.lerp(h,this.grad(n[f+1],t,e-1,i-1),this.grad(n[y+1],t-1,e-1,i-1)))))*(s-r)},e.fade=function(t){return t*t*t*(t*(6*t-15)+10)},e.lerp=function(t,e,i){return e+t*(i-e)},e.grad=function(t,e,i,r){var s=15&t,n=s<8?e:i,o=s<4?i:12===s||14===s?e:r;return(1&s?-n:n)+(2&s?-o:o)},e.scale=function(t){return(1+t)/2},e.setSpeed=function(t,e,i){this.noiseSpeed.set(t,e,i)},e.setFrequency=function(t){this.noiseFrequency=t},e.setAbs=function(t,e,i){this.noiseAbs.set(t,e,i)},e.setAmplititude=function(t,e,i){this.noiseAmplitude.set(t,e,i)},e.setOctaves=function(t,e,i){this.octaves.set(t,e,i)},e.setTime=function(t){this.dt=t},e.setSamplePoint=function(t){this.point.set(t)},e.getResult=function(){return this.result},e.getNoise=function(t,e,i,r,s,n,o){var a=n,l=0;if(l+=this.noise(t*a,e*a,i*a,-1,1),1===o.x)return l;for(var u=1,h=1,c=1;c<o.x;++c)u*=o.y,a*=o.z,h+=u,l+=this.noise(t*a,e*a,i*a,-1,1)*u;return l/h},e.getNoiseMix=function(t,e,i,r,s,n){t.x=this.getNoise(e.x,e.y,e.z,i,r,s,n),t.y=this.getNoise(e.y,e.z,e.x,i,r,s,n)},e.getNoiseParticle=function(){this.accSpeed.set(this.noiseSpeed.x*this.dt,this.noiseSpeed.y*this.dt,this.noiseSpeed.z*this.dt);var t=this.getNoise(this.point.z+this.accSpeed.x,this.point.y,this.point.x,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),e=this.getNoise(this.point.x+1e3,this.point.z+this.accSpeed.y,this.point.y,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),i=this.getNoise(this.point.y,this.point.x+1e3,this.point.z+this.accSpeed.z,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);this.result.set(t*this.noiseAmplitude.x,e*this.noiseAmplitude.y,i*this.noiseAmplitude.z)},e.getPreview=function(t,e,i){for(var r=0;r<i;++r)for(var s=0;s<e;++s){var n=(s-.5*e)/e+this.noiseSpeed.x*this.dt,o=(r-.5*i)/i+this.noiseSpeed.y*this.dt,a=this.getNoise(n,o,0,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);t[r*e+s]=.5*(a+1)}},t}(),kn=new x,Nn=q(),Gn=new k,Hn=new k,Xn=new U,Wn=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule"],Yn=[0,0,1,0,0,1,1,1],jn="CC_USE_WORLD_SPACE",Zn="CC_USE_EMBEDDED_ALPHA",qn="CC_RENDER_MODE",Qn=xt.ATTR_POSITION,Kn=xt.ATTR_NORMAL,Jn=xt.ATTR_COLOR,$n=xt.ATTR_COLOR1,to=xt.ATTR_TEX_COORD,eo=xt.ATTR_TEX_COORD1,io=xt.ATTR_TEX_COORD2,ro=xt.ATTR_TEX_COORD3,so=xt.ATTR_TEX_COORD4;function no(t,e,i,r,s,n){return void 0===i&&(i=!1),void 0===r&&(r=0),void 0===s&&(s=!1),void 0===n&&(n=0),new bt(t,e,i,r,s,n)}var oo=[no(Qn,Tt.RGB32F),no(to,Tt.RGB32F),no(eo,Tt.RGB32F),no(io,Tt.RGB32F),no(Jn,Tt.RGBA8,!0)],ao=[no(Qn,Tt.RGB32F),no(to,Tt.RGB32F),no(eo,Tt.RGB32F),no(io,Tt.RGB32F),no(Jn,Tt.RGBA8,!0),no($n,Tt.RGB32F)],lo=[no(Qn,Tt.RGB32F),no(to,Tt.RGB32F),no(eo,Tt.RGB32F),no(io,Tt.RGB32F),no(Jn,Tt.RGBA8,!0),no(ro,Tt.RGB32F),no(Kn,Tt.RGB32F),no($n,Tt.RGBA8,!0)],uo=[no(so,Tt.RGBA32F,!1,0,!0),no(eo,Tt.RGB32F,!1,0,!0),no(io,Tt.RGB32F,!1,0,!0),no(Jn,Tt.RGBA8,!0,0,!0),no(to,Tt.RGB32F,!1,1)],ho=[no(so,Tt.RGBA32F,!1,0,!0),no(eo,Tt.RGB32F,!1,0,!0),no(io,Tt.RGB32F,!1,0,!0),no(Jn,Tt.RGBA8,!0,0,!0),no($n,Tt.RGB32F,!1,0,!0),no(to,Tt.RGB32F,!1,1)],co=[no(so,Tt.RGBA32F,!1,0,!0),no(eo,Tt.RGB32F,!1,0,!0),no(io,Tt.RGB32F,!1,0,!0),no(Jn,Tt.RGBA8,!0,0,!0),no(to,Tt.RGB32F,!1,1),no(ro,Tt.RGB32F,!1,1),no(Kn,Tt.RGB32F,!1,1),no($n,Tt.RGBA8,!0,1)],_o={parent:null,owner:null,subModelIdx:0},po=function(){this.position=void 0,this.texcoord=void 0,this.size=void 0,this.rotation=void 0,this.color=void 0,this.velocity=void 0,this.position=q(),this.texcoord=q(),this.size=q(),this.rotation=q(),this.color=0,this.velocity=null},fo=function(t){function i(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._particleVertexData=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=[],i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._uNodeRotHandle=0,i._alignSpace=hi.View,i._inited=!1,i._localMat=new k,i._gravity=new x,i.noise=new Un,i._model=null,i._frameTile_velLenScale=new x(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=q(),i._particleVertexData=new po,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}e(i,t);var r=i.prototype;return r.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new c((function(){return new ai(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},r.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem&&this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},r.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},r.onDestroy=function(){var e;null==(e=this._particles)||e.destroy(),t.prototype.onDestroy.call(this)},r.getFreeParticle=function(){return this._particleSystem&&this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},r.getDefaultTrailMaterial=function(){return this._defaultTrailMat},r.setNewParticle=function(){},r._initModuleList=function(){var t=this;Wn.forEach((function(e){if(t._particleSystem){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&t._updateList.set(i.name,i),i.needAnimate&&t._animateList.set(i.name,i))}})),this._runAnimateList.length=0;for(var e=0,i=Mi.length;e<i;e++){var r=this._animateList.get(Mi[e]);r&&this._runAnimateList.push(r)}},r.enableModule=function(t,e,i){e?(i.needUpdate&&this._updateList.set(i.name,i),i.needAnimate&&this._animateList.set(i.name,i)):(this._animateList.delete(t),this._updateList.delete(t)),this._runAnimateList.length=0;for(var r=0,s=Mi.length;r<s;r++){var n=this._animateList.get(Mi[r]);n&&this._runAnimateList.push(n)}this.updateMaterialParams()},r.updateAlignSpace=function(t){this._alignSpace=t},r.getDefaultMaterial=function(){return this._defaultMat},r.updateRotation=function(t){t&&this.doUpdateRotation(t)},r.doUpdateRotation=function(t){if(this._renderInfo.renderMode===ci.Mesh||this._alignSpace!==hi.View){var e;if(this._alignSpace===hi.Local)null==(e=this._particleSystem)||e.node.getRotation(Xn);else if(this._alignSpace===hi.World){var i;null==(i=this._particleSystem)||i.node.getWorldRotation(Xn)}else if(this._alignSpace===hi.View){var r,s;Xn.set(0,0,0,1);var n=null==(r=this._particleSystem)||null==(s=r.node.scene.renderScene)?void 0:s.cameras;if(void 0!==n)for(var o=0;o<(null==n?void 0:n.length);++o){var a=n[o];if((a.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){U.fromViewUp(Xn,a.forward);break}}}else Xn.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Xn)}},r.updateScale=function(t){t&&this.doUpdateScale(t)},r.doUpdateScale=function(t){var e,i,r,s=this._node_scale;switch(null==(e=this._particleSystem)?void 0:e.scaleSpace){case li.Local:null==(i=this._particleSystem)||i.node.getScale(s);break;case li.World:null==(r=this._particleSystem)||r.node.getWorldScale(s)}t.setUniform(this._uScaleHandle,kn.set(s.x,s.y,s.z))},r.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;i.node.getWorldMatrix(Gn);var r=(i.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(r),this.doUpdateRotation(r),this._updateList.forEach((function(){}));var s=i._trailModule,n=s&&s.enable;n&&s.update();var o=!i.gravityModifier.isZero();if(o){if(i.simulationSpace===li.Local){var a=i.node.getRotation();k.fromQuat(this._localMat,a),this._localMat.transpose()}if(i.node.parent){var l=i.node.parent.worldRotation;k.fromQuat(Hn,l),Hn.transpose()}}for(var u=function(){var r=e._particles.data[h];if(r.remainingLifetime-=t,F.set(r.animatedVelocity,0,0,0),r.remainingLifetime<0)return n&&s.removeParticle(r),e._particles.removeAt(h),1;if(o){var a=Bi(i.gravityModifier)?X(r.randomSeed):0;if(i.simulationSpace===li.Local){var l=1-r.remainingLifetime/r.startLifetime,u=9.8*-i.gravityModifier.evaluate(l,a)*t;e._gravity.x=0,e._gravity.y=u,e._gravity.z=0,e._gravity.w=1,E(u,0,P)||(i.node.parent&&(e._gravity=e._gravity.transformMat4(Hn)),e._gravity=e._gravity.transformMat4(e._localMat),r.velocity.x+=e._gravity.x,r.velocity.y+=e._gravity.y,r.velocity.z+=e._gravity.z)}else r.velocity.y-=9.8*i.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,a)*t}F.copy(r.ultimateVelocity,r.velocity),e._runAnimateList.forEach((function(e){e.animate(r,t)})),F.scaleAndAdd(r.position,r.position,r.ultimateVelocity,t),n&&s.animate(r,t)},h=this._particles.length-1;h>=0;h--)u();return this._model.enabled=this._particles.length>0,this._particles.length},r.getNoisePreview=function(t,e,i){var r=this;this._runAnimateList.forEach((function(s){s.name===yi&&s.getNoisePreview(t,r._particleSystem,e,i)}))},r.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],r=0,s=this._particleSystem._textureAnimationModule;s&&s.enable&&(r=i.frameIndex),t=4*e,this._fillDataFunc(i,t,r)}},r.beforeRender=function(){this._model.updateIA(this._particles.length)},r.getParticleCount=function(){return this._particles.length},r.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},r.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule,r=null==i?void 0:i.getModel();r&&1===t&&r.setSubModelMaterial(0,e)},r._setFillFunc=function(){this._renderInfo.renderMode===ci.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===ci.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},r._fillMeshData=function(t,e,i){var r=this._particleVertexData,s=e/4;F.copy(r.position,t.position),Nn.z=i,F.copy(r.texcoord,Nn),F.copy(r.size,t.size),F.copy(r.rotation,t.rotation),r.color=T.toUint32(t.color),this._model.addParticleVertexData(s,r)},r._fillStrecthedData=function(t,e,i){var r=this._particleVertexData;if(this._useInstance)this._fillStrecthedDataIns(t,e,i);else for(var s=0;s<4;++s)F.copy(r.position,t.position),Nn.x=Yn[2*s],Nn.y=Yn[2*s+1],Nn.z=i,F.copy(r.texcoord,Nn),F.copy(r.size,t.size),F.copy(r.rotation,t.rotation),r.color=T.toUint32(t.color),r.velocity=t.ultimateVelocity,this._model.addParticleVertexData(e++,r)},r._fillStrecthedDataIns=function(t,e,i){var r=this._particleVertexData,s=e/4;F.copy(r.position,t.position),Nn.z=i,F.copy(r.texcoord,Nn),F.copy(r.size,t.size),F.copy(r.rotation,t.rotation),r.color=T.toUint32(t.color),r.velocity=t.ultimateVelocity,this._model.addParticleVertexData(s,r)},r._fillNormalData=function(t,e,i){var r=this._particleVertexData;if(this._useInstance)this._fillNormalDataIns(t,e,i);else for(var s=0;s<4;++s)F.copy(r.position,t.position),Nn.x=Yn[2*s],Nn.y=Yn[2*s+1],Nn.z=i,F.copy(r.texcoord,Nn),F.copy(r.size,t.size),F.copy(r.rotation,t.rotation),this._particleVertexData.color=T.toUint32(t.color),this._model.addParticleVertexData(e++,r)},r._fillNormalDataIns=function(t,e,i){var r=this._particleVertexData,s=e/4;F.copy(r.position,t.position),Nn.z=i,F.copy(r.texcoord,Nn),F.copy(r.size,t.size),F.copy(r.rotation,t.rotation),this._particleVertexData.color=T.toUint32(t.color),this._model.addParticleVertexData(s,r)},r.updateVertexAttrib=function(){if(this._renderInfo.renderMode===ci.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,xt.ATTR_COLOR);if(t){for(var e=Tt.RGBA8,i=0;i<At.length;++i)if(At[i].name===t.name){e=i;break}this._vertAttrs[7]=no($n,e,!0,this._useInstance?1:0)}else{var r=Tt.RGBA8;this._vertAttrs[7]=no($n,r,!0,this._useInstance?1:0)}}},r._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case ci.StrecthedBillboard:this._vertAttrs=ao.slice();break;case ci.Mesh:this._vertAttrs=lo.slice();break;default:this._vertAttrs=oo.slice()}},r._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case ci.StrecthedBillboard:this._vertAttrs=ho.slice();break;case ci.Mesh:this._vertAttrs=co.slice();break;default:this._vertAttrs=uo.slice()}},r.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!=e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(_o.parent=nt.get("default-particle-material"),_o.owner=this._particleSystem,_o.subModelIdx=0,this._defaultMat=new ct(_o),_o.parent=null,_o.owner=null,_o.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.simulationSpace===li.World?this._defines[jn]=!0:this._defines[jn]=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var s=this._renderInfo.renderMode,n=this._frameTile_velLenScale;s===ci.Billboard?this._defines[qn]=0:s===ci.StrecthedBillboard?(this._defines[qn]=1,n.z=this._renderInfo.velocityScale,n.w=this._renderInfo.lengthScale):s===ci.HorizontalBillboard?this._defines[qn]=2:s===ci.VerticalBillboard?this._defines[qn]=3:s===ci.Mesh?this._defines[qn]=4:h("particle system renderMode "+s+" not support.");var o=t._textureAnimationModule;if(o&&o.enable){var a=i.getProperty("mainTexture",0);a&&a.isAlphaAtlas&&(o.scaleNumTilesXY(2),this._defines[Zn]=!0),x.copy(this._tmp_velLenScale,n),V.set(this._tmp_velLenScale,o.numTilesX,o.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)}else r.setUniform(this._uLenHandle,n);var l,u=this._particleSystem._rotationOvertimeModule;l=!!u&&u.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=l,this._defines.CC_INSTANCE_PARTICLE=this._useInstance,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},r.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===li.World||e.space===li.World?this._trailDefines[jn]=!0:this._trailDefines[jn]=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(_o.parent=nt.get("default-trail-material"),_o.owner=this._particleSystem,_o.subModelIdx=1,this._defaultTrailMat=new ct(_o),_o.parent=null,_o.owner=null,_o.subModelIdx=0);var r=(i=i||this._defaultTrailMat).getProperty("mainTexture",0);r&&r.isAlphaAtlas&&(this._trailDefines[Zn]=!0),i.recompileShaders(this._trailDefines),e.updateMaterial()}}},r.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},i}(Vn),mo=new x,vo=new k,yo=new x,Mo=new U,go=new U;new F;var So,bo,xo,To,Ao,wo,Oo,Ro,Fo,Co,Eo,zo,Do,Po,Io,Bo,Lo,Vo,Uo,ko,No,Go=32,Ho="CC_USE_WORLD_SPACE",Xo="CC_RENDER_MODE",Wo="a_position_starttime",Yo="a_size_uv",jo="a_rotation_uv",Zo="a_color",qo="a_dir_life",Qo="a_rndSeed",Ko="a_size_fid",Jo="a_rotation",$o=[new bt(Wo,Tt.RGBA32F),new bt(Yo,Tt.RGBA32F),new bt(jo,Tt.RGBA32F),new bt(Zo,Tt.RGBA32F),new bt(qo,Tt.RGBA32F),new bt(Qo,Tt.R32F)],ta=[new bt(Wo,Tt.RGBA32F),new bt(Yo,Tt.RGBA32F),new bt(jo,Tt.RGBA32F),new bt(Zo,Tt.RGBA32F),new bt(qo,Tt.RGBA32F),new bt(Qo,Tt.R32F),new bt(xt.ATTR_TEX_COORD,Tt.RGB32F),new bt(xt.ATTR_TEX_COORD3,Tt.RGB32F),new bt(xt.ATTR_NORMAL,Tt.RGB32F),new bt(xt.ATTR_COLOR1,Tt.RGBA8,!0)],ea=[new bt(Wo,Tt.RGBA32F,!1,0,!0),new bt(Ko,Tt.RGBA32F,!1,0,!0),new bt(Jo,Tt.RGB32F,!1,0,!0),new bt(Zo,Tt.RGBA32F,!1,0,!0),new bt(qo,Tt.RGBA32F,!1,0,!0),new bt(Qo,Tt.R32F,!1,0,!0),new bt("a_uv",Tt.RGB32F,!1,1)],ia=[new bt(Wo,Tt.RGBA32F,!1,0,!0),new bt(Ko,Tt.RGBA32F,!1,0,!0),new bt(Jo,Tt.RGB32F,!1,0,!0),new bt(Zo,Tt.RGBA32F,!1,0,!0),new bt(qo,Tt.RGBA32F,!1,0,!0),new bt(Qo,Tt.R32F,!1,0,!0),new bt(xt.ATTR_TEX_COORD,Tt.RGB32F,!1,1),new bt(xt.ATTR_TEX_COORD3,Tt.RGB32F,!1,1),new bt(xt.ATTR_NORMAL,Tt.RGB32F,!1,1),new bt(xt.ATTR_COLOR1,Tt.RGBA8,!0,1)],ra={parent:null,owner:null,subModelIdx:0},sa=function(t){function i(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._colorData=null,i._forceData=null,i._velocityData=null,i._rotationData=null,i._sizeData=null,i._animData=null,i._uTimeHandle=0,i._uRotHandle=0,i._uNodeRotHandle=0,i._alignSpace=hi.View,i._inited=!1,i._frameTile_velLenScale=new x(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new F,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new ai(null),i._particleNum=0,i}e(i,t);var r=i.prototype;return r.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},r.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},r.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},r.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},r.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy(),this._forceData=null,this._velocityData=null,this._colorData=null,this._sizeData=null,this._rotationData=null,this._animData=null},r.enableModule=function(){var t,e=(null==(t=this._particleSystem)?void 0:t.getMaterialInstance(0))||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},r.getFreeParticle=function(){var t;return this._particleSystem&&this._particleNum>=(null==(t=this._particleSystem)?void 0:t.capacity)?null:this._tempParticle},r.setNewParticle=function(t){this._particleSystem&&(this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem.time),this._particleNum++)},r.getDefaultMaterial=function(){return this._defaultMat},r.updateRotation=function(t){t&&this.doUpdateRotation(t)},r.doUpdateRotation=function(t){if(this._renderInfo.renderMode===ci.Mesh||this._alignSpace!==hi.View){var e;if(this._alignSpace===hi.Local)null==(e=this._particleSystem)||e.node.getRotation(go);else if(this._alignSpace===hi.World){var i;null==(i=this._particleSystem)||i.node.getWorldRotation(go)}else if(this._alignSpace===hi.View){var r,s;go.set(0,0,0,1);var n=null==(r=this._particleSystem)||null==(s=r.node.scene.renderScene)?void 0:s.cameras;if(void 0!==n&&this._particleSystem)for(var o=0;o<(null==n?void 0:n.length);++o){var a=n[o];if((a.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){U.fromViewUp(go,a.forward);break}}}else go.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,go)}},r.updateScale=function(t){t&&this.doUpdateScale(t)},r.doUpdateScale=function(t){var e,i=this._node_scale;switch(null==(e=this._particleSystem)?void 0:e.scaleSpace){case li.Local:this._particleSystem.node.getScale(i);break;case li.World:this._particleSystem.node.getWorldScale(i)}t.setUniform(t.getHandle("scale"),mo.set(i.x,i.y,i.z))},r.updateParticles=function(t){return this._particleSystem?(this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem.time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum):this._particleNum},r.updateRenderData=function(){},r.beforeRender=function(){this._model.updateIA(this._particleNum)},r.updateAlignSpace=function(t){this._alignSpace=t},r.updateShaderUniform=function(t){if(this._particleSystem){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];yo.x=this._particleSystem.time,yo.y=t,i.setUniform(this._uTimeHandle,yo),this._particleSystem.node.getWorldRotation(Mo),i.setUniform(this._uRotHandle,Mo),this.doUpdateRotation(i)}}},r.initShaderUniform=function(t){var e,i,r,s,n,o,a=t.passes[0];this._uTimeHandle=a.getHandle("u_timeDelta"),this._uRotHandle=a.getHandle("u_worldRot"),this._uNodeRotHandle=a.getHandle("nodeRotation"),this.doUpdateScale(a),a.setUniform(a.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),yo.x=Go,yo.y=.03125,a.setUniform(a.getHandle("u_sampleInfo"),yo);var l=!1,u=null==(e=this._particleSystem)?void 0:e._forceOvertimeModule;if(l=!!u&&u.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=l,l){var h=Re(this._forceTexture,this._forceData,Go,u.x,u.y,u.z);this._forceTexture=h.texture,this._forceData=h.texdata;var c=a.getHandle("force_over_time_tex0"),_=_t(c);a.bindSampler(_,this._forceTexture.getGFXSampler()),a.bindTexture(_,this._forceTexture.getGFXTexture());var d=a.getHandle("u_force_space");a.setUniform(d,u.space);var p=a.getHandle("u_force_mode");a.setUniform(p,this._forceTexture.height)}var f=null==(i=this._particleSystem)?void 0:i._velocityOvertimeModule;if(l=!!f&&f.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=l,l){var m=Fe(this._velocityTexture,this._velocityData,Go,f.x,f.y,f.z,f.speedModifier);this._velocityTexture=m.texture,this._velocityData=m.texdata;var v=a.getHandle("velocity_over_time_tex0"),y=_t(v);a.bindSampler(y,this._velocityTexture.getGFXSampler()),a.bindTexture(y,this._velocityTexture.getGFXTexture());var M=a.getHandle("u_velocity_space");a.setUniform(M,f.space);var g=a.getHandle("u_velocity_mode");a.setUniform(g,this._velocityTexture.height)}var S=null==(r=this._particleSystem)?void 0:r._colorOverLifetimeModule;if(l=!!S&&S.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=l,l){var b=ri(this._colorTexture,this._colorData,Go,S.color);this._colorTexture=b.texture,this._colorData=b.texdata;var x=a.getHandle("color_over_time_tex0"),T=_t(x);a.bindSampler(T,this._colorTexture.getGFXSampler()),a.bindTexture(T,this._colorTexture.getGFXTexture());var A=a.getHandle("u_color_mode");a.setUniform(A,this._colorTexture.height)}var w,O=null==(s=this._particleSystem)?void 0:s._rotationOvertimeModule;if(l=!!O&&O.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=l,l&&(w=O.separateAxes?Re(this._rotationTexture,this._rotationData,Go,O.x,O.y,O.z):Ae(this._rotationTexture,this._rotationData,Go,O.z),this._rotationTexture=w.texture,this._rotationData=w.texdata,this._rotationTexture)){var R=a.getHandle("rotation_over_time_tex0"),F=_t(R);a.bindSampler(F,this._rotationTexture.getGFXSampler()),a.bindTexture(F,this._rotationTexture.getGFXTexture());var C=a.getHandle("u_rotation_mode");a.setUniform(C,this._rotationTexture.height)}var E,z=null==(n=this._particleSystem)?void 0:n._sizeOvertimeModule;if(l=!!z&&z.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=l,l&&(E=z.separateAxes?Re(this._sizeTexture,this._sizeData,Go,z.x,z.y,z.z,!0):we(this._sizeTexture,this._sizeData,Go,z.size),this._sizeTexture=E.texture,this._sizeData=E.texdata,this._sizeTexture)){var D=a.getHandle("size_over_time_tex0"),P=_t(D);a.bindSampler(P,this._sizeTexture.getGFXSampler()),a.bindTexture(P,this._sizeTexture.getGFXTexture());var I=a.getHandle("u_size_mode");a.setUniform(I,this._sizeTexture.height)}var B=null==(o=this._particleSystem)?void 0:o._textureAnimationModule;if(l=!!B&&B.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=l,l){var L=Oe(this._animTexture,this._animData,Go,B.startFrame,B.frameOverTime);this._animTexture=L.texture,this._animData=L.texdata;var V=a.getHandle("texture_animation_tex0"),U=_t(V);a.bindSampler(U,this._animTexture.getGFXSampler()),a.bindTexture(U,this._animTexture.getGFXTexture());var k=a.getHandle("u_anim_info");yo.x=this._animTexture.height,yo.y=B.numTilesX*B.numTilesY,yo.z=B.cycleCount,a.setUniform(k,yo)}this._defines.USE_VK_SHADER=gt.gfxDevice.gfxAPI===Ct.VULKAN,this._defines.CC_INSTANCE_PARTICLE=this._useInstance},r.getParticleCount=function(){return this._particleNum},r.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},r.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},r.updateVertexAttrib=function(){if(this._renderInfo.renderMode===ci.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,xt.ATTR_COLOR);if(t){for(var e=Tt.RGBA8,i=0;i<At.length;++i)if(At[i].name===t.name){e=i;break}this._vertAttrs[9]=new bt(xt.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var r=Tt.RGBA8;this._vertAttrs[9]=new bt(xt.ATTR_COLOR1,r,!0,this._useInstance?1:0)}}},r._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case ci.StrecthedBillboard:this._vertAttrs=$o.slice();break;case ci.Mesh:this._vertAttrs=ta.slice();break;default:this._vertAttrs=$o.slice()}},r._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case ci.StrecthedBillboard:this._vertAttrs=ea.slice();break;case ci.Mesh:this._vertAttrs=ia.slice();break;default:this._vertAttrs=ea.slice()}},r.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!==e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(ra.parent=nt.get("default-particle-gpu-material"),ra.owner=t,ra.subModelIdx=0,this._defaultMat=new ct(ra),ra.parent=null,ra.owner=null,ra.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(vo),t.simulationSpace===li.World?this._defines[Ho]=!0:this._defines[Ho]=!1;var r=this._renderInfo.renderMode;r===ci.Billboard?this._defines[Xo]=0:r===ci.StrecthedBillboard?(this._defines[Xo]=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===ci.HorizontalBillboard?this._defines[Xo]=2:r===ci.VerticalBillboard?this._defines[Xo]=3:r===ci.Mesh?this._defines[Xo]=4:h("particle system renderMode "+r+" not support.");var s=t._textureAnimationModule;if(s&&s.enable){var n=i.getProperty("mainTexture",0);n&&n.isAlphaAtlas&&(s.scaleNumTilesXY(2),this._defines.CC_USE_EMBEDDED_ALPHA=!0),V.set(this._frameTile_velLenScale,s.numTilesX,s.numTilesY),x.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)}else this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,x.copy(this._unifrom_velLenScale,this._tmp_velLenScale);this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},r.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},r.getNoisePreview=function(){},i}(Vn);function na(){var t=Pt.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.getFormatFeatures(Tt.RGBA32F)&(Et.RENDER_TARGET|Et.SAMPLED_TEXTURE))||(rt.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var oa,aa,la,ua,ha,ca,_a,da,pa,fa,ma,va,ya,Ma,ga,Sa,ba,xa,Ta,Aa,wa,Oa,Ra,Fa,Ca,Ea,za,Da,Pa,Ia,Ba,La,Va,Ua,ka,Na,Ga,Ha,Xa,Wa,Ya,ja,Za,qa,Qa,Ka,Ja,$a,tl,el,il,rl,sl,nl,ol,al,ll,ul,hl,cl,_l,dl,pl,fl,ml,vl,yl,Ml,gl,Sl,bl,xl,Tl,Al,wl,Ol,Rl,Fl,Cl,El,zl,Dl,Pl,Il,Bl,Ll,Vl,Ul,kl,Nl,Gl,Hl,Xl,Wl,Yl,jl,Zl,ql,Ql,Kl,Jl,$l,tu,eu,iu,ru,su,nu,ou,au,lu,uu,hu,cu,_u,du,pu,fu,mu,vu,yu,Mu,gu,Su,bu,xu,Tu,Au,wu,Ou,Ru,Fu,Cu,Eu,zu,Du,Pu,Iu,Bu,Lu,Vu,Uu,ku,Nu,Gu,Hu=(So=S("cc.ParticleSystemRenderer"),bo=b(ci),xo=b(ci),To=b(Bt),Ao=b(st),wo=b(st),Oo=b(st),Ro=b(st),Fo=b(hi),So((No=function(){function t(){this._renderMode=zo&&zo(),this._velocityScale=Do&&Do(),this._lengthScale=Po&&Po(),this._mesh=Io&&Io(),this._cpuMaterial=Bo&&Bo(),this._gpuMaterial=Lo&&Lo(),this._mainTexture=Vo&&Vo(),this._useGPU=Uo&&Uo(),this._alignSpace=ko&&ko(),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&_(6033)},e.onInit=function(t){this.create(t);var e=this._useGPU&&na();this._particleSystem.processor?_(6034):(this._particleSystem.processor=e?new sa(this):new fo(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)),e?this.gpuMaterial=this.particleMaterial:(this.particleMaterial&&-1!==this.particleMaterial.effectName.indexOf("particle-gpu")&&(this.particleMaterial=null,d(6035)),this.cpuMaterial=this.particleMaterial)},e._switchProcessor=function(){if(this._particleSystem){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null);var t=this._useGPU&&na();this.particleMaterial=t?this.gpuMaterial:this.cpuMaterial,this._particleSystem.processor=t?new sa(this):new fo(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},i(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,0)}},{key:"cpuMaterial",get:function(){return this._cpuMaterial},set:function(t){if(t){var e=t.effectName;if(-1===e.indexOf("particle")||-1!==e.indexOf("particle-gpu"))return void d(6035)}this._cpuMaterial=t,this.particleMaterial=this._cpuMaterial}},{key:"gpuMaterial",get:function(){return this._gpuMaterial},set:function(t){t&&-1===t.effectName.indexOf("particle-gpu")?d(6035):(this._gpuMaterial=t,this.particleMaterial=this._gpuMaterial)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(na()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}(),No.AlignmentSpace=hi,r((Eo=No).prototype,"renderMode",[bo],Object.getOwnPropertyDescriptor(Eo.prototype,"renderMode"),Eo.prototype),zo=A(Eo.prototype,"_renderMode",[xo,R],(function(){return ci.Billboard})),Do=A(Eo.prototype,"_velocityScale",[R],(function(){return 1})),Po=A(Eo.prototype,"_lengthScale",[R],(function(){return 1})),Io=A(Eo.prototype,"_mesh",[R],(function(){return null})),r(Eo.prototype,"mesh",[To],Object.getOwnPropertyDescriptor(Eo.prototype,"mesh"),Eo.prototype),r(Eo.prototype,"particleMaterial",[Ao],Object.getOwnPropertyDescriptor(Eo.prototype,"particleMaterial"),Eo.prototype),r(Eo.prototype,"cpuMaterial",[wo],Object.getOwnPropertyDescriptor(Eo.prototype,"cpuMaterial"),Eo.prototype),Bo=A(Eo.prototype,"_cpuMaterial",[R],(function(){return null})),r(Eo.prototype,"gpuMaterial",[Oo],Object.getOwnPropertyDescriptor(Eo.prototype,"gpuMaterial"),Eo.prototype),Lo=A(Eo.prototype,"_gpuMaterial",[R],(function(){return null})),r(Eo.prototype,"trailMaterial",[Ro],Object.getOwnPropertyDescriptor(Eo.prototype,"trailMaterial"),Eo.prototype),Vo=A(Eo.prototype,"_mainTexture",[R],(function(){return null})),Uo=A(Eo.prototype,"_useGPU",[R],(function(){return!1})),r(Eo.prototype,"alignSpace",[Fo],Object.getOwnPropertyDescriptor(Eo.prototype,"alignSpace"),Eo.prototype),ko=A(Eo.prototype,"_alignSpace",[R],(function(){return hi.View})),Co=Eo))||Co),Xu=Math.cos(O(100)),Wu={position:new F,velocity:new F},Yu=new U,ju=new F,Zu=new F,qu=new T,Qu=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new F,lifetime:0,width:0,velocity:new F,direction:0,color:new T})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new F,lifetime:0,width:0,velocity:new F,direction:0,color:new T}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,r){for(var s=this.start>=this.end?this.end+this.trailElements.length:this.end,n=this.start;n<s;n++)e(t,this.trailElements[n%this.trailElements.length],i,r)&&(this.start++,this.start%=this.trailElements.length);this.start===s&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),Ku=(oa=S("cc.TrailModule"),aa=b(fi),la=b(ge),ua=b(li),ha=b(mi),ca=b(ge),_a=b(ti),da=b(ti),pa=b(li),oa((ma=function(){var t=e.prototype;function e(){this._enable=va&&va(),this.mode=ya&&ya(),this.lifeTime=Ma&&Ma(),this._minParticleDistance=ga&&ga(),this.existWithParticles=Sa&&Sa(),this.textureMode=ba&&ba(),this.widthFromParticle=xa&&xa(),this.widthRatio=Ta&&Ta(),this.colorFromParticle=Aa&&Aa(),this.colorOverTrail=wa&&wa(),this.colorOvertime=Oa&&Oa(),this._space=Ra&&Ra(),this._particleSystem=Fa&&Fa(),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._psTransform=new k,this._iaVertCount=0,this._iaIndexCount=0,this._vertAttrs=[new bt(xt.ATTR_POSITION,Tt.RGB32F),new bt(xt.ATTR_TEX_COORD,Tt.RGBA32F),new bt(xt.ATTR_TEX_COORD1,Tt.RGB32F),new bt(xt.ATTR_COLOR,Tt.RGBA8,!0)],this._vertSize=this._vertAttrs.reduce((function(t,e){return t+At[e.format].size}),0),this._particleTrail=new Map,this._inited=!1}return t.getModel=function(){return this._trailModel},t.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),r=t.rateOverTime.getMax(),s=t.duration,n=0,o=t.bursts.length;n<o;n++)e+=t.bursts[n].getMaxCount(t)*Math.ceil(i/s);this.lifeTime.getMax()<1&&d(6036),this._trailNum=Math.ceil(i*Math.ceil(this.lifeTime.getMax())*60*(r*s+e)),this._trailSegments=new p((function(){return new Qu(10)}),Math.ceil(r*s),(function(t){t.trailElements.length=0})),this._enable&&(this.enable=this._enable),this._inited=!0},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(Pt.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor.getDefaultTrailMaterial(),this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem.time,1),this.space===li.World&&this._particleSystem.simulationSpace===li.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(this._psTransform),this._particleSystem.node.getWorldRotation(Yu)):this._needTransform=!1},t.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var r=i.getElement(i.end-1);if(this._needTransform?F.transformMat4(ju,t.position,this._psTransform):F.copy(ju,t.position),!(r&&(i.iterateElement(this,this._updateTrailElement,t,e),F.squaredDistance(r.position,ju)<this._minSquaredDistance))&&(r=i.addElement())){F.copy(r.position,ju),r.lifetime=0,this.widthFromParticle?r.width=t.size.x*this.widthRatio.evaluate(0,1):r.width=this.widthRatio.evaluate(0,1);var s=i.count();if(2===s){var n=i.getElement(i.end-2);F.subtract(n.velocity,r.position,n.position)}else if(s>2){var o=i.getElement(i.end-2),a=i.getElement(i.end-3);F.subtract(ju,a.position,o.position),F.subtract(Zu,r.position,o.position),F.subtract(o.velocity,Zu,ju),F.equals(F.ZERO,o.velocity)&&F.copy(o.velocity,ju),F.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,a)}this.colorFromParticle?r.color.set(t.color):r.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=s(this._particleTrail.keys());!(t=e()).done;){var i=t.value,r=this._particleTrail.get(i);if(-1!==r.start){var n=4*this.vbOffset/this._vertSize,o=r.start>=r.end?r.end+r.trailElements.length:r.end,a=o-r.start,l=1/a,u=r.trailElements[r.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),n,1,0,4);for(var h=r.start+1;h<o;h++){var c=r.trailElements[h%r.trailElements.length],_=h-r.start;this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1-_/a,1),n,1-_*l,_,5)}this._needTransform?F.transformMat4(Wu.position,i.position,this._psTransform):F.copy(Wu.position,i.position);var d=this._trailModel;if(d&&d.node.invalidateChildren(dt.POSITION),1===a||2===a){var p=r.getElement(r.end-1);F.subtract(p.velocity,Wu.position,p.position);var f=this._vbF32,m=this.vbOffset,v=this._vertSize/4,y=p.velocity;f[m-v-4]=y.x,f[m-v-3]=y.y,f[m-v-2]=y.z,f[m-4]=y.x,f[m-3]=y.y,f[m-2]=y.z,F.subtract(Wu.velocity,Wu.position,p.position),this._checkDirectionReverse(Wu,p)}else if(a>2){var M=r.getElement(r.end-1),g=r.getElement(r.end-2);F.subtract(ju,g.position,M.position),F.subtract(Zu,Wu.position,M.position),F.normalize(ju,ju),F.normalize(Zu,Zu),F.subtract(M.velocity,Zu,ju),F.normalize(M.velocity,M.velocity),this._checkDirectionReverse(M,g),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(M,this.colorOverTrail.evaluate(l,1),n,l,a-1,5),F.subtract(Wu.velocity,Wu.position,M.position),F.normalize(Wu.velocity,Wu.velocity),this._checkDirectionReverse(Wu,M)}this.widthFromParticle?Wu.width=i.size.x*this.widthRatio.evaluate(0,1):Wu.width=this.widthRatio.evaluate(0,1),Wu.color=i.color,F.equals(Wu.velocity,F.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Wu,this.colorOverTrail.evaluate(0,1),n,0,a,1)}}this._trailModel&&(this._trailModel.enabled=this.ibOffset>0)},t.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),i.inputAssembler.firstIndex=0,i.inputAssembler.indexCount=t,i.inputAssembler.vertexCount=this._iaVertCount}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=rt.director.root.createModel(mt))},t.rebuild=function(){var t=this,e=Pt.root.device,i=e.createBuffer(new wt(Ot.VERTEX|Ot.TRANSFER_DST,Rt.HOST|Rt.DEVICE,t._vertSize*(t._trailNum+1)*2,t._vertSize)),r=new ArrayBuffer(t._vertSize*(t._trailNum+1)*2);t._vbF32=new Float32Array(r),t._vbUint32=new Uint32Array(r),i.update(r);var s=e.createBuffer(new wt(Ot.INDEX|Ot.TRANSFER_DST,Rt.HOST|Rt.DEVICE,6*Math.max(1,t._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));t._iBuffer=new Uint16Array(6*Math.max(1,t._trailNum)),s.update(t._iBuffer),t._iaVertCount=2*(t._trailNum+1),t._iaIndexCount=6*t._trailNum,t._subMeshData=new Mt([i],t._vertAttrs,St.TRIANGLE_LIST,s);var n=t._trailModel;n&&t._material&&(n.node=n.transform=t._particleSystem.node,n.visFlags=t._particleSystem.visibility,n.initSubModel(0,t._subMeshData,t._material),n.enabled=!0)},t._updateTrailElement=function(t,e,i,r){return e.lifetime+=r,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},t._fillVertexBuffer=function(t,e,i,r,s,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,qu.set(t.color),qu.multiply(e),this._vbUint32[this.vbOffset++]=T.toUint32(qu),this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=T.toUint32(qu),1&n&&(this._iBuffer[this.ibOffset++]=i+2*s,this._iBuffer[this.ibOffset++]=i+2*s-1,this._iBuffer[this.ibOffset++]=i+2*s+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*s,this._iBuffer[this.ibOffset++]=i+2*s+1,this._iBuffer[this.ibOffset++]=i+2*s+2)},t._checkDirectionReverse=function(t,e){F.dot(t.velocity,e.velocity)<Xu?t.direction=1-e.direction:t.direction=e.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},i(e,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}},{key:"inited",get:function(){return this._inited}}]),e}(),va=A(ma.prototype,"_enable",[R],(function(){return!1})),ya=A(ma.prototype,"mode",[aa,R],(function(){return fi.Particles})),Ma=A(ma.prototype,"lifeTime",[la,R],(function(){return new ge})),ga=A(ma.prototype,"_minParticleDistance",[R],(function(){return.1})),r(ma.prototype,"space",[ua],Object.getOwnPropertyDescriptor(ma.prototype,"space"),ma.prototype),Sa=A(ma.prototype,"existWithParticles",[R],(function(){return!0})),ba=A(ma.prototype,"textureMode",[ha,R],(function(){return mi.Stretch})),xa=A(ma.prototype,"widthFromParticle",[R],(function(){return!0})),Ta=A(ma.prototype,"widthRatio",[ca,R],(function(){return new ge})),Aa=A(ma.prototype,"colorFromParticle",[R],(function(){return!1})),wa=A(ma.prototype,"colorOverTrail",[_a,R],(function(){return new ti})),Oa=A(ma.prototype,"colorOvertime",[da,R],(function(){return new ti})),Ra=A(ma.prototype,"_space",[pa],(function(){return li.World})),Fa=A(ma.prototype,"_particleSystem",[R],(function(){return null})),fa=ma))||fa),Ju=new k,$u=new k,th=new U,eh=new F,ih=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],rh=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=[],this._localMat=new k,this._gravity=new x,this.minPos=new F,this.maxPos=new F,this._nodePos=new F,this._nodeSize=new F,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;ih.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&t._updateList.set(i.name,i),i.needAnimate&&t._animateList.set(i.name,i))})),this._runAnimateList.length=0;for(var e=0,i=Mi.length;e<i;e++){var r=this._animateList.get(Mi[e]);r&&this._runAnimateList.push(r)}},e._emit=function(t,e,i){var r=this._particleSystem,s=this._node,n=r.time%r.duration/r.duration;s.invalidateChildren(dt.POSITION),r.simulationSpace===li.World&&(s.getWorldMatrix(Ju),s.getWorldRotation(th));for(var o=0;o<t;++o){var a=new ai(r);a.particleSystem=r,a.reset();var l=X(H(0,f));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(a):(F.set(a.position,0,0,0),F.copy(a.velocity,Ri)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(a);var u=r.startSpeed.evaluate(n,l);F.multiplyScalar(a.velocity,a.velocity,u),r.simulationSpace===li.World&&(F.transformMat4(a.position,a.position,Ju),F.transformQuat(a.velocity,a.velocity,th)),F.copy(a.ultimateVelocity,a.velocity),F.set(a.rotation,0,0,0),r.startSize3D?F.set(a.startSize,r.startSizeX.evaluate(n,l),r.startSizeY.evaluate(n,l),r.startSizeZ.evaluate(n,l)):(F.set(a.startSize,r.startSizeX.evaluate(n,l),1,1),a.startSize.y=a.startSize.x),F.copy(a.size,a.startSize),a.startLifetime=r.startLifetime.evaluate(n,l)+e,a.remainingLifetime=a.startLifetime,i.push(a)}},e._updateParticles=function(t,e){var i=this,r=this._particleSystem;switch(r.node.getWorldMatrix(Ju),r.scaleSpace){case li.Local:r.node.getScale(eh);break;case li.World:r.node.getWorldScale(eh)}if(this._updateList.forEach((function(){})),r.simulationSpace===li.Local){var s=r.node.getRotation();k.fromQuat(this._localMat,s),this._localMat.transpose()}r.node.parent&&(r.node.parent.getWorldMatrix($u),$u.invert());for(var n=function(){var s=e[o];if(s.remainingLifetime-=t,F.set(s.animatedVelocity,0,0,0),r.gravityModifier.mode!==Me.Constant||0!==r.gravityModifier.constant){var n=Bi(r.gravityModifier)?X(s.randomSeed):0;if(r.simulationSpace===li.Local){var a=9.8*-r.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,n)*t;i._gravity.x=0,i._gravity.y=a,i._gravity.z=0,i._gravity.w=1,E(a,0,P)||(r.node.parent&&(i._gravity=i._gravity.transformMat4($u)),i._gravity=i._gravity.transformMat4(i._localMat),s.velocity.x+=i._gravity.x,s.velocity.y+=i._gravity.y,s.velocity.z+=i._gravity.z)}else s.velocity.y-=9.8*r.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,n)*t}F.copy(s.ultimateVelocity,s.velocity),i._runAnimateList.forEach((function(e){e.animate(s,t)})),F.scaleAndAdd(s.position,s.position,s.ultimateVelocity,t)},o=0;o<e.length;++o)n()},e._calculateBounding=function(t){var e=new F,i=new F,r=new F,s=new F,n=new F(1,1,1);if(this._processor.getInfo().renderMode===ci.Mesh){var o=this._processor.getInfo().mesh;if(o&&o.struct.minPosition&&o.struct.maxPosition){var a=new Q;Q.fromPoints(a,o.struct.minPosition,o.struct.maxPosition);var l=Math.max(a.halfExtents.x,a.halfExtents.y,a.halfExtents.z);n.set(l,l,l)}}for(var u=this._particleSystem.node.worldMatrix,h=0;h<this._particlesAll.length;++h){var c=this._particlesAll[h];F.multiply(e,eh,c.size),F.multiply(e,e,n),i.set(c.position),this._particleSystem.simulationSpace!==li.World&&F.transformMat4(i,i,u),t&&0===h?(F.subtract(this.minPos,i,e),F.add(this.maxPos,i,e)):(F.subtract(r,i,e),F.add(s,i,e),F.min(this.minPos,this.minPos,r),F.max(this.maxPos,this.maxPos,s))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=Bi(this._particleSystem.startLifetime)?X(H(0,f)):0;this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),sh=R,nh=b,oh=(Ca=S("cc.NoiseModule"),Ea=nh(m),za=nh(m),Da=nh(m),Pa=nh(m),Ia=nh(m),Ba=nh(m),La=nh(m),Va=nh(m),Ua=nh(m),ka=nh(m),Na=nh(v),Ga=nh(m),Ha=nh(m),Ca((Wa=function(t){function r(){var e;return(e=t.call(this)||this)._enable=Ya&&Ya(),e._strengthX=ja&&ja(),e._strengthY=Za&&Za(),e._strengthZ=qa&&qa(),e._noiseSpeedX=Qa&&Qa(),e._noiseSpeedY=Ka&&Ka(),e._noiseSpeedZ=Ja&&Ja(),e._noiseFrequency=$a&&$a(),e._remapX=tl&&tl(),e._remapY=el&&el(),e._remapZ=il&&il(),e._octaves=rl&&rl(),e._octaveMultiplier=sl&&sl(),e._octaveScale=nl&&nl(),e.name=yi,e.noise=new Un,e.samplePosition=new F,e}e(r,t);var s=r.prototype;return s.animate=function(t,e){this.noise.setTime(t.particleSystem.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.samplePosition.set(t.position),this.samplePosition.add3f(1*G(),1*G(),1*G()),this.noise.setSamplePoint(this.samplePosition),this.noise.getNoiseParticle();var i=this.noise.getResult();i.multiply3f(G(),G(),G()),F.add(t.position,t.position,i.multiplyScalar(e))},s.getNoisePreview=function(t,e,i,r){this.noise.setTime(e.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.noise.getNoiseParticle(),this.noise.getPreview(t,i,r)},i(r,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"strengthX",get:function(){return this._strengthX},set:function(t){this._strengthX=t}},{key:"strengthY",get:function(){return this._strengthY},set:function(t){this._strengthY=t}},{key:"strengthZ",get:function(){return this._strengthZ},set:function(t){this._strengthZ=t}},{key:"noiseSpeedX",get:function(){return this._noiseSpeedX},set:function(t){this._noiseSpeedX=t}},{key:"noiseSpeedY",get:function(){return this._noiseSpeedY},set:function(t){this._noiseSpeedY=t}},{key:"noiseSpeedZ",get:function(){return this._noiseSpeedZ},set:function(t){this._noiseSpeedZ=t}},{key:"noiseFrequency",get:function(){return this._noiseFrequency},set:function(t){this._noiseFrequency=t}},{key:"remapX",get:function(){return this._remapX},set:function(t){this._remapX=t}},{key:"remapY",get:function(){return this._remapY},set:function(t){this._remapY=t}},{key:"remapZ",get:function(){return this._remapZ},set:function(t){this._remapZ=t}},{key:"octaves",get:function(){return this._octaves},set:function(t){this._octaves=t}},{key:"octaveMultiplier",get:function(){return this._octaveMultiplier},set:function(t){this._octaveMultiplier=t}},{key:"octaveScale",get:function(){return this._octaveScale},set:function(t){this._octaveScale=t}}]),r}(Si),Ya=A(Wa.prototype,"_enable",[sh],(function(){return!1})),r(Wa.prototype,"strengthX",[Ea],Object.getOwnPropertyDescriptor(Wa.prototype,"strengthX"),Wa.prototype),ja=A(Wa.prototype,"_strengthX",[sh],(function(){return 10})),r(Wa.prototype,"strengthY",[za],Object.getOwnPropertyDescriptor(Wa.prototype,"strengthY"),Wa.prototype),Za=A(Wa.prototype,"_strengthY",[sh],(function(){return 10})),r(Wa.prototype,"strengthZ",[Da],Object.getOwnPropertyDescriptor(Wa.prototype,"strengthZ"),Wa.prototype),qa=A(Wa.prototype,"_strengthZ",[sh],(function(){return 10})),r(Wa.prototype,"noiseSpeedX",[Pa],Object.getOwnPropertyDescriptor(Wa.prototype,"noiseSpeedX"),Wa.prototype),Qa=A(Wa.prototype,"_noiseSpeedX",[sh],(function(){return 0})),r(Wa.prototype,"noiseSpeedY",[Ia],Object.getOwnPropertyDescriptor(Wa.prototype,"noiseSpeedY"),Wa.prototype),Ka=A(Wa.prototype,"_noiseSpeedY",[sh],(function(){return 0})),r(Wa.prototype,"noiseSpeedZ",[Ba],Object.getOwnPropertyDescriptor(Wa.prototype,"noiseSpeedZ"),Wa.prototype),Ja=A(Wa.prototype,"_noiseSpeedZ",[sh],(function(){return 0})),r(Wa.prototype,"noiseFrequency",[La],Object.getOwnPropertyDescriptor(Wa.prototype,"noiseFrequency"),Wa.prototype),$a=A(Wa.prototype,"_noiseFrequency",[sh],(function(){return 1})),r(Wa.prototype,"remapX",[Va],Object.getOwnPropertyDescriptor(Wa.prototype,"remapX"),Wa.prototype),tl=A(Wa.prototype,"_remapX",[sh],(function(){return 0})),r(Wa.prototype,"remapY",[Ua],Object.getOwnPropertyDescriptor(Wa.prototype,"remapY"),Wa.prototype),el=A(Wa.prototype,"_remapY",[sh],(function(){return 0})),r(Wa.prototype,"remapZ",[ka],Object.getOwnPropertyDescriptor(Wa.prototype,"remapZ"),Wa.prototype),il=A(Wa.prototype,"_remapZ",[sh],(function(){return 0})),r(Wa.prototype,"octaves",[Na],Object.getOwnPropertyDescriptor(Wa.prototype,"octaves"),Wa.prototype),rl=A(Wa.prototype,"_octaves",[sh],(function(){return 1})),r(Wa.prototype,"octaveMultiplier",[Ga],Object.getOwnPropertyDescriptor(Wa.prototype,"octaveMultiplier"),Wa.prototype),sl=A(Wa.prototype,"_octaveMultiplier",[sh],(function(){return.5})),r(Wa.prototype,"octaveScale",[Ha],Object.getOwnPropertyDescriptor(Wa.prototype,"octaveScale"),Wa.prototype),nl=A(Wa.prototype,"_octaveScale",[sh],(function(){return 2})),Xa=Wa))||Xa),ah=new k,lh=new U,uh=Object.getOwnPropertyDescriptor(Dt.prototype,"sharedMaterials"),hh=(ol=S("cc.ParticleSystem"),al=J(99),ll=b(ti),ul=b(li),hl=Y("startSize"),cl=b(ge),_l=b(ge),dl=b(ge),pl=b(ge),fl=b(ge),ml=b(ge),vl=b(ge),yl=Y("startRotation"),Ml=b(ge),gl=b(ge),Sl=b(li),bl=b(ge),xl=b(ge),Tl=b(ge),Al=b([An]),wl=b(y),Ol=b(ui),Rl=b(m),Fl=b(m),Cl=b(m),El=Y("enableCulling"),zl=b(Tr),Dl=b(Tr),Pl=b(Fn),Il=b(Fn),Bl=b(fn),Ll=b(fn),Vl=b(Tn),Ul=b(Tn),kl=b(Or),Nl=b(Or),Gl=b(Er),Hl=b(Er),Xl=b(dn),Wl=b(dn),Yl=b(Mn),jl=b(Mn),Zl=b(oh),ql=b(oh),Ql=b(Ku),Kl=b(Ku),Jl=b(Hu),ol($l=al((Gu=function(t){function r(){var e;(e=t.call(this)||this).startColor=eu&&eu(),e.scaleSpace=iu&&iu(),e.startSize3D=ru&&ru(),e.startSizeX=su&&su(),e.startSizeY=nu&&nu(),e.startSizeZ=ou&&ou(),e.startSpeed=au&&au(),e.startRotation3D=lu&&lu(),e.startRotationX=uu&&uu(),e.startRotationY=hu&&hu(),e.startRotationZ=cu&&cu(),e.startDelay=_u&&_u(),e.startLifetime=du&&du(),e.duration=pu&&pu(),e.loop=fu&&fu(),e.simulationSpeed=mu&&mu(),e.playOnAwake=vu&&vu(),e.gravityModifier=yu&&yu(),e.rateOverTime=Mu&&Mu(),e.rateOverDistance=gu&&gu(),e.bursts=Su&&Su(),e._renderCulling=bu&&bu(),e._cullingMode=xu&&xu(),e._aabbHalfX=Tu&&Tu(),e._aabbHalfY=Au&&Au(),e._aabbHalfZ=wu&&wu(),e._dataCulling=Ou&&Ou(),e._colorOverLifetimeModule=Ru&&Ru(),e._shapeModule=Fu&&Fu(),e._sizeOvertimeModule=Cu&&Cu(),e._velocityOvertimeModule=Eu&&Eu(),e._forceOvertimeModule=zu&&zu(),e._limitVelocityOvertimeModule=Du&&Du(),e._rotationOvertimeModule=Pu&&Pu(),e._textureAnimationModule=Iu&&Iu(),e._noiseModule=Bu&&Bu(),e._trailModule=Lu&&Lu(),e.renderer=Vu&&Vu(),e._prewarm=Uu&&Uu(),e._capacity=ku&&ku(),e._simulationSpace=Nu&&Nu(),e.processor=null;var i=M(e);return i.rateOverTime.constant=10,i.startLifetime.constant=5,i.startSizeX.constant=1,i.startSpeed.constant=5,i._isPlaying=!1,i._isPaused=!1,i._isStopped=!0,i._isEmitting=!1,i._needToRestart=!1,i._needRefresh=!0,i._needAttach=!1,i._time=0,i._emitRateTimeCounter=0,i._emitRateDistanceCounter=0,i._oldWPos=new F,i._curWPos=new F,i._boundingBox=null,i._culler=null,i._oldPos=null,i._curPos=null,i._isCulled=!1,i._isSimulating=!0,i._customData1=new V,i._customData2=new V,i._subEmitters=[],e}e(r,t);var n=r.prototype;return n.onFocusInEditor=function(){this.renderer.create(this)},n.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&!this.renderer.useGPU&&this._trailModule.enable&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},n._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},n._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},n._collectModels=function(){return this._models.length=0,this._models.push(this.processor.model),this._trailModule&&this._trailModule.enable&&this._trailModule.getModel()&&this._models.push(this._trailModule.getModel()),this._models},n._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},n._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor),this._noiseModule&&this._noiseModule.bindTarget(this.processor)},n.play=function(){if(this._needToRestart&&(this.reset(),this._needToRestart=!1),this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},n.pause=function(){this._isStopped?h("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},n.stopEmitting=function(){this._isEmitting=!1,this._needToRestart=!0},n.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._isEmitting&&(this._isEmitting=!1),this._isStopped=!0,this._needRefresh=!0,this.reset()},n.reset=function(){this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._resetPosition(),this.bursts.forEach((function(t){t.reset()}))},n.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},n.getParticleCount=function(){return this.processor?this.processor.getParticleCount():0},n.setCustomData1=function(t,e){V.set(this._customData1,t,e)},n.setCustomData2=function(t,e){V.set(this._customData2,t,e)},n.onDestroy=function(){var t;this.stop(),null!=(t=this.processor.getModel())&&t.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()),Pt.off(It.BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.onEnable=function(){t.prototype.onEnable.call(this),Pt.on(It.BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&!it&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},n.onDisable=function(){Pt.off(It.BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._oldPos=null,this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n._calculateBounding=function(t){var e=this;e._boundingBox&&(e._culler||(e._culler=new rh(e)),e._culler.calculatePositions(),Q.fromPoints(e._boundingBox,e._culler.minPos,e._culler.maxPos),t?(e.aabbHalfX=e._boundingBox.halfExtents.x,e.aabbHalfY=e._boundingBox.halfExtents.y,e.aabbHalfZ=e._boundingBox.halfExtents.z):(e.aabbHalfX?e.setBoundingX(e.aabbHalfX):e.aabbHalfX=e._boundingBox.halfExtents.x,e.aabbHalfY?e.setBoundingY(e.aabbHalfY):e.aabbHalfY=e._boundingBox.halfExtents.y,e.aabbHalfZ?e.setBoundingZ(e.aabbHalfZ):e.aabbHalfZ=e._boundingBox.halfExtents.z),e._culler.clear())},n.update=function(t){var e,i,r=this,s=r.processor,n=r.trailModule,o=t*r.simulationSpeed;if(r.renderCulling){r._boundingBox||(r._boundingBox=new Q,r._calculateBounding(!1)),r._curPos||(r._curPos=new F),r.node.getWorldPosition(r._curPos),r._oldPos||(r._oldPos=new F,r._oldPos.set(r._curPos));var a=r._curPos,l=r._oldPos;if(!a.equals(l)&&r._boundingBox&&r._culler){var u=a.x-l.x,h=a.y-l.y,c=a.z-l.z,_=r._boundingBox.center;_.x+=u,_.y+=h,_.z+=c,r._culler.setBoundingBoxCenter(_.x,_.y,_.z),l.set(a)}var d=r.node.scene.renderScene,p=d?d.cameras:void 0,f=!0;if(void 0!==p&&r._boundingBox)for(var m=0;m<p.length;++m){var v=p[m];if((v.visibility&r.node.layer)===r.node.layer&&K.aabbFrustum(r._boundingBox,v.frustum)){f=!1;break}}if(f){if(r._cullingMode!==ui.AlwaysSimulate&&(r._isSimulating=!1),r._isCulled||(s.detachFromScene(),r._isCulled=!0),n&&n.enable&&n._detachFromScene(),r._cullingMode===ui.PauseAndCatchup&&(r._time+=o),r._cullingMode!==ui.AlwaysSimulate)return}else r._isCulled&&(r._attachToScene(),r._isCulled=!1),r._isSimulating||(r._isSimulating=!0);if(!r._isSimulating)return}else r._boundingBox&&(r._boundingBox=null),r._culler&&(r._culler.clear(),r._culler.destroy(),r._culler=null),r._isSimulating=!0;if(r._isPlaying)r._time+=o,r._emit(o),0!==s.updateParticles(o)||r._isEmitting||r.stop();else{var y=(r.getMaterialInstance(0)||s.getDefaultMaterial()).passes[0];s.updateRotation(y),s.updateScale(y)}r._needAttach&&r.getParticleCount()>0&&!r._isCulled&&(null!=(e=s.getModel())&&e.scene||s.attachToScene(),n&&n.enable&&(null!=(i=n.getModel())&&i.scene||n._attachToScene()),r._needAttach=!1);!r.renderer.useGPU&&n&&n.enable&&(n.inited||(n.clear(),n.destroy(),n.onInit(this),n.enable=!1,n.enable=!0))},n.beforeRender=function(){var t,e,i=this,r=i.processor,s=i.trailModule;i.getParticleCount()<=0?null!=(e=r.getModel())&&e.scene&&(r.detachFromScene(),s&&s.enable&&s._detachFromScene(),i._needAttach=!1):null!=(t=r.getModel())&&t.scene||(i._needAttach=!0),i._isPlaying&&(r.updateRenderData(),r.beforeRender(),s&&s.enable&&(s.updateRenderData(),s.beforeRender()))},n._onVisibilityChange=function(t){this.processor.model&&(this.processor.model.visFlags=t)},n.emit=function(t,e){var i=this,r=i.node,s=i._time%i.duration/i.duration;i._needRefresh&&(r.invalidateChildren(dt.POSITION),i._needRefresh=!1),i._simulationSpace===li.World&&(r.getWorldMatrix(ah),r.getWorldRotation(lh));for(var n=0;n<t;++n){var o=i.processor.getFreeParticle();if(null===o)return;o.particleSystem=i,o.reset();var a=X(H(0,f));i._shapeModule&&i._shapeModule.enable?i._shapeModule.emit(o):(F.set(o.position,0,0,0),F.copy(o.velocity,Ri)),i._textureAnimationModule&&i._textureAnimationModule.enable&&i._textureAnimationModule.init(o);var l=i.startSpeed.evaluate(s,a);F.multiplyScalar(o.velocity,o.velocity,l),i._simulationSpace===li.World&&(F.transformMat4(o.position,o.position,ah),F.transformQuat(o.velocity,o.velocity,lh)),F.copy(o.ultimateVelocity,o.velocity),i.startRotation3D?o.startEuler.set(i.startRotationX.evaluate(s,a),i.startRotationY.evaluate(s,a),i.startRotationZ.evaluate(s,a)):o.startEuler.set(0,0,i.startRotationZ.evaluate(s,a)),o.rotation.set(o.startEuler),i.startSize3D?F.set(o.startSize,i.startSizeX.evaluate(s,a),i.startSizeY.evaluate(s,a),i.startSizeZ.evaluate(s,a)):(F.set(o.startSize,i.startSizeX.evaluate(s,a),1,1),o.startSize.y=o.startSize.x),F.copy(o.size,o.startSize),o.startColor.set(i.startColor.evaluate(s,a)),o.color.set(o.startColor),o.startLifetime=i.startLifetime.evaluate(s,a)+e,o.remainingLifetime=o.startLifetime,o.randomSeed=H(0,233280),o.loopCount++,i.processor.setNewParticle(o)}},n._prewarmSystem=function(){this.startDelay.mode=Me.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},n._emit=function(t){var e=this,i=e.startDelay.evaluate(0,1);if(e._time>i){if(e._time>e.duration+i&&(e.loop||(e._isEmitting=!1)),!e._isEmitting)return;if(e._emitRateTimeCounter+=e.rateOverTime.evaluate(e._time/e.duration,1)*t,e._emitRateTimeCounter>1){var r=Math.floor(e._emitRateTimeCounter);e._emitRateTimeCounter-=r,e.emit(r,t)}var n=e.rateOverDistance.evaluate(e._time/e.duration,1);if(n>0){F.copy(e._oldWPos,e._curWPos),e.node.getWorldPosition(e._curWPos);var o=F.distance(e._curWPos,e._oldWPos);e._emitRateDistanceCounter+=o*n}if(e._emitRateDistanceCounter>1){var a=Math.floor(e._emitRateDistanceCounter);e._emitRateDistanceCounter-=a,e.emit(a,t)}for(var l,u=s(e.bursts);!(l=u()).done;)l.value.update(e,t)}},n._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),F.copy(this._curWPos,this._oldWPos)},n.addSubEmitter=function(t){this._subEmitters.push(t)},n.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},n.addBurst=function(t){this.bursts.push(t)},n.removeBurst=function(t){var e=this.bursts.indexOf(t);e>-1&&this.bursts.splice(e,1)},n.getBoundingX=function(){return this._aabbHalfX},n.getBoundingY=function(){return this._aabbHalfY},n.getBoundingZ=function(){return this._aabbHalfZ},n.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},n.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},n.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},n._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!gi.includes(t)||e[t]&&e[t].enable})):t},n.getNoisePreview=function(t,e){var i=[];return this.processor&&this.processor.getNoisePreview(i,t,e),i},i(r,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor.model&&this.processor.model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new Q,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return uh.get.call(this)},set:function(t){uh.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"noiseModule",get:function(){return this._noiseModule},set:function(t){t&&(this._noiseModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),r}(zt),Gu.CullingMode=ui,eu=A((tu=Gu).prototype,"startColor",[ll,R],(function(){return new ti})),iu=A(tu.prototype,"scaleSpace",[ul,R],(function(){return li.Local})),ru=A(tu.prototype,"startSize3D",[R],(function(){return!1})),su=A(tu.prototype,"startSizeX",[hl,cl],(function(){return new ge})),nu=A(tu.prototype,"startSizeY",[_l,R],(function(){return new ge})),ou=A(tu.prototype,"startSizeZ",[dl,R],(function(){return new ge})),au=A(tu.prototype,"startSpeed",[pl,R],(function(){return new ge})),lu=A(tu.prototype,"startRotation3D",[R],(function(){return!1})),uu=A(tu.prototype,"startRotationX",[fl,R],(function(){return new ge})),hu=A(tu.prototype,"startRotationY",[ml,R],(function(){return new ge})),cu=A(tu.prototype,"startRotationZ",[vl,yl],(function(){return new ge})),_u=A(tu.prototype,"startDelay",[Ml,R],(function(){return new ge})),du=A(tu.prototype,"startLifetime",[gl,R],(function(){return new ge})),pu=A(tu.prototype,"duration",[R],(function(){return 5})),fu=A(tu.prototype,"loop",[R],(function(){return!0})),r(tu.prototype,"simulationSpace",[Sl,R],Object.getOwnPropertyDescriptor(tu.prototype,"simulationSpace"),tu.prototype),mu=A(tu.prototype,"simulationSpeed",[R],(function(){return 1})),vu=A(tu.prototype,"playOnAwake",[R],(function(){return!0})),yu=A(tu.prototype,"gravityModifier",[bl,R],(function(){return new ge})),Mu=A(tu.prototype,"rateOverTime",[xl,R],(function(){return new ge})),gu=A(tu.prototype,"rateOverDistance",[Tl,R],(function(){return new ge})),Su=A(tu.prototype,"bursts",[Al,R],(function(){return[]})),r(tu.prototype,"renderCulling",[wl],Object.getOwnPropertyDescriptor(tu.prototype,"renderCulling"),tu.prototype),bu=A(tu.prototype,"_renderCulling",[R],(function(){return!1})),r(tu.prototype,"cullingMode",[Ol],Object.getOwnPropertyDescriptor(tu.prototype,"cullingMode"),tu.prototype),xu=A(tu.prototype,"_cullingMode",[R],(function(){return ui.Pause})),r(tu.prototype,"aabbHalfX",[Rl],Object.getOwnPropertyDescriptor(tu.prototype,"aabbHalfX"),tu.prototype),Tu=A(tu.prototype,"_aabbHalfX",[R],(function(){return 0})),r(tu.prototype,"aabbHalfY",[Fl],Object.getOwnPropertyDescriptor(tu.prototype,"aabbHalfY"),tu.prototype),Au=A(tu.prototype,"_aabbHalfY",[R],(function(){return 0})),r(tu.prototype,"aabbHalfZ",[Cl],Object.getOwnPropertyDescriptor(tu.prototype,"aabbHalfZ"),tu.prototype),wu=A(tu.prototype,"_aabbHalfZ",[R],(function(){return 0})),Ou=A(tu.prototype,"_dataCulling",[R,El],(function(){return!1})),r(tu.prototype,"sharedMaterials",[L,R],Object.getOwnPropertyDescriptor(tu.prototype,"sharedMaterials"),tu.prototype),Ru=A(tu.prototype,"_colorOverLifetimeModule",[zl],(function(){return null})),r(tu.prototype,"colorOverLifetimeModule",[Dl],Object.getOwnPropertyDescriptor(tu.prototype,"colorOverLifetimeModule"),tu.prototype),Fu=A(tu.prototype,"_shapeModule",[Pl],(function(){return null})),r(tu.prototype,"shapeModule",[Il],Object.getOwnPropertyDescriptor(tu.prototype,"shapeModule"),tu.prototype),Cu=A(tu.prototype,"_sizeOvertimeModule",[Bl],(function(){return null})),r(tu.prototype,"sizeOvertimeModule",[Ll],Object.getOwnPropertyDescriptor(tu.prototype,"sizeOvertimeModule"),tu.prototype),Eu=A(tu.prototype,"_velocityOvertimeModule",[Vl],(function(){return null})),r(tu.prototype,"velocityOvertimeModule",[Ul],Object.getOwnPropertyDescriptor(tu.prototype,"velocityOvertimeModule"),tu.prototype),zu=A(tu.prototype,"_forceOvertimeModule",[kl],(function(){return null})),r(tu.prototype,"forceOvertimeModule",[Nl],Object.getOwnPropertyDescriptor(tu.prototype,"forceOvertimeModule"),tu.prototype),Du=A(tu.prototype,"_limitVelocityOvertimeModule",[Gl],(function(){return null})),r(tu.prototype,"limitVelocityOvertimeModule",[Hl],Object.getOwnPropertyDescriptor(tu.prototype,"limitVelocityOvertimeModule"),tu.prototype),Pu=A(tu.prototype,"_rotationOvertimeModule",[Xl],(function(){return null})),r(tu.prototype,"rotationOvertimeModule",[Wl],Object.getOwnPropertyDescriptor(tu.prototype,"rotationOvertimeModule"),tu.prototype),Iu=A(tu.prototype,"_textureAnimationModule",[Yl],(function(){return null})),r(tu.prototype,"textureAnimationModule",[jl],Object.getOwnPropertyDescriptor(tu.prototype,"textureAnimationModule"),tu.prototype),Bu=A(tu.prototype,"_noiseModule",[Zl],(function(){return null})),r(tu.prototype,"noiseModule",[ql],Object.getOwnPropertyDescriptor(tu.prototype,"noiseModule"),tu.prototype),Lu=A(tu.prototype,"_trailModule",[Ql],(function(){return null})),r(tu.prototype,"trailModule",[Kl],Object.getOwnPropertyDescriptor(tu.prototype,"trailModule"),tu.prototype),Vu=A(tu.prototype,"renderer",[Jl,R],(function(){return new Hu})),Uu=A(tu.prototype,"_prewarm",[R],(function(){return!1})),ku=A(tu.prototype,"_capacity",[R],(function(){return 100})),Nu=A(tu.prototype,"_simulationSpace",[R],(function(){return li.Local})),$l=tu))||$l)||$l);t({ParticleSystem:hh,ParticleSystemComponent:hh});var ch=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){this.registeredSceneEvent||(Pt.on(It.BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0);var e=t._uuid;if(!this.particleSystemPool.has(e)){var i=new p((function(){return Lt(t)||new pt}),1,(function(t){return t.destroy()}));this.particleSystemPool.set(e,i)}return this.particleSystemPool.get(e).alloc()},t.destroy=function(t){var e,i,r=null==(e=t.prefab)||null==(i=e.asset)?void 0:i.uuid;r&&this.particleSystemPool.has(r)&&(this.stop(t),this.particleSystemPool.get(r).free(t))},t.play=function(t){for(var e,i=s(t.getComponentsInChildren(hh));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=s(t.getComponentsInChildren(hh));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());ch.particleSystemPool=new Map,ch.registeredSceneEvent=!1,$(An.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),tt(hh.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),rt.ParticleSystemComponent=hh,g(hh,"cc.ParticleSystemComponent"),rt.BillboardComponent=Zt,g(Zt,"cc.BillboardComponent"),rt.LineComponent=oi,g(oi,"cc.LineComponent"),rt.ParticleUtils=ch}}}));
//# sourceMappingURL=particle.js.map
