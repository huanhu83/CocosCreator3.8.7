System.register(["./_virtual_internal_constants-CVZmBipG.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./index-D-Wi7yQz.js","./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./wasm-web-DpHjq6qw.js","./physics-framework.js","./scene-D5fG1En6.js","./collision-matrix-DvJE_i6G.js","./array-collision-matrix-DU5_JQW3.js","./tuple-dictionary-By7Ih6PO.js","./util-BWh5q49O.js","./prefab-CJahvMeV.js","./pipeline-state-manager-C4BAah3w.js","./node-event-BDYemSfE.js","./debug-view-zRQBd5E1.js","./global-exports-ZavlJGEN.js","./deprecated-BaebfHhU.js","./mesh-BsaPYlYJ.js","./zlib.min-CyXMsivM.js","./skeleton-hXUbiLKQ.js","./terrain-asset-DtjAFN8y.js","./base.js","./deprecated-BfPl6EQ2.js","./render-types-DTmbYHic.js","./deprecated-B2PZGYTz.js","./camera-component-DK1ym1MK.js","./model-renderer-KnEZ5pPV.js","./renderer-DVTO-7-w.js","./instantiate-B8jTMe8K.js","./touch-Ch03mDFP.js","./move-DN1M4QQp.js","./capsule-C5D-FUD0.js"],(function(t,e){"use strict";var i,s,n,o,r,a,l,h,c,d,p,_,u,y,f,g,m,C,S,T,B,v,w,D,b,E,A,M,O,R,I,G,F,x,P;return{setters:[null,function(t){i=t.g,s=t.G},function(t){n=t.d},function(t){o=t.P,r=t.q,a=t.s},function(t){l=t.G,h=t.L,c=t.a,d=t.I,p=t._,_=t.F,u=t.ay},function(t){y=t.n,f=t.f,g=t.Q,m=t.M,C=t.C,S=t.ai,T=t.aj,B=t.h},null,function(t){v=t.P},function(t){w=t.e,D=t.i},null,function(t){b=t.T},function(t){E=t.P,A=t.a,M=t.b,O=t.c,R=t.d,I=t.e},function(t){G=t.A},function(t){F=t.T},function(t){x=t.V,P=t.a},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){var L,k,N;t("loadWasmModuleBullet",(function(){return Promise.resolve()})),function(t){t[t.EBulletTypeVec3=0]="EBulletTypeVec3",t[t.EBulletTypeQuat=1]="EBulletTypeQuat",t[t.EBulletTypeTransform=2]="EBulletTypeTransform",t[t.EBulletTypeMotionState=3]="EBulletTypeMotionState",t[t.EBulletTypeCollisionObject=4]="EBulletTypeCollisionObject",t[t.EBulletTypeCollisionShape=5]="EBulletTypeCollisionShape",t[t.EBulletTypeCharacterController=6]="EBulletTypeCharacterController",t[t.EBulletTypeStridingMeshInterface=7]="EBulletTypeStridingMeshInterface",t[t.EBulletTypeTriangleMesh=8]="EBulletTypeTriangleMesh",t[t.EBulletTypeCollisionDispatcher=9]="EBulletTypeCollisionDispatcher",t[t.EBulletTypeDbvtBroadPhase=10]="EBulletTypeDbvtBroadPhase",t[t.EBulletTypeSequentialImpulseConstraintSolver=11]="EBulletTypeSequentialImpulseConstraintSolver",t[t.EBulletTypeCollisionWorld=12]="EBulletTypeCollisionWorld",t[t.EBulletTypeTypedConstraint=13]="EBulletTypeTypedConstraint",t[t.EBulletTypeDebugDraw=14]="EBulletTypeDebugDraw"}(L||(L={})),function(t){t[t.NONE=0]="NONE",t[t.FilterBackfaces=1]="FilterBackfaces",t[t.KeepUnflippedNormal=2]="KeepUnflippedNormal",t[t.UseSubSimplexConvexCastRaytest=4]="UseSubSimplexConvexCastRaytest",t[t.UseGjkConvexCastRaytest=8]="UseGjkConvexCastRaytest"}(k||(k={})),function(t){t[t.DBG_NoDebug=0]="DBG_NoDebug",t[t.DBG_DrawWireframe=1]="DBG_DrawWireframe",t[t.DBG_DrawAabb=2]="DBG_DrawAabb",t[t.DBG_DrawFeaturesText=4]="DBG_DrawFeaturesText",t[t.DBG_DrawContactPoints=8]="DBG_DrawContactPoints",t[t.DBG_NoDeactivation=16]="DBG_NoDeactivation",t[t.DBG_NoHelpText=32]="DBG_NoHelpText",t[t.DBG_DrawText=64]="DBG_DrawText",t[t.DBG_ProfileTimings=128]="DBG_ProfileTimings",t[t.DBG_EnableSatComparison=256]="DBG_EnableSatComparison",t[t.DBG_DisableBulletLCP=512]="DBG_DisableBulletLCP",t[t.DBG_EnableCCD=1024]="DBG_EnableCCD",t[t.DBG_DrawConstraints=2048]="DBG_DrawConstraints",t[t.DBG_DrawConstraintLimits=4096]="DBG_DrawConstraintLimits",t[t.DBG_FastWireframe=8192]="DBG_FastWireframe",t[t.DBG_DrawNormals=16384]="DBG_DrawNormals",t[t.DBG_DrawFrames=32768]="DBG_DrawFrames",t[t.DBG_MAX_DEBUG_DRAW_MODE=32769]="DBG_MAX_DEBUG_DRAW_MODE"}(N||(N={}));var W={},V={BODY_CACHE_NAME:"body",CCT_CACHE_NAME:"cct"};i.onPostInfrastructureInitDelegate.add((function(){return w().then((function(){return y.hasFeature(y.Feature.WASM)?Promise.all([e.import("./bullet.release.wasm-CelXh8Y-.js").then((function(t){return t.b})),e.import("./bullet.release.wasm-mT4aJDLq.js")]).then((function(t){var e,i,s=t[0].default,n=t[1].default;return e=s,i=n,new Promise((function(t,s){var n=function(t){return"[bullet]: bullet wasm lib load failed: "+t};e({instantiateWasm:function(t,e){D(i,t).then((function(t){e(t.instance,t.module)})).catch((function(t){return s(n(t))}))}}).then((function(t){l("[bullet]:bullet wasm lib loaded."),W=t,globalThis.Bullet=W})).then(t).catch((function(t){return s(n(t))}))}))})):e.import("./bullet.release.asm-CtSjh1p_.js").then((function(t){return t.b})).then((function(t){var e;return null!=(e=t.default)?e().then((function(t){l("[bullet]:bullet asm lib loaded."),W=t})):new Promise((function(t){t()}))}))})).catch((function(t){h(t)}))}));var H={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},j={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},z={type:"onControllerTriggerEnter",collider:null,characterController:null,impl:null},U=function(){function t(){this.BT_TRANSFORM_0=W.Transform_new(),this.BT_TRANSFORM_1=W.Transform_new(),this.BT_V3_0=W.Vec3_new(0,0,0),this.BT_V3_1=W.Vec3_new(0,0,0),this.BT_V3_2=W.Vec3_new(0,0,0),this.BT_QUAT_0=W.Quat_new(0,0,0,1)}return t.setWrapper=function(t,e,i){this.ROOT[e]||(this.ROOT[e]={}),this.ROOT[e][t]=i},t.delWrapper=function(t,e){delete this.ROOT[e][t]},t.getWrapper=function(t,e){return this.ROOT[e][t]},t.isNotEmptyShape=function(t){return t!==W.EmptyShape_static()},c(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();U._instance=void 0,U.ROOT={},U.world=null;var Y=new f,J=new f,Q=new f,Z=new g,K=new g,X=new m;new m;var q,$,tt,et,it,st=new C;function nt(t,e){return W.Vec3_set(t,e.x,e.y,e.z),t}function ot(t,e){var i=W.HEAPF32.subarray(e/4,e/4+3);return t.x=i[0],t.y=i[1],t.z=i[2],t}function rt(t,e){return W.Quat_set(t,e.x,e.y,e.z,e.w),t}function at(t,e){var i=W.HEAPF32.subarray(e/4,e/4+4);return t.x=i[0],t.y=i[1],t.z=i[2],t.w=i[3],t}function lt(t,e){for(var i=e.renderingSubMeshes.length,s=0;s<i;s++){var n=e.renderingSubMeshes[s],o=n.geometricInfo;if(o){var r=n.primitiveMode,a=o.positions,l=o.indices,h=U.instance.BT_V3_0,c=U.instance.BT_V3_1,d=U.instance.BT_V3_2;if(r===v.TRIANGLE_LIST)for(var p=l.length,_=0;_<p;_+=3){var u=3*l[_],y=3*l[_+1],f=3*l[_+2];W.Vec3_set(h,a[u],a[u+1],a[u+2]),W.Vec3_set(c,a[y],a[y+1],a[y+2]),W.Vec3_set(d,a[f],a[f+1],a[f+2]),W.TriangleMesh_addTriangle(t,h,c,d,!1)}else if(r===v.TRIANGLE_STRIP)for(var g=l.length-2,m=0,C=0;C<g;C+=1){var S=3*l[C-m],T=3*l[C+m+1],B=3*l[C+2];m=~m,W.Vec3_set(h,a[S],a[S+1],a[S+2]),W.Vec3_set(c,a[T],a[T+1],a[T+2]),W.Vec3_set(d,a[B],a[B+1],a[B+2]),W.TriangleMesh_addTriangle(t,h,c,d,!1)}else if(r===v.TRIANGLE_FAN){var w=l.length-1,D=3*l[0];W.Vec3_set(h,a[D],a[D+1],a[D+2]);for(var b=1;b<w;b+=1){var E=3*l[b],A=3*l[b+1];W.Vec3_set(c,a[E],a[E+1],a[E+2]),W.Vec3_set(d,a[A],a[A+1],a[A+2]),W.TriangleMesh_addTriangle(t,h,c,d,!1)}}}}return t}function ht(t,e){return t*e}V.CACHE=U,function(t){t[t.NONE=0]="NONE",t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(q||(q={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}($||($={})),function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(tt||(tt={})),function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(et||(et={})),function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(it||(it={}));var ct=Y,dt=J,pt=function(){var t=e.prototype;function e(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this._sharedBody=void 0,this._rigidBody=void 0,this.id=e.idCounter++}return t.setMass=function(t){this._rigidBody.isDynamic&&(W.RigidBody_setMass(this.impl,t),this._wakeUpIfSleep(),this._sharedBody.dirty|=q.BODY_RE_ADD)},t.setType=function(t){this._sharedBody.setType(t)},t.setLinearDamping=function(){W.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.setAngularDamping=function(){W.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.useGravity=function(t){if(this._rigidBody.isDynamic){var e=W.RigidBody_getFlags(this.impl);t?e&=~it.BT_DISABLE_WORLD_GRAVITY:(W.RigidBody_setGravity(this.impl,nt(U.instance.BT_V3_0,f.ZERO)),e|=it.BT_DISABLE_WORLD_GRAVITY),W.RigidBody_setFlags(this.impl,e),this._wakeUpIfSleep(),this._sharedBody.dirty|=q.BODY_RE_ADD}},t.useCCD=function(t){W.CollisionObject_setCcdMotionThreshold(this.impl,t?.01:0),W.CollisionObject_setCcdSweptSphereRadius(this.impl,t?.1:0),this._isUsingCCD=t},t.isUsingCCD=function(){return this._isUsingCCD},t.setLinearFactor=function(t){W.RigidBody_setLinearFactor(this.impl,nt(U.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAngularFactor=function(t){W.RigidBody_setAngularFactor(this.impl,nt(U.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?W.CollisionObject_forceActivationState(this.impl,et.ACTIVE_TAG):W.CollisionObject_forceActivationState(this.impl,et.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},t.clearState=function(){W.RigidBody_clearState(this.impl)},t.clearVelocity=function(){this.setLinearVelocity(f.ZERO),this.setAngularVelocity(f.ZERO)},t.clearForces=function(){W.RigidBody_clearForces(this.impl)},t.initialize=function(t){this._rigidBody=t,this._sharedBody=o.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.wakeUp=function(t){void 0===t&&(t=!0),W.CollisionObject_activate(this.impl,t)},t.sleep=function(){var t=W.CollisionObject_getActivationState(this.impl);t!==et.DISABLE_DEACTIVATION&&t!==et.DISABLE_SIMULATION&&W.CollisionObject_forceActivationState(this.impl,et.ISLAND_SLEEPING)},t.setSleepThreshold=function(t){this._wakeUpIfSleep(),W.RigidBody_setSleepingThresholds(this.impl,t,t)},t.getSleepThreshold=function(){return W.RigidBody_getLinearSleepingThreshold(this.impl)},t.getLinearVelocity=function(t){return ot(t,W.RigidBody_getLinearVelocity(this.impl))},t.setLinearVelocity=function(t){this._wakeUpIfSleep(),nt(W.RigidBody_getLinearVelocity(this.impl),t)},t.getAngularVelocity=function(t){return ot(t,W.RigidBody_getAngularVelocity(this.impl))},t.setAngularVelocity=function(t){this._wakeUpIfSleep(),nt(W.RigidBody_getAngularVelocity(this.impl),t)},t.applyLocalForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var i=this._sharedBody.node.worldRotation,s=f.transformQuat(ct,t,i),n=e?f.transformQuat(dt,e,i):f.ZERO;W.RigidBody_applyForce(this.impl,nt(U.instance.BT_V3_0,s),nt(U.instance.BT_V3_1,n))},t.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),f.transformQuat(ct,t,this._sharedBody.node.worldRotation),W.RigidBody_applyTorque(this.impl,nt(U.instance.BT_V3_0,ct))},t.applyLocalImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var i=this._sharedBody.node.worldRotation,s=f.transformQuat(ct,t,i),n=e?f.transformQuat(dt,e,i):f.ZERO;W.RigidBody_applyImpulse(this.impl,nt(U.instance.BT_V3_0,s),nt(U.instance.BT_V3_1,n))},t.applyForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var i=e||f.ZERO;W.RigidBody_applyForce(this.impl,nt(U.instance.BT_V3_0,t),nt(U.instance.BT_V3_1,i))},t.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),W.RigidBody_applyTorque(this.impl,nt(U.instance.BT_V3_0,t))},t.applyImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var i=e||f.ZERO;W.RigidBody_applyImpulse(this.impl,nt(U.instance.BT_V3_0,t),nt(U.instance.BT_V3_1,i))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t._wakeUpIfSleep=function(){this.isAwake||W.CollisionObject_activate(this.impl,!0)},c(e,[{key:"isAwake",get:function(){var t=W.CollisionObject_getActivationState(this.impl);return t===et.ACTIVE_TAG||t===et.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return W.CollisionObject_getActivationState(this.impl)===et.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return W.CollisionObject_getActivationState(this.impl)===et.ISLAND_SLEEPING}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),e}();pt.idCounter=0;var _t={syncPhysicsToGraphics:function(t){V.CACHE.getWrapper(t,V.BODY_CACHE_NAME).syncPhysicsToGraphics()},onShapeHitExt:function(t,e){V.CACHE.getWrapper(e,V.CCT_CACHE_NAME).onShapeHitExt(t)},onDebugDrawLine:function(t,e,i){var s=V.CACHE.world;s&&s.onDebugDrawLine(t,e,i)},clearLines:function(){var t=V.CACHE.world;t&&t.onClearLines()},flushLines:function(){}},ut=Y,yt=Z,ft=0,gt=function(){function t(e,i){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=o.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._bodyStruct=void 0,this._ghostStruct=void 0,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=i,this.node=e}t.getSharedBody=function(e,i,s){var n,r=e.uuid;if(t.sharedBodesMap.has(r))n=t.sharedBodesMap.get(r);else{n=new t(e,i);var a=E.DEFAULT,l=o.instance.collisionMatrix[a];n._collisionFilterGroup=a,n._collisionFilterMask=l,t.sharedBodesMap.set(e.uuid,n)}if(s){n._wrappedBody=s;var h=s.rigidBody.group,c=o.instance.collisionMatrix[h];n._collisionFilterGroup=h,n._collisionFilterMask=c}return n};var e=t.prototype;return e._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(t=this._wrappedBody.rigidBody.mass);var e=U.instance.BT_TRANSFORM_0,i=U.instance.BT_QUAT_0;nt(W.Transform_getOrigin(e),this.node.worldPosition),rt(i,this.node.worldRotation),W.Transform_setRotation(e,i);var s=W.MotionState.implement(_t).$$.ptr;W.ccMotionState_setup(s,this.id,e);var n=W.RigidBody_new(t,s),r=o.instance.sleepThreshold;W.RigidBody_setSleepingThresholds(n,r,r),this._bodyStruct={id:ft++,body:n,motionState:s,compound:W.ccCompoundShape_new(),wrappedShapes:[],useCompound:!1},U.setWrapper(this.id,V.BODY_CACHE_NAME,this),this._ghostStruct&&W.CollisionObject_setIgnoreCollisionCheck(this.ghost,this.body,!0),this._wrappedBody&&this.setBodyType(this._wrappedBody.rigidBody.type)}},e._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=W.CollisionObject_new(),e=W.ccCompoundShape_new();W.CollisionObject_setCollisionShape(t,e),W.CollisionObject_setCollisionFlags(t,$.CF_STATIC_OBJECT|$.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:ft++,ghost:t,compound:e,wrappedShapes:[]},this._bodyStruct&&W.CollisionObject_setIgnoreCollisionCheck(this.body,this.ghost,!0),this._wrappedBody&&this.setGhostType(this._wrappedBody.rigidBody.type)}},e.setType=function(t){this.setBodyType(t),this.setGhostType(t)},e.setBodyType=function(t){if(this._bodyStruct&&this._wrappedBody){var e=this._bodyStruct.body,i=this._wrappedBody,s=i.rigidBody,n=W.CollisionObject_getCollisionFlags(e),o=U.instance.BT_V3_0;switch(t){case A.DYNAMIC:n&=~$.CF_KINEMATIC_OBJECT,n&=~$.CF_STATIC_OBJECT,W.CollisionObject_setCollisionFlags(e,n),i.setMass(s.mass),i.useGravity(s.useGravity),i.setAllowSleep(s.allowSleep);break;case A.KINEMATIC:W.Vec3_set(o,0,0,0),W.RigidBody_setMassProps(e,0,o),n|=$.CF_KINEMATIC_OBJECT,n&=~$.CF_STATIC_OBJECT,W.CollisionObject_setCollisionFlags(e,n),W.CollisionObject_forceActivationState(e,et.DISABLE_DEACTIVATION);break;case A.STATIC:default:W.Vec3_set(o,0,0,0),W.RigidBody_setMassProps(e,0,o),n|=$.CF_STATIC_OBJECT,n&=~$.CF_KINEMATIC_OBJECT,W.CollisionObject_setCollisionFlags(e,n),W.CollisionObject_forceActivationState(e,et.ISLAND_SLEEPING)}this.dirty|=q.BODY_RE_ADD}},e.setGhostType=function(t){if(this._ghostStruct){var e=this._ghostStruct.ghost,i=W.CollisionObject_getCollisionFlags(e);switch(t){case A.DYNAMIC:case A.KINEMATIC:i&=~$.CF_STATIC_OBJECT,i|=$.CF_KINEMATIC_OBJECT,W.CollisionObject_setCollisionFlags(e,i),W.CollisionObject_forceActivationState(e,et.DISABLE_DEACTIVATION);break;case A.STATIC:default:i&=~$.CF_KINEMATIC_OBJECT,i|=$.CF_STATIC_OBJECT,W.CollisionObject_setCollisionFlags(e,i),W.CollisionObject_forceActivationState(e,et.ISLAND_SLEEPING)}this.dirty|=q.GHOST_RE_ADD}},e.addShape=function(t,e){function i(t,e){W.CollisionObject_setCollisionShape(t.body,e),t.dirty|=q.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(e)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var n=0;n<s;n++)this.bodyStruct.wrappedShapes[n].setCompound(this.bodyCompoundShape);i(this,this.bodyStruct.compound)}else i(this,t.impl)}this.bodyEnabled=!0}},e.removeShape=function(t,e){if(e){var i=this.ghostStruct.wrappedShapes.indexOf(t);i>=0&&(d(this.ghostStruct.wrappedShapes,i),t.setCompound(0),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(0):W.CollisionObject_setCollisionShape(this.body,W.EmptyShape_static()),W.CollisionObject_activate(this.body,!0),this.dirty|=q.BODY_RE_ADD,d(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},e.addJoint=function(t,e){e?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,e){if(e){var i=this.wrappedJoints1.indexOf(t);i>=0&&d(this.wrappedJoints1,i)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&d(this.wrappedJoints0,s)}},e.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&q.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&q.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},e.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=U.instance.BT_QUAT_0,e=W.CollisionObject_getWorldTransform(this.body);if(rt(t,this.node.worldRotation),nt(W.Transform_getOrigin(e),this.node.worldPosition),W.Transform_setRotation(e,t),this.node.hasChangedFlags&b.SCALE&&this.syncBodyScale(),W.CollisionObject_isKinematicObject(this.body)){var i=W.RigidBody_getMotionState(this.body);i&&W.MotionState_setWorldTransform(i,e)}else this.isBodySleeping()&&W.CollisionObject_activate(this.body,!1)}},e.syncPhysicsToScene=function(){W.CollisionObject_isStaticOrKinematicObject(this.body)||this.syncPhysicsToGraphics()},e.syncPhysicsToGraphics=function(){if(!this.isBodySleeping()){var t=U.instance.BT_QUAT_0,e=U.instance.BT_TRANSFORM_0;W.RigidBody_getWorldTransform(this.body,e);var i=W.Transform_getRotationAndOrigin(e,t);if(this.node.worldRotation=at(yt,t),this.node.worldPosition=ot(ut,i),this._ghostStruct){var s=W.CollisionObject_getWorldTransform(this.ghost);nt(W.Transform_getOrigin(s),this.node.worldPosition),rt(t,this.node.worldRotation),W.Transform_setRotation(s,t)}}},e.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=U.instance.BT_QUAT_0,e=W.CollisionObject_getWorldTransform(this.ghost);nt(W.Transform_getOrigin(e),this.node.worldPosition),rt(t,this.node.worldRotation),W.Transform_setRotation(e,t),this.node.hasChangedFlags&b.SCALE&&this.syncGhostScale(),W.CollisionObject_activate(this.ghost,!1)}},e.syncInitialBody=function(){var t=U.instance.BT_QUAT_0,e=W.CollisionObject_getWorldTransform(this.body);nt(W.Transform_getOrigin(e),this.node.worldPosition),rt(t,this.node.worldRotation),W.Transform_setRotation(e,t),this.syncBodyScale(),W.CollisionObject_activate(this.body,!1)},e.syncInitialGhost=function(){var t=U.instance.BT_QUAT_0,e=W.CollisionObject_getWorldTransform(this.ghost);nt(W.Transform_getOrigin(e),this.node.worldPosition),rt(t,this.node.worldRotation),W.Transform_setRotation(e,t),this.syncGhostScale(),W.CollisionObject_activate(this.body,!1)},e.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(var e=0;e<this.wrappedJoints0.length;e++)this.wrappedJoints0[e].updateScale0();for(var i=0;i<this.wrappedJoints1.length;i++)this.wrappedJoints1[i].updateScale1()},e.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()},e.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},e.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},e.destroy=function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var e=this._bodyStruct;U.delWrapper(this.id,V.BODY_CACHE_NAME),W._safe_delete(e.motionState,L.EBulletTypeMotionState),W._safe_delete(e.compound,L.EBulletTypeCollisionShape),W._safe_delete(e.body,L.EBulletTypeCollisionObject),this._bodyStruct=null}if(this._ghostStruct){var i=this._ghostStruct;W._safe_delete(i.compound,L.EBulletTypeCollisionShape),W._safe_delete(i.ghost,L.EBulletTypeCollisionObject),this._ghostStruct=null}},e.isBodySleeping=function(){return W.CollisionObject_isSleeping(this.body)},c(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.compound}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.compound}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=q.BODY_RE_ADD,this.dirty|=q.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=q.BODY_RE_ADD,this.dirty|=q.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){var e=this;if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else if(this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)){var i=this.body;this.wrappedWorld.constraints.forEach((function(t){var s,n;(null==(s=t.constraint.attachedBody)||null==(n=s.body)?void 0:n.impl)===i&&e.wrappedWorld.removeConstraint(t)})),W.RigidBody_clearState(this.body),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this)}}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();gt.idCounter=0,gt.sharedBodesMap=new Map;var mt=Y,Ct={},St=function(){function t(){this.id=t.idCounter++,this._isEnabled=!1,this._isTrigger=!1,this._isInitialized=!1,this._impl=0,this._compound=0,this.quat=W.Quat_new(0,0,0,1),this.transform=W.Transform_new(),this._collider=void 0,this._sharedBody=void 0}var e=t.prototype;return e.updateEventListener=function(){this._sharedBody.wrappedWorld&&this._sharedBody.wrappedWorld.updateNeedEmitEvents(this.collider.needCollisionEvent||this.collider.needTriggerEvent)},e.setMaterial=function(t){var e=null==t?o.instance.defaultMaterial:t;if(!this._isTrigger&&this._isEnabled)if(this._compound){Ct[e._uuid]||(Ct[e._uuid]=W.ccMaterial_new());var i=Ct[e._uuid];W.ccMaterial_set(i,e.restitution,e.friction,e.rollingFriction,e.spinningFriction),W.CollisionShape_setMaterial(this._impl,i)}else W.CollisionObject_setMaterial(this._sharedBody.body,e.restitution,e.friction,e.rollingFriction,e.spinningFriction)},e.setCenter=function(t){f.copy(mt,t),mt.multiply(this._collider.node.worldScale),nt(W.Transform_getOrigin(this.transform),mt),this.updateCompoundTransform()},e.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},e.getAABB=function(t){var e=U.instance.BT_TRANSFORM_0;W.Transform_setIdentity(e),W.Transform_setRotation(e,rt(U.instance.BT_QUAT_0,this._collider.node.worldRotation));var i=U.instance.BT_V3_0,s=U.instance.BT_V3_1;W.CollisionShape_getAabb(this._impl,e,i,s),t.halfExtents.x=(W.Vec3_x(s)-W.Vec3_x(i))/2,t.halfExtents.y=(W.Vec3_y(s)-W.Vec3_y(i))/2,t.halfExtents.z=(W.Vec3_z(s)-W.Vec3_z(i))/2,f.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.getBoundingSphere=function(t){t.radius=W.CollisionShape_getLocalBoundingSphere(this._impl),f.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.initialize=function(t){this._collider=t,this._isInitialized=!0,this._sharedBody=o.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()},e.setWrapper=function(){U.isNotEmptyShape(this._impl)&&(W.CollisionShape_setUserPointer(this._impl,this._impl),U.setWrapper(this._impl,t.TYPE,this))},e.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},e.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},e.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},e.onDestroy=function(){this._sharedBody.reference=!1,this._collider=null,W._safe_delete(this.quat,L.EBulletTypeQuat),W._safe_delete(this.transform,L.EBulletTypeTransform),this._compound&&W._safe_delete(this._compound,L.EBulletTypeCollisionShape),U.isNotEmptyShape(this._impl)&&(W._safe_delete(this._impl,L.EBulletTypeCollisionShape),U.delWrapper(this._impl,t.TYPE))},e.updateByReAdd=function(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))},e.getGroup=function(){return this._sharedBody.collisionFilterGroup},e.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},e.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},e.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},e.getMask=function(){return this._sharedBody.collisionFilterMask},e.setMask=function(t){this._sharedBody.collisionFilterMask=t},e.addMask=function(t){this._sharedBody.collisionFilterMask|=t},e.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},e.setCompound=function(t){this._compound&&W.CompoundShape_removeChildShape(this._compound,this._impl),t&&W.CompoundShape_addChildShape(t,this.transform,this._impl),this._compound=t},e.updateScale=function(){this.setCenter(this._collider.center)},e.updateCompoundTransform=function(){this._compound?W.CompoundShape_updateChildTransform(this._compound,this._impl,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=q.BODY_RE_ADD)},e.needCompound=function(){return this._collider.type===M.TERRAIN||!this._collider.center.equals(f.ZERO)},c(t,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}}]),t}();St.TYPE="shape",St.idCounter=0;var Tt=function(){function t(t){this.impl=0,this.event=void 0,this.event=t}var e=t.prototype;return e.getLocalPointOnA=function(t){this.impl&&ot(t,W.ManifoldPoint_get_m_localPointA(this.impl))},e.getLocalPointOnB=function(t){this.impl&&ot(t,W.ManifoldPoint_get_m_localPointB(this.impl))},e.getWorldPointOnA=function(t){this.impl&&ot(t,W.ManifoldPoint_get_m_positionWorldOnA(this.impl))},e.getWorldPointOnB=function(t){this.impl&&ot(t,W.ManifoldPoint_get_m_positionWorldOnB(this.impl))},e.getLocalNormalOnA=function(t){if(this.impl){var e=U.instance.BT_QUAT_0,i=W.PersistentManifold_getBody0(this.event.impl),s=W.CollisionObject_getWorldTransform(i);W.Transform_getRotation(s,e);var n=Z;at(n,e),g.conjugate(n,n),ot(t,W.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||f.negate(t,t),f.transformQuat(t,t,n)}},e.getLocalNormalOnB=function(t){if(this.impl){var e=U.instance.BT_QUAT_0,i=W.PersistentManifold_getBody1(this.event.impl),s=W.CollisionObject_getWorldTransform(i);W.Transform_getRotation(s,e);var n=Z;at(n,e),g.conjugate(n,n),ot(t,W.ManifoldPoint_get_m_normalWorldOnB(this.impl)),f.transformQuat(t,t,n)}},e.getWorldNormalOnA=function(t){this.impl&&(ot(t,W.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||f.negate(t,t))},e.getWorldNormalOnB=function(t){this.impl&&ot(t,W.ManifoldPoint_get_m_normalWorldOnB(this.impl))},c(t,[{key:"isBodyA",get:function(){return this.event.selfCollider.shape.sharedBody.body===W.PersistentManifold_getBody0(this.event.impl)}}]),t}(),Bt=[],vt=Y,wt=J,Dt=Q,bt=st,Et=new r,At=function(){var t=e.prototype;function e(){this._world=void 0,this._broadphase=void 0,this._solver=void 0,this._dispatcher=void 0,this._debugDraw=void 0,this._debugLineCount=0,this._MAX_DEBUG_LINE_COUNT=16384,this._debugDrawFlags=O.NONE,this._debugConstraintSize=.3,this._needEmitEvents=!1,this._needSyncAfterEvents=!1,this._needEmitCCTEvents=!1,this.bodies=[],this.ghosts=[],this.ccts=[],this.constraints=[],this.triggerArrayMat=new G,this.characterControllerArrayMat=new G,this.collisionArrayMat=new G,this.contactsDic=new F,this.oldContactsDic=new F,this.cctShapeEventDic=new F,this.cctContactsDic=new F,this.cctOldContactsDic=new F,V.CACHE.world=this,this._broadphase=W.DbvtBroadphase_new(),this._dispatcher=W.CollisionDispatcher_new(),this._solver=W.SequentialImpulseConstraintSolver_new(),this._world=W.ccDiscreteDynamicsWorld_new(this._dispatcher,this._broadphase,this._solver);var t=W.DebugDraw.implement(_t);this._debugDraw=t.$$.ptr,W.CollisionWorld_setDebugDrawer(this._world,this._debugDraw),W.DebugDraw_setDebugMode(this._debugDraw,N.DBG_NoDebug),W.DebugDraw_setAABBColor(this._debugDraw,0,1,1),W.DebugDraw_setActiveObjectColor(this._debugDraw,1,0,1),W.DebugDraw_setDeactiveObjectColor(this._debugDraw,1,0,1),W.DebugDraw_setWantsDeactivationObjectColor(this._debugDraw,1,0,1),W.DebugDraw_setDisabledDeactivationObjectColor(this._debugDraw,1,0,1),W.DebugDraw_setDisabledSimulationObjectColor(this._debugDraw,1,0,1),W.DebugDraw_setConstraintLimitColor(this._debugDraw,.5,.5,.5)}return t.setDefaultMaterial=function(){},t.setAllowSleep=function(t){W.ccDiscreteDynamicsWorld_setAllowSleep(this._world,t)},t.setGravity=function(t){W.DynamicsWorld_setGravity(this._world,nt(U.instance.BT_V3_0,t))},t.updateNeedEmitEvents=function(t){if(this.ghosts)if(t)this._needEmitEvents=!0;else{this._needEmitEvents=!1;for(var e=0;e<this.ghosts.length;e++)for(var i=this.ghosts[e].ghostStruct.wrappedShapes,s=0;s<i.length;s++){var n=i[s].collider;if(n.needCollisionEvent||n.needTriggerEvent)return void(this._needEmitEvents=!0)}for(var o=0;o<this.bodies.length;o++)for(var r=this.bodies[o].bodyStruct.wrappedShapes,a=0;a<r.length;a++){var l=r[a].collider;if(l.needCollisionEvent||l.needTriggerEvent)return void(this._needEmitEvents=!0)}}},t.updateNeedEmitCCTEvents=function(t){if(this.ccts)if(t)this._needEmitCCTEvents=!0;else{this._needEmitCCTEvents=!1;for(var e=this.ccts,i=e.length,s=0;s<i;s++)if(e[s].characterController.needCollisionEvent)return void(this._needEmitCCTEvents=!0)}},t.destroy=function(){(this.constraints.length||this.bodies.length||this.ccts.length)&&h("You should destroy all physics component first."),W._safe_delete(this._world,L.EBulletTypeCollisionWorld),W._safe_delete(this._broadphase,L.EBulletTypeDbvtBroadPhase),W._safe_delete(this._dispatcher,L.EBulletTypeCollisionDispatcher),W._safe_delete(this._solver,L.EBulletTypeSequentialImpulseConstraintSolver),W._safe_delete(this._debugDraw,L.EBulletTypeDebugDraw),this.bodies=null,this.ghosts=null,this.ccts=null,this.constraints=null,this.triggerArrayMat=null,this.characterControllerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,this.cctShapeEventDic=null,this.cctShapeEventPool=null,Bt.length=0},t.step=function(t,e,i){void 0===i&&(i=0),(this.bodies.length||this.ghosts.length)&&(void 0===e&&(e=t),W.DynamicsWorld_stepSimulation(this._world,e,i,t),W.CollisionWorld_debugDrawWorld(this._world))},t.syncSceneToPhysics=function(){for(var t=this.ghosts.length-1;t>=0;t--){var e=this.ghosts[t];e.updateDirty(),e.syncSceneToGhost()}for(var i=this.bodies.length-1;i>=0;i--){var s=this.bodies[i];s.updateDirty(),s.syncSceneToPhysics()}for(var n=this.ccts,o=n.length-1;o>=0;o--){var r=n[o];r.updateDirty(),r.syncSceneToPhysics()}},t.syncAfterEvents=function(){this._needSyncAfterEvents&&this.syncSceneToPhysics()},t.raycast=function(t,e,i,s){t.computeHit(vt,e.maxDistance);var n=nt(U.instance.BT_V3_0,vt),o=nt(U.instance.BT_V3_1,t.o),r=W.ccAllRayCallback_static();if(W.ccAllRayCallback_reset(r,o,n,e.mask>>>0,e.queryTrigger),W.ccAllRayCallback_setFlags(r,k.UseSubSimplexConvexCastRaytest),W.CollisionWorld_rayTest(this._world,o,n,r),W.RayCallback_hasHit(r)){for(var a=W.ccAllRayCallback_getHitPointWorld(r),l=W.ccAllRayCallback_getHitNormalWorld(r),h=W.ccAllRayCallback_getCollisionShapePtrs(r),c=W.ccAllRayCallback_getClosestHitFraction(r),d=0,p=W.int_array_size(h);d<p;d++){ot(vt,W.Vec3_array_at(a,d)),ot(wt,W.Vec3_array_at(l,d));var _=U.getWrapper(W.int_array_at(h,d),St.TYPE),u=i.add();s.push(u),u._assign(vt,f.distance(t.o,vt),_.collider,wt,c)}return!0}return!1},t.raycastClosest=function(t,e,i){t.computeHit(vt,e.maxDistance);var s=nt(U.instance.BT_V3_0,vt),n=nt(U.instance.BT_V3_1,t.o),o=W.ccClosestRayCallback_static();if(W.ccClosestRayCallback_reset(o,n,s,e.mask>>>0,e.queryTrigger),W.ccClosestRayCallback_setFlags(o,k.UseSubSimplexConvexCastRaytest),W.CollisionWorld_rayTest(this._world,n,s,o),W.RayCallback_hasHit(o)){ot(vt,W.ccClosestRayCallback_getHitPointWorld(o)),ot(wt,W.ccClosestRayCallback_getHitNormalWorld(o));var r=U.getWrapper(W.ccClosestRayCallback_getCollisionShapePtr(o),St.TYPE),a=W.ccClosestConvexCallback_getClosestHitFraction(o);return i._assign(vt,f.distance(t.o,vt),r.collider,wt,a),!0}return!1},t.sweepBox=function(t,i,s,n,o,r){var a=U.instance.BT_V3_0;return nt(a,i),e._sweepBoxGeometry||(e._sweepBoxGeometry=W.BoxShape_new(a)),W.BoxShape_setUnscaledHalfExtents(e._sweepBoxGeometry,a),this.sweep(t,e._sweepBoxGeometry,s,n,o,r)},t.sweepBoxClosest=function(t,i,s,n,o){var r=U.instance.BT_V3_0;return nt(r,i),e._sweepBoxGeometry||(e._sweepBoxGeometry=W.BoxShape_new(r)),W.BoxShape_setUnscaledHalfExtents(e._sweepBoxGeometry,r),this.sweepClosest(t,e._sweepBoxGeometry,s,n,o)},t.sweepSphere=function(t,i,s,n,o){return e._sweepSphereGeometry||(e._sweepSphereGeometry=W.SphereShape_new(i)),W.SphereShape_setUnscaledRadius(e._sweepSphereGeometry,i),this.sweep(t,e._sweepSphereGeometry,g.IDENTITY,s,n,o)},t.sweepSphereClosest=function(t,i,s,n){return e._sweepSphereGeometry||(e._sweepSphereGeometry=W.SphereShape_new(i)),W.SphereShape_setUnscaledRadius(e._sweepSphereGeometry,i),this.sweepClosest(t,e._sweepSphereGeometry,g.IDENTITY,s,n)},t.sweepCapsule=function(t,i,s,n,o,r,a){return e._sweepCapsuleGeometry||(e._sweepCapsuleGeometry=W.CapsuleShape_new(i,s)),W.CapsuleShape_updateProp(e._sweepCapsuleGeometry,i,.5*s,1),this.sweep(t,e._sweepCapsuleGeometry,n,o,r,a)},t.sweepCapsuleClosest=function(t,i,s,n,o,r){return e._sweepCapsuleGeometry||(e._sweepCapsuleGeometry=W.CapsuleShape_new(i,s)),W.CapsuleShape_updateProp(e._sweepCapsuleGeometry,i,.5*s,1),this.sweepClosest(t,e._sweepCapsuleGeometry,n,o,r)},t.sweep=function(t,e,i,s,n,o){var r=W.Transform_new(),a=W.Transform_new(),l=W.Quat_new(0,0,0,1);nt(W.Transform_getOrigin(r),t.o),rt(l,i),W.Transform_setRotation(r,l),t.computeHit(vt,s.maxDistance),nt(W.Transform_getOrigin(a),vt),rt(l,i),W.Transform_setRotation(a,l);var h=W.ccAllConvexCallback_static();if(W.ccAllConvexCallback_reset(h,r,a,s.mask>>>0,s.queryTrigger),W.CollisionWorld_convexSweepTest(this._world,e,r,a,h,0),W._safe_delete(r,L.EBulletTypeTransform),W._safe_delete(a,L.EBulletTypeTransform),W._safe_delete(l,L.EBulletTypeQuat),W.ConvexCallback_hasHit(h)){for(var c=W.ccAllConvexCallback_getHitPointWorld(h),d=W.ccAllConvexCallback_getHitNormalWorld(h),p=W.ccAllConvexCallback_getCollisionShapePtrs(h),_=W.ccAllConvexCallback_getClosestHitFraction(h),u=0,y=W.int_array_size(p);u<y;u++){ot(vt,W.Vec3_array_at(c,u)),ot(wt,W.Vec3_array_at(d,u));var g=U.getWrapper(W.int_array_at(p,u),St.TYPE),m=n.add();o.push(m),m._assign(vt,f.distance(t.o,vt),g.collider,wt,_)}return!0}return!1},t.sweepClosest=function(t,e,i,s,n){var o=W.Transform_new(),r=W.Transform_new(),a=W.Quat_new(0,0,0,1);nt(W.Transform_getOrigin(o),t.o),rt(a,i),W.Transform_setRotation(o,a),t.computeHit(vt,s.maxDistance),nt(W.Transform_getOrigin(r),vt),rt(a,i),W.Transform_setRotation(r,a);var l=W.ccClosestConvexCallback_static();if(W.ccClosestConvexCallback_reset(l,o,r,s.mask>>>0,s.queryTrigger),W.CollisionWorld_convexSweepTest(this._world,e,o,r,l,0),W._safe_delete(o,L.EBulletTypeTransform),W._safe_delete(r,L.EBulletTypeTransform),W._safe_delete(a,L.EBulletTypeQuat),W.ConvexCallback_hasHit(l)){ot(vt,W.ccClosestConvexCallback_getHitPointWorld(l)),ot(wt,W.ccClosestConvexCallback_getHitNormalWorld(l));var h=U.getWrapper(W.ccClosestConvexCallback_getCollisionShapePtr(l),St.TYPE),c=W.ccClosestConvexCallback_getClosestHitFraction(l);return n._assign(vt,f.distance(t.o,vt),h.collider,wt,c),!0}return!1},t.getSharedBody=function(t,e){return gt.getSharedBody(t,this,e)},t.addSharedBody=function(t){if(this.bodies.indexOf(t)<0){this.bodies.push(t);var e=t.collisionFilterGroup,i=t.collisionFilterMask;W.DynamicsWorld_addRigidBody(this._world,t.body,e>>>0,i>>>0)}},t.removeSharedBody=function(t){var e=this.bodies.indexOf(t);e>=0&&(d(this.bodies,e),W.DynamicsWorld_removeRigidBody(this._world,t.body))},t.addGhostObject=function(t){if(this.ghosts.indexOf(t)<0){this.ghosts.push(t);var e=t.collisionFilterGroup,i=t.collisionFilterMask;W.CollisionWorld_addCollisionObject(this._world,t.ghost,e>>>0,i>>>0)}},t.removeGhostObject=function(t){var e=this.ghosts.indexOf(t);e>=0&&(d(this.ghosts,e),W.CollisionWorld_removeCollisionObject(this._world,t.ghost))},t.addCCT=function(t){if(this.ccts.indexOf(t)<0){this.ccts.push(t);var e=W.CharacterController_getGhostObject(t.impl),i=t.getGroup(),s=t.getMask();W.CollisionWorld_addCollisionObject(this._world,e,i>>>0,s>>>0),W.DynamicsWorld_addAction(this._world,t.impl)}},t.removeCCT=function(t){var e=this.ccts.indexOf(t);if(e>=0){d(this.ccts,e);var i=W.CharacterController_getGhostObject(t.impl);W.CollisionWorld_removeCollisionObject(this._world,i),W.DynamicsWorld_removeAction(this._world,t.impl)}},t.addConstraint=function(t){var e=this.constraints.indexOf(t);e<0&&(this.constraints.push(t),W.DynamicsWorld_addConstraint(this.impl,t.impl,!t.constraint.enableCollision),t.index=e)},t.removeConstraint=function(t){var e=this.constraints.indexOf(t);e>=0&&(this.constraints.splice(e,1),W.DynamicsWorld_removeConstraint(this.impl,t.impl),t.index=-1)},t.emitEvents=function(){this._needSyncAfterEvents=!1,this._needEmitEvents&&(this.gatherConatactData(),this.emitCollisionAndTriggerEvent(),this.emitCCTTriggerEvent()),this._needEmitCCTEvents&&this.emitCCTCollisionEvent()},t.emitCollisionAndTriggerEvent=function(){for(var t=this.contactsDic.getLength();t--;){Bt.push.apply(Bt,j.contacts),j.contacts.length=0;var e=this.contactsDic.getKeyByIndex(t),i=this.contactsDic.getDataByKey(e),s=i.shape0,n=i.shape1;this.oldContactsDic.set(s.id,n.id,i);var o=s.collider,r=n.collider;if(o&&r){if(o.isTrigger||r.isTrigger)this.triggerArrayMat.get(s.id,n.id)?H.type="onTriggerStay":(H.type="onTriggerEnter",this.triggerArrayMat.set(s.id,n.id,!0)),H.impl=i.impl,H.selfCollider=o,H.otherCollider=r,o.emit(H.type,H),H.selfCollider=r,H.otherCollider=o,r.emit(H.type,H),this._needSyncAfterEvents=!0;else{var a=o.attachedRigidBody,l=r.attachedRigidBody;if(a&&l){if(a.isSleeping&&l.isSleeping)continue}else if(!a&&l){if(l.isSleeping)continue}else if(!l&&a&&a.isSleeping)continue;this.collisionArrayMat.get(s.id,n.id)?j.type="onCollisionStay":(j.type="onCollisionEnter",this.collisionArrayMat.set(s.id,n.id,!0));for(var h=0;h<i.contacts.length;h++){var c=i.contacts[h];if(Bt.length>0){var d=Bt.pop();d.impl=c,j.contacts.push(d)}else{var p=new Tt(j);p.impl=c,j.contacts.push(p)}}j.impl=i.impl,j.selfCollider=o,j.otherCollider=r,o.emit(j.type,j),j.selfCollider=r,j.otherCollider=o,r.emit(j.type,j),this._needSyncAfterEvents=!0}null==this.oldContactsDic.get(s.id,n.id)&&this.oldContactsDic.set(s.id,n.id,i)}}for(var _=this.oldContactsDic.getLength();_--;){var u=this.oldContactsDic.getKeyByIndex(_),y=this.oldContactsDic.getDataByKey(u),f=y.shape0,g=y.shape1,m=f.collider,C=g.collider;if(m&&C){var S=m.isTrigger||C.isTrigger;null==this.contactsDic.getDataByKey(u)&&(S?this.triggerArrayMat.get(f.id,g.id)&&(H.type="onTriggerExit",H.selfCollider=m,H.otherCollider=C,m.emit(H.type,H),H.selfCollider=C,H.otherCollider=m,C.emit(H.type,H),this.triggerArrayMat.set(f.id,g.id,!1),this.oldContactsDic.set(f.id,g.id,null),this._needSyncAfterEvents=!0):this.collisionArrayMat.get(f.id,g.id)&&(Bt.push.apply(Bt,j.contacts),j.contacts.length=0,j.type="onCollisionExit",j.selfCollider=m,j.otherCollider=C,m.emit(j.type,j),j.selfCollider=C,j.otherCollider=m,C.emit(j.type,j),this.collisionArrayMat.set(f.id,g.id,!1),this.oldContactsDic.set(f.id,g.id,null),this._needSyncAfterEvents=!0))}}this.contactsDic.reset()},t.emitCCTTriggerEvent=function(){for(var t=this.cctContactsDic.getLength();t--;){var e=this.cctContactsDic.getKeyByIndex(t),i=this.cctContactsDic.getDataByKey(e),s=i.shape,n=i.cct;this.cctOldContactsDic.set(s.id,n.id,i);var o=s.collider,r=n.characterController;o&&r&&(o.isTrigger&&(this.characterControllerArrayMat.get(s.id,n.id)?z.type="onControllerTriggerStay":(z.type="onControllerTriggerEnter",this.characterControllerArrayMat.set(s.id,n.id,!0)),z.impl=i.impl,z.collider=o,z.characterController=r,o.emit(z.type,z),z.collider=o,z.characterController=r,r.emit(z.type,z),this._needSyncAfterEvents=!0),null==this.cctOldContactsDic.get(s.id,n.id)&&this.cctOldContactsDic.set(s.id,n.id,i))}for(var a=this.cctOldContactsDic.getLength();a--;){var l=this.cctOldContactsDic.getKeyByIndex(a),h=this.cctOldContactsDic.getDataByKey(l),c=h.shape,d=h.cct,p=c.collider,_=d.characterController;if(p&&_){var u=p.isTrigger;null==this.cctContactsDic.getDataByKey(l)&&u&&this.characterControllerArrayMat.get(c.id,d.id)&&(z.type="onControllerTriggerExit",z.collider=p,z.characterController=_,p.emit(z.type,z),z.collider=p,z.characterController=_,_.emit(z.type,z),this.characterControllerArrayMat.set(c.id,d.id,!1),this.cctOldContactsDic.set(c.id,d.id,null),this._needSyncAfterEvents=!0)}}this.cctContactsDic.reset()},t.emitCCTCollisionEvent=function(){for(var t=this.cctShapeEventDic.getLength();t--;){var e,i=this.cctShapeEventDic.getKeyByIndex(t),s=this.cctShapeEventDic.getDataByKey(i),n=s.BulletCharacterController,o=s.BulletShape,r=s.worldPos,a=s.worldNormal,l=s.motionDir,h=s.motionLength;Et.controller=n.characterController,Et.collider=o.collider,Et.worldPosition.set(r.x,r.y,r.z),Et.worldNormal.set(a.x,a.y,a.z),Et.motionDirection.set(l.x,l.y,l.z),Et.motionLength=h,null==(e=Et.controller)||e.emit("onControllerColliderHit",Et),this._needSyncAfterEvents=!0}this.cctShapeEventDic.reset()},t.gatherConatactData=function(){for(var t=W.Dispatcher_getNumManifolds(this._dispatcher),e=0;e<t;e++)for(var i=W.Dispatcher_getManifoldByIndexInternal(this._dispatcher,e),s=W.PersistentManifold_getNumContacts(i),n=0;n<s;n++){var o=W.PersistentManifold_getContactPoint(i,n),r=W.ManifoldPoint_getShape0(o),a=W.ManifoldPoint_getShape1(o),l=!1;if(!l){var h=U.getWrapper(r,St.TYPE),c=U.getWrapper(a,St.TYPE);if(h&&c&&(l=!0,h.collider.needTriggerEvent||c.collider.needTriggerEvent||h.collider.needCollisionEvent||c.collider.needCollisionEvent)){var d=this.contactsDic.get(h.id,c.id);d||(d=this.contactsDic.set(h.id,c.id,{shape0:h,shape1:c,contacts:[],impl:i})),d.contacts.push(o)}}if(!l){var p=U.getWrapper(r,St.TYPE),_=U.getWrapper(a,V.CCT_CACHE_NAME);if(p&&_&&(l=!0,p.collider.needTriggerEvent)){var u=this.cctContactsDic.get(p.id,_.id);u||(u=this.cctContactsDic.set(p.id,_.id,{shape:p,cct:_,contacts:[],impl:i})),u.contacts.push(o),l=!0}}if(!l){var y=U.getWrapper(r,V.CCT_CACHE_NAME),f=U.getWrapper(a,St.TYPE);if(f&&y&&(l=!0,f.collider.needTriggerEvent)){var g=this.cctContactsDic.get(f.id,y.id);g||(g=this.cctContactsDic.set(f.id,y.id,{shape:f,cct:y,contacts:[],impl:i})),g.contacts.push(o),l=!0}}}},t._setDebugDrawMode=function(){var t=0;this._debugDrawFlags&O.WIRE_FRAME&&(t|=N.DBG_DrawWireframe),this._debugDrawFlags&O.CONSTRAINT&&(t|=N.DBG_DrawConstraints,t|=N.DBG_DrawConstraintLimits),this._debugDrawFlags&O.AABB&&(t|=N.DBG_DrawAabb),W.DebugDraw_setDebugMode(this._debugDraw,t)},t._getDebugRenderer=function(){var t,e=null==(t=n.root.mainWindow)?void 0:t.cameras;return e?0===e.length?null:e[0]?(e[0].initGeometryRenderer(),e[0].geometryRenderer):null:null},t.onDebugDrawLine=function(t,e,i){var s=this._getDebugRenderer();s&&this._debugLineCount<this._MAX_DEBUG_LINE_COUNT&&(this._debugLineCount++,ot(vt,t),ot(wt,e),ot(Dt,i),bt.set(255*Dt.x,255*Dt.y,255*Dt.z,255),s.addLine(vt,wt,bt))},t.onClearLines=function(){this._debugLineCount=0},c(e,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){this._debugDrawFlags=t,this._debugDraw&&this._setDebugDrawMode()}},{key:"debugDrawConstraintSize",get:function(){return this._debugConstraintSize},set:function(t){this._debugConstraintSize=t;for(var e=0;e<this.constraints.length;e++)this.constraints[e].updateDebugDrawSize()}}]),e}();At._sweepBoxGeometry=void 0,At._sweepSphereGeometry=void 0,At._sweepCapsuleGeometry=void 0;var Mt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.updateSize=function(){var t=U.instance.BT_V3_0;nt(t,this.getMinUnscaledHalfExtents(x)),W.BoxShape_setUnscaledHalfExtents(this.impl,t),this.updateCompoundTransform()},i.onComponentSet=function(){var t=U.instance.BT_V3_0;nt(t,this.getMinUnscaledHalfExtents(x)),this._impl=W.BoxShape_new(t),this.updateScale()},i.updateScale=function(){t.prototype.updateScale.call(this);var e=U.instance.BT_V3_0;W.CollisionShape_setLocalScaling(this._impl,nt(e,this.getMinScale(x))),this.updateCompoundTransform()},i.getMinUnscaledHalfExtents=function(t){var e=this.collider.size,i=P(x.set(this._collider.node.worldScale)),s=o.instance.minVolumeSize,n=e.x/2,r=e.y/2,a=e.z/2,l=n*i.x<s?s/i.x:n,h=r*i.y<s?s/i.y:r,c=a*i.z<s?s/i.z:a;return t.set(l,h,c),t},i.getMinScale=function(t){var e=this.collider.size,i=P(x.set(this._collider.node.worldScale)),s=o.instance.minVolumeSize,n=e.x/2,r=e.y/2,a=e.z/2,l=n*i.x<s?s/n:i.x,h=r*i.y<s?s/r:i.y,c=a*i.z<s?s/a:i.z;return t.set(l,h,c),t},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Ot=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.updateRadius=function(){W.SphereShape_setUnscaledRadius(this.impl,this.getMinUnscaledRadius()),this.updateCompoundTransform()},i.onComponentSet=function(){this._impl=W.SphereShape_new(this.getMinUnscaledRadius()),this.updateScale()},i.updateScale=function(){t.prototype.updateScale.call(this);var e=this.getMinScale();Y.set(e,e,e);var i=U.instance.BT_V3_0;W.CollisionShape_setLocalScaling(this._impl,nt(i,Y)),this.updateCompoundTransform()},i.getMinUnscaledRadius=function(){var t=this.collider.radius,e=Math.abs(S(this._collider.node.worldScale)),i=o.instance.minVolumeSize;return e*t<i?i/e:t},i.getMinScale=function(){var t=this.collider.radius,e=Math.abs(S(this._collider.node.worldScale)),i=o.instance.minVolumeSize;return e*t<i?i/t:e},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Rt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},i.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},i.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},i.onComponentSet=function(){this._impl=W.CapsuleShape_new(.5,1),this.setRadius(this.collider.radius)},i.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},i.updateProperties=function(t,e,i,s){var n,o,r=s,a=i;1===a?(n=t*Math.abs(T(r.x,r.z)),o=e/2*Math.abs(r.y)):0===a?(n=t*Math.abs(T(r.y,r.z)),o=e/2*Math.abs(r.x)):(n=t*Math.abs(T(r.x,r.y)),o=e/2*Math.abs(r.z)),W.CapsuleShape_updateProp(this._impl,n,o,a),this.updateCompoundTransform()},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),It=function(){function t(t,e){this.key=void 0,this.ref=0,this.bulletBvhTriangleMeshShapePtr=void 0,this.btTriangleMeshPtr=0,this.reference=!0,this.key=t,this.btTriangleMeshPtr=W.TriangleMesh_new(),lt(this.btTriangleMeshPtr,e),this.bulletBvhTriangleMeshShapePtr=W.BvhTriangleMeshShape_new(this.btTriangleMeshPtr,!0,!0)}return t.getBulletBvhTriangleMeshShape=function(e,i){var s;return t.BulletBvhTriangleMeshShapeMap.has(e)?(s=t.BulletBvhTriangleMeshShapeMap.get(e)).reference=!0:(s=new t(e,i),t.BulletBvhTriangleMeshShapeMap.set(e,s)),s},t.prototype.destroy=function(){this.bulletBvhTriangleMeshShapePtr&&W._safe_delete(this.bulletBvhTriangleMeshShapePtr,L.EBulletTypeCollisionShape),this.btTriangleMeshPtr&&W._safe_delete(this.btTriangleMeshPtr,L.EBulletTypeTriangleMesh),t.BulletBvhTriangleMeshShapeMap.delete(this.key)},c(t,[{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();It.BulletBvhTriangleMeshShapeMap=new Map;var Gt,Ft,xt=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];return(e=t.call.apply(t,[this].concat(s))||this).btBVHMeshShape=null,e.refBtTriangleMesh=0,e}p(e,t);var i=e.prototype;return i.setMesh=function(t){if(this._isInitialized){this._impl&&U.isNotEmptyShape(this._impl)&&(this._compound&&W.CompoundShape_removeChildShape(this._compound,this._impl),W._safe_delete(this._impl,L.EBulletTypeCollisionShape),U.delWrapper(this._impl,St.TYPE),this._impl=0);var e=t;if(e&&e.renderingSubMeshes.length>0){if(this.collider.convex){var i=this._getBtTriangleMesh(e);this._impl=W.ConvexTriangleMeshShape_new(i)}else this.btBVHMeshShape=It.getBulletBvhTriangleMeshShape(e.hash,e),this._impl=W.ScaledBvhTriangleMeshShape_new(this.btBVHMeshShape.bulletBvhTriangleMeshShapePtr,1,1,1);var s=U.instance.BT_V3_0;nt(s,this._collider.node.worldScale),W.CollisionShape_setLocalScaling(this._impl,s),W.CollisionShape_setMargin(this._impl,.01),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=W.EmptyShape_static()}},i.onComponentSet=function(){this.setMesh(this.collider.mesh)},i.onDestroy=function(){this.collider.convex?this.refBtTriangleMesh&&W._safe_delete(this.refBtTriangleMesh,L.EBulletTypeTriangleMesh):this.btBVHMeshShape&&(this.btBVHMeshShape.reference=!1),t.prototype.onDestroy.call(this)},i.updateScale=function(){t.prototype.updateScale.call(this);var e=U.instance.BT_V3_0;nt(e,this._collider.node.worldScale),W.CollisionShape_setLocalScaling(this._impl,e),this.updateCompoundTransform()},i._getBtTriangleMesh=function(t){return this.refBtTriangleMesh=W.TriangleMesh_new(),lt(this.refBtTriangleMesh,t),this.refBtTriangleMesh},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Pt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.onComponentSet=function(){var t=U.instance.BT_V3_0;W.Vec3_set(t,.5,1,.5),this._impl=W.CylinderShape_new(t),this.setRadius(this.collider.radius)},i.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},i.updateProperties=function(t,e,i,s){var n,o,r=s,a=i;1===a?(o=e*Math.abs(r.y),n=t*Math.abs(T(r.x,r.z))):0===a?(o=e*Math.abs(r.x),n=t*Math.abs(T(r.y,r.z))):(o=e*Math.abs(r.z),n=t*Math.abs(T(r.x,r.y))),W.CylinderShape_updateProp(this._impl,n,o/2,a),this.updateCompoundTransform()},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Lt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i.onComponentSet=function(){this._impl=W.ConeShape_new(.5,1),this.setRadius(this.collider.radius)},i.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},i.updateProperties=function(t,e,i,s){var n,o,r=s,a=i;1===a?(o=e*Math.abs(r.y),n=t*Math.abs(T(r.x,r.z))):0===a?(o=e*Math.abs(r.x),n=t*Math.abs(T(r.y,r.z))):(o=e*Math.abs(r.z),n=t*Math.abs(T(r.x,r.y))),W.ConeShape_setRadius(this._impl,n),W.ConeShape_setHeight(this._impl,o),W.ConeShape_setConeUpIndex(this._impl,a);var l=U.instance.BT_V3_0;W.Vec3_set(l,1,1,1),W.CollisionShape_setLocalScaling(this._impl,l),this.updateCompoundTransform()},c(e,[{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}}]),e}(St),kt=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];return(e=t.call.apply(t,[this].concat(s))||this)._bufPtr=0,e._tileSize=0,e._localOffset=new f,e}p(e,t);var i=e.prototype;return i.setTerrain=function(t){if(this._isInitialized)if(this._impl&&U.isNotEmptyShape(this._impl))_("[Physics][Bullet]: change the terrain asset after initialization is not support.");else{var e=t;if(e){this._tileSize=e.tileSize;var i=e.getVertexCountI(),s=e.getVertexCountJ();this._bufPtr=W._malloc(4*i*s);for(var n=0,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,a=0;a<s;a++)for(var l=0;l<i;l++){var h=e.getHeight(l,a);W._write_f32(this._bufPtr+n,h),o>h&&(o=h),h>r&&(r=h),n+=4}r+=.01,o-=.01,this._localOffset.set((i-1)/2*this._tileSize,(r+o)/2,(s-1)/2*this._tileSize),this._impl=W.TerrainShape_new(i,s,this._bufPtr,1,o,r);var c=U.instance.BT_V3_0;W.Vec3_set(c,this._tileSize,1,this._tileSize),W.CollisionShape_setLocalScaling(this._impl,c),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=W.EmptyShape_static()}},i.onComponentSet=function(){this.setTerrain(this.collider.terrain)},i.onDestroy=function(){this._bufPtr&&W._free(this._bufPtr),t.prototype.onDestroy.call(this)},i.setCenter=function(t){f.copy(Y,t),Y.add(this._localOffset),nt(W.Transform_getOrigin(this.transform),Y),this.updateCompoundTransform()},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Nt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setShapeType=function(){},i.setVertices=function(){},i.onComponentSet=function(){this._impl=W.SimplexShape_new();for(var t=this.collider.shapeType,e=this.collider.vertices,i=U.instance.BT_V3_0,s=0;s<t;s++)W.SimplexShape_addVertex(this._impl,nt(i,e[s]));W.CollisionShape_setLocalScaling(this._impl,nt(i,this._collider.node.worldScale))},i.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},i.updateScale=function(){t.prototype.updateScale.call(this);var e=U.instance.BT_V3_0;W.CollisionShape_setLocalScaling(this._impl,nt(e,this._collider.node.worldScale))},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Wt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setNormal=function(t){nt(W.StaticPlaneShape_getPlaneNormal(this.impl),t),this.updateCompoundTransform()},i.setConstant=function(t){W.StaticPlaneShape_setPlaneConstant(this.impl,t),this.updateCompoundTransform()},i.updateScale=function(){t.prototype.updateScale.call(this);var e=U.instance.BT_V3_0;nt(e,this._collider.node.worldScale),W.CollisionShape_setLocalScaling(this._impl,e),this.updateCompoundTransform()},i.onComponentSet=function(){var t=U.instance.BT_V3_0;nt(t,this.collider.normal),this._impl=W.StaticPlaneShape_new(t,this.collider.constant),this.updateScale()},c(e,[{key:"collider",get:function(){return this._collider}}]),e}(St),Vt=function(){function t(){this.dirty=0,this.index=-1,this._impl=0,this._com=void 0,this._rigidBody=void 0,this._connectedBody=null,this._collided=!1}var e=t.prototype;return e.setConnectedBody=function(t){if(this._connectedBody!==t){var e=this._connectedBody;e&&e.body.sharedBody.removeJoint(this,1);var i=this._rigidBody.body.sharedBody;i.removeJoint(this,0),this._impl&&(i.wrappedWorld.removeConstraint(this),W._safe_delete(this._impl,L.EBulletTypeTypedConstraint)),this._connectedBody=t;var s=this._connectedBody;this.onComponentSet(),this.setEnableCollision(this._collided),i.wrappedWorld.addConstraint(this),i.addJoint(this,0),s&&s.body.sharedBody.addJoint(this,1)}},e.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},e.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._connectedBody=t.connectedBody,this._collided=t.enableCollision,this.onComponentSet(),this.setEnableCollision(this._collided)},e.updateDebugDrawSize=function(){if(this.impl){var t=o.instance.physicsWorld.debugDrawConstraintSize;W.TypedConstraint_setDbgDrawSize(this.impl,t)}},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var e=this._connectedBody;e&&e.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var e=this._connectedBody;e&&e.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){W._safe_delete(this._impl,L.EBulletTypeTypedConstraint),this._com=null,this._rigidBody=null,this._connectedBody=null},c(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),Ht=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setPivotA=function(){var t=this.constraint,e=U.instance.BT_V3_0;f.multiply(Y,t.node.worldScale,t.pivotA),nt(e,Y),W.P2PConstraint_setPivotA(this._impl,e),t.connectedBody||this.setPivotB(t.pivotB)},i.setPivotB=function(){var t=this.constraint,e=this._rigidBody.node,i=U.instance.BT_V3_0,s=t.connectedBody;s?(f.multiply(Y,s.node.worldScale,t.pivotB),nt(i,Y)):(f.multiply(Y,e.worldScale,t.pivotA),f.transformQuat(Y,Y,e.worldRotation),f.add(Y,Y,e.worldPosition),nt(i,Y)),W.P2PConstraint_setPivotB(this._impl,i)},i.onComponentSet=function(){var t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:W.TypedConstraint_getFixedBody(),s=U.instance.BT_V3_0,n=U.instance.BT_V3_1;this._impl=W.P2PConstraint_new(e,i,s,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.updateDebugDrawSize()},i.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},i.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},c(e,[{key:"constraint",get:function(){return this._com}}]),e}(Vt),jt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setBreakForce=function(t){W.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},i.setBreakTorque=function(){},i.onComponentSet=function(){var t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:W.TypedConstraint_getFixedBody(),s=U.instance.BT_TRANSFORM_0,n=U.instance.BT_TRANSFORM_1;this._impl=W.FixedConstraint_new(e,i,s,n),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()},i.updateFrames=function(){var t=this.constraint.connectedBody,e=this._rigidBody.body.sharedBody,i=Y,s=Z,n=W.Transform_new(),o=W.Transform_new(),r=W.Quat_new(0,0,0,1),a=X;if(m.fromRT(a,e.node.worldRotation,e.node.worldPosition),m.invert(a,a),m.getRotation(s,a),m.getTranslation(i,a),nt(W.Transform_getOrigin(n),i),rt(r,s),W.Transform_setRotation(n,r),t){var l=t.body.sharedBody;m.fromRT(a,l.node.worldRotation,l.node.worldPosition),m.invert(a,a),m.getRotation(s,a),m.getTranslation(i,a),nt(W.Transform_getOrigin(o),i),rt(r,s),W.Transform_setRotation(o,r)}else W.Transform_setIdentity(o);W.FixedConstraint_setFrames(this._impl,n,o),W._safe_delete(n,L.EBulletTypeTransform),W._safe_delete(o,L.EBulletTypeTransform),W._safe_delete(r,L.EBulletTypeQuat)},i.updateScale0=function(){this.updateFrames()},i.updateScale1=function(){this.updateFrames()},c(e,[{key:"constraint",get:function(){return this._com}}]),e}(Vt),zt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.setPivotA=function(){this.updateFrames()},i.setPivotB=function(){this.updateFrames()},i.setAxis=function(){this.updateFrames()},i.setLimitEnabled=function(){this.constraint.limitEnabled?W.HingeConstraint_setLimit(this._impl,B(this.constraint.lowerLimit),B(this.constraint.upperLimit),.9,.3,1):W.HingeConstraint_setLimit(this._impl,1,0,.9,.3,1)},i.setLowerLimit=function(){this.constraint.limitEnabled&&W.HingeConstraint_setLimit(this._impl,B(this.constraint.lowerLimit),B(this.constraint.upperLimit),.9,.3,1)},i.setUpperLimit=function(){this.constraint.limitEnabled&&W.HingeConstraint_setLimit(this._impl,B(this.constraint.lowerLimit),B(this.constraint.upperLimit),.9,.3,1)},i.setMotorEnabled=function(t){W.HingeConstraint_enableMotor(this._impl,t);var e=-this.constraint.motorVelocity/60,i=ht(this.constraint.motorForceLimit,o.instance.fixedTimeStep);W.HingeConstraint_setMotorVelocity(this._impl,e),W.HingeConstraint_setMaxMotorImpulse(this._impl,i)},i.setMotorVelocity=function(t){if(this.constraint.motorEnabled){var e=-t/60;W.HingeConstraint_setMotorVelocity(this._impl,e)}},i.setMotorForceLimit=function(t){if(this.constraint.motorEnabled){var e=ht(t,o.instance.fixedTimeStep);W.HingeConstraint_setMaxMotorImpulse(this._impl,e)}},i.onComponentSet=function(){var t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:W.TypedConstraint_getFixedBody(),s=U.instance.BT_TRANSFORM_0,n=U.instance.BT_TRANSFORM_1;this._impl=W.HingeConstraint_new(e,i,s,n),this.setLimitEnabled(this.constraint.limitEnabled),this.setLowerLimit(this.constraint.lowerLimit),this.setUpperLimit(this.constraint.upperLimit),this.setMotorEnabled(this.constraint.motorEnabled),this.setMotorVelocity(this.constraint.motorVelocity),this.setMotorForceLimit(this.constraint.motorForceLimit),this.updateFrames(),this.updateDebugDrawSize()},i.updateFrames=function(){var t=this.constraint,e=t.node,i=Y,s=Z,n=K,o=U.instance.BT_TRANSFORM_0;f.multiply(i,e.worldScale,t.pivotA),nt(W.Transform_getOrigin(o),i);var r=U.instance.BT_QUAT_0;f.normalize(i,t.axis),g.rotationTo(n,f.UNIT_Z,i),rt(r,n),W.Transform_setRotation(o,r);var a=U.instance.BT_TRANSFORM_1,l=this.constraint.connectedBody;l?(f.multiply(i,l.node.worldScale,t.pivotB),g.multiply(n,e.worldRotation,n),g.invert(s,l.node.worldRotation),g.multiply(n,s,n)):(f.multiply(i,e.worldScale,t.pivotA),f.transformQuat(i,i,e.worldRotation),f.add(i,i,e.worldPosition),g.multiply(n,e.worldRotation,n)),nt(W.Transform_getOrigin(a),i),rt(r,n),W.Transform_setRotation(a,r),W.HingeConstraint_setFrames(this._impl,o,a)},i.updateScale0=function(){this.updateFrames()},i.updateScale1=function(){this.updateFrames()},c(e,[{key:"constraint",get:function(){return this._com}}]),e}(Vt);!function(t){t[t.RO_XYZ=0]="RO_XYZ",t[t.RO_XZY=1]="RO_XZY",t[t.RO_YXZ=2]="RO_YXZ",t[t.RO_YZX=3]="RO_YZX",t[t.RO_ZXY=4]="RO_ZXY",t[t.RO_ZYX=5]="RO_ZYX"}(Gt||(Gt={})),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z",t[t.TWIST=3]="TWIST",t[t.SWING1=4]="SWING1",t[t.SWING2=5]="SWING2"}(Ft||(Ft={}));var Ut=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i._setLimit=function(t,e,i,s){switch(t){case R.LOCKED:W.Generic6DofSpring2Constraint_setLimit(this._impl,e,0,0);break;case R.LIMITED:W.Generic6DofSpring2Constraint_setLimit(this._impl,e,i,s);break;case R.FREE:W.Generic6DofSpring2Constraint_setLimit(this._impl,e,1,0)}},i.setConstraintMode=function(t,e){var i=this.constraint.linearLimitSettings,s=this.constraint.angularLimitSettings,n=[0,0,0],o=[0,0,0],r=0,a=0;switch(t){case 0:case 1:case 2:f.toArray(n,i.lower),f.toArray(o,i.upper),a=n[t],r=o[t];break;case 3:a=-(r=.5*B(s.twistExtent));break;case 4:a=-(r=.5*B(s.swingExtent1));break;case 5:a=-(r=.5*B(s.swingExtent2));break;default:h("idx should be in [0, 5], but give "+t)}this._setLimit(e,t,a,r)},i.setLinearLimit=function(t,e,i){var s=0,n=this.constraint.linearLimitSettings;switch(t){case 0:s=n.xMotion;break;case 1:s=n.yMotion;break;case 2:s=n.zMotion}this._setLimit(s,t,e,i)},i.setAngularExtent=function(t,e,i){var s=this.constraint.angularLimitSettings;this._setLimit(s.twistMotion,Ft.TWIST,.5*-B(t),.5*B(t)),this._setLimit(s.swingMotion1,Ft.SWING1,.5*-B(e),.5*B(e)),this._setLimit(s.swingMotion2,Ft.SWING2,.5*-B(i),.5*B(i))},i.setSwingSoftConstraint=function(t){W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.SWING1,t),W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.SWING2,t)},i.setTwistSoftConstraint=function(t){W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.TWIST,t)},i.setLinearSoftConstraint=function(t){W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.X,t),W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.Y,t),W.Generic6DofSpring2Constraint_enableSpring(this._impl,Ft.Z,t)},i.setLinearStiffness=function(t){W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.X,t),W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.Y,t),W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.Z,t)},i.setLinearDamping=function(t){W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.X,t),W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.Y,t),W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.Z,t)},i.setLinearRestitution=function(t){W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.X,t),W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.Y,t),W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.Z,t)},i.setSwingStiffness=function(t){W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.SWING1,t),W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.SWING2,t)},i.setSwingDamping=function(t){W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.SWING1,t),W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.SWING2,t)},i.setSwingRestitution=function(t){W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.SWING1,t),W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.SWING2,t)},i.setTwistStiffness=function(t){W.Generic6DofSpring2Constraint_setStiffness(this._impl,Ft.TWIST,t)},i.setTwistDamping=function(t){W.Generic6DofSpring2Constraint_setDamping(this._impl,Ft.TWIST,t)},i.setTwistRestitution=function(t){W.Generic6DofSpring2Constraint_setBounce(this._impl,Ft.TWIST,t)},i.setDriverMode=function(t,e){e===I.DISABLED?W.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!1):e===I.SERVO?(W.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),W.Generic6DofSpring2Constraint_setServo(this._impl,t,!0)):e===I.INDUCTION&&(W.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),W.Generic6DofSpring2Constraint_setServo(this._impl,t,!1))},i._updateMotorTargetAndVelocity=function(t){var e=I.DISABLED,i=0,s=0,n=0,o=this.constraint.linearDriverSettings,r=this.constraint.angularDriverSettings;switch(t){case 0:i=Ft.X,e=o.xDrive,s=o.targetPosition.x,n=-o.targetVelocity.x;break;case 1:i=Ft.Y,e=o.yDrive,s=o.targetPosition.y,n=-o.targetVelocity.y;break;case 2:i=Ft.Z,e=o.zDrive,s=o.targetPosition.z,n=-o.targetVelocity.z;break;case 3:i=Ft.TWIST,e=r.twistDrive,s=-B(r.targetOrientation.x),n=-B(r.targetVelocity.x);break;case 4:i=Ft.SWING1,e=r.swingDrive1,s=-B(r.targetOrientation.y),n=-B(r.targetVelocity.y);break;case 5:i=Ft.SWING2,e=r.swingDrive2,s=-B(r.targetOrientation.z),n=-B(r.targetVelocity.z)}var a=t>2?r.strength:o.strength;W.Generic6DofSpring2Constraint_setServoTarget(this._impl,i,s),e===I.SERVO?t>2?W.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,-s*a*.1):W.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,s*a*.1):e===I.INDUCTION&&W.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,n)},i.setLinearMotorTarget=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},i.setLinearMotorVelocity=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},i.setLinearMotorForceLimit=function(t){W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.X,t),W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.Y,t),W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.Z,t)},i.setAngularMotorTarget=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},i.setAngularMotorVelocity=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},i.setAngularMotorForceLimit=function(t){W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.TWIST,t),W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.SWING1,t),W.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,Ft.SWING2,t)},i.setPivotA=function(){this.updateFrames()},i.setPivotB=function(){this.updateFrames()},i.setAutoPivotB=function(){this.updateFrames()},i.setAxis=function(){this.updateFrames()},i.setSecondaryAxis=function(){this.updateFrames()},i.setBreakForce=function(){var t=ht(Math.max(this.constraint.breakForce,this.constraint.breakTorque),o.instance.fixedTimeStep);W.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},i.setBreakTorque=function(){var t=ht(Math.max(this.constraint.breakForce,this.constraint.breakTorque),o.instance.fixedTimeStep);W.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},i.onComponentSet=function(){var t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t&&t.body.impl||W.TypedConstraint_getFixedBody(),s=U.instance.BT_TRANSFORM_0,n=U.instance.BT_TRANSFORM_1;this._impl=W.Generic6DofSpring2Constraint_new(e,i,s,n,Gt.RO_YZX);var o=this.constraint.linearLimitSettings,r=this.constraint.angularLimitSettings;this.setConstraintMode(0,o.xMotion),this.setConstraintMode(1,o.yMotion),this.setConstraintMode(2,o.zMotion),this.setConstraintMode(3,r.twistMotion),this.setConstraintMode(4,r.swingMotion1),this.setConstraintMode(5,r.swingMotion2),this.setLinearSoftConstraint(o.enableSoftConstraint),this.setLinearStiffness(o.stiffness),this.setLinearDamping(o.damping),this.setLinearRestitution(o.restitution),this.setSwingSoftConstraint(r.enableSoftConstraintSwing),this.setSwingRestitution(r.swingRestitution),this.setSwingStiffness(r.swingStiffness),this.setSwingDamping(r.swingDamping),this.setTwistSoftConstraint(r.enableSoftConstraintTwist),this.setTwistRestitution(r.twistRestitution),this.setTwistStiffness(r.twistStiffness),this.setTwistDamping(r.twistDamping);var a=this.constraint.linearDriverSettings,l=this.constraint.angularDriverSettings;this.setDriverMode(0,a.xDrive),this.setDriverMode(1,a.yDrive),this.setDriverMode(2,a.zDrive),this.setDriverMode(3,l.twistDrive),this.setDriverMode(4,l.swingDrive1),this.setDriverMode(5,l.swingDrive2),this.setLinearMotorTarget(a.targetPosition),this.setLinearMotorVelocity(a.targetVelocity),this.setLinearMotorForceLimit(a.strength),this.setAngularMotorTarget(l.targetOrientation),this.setAngularMotorVelocity(l.targetVelocity),this.setAngularMotorForceLimit(l.strength),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()},i.updateFrames=function(){var t=this.constraint,e=t.node,i=Y,s=Z,n=K,o=W.Transform_new();f.multiply(i,e.worldScale,t.pivotA),nt(W.Transform_getOrigin(o),i);var r=W.Quat_new(0,0,0,1),a=t.axis,l=t.secondaryAxis,h=f.cross(J,a,l);m.set(X,a.x,a.y,a.z,0,l.x,l.y,l.z,0,h.x,h.y,h.z,0,0,0,0,1).getRotation(s),rt(r,s),W.Transform_setRotation(o,r);var c=W.Transform_new(),d=this.constraint.connectedBody;d?(g.multiply(s,e.worldRotation,s),g.invert(n,d.node.worldRotation),g.multiply(s,n,s),t.autoPivotB?(f.multiply(i,t.node.worldScale,t.pivotA),f.transformQuat(i,i,e.worldRotation),f.add(i,i,t.node.worldPosition),f.subtract(i,i,d.node.worldPosition),f.transformQuat(i,i,n)):f.multiply(i,d.node.worldScale,t.pivotB)):(f.multiply(i,e.worldScale,t.pivotA),f.transformQuat(i,i,e.worldRotation),f.add(i,i,e.worldPosition),g.multiply(s,e.worldRotation,s)),nt(W.Transform_getOrigin(c),i),rt(r,s),W.Transform_setRotation(c,r),W.Generic6DofSpring2Constraint_setFrames(this._impl,o,c),W._safe_delete(o,L.EBulletTypeTransform),W._safe_delete(c,L.EBulletTypeTransform),W._safe_delete(r,L.EBulletTypeQuat)},i.updateScale0=function(){this.updateFrames()},i.updateScale1=function(){this.updateFrames()},c(e,[{key:"constraint",get:function(){return this._com}}]),e}(Vt),Yt=new f(0,0,0),Jt=new f(0,0,0);new f(0,0,0);var Qt=function(){function t(){this.wrappedWorld=void 0,this._isEnabled=!1,this._impl=0,this._comp=null,this._btCollisionFlags=0,this._word3=0,this._dirty=!1,this._collisionFilterGroup=E.DEFAULT,this._collisionFilterMask=-1,this.id=t.idCounter++,this.wrappedWorld=o.instance.physicsWorld}var e=t.prototype;return e.onComponentSet=function(){},e.updateScale=function(){},e.initialize=function(t){this._comp=t;var e=this._comp.group,i=o.instance.collisionMatrix[e];return this._collisionFilterGroup=e,this._collisionFilterMask=i,this.onComponentSet(),0!==this._impl||(h("[Physics]: Initialize BulletCharacterController failed"),!1)},e.setWrapper=function(){U.setWrapper(this._impl,V.CCT_CACHE_NAME,this);var t=W.CharacterController_getCollisionShape(this.impl);U.setWrapper(t,V.CCT_CACHE_NAME,this)},e.onEnable=function(){this._isEnabled=!0,this._impl||this.onComponentSet(),this.setDetectCollisions(!1),this.setOverlapRecovery(!0),o.instance.physicsWorld.addCCT(this),this.setWrapper()},e.onDisable=function(){this._isEnabled=!1,this.wrappedWorld.removeCCT(this),this.onDestroy()},e.onDestroy=function(){W._safe_delete(this._impl,L.EBulletTypeCharacterController),U.delWrapper(this._impl,V.CCT_CACHE_NAME),this._impl=0},e.onLoad=function(){},e.getPosition=function(t){this._impl&&ot(t,W.CharacterController_getPosition(this.impl))},e.setPosition=function(t){this._impl&&(nt(W.CharacterController_getPosition(this.impl),t),this.syncPhysicsToScene())},e.setContactOffset=function(t){this._impl&&W.CharacterController_setContactOffset(this._impl,t)},e.setStepOffset=function(t){this._impl&&W.CharacterController_setStepOffset(this._impl,t)},e.setSlopeLimit=function(t){this._impl&&W.CharacterController_setSlopeLimit(this._impl,u(t))},e.setDetectCollisions=function(t){this._impl&&W.CharacterController_setCollision(this.impl,t)},e.setOverlapRecovery=function(t){this._impl&&W.CharacterController_setOverlapRecovery(this.impl,t)},e.onGround=function(){return(4&this._btCollisionFlags)>0},e.syncSceneToPhysics=function(){var t=this.characterController.node;t.hasChangedFlags&&(t.hasChangedFlags&b.SCALE&&this.syncScale(),t.hasChangedFlags&b.POSITION&&(f.add(Yt,t.worldPosition,this.scaledCenter),this.setPosition(Yt)))},e.syncPhysicsToScene=function(){this.getPosition(Yt),Yt.subtract(this.scaledCenter),this._comp.node.setWorldPosition(Yt)},e.syncScale=function(){this.updateScale()},e.move=function(t,e,i){if(this._isEnabled){var s=U.instance.BT_V3_0;W.Vec3_set(s,t.x,t.y,t.z),this._btCollisionFlags=W.CharacterController_move(this.impl,s,e,i)}},e.setGroup=function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this._dirty=!0)},e.getGroup=function(){return this._collisionFilterGroup},e.addGroup=function(t){this._collisionFilterGroup|=t,this._dirty=!0},e.removeGroup=function(t){this._collisionFilterGroup&=~t,this._dirty=!0},e.setMask=function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this._dirty=!0)},e.getMask=function(){return this._collisionFilterMask},e.addMask=function(t){this._collisionFilterMask|=t,this._dirty=!0},e.removeMask=function(t){this._collisionFilterMask&=~t,this._dirty=!0},e.updateEventListener=function(){this.wrappedWorld.updateNeedEmitCCTEvents(this.characterController.needCollisionEvent)},e.updateDirty=function(){this._dirty&&(o.instance.physicsWorld.removeCCT(this),o.instance.physicsWorld.addCCT(this),this._dirty=!1)},e.onShapeHitExt=function(t){var e=W.ControllerShapeHit_getHitShape(t),i=o.instance.physicsWorld;i.cctShapeEventDic.get(this.impl,e);var s=new f;ot(s,W.ControllerHit_getHitWorldPos(t));var n=new f;ot(n,W.ControllerHit_getHitWorldNormal(t));var r=new f;ot(r,W.ControllerHit_getHitMotionDir(t));var a=W.ControllerHit_getHitMotionLength(t),l=U.getWrapper(e,St.TYPE);l&&i.cctShapeEventDic.set(this.impl,e,{BulletCharacterController:this,BulletShape:l,worldPos:s,worldNormal:n,motionDir:r,motionLength:a})},c(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._impl}},{key:"characterController",get:function(){return this._comp}},{key:"scaledCenter",get:function(){return f.multiply(Jt,this._comp.center,this._comp.node.worldScale),Jt}}]),t}();Qt.idCounter=0;var Zt=new f(0,0,0),Kt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.onComponentSet=function(){this.component.node.getWorldPosition(Zt),Zt.add(this.scaledCenter);var t=U.instance.BT_V3_0;W.Vec3_set(t,Zt.x,Zt.y,Zt.z);var e=f.UNIT_Y,i=U.instance.BT_V3_1;W.Vec3_set(i,e.x,e.y,e.z);var s=W.ControllerHitReport.implement(_t).$$.ptr,n=o.instance.physicsWorld,r=W.CapsuleCharacterControllerDesc_new(u(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,i,t,s,this.component.radius,this.component.height);this._impl=W.CapsuleCharacterController_new(n.impl,r,0),this.updateScale()},i.setRadius=function(){this.updateScale()},i.setHeight=function(){this.updateScale()},i.updateScale=function(){this.updateGeometry()},i.updateGeometry=function(){var t=this.component.node.worldScale,e=this.component.radius*T(t.x,t.z),i=this.component.height*Math.abs(t.y);W.CapsuleCharacterController_setRadius(this.impl,e),W.CapsuleCharacterController_setHeight(this.impl,i),this._dirty=!0},c(e,[{key:"component",get:function(){return this._comp}}]),e}(Qt),Xt=new f(0,0,0),qt=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var i=e.prototype;return i.onComponentSet=function(){this.component.node.getWorldPosition(Xt),Xt.add(this.scaledCenter);var t=U.instance.BT_V3_0;W.Vec3_set(t,Xt.x,Xt.y,Xt.z);var e=f.UNIT_Y,i=U.instance.BT_V3_1;W.Vec3_set(i,e.x,e.y,e.z);var s=W.ControllerHitReport.implement(_t).$$.ptr,n=o.instance.physicsWorld,r=W.BoxCharacterControllerDesc_new(u(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,i,t,s,this.component.halfHeight,this.component.halfSideExtent,this.component.halfForwardExtent);this._impl=W.BoxCharacterController_new(n.impl,r,0),this.updateScale()},i.setHalfHeight=function(){this.updateScale()},i.setHalfSideExtent=function(){this.updateScale()},i.setHalfForwardExtent=function(){this.updateScale()},i.updateScale=function(){this.updateGeometry()},i.updateGeometry=function(){var t=this.component.node.worldScale;W.BoxCharacterController_setHalfSideExtent(this.impl,this.component.halfSideExtent*t.x),W.BoxCharacterController_setHalfHeight(this.impl,this.component.halfHeight*t.y),W.BoxCharacterController_setHalfForwardExtent(this.impl,this.component.halfForwardExtent*t.z),this._dirty=!0},c(e,[{key:"component",get:function(){return this._comp}}]),e}(Qt);i.once(s.EVENT_PRE_SUBSYSTEM_INIT,(function(){a.register("bullet",{PhysicsWorld:At,RigidBody:pt,BoxShape:Mt,SphereShape:Ot,CapsuleShape:Rt,TrimeshShape:xt,CylinderShape:Pt,ConeShape:Lt,TerrainShape:kt,SimplexShape:Nt,PlaneShape:Wt,PointToPointConstraint:Ht,HingeConstraint:zt,FixedConstraint:jt,ConfigurableConstraint:Ut,BoxCharacterController:qt,CapsuleCharacterController:Kt})}))}}}));
//# sourceMappingURL=physics-ammo.js.map
