System.register(["./gc-object-BD6DANSw.js","./_virtual_internal_constants-CVZmBipG.js","./mesh-renderer-B_2j2ns-.js","./prefab-CJahvMeV.js","./create-mesh-CgNcAxLl.js","./debug-view-zRQBd5E1.js","./scene-D5fG1En6.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./pipeline-state-manager-C4BAah3w.js","./node-event-BDYemSfE.js","./index-BcjqSS2q.js","./global-exports-ZavlJGEN.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./mesh-BsaPYlYJ.js","./wasm-web-DpHjq6qw.js","./zlib.min-CyXMsivM.js","./deprecated-BaebfHhU.js","./deprecated-BfPl6EQ2.js","./model-renderer-KnEZ5pPV.js","./renderer-DVTO-7-w.js","./touch-Ch03mDFP.js"],(function(t){"use strict";var e,i,s,r,a,n,o,h,l,u,c,_,f,d,v,m,p,g,S,w,R,E,D,x,P,b,y,T;return{setters:[function(t){e=t.a,i=t._,s=t.s,r=t.S,a=t.d,n=t.w},null,function(t){o=t.M},null,function(t){h=t._},null,function(t){l=t.N,u=t.b},function(t){c=t.d},function(t){_=t.T,f=t.d,d=t.e,v=t.F,m=t.f},function(t){p=t.L},null,function(t){g=t.c,S=t.m,w=t.n,R=t.C,E=t.S},function(t){D=t.c,x=t.a},function(t){P=t.G,b=t.g},function(t){y=t.d,T=t.D},null,null,null,null,null,null,null,null],execute:function(){var N,F=function(){function t(t,e,i){this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}var i=t.prototype;return i.sample=function(t){this._average(this._value,t)},i.human=function(){var t=this._opts,e=t.average,i=t.isInteger,s=e?this._averageValue:this._value;return i?Math.round(s):Math.round(100*s)/100},i.alarm=function(){return void 0!==this._opts.below&&this._value<this._opts.below||void 0!==this._opts.over&&this._value>this._opts.over},i._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}},e(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),A=g("cc.PerfCounter")(N=function(t){function e(e,i,s){var r;return(r=t.call(this,e,i,s)||this)._time=s,r}i(e,t);var s=e.prototype;return s.start=function(t){void 0===t&&(t=0),this._time=t},s.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},s.tick=function(){this.end(),this.start()},s.frame=function(t){var e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))},e}(F))||N,j="0123456789. ",C=500,I={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},H={fps:{desc:"Framerate (FPS)",below:30,average:C,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:C},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:C,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:C},render:{desc:"Renderer (ms)",min:0,max:50,average:C,color:"#f90"},present:{desc:"Present (ms)",min:0,max:50,average:C,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},M=t("Profiler",function(t){function g(){var e;return(e=t.call(this)||this)._profilerStats=null,e._showFPS=!1,e._rootNode=null,e._device=null,e._swapchain=null,e._meshRenderer=null,e._canvas=null,e._ctx=null,e._texture=null,e._region=new m,e._canvasArr=[],e._regionArr=[e._region],e.digitsData=null,e.offsetData=null,e.pass=null,e._canvasDone=!1,e._statsDone=!1,e._inited=!1,e._lineHeight=280/(Object.keys(H).length+1),e._wordHeight=0,e._eachNumWidth=0,e._totalLines=0,e.lastTime=0,e._backgroundColor=new R(150,150,150,100),e._fontColor=R.WHITE.clone(),e}i(g,t);var E=g.prototype;return E.init=function(){s.querySettings(r.PROFILING,"showFPS")?this.showStats():this.hideStats()},E.setBackgroundColor=function(t){this._backgroundColor.equals(t)||(this._backgroundColor.set(t),this._showFPS&&(this.hideStats(),this.showStats()))},E.setFontColor=function(t){this._fontColor.equals(t)||(this._fontColor.set(t),this._showFPS&&(this.hideStats(),this.showStats()))},E.isShowingStats=function(){return this._showFPS},E.hideStats=function(){var t=this;if(t._showFPS){t._profilerStats=null,t._rootNode&&(t._rootNode.destroy(),t._rootNode=null),t._device=null,t._swapchain=null;var e,i,s=t._meshRenderer;s&&(null==(e=s.sharedMaterial)||e.destroy(),null==(i=s.mesh)||i.destroy(),s.destroy(),t._meshRenderer=null),t._canvas=null,t._ctx=null,t._texture&&(t._texture.destroy(),t._texture=null),t._canvasArr.length=0,t.digitsData=null,t.offsetData=null,t.pass=null,t._canvasDone=!1,t._statsDone=!1,t._inited=!1,t._wordHeight=0,t._eachNumWidth=0,t._totalLines=0,t.lastTime=0,y.off(T.BEFORE_UPDATE,t.beforeUpdate,t),y.off(T.AFTER_UPDATE,t.afterUpdate,t),y.off(T.BEFORE_PHYSICS,t.beforePhysics,t),y.off(T.AFTER_PHYSICS,t.afterPhysics,t),y.off(T.BEFORE_DRAW,t.beforeDraw,t),y.off(T.AFTER_RENDER,t.afterRender,t),y.off(T.AFTER_DRAW,t.afterPresent,t),t._showFPS=!1,y.root.pipeline.profiler=null,D.game.config.showFPS=!1}},E.showStats=function(){var t=D.game;if(!this._showFPS){if(this._canvas=x.document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas),!this._device){var e=D.director.root;this._device=c.gfxDevice,this._swapchain=e.mainWindow.swapchain}this.generateCanvas(),this.generateStats(),t.once(P.EVENT_ENGINE_INITED,this.generateNode,this),t.on(P.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),y.on(T.BEFORE_UPDATE,this.beforeUpdate,this),y.on(T.AFTER_UPDATE,this.afterUpdate,this),y.on(T.BEFORE_PHYSICS,this.beforePhysics,this),y.on(T.AFTER_PHYSICS,this.afterPhysics,this),y.on(T.BEFORE_DRAW,this.beforeDraw,this),y.on(T.AFTER_RENDER,this.afterRender,this),y.on(T.AFTER_DRAW,this.afterPresent,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,t.config.showFPS=!0}},E.generateCanvas=function(){if(!this._canvasDone){var t=this._canvas,e=this._ctx;if(e&&t){t.width=280,t.height=280,t.style.width=""+t.width,t.style.height=""+t.height,e.font="23px Arial",e.textBaseline="top";var i=this._fontColor;e.fillStyle="rgba("+i.r+", "+i.g+", "+i.b+", "+i.a/255+")",this._texture=this._device.createTexture(new _(f.TEX2D,d.SAMPLED|d.TRANSFER_DST,v.RGBA8,280,280));var s=this._region.texExtent;s.width=280,s.height=280}}},E.generateStats=function(){var t=this._canvas,e=this._ctx;if(!this._statsDone&&e&&t){this._profilerStats=null;var i=performance.now();e.textAlign="left";var s=0;for(var r in H){var a=H[r];e.fillText(a.desc,0,s*this._lineHeight),a.counter=new A(r,a,i),s++}this._totalLines=s,this._wordHeight=this._totalLines*this._lineHeight/t.height;var n=0;for(n=0;n<12;++n){var o=e.measureText(j[n]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(n=0;n<12;++n)e.fillText(j[n],n*this._eachNumWidth,this._totalLines*this._lineHeight);var h=this._backgroundColor;e.fillStyle="rgba("+h.r+", "+h.g+", "+h.b+", "+h.a/255+")",e.fillRect(t.width-4,t.height-4,4,4),this._eachNumWidth/=t.width,this._profilerStats=H,this._canvasArr[0]=t,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},E.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){var t=this._canvas;this._rootNode=new l("PROFILER_NODE"),this._rootNode._objFlags=a.DontSave|a.HideInHierarchy,b.addPersistRootNode(this._rootNode);var e=new l("Profiler_Root");e.parent=this._rootNode;var i=.4,s=i/this._totalLines,r=i/this._wordHeight,n=s/23,c=this._eachNumWidth*t.width*n,_=r+8*c,f=[-c,i+c,0,_+c,i+c,0,_+c,-c,0,-c,-c,0],d=[0,2,1,0,3,2],v=(t.width-3)/t.width,m=(t.height-3)/t.height,g=(t.width-1)/t.width,S=(t.height-1)/t.width,w=[v,m,-1,0,g,m,-1,0,g,S,-1,0,v,S,-1,0];f.push(0,i,0,r,i,0,r,0,0,0,0,0),d.push(4,6,5,4,7,6),w.push(0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0);for(var R=0,E=0;E<this._totalLines;E++)for(var D=0;D<8;D++){f.push(r+D*c,i-E*s,0),f.push(r+(D+1)*c,i-E*s,0),f.push(r+(D+1)*c,i-(E+1)*s,0),f.push(r+D*c,i-(E+1)*s,0),R=4*(8*E+D+2),d.push(0+R,2+R,1+R,0+R,3+R,2+R);var x=8*E+D,P=Math.floor(x/4),y=x-4*P;w.push(0,this._wordHeight,P,y),w.push(this._eachNumWidth,this._wordHeight,P,y),w.push(this._eachNumWidth,1,P,y),w.push(0,1,P,y)}this._meshRenderer=e.addComponent(o),this._meshRenderer.mesh=h({positions:f,indices:d,colors:w});var T=new u;T.initialize({effectName:"util/profiler"});var N=this.pass=T.passes[0],F=N.getBinding("mainTexture"),A=N.getBinding("digits"),j=N.getBinding("offset");N.bindTexture(F,this._texture),this.digitsData=N.blocks[A],this.offsetData=N.blocks[j],this.offsetData[3]=-1,this._meshRenderer.material=T,this._meshRenderer.node.layer=p.Enum.PROFILER,this._inited=!0}},E.beforeUpdate=function(){var t=this._profilerStats;if(t){var e=performance.now();t.frame.counter.start(e),t.logic.counter.start(e)}},E.afterUpdate=function(){var t=this._profilerStats;if(t){var e=performance.now();y.isPaused()?t.frame.counter.start(e):t.logic.counter.end(e)}},E.beforePhysics=function(){if(this._profilerStats){var t=performance.now();this._profilerStats.physics.counter.start(t)}},E.afterPhysics=function(){if(this._profilerStats){var t=performance.now();this._profilerStats.physics.counter.end(t)}},E.beforeDraw=function(){if(this._profilerStats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var i=S[t],s=-.9,r=-.9*e;w.isXR&&(s=-.5,r=-.5*e),this.offsetData[0]=s*i[0]+r*i[2],this.offsetData[1]=s*i[1]+r*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass.setRootBufferDirty(!0),this._meshRenderer.model?y.root.pipeline.profiler=this._meshRenderer.model:y.root.pipeline.profiler=null;var a=performance.now();this._profilerStats.render.counter.start(a)}},E.afterRender=function(){var t=this._profilerStats;if(t&&this._inited){var e=performance.now();t.render.counter.end(e),t.present.counter.start(e)}},E.afterPresent=function(){var t=this._profilerStats;if(t&&this._inited){var e=performance.now();if(t.frame.counter.end(e),t.fps.counter.frame(e),t.present.counter.end(e),!(e-this.lastTime<C)){this.lastTime=e;var i=this._device;t.draws.counter.value=i.numDrawCalls,t.instances.counter.value=i.numInstances,t.bufferMemory.counter.value=i.memoryStatus.bufferSize/1048576,t.textureMemory.counter.value=i.memoryStatus.textureSize/1048576,t.tricount.counter.value=i.numTris;var s=0,r=this.digitsData;for(var a in t){var n=t[a];n.counter.sample(e);for(var o=n.counter.human().toString(),h=7;h>=0;h--){var l=8*s+h,u=o[o.length-(8-h)],c=I[u];void 0===c&&(c=11),r[l]=c}s++}}}},e(g,[{key:"_stats",get:function(){return n(16381),this._profilerStats}},{key:"stats",get:function(){return this._profilerStats}}]),g}(E)),W=t("profiler",new M);y.registerSystem("profiler",W,0),D.profiler=W}}}));
//# sourceMappingURL=profiler.js.map
