System.register(["./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js","./sprite-frame-CT0e6iHI.js","./sprite-8ksyG6DL.js","./label-PJV2Zpvv.js","./prefab-CJahvMeV.js","./scene-D5fG1En6.js","./pipeline-state-manager-C4BAah3w.js","./node-event-BDYemSfE.js","./sprite-renderer-CC0tdWTR.js","./ui-renderer-BG8n0rhU.js","./sorting-2d-CIasnD0H.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./deprecated-gv6rCJsk.js","./director-D6Xf3-Ej.js","./debug-view-zRQBd5E1.js","./deprecated-BaebfHhU.js","./create-mesh-CgNcAxLl.js","./mesh-BsaPYlYJ.js","./wasm-web-DpHjq6qw.js","./zlib.min-CyXMsivM.js","./touch-Ch03mDFP.js","./camera-component-DK1ym1MK.js","./deprecated-B2PZGYTz.js","./model-renderer-KnEZ5pPV.js","./renderer-DVTO-7-w.js","./sorting-layers-sC9IxUEk.js","./deprecated-BfPl6EQ2.js"],(function(t){"use strict";var e,i,n,s,o,r,a,l,h,u,c,_,f,d,g,p,m,y,v,x,C,b,T,S,A,L,O,I,H,z,W,E,R,j,k,F;return{setters:[function(t){e=t.a4,i=t._,n=t.H,s=t.w,o=t.a,r=t.b,a=t.d},function(t){l=t.V,h=t.c,u=t.t,c=t.C,_=t.a,f=t.K,d=t.j,g=t.s},null,function(t){p=t.c},null,function(t){m=t.S,y=t.b},function(t){v=t.o,x=t.L,t.T,C=t.t,b=t.u,T=t.f,S=t.a,A=t.c,L=t.e,O=t.i,I=t.H,H=t.n,z=t.V,W=t.k},null,function(t){E=t.N},null,function(t){R=t.N,j=t.C},null,function(t){k=t.c},function(t){F=t.S},null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],execute:function(){var D,P,w,U,X,N,M,V,G,B,Y,q,K,J,Q,Z,$,tt,et,it,nt,st,ot,rt,at,lt,ht=new v,ut="RICHTEXT_CHILD",ct="RICHTEXT_Image_CHILD",_t=new l,ft=new l,dt=new e((function(t){if(!p.isValid(t.node))return!1;var e=t.node.getComponent(x);return e&&(e.outlineWidth=0),!0}),20),gt=new e((function(t){return p.isValid(t.node)}),10);function pt(t){return{node:new E(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function mt(t,e,i){var n;t===ut?n=dt._get():t===ct&&(n=gt._get());var s=(n=n||pt(t)).node;s||(s=new E(t)),s.hideFlags|=a.DontSave|a.HideInHierarchy,s.active=!0,t===ct?(n.comp=s.getComponent(m)||s.addComponent(m),n.comp.spriteFrame=e,n.comp.type=m.Type.SLICED,n.comp.sizeMode=m.SizeMode.CUSTOM):(n.comp=s.getComponent(x)||s.addComponent(x),n.comp.string=e,n.comp.horizontalAlign=I.LEFT,n.comp.verticalAlign=z.TOP,n.comp.underlineHeight=2);var o=i.getComponent(F);if(o){var r=s.getComponent(F)||s.addComponent(F);r.sortingLayer=o.sortingLayer,r.sortingOrder=o.sortingOrder}return s.setPosition(0,0,0),s._getUITransformComp().setAnchorPoint(.5,.5),n.node=s,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var yt=t("RichText",(D=h("cc.RichText"),P=f(k),w=d(110),U=u(I),X=u(z),N=u(c),M=u(H),V=u(W),G=u(y),D(B=P(B=w((lt=function(t){function e(){var e;return(e=t.call(this)||this)._lineHeight=q&&q(),e._string=K&&K(),e._horizontalAlign=J&&J(),e._verticalAlign=Q&&Q(),e._fontSize=Z&&Z(),e._fontColor=$&&$(),e._maxWidth=tt&&tt(),e._fontFamily=et&&et(),e._font=it&&it(),e._isSystemFontUsed=nt&&nt(),e._userDefinedFont=st&&st(),e._cacheMode=ot&&ot(),e._imageAtlas=rt&&rt(),e._handleTouchEvent=at&&at(),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._labelChildrenNum=0,e._updateRichTextStatus=e._updateRichText,e}i(e,t);var r=e.prototype;return r.onLoad=function(){this.node.on(R.LAYER_CHANGED,this._applyLayer,this),this.node.on(R.ANCHOR_CHANGED,this._updateRichTextPosition,this)},r.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},r.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},r.onRestore=function(){},r.onDestroy=function(){this._segments.forEach((function(t){t.node.removeFromParent(),t.type===ut?dt.put(t):t.type===ct&&gt.put(t)})),this.node.off(R.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(R.LAYER_CHANGED,this._applyLayer,this)},r._addEventListeners=function(){this.node.on(R.TOUCH_END,this._onTouchEnded,this)},r._removeEventListeners=function(){this.node.off(R.TOUCH_END,this._onTouchEnded,this)},r._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},r._createFontLabel=function(t){return mt(ut,t,this.node)},r._createImage=function(t){return mt(ct,t,this.node)},r._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},r.splitLongStringApproximatelyIn2048=function(t,e){var i=[];if(t.length*this.fontSize<=1638.4)return i.push(t),i;if(this._calculateSize(_t,e,t),_t.x<2048)i.push(t);else for(var n=t.split("\n"),s=0;s<n.length;s++)if(this._calculateSize(_t,e,n[s]),_t.x<2048)i.push(n[s]);else{var o=this.splitLongStringOver2048(n[s],e);i.push.apply(i,o)}return i},r.splitLongStringOver2048=function(t,e){var i=[],n=t,s=0,o=n.length/2,r=n.substring(s,o),a=n.substring(o),l=this._calculateSize(_t,e,r),h=this._calculateSize(ft,e,a),u=this._maxWidth;0===this._maxWidth&&(u=2047.9);for(var c=1*u;l.x>c;){if((o/=2)<1){o*=2;break}r=r.substring(s,o),a=n.substring(o),this._calculateSize(l,e,r)}for(var _=1e3,f=1;_&&s<t.length;){for(;_&&l.x<c;){var d=C(a);d&&d.length>0&&(f=d[0].length),o+=f,r=n.substring(s,o),a=n.substring(o),this._calculateSize(l,e,r),_--}for(;_&&r.length>=2&&l.x>c;)o-=f,r=n.substring(s,o),this._calculateSize(l,e,r),f=1,_--;if(r.length>=2){var g=b(r);g&&g.length>0&&r!==g[0]&&(o-=g[0].length,r=n.substring(s,o))}if(i.push(r),s=o,o+=r.length,r=n.substring(s,o),a=n.substring(o),this._calculateSize(h,e,a),this._calculateSize(l,e,r),_--,h.x<2048&&l.x<c){i.push(r),s=t.length,o=t.length,r=a,""!==a&&i.push(r);break}}return i},r._measureText=function(t,e){var i=this,n=function(e){return i._calculateSize(_t,t,e).x};return e?n(e):n},r._calculateSize=function(t,e,i){var n;0===this._labelSegmentsCache.length?(n=this._createFontLabel(i),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0]).node.getComponent(x).string=i,n.styleIndex=e,this._applyTextAttribute(n);var s=n.node._getUITransformComp().contentSize;return l.set(t,s.x,s.y),t},r._onTouchEnded=function(t){var e=this,i=this.node.getComponents(j);this._segments.forEach((function(n){var s=n.clickHandler,o=n.clickParam;s&&e._containsTouchLocation(n,t.touch.getUILocation())&&(i.forEach((function(e){var i=e[s];e.enabledInHierarchy&&i&&i.call(e,t,o)})),t.propagationStopped=!0)}))},r._containsTouchLocation=function(t,e){var i=t.node.getComponent(k);return!!i&&i.getBoundingBoxToWorld().contains(e)},r._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var i=t[e];if(i.name===ut||i.name===ct){n(i.parent===this.node),i.parent=null;var s=pt(i.name);s.node=i,i.name===ut?(s.comp=i.getComponent(x),dt.put(s)):(s.comp=i.getComponent(m),gt.put(s)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},r._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var i=this.node.children[e];i.name!==ut&&i.name!==ct||(i.active=t)}},r._addLabelSegment=function(t,e){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(x);n&&(n.string=t)}var s=i.comp;return s.verticalAlign!==this._verticalAlign&&(s.verticalAlign=this._verticalAlign),i.styleIndex=e,i.lineCount=this._lineCount,i.node._getUITransformComp().setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.insertChild(i.node,this._labelChildrenNum++),this._applyTextAttribute(i),this._segments.push(i),i},r._updateRichTextWithMaxWidth=function(t,e,i){var n=e;if(this._lineOffsetX>0&&n+this._lineOffsetX>this._maxWidth)for(var s=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,s,t.length),r=t.substr(s,o),a=this._measureText(i,r);if(!(this._lineOffsetX+a<=this._maxWidth)){if(s>0){var l=t.substr(0,s);this._addLabelSegment(l,i),t=t.substr(s,t.length),n=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=a,s+=o}if(n>this._maxWidth)for(var h=T(t,n,this._maxWidth,this._measureText(i)),u=0;u<h.length;++u){var c=h[u],_=this._addLabelSegment(c,i).node._getUITransformComp().contentSize;this._lineOffsetX+=_.width,h.length>1&&u<h.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(t,i)},r._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},r._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},r._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var i=this._textArray[e],n=t[e];if(i.text!==n.text)return!0;var s=i.style,o=n.style;if(s){if(o){if(!!o.outline!=!!s.outline)return!0;if(s.size!==o.size||s.italic!==o.italic||s.isImage!==o.isImage)return!0;if(s.src!==o.src||s.imageAlign!==o.imageAlign||s.imageHeight!==o.imageHeight||s.imageWidth!==o.imageWidth||s.imageOffset!==o.imageOffset)return!0}else if(s.size||s.italic||s.isImage||s.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},r._addRichTextImageElement=function(t){if(t.style){var e=t.style,i=e.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){var o=this._createImage(n),r=o.node._getUITransformComp();switch(e.imageAlign){case"top":r.setAnchorPoint(0,1);break;case"center":r.setAnchorPoint(0,.5);break;default:r.setAnchorPoint(0,0)}e.imageOffset&&(o.imageOffset=e.imageOffset),o.node.layer=this.node.layer,this.node.insertChild(o.node,this._labelChildrenNum++),this._segments.push(o);var a=n.rect.clone(),l=1,h=a.width,u=a.height,c=e.imageWidth||0,_=e.imageHeight||0;_>0?(h*=l=_/u,u*=l):(h*=l=this._lineHeight/u,u*=l),c>0&&(h=c),this._maxWidth>0?(this._lineOffsetX+h>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=h):(this._lineOffsetX+=h,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.setContentSize(h,u),o.lineCount=this._lineCount,o.clickHandler="",o.clickParam="";var f=e.event;f&&(o.clickHandler=f.click,o.clickParam=f.param)}else s(4400)}},r._updateTextDefaultColor=function(){for(var t=0;t<this._segments.length;++t){var e,i,n=this._segments[t],s=n.node.getComponent(x);s&&(null!=(e=this._textArray[n.styleIndex])&&null!=(i=e.style)&&i.color||(s.color=this._fontColor))}},r._updateRichText=function(){if(this.enabledInHierarchy){var t=ht.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,i=!1,n=0;n<this._textArray.length;++n){var s=this._textArray[n],o=s.text;if(void 0!==o){if(""===o){if(s.style&&s.style.isNewLine){this._updateLineInfo();continue}if(s.style&&s.style.isImage&&this._imageAtlas){this._addRichTextImageElement(s);continue}}for(var r=(o=this.splitLongStringApproximatelyIn2048(o,n).join("\n")).split("\n"),a=0;a<r.length;++a){var l=r[a];if(""!==l)if(i=!1,this._maxWidth>0){var h=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,h,n),r.length>1&&a<r.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(l,n),this._lineOffsetX+=e.node._getUITransformComp().width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&a<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&a===r.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+S)*this._lineHeight,this.node._getUITransformComp().setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},r._getFirstWordLen=function(t,e,i){var n=A(t,e);if(L(n)||O(n))return 1;for(var s=1,o=e+1;o<i&&(n=A(t,o),!O(n)&&!L(n));++o)s++;return s},r._updateRichTextPosition=function(){for(var t=0,e=1,i=this._lineCount,n=this.node._getUITransformComp(),s=n.anchorX,o=n.anchorY,r=0;r<this._segments.length;++r){var a=this._segments[r],l=a.lineCount;l>e&&(t=0,e=l);var h=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case I.LEFT:break;case I.CENTER:h-=this._linesWidth[l-1]/2;break;case I.RIGHT:h-=this._linesWidth[l-1]}var u=a.node,c=u.position;if(u.setPosition(t+h,this._lineHeight*(i-l)-this._labelHeight*o,c.z),l===e&&(t+=u._getUITransformComp().width),u.getComponent(m)){var _=u.position.clone(),f=this._lineHeight,d=this._lineHeight*(1+S);switch(u._getUITransformComp().anchorY){case 1:_.y+=f+(d-f)/2;break;case.5:_.y+=d/2;break;default:_.y+=(d-f)/2}if(a.imageOffset){var g=a.imageOffset.split(",");if(1===g.length&&g[0]){var p=parseFloat(g[0]);Number.isInteger(p)&&(_.y+=p)}else if(2===g.length){var y=parseFloat(g[0]),v=parseFloat(g[1]);Number.isInteger(y)&&(_.x+=y),Number.isInteger(v)&&(_.y+=v)}}u.position=_}var C=u.getComponent(x);if(C&&C.enableOutline){var b=u.position.clone();b.y-=C.outlineWidth,u.position=b}}},r._convertLiteralColorValue=function(t){var e=t.toUpperCase();return c[e]?c[e]:(new c).fromHEX(t)},r._applyTextAttribute=function(t){var e=t.node.getComponent(x);if(e){this._resetLabelState(e);var i,n=t.styleIndex;if(this._textArray[n]&&(i=this._textArray[n].style),i){i.color?e.color=this._convertLiteralColorValue(i.color):e.color=this._fontColor,e.isBold=!!i.bold,e.isItalic=!!i.italic,e.isUnderline=!!i.underline,i.outline&&(e.enableOutline=!0,e.outlineColor=this._convertLiteralColorValue(i.outline.color),e.outlineWidth=i.outline.width),e.fontSize=i.size||this._fontSize,t.clickHandler="",t.clickParam="";var s=i.event;s&&(t.clickHandler=s.click||"",t.clickParam=s.param||"")}e.cacheMode=this._cacheMode,this._font instanceof H&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0)}},r._applyLayer=function(){var t=this;this._segments.forEach((function(e){e.node.layer=t.node.layer}))},r._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=this._fontColor,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},o(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontColor",get:function(){return this._fontColor},set:function(t){this._fontColor!==t&&(this._fontColor=t,this._updateTextDefaultColor())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}(j),lt.HorizontalAlign=I,lt.VerticalAlign=z,r((Y=lt).prototype,"horizontalAlign",[U],Object.getOwnPropertyDescriptor(Y.prototype,"horizontalAlign"),Y.prototype),r(Y.prototype,"verticalAlign",[X],Object.getOwnPropertyDescriptor(Y.prototype,"verticalAlign"),Y.prototype),r(Y.prototype,"fontColor",[N],Object.getOwnPropertyDescriptor(Y.prototype,"fontColor"),Y.prototype),r(Y.prototype,"font",[M],Object.getOwnPropertyDescriptor(Y.prototype,"font"),Y.prototype),r(Y.prototype,"cacheMode",[V],Object.getOwnPropertyDescriptor(Y.prototype,"cacheMode"),Y.prototype),r(Y.prototype,"imageAtlas",[G],Object.getOwnPropertyDescriptor(Y.prototype,"imageAtlas"),Y.prototype),q=_(Y.prototype,"_lineHeight",[g],(function(){return 40})),K=_(Y.prototype,"_string",[g],(function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"})),J=_(Y.prototype,"_horizontalAlign",[g],(function(){return I.LEFT})),Q=_(Y.prototype,"_verticalAlign",[g],(function(){return z.TOP})),Z=_(Y.prototype,"_fontSize",[g],(function(){return 40})),$=_(Y.prototype,"_fontColor",[g],(function(){return c.WHITE.clone()})),tt=_(Y.prototype,"_maxWidth",[g],(function(){return 0})),et=_(Y.prototype,"_fontFamily",[g],(function(){return"Arial"})),it=_(Y.prototype,"_font",[g],(function(){return null})),nt=_(Y.prototype,"_isSystemFontUsed",[g],(function(){return!0})),st=_(Y.prototype,"_userDefinedFont",[g],(function(){return null})),ot=_(Y.prototype,"_cacheMode",[g],(function(){return W.NONE})),rt=_(Y.prototype,"_imageAtlas",[g],(function(){return null})),at=_(Y.prototype,"_handleTouchEvent",[g],(function(){return!0})),B=Y))||B)||B)||B));p.RichText=yt}}}));
//# sourceMappingURL=rich-text.js.map
