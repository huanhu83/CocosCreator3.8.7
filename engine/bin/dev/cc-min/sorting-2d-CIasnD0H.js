System.register(["./sorting-layers-sC9IxUEk.js","./gc-object-BD6DANSw.js","./index-BcjqSS2q.js","./_virtual_internal_constants-CVZmBipG.js","./global-exports-ZavlJGEN.js","./node-event-BDYemSfE.js","./ui-renderer-BG8n0rhU.js","./scene-D5fG1En6.js","./device-manager-BCOP-4pU.js","./buffer-barrier-CZBuOw0V.js","./pipeline-state-manager-C4BAah3w.js","./debug-view-zRQBd5E1.js","./deprecated-BaebfHhU.js","./deprecated-BfPl6EQ2.js"],(function(e){"use strict";var t,r,s,a,i,n,h,c,l,o,u,_,d,f,p,g,S,m,y,v,M,B,D,x,R,b,C,E,T,w,I,H,L,A,k,O,F,P,V,N,U,j,X,G,q,z,Q;return{setters:[function(e){t=e.S},function(e){r=e.a,s=e.R,a=e.j,i=e.H,n=e.l,h=e.a5,c=e.P,l=e._,o=e.w,u=e.b},function(e){_=e.g,d=e.b,f=e.M,p=e.a7,g=e.N,S=e.c,m=e.t,y=e.d,v=e.a,M=e.K,B=e.s},null,function(e){D=e.c},function(e){x=e.C},function(e){R=e.n,b=e.d,C=e.a,E=e.j,T=e.S,w=e.e,I=e.p,H=e.U},function(e){L=e.h,A=e.d,k=e.b},function(e){O=e.d},function(e){F=e.c,P=e.B,V=e.b,N=e.M,U=e.P,j=e.ax},function(e){X=e.L,G=e.M,q=e.c},function(e){z=e.g},function(e){Q=e.M},null],execute:function(){e("f",(function(e,t,r,s){if(r){var a=r.chunk,i=r.data,n=a.vb,h=r.vertexCount,c=e.worldMatrix,l=c.m00,o=c.m01,u=c.m02,d=c.m03,f=c.m04,p=c.m05,g=c.m06,S=c.m07,m=c.m12,y=c.m13,v=c.m14,M=c.m15;W.set(s.r/255,s.g/255,s.b/255,s.a/255);for(var B=0,D=0;D<h;++D){var x=i[D],R=x.x,b=x.y,C=d*R+S*b+M;C=C?1/C:1,n[B+0]=(l*R+f*b+m)*C,n[B+1]=(o*R+p*b+y)*C,n[B+2]=(u*R+g*b+v)*C,_.toArray(n,W,B+5),B+=r.floatStride}a.bufferId;for(var E=a.vertexOffset,T=a.meshBuffer,w=a.meshBuffer.iData,I=T.indexOffset,H=0,L=h/4;H<L;H++){var A=E+4*H;w[I++]=A,w[I++]=A+1,w[I++]=A+2,w[I++]=A+1,w[I++]=A+3,w[I++]=A+2}T.indexOffset+=r.indexCount,T.setDirty()}}));var W=new _;function Y(e,t){if(e.chunk)for(var r,s,a,i,n=e.vertexFormat,h=e.chunk.vb,c=0,l=0;l<n.length;++l){if(s=n[l],(a=F[s.format]).hasAlpha)if(i=e.floatStride,a.size/a.count==1){r||(r=new Uint32Array(h.buffer,h.byteOffset,h.length));for(var o=~~d(Math.round(255*t),0,255),u=c;u<r.length;u+=i)r[u]=(16777215&r[u]|o<<24)>>>0}else if(a.size/a.count==4)for(var _=c+3;_<h.length;_+=i)h[_]=t;c+=a.size>>2}}var Z=X.Enum.NONE|X.Enum.UI_3D,K=e("D",function(){function e(){this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this.visFlags=Z,this.inputAssembler=null,this.descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.inputAssembler=null,this.descriptorSet=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=Z},t.fillPasses=function(e,t,r,s){if(e){var a=e.passes;if(!a)return;this._shaders.length=a.length;for(var i=0;i<a.length;i++){this._passes[i]||(this._passes[i]=new L(D.director.root));var n=a[i],h=this._passes[i];n.update(),t||(t=n.depthStencilState,r=0),h._initPassFromTarget(n,t,r),this._shaders[i]=h.getShaderVariant(s)}}},r(e,[{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),J=0;function $(e){J=e}var ee,te,re,se,ae,ie,ne,he=new j(null),ce=new f,le=new s((function(){return{uiRenderer:null,finalOpacity:0,opacityDirty:!1}}),128),oe=e("B",function(){function e(e){var t=this;this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new k,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currHash=0,this._currIsMiddleware=!1,this._middlewareEnableBatch=!1,this._middlewareBuffer=null,this._middlewareIndexStart=0,this._middlewareIndexCount=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new _e,this._meshDataArray=[],this._maskClearModel=null,this._maskClearMtl=null,this._maskModelMesh=null,this._recordedRendererInfoQueue=[],this._root=e,this.device=e.device,this._batches=new h(64),this._drawBatchPool=new c((function(){return new K}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.getRecordedRendererInfoQueue=function(){return this._recordedRendererInfoQueue},t.initialize=function(){return!0},t.destroy=function(){this._recordedRendererInfoQueue.length=0;for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(var t,r=a(this._bufferAccessors.values());!(t=r()).done;)t.value.destroy();this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),R.sharedManager.destroy(),this._maskClearModel&&this._maskModelMesh&&(D.director.root.destroyModel(this._maskClearModel),this._maskModelMesh.destroy()),this._maskClearMtl&&this._maskClearMtl.destroy()},t.syncRootNodesToNative=function(){},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,r=0;r<t.length;r++){var s=t[r];if(s.visibility&e.layer)return s}return null},t.update=function(){for(var e=this._screens,t=0,r=0;r<e.length;++r){var s=e[r],a=s._getRenderScene();if(s.enabledInHierarchy&&a){this._opacityDirty=0,this._pOpacity=1,this.walk(s.node),J>0&&this._flushRecordedUIRenderers(),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var i=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var n=this._batches.array[t];if(n.model)for(var h=n.model.subModels,c=0;c<h.length;c++)h[c].priority=i++;else n.descriptorSet=this._descriptorSetCache.getDescriptorSet(n);a.addBatch(n)}}}J>0&&le.reset()},t.uploadBuffers=function(){if(this._batches.length>0){for(var e=this._meshDataArray.length,t=0;t<e;t++)this._meshDataArray[t].uploadBuffers();for(var r,s=a(this._bufferAccessors.values());!(r=s()).done;){var i=r.value;i.uploadBuffers(),i.reset()}this._descriptorSetCache.update()}},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}for(var r,s=a(this._bufferAccessors.values());!(r=s()).done;)r.value.reset();for(var i=this._meshDataArray.length,n=0;n<i;n++)this._meshDataArray[n].freeIAPool();this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),R.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=b);var t=e===b?36:C(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var r=this._bufferAccessors.get(t);r||(r=new E(this.device,e),this._bufferAccessors.set(t,r)),this._staticVBBuffer=r,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var r=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=r.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,r,s,a){var n,h=0,c=-1;if(t&&t.chunk){if(!t.isValid())return;h=t.dataHash,n=t.material,c=t.chunk.bufferId}e.stencilStage===T.ENTER_LEVEL||e.stencilStage===T.ENTER_LEVEL_INVERTED?this._insertMaskBatch(e):e.stencilStage=R.sharedManager.stage;var l=e.stencilStage;this._currHash===h&&0!==h&&this._currMaterial===n&&this._currDepthStencilStateStage===l||(this.autoMergeBatches(this._currComponent),t&&!t._isMeshBuffer&&this.updateBuffer(t.vertexFormat,c),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=a,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=l,this._currLayer=e.node.layer,r?(i(r.isValid,"frame should not be invalid, it may have been released"),this._currTexture=r.getGFXTexture(),this._currSampler=r.getGFXSampler(),this._currTextureHash=r.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),s.fillBuffers&&s.fillBuffers(e,this)},t.commitIA=function(e,t,r,s,a){this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var i=null,n=0;e&&(e.stencilStage=R.sharedManager.stage,i=null!==e.customMaterial?R.sharedManager.getStencilStage(e.stencilStage,s):R.sharedManager.getStencilStage(e.stencilStage),n=R.sharedManager.getStencilHash(e.stencilStage));var h=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();h.visFlags=e.node.layer,h.inputAssembler=t,h.useLocalData=a||null,r&&(h.texture=r.getGFXTexture(),h.sampler=r.getGFXSampler(),h.textureHash=r.getHash(),h.samplerHash=h.sampler.hash),h.fillPasses(s||null,i,n,null),this._batches.push(h)},t.commitMiddleware=function(e,t,r,s,a,i,n){var h=a.getGFXTexture();n&&this._middlewareEnableBatch&&this._middlewareBuffer===t&&this._currTexture===h&&this._currMaterial.hash===i.hash&&this._middlewareIndexStart+this._middlewareIndexCount===r&&this._currLayer===e.node.layer?this._middlewareIndexCount+=s:(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._currComponent=e,this._currTexture=h,this._currSampler=a.getGFXSampler(),this._currTextureHash=a.getHash(),this._currLayer=e.node.layer,this._currSamplerHash=this._currSampler.hash,this._currHash=0,this._currTransform=n?null:e.node,this._middlewareEnableBatch=n,this._middlewareBuffer=t,this._currMaterial=i,this._middlewareIndexStart=r,this._middlewareIndexCount=s),this._currIsMiddleware=!0},t.commitModel=function(e,t,r){this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=null,a=0;r&&(e.stencilStage===T.ENTER_LEVEL||e.stencilStage===T.ENTER_LEVEL_INVERTED?this._insertMaskBatch(e):e.stencilStage=R.sharedManager.stage,s=R.sharedManager.getStencilStage(e.stencilStage,r),a=R.sharedManager.getStencilHash(e.stencilStage));var i=D.director.getTotalFrames();t&&(t.updateTransform(i),t.updateUBOs(i));for(var n=0;n<t.subModels.length;n++){var h=this._drawBatchPool.alloc(),c=t.subModels[n];h.visFlags=e.node.layer,h.model=t,h.texture=null,h.sampler=null,h.useLocalData=null,s||(s=null),h.fillPasses(r,s,a,c.patches),h.inputAssembler=c.inputAssembler,h.model.visFlags=h.visFlags,h.descriptorSet=c.descriptorSet,this._batches.push(h)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){if(this._currIsMiddleware)this.mergeBatchesForMiddleware(e);else{var t=this._currMaterial;if(t){var r,s=this._currRenderData,a=this._staticVBBuffer;if(s&&s._isMeshBuffer)r=s.requestIA(this.device),-1===this._meshDataArray.indexOf(s)&&this._meshDataArray.push(s);else if(a){var i=this._currBID,h=a.getMeshBuffer(i);if(!h)return;var c=h.indexOffset-this._indexStart;if(c<=0)return;n(this._indexStart<h.indexOffset),h.setDirty(),(r=h.requireFreeIA(this.device)).firstIndex=this._indexStart,r.indexCount=c,this._indexStart=h.indexOffset}if(this._currBID=-1,r&&this._currTexture){var l=null,o=0;e&&(l=null!==e.customMaterial?R.sharedManager.getStencilStage(e.stencilStage,t):R.sharedManager.getStencilStage(e.stencilStage),o=R.sharedManager.getStencilHash(e.stencilStage));var u=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();u.visFlags=this._currLayer,u.texture=this._currTexture,u.sampler=this._currSampler,u.inputAssembler=r,u.useLocalData=this._currTransform,u.textureHash=this._currTextureHash,u.samplerHash=this._currSamplerHash,u.fillPasses(t,l,o,null),this._batches.push(u)}}}},t.mergeBatchesForMiddleware=function(e){var t,r;e.stencilStage=R.sharedManager.stage,r=null!==e.customMaterial?R.sharedManager.getStencilStage(e.stencilStage,this._currMaterial):R.sharedManager.getStencilStage(e.stencilStage),t=R.sharedManager.getStencilHash(e.stencilStage);var s=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();s.visFlags=e.node.layer;var a=this._middlewareBuffer.requireFreeIA(this.device);a.firstIndex=this._middlewareIndexStart,a.indexCount=this._middlewareIndexCount,s.inputAssembler=a,s.useLocalData=this._currTransform,s.texture=this._currTexture,s.sampler=this._currSampler,s.textureHash=this._currTextureHash,s.samplerHash=this._currSamplerHash,s.fillPasses(this._currMaterial||null,r,t,null),this._batches.push(s),this._currIsMiddleware=!1,this._middlewareBuffer=null},t.forceMergeBatches=function(e,t,r){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=r.node.layer,this.autoMergeBatches(r)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t._handleUIRenderer=function(e,t,r){var s=e?e.renderData:null,a=s?s.vertexCount:0;if(e&&e.enabledInHierarchy&&e.fillBuffers(this),r&&a>0){switch(e.getFillColorType()){case w.COLOR:Y(s,t);case w.VERTEX:}var i=s.getMeshBuffer();i&&i.setDirty()}},t._recordUIRenderer=function(e,t,r){var s=this.getRecordedRendererInfoQueue(),a=le.add();return a.uiRenderer=e,a.finalOpacity=t,a.opacityDirty=r,s.push(a),a},t._flushRecordedUIRenderers=function(){var e=this.getRecordedRendererInfoQueue(),t=e.length;if(0!==t){e.sort((function(e,t){return e.uiRenderer.priority-t.uiRenderer.priority}));for(var r=0;r<t;r++){var s=e[r],a=s.uiRenderer;a&&(this._handleUIRenderer(a,s.finalOpacity,s.opacityDirty),a.enabledInHierarchy&&a.postUpdateAssembler(this)),s.finalOpacity=1,s.opacityDirty=!1,s.uiRenderer=null}e.length=0}},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var r=e.children,s=e._uiProps,a=s.uiComp,i=this._pOpacity,n=i,h=a&&a.color?a.color.a/255:1;this._pOpacity=n*=h*s.localOpacity,s.setOpacity(n);var c=!p(n,0,g);if(c){if(s.colorDirty&&this._opacityDirty++,a&&(J>0?(a.stencilStage!==T.ENTER_LEVEL&&a.stencilStage!==T.ENTER_LEVEL_INVERTED||(this._flushRecordedUIRenderers(),this.autoMergeBatches(this._currComponent),this.resetRenderStates()),this._recordUIRenderer(a,n,!!this._opacityDirty)):this._handleUIRenderer(a,n,!!this._opacityDirty)),r.length>0&&!e._static)for(var l=0;l<r.length;++l){var o=r[l];this.walk(o,t)}s.colorDirty&&(this._opacityDirty--,s.colorDirty=!1)}this._pOpacity=i,a&&a.enabledInHierarchy&&(!c||a.stencilStage!==T.ENTER_LEVEL&&a.stencilStage!==T.ENTER_LEVEL_INVERTED||(J>0&&this._flushRecordedUIRenderers(),R.sharedManager.getMaskStackSize()>0&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),R.sharedManager.exitMask()))),t+=1}},t._screenSort=function(e,t){return e.node.siblingIndex-t.node.siblingIndex},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},t._createClearModel=function(){if(!this._maskClearModel){this._maskClearMtl=A.get("default-clear-stencil"),this._maskClearModel=D.director.root.createModel(Q);var e=C(I),t=O.gfxDevice,r=t.createBuffer(new P(V.VERTEX|V.TRANSFER_DST,N.DEVICE,4*e,e)),s=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(s);var a=t.createBuffer(new P(V.INDEX|V.TRANSFER_DST,N.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),i=new Uint16Array([0,1,2,2,1,3]);a.update(i),this._maskModelMesh=new z([r],I,U.TRIANGLE_LIST,a),this._maskModelMesh.subMeshIdx=0,this._maskClearModel.initSubModel(0,this._maskModelMesh,this._maskClearMtl)}},t._insertMaskBatch=function(e){this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._createClearModel(),this._maskClearModel.node=this._maskClearModel.transform=e.node;var t=R.sharedManager;t.pushMask(1);var r=t.clear(e),s=null,a=0,i=this._maskClearMtl;i&&(s=t.getStencilStage(r,i),a=t.getStencilHash(r));var n=this._maskClearModel,h=D.director.getTotalFrames();n&&(n.updateTransform(h),n.updateUBOs(h));for(var c=0;c<n.subModels.length;c++){var l=this._drawBatchPool.alloc(),o=n.subModels[c];l.visFlags=e.node.layer,l.model=n,l.texture=null,l.sampler=null,l.useLocalData=null,s||(s=null),l.fillPasses(i,s,a,o.patches),l.inputAssembler=o.inputAssembler,l.model.visFlags=l.visFlags,l.descriptorSet=o.descriptorSet,this._batches.push(l)}t.enableMask()},t.syncMeshBuffersToNative=function(){},r(e,[{key:"nativeObj",get:function(){return this._nativeObj}},{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(){}}]),e}()),ue=function(){var e=t.prototype;function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=O.gfxDevice;this._localData=new Float32Array(q.COUNT),this._localBuffer=e.createBuffer(new P(V.UNIFORM|V.TRANSFER_DST,N.HOST|N.DEVICE,q.SIZE,q.SIZE))}return e.getDescriptorSet=function(){return this._descriptorSet},e.initialize=function(e){var t=O.gfxDevice;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,he.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(he),this._descriptorSet.bindBuffer(q.BINDING,this._localBuffer);var r=G.SAMPLER_SPRITE;this._descriptorSet.bindTexture(r,e.texture),this._descriptorSet.bindSampler(r,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(e,t,r){return this._transform===e&&this._textureHash===t&&this._samplerHash===r},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e.isTransformDirty())&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;f.toArray(this._localData,t,q.MAT_WORLD_OFFSET),f.invert(ce,t),f.transpose(ce,ce);var r=f.determinant(ce),s=1/Math.sqrt(r);f.multiplyScalar(ce,ce,s),f.toArray(this._localData,ce,q.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},t}(),_e=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=new c((function(){return new ue}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){if(e.useLocalData){for(var t=this._localDescriptorSetCache,r=0,s=t.length;r<s;r++){var a=t[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.getDescriptorSet()}var i=this._localCachePool.alloc();return i.initialize(e),this._localDescriptorSetCache.push(i),i.getDescriptorSet()}var n=e.textureHash^e.samplerHash;if(this._descriptorSetCache.has(n))return this._descriptorSetCache.get(n);he.layout=e.passes[0].localSetLayout;var h=O.gfxDevice.createDescriptorSet(he),c=G.SAMPLER_SPRITE;return h.bindTexture(c,e.texture),h.bindSampler(c,e.sampler),h.update(),this._descriptorSetCache.set(n,h),this._dsCacheHashByTexture.set(e.textureHash,n),h},t.update=function(){var e=this._localDescriptorSetCache,t=e.length;if(0!==t){for(var r=[],s=0;s<t;s++){var a=e[s];if(a.isValid())a.uploadLocalData();else{a.reset();var i=e.indexOf(a);r.push(i)}}for(var n=r.length-1;n>=0;n--){var h=r[n],c=e[h];e.splice(h,1),this._localCachePool.free(c)}}},t.reset=function(){for(var e=this._localDescriptorSetCache,t=e.length,r=0;r<t;r++){var s=e[r];this._localCachePool.free(s)}this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){for(var e,t=a(this._descriptorSetCache.values());!(e=t()).done;)e.value.destroy();this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();D.internal.Batcher2D=oe;var de=0;e("S",(ee=S("cc.Sorting2D"),te=M(H),re=m(t.Enum),ee(se=y(se=te((ae=function(e){function s(){var t;return(t=e.call(this)||this)._isSorting2DEnabled=!1,t._sortingLayer=ie&&ie(),t._sortingOrder=ne&&ne(),t._uiRenderer=null,t}l(s,e);var a=s.prototype;return a.__preload=function(){this._uiRenderer=this.getComponent(H),this._uiRenderer||o(16300,this.node.name)},a.onEnable=function(){this._isSorting2DEnabled=!0,this._updateSortingPriority(),$(++de)},a.onDisable=function(){this._isSorting2DEnabled=!1,this._updateSortingPriority(),$(--de)},a._updateSortingPriority=function(){var e=this._uiRenderer;if(e&&e.isValid)if(this._isSorting2DEnabled){var r=t.getLayerIndex(this._sortingLayer),s=t.getSortingPriority(r,this._sortingOrder);e.priority=s}else e.priority=t.getDefaultPriority()},r(s,[{key:"sortingLayer",get:function(){return this._sortingLayer},set:function(e){e!==this._sortingLayer&&t.isLayerValid(e)&&(this._sortingLayer=e,this._updateSortingPriority())}},{key:"sortingOrder",get:function(){return this._sortingOrder},set:function(e){e!==this._sortingOrder&&(this._sortingOrder=d(e,-32768,32767),this._updateSortingPriority())}}]),s}(x),u(ae.prototype,"sortingLayer",[re],Object.getOwnPropertyDescriptor(ae.prototype,"sortingLayer"),ae.prototype),ie=v(ae.prototype,"_sortingLayer",[B],(function(){return t.Enum.default})),ne=v(ae.prototype,"_sortingOrder",[B],(function(){return 0})),se=ae))||se)||se)||se))}}}));
//# sourceMappingURL=sorting-2d-CIasnD0H.js.map
