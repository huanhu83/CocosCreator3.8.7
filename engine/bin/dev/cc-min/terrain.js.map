{"version":3,"file":"terrain.js","sources":["../../../cocos/terrain/height-field.ts","../../../cocos/terrain/terrain-lod.ts","../../../cocos/terrain/terrain.ts"],"sourcesContent":["/*\r\n Copyright (c) 2020-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { clamp } from '../core/math';\r\n\r\nexport class HeightField {\r\n    public data: Uint16Array = new Uint16Array();\r\n    public w = 0;\r\n    public h = 0;\r\n\r\n    constructor (w: number, h: number) {\r\n        this.w = w;\r\n        this.h = h;\r\n        this.data = new Uint16Array(w * h);\r\n\r\n        for (let i = 0; i < w * h; ++i) {\r\n            this.data[i] = 0;\r\n        }\r\n    }\r\n\r\n    public set (i: number, j: number, value: number): void {\r\n        this.data[j * this.w + i] = value;\r\n    }\r\n\r\n    public get (i: number, j: number): number {\r\n        return this.data[j * this.w + i];\r\n    }\r\n\r\n    public getClamp (i: number, j: number): number {\r\n        i = clamp(i, 0, this.w - 1);\r\n        j = clamp(j, 0, this.h  - 1);\r\n\r\n        return this.get(i, j);\r\n    }\r\n\r\n    public getAt (x: number, y: number): number {\r\n        const fx = x;\r\n        const fy = y;\r\n\r\n        let ix0 = Math.floor(fx);\r\n        let iz0 = Math.floor(fy);\r\n        let ix1 = ix0 + 1;\r\n        let iz1 = iz0 + 1;\r\n        const dx = fx - ix0;\r\n        const dz = fy - iz0;\r\n\r\n        ix0 = clamp(ix0, 0, this.w - 1);\r\n        iz0 = clamp(iz0, 0, this.h - 1);\r\n        ix1 = clamp(ix1, 0, this.w - 1);\r\n        iz1 = clamp(iz1, 0, this.h - 1);\r\n\r\n        let a = this.get(ix0, iz0);\r\n        const b = this.get(ix1, iz0);\r\n        const c = this.get(ix0, iz1);\r\n        let d = this.get(ix1, iz1);\r\n        const m = (b + c) * 0.5;\r\n\r\n        if (dx + dz <= 1.0) {\r\n            d = m + (m - a);\r\n        } else {\r\n            a = m + (m - d);\r\n        }\r\n\r\n        const h1 = a * (1.0 - dx) + b * dx;\r\n        const h2 = c * (1.0 - dx) + d * dx;\r\n\r\n        const h = h1 * (1.0 - dz) + h2 * dz;\r\n\r\n        return h;\r\n    }\r\n}\r\n","/*\r\n Copyright (c) 2020-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nexport const TERRAIN_LOD_VERTS = 33;\r\nexport const TERRAIN_LOD_TILES = 32;\r\nexport const TERRAIN_LOD_LEVELS = 4;\r\nexport const TERRAIN_LOD_NORTH_INDEX = 0;\r\nexport const TERRAIN_LOD_SOUTH_INDEX = 1;\r\nexport const TERRAIN_LOD_WEST_INDEX = 2;\r\nexport const TERRAIN_LOD_EAST_INDEX = 3;\r\nexport const TERRAIN_LOD_MAX_DISTANCE = 100000000000000.0;\r\n\r\nexport class TerrainLodKey {\r\n    public level = 0;\r\n    public north = 0;\r\n    public south = 0;\r\n    public west = 0;\r\n    public east = 0;\r\n\r\n    public equals (rk: TerrainLodKey): boolean {\r\n        return this.level === rk.level && this.north === rk.north && this.south === rk.south && this.west === rk.west && this.east === rk.east;\r\n    }\r\n}\r\n\r\nexport class TerrainIndexPool {\r\n    public size = 0;\r\n    public indices: Uint16Array|null = null;\r\n}\r\n\r\nexport class TerrainIndexData {\r\n    public key: TerrainLodKey = new TerrainLodKey();\r\n    public start = 0;\r\n    public size = 0;\r\n    public buffer: Uint16Array|null = null;\r\n    public primCount = 0;\r\n}\r\n\r\nexport class TerrainLod {\r\n    public static mapIndex (i: number, j: number, k: number): number {\r\n        return i * (TERRAIN_LOD_LEVELS * TERRAIN_LOD_LEVELS) + j * TERRAIN_LOD_LEVELS + k;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _bodyIndexPool: TerrainIndexPool[];\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _connecterIndexPool: TerrainIndexPool[];\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _indexMap: TerrainIndexData[] = [];\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _indexBuffer: Uint16Array = new Uint16Array();\r\n\r\n    constructor () {\r\n        this._bodyIndexPool = new Array<TerrainIndexPool>(TERRAIN_LOD_LEVELS);\r\n        for (let i = 0; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            this._bodyIndexPool[i] = new TerrainIndexPool();\r\n        }\r\n\r\n        this._connecterIndexPool = new Array<TerrainIndexPool>(TERRAIN_LOD_LEVELS * TERRAIN_LOD_LEVELS * 4);\r\n        for (let i = 0; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            for (let j = 0; j < TERRAIN_LOD_LEVELS; ++j) {\r\n                for (let k = 0; k < 4; ++k) {\r\n                    this._connecterIndexPool[TerrainLod.mapIndex(i, j, k)] = new TerrainIndexPool();\r\n                }\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            this._genBodyIndex(i);\r\n        }\r\n\r\n        for (let i = 0; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            for (let j = 0; j < TERRAIN_LOD_LEVELS; ++j) {\r\n                this._genConnecterIndexNorth(i, j);\r\n                this._genConnecterIndexSouth(i, j);\r\n                this._genConnecterIndexWest(i, j);\r\n                this._genConnecterIndexEast(i, j);\r\n            }\r\n        }\r\n\r\n        const levels = TERRAIN_LOD_LEVELS;\r\n        for (let l = 0; l < levels; ++l) {\r\n            for (let n = 0; n < levels; ++n) {\r\n                if (n < l) {\r\n                    continue;\r\n                }\r\n\r\n                for (let s = 0; s < levels; ++s) {\r\n                    if (s < l) {\r\n                        continue;\r\n                    }\r\n\r\n                    for (let w = 0; w < levels; ++w) {\r\n                        if (w < l) {\r\n                            continue;\r\n                        }\r\n\r\n                        for (let e = 0; e < levels; ++e) {\r\n                            if (e < l) {\r\n                                continue;\r\n                            }\r\n\r\n                            const k = new TerrainLodKey();\r\n                            k.level = l;\r\n                            k.north = n;\r\n                            k.south = s;\r\n                            k.west = w;\r\n                            k.east = e;\r\n                            this._genIndexData(k);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public getIndexData (k: TerrainLodKey): TerrainIndexData | null {\r\n        for (let i = 0; i < this._indexMap.length; ++i) {\r\n            if (this._indexMap[i].key.equals(k)) {\r\n                return this._indexMap[i];\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    private _genBodyIndex (level: number): void {\r\n        const step = 1 << level;\r\n        let tiles = TERRAIN_LOD_TILES >> level;\r\n        let start = 0;\r\n\r\n        if (level < TERRAIN_LOD_LEVELS - 1)  {\r\n            tiles -= 2;\r\n            start = step * TERRAIN_LOD_VERTS + step;\r\n        }\r\n\r\n        if (tiles === 0 || tiles === 0) {\r\n            return;\r\n        }\r\n\r\n        const count = tiles * tiles * 6;\r\n        this._bodyIndexPool[level].indices = new Uint16Array(count);\r\n\r\n        let index = 0;\r\n        const indices = new Uint16Array(count);\r\n\r\n        // generate triangle list cw\r\n        //\r\n        let row_c = start;\r\n        let row_n = row_c + TERRAIN_LOD_VERTS * step;\r\n        for (let y = 0; y < tiles; ++y) {\r\n            for (let x = 0; x < tiles; ++x) {\r\n                /*\r\n                indices[index++] = row_n + x * step;\r\n                indices[index++] = row_c + x * step;\r\n                indices[index++] = row_n + (x + 1) * step;\r\n\r\n                indices[index++] = row_n + (x + 1) * step;\r\n                indices[index++] = row_c + x * step;\r\n                indices[index++] = row_c + (x + 1) * step;\r\n                */\r\n\r\n                indices[index++] = row_n + x * step;\r\n                indices[index++] = row_n + (x + 1) * step;\r\n                indices[index++] = row_c + x * step;\r\n\r\n                indices[index++] = row_n + (x + 1) * step;\r\n                indices[index++] = row_c + (x + 1) * step;\r\n                indices[index++] = row_c + x * step;\r\n            }\r\n\r\n            row_c += TERRAIN_LOD_VERTS * step;\r\n            row_n += TERRAIN_LOD_VERTS * step;\r\n        }\r\n\r\n        this._bodyIndexPool[level].size = index;\r\n        this._bodyIndexPool[level].indices = indices;\r\n    }\r\n\r\n    private _genConnecterIndexNorth (level: number, connecter: number): void {\r\n        const connecterIndex = TerrainLod.mapIndex(level, connecter, TERRAIN_LOD_NORTH_INDEX);\r\n\r\n        if (connecter < level || level === TERRAIN_LOD_LEVELS - 1) {\r\n            this._connecterIndexPool[connecterIndex].size = 0;\r\n            this._connecterIndexPool[connecterIndex].indices = null;\r\n            return;\r\n        }\r\n\r\n        const self_step = 1 << level;\r\n        const neighbor_step = 1 << connecter;\r\n        const self_tile = TERRAIN_LOD_TILES >> level;\r\n        const count = self_tile * 2 + 2;\r\n\r\n        let index = 0;\r\n        const indices = new Uint16Array(count);\r\n\r\n        // starter\r\n        indices[index++] = 0;\r\n        indices[index++] = 0;\r\n\r\n        // middler\r\n        for (let i = 1; i < self_tile; ++i) {\r\n            const x1 = i * self_step;\r\n            const y1 = self_step;\r\n            const x0 = x1 / neighbor_step * neighbor_step;\r\n            const y0 = y1 - self_step;\r\n\r\n            const index0 = y1 * TERRAIN_LOD_VERTS + x1;\r\n            const index1 = y0 * TERRAIN_LOD_VERTS + x0;\r\n\r\n            indices[index++] = index0;\r\n            indices[index++] = index1;\r\n        }\r\n\r\n        // ender\r\n        indices[index++] = TERRAIN_LOD_VERTS - 1;\r\n        indices[index++] = TERRAIN_LOD_VERTS - 1;\r\n\r\n        this._connecterIndexPool[connecterIndex].size = index;\r\n        this._connecterIndexPool[connecterIndex].indices = indices;\r\n    }\r\n\r\n    private _genConnecterIndexSouth (level: number, connecter: number): void {\r\n        const connecterIndex = TerrainLod.mapIndex(level, connecter, TERRAIN_LOD_SOUTH_INDEX);\r\n\r\n        if (connecter < level || level === TERRAIN_LOD_LEVELS - 1) {\r\n            this._connecterIndexPool[connecterIndex].size = 0;\r\n            this._connecterIndexPool[connecterIndex].indices = null;\r\n            return;\r\n        }\r\n\r\n        const self_step = 1 << level;\r\n        const neighbor_step = 1 << connecter;\r\n        const self_tile = TERRAIN_LOD_TILES >> level;\r\n        const count = self_tile * 2 + 2;\r\n\r\n        let index = 0;\r\n        const indices = new Uint16Array(count);\r\n\r\n        // starter\r\n        indices[index++] = TERRAIN_LOD_TILES * TERRAIN_LOD_VERTS;\r\n        indices[index++] = TERRAIN_LOD_TILES * TERRAIN_LOD_VERTS;\r\n\r\n        // middler\r\n        for (let i = 1; i < self_tile; ++i) {\r\n            const x0 = i * self_step;\r\n            const y0 = TERRAIN_LOD_VERTS - 1 - self_step;\r\n            const x1 = x0 / neighbor_step * neighbor_step;\r\n            const y1 = y0 + self_step;\r\n\r\n            const index0 = y1 * TERRAIN_LOD_VERTS + x1;\r\n            const index1 = y0 * TERRAIN_LOD_VERTS + x0;\r\n\r\n            indices[index++] = index0;\r\n            indices[index++] = index1;\r\n        }\r\n\r\n        // ender\r\n        indices[index++] = TERRAIN_LOD_VERTS * TERRAIN_LOD_VERTS - 1;\r\n        indices[index++] = TERRAIN_LOD_VERTS * TERRAIN_LOD_VERTS - 1;\r\n\r\n        this._connecterIndexPool[connecterIndex].size = index;\r\n        this._connecterIndexPool[connecterIndex].indices = indices;\r\n    }\r\n\r\n    private _genConnecterIndexWest (level: number, connecter: number): void {\r\n        const connecterIndex = TerrainLod.mapIndex(level, connecter, TERRAIN_LOD_WEST_INDEX);\r\n\r\n        if (connecter < level || level === TERRAIN_LOD_LEVELS - 1) {\r\n            this._connecterIndexPool[connecterIndex].size = 0;\r\n            this._connecterIndexPool[connecterIndex].indices = null;\r\n            return;\r\n        }\r\n\r\n        const self_step = 1 << level;\r\n        const neighbor_step = 1 << connecter;\r\n        const self_tile = TERRAIN_LOD_TILES >> level;\r\n        const count = self_tile * 2 + 2;\r\n\r\n        let index = 0;\r\n        const indices = new Uint16Array(count);\r\n\r\n        // starter\r\n        indices[index++] = 0;\r\n        indices[index++] = 0;\r\n\r\n        // middler\r\n        for (let i = 1; i < self_tile; ++i)  {\r\n            const x0 = 0;\r\n            const y0 = i * self_step / neighbor_step * neighbor_step;\r\n            const x1 = self_step;\r\n            const y1 = i * self_step;\r\n\r\n            const index0 = y0 * TERRAIN_LOD_VERTS + x0;\r\n            const index1 = y1 * TERRAIN_LOD_VERTS + x1;\r\n\r\n            indices[index++] = index0;\r\n            indices[index++] = index1;\r\n        }\r\n\r\n        // ender\r\n        indices[index++] = TERRAIN_LOD_TILES * TERRAIN_LOD_VERTS;\r\n        indices[index++] = TERRAIN_LOD_TILES * TERRAIN_LOD_VERTS;\r\n\r\n        this._connecterIndexPool[connecterIndex].size = index;\r\n        this._connecterIndexPool[connecterIndex].indices = indices;\r\n    }\r\n\r\n    private _genConnecterIndexEast (level: number, connecter: number): void {\r\n        const connecterIndex = TerrainLod.mapIndex(level, connecter, TERRAIN_LOD_EAST_INDEX);\r\n\r\n        if (connecter < level || level === TERRAIN_LOD_LEVELS - 1) {\r\n            this._connecterIndexPool[connecterIndex].size = 0;\r\n            this._connecterIndexPool[connecterIndex].indices = null;\r\n            return;\r\n        }\r\n\r\n        const self_step = 1 << level;\r\n        const neighbor_step = 1 << connecter;\r\n        const self_tile = TERRAIN_LOD_TILES >> level;\r\n        const count = self_tile * 2 + 2;\r\n\r\n        let index = 0;\r\n        const indices = new Uint16Array(count);\r\n\r\n        // starter\r\n        indices[index++] = TERRAIN_LOD_VERTS - 1;\r\n        indices[index++] = TERRAIN_LOD_VERTS - 1;\r\n\r\n        // middler\r\n        for (let i = 1; i < self_tile; ++i) {\r\n            const x0 = TERRAIN_LOD_VERTS - 1 - self_step;\r\n            const y0 = i * self_step;\r\n            const x1 = TERRAIN_LOD_VERTS - 1;\r\n            const y1 = i * self_step / neighbor_step * neighbor_step;\r\n\r\n            const index0 = y0 * TERRAIN_LOD_VERTS + x0;\r\n            const index1 = y1 * TERRAIN_LOD_VERTS + x1;\r\n\r\n            indices[index++] = index0;\r\n            indices[index++] = index1;\r\n        }\r\n\r\n        // ender\r\n        indices[index++] = TERRAIN_LOD_VERTS * TERRAIN_LOD_VERTS - 1;\r\n        indices[index++] = TERRAIN_LOD_VERTS * TERRAIN_LOD_VERTS - 1;\r\n\r\n        this._connecterIndexPool[connecterIndex].size = index;\r\n        this._connecterIndexPool[connecterIndex].indices = indices;\r\n    }\r\n\r\n    private _getConnenterIndex (i: number, j: number, k: number): TerrainIndexPool {\r\n        return this._connecterIndexPool[TerrainLod.mapIndex(i, j, k)];\r\n    }\r\n\r\n    private _genIndexData (k: TerrainLodKey): TerrainIndexData | null {\r\n        let data = this.getIndexData(k);\r\n        if (data != null) {\r\n            return data;\r\n        }\r\n\r\n        const body = this._bodyIndexPool[k.level];\r\n        const north = this._getConnenterIndex(k.level, k.north, TERRAIN_LOD_NORTH_INDEX);\r\n        const south = this._getConnenterIndex(k.level, k.south, TERRAIN_LOD_SOUTH_INDEX);\r\n        const west = this._getConnenterIndex(k.level, k.west, TERRAIN_LOD_WEST_INDEX);\r\n        const east = this._getConnenterIndex(k.level, k.east, TERRAIN_LOD_EAST_INDEX);\r\n\r\n        data = new TerrainIndexData();\r\n        data.size = 0;\r\n        data.primCount = 0;\r\n\r\n        if (body.indices != null) {\r\n            data.size += body.size;\r\n        }\r\n        if (north.indices) {\r\n            data.size += (north.size - 2) * 3;\r\n        }\r\n        if (south.indices) {\r\n            data.size += (south.size - 2) * 3;\r\n        }\r\n        if (west.indices) {\r\n            data.size += (west.size - 2) * 3;\r\n        }\r\n        if (east.indices) {\r\n            data.size += (east.size - 2) * 3;\r\n        }\r\n\r\n        if (data.size === 0) {\r\n            return null;\r\n        }\r\n\r\n        let index = 0;\r\n        data.buffer = new Uint16Array(data.size);\r\n        data.key.level = k.level;\r\n        data.key.east = k.east;\r\n        data.key.west = k.west;\r\n        data.key.north = k.north;\r\n        data.key.south = k.south;\r\n\r\n        if (body.indices) {\r\n            for (let i = 0; i < body.size; ++i) {\r\n                data.buffer[index++] = body.indices[i];\r\n            }\r\n        }\r\n\r\n        if (north.indices) {\r\n            for (let i = 0; i < north.size - 2; i += 2)  {\r\n                const a = north.indices[i + 0];\r\n                const b = north.indices[i + 1];\r\n                const c = north.indices[i + 2];\r\n                const d = north.indices[i + 3];\r\n\r\n                data.buffer[index++] = a;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = b;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = d;\r\n                data.buffer[index++] = b;\r\n            }\r\n        }\r\n\r\n        if (south.indices)  {\r\n            for (let i = 0; i < south.size - 2; i += 2)  {\r\n                const a = south.indices[i + 0];\r\n                const b = south.indices[i + 1];\r\n                const c = south.indices[i + 2];\r\n                const d = south.indices[i + 3];\r\n\r\n                data.buffer[index++] = a;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = b;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = d;\r\n                data.buffer[index++] = b;\r\n            }\r\n        }\r\n\r\n        if (west.indices) {\r\n            for (let i = 0; i < west.size - 2; i += 2)  {\r\n                const a = west.indices[i + 0];\r\n                const b = west.indices[i + 1];\r\n                const c = west.indices[i + 2];\r\n                const d = west.indices[i + 3];\r\n\r\n                data.buffer[index++] = a;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = b;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = d;\r\n                data.buffer[index++] = b;\r\n            }\r\n        }\r\n\r\n        if (east.indices)  {\r\n            for (let i = 0; i < east.size - 2; i += 2) {\r\n                const a = east.indices[i + 0];\r\n                const b = east.indices[i + 1];\r\n                const c = east.indices[i + 2];\r\n                const d = east.indices[i + 3];\r\n\r\n                data.buffer[index++] = a;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = b;\r\n                data.buffer[index++] = c;\r\n                data.buffer[index++] = d;\r\n                data.buffer[index++] = b;\r\n            }\r\n        }\r\n\r\n        data.primCount = index / 3;\r\n        data.start = this._indexBuffer.length;\r\n        this._indexMap.push(data);\r\n\r\n        const temp = new Uint16Array(data.start + data.size);\r\n        temp.set(this._indexBuffer, 0);\r\n        temp.set(data.buffer, data.start);\r\n        this._indexBuffer = temp;\r\n\r\n        return data;\r\n    }\r\n}\r\n","/*\r\n Copyright (c) 2020-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { ccclass, disallowMultiple, executeInEditMode, help, visible, type, serializable, editable, disallowAnimation, menu } from 'cc.decorator';\r\nimport { EDITOR } from 'internal:constants';\r\nimport { builtinResMgr } from '../asset/asset-manager';\r\nimport { ModelRenderer } from '../misc/model-renderer';\r\nimport { EffectAsset, Texture2D } from '../asset/assets';\r\nimport { TextureFilter, PixelFormat, WrapMode } from '../asset/assets/asset-enum';\r\nimport { Material } from '../asset/assets/material';\r\nimport { RenderingSubMesh } from '../asset/assets/rendering-sub-mesh';\r\nimport { Component } from '../scene-graph/component';\r\nimport { CCObjectFlags, isValid } from '../core/data/object';\r\nimport { director } from '../game/director';\r\nimport { AttributeName, BufferUsageBit, Format, MemoryUsageBit, PrimitiveMode, Attribute, Buffer, BufferInfo, deviceManager, Texture } from '../gfx';\r\nimport { clamp, Rect, Size, v3, Vec2, Vec3, Vec4 } from '../core/math';\r\nimport { MacroRecord } from '../render-scene/core/pass-utils';\r\nimport { Pass, scene } from '../render-scene';\r\nimport { Camera } from '../render-scene/scene/camera';\r\nimport { Root } from '../root';\r\nimport { HeightField } from './height-field';\r\nimport { legacyCC } from '../core/global-exports';\r\nimport { TerrainLod, TerrainLodKey, TERRAIN_LOD_LEVELS, TERRAIN_LOD_MAX_DISTANCE, TerrainIndexData } from './terrain-lod';\r\nimport { TerrainAsset, TerrainLayerInfo, TERRAIN_HEIGHT_BASE, TERRAIN_HEIGHT_FACTORY,\r\n    TERRAIN_BLOCK_TILE_COMPLEXITY, TERRAIN_BLOCK_VERTEX_SIZE, TERRAIN_BLOCK_VERTEX_COMPLEXITY,\r\n    TERRAIN_MAX_LAYER_COUNT, TERRAIN_HEIGHT_FMIN, TERRAIN_HEIGHT_FMAX, TERRAIN_MAX_BLEND_LAYERS, TERRAIN_DATA_VERSION5 } from './terrain-asset';\r\nimport { CCFloat } from '../core';\r\nimport { PipelineEventType } from '../rendering';\r\nimport { MobilityMode, Node } from '../scene-graph';\r\n\r\n// the same as dependentAssets: legacy/terrain.effect\r\nconst TERRAIN_EFFECT_UUID = '1d08ef62-a503-4ce2-8b9a-46c90873f7d3';\r\n\r\n/**\r\n * @en Terrain info\r\n * @zh 地形信息\r\n */\r\n@ccclass('cc.TerrainInfo')\r\nexport class TerrainInfo {\r\n    constructor () {\r\n    }\r\n    /**\r\n     * @en tile size\r\n     * @zh 栅格大小\r\n     */\r\n    @serializable\r\n    @editable\r\n    public tileSize = 1;\r\n\r\n    /**\r\n     * @en block count\r\n     * @zh 地形块的数量\r\n     */\r\n    @serializable\r\n    @editable\r\n    public blockCount: number[] = [1, 1];\r\n\r\n    /**\r\n     * @en weight map size\r\n     * @zh 权重图大小\r\n     */\r\n    @serializable\r\n    @editable\r\n    public weightMapSize = 128;\r\n\r\n    /**\r\n     * @en light map size\r\n     * @zh 光照图大小\r\n     */\r\n    @serializable\r\n    @editable\r\n    public lightMapSize = 128;\r\n\r\n    /**\r\n     * @en terrain size\r\n     * @zh 地形大小\r\n     */\r\n    public get size (): Size {\r\n        const sz = new Size(0, 0);\r\n        sz.width = this.blockCount[0] * TERRAIN_BLOCK_TILE_COMPLEXITY * this.tileSize;\r\n        sz.height = this.blockCount[1] * TERRAIN_BLOCK_TILE_COMPLEXITY * this.tileSize;\r\n        return sz;\r\n    }\r\n\r\n    /**\r\n     * @en tile count\r\n     * @zh 栅格数量\r\n     */\r\n    public get tileCount (): number[] {\r\n        const _tileCount = [0, 0];\r\n        _tileCount[0] = this.blockCount[0] * TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n        _tileCount[1] = this.blockCount[1] * TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n        return _tileCount;\r\n    }\r\n\r\n    /**\r\n     * @en vertex count\r\n     * @zh 顶点数量\r\n     */\r\n    public get vertexCount (): number[] {\r\n        const _vertexCount = this.tileCount;\r\n        _vertexCount[0] += 1;\r\n        _vertexCount[1] += 1;\r\n        return _vertexCount;\r\n    }\r\n}\r\n\r\n/**\r\n * @en Terrain layer\r\n * @zh 地形纹理层\r\n */\r\n@ccclass('cc.TerrainLayer')\r\nexport class TerrainLayer {\r\n    /**\r\n     * @en detail texture\r\n     * @zh 细节纹理\r\n     */\r\n    @serializable\r\n    @editable\r\n    public detailMap: Texture2D|null = null;\r\n\r\n    /**\r\n     * @en normal texture\r\n     * @zh 法线纹理\r\n     */\r\n    @serializable\r\n    @editable\r\n    public normalMap: Texture2D|null = null;\r\n\r\n    /**\r\n     * @en tile size\r\n     * @zh 平铺大小\r\n     */\r\n    @serializable\r\n    @editable\r\n    public tileSize = 1;\r\n\r\n    /**\r\n     * @en metallic\r\n     * @zh 金属性\r\n     */\r\n    @serializable\r\n    @editable\r\n    public metallic = 0; /* [0, 1] */\r\n\r\n    /**\r\n     * @en roughness\r\n     * @zh 粗糙度\r\n     */\r\n    @serializable\r\n    @editable\r\n    public roughness = 1; /* [0, 1] */\r\n}\r\n\r\n/**\r\n * @en Terrain renderable\r\n * @zh 地形渲染组件\r\n */\r\nclass TerrainRenderable extends ModelRenderer {\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _model: scene.Model | null = null;\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _meshData: RenderingSubMesh | null = null;\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _brushPass: Pass | null = null;\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _brushMaterial: Material | null = null;\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _currentMaterial: Material | null = null;\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _currentMaterialLayers = 0;\r\n\r\n    /**\r\n     * @engineInternal\r\n     * @mangle\r\n     */\r\n    public _lightmap: Texture2D | null = null;\r\n\r\n    public destroy (): boolean {\r\n        // this._invalidMaterial();\r\n        if (this._model != null) {\r\n            legacyCC.director.root.destroyModel(this._model);\r\n            this._model = null;\r\n        }\r\n\r\n        return super.destroy();\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _destroyModel (): void {\r\n        // this._invalidMaterial();\r\n        if (this._model != null) {\r\n            legacyCC.director.root.destroyModel(this._model);\r\n            this._model = null;\r\n        }\r\n\r\n        if (this._meshData != null) {\r\n            this._meshData.destroy();\r\n            this._meshData = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _invalidMaterial (): void {\r\n        if (this._currentMaterial == null) {\r\n            return;\r\n        }\r\n\r\n        this._clearMaterials();\r\n\r\n        this._brushPass = null;\r\n        this._currentMaterial = null;\r\n        if (this._model != null) {\r\n            this._model.enabled = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateMaterial (block: TerrainBlock, init: boolean): boolean {\r\n        if (this._meshData == null || this._model == null) {\r\n            return false;\r\n        }\r\n\r\n        const nLayers = block.getMaxLayer();\r\n        if (this._currentMaterial == null || nLayers !== this._currentMaterialLayers) {\r\n            this._currentMaterial = new Material();\r\n\r\n            this._currentMaterial.initialize({\r\n                effectAsset: block.getTerrain().getEffectAsset(),\r\n                defines: block._getMaterialDefines(nLayers),\r\n            });\r\n\r\n            if (this._brushMaterial !== null) {\r\n                // Create brush material instance, avoid being destroyed by material gc\r\n                const brushMaterialInstance = new Material();\r\n                brushMaterialInstance.copy(this._brushMaterial);\r\n\r\n                this._brushPass = null;\r\n                if (brushMaterialInstance.passes !== null && brushMaterialInstance.passes.length > 0) {\r\n                    this._brushPass = brushMaterialInstance.passes[0];\r\n                    const passes = this._currentMaterial.passes;\r\n                    passes.push(this._brushPass);\r\n                    brushMaterialInstance.passes.pop();\r\n                }\r\n            }\r\n\r\n            if (init) {\r\n                this._model.initSubModel(0, this._meshData, this._currentMaterial);\r\n            }\r\n\r\n            this.setSharedMaterial(this._currentMaterial, 0);\r\n\r\n            this._currentMaterialLayers = nLayers;\r\n            this._model.enabled = true;\r\n            this._model.receiveShadow = block.getTerrain().receiveShadow;\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateLightingmap (texture: Texture2D | null, uvParam: Vec4): void {\r\n        if (this._model == null) {\r\n            return;\r\n        }\r\n\r\n        this._lightmap = texture;\r\n        this._updateReceiveDirLight();\r\n        this._model.updateLightingmap(texture, uvParam);\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _onMaterialModified (idx: number, mtl: Material|null): void {\r\n        if (this._model == null) {\r\n            return;\r\n        }\r\n        this._onRebuildPSO(idx, mtl || this._getBuiltinMaterial());\r\n    }\r\n\r\n    /**\r\n     * @engineInternal\r\n     */\r\n    public _onRebuildPSO (idx: number, material: Material): void {\r\n        if (this._model) {\r\n            this._model.setSubModelMaterial(idx, material);\r\n        }\r\n    }\r\n\r\n    protected _clearMaterials (): void {\r\n        if (this._model == null) {\r\n            return;\r\n        }\r\n\r\n        this._onMaterialModified(0, null);\r\n    }\r\n\r\n    protected _onUpdateReceiveDirLight (visibility: number, forceClose = false): void {\r\n        if (!this._model) { return; }\r\n        if (forceClose) {\r\n            this._model.receiveDirLight = false;\r\n            return;\r\n        }\r\n        if (this.node && ((visibility & this.node.layer) === this.node.layer)\r\n        || (visibility & this._model.visFlags)) {\r\n            this._model.receiveDirLight = true;\r\n        } else {\r\n            this._model.receiveDirLight = false;\r\n        }\r\n    }\r\n\r\n    protected _updateReceiveDirLight (): void {\r\n        const scene = this.node.scene;\r\n        if (!scene || !scene.renderScene) { return; }\r\n        const mainLight = scene.renderScene.mainLight;\r\n        if (!mainLight) { return; }\r\n        const visibility = mainLight.visibility;\r\n        if (!mainLight.node) { return; }\r\n        if (mainLight.node.mobility === MobilityMode.Static && this._lightmap) {\r\n            this._onUpdateReceiveDirLight(visibility, true);\r\n        } else {\r\n            this._onUpdateReceiveDirLight(visibility);\r\n        }\r\n    }\r\n\r\n    private _getBuiltinMaterial (): Material {\r\n        return builtinResMgr.get<Material>('missing-material');\r\n    }\r\n}\r\n\r\n/**\r\n * @en Terrain block light map info\r\n * @zh 地形块光照图信息\r\n */\r\n@ccclass('cc.TerrainBlockLightmapInfo')\r\nexport class TerrainBlockLightmapInfo {\r\n    @serializable\r\n    @editable\r\n    public texture: Texture2D|null = null;\r\n    @serializable\r\n    @editable\r\n    public UOff = 0;\r\n    @serializable\r\n    @editable\r\n    public VOff = 0;\r\n    @serializable\r\n    @editable\r\n    public UScale = 0;\r\n    @serializable\r\n    @editable\r\n    public VScale = 0;\r\n}\r\n\r\n/**\r\n * @en Terrain block\r\n * @zh 地形块\r\n */\r\nexport class TerrainBlock {\r\n    private _terrain: Terrain;\r\n    private _node: Node;\r\n    private _renderable: TerrainRenderable;\r\n    private _index: number[] = [1, 1];\r\n    private _weightMap: Texture2D|null = null;\r\n    private _lightmapInfo: TerrainBlockLightmapInfo|null = null;\r\n    private _lodLevel = 0;\r\n    private _lodKey: TerrainLodKey = new TerrainLodKey();\r\n    private _errorMetrics: number[] = [0, 0, 0, 0];\r\n    private _LevelDistances: number[] = [TERRAIN_LOD_MAX_DISTANCE, TERRAIN_LOD_MAX_DISTANCE, TERRAIN_LOD_MAX_DISTANCE, TERRAIN_LOD_MAX_DISTANCE];\r\n    private _bbMin = v3();\r\n    private _bbMax = v3();\r\n\r\n    constructor (t: Terrain, i: number, j: number) {\r\n        this._terrain = t;\r\n        this._index[0] = i;\r\n        this._index[1] = j;\r\n        this._lightmapInfo = t._getLightmapInfo(i, j);\r\n\r\n        this._node = new Node('TerrainBlock');\r\n        this._node.setParent(this._terrain.node);\r\n        this._node.hideFlags |= CCObjectFlags.DontSave | CCObjectFlags.HideInHierarchy;\r\n        this._node.layer = this._terrain.node.layer;\r\n\r\n        this._renderable = this._node.addComponent(TerrainRenderable);\r\n    }\r\n\r\n    public build (): void {\r\n        const gfxDevice = director.root!.device;\r\n\r\n        // vertex buffer\r\n        const vertexData = new Float32Array(TERRAIN_BLOCK_VERTEX_SIZE * TERRAIN_BLOCK_VERTEX_COMPLEXITY * TERRAIN_BLOCK_VERTEX_COMPLEXITY);\r\n        this._buildVertexData(vertexData);\r\n        const vertexBuffer = gfxDevice.createBuffer(new BufferInfo(\r\n            BufferUsageBit.VERTEX | BufferUsageBit.TRANSFER_DST,\r\n            MemoryUsageBit.DEVICE,\r\n            TERRAIN_BLOCK_VERTEX_SIZE * Float32Array.BYTES_PER_ELEMENT * TERRAIN_BLOCK_VERTEX_COMPLEXITY * TERRAIN_BLOCK_VERTEX_COMPLEXITY,\r\n            TERRAIN_BLOCK_VERTEX_SIZE * Float32Array.BYTES_PER_ELEMENT,\r\n        ));\r\n        vertexBuffer.update(vertexData);\r\n\r\n        // build bounding box\r\n        this._buildBoundingBox();\r\n\r\n        // initialize renderable\r\n        const gfxAttributes: Attribute[] = [\r\n            new Attribute(AttributeName.ATTR_POSITION, Format.RGB32F),\r\n            new Attribute(AttributeName.ATTR_NORMAL, Format.RGB32F),\r\n            new Attribute(AttributeName.ATTR_TEX_COORD, Format.RG32F),\r\n        ];\r\n\r\n        this._renderable._meshData = new RenderingSubMesh(\r\n            [vertexBuffer],\r\n            gfxAttributes,\r\n            PrimitiveMode.TRIANGLE_LIST,\r\n            this._terrain._getSharedIndexBuffer(),\r\n            null,\r\n            false,\r\n        );\r\n        this._renderable._model = (legacyCC.director.root as Root).createModel(scene.Model);\r\n        this._renderable._model.createBoundingShape(this._bbMin, this._bbMax);\r\n        this._renderable._model.node = this._renderable._model.transform = this._node;\r\n        // ensure the terrain node is in the scene\r\n        if (this._renderable.node.scene != null) {\r\n            this.visible = true;\r\n        }\r\n\r\n        // reset weightMap\r\n        this._updateWeightMap();\r\n\r\n        // reset material\r\n        this._updateMaterial(true);\r\n\r\n        if (this._terrain.lodEnable) {\r\n            // update lod\r\n            this._updateLodBuffer(vertexData);\r\n            // update index buffer\r\n            this._updateIndexBuffer();\r\n        }\r\n    }\r\n\r\n    public rebuild (): void {\r\n        this._updateHeight();\r\n        this._updateWeightMap();\r\n\r\n        this._renderable._invalidMaterial();\r\n        this._updateMaterial(false);\r\n    }\r\n\r\n    public destroy (): void {\r\n        this.visible = false;\r\n        this._renderable._destroyModel();\r\n\r\n        if (this._node != null && this._node.isValid) {\r\n            this._node.destroy();\r\n        }\r\n        if (this._weightMap != null) {\r\n            this._weightMap.destroy();\r\n        }\r\n    }\r\n\r\n    public update (): void {\r\n        this._updateMaterial(false);\r\n\r\n        if (this.lightmap !== this._renderable._lightmap) {\r\n            this._renderable._updateLightingmap(this.lightmap, this.lightmapUVParam);\r\n        }\r\n\r\n        const useNormalMap = this._terrain.useNormalMap;\r\n        const usePBR = this._terrain.usePBR;\r\n\r\n        // eslint-disable-next-line arrow-body-style\r\n        const getDetailTex = (layer: TerrainLayer|null): Texture2D | null => {\r\n            return layer !== null ? layer.detailMap : null;\r\n        };\r\n\r\n        const getNormalTex = (layer: TerrainLayer|null): Texture2D | null => {\r\n            let normalTex = layer !== null ? layer.normalMap : null;\r\n            if (normalTex === null) {\r\n                normalTex = builtinResMgr.get<Texture2D>('normal-texture');\r\n            }\r\n\r\n            return normalTex;\r\n        };\r\n\r\n        const mtl = this._renderable._currentMaterial;\r\n        if (mtl !== null) {\r\n            const nLayers = this.getMaxLayer();\r\n            const uvScale = new Vec4(1, 1, 1, 1);\r\n            const roughness = new Vec4(1, 1, 1, 1);\r\n            const metallic = new Vec4(0, 0, 0, 0);\r\n\r\n            if (nLayers === 0) {\r\n                if (this.layers[0] !== -1) {\r\n                    const l0 = this._terrain.getLayer(this.layers[0]);\r\n\r\n                    if (l0 !== null) {\r\n                        uvScale.x = 1.0 / l0.tileSize;\r\n                        roughness.x = l0.roughness;\r\n                        metallic.x = l0.metallic;\r\n                    }\r\n\r\n                    mtl.setProperty('detailMap0', getDetailTex(l0));\r\n                    if (useNormalMap) {\r\n                        mtl.setProperty('normalMap0', getNormalTex(l0));\r\n                    }\r\n                } else {\r\n                    mtl.setProperty('detailMap0', builtinResMgr.get<Texture2D>('default-texture'));\r\n                    if (useNormalMap) {\r\n                        mtl.setProperty('normalMap0', builtinResMgr.get<Texture2D>('normal-texture'));\r\n                    }\r\n                }\r\n            } else if (nLayers === 1) {\r\n                const l0 = this._terrain.getLayer(this.layers[0]);\r\n                const l1 = this._terrain.getLayer(this.layers[1]);\r\n\r\n                if (l0 !== null) {\r\n                    uvScale.x = 1.0 / l0.tileSize;\r\n                    roughness.x = l0.roughness;\r\n                    metallic.x = l0.metallic;\r\n                }\r\n                if (l1 !== null) {\r\n                    uvScale.y = 1.0 / l1.tileSize;\r\n                    roughness.y = l1.roughness;\r\n                    metallic.y = l1.metallic;\r\n                }\r\n\r\n                mtl.setProperty('weightMap', this._weightMap);\r\n                mtl.setProperty('detailMap0', getDetailTex(l0));\r\n                mtl.setProperty('detailMap1', getDetailTex(l1));\r\n                if (useNormalMap) {\r\n                    mtl.setProperty('normalMap0', getNormalTex(l0));\r\n                    mtl.setProperty('normalMap1', getNormalTex(l1));\r\n                }\r\n            } else if (nLayers === 2) {\r\n                const l0 = this._terrain.getLayer(this.layers[0]);\r\n                const l1 = this._terrain.getLayer(this.layers[1]);\r\n                const l2 = this._terrain.getLayer(this.layers[2]);\r\n\r\n                if (l0 !== null) {\r\n                    uvScale.x = 1.0 / l0.tileSize;\r\n                    roughness.x = l0.roughness;\r\n                    metallic.x = l0.metallic;\r\n                }\r\n                if (l1 !== null) {\r\n                    uvScale.y = 1.0 / l1.tileSize;\r\n                    roughness.y = l1.roughness;\r\n                    metallic.y = l1.metallic;\r\n                }\r\n                if (l2 !== null) {\r\n                    uvScale.z = 1.0 / l2.tileSize;\r\n                    roughness.z = l2.roughness;\r\n                    metallic.z = l2.metallic;\r\n                }\r\n\r\n                mtl.setProperty('weightMap', this._weightMap);\r\n                mtl.setProperty('detailMap0', getDetailTex(l0));\r\n                mtl.setProperty('detailMap1', getDetailTex(l1));\r\n                mtl.setProperty('detailMap2', getDetailTex(l2));\r\n                if (useNormalMap) {\r\n                    mtl.setProperty('normalMap0', getNormalTex(l0));\r\n                    mtl.setProperty('normalMap1', getNormalTex(l1));\r\n                    mtl.setProperty('normalMap2', getNormalTex(l2));\r\n                }\r\n            } else if (nLayers === 3) {\r\n                const l0 = this._terrain.getLayer(this.layers[0]);\r\n                const l1 = this._terrain.getLayer(this.layers[1]);\r\n                const l2 = this._terrain.getLayer(this.layers[2]);\r\n                const l3 = this._terrain.getLayer(this.layers[3]);\r\n\r\n                if (l0 !== null) {\r\n                    uvScale.x = 1.0 / l0.tileSize;\r\n                    roughness.x = l0.roughness;\r\n                    metallic.x = l0.metallic;\r\n                }\r\n                if (l1 !== null) {\r\n                    uvScale.y = 1.0 / l1.tileSize;\r\n                    roughness.y = l1.roughness;\r\n                    metallic.y = l1.metallic;\r\n                }\r\n                if (l2 !== null) {\r\n                    uvScale.z = 1.0 / l2.tileSize;\r\n                    roughness.z = l2.roughness;\r\n                    metallic.z = l2.metallic;\r\n                }\r\n                if (l3 !== null) {\r\n                    uvScale.w = 1.0 / l3.tileSize;\r\n                    roughness.w = l3.roughness;\r\n                    metallic.w = l3.metallic;\r\n                }\r\n\r\n                mtl.setProperty('weightMap', this._weightMap);\r\n                mtl.setProperty('detailMap0', getDetailTex(l0));\r\n                mtl.setProperty('detailMap1', getDetailTex(l1));\r\n                mtl.setProperty('detailMap2', getDetailTex(l2));\r\n                mtl.setProperty('detailMap3', getDetailTex(l3));\r\n                if (useNormalMap) {\r\n                    mtl.setProperty('normalMap0', getNormalTex(l0));\r\n                    mtl.setProperty('normalMap1', getNormalTex(l1));\r\n                    mtl.setProperty('normalMap2', getNormalTex(l2));\r\n                    mtl.setProperty('normalMap3', getNormalTex(l3));\r\n                }\r\n            }\r\n\r\n            mtl.setProperty('UVScale', uvScale);\r\n            if (usePBR) {\r\n                mtl.setProperty('roughness', roughness);\r\n                mtl.setProperty('metallic', metallic);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @engineInternal\r\n     */\r\n    public _buildLodInfo (): void {\r\n        const vertexData = new Float32Array(TERRAIN_BLOCK_VERTEX_SIZE * TERRAIN_BLOCK_VERTEX_COMPLEXITY * TERRAIN_BLOCK_VERTEX_COMPLEXITY);\r\n        this._buildVertexData(vertexData);\r\n        // update lod\r\n        this._updateLodBuffer(vertexData);\r\n        // update index buffer\r\n        this._updateIndexBuffer();\r\n    }\r\n\r\n    /**\r\n     * @engineInternal\r\n     * @mangle\r\n     */\r\n    public _updateLevel (camPos: Vec3): void {\r\n        const terrain = this._terrain;\r\n        const terrainNode = terrain.node;\r\n\r\n        const maxLevel = TERRAIN_LOD_LEVELS - 1;\r\n        const bbMin = v3();\r\n        const bbMax = v3();\r\n\r\n        Vec3.add(bbMin, this._bbMin, terrainNode.worldPosition);\r\n        Vec3.add(bbMax, this._bbMax, terrainNode.worldPosition);\r\n\r\n        const d1 = Vec3.distance(bbMin, camPos);\r\n        const d2 = Vec3.distance(bbMax, camPos);\r\n        let d = Math.min(d1, d2);\r\n\r\n        d -= terrain.LodBias;\r\n\r\n        this._lodLevel = 0;\r\n        while (this._lodLevel < maxLevel) {\r\n            const ld1 = this._LevelDistances[this._lodLevel + 1];\r\n            if (d <= ld1) {\r\n                break;\r\n            }\r\n\r\n            ++this._lodLevel;\r\n        }\r\n    }\r\n\r\n    public setBrushMaterial (mtl: Material|null): void {\r\n        if (this._renderable._brushMaterial !== mtl) {\r\n            this._renderable._invalidMaterial();\r\n            this._renderable._brushMaterial = mtl;\r\n        }\r\n    }\r\n\r\n    public _getBrushMaterial (): Material | null {\r\n        return this._renderable ? this._renderable._brushMaterial : null;\r\n    }\r\n\r\n    public _getBrushPass (): Pass | null {\r\n        return this._renderable ? this._renderable._brushPass : null;\r\n    }\r\n\r\n    /**\r\n     * @en valid\r\n     * @zh 是否有效\r\n     */\r\n    get valid (): boolean {\r\n        if (this._terrain === null) {\r\n            return false;\r\n        }\r\n\r\n        const blocks = this._terrain.getBlocks();\r\n        for (let i = 0; i < blocks.length; ++i) {\r\n            if (blocks[i] === this) {\r\n                return true;\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * @en get current material\r\n     * @zh 获得当前的材质\r\n     */\r\n    get material (): Material | null {\r\n        return this._renderable ? this._renderable._currentMaterial : null;\r\n    }\r\n\r\n    /**\r\n     * @en get layers\r\n     * @zh 获得纹理层索引\r\n     */\r\n    get layers (): number[] {\r\n        return this._terrain.getBlockLayers(this._index[0], this._index[1]);\r\n    }\r\n\r\n    /**\r\n     * @en get weight map\r\n     * @zh 获得权重图\r\n     */\r\n    get weightmap (): Texture2D | null {\r\n        return this._weightMap;\r\n    }\r\n\r\n    /**\r\n     * @en get light map\r\n     * @zh 获得光照图\r\n     */\r\n    get lightmap (): Texture2D | null {\r\n        return this._lightmapInfo ? this._lightmapInfo.texture : null;\r\n    }\r\n\r\n    /**\r\n     * @en get light map uv parameter\r\n     * @zh 获得光照图纹理坐标参数\r\n     */\r\n    get lightmapUVParam (): Vec4 {\r\n        if (this._lightmapInfo != null) {\r\n            return new Vec4(this._lightmapInfo.UOff, this._lightmapInfo.VOff, this._lightmapInfo.UScale, this._lightmapInfo.VScale);\r\n        }\r\n\r\n        return new Vec4(0, 0, 0, 0);\r\n    }\r\n\r\n    /**\r\n     * @zh 地形块的可见性\r\n     * @en The visibility of the block\r\n     */\r\n    set visible (val) {\r\n        if (this._renderable._model !== null) {\r\n            if (val) {\r\n                if (this._terrain.node != null\r\n                    && this._terrain.node.scene != null\r\n                    && this._terrain.node.scene.renderScene != null\r\n                    && this._renderable._model.scene == null) {\r\n                    this._terrain.node.scene.renderScene.addModel(this._renderable._model);\r\n                }\r\n            } else if (this._renderable._model.scene !== null) {\r\n                this._renderable._model.scene.removeModel(this._renderable._model);\r\n            }\r\n        }\r\n    }\r\n\r\n    get visible (): boolean {\r\n        if (this._renderable._model !== null) {\r\n            return this._renderable._model.scene !== null;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * @en get terrain owner\r\n     * @zh 获得地形对象\r\n     */\r\n    public getTerrain (): Terrain {\r\n        return this._terrain;\r\n    }\r\n\r\n    /**\r\n     * @en get index\r\n     * @zh 获得地形索引\r\n     */\r\n    public getIndex (): number[] {\r\n        return this._index;\r\n    }\r\n\r\n    /**\r\n     * @en get rect bound\r\n     * @zh 获得地形矩形包围体\r\n     */\r\n    public getRect (): Rect {\r\n        const rect = new Rect();\r\n        rect.x = this._index[0] * TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n        rect.y = this._index[1] * TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n        rect.width = TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n        rect.height = TERRAIN_BLOCK_TILE_COMPLEXITY;\r\n\r\n        return rect;\r\n    }\r\n\r\n    /**\r\n     * @en set layer\r\n     * @zh 设置纹理层\r\n     */\r\n    public setLayer (index: number, layerId: number): void {\r\n        if (this.layers[index] !== layerId) {\r\n            this._terrain.setBlockLayer(this._index[0], this._index[1], index, layerId);\r\n            this._renderable._invalidMaterial();\r\n            this._updateMaterial(false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en get layer\r\n     * @zh 获得纹理层\r\n     */\r\n    public getLayer (index: number): number {\r\n        return this.layers[index];\r\n    }\r\n\r\n    /**\r\n     * @en get max layer index\r\n     * @zh 获得最大纹理索引\r\n     */\r\n    public getMaxLayer (): number {\r\n        if (this.layers[3] >= 0) {\r\n            return 3;\r\n        }\r\n        if (this.layers[2] >= 0) {\r\n            return 2;\r\n        }\r\n        if (this.layers[1] >= 0) {\r\n            return 1;\r\n        }\r\n\r\n        return 0;\r\n    }\r\n\r\n    public _getMaterialDefines (nLayers: number): MacroRecord {\r\n        let lightmapMacroValue = 1; /*static*/\r\n        if (this._terrain.node && this._terrain.node.scene) {\r\n            if (this._terrain.node.scene.globals.bakedWithStationaryMainLight) {\r\n                lightmapMacroValue = 2; /*stationary*/\r\n            }\r\n        }\r\n        return {\r\n            LAYERS: nLayers + 1,\r\n            CC_USE_LIGHTMAP: this.lightmap !== null ? lightmapMacroValue : 0,\r\n            USE_NORMALMAP: this._terrain.useNormalMap ? 1 : 0,\r\n            USE_PBR: this._terrain.usePBR ? 1 : 0,\r\n            // CC_RECEIVE_SHADOW: this._terrain.receiveShadow ? 1 : 0,\r\n        };\r\n    }\r\n\r\n    public _invalidMaterial (): void {\r\n        this._renderable._invalidMaterial();\r\n    }\r\n\r\n    public _updateMaterial (init: boolean): void {\r\n        if (this._renderable._updateMaterial(this, init)) {\r\n            // Need set wrap mode clamp to border\r\n            if (this.lightmap !== null) {\r\n                this.lightmap.setWrapMode(WrapMode.CLAMP_TO_BORDER, WrapMode.CLAMP_TO_BORDER);\r\n            }\r\n\r\n            this._renderable._updateLightingmap(this.lightmap, this.lightmapUVParam);\r\n        }\r\n    }\r\n\r\n    public _updateHeight (): void {\r\n        if (this._renderable._meshData == null) {\r\n            return;\r\n        }\r\n\r\n        const vertexData = new Float32Array(TERRAIN_BLOCK_VERTEX_SIZE * TERRAIN_BLOCK_VERTEX_COMPLEXITY * TERRAIN_BLOCK_VERTEX_COMPLEXITY);\r\n        this._buildVertexData(vertexData);\r\n        this._renderable._meshData.vertexBuffers[0].update(vertexData);\r\n\r\n        this._buildBoundingBox();\r\n        this._renderable._model!.createBoundingShape(this._bbMin, this._bbMax);\r\n        this._renderable._model!.updateWorldBound();\r\n\r\n        this._updateLodBuffer(vertexData);\r\n\r\n        this._updateIndexBuffer();\r\n    }\r\n\r\n    public _updateWeightMap (): void {\r\n        const nLayers = this.getMaxLayer();\r\n\r\n        if (nLayers === 0) {\r\n            if (this._weightMap != null) {\r\n                this._weightMap.destroy();\r\n                this._weightMap = null;\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        if (this._weightMap == null) {\r\n            this._weightMap = new Texture2D();\r\n            this._weightMap.create(this._terrain.weightMapSize, this._terrain.weightMapSize, PixelFormat.RGBA8888);\r\n            this._weightMap.setFilters(TextureFilter.LINEAR, TextureFilter.LINEAR);\r\n            this._weightMap.setWrapMode(WrapMode.CLAMP_TO_EDGE, WrapMode.CLAMP_TO_EDGE);\r\n        }\r\n\r\n        const weightData = new Uint8Array(this._terrain.weightMapSize * this._terrain.weightMapSize * 4);\r\n        let weightIndex = 0;\r\n        for (let j = 0; j < this._terrain.weightMapSize; ++j) {\r\n            for (let i = 0; i < this._terrain.weightMapSize; ++i) {\r\n                const x = this._index[0] * this._terrain.weightMapSize + i;\r\n                const y = this._index[1] * this._terrain.weightMapSize + j;\r\n                const w = this._terrain.getWeight(x, y);\r\n\r\n                weightData[weightIndex * 4 + 0] = Math.floor(w.x * 255);\r\n                weightData[weightIndex * 4 + 1] = Math.floor(w.y * 255);\r\n                weightData[weightIndex * 4 + 2] = Math.floor(w.z * 255);\r\n                weightData[weightIndex * 4 + 3] = Math.floor(w.w * 255);\r\n\r\n                weightIndex += 1;\r\n            }\r\n        }\r\n        this._weightMap.uploadData(weightData);\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateLightmap (info: TerrainBlockLightmapInfo): void {\r\n        this._lightmapInfo = info;\r\n        this._invalidMaterial();\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateLod (): void {\r\n        const key = new TerrainLodKey();\r\n        key.level = this._lodLevel;\r\n        key.north = this._lodLevel;\r\n        key.south = this._lodLevel;\r\n        key.west = this._lodLevel;\r\n        key.east = this._lodLevel;\r\n\r\n        if (this._index[0] > 0) {\r\n            const n = this.getTerrain().getBlock(this._index[0] - 1, this._index[1]);\r\n            key.west = n._lodLevel;\r\n            if (key.west < this._lodLevel) {\r\n                key.west = this._lodLevel;\r\n            }\r\n        }\r\n\r\n        if (this._index[0] < this._terrain.info.blockCount[0] - 1) {\r\n            const n = this.getTerrain().getBlock(this._index[0] + 1, this._index[1]);\r\n            key.east = n._lodLevel;\r\n            if (key.east < this._lodLevel) {\r\n                key.east = this._lodLevel;\r\n            }\r\n        }\r\n\r\n        if (this._index[1] > 0) {\r\n            const n = this.getTerrain().getBlock(this._index[0], this._index[1] - 1);\r\n            key.north = n._lodLevel;\r\n            if (key.north < this._lodLevel) {\r\n                key.north = this._lodLevel;\r\n            }\r\n        }\r\n\r\n        if (this._index[1] < this._terrain.info.blockCount[1] - 1) {\r\n            const n = this.getTerrain().getBlock(this._index[0], this._index[1] + 1);\r\n            key.south = n._lodLevel;\r\n            if (key.south < this._lodLevel) {\r\n                key.south = this._lodLevel;\r\n            }\r\n        }\r\n\r\n        if (this._lodKey.equals(key)) {\r\n            return;\r\n        }\r\n\r\n        this._lodKey = key;\r\n        this._updateIndexBuffer();\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _resetLod (): void {\r\n        const key = new TerrainLodKey();\r\n        key.level = 0;\r\n        key.north = 0;\r\n        key.south = 0;\r\n        key.west = 0;\r\n        key.east = 0;\r\n\r\n        if (this._lodKey.equals(key)) {\r\n            return;\r\n        }\r\n\r\n        this._lodKey = key;\r\n        this._updateIndexBuffer();\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateIndexBuffer (): void {\r\n        if (this._renderable._meshData === null) {\r\n            return;\r\n        }\r\n        if (this._renderable._model === null) {\r\n            return;\r\n        }\r\n        if (this._renderable._model.subModels.length === 0) {\r\n            return;\r\n        }\r\n\r\n        const indexData = this._terrain._getIndexData(this._lodKey);\r\n        if (indexData === null) {\r\n            return;\r\n        }\r\n\r\n        const model = this._renderable._model.subModels[0];\r\n        model.inputAssembler.firstIndex = indexData.start;\r\n        model.inputAssembler.indexCount = indexData.size;\r\n    }\r\n\r\n    private _getHeight (x: number, y: number, verts: Float32Array): number {\r\n        const idx = TERRAIN_BLOCK_VERTEX_COMPLEXITY * y + x;\r\n        return verts[idx * TERRAIN_BLOCK_VERTEX_SIZE + 1];\r\n    }\r\n\r\n    private _updateLodBuffer (vertices: Float32Array): void  {\r\n        this._lodLevel = 0;\r\n        this._lodKey = new TerrainLodKey();\r\n        this._calcErrorMetrics(vertices);\r\n        this._calcLevelDistances(vertices);\r\n    }\r\n\r\n    private _calcErrorMetrics (vertices: Float32Array): void {\r\n        this._errorMetrics[0] = 0;\r\n\r\n        for (let i = 1; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            this._errorMetrics[i] = this._calcErrorMetric(i, vertices);\r\n        }\r\n\r\n        for (let i = 2; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            this._errorMetrics[i] = Math.max(this._errorMetrics[i],  this._errorMetrics[i - 1]);\r\n        }\r\n    }\r\n\r\n    private _calcErrorMetric (level: number, vertices: Float32Array): number {\r\n        let err = 0.0;\r\n        const step = 1 << level;\r\n        const xSectionVertices = TERRAIN_BLOCK_VERTEX_COMPLEXITY;\r\n        const ySectionVertices = TERRAIN_BLOCK_VERTEX_COMPLEXITY;\r\n        const xSides = (xSectionVertices - 1) >> level;\r\n        const ySides = (ySectionVertices - 1) >> level;\r\n\r\n        for (let y = 0; y < ySectionVertices; y += step)  {\r\n            for (let x = 0; x < xSides; ++x)  {\r\n                const x0 = x * step;\r\n                const x1 = x0 + step;\r\n                const xm = (x1 + x0) / 2;\r\n\r\n                const h0 = this._getHeight(x0, y, vertices);\r\n                const h1 = this._getHeight(x1, y, vertices);\r\n                const hm = this._getHeight(xm, y, vertices);\r\n                const hmi = (h0 + h1) / 2;\r\n\r\n                const delta = Math.abs(hm - hmi);\r\n\r\n                err = Math.max(err, delta);\r\n            }\r\n        }\r\n\r\n        for (let x = 0; x < xSectionVertices; x += step) {\r\n            for (let y = 0; y < ySides; ++y) {\r\n                const y0 = y * step;\r\n                const y1 = y0 + step;\r\n                const ym = (y0 + y1) / 2;\r\n\r\n                const h0 = this._getHeight(x, y0, vertices);\r\n                const h1 = this._getHeight(x, y1, vertices);\r\n                const hm = this._getHeight(x, ym, vertices);\r\n                const hmi = (h0 + h1) / 2;\r\n\r\n                const delta = Math.abs(hm - hmi);\r\n\r\n                err = Math.max(err, delta);\r\n            }\r\n        }\r\n\r\n        for (let y = 0; y < ySides; ++y) {\r\n            const y0 = y * step;\r\n            const y1 = y0 + step;\r\n            const ym = (y0 + y1) / 2;\r\n\r\n            for (let x = 0; x < xSides; ++x) {\r\n                const x0 = x * step;\r\n                const x1 = x0 + step;\r\n                const xm = (x0 + x1) / 2;\r\n\r\n                const h0 = this._getHeight(x0, y0, vertices);\r\n                const h1 = this._getHeight(x1, y1, vertices);\r\n                const hm = this._getHeight(xm, ym, vertices);\r\n                const hmi = (h0 + h1) / 2;\r\n\r\n                const delta = Math.abs(hm - hmi);\r\n\r\n                err = Math.max(err, delta);\r\n            }\r\n        }\r\n\r\n        return err;\r\n    }\r\n\r\n    private _calcLevelDistances (vertices: Float32Array): void  {\r\n        const pixelErr = 4;\r\n        const resolution = 768;\r\n        const c = 1.0 / (2 * pixelErr / resolution);\r\n\r\n        for (let i = 1; i < TERRAIN_LOD_LEVELS; ++i) {\r\n            const e = this._errorMetrics[i];\r\n            const d = e * c;\r\n            this._LevelDistances[i] = d;\r\n        }\r\n    }\r\n\r\n    private _buildVertexData (vertexData: Float32Array): void {\r\n        let index = 0;\r\n        for (let j = 0; j < TERRAIN_BLOCK_VERTEX_COMPLEXITY; ++j) {\r\n            for (let i = 0; i < TERRAIN_BLOCK_VERTEX_COMPLEXITY; ++i) {\r\n                const x = this._index[0] * TERRAIN_BLOCK_TILE_COMPLEXITY + i;\r\n                const y = this._index[1] * TERRAIN_BLOCK_TILE_COMPLEXITY + j;\r\n                const position = this._terrain.getPosition(x, y);\r\n                const normal = this._terrain.getNormal(x, y);\r\n                const uv = new Vec2(i / TERRAIN_BLOCK_TILE_COMPLEXITY, j / TERRAIN_BLOCK_TILE_COMPLEXITY);\r\n                vertexData[index++] = position.x;\r\n                vertexData[index++] = position.y;\r\n                vertexData[index++] = position.z;\r\n                vertexData[index++] = normal.x;\r\n                vertexData[index++] = normal.y;\r\n                vertexData[index++] = normal.z;\r\n                vertexData[index++] = uv.x;\r\n                vertexData[index++] = uv.y;\r\n            }\r\n        }\r\n    }\r\n\r\n    private _buildBoundingBox (): void {\r\n        this._bbMin.set(Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE);\r\n        this._bbMax.set(Number.MIN_VALUE, Number.MIN_VALUE, Number.MIN_VALUE);\r\n        for (let j = 0; j < TERRAIN_BLOCK_VERTEX_COMPLEXITY; ++j) {\r\n            for (let i = 0; i < TERRAIN_BLOCK_VERTEX_COMPLEXITY; ++i) {\r\n                const x = this._index[0] * TERRAIN_BLOCK_TILE_COMPLEXITY + i;\r\n                const y = this._index[1] * TERRAIN_BLOCK_TILE_COMPLEXITY + j;\r\n                const position = this._terrain.getPosition(x, y);\r\n                Vec3.min(this._bbMin, this._bbMin, position);\r\n                Vec3.max(this._bbMax, this._bbMax, position);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * @en Terrain\r\n * @zh 地形组件\r\n */\r\n@ccclass('cc.Terrain')\r\n@help('i18n:cc.Terrain')\r\n@menu('Terrain/Terrain')\r\n@executeInEditMode\r\n@disallowMultiple\r\nexport class Terrain extends Component {\r\n    @type(TerrainAsset)\r\n    @serializable\r\n    @disallowAnimation\r\n    protected __asset: TerrainAsset|null = null;\r\n\r\n    @type(EffectAsset)\r\n    @serializable\r\n    @disallowAnimation\r\n    @visible(false)\r\n    protected _effectAsset: EffectAsset|null = null;\r\n\r\n    @type(TerrainBlockLightmapInfo)\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _lightmapInfos: TerrainBlockLightmapInfo[] = [];\r\n\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _receiveShadow = false;\r\n\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _useNormalmap = false;\r\n\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _usePBR = false;\r\n\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _lodEnable = false;\r\n\r\n    @type(CCFloat)\r\n    @serializable\r\n    @disallowAnimation\r\n    protected _lodBias = 0;\r\n\r\n    // when the terrain undo, __asset is changed by serialize, but the internal block is created by last asset, here saved last asset\r\n    protected _buitinAsset: TerrainAsset|null = null;\r\n    protected _tileSize = 1;\r\n    protected _blockCount: number[] = [1, 1];\r\n    protected _weightMapSize = 128;\r\n    protected _lightMapSize = 128;\r\n    protected _heights: Uint16Array = new Uint16Array();\r\n    protected _weights: Uint8Array = new Uint8Array();\r\n    protected _normals: Float32Array = new Float32Array();\r\n    protected _layerList: (TerrainLayer|null)[] = [];\r\n    protected _layerBuffer: number[] = [];\r\n    protected _blocks: TerrainBlock[] = [];\r\n    protected _lod: TerrainLod|null = null;\r\n    protected _sharedIndexBuffer: Buffer|null = null;\r\n    protected _sharedLodIndexBuffer: Buffer|null = null;\r\n\r\n    constructor () {\r\n        super();\r\n\r\n        // initialize layers\r\n        for (let i = 0; i < TERRAIN_MAX_LAYER_COUNT; ++i) {\r\n            this._layerList.push(null);\r\n        }\r\n    }\r\n\r\n    @type(TerrainAsset)\r\n    @visible(true)\r\n    public set _asset (value: TerrainAsset|null) {\r\n        this.__asset = value;\r\n\r\n        if (this._buitinAsset !== this.__asset) {\r\n            this._buitinAsset = this.__asset;\r\n\r\n            // destroy all block\r\n            for (let i = 0; i < this._blocks.length; ++i) {\r\n                this._blocks[i].destroy();\r\n            }\r\n            this._blocks = [];\r\n\r\n            // restore to default\r\n            if (this.__asset === null) {\r\n                this._effectAsset = null;\r\n                this._lightmapInfos = [];\r\n                this._receiveShadow = false;\r\n                this._useNormalmap = false;\r\n                this._usePBR = false;\r\n                this._tileSize = 1;\r\n                this._blockCount = [1, 1];\r\n                this._weightMapSize = 128;\r\n                this._lightMapSize = 128;\r\n                this._heights = new Uint16Array();\r\n                this._weights = new Uint8Array();\r\n                this._normals = new Float32Array();\r\n                this._layerBuffer = [];\r\n                this._blocks = [];\r\n\r\n                // initialize layers\r\n                this._layerList = [];\r\n                for (let i = 0; i < TERRAIN_MAX_LAYER_COUNT; ++i) {\r\n                    this._layerList.push(null);\r\n                }\r\n            }\r\n\r\n            // Ensure device is created\r\n            if (deviceManager.gfxDevice) {\r\n                // rebuild\r\n                this._buildImp();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public get _asset (): TerrainAsset | null {\r\n        return this.__asset;\r\n    }\r\n\r\n    /**\r\n     * @en Terrain effect asset\r\n     * @zh 地形特效资源\r\n     */\r\n    @type(EffectAsset)\r\n    @visible(true)\r\n    public set effectAsset (value) {\r\n        if (this._effectAsset === value) {\r\n            return;\r\n        }\r\n\r\n        this._effectAsset = value;\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i]._invalidMaterial();\r\n        }\r\n    }\r\n\r\n    public get effectAsset (): EffectAsset | null {\r\n        return this._effectAsset;\r\n    }\r\n\r\n    /**\r\n     * @en Receive shadow\r\n     * @zh 是否接受阴影\r\n     */\r\n    @editable\r\n    get receiveShadow (): boolean {\r\n        return this._receiveShadow;\r\n    }\r\n\r\n    set receiveShadow (val) {\r\n        this._receiveShadow = val;\r\n        for (let i = 0; i < this._blocks.length; i++) {\r\n            this._blocks[i]._invalidMaterial();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en Use normal map\r\n     * @zh 是否使用法线贴图\r\n     */\r\n    @editable\r\n    get useNormalMap (): boolean {\r\n        return this._useNormalmap;\r\n    }\r\n\r\n    set useNormalMap (val) {\r\n        this._useNormalmap = val;\r\n        for (let i = 0; i < this._blocks.length; i++) {\r\n            this._blocks[i]._invalidMaterial();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en Use pbr material\r\n     * @zh 是否使用物理材质\r\n     */\r\n    @editable\r\n    get usePBR (): boolean {\r\n        return this._usePBR;\r\n    }\r\n\r\n    set usePBR (val) {\r\n        this._usePBR = val;\r\n        for (let i = 0; i < this._blocks.length; i++) {\r\n            this._blocks[i]._invalidMaterial();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en Enable lod\r\n     * @zh 是否允许lod\r\n     */\r\n    @editable\r\n    get lodEnable (): boolean {\r\n        return this._lodEnable;\r\n    }\r\n\r\n    set lodEnable (val) {\r\n        this._lodEnable = val;\r\n\r\n        if (this._lodEnable && this._lod === null) {\r\n            this._lod = new TerrainLod();\r\n\r\n            if (this._sharedLodIndexBuffer === null) {\r\n                this._sharedLodIndexBuffer = this._createSharedIndexBuffer();\r\n            }\r\n\r\n            // rebuild all block\r\n            for (let i = 0; i < this._blocks.length; ++i) {\r\n                this._blocks[i].destroy();\r\n            }\r\n            this._blocks = [];\r\n\r\n            for (let j = 0; j < this._blockCount[1]; ++j) {\r\n                for (let i = 0; i < this._blockCount[0]; ++i) {\r\n                    this._blocks.push(new TerrainBlock(this, i, j));\r\n                }\r\n            }\r\n\r\n            for (let i = 0; i < this._blocks.length; ++i) {\r\n                this._blocks[i].build();\r\n            }\r\n        }\r\n\r\n        if (!this._lodEnable) {\r\n            for (let i = 0; i < this._blocks.length; i++) {\r\n                this._blocks[i]._resetLod();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en Lod bias\r\n     * @zh Lod偏移距离\r\n     */\r\n    @editable\r\n    get LodBias (): number {\r\n        return this._lodBias;\r\n    }\r\n\r\n    set LodBias (val) {\r\n        this._lodBias = val;\r\n    }\r\n\r\n    /**\r\n     * @en get terrain size\r\n     * @zh 获得地形大小\r\n     */\r\n    public get size (): Size {\r\n        const sz = new Size(0, 0);\r\n        sz.width = this.blockCount[0] * TERRAIN_BLOCK_TILE_COMPLEXITY * this.tileSize;\r\n        sz.height = this.blockCount[1] * TERRAIN_BLOCK_TILE_COMPLEXITY * this.tileSize;\r\n        return sz;\r\n    }\r\n\r\n    /**\r\n     * @en get tile size\r\n     * @zh 获得栅格大小\r\n     */\r\n    get tileSize (): number {\r\n        return this._tileSize;\r\n    }\r\n\r\n    /**\r\n     * @en get tile count\r\n     * @zh 获得栅格数量\r\n     */\r\n    public get tileCount (): number[] {\r\n        return [this.blockCount[0] * TERRAIN_BLOCK_TILE_COMPLEXITY, this.blockCount[1] * TERRAIN_BLOCK_TILE_COMPLEXITY];\r\n    }\r\n\r\n    /**\r\n     * @en get vertex count\r\n     * @zh 获得顶点数量\r\n     */\r\n    public get vertexCount (): number[] {\r\n        const _vertexCount = this.tileCount;\r\n        _vertexCount[0] += 1;\r\n        _vertexCount[1] += 1;\r\n\r\n        return _vertexCount;\r\n    }\r\n\r\n    /**\r\n     * @en get block count\r\n     * @zh 获得地形块数量\r\n     */\r\n    get blockCount (): number[] {\r\n        return this._blockCount;\r\n    }\r\n\r\n    /**\r\n     * @en get light map size\r\n     * @zh 获得光照图大小\r\n     */\r\n    get lightMapSize (): number {\r\n        return this._lightMapSize;\r\n    }\r\n\r\n    /**\r\n     * @en get weight map size\r\n     * @zh 获得权重图大小\r\n     */\r\n    get weightMapSize (): number {\r\n        return this._weightMapSize;\r\n    }\r\n\r\n    /**\r\n     * @en get height buffer\r\n     * @zh 获得高度缓存\r\n     */\r\n    get heights (): Uint16Array {\r\n        return this._heights;\r\n    }\r\n\r\n    /**\r\n     * @en get weight buffer\r\n     * @zh 获得权重缓存\r\n     */\r\n    get weights (): Uint8Array {\r\n        return this._weights;\r\n    }\r\n\r\n    /**\r\n     * @en check valid\r\n     * @zh 检测是否有效\r\n     */\r\n    get valid (): boolean {\r\n        return this._blocks.length > 0;\r\n    }\r\n\r\n    /**\r\n     * @en get terrain info\r\n     * @zh 获得地形信息\r\n     */\r\n    @type(TerrainInfo)\r\n    public get info (): TerrainInfo {\r\n        const ti = new TerrainInfo();\r\n        ti.tileSize = this.tileSize;\r\n        ti.blockCount[0] = this.blockCount[0];\r\n        ti.blockCount[1] = this.blockCount[1];\r\n        ti.weightMapSize = this.weightMapSize;\r\n        ti.lightMapSize = this.lightMapSize;\r\n\r\n        return ti;\r\n    }\r\n\r\n    /**\r\n     * @en build\r\n     * @zh 构建地形\r\n     */\r\n    public build (info: TerrainInfo): void {\r\n        this._tileSize = info.tileSize;\r\n        this._blockCount[0] = info.blockCount[0];\r\n        this._blockCount[1] = info.blockCount[1];\r\n        this._weightMapSize = info.weightMapSize;\r\n        this._lightMapSize = info.lightMapSize;\r\n\r\n        return this._buildImp();\r\n    }\r\n\r\n    /**\r\n     * @en rebuild\r\n     * @zh 重建地形\r\n     */\r\n    public rebuild (info: TerrainInfo): void {\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].destroy();\r\n        }\r\n        this._blocks = [];\r\n\r\n        // reset lightmap\r\n        this._resetLightmap(false);\r\n\r\n        // build layer buffer\r\n        this._rebuildLayerBuffer(info);\r\n\r\n        // build heights and normals\r\n        const heightsChanged = this._rebuildHeights(info);\r\n\r\n        // build weights\r\n        this._rebuildWeights(info);\r\n\r\n        // update info\r\n        this._tileSize = info.tileSize;\r\n        this._blockCount[0] = info.blockCount[0];\r\n        this._blockCount[1] = info.blockCount[1];\r\n        this._weightMapSize = info.weightMapSize;\r\n        this._lightMapSize = info.lightMapSize;\r\n\r\n        // build normals if heights changed\r\n        if (heightsChanged) {\r\n            this._normals = new Float32Array(this.heights.length * 3);\r\n            this._buildNormals();\r\n        }\r\n\r\n        // build blocks\r\n        for (let j = 0; j < this._blockCount[1]; ++j) {\r\n            for (let i = 0; i < this._blockCount[0]; ++i) {\r\n                this._blocks.push(new TerrainBlock(this, i, j));\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].build();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en import height field\r\n     * @zh 导入高度图\r\n     */\r\n    public importHeightField (hf: HeightField, heightScale: number): void {\r\n        let index = 0;\r\n        for (let j = 0; j < this.vertexCount[1]; ++j) {\r\n            for (let i = 0; i < this.vertexCount[0]; ++i) {\r\n                const u = i / this.tileCount[0];\r\n                const v = j / this.tileCount[1];\r\n\r\n                const h = hf.getAt(u * hf.w, v * hf.h) * heightScale;\r\n\r\n                this._heights[index++] = h;\r\n            }\r\n        }\r\n\r\n        this._buildNormals();\r\n\r\n        // rebuild all blocks\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i]._updateHeight();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en export height field\r\n     * @zh 导出高度图\r\n     */\r\n    public exportHeightField (hf: HeightField, heightScale: number): void {\r\n        let index = 0;\r\n        for (let j = 0; j < hf.h; ++j) {\r\n            for (let i = 0; i < hf.w; ++i) {\r\n                const u = i / (hf.w - 1);\r\n                const v = j / (hf.h - 1);\r\n\r\n                const x = u * this.size.width;\r\n                const y = v * this.size.height;\r\n\r\n                const h = this.getHeightAt(x, y);\r\n                if (h != null) {\r\n                    hf.data[index++] = h * heightScale;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public exportAsset (): TerrainAsset {\r\n        const asset = new TerrainAsset();\r\n\r\n        asset.tileSize = this.tileSize;\r\n        asset.blockCount = this.blockCount;\r\n        asset.lightMapSize = this.lightMapSize;\r\n        asset.weightMapSize = this.weightMapSize;\r\n        asset.heights = this.heights;\r\n        asset.weights = this.weights;\r\n\r\n        asset.layerBuffer = new Array<number>(this._blocks.length * 4);\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            asset.layerBuffer[i * 4 + 0] = this._blocks[i].layers[0];\r\n            asset.layerBuffer[i * 4 + 1] = this._blocks[i].layers[1];\r\n            asset.layerBuffer[i * 4 + 2] = this._blocks[i].layers[2];\r\n            asset.layerBuffer[i * 4 + 3] = this._blocks[i].layers[3];\r\n        }\r\n\r\n        this.exportLayerListToAsset(asset);\r\n\r\n        return asset;\r\n    }\r\n\r\n    public exportLayerListToAsset (asset: TerrainAsset): void {\r\n        asset.layerInfos.length = 0;\r\n        for (let i = 0; i < this._layerList.length; ++i) {\r\n            const temp = this._layerList[i];\r\n            if (temp && temp.detailMap && isValid(temp.detailMap)) {\r\n                const layer = new TerrainLayerInfo();\r\n                layer.slot = i;\r\n                layer.tileSize = temp.tileSize;\r\n                layer.detailMap = temp.detailMap;\r\n                layer.normalMap = temp.normalMap;\r\n                layer.metallic = temp.metallic;\r\n                layer.roughness = temp.roughness;\r\n                asset.layerInfos.push(layer);\r\n            }\r\n        }\r\n    }\r\n\r\n    public getEffectAsset (): EffectAsset {\r\n        if (this._effectAsset === null) {\r\n            return legacyCC.EffectAsset.get(TERRAIN_EFFECT_UUID) as EffectAsset;\r\n        }\r\n\r\n        return this._effectAsset;\r\n    }\r\n\r\n    public onEnable (): void {\r\n        if (this._blocks.length === 0) {\r\n            this._buildImp();\r\n        }\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].visible = true;\r\n        }\r\n\r\n        (legacyCC.director.root as Root).pipelineEvent.on(PipelineEventType.RENDER_CAMERA_BEGIN, this.onUpdateFromCamera, this);\r\n    }\r\n\r\n    public onDisable (): void {\r\n        (legacyCC.director.root as Root).pipelineEvent.off(PipelineEventType.RENDER_CAMERA_BEGIN, this.onUpdateFromCamera, this);\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].visible = false;\r\n        }\r\n    }\r\n\r\n    public onDestroy (): void {\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].destroy();\r\n        }\r\n        this._blocks = [];\r\n\r\n        for (let i = 0; i < this._layerList.length; ++i) {\r\n            this._layerList[i] = null;\r\n        }\r\n\r\n        if (this._sharedIndexBuffer != null) {\r\n            this._sharedIndexBuffer.destroy();\r\n        }\r\n        if (this._sharedLodIndexBuffer != null) {\r\n            this._sharedLodIndexBuffer.destroy();\r\n        }\r\n    }\r\n\r\n    public onRestore (): void {\r\n        this.onEnable();\r\n        this._buildImp(true);\r\n    }\r\n\r\n    public update (deltaTime: number): void {\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].update();\r\n        }\r\n    }\r\n\r\n    public onUpdateFromCamera (cam: Camera): void {\r\n        if (!this.lodEnable || this._sharedLodIndexBuffer == null) {\r\n            return;\r\n        }\r\n        if (cam.scene !== this._getRenderScene()) {\r\n            return;\r\n        }\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i]._updateLevel(cam.position);\r\n        }\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i]._updateLod();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en add layer\r\n     * @zh 添加纹理层\r\n     */\r\n    public addLayer (layer: TerrainLayer): number {\r\n        for (let i = 0; i < this._layerList.length; ++i) {\r\n            if (this._layerList[i] === null || (this._layerList[i] && this._layerList[i]?.detailMap === null)) {\r\n                this._layerList[i] = layer;\r\n                if (this._asset) {\r\n                    this.exportLayerListToAsset(this._asset);\r\n                }\r\n                return i;\r\n            }\r\n        }\r\n\r\n        return -1;\r\n    }\r\n\r\n    /**\r\n     * @en set layer\r\n     * @zh 设置纹理层\r\n     */\r\n    public setLayer (i: number, layer: TerrainLayer): void {\r\n        this._layerList[i] = layer;\r\n        if (this._asset) {\r\n            this.exportLayerListToAsset(this._asset);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en remove layer\r\n     * @zh 移除纹理层\r\n     */\r\n    public removeLayer (id: number): void {\r\n        this._layerList[id] = null;\r\n        if (this._asset) {\r\n            this.exportLayerListToAsset(this._asset);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en get layer\r\n     * @zh 获得纹理层\r\n     */\r\n    public getLayer (id: number): TerrainLayer | null {\r\n        if (id === -1) {\r\n            return null;\r\n        }\r\n\r\n        return this._layerList[id];\r\n    }\r\n\r\n    /**\r\n     * @en get position\r\n     * @zh 获得地形上的位置\r\n     */\r\n    public getPosition (i: number, j: number): Vec3 {\r\n        const x = i * this._tileSize;\r\n        const z = j * this._tileSize;\r\n        const y = this.getHeight(i, j);\r\n\r\n        return v3(x, y, z);\r\n    }\r\n\r\n    public getHeightField (): Uint16Array {\r\n        return this._heights;\r\n    }\r\n\r\n    /**\r\n     * @en set height\r\n     * @zh 设置地形上的高度\r\n     */\r\n    public setHeight (i: number, j: number, h: number): void {\r\n        h = clamp(h, TERRAIN_HEIGHT_FMIN, TERRAIN_HEIGHT_FMAX);\r\n        this._heights[j * this.vertexCount[0] + i] = TERRAIN_HEIGHT_BASE + h / TERRAIN_HEIGHT_FACTORY;\r\n        if (EDITOR && this._asset) {\r\n            this._asset.heights[j * this.vertexCount[0] + i] = TERRAIN_HEIGHT_BASE + h / TERRAIN_HEIGHT_FACTORY;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en get height\r\n     * @zh 获得地形上的高度\r\n     */\r\n    public getHeight (i: number, j: number): number {\r\n        return (this._heights[j * this.vertexCount[0] + i] - TERRAIN_HEIGHT_BASE) * TERRAIN_HEIGHT_FACTORY;\r\n    }\r\n\r\n    /**\r\n     * @en set height\r\n     * @zh 设置高度\r\n     */\r\n    public getHeightClamp (i: number, j: number): number {\r\n        i = clamp(i, 0, this.vertexCount[0] - 1);\r\n        j = clamp(j, 0, this.vertexCount[1] - 1);\r\n\r\n        return this.getHeight(i, j);\r\n    }\r\n\r\n    /**\r\n     * @en get height by point\r\n     * @zh 根据点的坐标获得高度\r\n     */\r\n    public getHeightAt (x: number, y: number): number | null {\r\n        const fx = x / this.tileSize;\r\n        const fy = y / this.tileSize;\r\n\r\n        let ix0 = Math.floor(fx);\r\n        let iz0 = Math.floor(fy);\r\n        let ix1 = ix0 + 1;\r\n        let iz1 = iz0 + 1;\r\n        const dx = fx - ix0;\r\n        const dz = fy - iz0;\r\n\r\n        if (ix0 < 0 || ix0 > this.vertexCount[0] - 1 || iz0 < 0 || iz0 > this.vertexCount[1] - 1) {\r\n            return null;\r\n        }\r\n\r\n        ix0 = clamp(ix0, 0, this.vertexCount[0] - 1);\r\n        iz0 = clamp(iz0, 0, this.vertexCount[1] - 1);\r\n        ix1 = clamp(ix1, 0, this.vertexCount[0] - 1);\r\n        iz1 = clamp(iz1, 0, this.vertexCount[1] - 1);\r\n\r\n        let a = this.getHeight(ix0, iz0);\r\n        const b = this.getHeight(ix1, iz0);\r\n        const c = this.getHeight(ix0, iz1);\r\n        let d = this.getHeight(ix1, iz1);\r\n        const m = (b + c) * 0.5;\r\n\r\n        if (dx + dz <= 1.0) {\r\n            d = m + (m - a);\r\n        } else {\r\n            a = m + (m - d);\r\n        }\r\n\r\n        const h1 = a * (1.0 - dx) + b * dx;\r\n        const h2 = c * (1.0 - dx) + d * dx;\r\n\r\n        const h = h1 * (1.0 - dz) + h2 * dz;\r\n\r\n        return h;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _setNormal (i: number, j: number, n: Vec3): void {\r\n        const index = j * this.vertexCount[0] + i;\r\n\r\n        this._normals[index * 3 + 0] = n.x;\r\n        this._normals[index * 3 + 1] = n.y;\r\n        this._normals[index * 3 + 2] = n.z;\r\n    }\r\n\r\n    /**\r\n     * @en get normal\r\n     * @zh 获得法线\r\n     */\r\n    public getNormal (i: number, j: number): Vec3 {\r\n        const index = j * this.vertexCount[0] + i;\r\n\r\n        const n = v3();\r\n        n.x = this._normals[index * 3 + 0];\r\n        n.y = this._normals[index * 3 + 1];\r\n        n.z = this._normals[index * 3 + 2];\r\n\r\n        return n;\r\n    }\r\n\r\n    /**\r\n     * @en get normal by point\r\n     * @zh 根据点的坐标获得法线\r\n     */\r\n    public getNormalAt (x: number, y: number): Vec3 | null {\r\n        const fx = x / this.tileSize;\r\n        const fy = y / this.tileSize;\r\n\r\n        let ix0 = Math.floor(fx);\r\n        let iz0 = Math.floor(fy);\r\n        let ix1 = ix0 + 1;\r\n        let iz1 = iz0 + 1;\r\n        const dx = fx - ix0;\r\n        const dz = fy - iz0;\r\n\r\n        if (ix0 < 0 || ix0 > this.vertexCount[0] - 1 || iz0 < 0 || iz0 > this.vertexCount[1] - 1) {\r\n            return null;\r\n        }\r\n\r\n        ix0 = clamp(ix0, 0, this.vertexCount[0] - 1);\r\n        iz0 = clamp(iz0, 0, this.vertexCount[1] - 1);\r\n        ix1 = clamp(ix1, 0, this.vertexCount[0] - 1);\r\n        iz1 = clamp(iz1, 0, this.vertexCount[1] - 1);\r\n\r\n        const a = this.getNormal(ix0, iz0);\r\n        const b = this.getNormal(ix1, iz0);\r\n        const c = this.getNormal(ix0, iz1);\r\n        const d = this.getNormal(ix1, iz1);\r\n        const m = v3();\r\n        Vec3.add(m, b, c).multiplyScalar(0.5);\r\n\r\n        if (dx + dz <= 1.0) {\r\n            // d = m + (m - a);\r\n            d.set(m);\r\n            d.subtract(a);\r\n            d.add(m);\r\n        } else {\r\n            // a = m + (m - d);\r\n            a.set(m);\r\n            a.subtract(d);\r\n            a.add(m);\r\n        }\r\n\r\n        const n1 = v3();\r\n        const n2 = v3();\r\n        const n = v3();\r\n        Vec3.lerp(n1, a, b, dx);\r\n        Vec3.lerp(n2, c, d, dx);\r\n        Vec3.lerp(n, n1, n2, dz);\r\n\r\n        return n;\r\n    }\r\n\r\n    /**\r\n     * @en set weight\r\n     * @zh 设置权重\r\n     */\r\n    public setWeight (i: number, j: number, w: Vec4): void {\r\n        const index = j * this._weightMapSize * this._blockCount[0] + i;\r\n\r\n        this._weights[index * 4 + 0] = w.x * 255;\r\n        this._weights[index * 4 + 1] = w.y * 255;\r\n        this._weights[index * 4 + 2] = w.z * 255;\r\n        this._weights[index * 4 + 3] = w.w * 255;\r\n        if (EDITOR && this._asset) {\r\n            this._asset.weights[index * 4 + 0] = w.x * 255;\r\n            this._asset.weights[index * 4 + 1] = w.y * 255;\r\n            this._asset.weights[index * 4 + 2] = w.z * 255;\r\n            this._asset.weights[index * 4 + 3] = w.w * 255;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en get weight\r\n     * @zh 获得权重\r\n     */\r\n    public getWeight (i: number, j: number): Vec4 {\r\n        const index = j * this._weightMapSize * this._blockCount[0] + i;\r\n\r\n        const w = new Vec4();\r\n        w.x = this._weights[index * 4 + 0] / 255.0;\r\n        w.y = this._weights[index * 4 + 1] / 255.0;\r\n        w.z = this._weights[index * 4 + 2] / 255.0;\r\n        w.w = this._weights[index * 4 + 3] / 255.0;\r\n\r\n        return w;\r\n    }\r\n\r\n    /**\r\n     * @en get normal by point\r\n     * @zh 根据点的坐标获得权重\r\n     */\r\n    public getWeightAt (x: number, y: number): Vec4 | null {\r\n        const uWeightComplexity = this.weightMapSize * this.blockCount[0];\r\n        const vWeightComplexity = this.weightMapSize * this.blockCount[1];\r\n        if (uWeightComplexity === 0 || vWeightComplexity === 0) {\r\n            return null;\r\n        }\r\n\r\n        const fx = x / uWeightComplexity;\r\n        const fy = y / vWeightComplexity;\r\n\r\n        let ix0 = Math.floor(fx);\r\n        let iz0 = Math.floor(fy);\r\n        let ix1 = ix0 + 1;\r\n        let iz1 = iz0 + 1;\r\n        const dx = fx - ix0;\r\n        const dz = fy - iz0;\r\n\r\n        if (ix0 < 0 || ix0 > uWeightComplexity - 1 || iz0 < 0 || iz0 > vWeightComplexity - 1) {\r\n            return null;\r\n        }\r\n\r\n        ix0 = clamp(ix0, 0, uWeightComplexity - 1);\r\n        iz0 = clamp(iz0, 0, vWeightComplexity - 1);\r\n        ix1 = clamp(ix1, 0, uWeightComplexity - 1);\r\n        iz1 = clamp(iz1, 0, vWeightComplexity - 1);\r\n\r\n        let a = this.getWeight(ix0, iz0);\r\n        const b = this.getWeight(ix1, iz0);\r\n        const c = this.getWeight(ix0, iz1);\r\n        let d = this.getWeight(ix1, iz1);\r\n        const m = new Vec4();\r\n        Vec4.add(m, b, c).multiplyScalar(0.5);\r\n\r\n        if (dx + dz <= 1.0) {\r\n            d = new Vec4();\r\n            Vec4.subtract(d, m, a).add(m);\r\n        } else {\r\n            a = new Vec4();\r\n            Vec4.subtract(a, m, d).add(m);\r\n        }\r\n\r\n        const n1 = new Vec4();\r\n        const n2 = new Vec4();\r\n        const n = new Vec4();\r\n        Vec4.lerp(n1, a, b, dx);\r\n        Vec4.lerp(n2, c, d, dx);\r\n        Vec4.lerp(n, n1, n2, dz);\r\n\r\n        return n;\r\n    }\r\n\r\n    /**\r\n     * @en get max weight layer by point\r\n     * @zh 根据点的坐标获得权重最大的纹理层\r\n     */\r\n    public getMaxWeightLayerAt (x: number, y: number): TerrainLayer | null {\r\n        const uWeightComplexity = this.weightMapSize * this.blockCount[0];\r\n        const vWeightComplexity = this.weightMapSize * this.blockCount[1];\r\n        if (uWeightComplexity === 0 || vWeightComplexity === 0) {\r\n            return null;\r\n        }\r\n\r\n        const fx = x / uWeightComplexity;\r\n        const fy = y / vWeightComplexity;\r\n        const ix0 = Math.floor(fx);\r\n        const iz0 = Math.floor(fy);\r\n\r\n        if (ix0 < 0 || ix0 > uWeightComplexity - 1 || iz0 < 0 || iz0 > vWeightComplexity - 1) {\r\n            return null;\r\n        }\r\n\r\n        const w = this.getWeight(ix0, iz0);\r\n        const bx = Math.floor(x / this.weightMapSize);\r\n        const by = Math.floor(y / this.weightMapSize);\r\n        const block = this.getBlock(bx, by);\r\n\r\n        let i = 0;\r\n        if (w.y > w[i] && block.getLayer(1) !== -1) {\r\n            i = 1;\r\n        }\r\n        if (w.y > w[i] && block.getLayer(2) !== -1) {\r\n            i = 2;\r\n        }\r\n        if (w.z > w[i] && block.getLayer(3) !== -1) {\r\n            i = 3;\r\n        }\r\n\r\n        i = block.getLayer(i);\r\n\r\n        return this.getLayer(i);\r\n    }\r\n\r\n    /**\r\n     * @en get block layers\r\n     * @zh 获得地形块纹理层\r\n     */\r\n    public getBlockLayers (i: number, j: number): number[] {\r\n        const layerIndex = (j * this._blockCount[0] + i) * TERRAIN_MAX_BLEND_LAYERS;\r\n\r\n        return [\r\n            this._layerBuffer[layerIndex],\r\n            this._layerBuffer[layerIndex + 1],\r\n            this._layerBuffer[layerIndex + 2],\r\n            this._layerBuffer[layerIndex + 3],\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * @en get block layer\r\n     * @zh 获得地形块纹理层\r\n     */\r\n    public getBlockLayer (i: number, j: number, index: number): number {\r\n        const layerIndex = (j * this._blockCount[0] + i) * TERRAIN_MAX_BLEND_LAYERS;\r\n        return this._layerBuffer[layerIndex + index];\r\n    }\r\n\r\n    /**\r\n     * @en set block layer\r\n     * @zh 获得地形块层\r\n     */\r\n    public setBlockLayer (i: number, j: number, index: number, layerId: number): void {\r\n        const layerIndex = (j * this._blockCount[0] + i) * TERRAIN_MAX_BLEND_LAYERS;\r\n        this._layerBuffer[layerIndex + index] = layerId;\r\n    }\r\n\r\n    /**\r\n     * @en get block\r\n     * @zh 获得地形块对象\r\n     */\r\n    public getBlock (i: number, j: number): TerrainBlock {\r\n        return this._blocks[j * this._blockCount[0] + i];\r\n    }\r\n\r\n    /**\r\n     * @en get all blocks\r\n     * @zh 获得地形块缓存\r\n     */\r\n    public getBlocks (): TerrainBlock[] {\r\n        return this._blocks;\r\n    }\r\n\r\n    /**\r\n     * @en ray check\r\n     * @zh 射线检测\r\n     * @param start ray start\r\n     * @param dir ray direction\r\n     * @param step ray step\r\n     * @param worldSpace is world space\r\n     */\r\n    public rayCheck (start: Vec3, dir: Vec3, step: number, worldSpace = true): Vec3 | null {\r\n        const MAX_COUNT = 2000;\r\n\r\n        const trace = start;\r\n        if (worldSpace) {\r\n            Vec3.subtract(trace, start, this.node.worldPosition);\r\n        }\r\n\r\n        const delta = v3();\r\n        delta.set(dir);\r\n        delta.multiplyScalar(step);\r\n\r\n        let position: Vec3|null = null;\r\n\r\n        if (dir.equals(v3(0, 1, 0))) {\r\n            const y = this.getHeightAt(trace.x, trace.z);\r\n            if (y != null && trace.y <= y) {\r\n                position = v3(trace.x, y, trace.z);\r\n            }\r\n        } else if (dir.equals(v3(0, -1, 0))) {\r\n            const y = this.getHeightAt(trace.x, trace.z);\r\n            if (y != null && trace.y >= y) {\r\n                position = v3(trace.x, y, trace.z);\r\n            }\r\n        } else {\r\n            let i = 0;\r\n\r\n            // 优先大步进查找\r\n            while (i++ < MAX_COUNT) {\r\n                const y = this.getHeightAt(trace.x, trace.z);\r\n                if (y != null && trace.y <= y) {\r\n                    break;\r\n                }\r\n\r\n                trace.add(dir);\r\n            }\r\n\r\n            // 穷举法\r\n            while (i++ < MAX_COUNT) {\r\n                const y = this.getHeightAt(trace.x, trace.z);\r\n                if (y != null && trace.y <= y) {\r\n                    position = v3(trace.x, y, trace.z);\r\n                    break;\r\n                }\r\n\r\n                trace.add(delta);\r\n            }\r\n        }\r\n\r\n        return position;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.1, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _createSharedIndexBuffer (): Buffer {\r\n        // initialize shared index buffer\r\n        const gfxDevice = deviceManager.gfxDevice;\r\n\r\n        if (this._lod !== null) {\r\n            const gfxBuffer = gfxDevice.createBuffer(new BufferInfo(\r\n                BufferUsageBit.INDEX | BufferUsageBit.TRANSFER_DST,\r\n                MemoryUsageBit.DEVICE,\r\n                Uint16Array.BYTES_PER_ELEMENT * this._lod._indexBuffer.length,\r\n                Uint16Array.BYTES_PER_ELEMENT,\r\n            ));\r\n            gfxBuffer.update(this._lod._indexBuffer);\r\n            return gfxBuffer;\r\n        } else {\r\n            const indexData = new Uint16Array(TERRAIN_BLOCK_TILE_COMPLEXITY * TERRAIN_BLOCK_TILE_COMPLEXITY * 6);\r\n\r\n            let index = 0;\r\n            for (let j = 0; j < TERRAIN_BLOCK_TILE_COMPLEXITY; ++j) {\r\n                for (let i = 0; i < TERRAIN_BLOCK_TILE_COMPLEXITY; ++i) {\r\n                    const a = j * TERRAIN_BLOCK_VERTEX_COMPLEXITY + i;\r\n                    const b = j * TERRAIN_BLOCK_VERTEX_COMPLEXITY + i + 1;\r\n                    const c = (j + 1) * TERRAIN_BLOCK_VERTEX_COMPLEXITY + i;\r\n                    const d = (j + 1) * TERRAIN_BLOCK_VERTEX_COMPLEXITY + i + 1;\r\n\r\n                    // face 1\r\n                    indexData[index++] = a;\r\n                    indexData[index++] = c;\r\n                    indexData[index++] = b;\r\n                    // face 2\r\n                    indexData[index++] = b;\r\n                    indexData[index++] = c;\r\n                    indexData[index++] = d;\r\n                }\r\n            }\r\n\r\n            const gfxBuffer = gfxDevice.createBuffer(new BufferInfo(\r\n                BufferUsageBit.INDEX | BufferUsageBit.TRANSFER_DST,\r\n                MemoryUsageBit.DEVICE,\r\n                Uint16Array.BYTES_PER_ELEMENT * indexData.length,\r\n                Uint16Array.BYTES_PER_ELEMENT,\r\n            ));\r\n            gfxBuffer.update(indexData);\r\n            return gfxBuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _getSharedIndexBuffer (): Buffer {\r\n        if (this._sharedLodIndexBuffer !== null) {\r\n            return this._sharedLodIndexBuffer;\r\n        }\r\n\r\n        if (this._sharedIndexBuffer !== null) {\r\n            return this._sharedIndexBuffer;\r\n        }\r\n\r\n        if (this.lodEnable && this._lod === null) {\r\n            this._lod = new TerrainLod();\r\n        }\r\n\r\n        if (this._lod !== null) {\r\n            this._sharedLodIndexBuffer = this._createSharedIndexBuffer();\r\n            return this._sharedLodIndexBuffer;\r\n        } else {\r\n            this._sharedIndexBuffer = this._createSharedIndexBuffer();\r\n            return this._sharedIndexBuffer;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _getIndexData (key: TerrainLodKey): TerrainIndexData | null {\r\n        if (this._sharedLodIndexBuffer !== null && this._lod !== null) {\r\n            return this._lod.getIndexData(key);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _resetLightmap (enable: boolean): void {\r\n        this._lightmapInfos.length = 0;\r\n        if (enable) {\r\n            for (let i = 0; i < this._blockCount[0] * this._blockCount[1]; ++i) {\r\n                this._lightmapInfos.push(new TerrainBlockLightmapInfo());\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _updateLightmap (blockId: number, tex: Texture2D|null, uOff: number, vOff: number, uScale: number, vScale: number): void {\r\n        if (tex) {\r\n            // ensure the lightmap infos is initialized\r\n            if (this._lightmapInfos.length === 0) {\r\n                for (let i = 0; i < this._blockCount[0] * this._blockCount[1]; ++i) {\r\n                    this._lightmapInfos.push(new TerrainBlockLightmapInfo());\r\n                }\r\n            }\r\n        } else if (this._lightmapInfos.length === 0) {\r\n            return;\r\n        }\r\n\r\n        this._lightmapInfos[blockId].texture = tex;\r\n        this._lightmapInfos[blockId].UOff = uOff;\r\n        this._lightmapInfos[blockId].VOff = vOff;\r\n        this._lightmapInfos[blockId].UScale = uScale;\r\n        this._lightmapInfos[blockId].VScale = vScale;\r\n        this._blocks[blockId]._updateLightmap(this._lightmapInfos[blockId]);\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _getLightmapInfo (i: number, j: number): TerrainBlockLightmapInfo | null {\r\n        const index = j * this._blockCount[0] + i;\r\n        return index < this._lightmapInfos.length ? this._lightmapInfos[index] : null;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _calcNormal (x: number, z: number): Vec3 {\r\n        let flip = 1;\r\n        const here = this.getPosition(x, z);\r\n        let right: Vec3;\r\n        let up: Vec3;\r\n\r\n        if (x < this.vertexCount[0] - 1) {\r\n            right = this.getPosition(x + 1, z);\r\n        } else {\r\n            flip *= -1;\r\n            right = this.getPosition(x - 1, z);\r\n        }\r\n\r\n        if (z < this.vertexCount[1] - 1) {\r\n            up = this.getPosition(x, z + 1);\r\n        } else {\r\n            flip *= -1;\r\n            up = this.getPosition(x, z - 1);\r\n        }\r\n\r\n        right.subtract(here);\r\n        up.subtract(here);\r\n\r\n        const normal = v3();\r\n        normal.set(up);\r\n        normal.cross(right);\r\n        normal.multiplyScalar(flip);\r\n        normal.normalize();\r\n\r\n        return normal;\r\n    }\r\n\r\n    /**\r\n     * @deprecated since v3.5.0, this is an engine private interface that will be removed in the future.\r\n     */\r\n    public _buildNormals (): void {\r\n        let index = 0;\r\n        for (let y = 0; y < this.vertexCount[1]; ++y) {\r\n            for (let x = 0; x < this.vertexCount[0]; ++x) {\r\n                const n = this._calcNormal(x, y);\r\n\r\n                this._normals[index * 3 + 0] = n.x;\r\n                this._normals[index * 3 + 1] = n.y;\r\n                this._normals[index * 3 + 2] = n.z;\r\n                index += 1;\r\n            }\r\n        }\r\n    }\r\n\r\n    private _buildImp (restore = false): void {\r\n        if (this.valid) {\r\n            return;\r\n        }\r\n\r\n        const terrainAsset = this.__asset;\r\n        if (this._buitinAsset !== terrainAsset) {\r\n            this._buitinAsset = terrainAsset;\r\n        }\r\n\r\n        if (!restore && terrainAsset !== null) {\r\n            this._tileSize = terrainAsset.tileSize;\r\n            this._blockCount = terrainAsset.blockCount;\r\n            this._weightMapSize = terrainAsset.weightMapSize;\r\n            this._lightMapSize = terrainAsset.lightMapSize;\r\n            this._heights = terrainAsset.heights;\r\n            this._normals = terrainAsset.normals;\r\n            this._weights = terrainAsset.weights;\r\n            this._layerBuffer = terrainAsset.layerBuffer;\r\n\r\n            // build layers\r\n            for (let i = 0; i < this._layerList.length; ++i) {\r\n                this._layerList[i] = null;\r\n            }\r\n\r\n            if (terrainAsset.version < TERRAIN_DATA_VERSION5) {\r\n                for (let i = 0; i < terrainAsset.layerBinaryInfos.length; ++i) {\r\n                    const layer = new TerrainLayer();\r\n                    const layerInfo = terrainAsset.layerBinaryInfos[i];\r\n                    layer.tileSize = layerInfo.tileSize;\r\n                    legacyCC.assetManager.loadAny(layerInfo.detailMapId, (err, asset) => {\r\n                        layer.detailMap = asset;\r\n                    });\r\n\r\n                    if (layerInfo.normalMapId !== '') {\r\n                        legacyCC.assetManager.loadAny(layerInfo.normalMapId, (err, asset) => {\r\n                            layer.normalMap = asset;\r\n                        });\r\n                    }\r\n\r\n                    layer.roughness = layerInfo.roughness;\r\n                    layer.metallic = layerInfo.metallic;\r\n\r\n                    this._layerList[layerInfo.slot] = layer;\r\n                }\r\n            } else {\r\n                for (let i = 0; i < terrainAsset.layerInfos.length; ++i) {\r\n                    const layer = new TerrainLayer();\r\n                    const layerInfo = terrainAsset.layerInfos[i];\r\n                    layer.tileSize = layerInfo.tileSize;\r\n                    layer.detailMap = layerInfo.detailMap;\r\n                    layer.normalMap = layerInfo.normalMap;\r\n                    layer.roughness = layerInfo.roughness;\r\n                    layer.metallic = layerInfo.metallic;\r\n\r\n                    this._layerList[layerInfo.slot] = layer;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this._blockCount[0] === 0 || this._blockCount[1] === 0) {\r\n            return;\r\n        }\r\n\r\n        // build heights & normals\r\n        const vertexCount = this.vertexCount[0] * this.vertexCount[1];\r\n        if (this._heights === null || this._heights.length !== vertexCount) {\r\n            this._heights = new Uint16Array(vertexCount);\r\n            this._normals = new Float32Array(vertexCount * 3);\r\n            for (let i = 0; i < vertexCount; ++i) {\r\n                this._heights[i] = TERRAIN_HEIGHT_BASE;\r\n                this._normals[i * 3 + 0] = 0;\r\n                this._normals[i * 3 + 1] = 1;\r\n                this._normals[i * 3 + 2] = 0;\r\n            }\r\n            if (terrainAsset) {\r\n                terrainAsset.heights = this._heights;\r\n                terrainAsset.normals = this._normals;\r\n            }\r\n        }\r\n\r\n        if (this._normals === null || this._normals.length !== vertexCount * 3) {\r\n            this._normals = new Float32Array(vertexCount * 3);\r\n            this._buildNormals();\r\n        }\r\n\r\n        // build layer buffer\r\n        const layerBufferSize = this.blockCount[0] * this.blockCount[1] * TERRAIN_MAX_BLEND_LAYERS;\r\n        if (this._layerBuffer === null || this._layerBuffer.length !== layerBufferSize) {\r\n            this._layerBuffer = new Array<number>(layerBufferSize);\r\n            for (let i = 0; i < layerBufferSize; ++i) {\r\n                this._layerBuffer[i] = -1;\r\n            }\r\n            if (terrainAsset) {\r\n                terrainAsset.layerBuffer = this._layerBuffer;\r\n            }\r\n        }\r\n\r\n        // build weights\r\n        const weightMapComplexityU = this._weightMapSize * this._blockCount[0];\r\n        const weightMapComplexityV = this._weightMapSize * this._blockCount[1];\r\n        if (this._weights.length !== weightMapComplexityU * weightMapComplexityV * 4) {\r\n            this._weights = new Uint8Array(weightMapComplexityU * weightMapComplexityV * 4);\r\n            for (let i = 0; i < weightMapComplexityU * weightMapComplexityV; ++i) {\r\n                this._weights[i * 4 + 0] = 255;\r\n                this._weights[i * 4 + 1] = 0;\r\n                this._weights[i * 4 + 2] = 0;\r\n                this._weights[i * 4 + 3] = 0;\r\n            }\r\n            if (terrainAsset) {\r\n                terrainAsset.weights = this._weights;\r\n            }\r\n        }\r\n\r\n        // build blocks\r\n        for (let j = 0; j < this._blockCount[1]; ++j) {\r\n            for (let i = 0; i < this._blockCount[0]; ++i) {\r\n                this._blocks.push(new TerrainBlock(this, i, j));\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < this._blocks.length; ++i) {\r\n            this._blocks[i].build();\r\n        }\r\n    }\r\n\r\n    private _rebuildHeights (info: TerrainInfo): boolean {\r\n        if (this.vertexCount[0] === info.vertexCount[0] && this.vertexCount[1] === info.vertexCount[1]) {\r\n            return false;\r\n        }\r\n\r\n        const heights = new Uint16Array(info.vertexCount[0] * info.vertexCount[1]);\r\n        for (let i = 0; i < heights.length; ++i) {\r\n            heights[i] = TERRAIN_HEIGHT_BASE;\r\n        }\r\n\r\n        const w = Math.min(this.vertexCount[0], info.vertexCount[0]);\r\n        const h = Math.min(this.vertexCount[1], info.vertexCount[1]);\r\n\r\n        for (let j = 0; j < h; ++j) {\r\n            for (let i = 0; i < w; ++i) {\r\n                const index0 = j * info.vertexCount[0] + i;\r\n                const index1 = j * this.vertexCount[0] + i;\r\n\r\n                heights[index0] = this._heights[index1];\r\n            }\r\n        }\r\n\r\n        this._heights = heights;\r\n\r\n        return true;\r\n    }\r\n\r\n    private _rebuildLayerBuffer (info: TerrainInfo): boolean {\r\n        if (this.blockCount[0] === info.blockCount[0] && this.blockCount[1] === info.blockCount[1]) {\r\n            return false;\r\n        }\r\n\r\n        const layerBuffer: number[] = [];\r\n        layerBuffer.length = info.blockCount[0] * info.blockCount[1] * TERRAIN_MAX_BLEND_LAYERS;\r\n        for (let i = 0; i < layerBuffer.length; ++i) {\r\n            layerBuffer[i] = -1;\r\n        }\r\n\r\n        const w = Math.min(this.blockCount[0], info.blockCount[0]);\r\n        const h = Math.min(this.blockCount[1], info.blockCount[1]);\r\n        for (let j = 0; j < h; ++j) {\r\n            for (let i = 0; i < w; ++i) {\r\n                const index0 = j * info.blockCount[0] + i;\r\n                const index1 = j * this.blockCount[0] + i;\r\n\r\n                for (let l = 0; l < TERRAIN_MAX_BLEND_LAYERS; ++l) {\r\n                    layerBuffer[index0 * TERRAIN_MAX_BLEND_LAYERS + l] = this._layerBuffer[index1 * TERRAIN_MAX_BLEND_LAYERS + l];\r\n                }\r\n            }\r\n        }\r\n\r\n        this._layerBuffer = layerBuffer;\r\n\r\n        return true;\r\n    }\r\n\r\n    private _rebuildWeights (info: TerrainInfo): boolean {\r\n        const oldWeightMapSize = this._weightMapSize;\r\n        const oldWeightMapComplexityU = this._weightMapSize * this._blockCount[0];\r\n        const oldWeightMapComplexityV = this._weightMapSize * this._blockCount[1];\r\n\r\n        const weightMapComplexityU = info.weightMapSize * info.blockCount[0];\r\n        const weightMapComplexityV = info.weightMapSize * info.blockCount[1];\r\n\r\n        if (weightMapComplexityU === oldWeightMapComplexityU && weightMapComplexityV === oldWeightMapComplexityV) {\r\n            return false;\r\n        }\r\n\r\n        const weights = new Uint8Array(weightMapComplexityU * weightMapComplexityV * 4);\r\n\r\n        for (let i = 0; i < weightMapComplexityU * weightMapComplexityV; ++i) {\r\n            weights[i * 4 + 0] = 255;\r\n            weights[i * 4 + 1] = 0;\r\n            weights[i * 4 + 2] = 0;\r\n            weights[i * 4 + 3] = 0;\r\n        }\r\n\r\n        const w = Math.min(info.blockCount[0], this._blockCount[0]);\r\n        const h = Math.min(info.blockCount[1], this._blockCount[1]);\r\n\r\n        // get weight\r\n        const getOldWeight = (_i: number, _j: number, _weights: Uint8Array): Vec4 => {\r\n            const index = _j * oldWeightMapComplexityU + _i;\r\n\r\n            const weight = new Vec4();\r\n            weight.x = _weights[index * 4 + 0] / 255.0;\r\n            weight.y = _weights[index * 4 + 1] / 255.0;\r\n            weight.z = _weights[index * 4 + 2] / 255.0;\r\n            weight.w = _weights[index * 4 + 3] / 255.0;\r\n\r\n            return weight;\r\n        };\r\n\r\n        // sample weight\r\n        const sampleOldWeight = (_x: number, _y: number, _xOff: number, _yOff: number, _weights: Uint8Array): Vec4 => {\r\n            const ix0 = Math.floor(_x);\r\n            const iz0 = Math.floor(_y);\r\n            const ix1 = Math.min(ix0 + 1, oldWeightMapSize - 1);\r\n            const iz1 = Math.min(iz0 + 1, oldWeightMapSize - 1);\r\n            const dx = _x - ix0;\r\n            const dz = _y - iz0;\r\n\r\n            const a = getOldWeight(ix0 + _xOff, iz0 + _yOff, this._weights);\r\n            const b = getOldWeight(ix1 + _xOff, iz0 + _yOff, this._weights);\r\n            const c = getOldWeight(ix0 + _xOff, iz1 + _yOff, this._weights);\r\n            const d = getOldWeight(ix1 + _xOff, iz1 + _yOff, this._weights);\r\n            const m = new Vec4();\r\n            Vec4.add(m, b, c).multiplyScalar(0.5);\r\n\r\n            if (dx + dz <= 1.0) {\r\n                d.set(m);\r\n                d.subtract(a);\r\n                d.add(m);\r\n            } else {\r\n                a.set(m);\r\n                a.subtract(d);\r\n                a.add(m);\r\n            }\r\n\r\n            const n1 = new Vec4();\r\n            const n2 = new Vec4();\r\n            const n = new Vec4();\r\n            Vec4.lerp(n1, a, b, dx);\r\n            Vec4.lerp(n2, c, d, dx);\r\n            Vec4.lerp(n, n1, n2, dz);\r\n\r\n            return n;\r\n        };\r\n\r\n        // fill new weights\r\n        for (let j = 0; j < h; ++j) {\r\n            for (let i = 0; i < w; ++i) {\r\n                const uOff = i * oldWeightMapSize;\r\n                const vOff = j * oldWeightMapSize;\r\n\r\n                for (let v = 0; v < info.weightMapSize; ++v) {\r\n                    for (let u = 0; u < info.weightMapSize; ++u) {\r\n                        let w: Vec4;\r\n                        if (info.weightMapSize === oldWeightMapSize) {\r\n                            w = getOldWeight(u + uOff, v + vOff, this._weights);\r\n                        } else {\r\n                            const x = u / (info.weightMapSize - 1) * (oldWeightMapSize - 1);\r\n                            const y = v / (info.weightMapSize - 1) * (oldWeightMapSize - 1);\r\n                            w = sampleOldWeight(x, y, uOff, vOff, this._weights);\r\n                        }\r\n\r\n                        const du = i * info.weightMapSize + u;\r\n                        const dv = j * info.weightMapSize + v;\r\n                        const index = dv * weightMapComplexityU + du;\r\n\r\n                        weights[index * 4 + 0] = w.x * 255;\r\n                        weights[index * 4 + 1] = w.y * 255;\r\n                        weights[index * 4 + 2] = w.z * 255;\r\n                        weights[index * 4 + 3] = w.w * 255;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        this._weights = weights;\r\n\r\n        return true;\r\n    }\r\n}\r\n"],"names":["w","h","this","data","Uint16Array","i","_proto","HeightField","prototype","set","j","value","get","getClamp","clamp","getAt","x","y","fx","fy","ix0","Math","floor","iz0","ix1","iz1","dx","dz","a","b","c","d","m","TERRAIN_LOD_VERTS","TERRAIN_LOD_MAX_DISTANCE","TerrainLodKey","level","north","south","west","east","equals","rk","TerrainIndexPool","size","indices","TerrainIndexData","key","start","buffer","primCount","TerrainLod","_bodyIndexPool","_connecterIndexPool","_indexMap","_indexBuffer","Array","TERRAIN_LOD_LEVELS","k","mapIndex","_genBodyIndex","_genConnecterIndexNorth","_genConnecterIndexSouth","_genConnecterIndexWest","_genConnecterIndexEast","l","n","s","e","_genIndexData","_proto2","getIndexData","length","step","tiles","count","index","row_c","row_n","connecter","connecterIndex","self_step","neighbor_step","self_tile","x1","index0","index1","TERRAIN_LOD_TILES","x0","y0","_getConnenterIndex","body","push","temp","TerrainInfo","exports","ccclass","_dec","_class2","tileSize","_initializer","blockCount","_initializer2","weightMapSize","_initializer3","lightMapSize","_initializer4","_createClass","sz","Size","width","TERRAIN_BLOCK_TILE_COMPLEXITY","height","_tileCount","_vertexCount","tileCount","_applyDecoratedInitializer","serializable","_class","TerrainLayer","_dec2","_class5","detailMap","_initializer5","normalMap","_initializer6","_initializer7","metallic","_initializer8","roughness","_initializer9","_class4","TerrainRenderable","_ModelRenderer","_this","_len","arguments","args","_key","call","apply","concat","_model","_meshData","_brushPass","_brushMaterial","_currentMaterial","_currentMaterialLayers","_lightmap","_inheritsLoose","destroy","legacyCC","director","root","destroyModel","_destroyModel","_invalidMaterial","_clearMaterials","enabled","_updateMaterial","block","init","nLayers","getMaxLayer","Material","initialize","effectAsset","getTerrain","getEffectAsset","defines","_getMaterialDefines","brushMaterialInstance","copy","passes","pop","initSubModel","setSharedMaterial","receiveShadow","_updateLightingmap","texture","uvParam","_updateReceiveDirLight","updateLightingmap","_onMaterialModified","idx","mtl","_onRebuildPSO","_getBuiltinMaterial","material","setSubModelMaterial","_onUpdateReceiveDirLight","visibility","forceClose","receiveDirLight","node","layer","visFlags","scene","renderScene","mainLight","mobility","MobilityMode","Static","builtinResMgr","ModelRenderer","TerrainBlockLightmapInfo","_dec3","_class9","_initializer10","UOff","_initializer11","VOff","_initializer12","UScale","_initializer13","VScale","_initializer14","_class8","TerrainBlock","t","_terrain","_node","_renderable","_index","_weightMap","_lightmapInfo","_lodLevel","_lodKey","_errorMetrics","_LevelDistances","_bbMin","v3","_bbMax","_getLightmapInfo","Node","setParent","hideFlags","CCObjectFlags","DontSave","HideInHierarchy","addComponent","build","gfxDevice","device","vertexData","Float32Array","TERRAIN_BLOCK_VERTEX_SIZE","TERRAIN_BLOCK_VERTEX_COMPLEXITY","_buildVertexData","vertexBuffer","createBuffer","BufferInfo","BufferUsageBit","VERTEX","TRANSFER_DST","MemoryUsageBit","DEVICE","BYTES_PER_ELEMENT","update","_buildBoundingBox","gfxAttributes","Attribute","AttributeName","ATTR_POSITION","Format","RGB32F","ATTR_NORMAL","ATTR_TEX_COORD","RG32F","RenderingSubMesh","PrimitiveMode","TRIANGLE_LIST","_getSharedIndexBuffer","createModel","createBoundingShape","transform","visible","_updateWeightMap","lodEnable","_updateLodBuffer","_updateIndexBuffer","rebuild","_updateHeight","isValid","lightmap","lightmapUVParam","useNormalMap","usePBR","getDetailTex","getNormalTex","normalTex","uvScale","Vec4","layers","l0","getLayer","setProperty","l1","l2","z","l3","_buildLodInfo","_updateLevel","camPos","terrain","terrainNode","bbMin","bbMax","Vec3","add","worldPosition","d1","distance","d2","min","LodBias","setBrushMaterial","_getBrushMaterial","_getBrushPass","getIndex","getRect","rect","Rect","setLayer","layerId","setBlockLayer","lightmapMacroValue","globals","bakedWithStationaryMainLight","LAYERS","CC_USE_LIGHTMAP","USE_NORMALMAP","USE_PBR","setWrapMode","WrapMode","CLAMP_TO_BORDER","vertexBuffers","updateWorldBound","Texture2D","create","PixelFormat","RGBA8888","setFilters","TextureFilter","LINEAR","CLAMP_TO_EDGE","weightData","Uint8Array","weightIndex","getWeight","uploadData","_updateLightmap","info","_updateLod","getBlock","_resetLod","subModels","indexData","_getIndexData","model","inputAssembler","firstIndex","indexCount","_getHeight","verts","vertices","_calcErrorMetrics","_calcLevelDistances","_calcErrorMetric","max","err","xSectionVertices","ySectionVertices","xSides","ySides","xm","h0","h1","hm","hmi","delta","abs","y1","ym","position","getPosition","normal","getNormal","uv","Vec2","Number","MAX_VALUE","MIN_VALUE","blocks","getBlocks","getBlockLayers","val","addModel","removeModel","type","TerrainAsset","_dec6","EffectAsset","CCFloat","_dec10","disallowMultiple","_class13","_Component","Terrain","_this2","__asset","_initializer15","_effectAsset","_initializer16","_lightmapInfos","_initializer17","_receiveShadow","_initializer18","_useNormalmap","_initializer19","_usePBR","_initializer20","_lodEnable","_initializer21","_lodBias","_initializer22","_buitinAsset","_tileSize","_blockCount","_weightMapSize","_lightMapSize","_heights","_weights","_normals","_layerList","_layerBuffer","_blocks","_lod","_sharedIndexBuffer","_sharedLodIndexBuffer","TERRAIN_MAX_LAYER_COUNT","_proto3","_buildImp","_resetLightmap","_rebuildLayerBuffer","heightsChanged","_rebuildHeights","_rebuildWeights","heights","_buildNormals","importHeightField","hf","heightScale","vertexCount","u","v","exportHeightField","getHeightAt","exportAsset","asset","weights","layerBuffer","exportLayerListToAsset","layerInfos","TerrainLayerInfo","slot","onEnable","pipelineEvent","on","PipelineEventType","RENDER_CAMERA_BEGIN","onUpdateFromCamera","onDisable","off","onDestroy","onRestore","cam","_getRenderScene","addLayer","_this$_layerList$i","_asset","removeLayer","id","getHeight","getHeightField","setHeight","TERRAIN_HEIGHT_FMIN","TERRAIN_HEIGHT_FMAX","TERRAIN_HEIGHT_BASE","TERRAIN_HEIGHT_FACTORY","getHeightClamp","_setNormal","getNormalAt","multiplyScalar","subtract","n1","n2","lerp","setWeight","getWeightAt","uWeightComplexity","vWeightComplexity","getMaxWeightLayerAt","bx","by","layerIndex","TERRAIN_MAX_BLEND_LAYERS","getBlockLayer","rayCheck","dir","worldSpace","trace","_createSharedIndexBuffer","deviceManager","gfxBuffer","INDEX","enable","blockId","tex","uOff","vOff","uScale","vScale","_calcNormal","right","up","flip","here","cross","normalize","restore","_this3","valid","terrainAsset","normals","version","TERRAIN_DATA_VERSION5","_loop","layerInfo","layerBinaryInfos","assetManager","loadAny","detailMapId","normalMapId","layerBufferSize","weightMapComplexityU","weightMapComplexityV","_this4","oldWeightMapSize","oldWeightMapComplexityU","oldWeightMapComplexityV","getOldWeight","_i","_j","weight","sampleOldWeight","_x","_y","_xOff","_yOff","du","ti","Component","_dec7","_dec8","_applyDecoratedDescriptor","_dec9","Object","getOwnPropertyDescriptor","_dec11","_class12"],"mappings":"u5DA0BwB,WAKpB,SAAaA,EAAAA,EAAWC,GAASC,KAJ1BC,KAAoB,IAAIC,YAAaF,KACrCF,EAAI,EAACE,KACLD,EAAI,EAGPC,KAAKF,EAAIA,EACTE,KAAKD,EAAIA,EACTC,KAAKC,KAAO,IAAIC,YAAYJ,EAAIC,GAEhC,IAAK,IAAII,EAAI,EAAGA,EAAIL,EAAIC,IAAKI,EACzBH,KAAKC,KAAKE,GAAK,CAEvB,CAAC,IAAAC,EAAAC,EAAAC,UAmDA,OAnDAF,EAEMG,IAAP,SAAYJ,EAAWK,EAAWC,GAC9BT,KAAKC,KAAKO,EAAIR,KAAKF,EAAIK,GAAKM,CAC/B,EAAAL,EAEMM,IAAP,SAAYP,EAAWK,GACnB,OAAOR,KAAKC,KAAKO,EAAIR,KAAKF,EAAIK,EACjC,EAAAC,EAEMO,SAAP,SAAiBR,EAAWK,GAIxB,OAHAL,EAAIS,EAAMT,EAAG,EAAGH,KAAKF,EAAI,GACzBU,EAAII,EAAMJ,EAAG,EAAGR,KAAKD,EAAK,GAEnBC,KAAKU,IAAIP,EAAGK,EACtB,EAAAJ,EAEMS,MAAP,SAAcC,EAAWC,GACrB,IAAMC,EAAKF,EACLG,EAAKF,EAEPG,EAAMC,KAAKC,MAAMJ,GACjBK,EAAMF,KAAKC,MAAMH,GACjBK,EAAMJ,EAAM,EACZK,EAAMF,EAAM,EACVG,EAAKR,EAAKE,EACVO,EAAKR,EAAKI,EAEhBH,EAAMN,EAAMM,EAAK,EAAGlB,KAAKF,EAAI,GAC7BuB,EAAMT,EAAMS,EAAK,EAAGrB,KAAKD,EAAI,GAC7BuB,EAAMV,EAAMU,EAAK,EAAGtB,KAAKF,EAAI,GAC7ByB,EAAMX,EAAMW,EAAK,EAAGvB,KAAKD,EAAI,GAE7B,IAAI2B,EAAI1B,KAAKU,IAAIQ,EAAKG,GAChBM,EAAI3B,KAAKU,IAAIY,EAAKD,GAClBO,EAAI5B,KAAKU,IAAIQ,EAAKK,GACpBM,EAAI7B,KAAKU,IAAIY,EAAKC,GAChBO,EAAc,IAATH,EAAIC,GAaf,OAXIJ,EAAKC,GAAM,EACXI,EAAIC,GAAKA,EAAIJ,GAEbA,EAAII,GAAKA,EAAID,IAGNH,GAAK,EAAMF,GAAMG,EAAIH,IAGhB,EAAMC,IAFXG,GAAK,EAAMJ,GAAMK,EAAIL,GAECC,CAGpC,EAAApB,CAAA,CAhEmB,IAAXA,sHCFA0B,GAAoB,GAOpBC,GAA2B,KAE3BC,GAAa,WAAA,SAAAA,IAAAjC,KACfkC,MAAQ,EAAClC,KACTmC,MAAQ,EAACnC,KACToC,MAAQ,EAACpC,KACTqC,KAAO,EAACrC,KACRsC,KAAO,CAAC,CAId,OAJcL,EAAA3B,UAERiC,OAAP,SAAeC,GACX,OAAOxC,KAAKkC,QAAUM,EAAGN,OAASlC,KAAKmC,QAAUK,EAAGL,OAASnC,KAAKoC,QAAUI,EAAGJ,OAASpC,KAAKqC,OAASG,EAAGH,MAAQrC,KAAKsC,OAASE,EAAGF,IACrI,EAAAL,CAAA,CATqB,GAYbQ,GAAgB,WAAAzC,KAClB0C,KAAO,EAAC1C,KACR2C,QAA4B,IAAI,EAG9BC,GAAgB,WAAA5C,KAClB6C,IAAqB,IAAIZ,GAAejC,KACxC8C,MAAQ,EAAC9C,KACT0C,KAAO,EAAC1C,KACR+C,OAA2B,KAAI/C,KAC/BgD,UAAY,CAAC,EAGXC,GAAU,WAsBnB,SAAAA,IAAAjD,KAdOkD,oBAAc,EAAAlD,KAIdmD,yBAAmB,EAAAnD,KAInBoD,UAAgC,GAAEpD,KAIlCqD,aAA4B,IAAInD,YAGnCF,KAAKkD,eAAiB,IAAII,MAvDA,GAwD1B,IAAK,IAAInD,EAAI,EAAGA,EAxDU,IAwDgBA,EACtCH,KAAKkD,eAAe/C,GAAK,IAAIsC,GAGjCzC,KAAKmD,oBAAsB,IAAIG,MAAwBC,IACvD,IAAK,IAAIpD,EAAI,EAAGA,EA7DU,IA6DgBA,EACtC,IAAK,IAAIK,EAAI,EAAGA,EA9DM,IA8DoBA,EACtC,IAAK,IAAIgD,EAAI,EAAGA,EAAI,IAAKA,EACrBxD,KAAKmD,oBAAoBF,EAAWQ,SAAStD,EAAGK,EAAGgD,IAAM,IAAIf,GAKzE,IAAK,IAAItC,EAAI,EAAGA,EArEU,IAqEgBA,EACtCH,KAAK0D,cAAcvD,GAGvB,IAAK,IAAIA,EAAI,EAAGA,EAzEU,IAyEgBA,EACtC,IAAK,IAAIK,EAAI,EAAGA,EA1EM,IA0EoBA,EACtCR,KAAK2D,wBAAwBxD,EAAGK,GAChCR,KAAK4D,wBAAwBzD,EAAGK,GAChCR,KAAK6D,uBAAuB1D,EAAGK,GAC/BR,KAAK8D,uBAAuB3D,EAAGK,GAKvC,IADA,IACSuD,EAAI,EAAGA,EAnFU,IAmFIA,EAC1B,IAAK,IAAIC,EAAI,EAAGA,EApFM,IAoFQA,EAC1B,KAAIA,EAAID,GAIR,IAAK,IAAIE,EAAI,EAAGA,EAzFE,IAyFYA,EAC1B,KAAIA,EAAIF,GAIR,IAAK,IAAIjE,EAAI,EAAGA,EA9FF,IA8FgBA,EAC1B,KAAIA,EAAIiE,GAIR,IAAK,IAAIG,EAAI,EAAGA,EAnGN,IAmGoBA,EAC1B,KAAIA,EAAIH,GAAR,CAIA,IAAMP,EAAI,IAAIvB,GACduB,EAAEtB,MAAQ6B,EACVP,EAAErB,MAAQ6B,EACVR,EAAEpB,MAAQ6B,EACVT,EAAEnB,KAAOvC,EACT0D,EAAElB,KAAO4B,EACTlE,KAAKmE,cAAcX,EARlB,CAczB,CApFmBP,EACLQ,SAAd,SAAwBtD,EAAWK,EAAWgD,GAC1C,OAAYD,GAALpD,EAlCmB,EAkC6BK,EAAyBgD,CACpF,EAiFC,IAAAY,EAAAnB,EAAA3C,UA6WA,OA7WA8D,EAEMC,aAAP,SAAqBb,GACjB,IAAK,IAAIrD,EAAI,EAAGA,EAAIH,KAAKoD,UAAUkB,SAAUnE,EACzC,GAAIH,KAAKoD,UAAUjD,GAAG0C,IAAIN,OAAOiB,GAC7B,OAAOxD,KAAKoD,UAAUjD,GAI9B,OAAO,IACV,EAAAiE,EAEOV,cAAR,SAAuBxB,GACnB,IAAMqC,EAAO,GAAKrC,EACdsC,EAnIqB,IAmIQtC,EAC7BY,EAAQ,EAOZ,GALIZ,EAAQqB,IACRiB,GAAS,EACT1B,EAAQyB,EAAOxC,GAAoBwC,GAGzB,IAAVC,GAAyB,IAAVA,EAAnB,CAIA,IAAMC,EAAQD,EAAQA,EAAQ,EAC9BxE,KAAKkD,eAAehB,GAAOS,QAAU,IAAIzC,YAAYuE,GASrD,IAPA,IAAIC,EAAQ,EACN/B,EAAU,IAAIzC,YAAYuE,GAI5BE,EAAQ7B,EACR8B,EAAQD,EAAQ5C,GAAoBwC,EAC/BxD,EAAI,EAAGA,EAAIyD,IAASzD,EAAG,CAC5B,IAAK,IAAID,EAAI,EAAGA,EAAI0D,IAAS1D,EAWzB6B,EAAQ+B,KAAWE,EAAQ9D,EAAIyD,EAC/B5B,EAAQ+B,KAAWE,GAAS9D,EAAI,GAAKyD,EACrC5B,EAAQ+B,KAAWC,EAAQ7D,EAAIyD,EAE/B5B,EAAQ+B,KAAWE,GAAS9D,EAAI,GAAKyD,EACrC5B,EAAQ+B,KAAWC,GAAS7D,EAAI,GAAKyD,EACrC5B,EAAQ+B,KAAWC,EAAQ7D,EAAIyD,EAGnCI,GAAS5C,GAAoBwC,EAC7BK,GAAS7C,GAAoBwC,CAChC,CAEDvE,KAAKkD,eAAehB,GAAOQ,KAAOgC,EAClC1E,KAAKkD,eAAehB,GAAOS,QAAUA,CAtCpC,CAuCJ,EAAAyB,EAEOT,wBAAR,SAAiCzB,EAAe2C,GAC5C,IAAMC,EAAiB7B,EAAWQ,SAASvB,EAAO2C,EArLnB,GAuL/B,GAAIA,EAAY3C,GAAmBqB,IAAVrB,EAGrB,OAFAlC,KAAKmD,oBAAoB2B,GAAgBpC,KAAO,OAChD1C,KAAKmD,oBAAoB2B,GAAgBnC,QAAU,MAIvD,IAAMoC,EAAY,GAAK7C,EACjB8C,EAAgB,GAAKH,EACrBI,EAjMmB,IAiMc/C,EAGnCwC,EAAQ,EACN/B,EAAU,IAAIzC,YAHM,EAAZ+E,EAAgB,GAM9BtC,EAAQ+B,KAAW,EACnB/B,EAAQ+B,KAAW,EAGnB,IAAK,IAAIvE,EAAI,EAAGA,EAAI8E,IAAa9E,EAAG,CAChC,IAAM+E,EAAK/E,EAAI4E,EAKTI,EAJKJ,EAIShD,GAAoBmD,EAClCE,GALKL,EAEKA,GAGIhD,GAJTmD,EAAKF,EAAgBA,EAMhCrC,EAAQ+B,KAAWS,EACnBxC,EAAQ+B,KAAWU,CACtB,CAGDzC,EAAQ+B,KAAW3C,GACnBY,EAAQ+B,KAAW3C,GAEnB/B,KAAKmD,oBAAoB2B,GAAgBpC,KAAOgC,EAChD1E,KAAKmD,oBAAoB2B,GAAgBnC,QAAUA,CACtD,EAAAyB,EAEOR,wBAAR,SAAiC1B,EAAe2C,GAC5C,IAAMC,EAAiB7B,EAAWQ,SAASvB,EAAO2C,EA/NnB,GAiO/B,GAAIA,EAAY3C,GAAmBqB,IAAVrB,EAGrB,OAFAlC,KAAKmD,oBAAoB2B,GAAgBpC,KAAO,OAChD1C,KAAKmD,oBAAoB2B,GAAgBnC,QAAU,MAIvD,IAAMoC,EAAY,GAAK7C,EACjB8C,EAAgB,GAAKH,EACrBI,EA5OmB,IA4Oc/C,EAGnCwC,EAAQ,EACN/B,EAAU,IAAIzC,YAHM,EAAZ+E,EAAgB,GAM9BtC,EAAQ+B,KAAWW,KACnB1C,EAAQ+B,KAAWW,KAGnB,IAAK,IAAIlF,EAAI,EAAGA,EAAI8E,IAAa9E,EAAG,CAChC,IAAMmF,EAAKnF,EAAI4E,EACTQ,EAAKxD,GAAwBgD,EAI7BI,GAFKI,EAAKR,GAEIhD,GAHTuD,EAAKN,EAAgBA,EAI1BI,EAASG,EAAKxD,GAAoBuD,EAExC3C,EAAQ+B,KAAWS,EACnBxC,EAAQ+B,KAAWU,CACtB,CAGDzC,EAAQ+B,KAAW3C,KACnBY,EAAQ+B,KAAW3C,KAEnB/B,KAAKmD,oBAAoB2B,GAAgBpC,KAAOgC,EAChD1E,KAAKmD,oBAAoB2B,GAAgBnC,QAAUA,CACtD,EAAAyB,EAEOP,uBAAR,SAAgC3B,EAAe2C,GAC3C,IAAMC,EAAiB7B,EAAWQ,SAASvB,EAAO2C,EAzQpB,GA2Q9B,GAAIA,EAAY3C,GAAmBqB,IAAVrB,EAGrB,OAFAlC,KAAKmD,oBAAoB2B,GAAgBpC,KAAO,OAChD1C,KAAKmD,oBAAoB2B,GAAgBnC,QAAU,MAIvD,IAAMoC,EAAY,GAAK7C,EACjB8C,EAAgB,GAAKH,EACrBI,EAvRmB,IAuRc/C,EAGnCwC,EAAQ,EACN/B,EAAU,IAAIzC,YAHM,EAAZ+E,EAAgB,GAM9BtC,EAAQ+B,KAAW,EACnB/B,EAAQ+B,KAAW,EAGnB,IAAK,IAAIvE,EAAI,EAAGA,EAAI8E,IAAa9E,EAAI,CACjC,IAKMgF,EAJKhF,EAAI4E,EAAYC,EAAgBA,EAIvBjD,GALT,EAMLqD,EAHKjF,EAAI4E,EAGKhD,GAJTgD,EAMXpC,EAAQ+B,KAAWS,EACnBxC,EAAQ+B,KAAWU,CACtB,CAGDzC,EAAQ+B,KAAWW,KACnB1C,EAAQ+B,KAAWW,KAEnBrF,KAAKmD,oBAAoB2B,GAAgBpC,KAAOgC,EAChD1E,KAAKmD,oBAAoB2B,GAAgBnC,QAAUA,CACtD,EAAAyB,EAEON,uBAAR,SAAgC5B,EAAe2C,GAC3C,IAAMC,EAAiB7B,EAAWQ,SAASvB,EAAO2C,EAnTpB,GAqT9B,GAAIA,EAAY3C,GAAmBqB,IAAVrB,EAGrB,OAFAlC,KAAKmD,oBAAoB2B,GAAgBpC,KAAO,OAChD1C,KAAKmD,oBAAoB2B,GAAgBnC,QAAU,MAIvD,IAAMoC,EAAY,GAAK7C,EACjB8C,EAAgB,GAAKH,EACrBI,EAlUmB,IAkUc/C,EAGnCwC,EAAQ,EACN/B,EAAU,IAAIzC,YAHM,EAAZ+E,EAAgB,GAM9BtC,EAAQ+B,KAAW3C,GACnBY,EAAQ+B,KAAW3C,GAGnB,IAAK,IAAI5B,EAAI,EAAGA,EAAI8E,IAAa9E,EAAG,CAChC,IAKMgF,EAJKhF,EAAI4E,EAIKhD,IALTA,GAAwBgD,GAM7BK,EAHKjF,EAAI4E,EAAYC,EAAgBA,EAGvBjD,GAJTA,GAMXY,EAAQ+B,KAAWS,EACnBxC,EAAQ+B,KAAWU,CACtB,CAGDzC,EAAQ+B,KAAW3C,KACnBY,EAAQ+B,KAAW3C,KAEnB/B,KAAKmD,oBAAoB2B,GAAgBpC,KAAOgC,EAChD1E,KAAKmD,oBAAoB2B,GAAgBnC,QAAUA,CACtD,EAAAyB,EAEOoB,mBAAR,SAA4BrF,EAAWK,EAAWgD,GAC9C,OAAOxD,KAAKmD,oBAAoBF,EAAWQ,SAAStD,EAAGK,EAAGgD,GAC7D,EAAAY,EAEOD,cAAR,SAAuBX,GACnB,IAAIvD,EAAOD,KAAKqE,aAAab,GAC7B,GAAY,MAARvD,EACA,OAAOA,EAGX,IAAMwF,EAAOzF,KAAKkD,eAAeM,EAAEtB,OAC7BC,EAAQnC,KAAKwF,mBAAmBhC,EAAEtB,MAAOsB,EAAErB,MA3WlB,GA4WzBC,EAAQpC,KAAKwF,mBAAmBhC,EAAEtB,MAAOsB,EAAEpB,MA3WlB,GA4WzBC,EAAOrC,KAAKwF,mBAAmBhC,EAAEtB,MAAOsB,EAAEnB,KA3WlB,GA4WxBC,EAAOtC,KAAKwF,mBAAmBhC,EAAEtB,MAAOsB,EAAElB,KA3WlB,GAiY9B,IApBArC,EAAO,IAAI2C,IACNF,KAAO,EACZzC,EAAK+C,UAAY,EAEG,MAAhByC,EAAK9C,UACL1C,EAAKyC,MAAQ+C,EAAK/C,MAElBP,EAAMQ,UACN1C,EAAKyC,MAA2B,GAAlBP,EAAMO,KAAO,IAE3BN,EAAMO,UACN1C,EAAKyC,MAA2B,GAAlBN,EAAMM,KAAO,IAE3BL,EAAKM,UACL1C,EAAKyC,MAA0B,GAAjBL,EAAKK,KAAO,IAE1BJ,EAAKK,UACL1C,EAAKyC,MAA0B,GAAjBJ,EAAKI,KAAO,IAGZ,IAAdzC,EAAKyC,KACL,OAAO,KAGX,IAAIgC,EAAQ,EAQZ,GAPAzE,EAAK8C,OAAS,IAAI7C,YAAYD,EAAKyC,MACnCzC,EAAK4C,IAAIX,MAAQsB,EAAEtB,MACnBjC,EAAK4C,IAAIP,KAAOkB,EAAElB,KAClBrC,EAAK4C,IAAIR,KAAOmB,EAAEnB,KAClBpC,EAAK4C,IAAIV,MAAQqB,EAAErB,MACnBlC,EAAK4C,IAAIT,MAAQoB,EAAEpB,MAEfqD,EAAK9C,QACL,IAAK,IAAIxC,EAAI,EAAGA,EAAIsF,EAAK/C,OAAQvC,EAC7BF,EAAK8C,OAAO2B,KAAWe,EAAK9C,QAAQxC,GAI5C,GAAIgC,EAAMQ,QACN,IAAK,IAAIxC,EAAI,EAAGA,EAAIgC,EAAMO,KAAO,EAAGvC,GAAK,EAAI,CACzC,IAAMuB,EAAIS,EAAMQ,QAAQxC,EAAI,GACtBwB,EAAIQ,EAAMQ,QAAQxC,EAAI,GACtByB,EAAIO,EAAMQ,QAAQxC,EAAI,GACtB0B,EAAIM,EAAMQ,QAAQxC,EAAI,GAE5BF,EAAK8C,OAAO2B,KAAWhD,EACvBzB,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW/C,EACvB1B,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW7C,EACvB5B,EAAK8C,OAAO2B,KAAW/C,CAC1B,CAGL,GAAIS,EAAMO,QACN,IAAK,IAAIxC,EAAI,EAAGA,EAAIiC,EAAMM,KAAO,EAAGvC,GAAK,EAAI,CACzC,IAAMuB,EAAIU,EAAMO,QAAQxC,EAAI,GACtBwB,EAAIS,EAAMO,QAAQxC,EAAI,GACtByB,EAAIQ,EAAMO,QAAQxC,EAAI,GACtB0B,EAAIO,EAAMO,QAAQxC,EAAI,GAE5BF,EAAK8C,OAAO2B,KAAWhD,EACvBzB,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW/C,EACvB1B,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW7C,EACvB5B,EAAK8C,OAAO2B,KAAW/C,CAC1B,CAGL,GAAIU,EAAKM,QACL,IAAK,IAAIxC,EAAI,EAAGA,EAAIkC,EAAKK,KAAO,EAAGvC,GAAK,EAAI,CACxC,IAAMuB,EAAIW,EAAKM,QAAQxC,EAAI,GACrBwB,EAAIU,EAAKM,QAAQxC,EAAI,GACrByB,EAAIS,EAAKM,QAAQxC,EAAI,GACrB0B,EAAIQ,EAAKM,QAAQxC,EAAI,GAE3BF,EAAK8C,OAAO2B,KAAWhD,EACvBzB,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW/C,EACvB1B,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW7C,EACvB5B,EAAK8C,OAAO2B,KAAW/C,CAC1B,CAGL,GAAIW,EAAKK,QACL,IAAK,IAAIxC,EAAI,EAAGA,EAAImC,EAAKI,KAAO,EAAGvC,GAAK,EAAG,CACvC,IAAMuB,EAAIY,EAAKK,QAAQxC,EAAI,GACrBwB,EAAIW,EAAKK,QAAQxC,EAAI,GACrByB,EAAIU,EAAKK,QAAQxC,EAAI,GACrB0B,EAAIS,EAAKK,QAAQxC,EAAI,GAE3BF,EAAK8C,OAAO2B,KAAWhD,EACvBzB,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW/C,EACvB1B,EAAK8C,OAAO2B,KAAW9C,EACvB3B,EAAK8C,OAAO2B,KAAW7C,EACvB5B,EAAK8C,OAAO2B,KAAW/C,CAC1B,CAGL1B,EAAK+C,UAAY0B,EAAQ,EACzBzE,EAAK6C,MAAQ9C,KAAKqD,aAAaiB,OAC/BtE,KAAKoD,UAAUsC,KAAKzF,GAEpB,IAAM0F,EAAO,IAAIzF,YAAYD,EAAK6C,MAAQ7C,EAAKyC,MAK/C,OAJAiD,EAAKpF,IAAIP,KAAKqD,aAAc,GAC5BsC,EAAKpF,IAAIN,EAAK8C,OAAQ9C,EAAK6C,OAC3B9C,KAAKqD,aAAesC,EAEb1F,CACV,EAAAgD,CAAA,CAjckB,GCCV2C,GAAWC,EAAA,cADvBC,EAAQ,iBAAiBC,EAAAC,GAAA,WAEtB,SAAAJ,IAAA5F,KAAAiG,SAAAC,IAAAA,KAAAlG,KAAAmG,WAAAC,IAAAA,KAAApG,KAAAqG,cAAAC,IAAAA,KAAAtG,KAAAuG,aAAAC,IAAAA,IACA,CAgEC,OAhEAC,EAAAb,EAAA,CAAA,CAAA/C,IAAA,OAAAnC,IAqCD,WACI,IAAMgG,EAAK,IAAIC,EAAK,EAAG,GAGvB,OAFAD,EAAGE,MAAQ5G,KAAKmG,WAAW,GAAKU,EAAgC7G,KAAKiG,SACrES,EAAGI,OAAS9G,KAAKmG,WAAW,GAAKU,EAAgC7G,KAAKiG,SAC/DS,CACX,GAAC,CAAA7D,IAAA,YAAAnC,IAMD,WACI,IAAMqG,EAAa,CAAC,EAAG,GAGvB,OAFAA,EAAW,GAAK/G,KAAKmG,WAAW,GAAKU,EACrCE,EAAW,GAAK/G,KAAKmG,WAAW,GAAKU,EAC9BE,CACX,GAAC,CAAAlE,IAAA,cAAAnC,IAMD,WACI,IAAMsG,EAAehH,KAAKiH,UAG1B,OAFAD,EAAa,IAAM,EACnBA,EAAa,IAAM,EACZA,CACX,KAACpB,CAAA,CAnEqB,GAmErBM,GAAAgB,EAAAlB,GAAA1F,UAAA,WAAA,CA3DA6G,IAAY,WAAA,OAEK,CAAC,IAAAf,GAAAc,EAAAlB,GAAA1F,UAAA,aAAA,CAMlB6G,IAAY,WAAA,MAEiB,CAAC,EAAG,EAAE,IAAAb,GAAAY,EAAAlB,GAAA1F,UAAA,gBAAA,CAMnC6G,IAAY,WAAA,OAEU,GAAG,IAAAX,GAAAU,EAAAlB,GAAA1F,UAAA,eAAA,CAMzB6G,IAAY,WAAA,OAES,GAAG,IAlCHC,GAkCGpB,MAAAoB,IAyChBC,GAAYxB,EAAA,eADxBC,EAAQ,kBAAkBwB,EAAAC,GAAA,WAAAvH,KAAAwH,UAAAC,IAAAA,KAAAzH,KAAA0H,UAAAC,IAAAA,KAAA3H,KAAAiG,SAAA2B,IAAAA,KAAA5H,KAAA6H,SAAAC,IAAAA,KAAA9H,KAAA+H,UAAAC,IAAAA,IAAA,EAAAP,GAAAP,EAAAK,GAAAjH,UAAA,YAAA,CAMtB6G,IAAY,WAAA,OAEsB,IAAI,IAAAQ,GAAAT,EAAAK,GAAAjH,UAAA,YAAA,CAMtC6G,IAAY,WAAA,OAEsB,IAAI,IAAAS,GAAAV,EAAAK,GAAAjH,UAAA,WAAA,CAMtC6G,IAAY,WAAA,OAEK,CAAC,IAAAW,GAAAZ,EAAAK,GAAAjH,UAAA,WAAA,CAMlB6G,IAAY,WAAA,OAEK,CAAC,IAAAa,GAAAd,EAAAK,GAAAjH,UAAA,YAAA,CAMlB6G,IAAY,WAAA,OAEM,CAAC,IAxCGc,GAwCHV,MAAAU,IAOlBC,GAAkB,SAAAC,GAAA,SAAAD,IAAA,IAAA,IAAAE,EAAAC,EAAAC,UAAAhE,OAAAiE,EAAA,IAAAjF,MAAA+E,GAAAG,EAAA,EAAAA,EAAAH,EAAAG,IAAAD,EAAAC,GAAAF,UAAAE,GA8BqB,OA9BrBJ,EAAAD,EAAAM,KAAAC,MAAAP,EAAA,CAAAnI,MAAA2I,OAAAJ,KAAAvI,MAIb4I,OAA6B,KAAIR,EAIjCS,UAAqC,KAAIT,EAIzCU,WAA0B,KAAIV,EAI9BW,eAAkC,KAAIX,EAItCY,iBAAoC,KAAIZ,EAIxCa,uBAAyB,EAACb,EAM1Bc,UAA8B,KAAId,CAAA,CA9BrBe,EAAAjB,EAAAC,GA8BqB,IAAA/H,EAAA8H,EAAA5H,UAiKxC,OAjKwCF,EAElCgJ,QAAP,WAOI,OALmB,MAAfpJ,KAAK4I,SACLS,EAASC,SAASC,KAAKC,aAAaxJ,KAAK4I,QACzC5I,KAAK4I,OAAS,MAGlBT,EAAA7H,UAAa8I,QAAOX,KAAAzI,KACxB,EAACI,EAKMqJ,cAAP,WAEuB,MAAfzJ,KAAK4I,SACLS,EAASC,SAASC,KAAKC,aAAaxJ,KAAK4I,QACzC5I,KAAK4I,OAAS,MAGI,MAAlB5I,KAAK6I,YACL7I,KAAK6I,UAAUO,UACfpJ,KAAK6I,UAAY,KAEzB,EAACzI,EAKMsJ,iBAAP,WACiC,MAAzB1J,KAAKgJ,mBAIThJ,KAAK2J,kBAEL3J,KAAK8I,WAAa,KAClB9I,KAAKgJ,iBAAmB,KACL,MAAfhJ,KAAK4I,SACL5I,KAAK4I,OAAOgB,SAAU,GAE9B,EAACxJ,EAKMyJ,gBAAP,SAAwBC,EAAqBC,GACzC,GAAsB,MAAlB/J,KAAK6I,WAAoC,MAAf7I,KAAK4I,OAC/B,OAAO,EAGX,IAAMoB,EAAUF,EAAMG,cACtB,GAA6B,MAAzBjK,KAAKgJ,kBAA4BgB,IAAYhK,KAAKiJ,uBAAwB,CAQ1E,GAPAjJ,KAAKgJ,iBAAmB,IAAIkB,EAE5BlK,KAAKgJ,iBAAiBmB,WAAW,CAC7BC,YAAaN,EAAMO,aAAaC,iBAChCC,QAAST,EAAMU,oBAAoBR,KAGX,OAAxBhK,KAAK+I,eAAyB,CAE9B,IAAM0B,EAAwB,IAAIP,EAClCO,EAAsBC,KAAK1K,KAAK+I,gBAEhC/I,KAAK8I,WAAa,KACmB,OAAjC2B,EAAsBE,QAAmBF,EAAsBE,OAAOrG,OAAS,IAC/EtE,KAAK8I,WAAa2B,EAAsBE,OAAO,GAChC3K,KAAKgJ,iBAAiB2B,OAC9BjF,KAAK1F,KAAK8I,YACjB2B,EAAsBE,OAAOC,MAEpC,CAWD,OATIb,GACA/J,KAAK4I,OAAOiC,aAAa,EAAG7K,KAAK6I,UAAW7I,KAAKgJ,kBAGrDhJ,KAAK8K,kBAAkB9K,KAAKgJ,iBAAkB,GAE9ChJ,KAAKiJ,uBAAyBe,EAC9BhK,KAAK4I,OAAOgB,SAAU,EACtB5J,KAAK4I,OAAOmC,cAAgBjB,EAAMO,aAAaU,eACxC,CACV,CAED,OAAO,CACX,EAAC3K,EAKM4K,mBAAP,SAA2BC,EAA2BC,GAC/B,MAAflL,KAAK4I,SAIT5I,KAAKkJ,UAAY+B,EACjBjL,KAAKmL,yBACLnL,KAAK4I,OAAOwC,kBAAkBH,EAASC,GAC3C,EAAC9K,EAKMiL,oBAAP,SAA4BC,EAAaC,GAClB,MAAfvL,KAAK4I,QAGT5I,KAAKwL,cAAcF,EAAKC,GAAOvL,KAAKyL,sBACxC,EAACrL,EAKMoL,cAAP,SAAsBF,EAAaI,GAC3B1L,KAAK4I,QACL5I,KAAK4I,OAAO+C,oBAAoBL,EAAKI,EAE5C,EAAAtL,EAESuJ,gBAAV,WACuB,MAAf3J,KAAK4I,QAIT5I,KAAKqL,oBAAoB,EAAG,KAC/B,EAAAjL,EAESwL,yBAAV,SAAoCC,EAAoBC,QAAU,IAAVA,IAAAA,GAAa,GAC5D9L,KAAK4I,SACNkD,EACA9L,KAAK4I,OAAOmD,iBAAkB,EAG9B/L,KAAKgM,OAAUH,EAAa7L,KAAKgM,KAAKC,SAAWjM,KAAKgM,KAAKC,OAC3DJ,EAAa7L,KAAK4I,OAAOsD,SACzBlM,KAAK4I,OAAOmD,iBAAkB,EAE9B/L,KAAK4I,OAAOmD,iBAAkB,EAErC,EAAA3L,EAES+K,uBAAV,WACI,IAAMgB,EAAQnM,KAAKgM,KAAKG,MACxB,GAAKA,GAAUA,EAAMC,YAArB,CACA,IAAMC,EAAYF,EAAMC,YAAYC,UACpC,GAAKA,EAAL,CACA,IAAMR,EAAaQ,EAAUR,WACxBQ,EAAUL,OACXK,EAAUL,KAAKM,WAAaC,EAAaC,QAAUxM,KAAKkJ,UACxDlJ,KAAK4L,yBAAyBC,GAAY,GAE1C7L,KAAK4L,yBAAyBC,GANP,CAFkB,CAUhD,EAAAzL,EAEOqL,oBAAR,WACI,OAAOgB,EAAc/L,IAAc,mBACtC,EAAAwH,CAAA,CA/LmB,CAAQwE,GAuMnBC,GAAwB9G,EAAA,2BADpCC,EAAQ,8BAA8B8G,EAAAC,GAAA,WAAA7M,KAAAiL,QAAA6B,IAAAA,KAAA9M,KAAA+M,KAAAC,IAAAA,KAAAhN,KAAAiN,KAAAC,IAAAA,KAAAlN,KAAAmN,OAAAC,IAAAA,KAAApN,KAAAqN,OAAAC,IAAAA,IAAA,EAAAR,GAAA5F,EAAA2F,GAAAvM,UAAA,UAAA,CAElC6G,IAAY,WAAA,OAEoB,IAAI,IAAA6F,GAAA9F,EAAA2F,GAAAvM,UAAA,OAAA,CACpC6G,IAAY,WAAA,OAEC,CAAC,IAAA+F,GAAAhG,EAAA2F,GAAAvM,UAAA,OAAA,CACd6G,IAAY,WAAA,OAEC,CAAC,IAAAiG,GAAAlG,EAAA2F,GAAAvM,UAAA,SAAA,CACd6G,IAAY,WAAA,OAEG,CAAC,IAAAmG,GAAApG,EAAA2F,GAAAvM,UAAA,SAAA,CAChB6G,IAAY,WAAA,OAEG,CAAC,IAhBkBoG,GAgBlBV,MAAAU,IAORC,oBAAY,WAcrB,SAAAA,EAAaC,EAAYtN,EAAWK,GAASR,KAbrC0N,cAAQ,EAAA1N,KACR2N,WAAK,EAAA3N,KACL4N,iBAAW,EAAA5N,KACX6N,OAAmB,CAAC,EAAG,GAAE7N,KACzB8N,WAA6B,KAAI9N,KACjC+N,cAA+C,KAAI/N,KACnDgO,UAAY,EAAChO,KACbiO,QAAyB,IAAIhM,GAAejC,KAC5CkO,cAA0B,CAAC,EAAG,EAAG,EAAG,GAAElO,KACtCmO,gBAA4B,CAACnM,GAA0BA,GAA0BA,GAA0BA,IAAyBhC,KACpIoO,OAASC,IAAIrO,KACbsO,OAASD,IAGbrO,KAAK0N,SAAWD,EAChBzN,KAAK6N,OAAO,GAAK1N,EACjBH,KAAK6N,OAAO,GAAKrN,EACjBR,KAAK+N,cAAgBN,EAAEc,iBAAiBpO,EAAGK,GAE3CR,KAAK2N,MAAQ,IAAIa,EAAK,gBACtBxO,KAAK2N,MAAMc,UAAUzO,KAAK0N,SAAS1B,MACnChM,KAAK2N,MAAMe,WAAaC,EAAcC,SAAWD,EAAcE,gBAC/D7O,KAAK2N,MAAM1B,MAAQjM,KAAK0N,SAAS1B,KAAKC,MAEtCjM,KAAK4N,YAAc5N,KAAK2N,MAAMmB,aAAa5G,GAC/C,CAAC,IAAA9D,EAAAoJ,EAAAlN,UA8WA,OA9WA8D,EAEM2K,MAAP,WACI,IAAMC,EAAY1F,EAASC,KAAM0F,OAG3BC,EAAa,IAAIC,aAAaC,EAA4BC,EAAkCA,GAClGrP,KAAKsP,iBAAiBJ,GACtB,IAAMK,EAAeP,EAAUQ,aAAa,IAAIC,EAC5CC,EAAeC,OAASD,EAAeE,aACvCC,EAAeC,OACfV,EAA4BD,aAAaY,kBAAoBV,EAAkCA,EAC/FD,EAA4BD,aAAaY,oBAE7CR,EAAaS,OAAOd,GAGpBlP,KAAKiQ,oBAGL,IAAMC,EAA6B,CAC/B,IAAIC,EAAUC,EAAcC,cAAeC,EAAOC,QAClD,IAAIJ,EAAUC,EAAcI,YAAaF,EAAOC,QAChD,IAAIJ,EAAUC,EAAcK,eAAgBH,EAAOI,QAGvD1Q,KAAK4N,YAAY/E,UAAY,IAAI8H,EAC7B,CAACpB,GACDW,EACAU,EAAcC,cACd7Q,KAAK0N,SAASoD,wBACd,MACA,GAEJ9Q,KAAK4N,YAAYhF,OAAUS,EAASC,SAASC,KAAcwH,YAAY5E,GACvEnM,KAAK4N,YAAYhF,OAAOoI,oBAAoBhR,KAAKoO,OAAQpO,KAAKsO,QAC9DtO,KAAK4N,YAAYhF,OAAOoD,KAAOhM,KAAK4N,YAAYhF,OAAOqI,UAAYjR,KAAK2N,MAErC,MAA/B3N,KAAK4N,YAAY5B,KAAKG,QACtBnM,KAAKkR,SAAU,GAInBlR,KAAKmR,mBAGLnR,KAAK6J,iBAAgB,GAEjB7J,KAAK0N,SAAS0D,YAEdpR,KAAKqR,iBAAiBnC,GAEtBlP,KAAKsR,qBAEZ,EAAAlN,EAEMmN,QAAP,WACIvR,KAAKwR,gBACLxR,KAAKmR,mBAELnR,KAAK4N,YAAYlE,mBACjB1J,KAAK6J,iBAAgB,EACxB,EAAAzF,EAEMgF,QAAP,WACIpJ,KAAKkR,SAAU,EACflR,KAAK4N,YAAYnE,gBAEC,MAAdzJ,KAAK2N,OAAiB3N,KAAK2N,MAAM8D,SACjCzR,KAAK2N,MAAMvE,UAEQ,MAAnBpJ,KAAK8N,YACL9N,KAAK8N,WAAW1E,SAEvB,EAAAhF,EAEM4L,OAAP,WACIhQ,KAAK6J,iBAAgB,GAEjB7J,KAAK0R,WAAa1R,KAAK4N,YAAY1E,WACnClJ,KAAK4N,YAAY5C,mBAAmBhL,KAAK0R,SAAU1R,KAAK2R,iBAG5D,IAAMC,EAAe5R,KAAK0N,SAASkE,aAC7BC,EAAS7R,KAAK0N,SAASmE,OAGvBC,EAAe,SAAC7F,GAClB,OAAiB,OAAVA,EAAiBA,EAAMzE,UAAY,IAC7C,EAEKuK,EAAe,SAAC9F,GAClB,IAAI+F,EAAsB,OAAV/F,EAAiBA,EAAMvE,UAAY,KAKnD,OAJkB,OAAdsK,IACAA,EAAYvF,EAAc/L,IAAe,mBAGtCsR,CACV,EAEKzG,EAAMvL,KAAK4N,YAAY5E,iBAC7B,GAAY,OAARuC,EAAc,CACd,IAAMvB,EAAUhK,KAAKiK,cACfgI,EAAU,IAAIC,EAAK,EAAG,EAAG,EAAG,GAC5BnK,EAAY,IAAImK,EAAK,EAAG,EAAG,EAAG,GAC9BrK,EAAW,IAAIqK,EAAK,EAAG,EAAG,EAAG,GAEnC,GAAgB,IAAZlI,EACA,IAAwB,IAApBhK,KAAKmS,OAAO,GAAW,CACvB,IAAMC,EAAKpS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IAEnC,OAAPC,IACAH,EAAQnR,EAAI,EAAMsR,EAAGnM,SACrB8B,EAAUjH,EAAIsR,EAAGrK,UACjBF,EAAS/G,EAAIsR,EAAGvK,UAGpB0D,EAAI+G,YAAY,aAAcR,EAAaM,IACvCR,GACArG,EAAI+G,YAAY,aAAcP,EAAaK,GAElD,MACG7G,EAAI+G,YAAY,aAAc7F,EAAc/L,IAAe,oBACvDkR,GACArG,EAAI+G,YAAY,aAAc7F,EAAc/L,IAAe,wBAGhE,GAAgB,IAAZsJ,EAAe,CACtB,IAAMoI,EAAKpS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCI,EAAKvS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IAEnC,OAAPC,IACAH,EAAQnR,EAAI,EAAMsR,EAAGnM,SACrB8B,EAAUjH,EAAIsR,EAAGrK,UACjBF,EAAS/G,EAAIsR,EAAGvK,UAET,OAAP0K,IACAN,EAAQlR,EAAI,EAAMwR,EAAGtM,SACrB8B,EAAUhH,EAAIwR,EAAGxK,UACjBF,EAAS9G,EAAIwR,EAAG1K,UAGpB0D,EAAI+G,YAAY,YAAatS,KAAK8N,YAClCvC,EAAI+G,YAAY,aAAcR,EAAaM,IAC3C7G,EAAI+G,YAAY,aAAcR,EAAaS,IACvCX,IACArG,EAAI+G,YAAY,aAAcP,EAAaK,IAC3C7G,EAAI+G,YAAY,aAAcP,EAAaQ,IAElD,MAAM,GAAgB,IAAZvI,EAAe,CACtB,IAAMoI,EAAKpS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCI,EAAKvS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCK,EAAKxS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IAEnC,OAAPC,IACAH,EAAQnR,EAAI,EAAMsR,EAAGnM,SACrB8B,EAAUjH,EAAIsR,EAAGrK,UACjBF,EAAS/G,EAAIsR,EAAGvK,UAET,OAAP0K,IACAN,EAAQlR,EAAI,EAAMwR,EAAGtM,SACrB8B,EAAUhH,EAAIwR,EAAGxK,UACjBF,EAAS9G,EAAIwR,EAAG1K,UAET,OAAP2K,IACAP,EAAQQ,EAAI,EAAMD,EAAGvM,SACrB8B,EAAU0K,EAAID,EAAGzK,UACjBF,EAAS4K,EAAID,EAAG3K,UAGpB0D,EAAI+G,YAAY,YAAatS,KAAK8N,YAClCvC,EAAI+G,YAAY,aAAcR,EAAaM,IAC3C7G,EAAI+G,YAAY,aAAcR,EAAaS,IAC3ChH,EAAI+G,YAAY,aAAcR,EAAaU,IACvCZ,IACArG,EAAI+G,YAAY,aAAcP,EAAaK,IAC3C7G,EAAI+G,YAAY,aAAcP,EAAaQ,IAC3ChH,EAAI+G,YAAY,aAAcP,EAAaS,IAElD,MAAM,GAAgB,IAAZxI,EAAe,CACtB,IAAMoI,EAAKpS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCI,EAAKvS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCK,EAAKxS,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IACxCO,EAAK1S,KAAK0N,SAAS2E,SAASrS,KAAKmS,OAAO,IAEnC,OAAPC,IACAH,EAAQnR,EAAI,EAAMsR,EAAGnM,SACrB8B,EAAUjH,EAAIsR,EAAGrK,UACjBF,EAAS/G,EAAIsR,EAAGvK,UAET,OAAP0K,IACAN,EAAQlR,EAAI,EAAMwR,EAAGtM,SACrB8B,EAAUhH,EAAIwR,EAAGxK,UACjBF,EAAS9G,EAAIwR,EAAG1K,UAET,OAAP2K,IACAP,EAAQQ,EAAI,EAAMD,EAAGvM,SACrB8B,EAAU0K,EAAID,EAAGzK,UACjBF,EAAS4K,EAAID,EAAG3K,UAET,OAAP6K,IACAT,EAAQnS,EAAI,EAAM4S,EAAGzM,SACrB8B,EAAUjI,EAAI4S,EAAG3K,UACjBF,EAAS/H,EAAI4S,EAAG7K,UAGpB0D,EAAI+G,YAAY,YAAatS,KAAK8N,YAClCvC,EAAI+G,YAAY,aAAcR,EAAaM,IAC3C7G,EAAI+G,YAAY,aAAcR,EAAaS,IAC3ChH,EAAI+G,YAAY,aAAcR,EAAaU,IAC3CjH,EAAI+G,YAAY,aAAcR,EAAaY,IACvCd,IACArG,EAAI+G,YAAY,aAAcP,EAAaK,IAC3C7G,EAAI+G,YAAY,aAAcP,EAAaQ,IAC3ChH,EAAI+G,YAAY,aAAcP,EAAaS,IAC3CjH,EAAI+G,YAAY,aAAcP,EAAaW,IAElD,CAEDnH,EAAI+G,YAAY,UAAWL,GACvBJ,IACAtG,EAAI+G,YAAY,YAAavK,GAC7BwD,EAAI+G,YAAY,WAAYzK,GAEnC,CACL,EAACzD,EAKMuO,cAAP,WACI,IAAMzD,EAAa,IAAIC,aAAaC,EAA4BC,EAAkCA,GAClGrP,KAAKsP,iBAAiBJ,GAEtBlP,KAAKqR,iBAAiBnC,GAEtBlP,KAAKsR,oBACT,EAAClN,EAMMwO,aAAP,SAAqBC,GACjB,IAAMC,EAAU9S,KAAK0N,SACfqF,EAAcD,EAAQ9G,KAGtBgH,EAAQ3E,IACR4E,EAAQ5E,IAEd6E,EAAKC,IAAIH,EAAOhT,KAAKoO,OAAQ2E,EAAYK,eACzCF,EAAKC,IAAIF,EAAOjT,KAAKsO,OAAQyE,EAAYK,eAEzC,IAAMC,EAAKH,EAAKI,SAASN,EAAOH,GAC1BU,EAAKL,EAAKI,SAASL,EAAOJ,GAC5BhR,EAAIV,KAAKqS,IAAIH,EAAIE,GAKrB,IAHA1R,GAAKiR,EAAQW,QAEbzT,KAAKgO,UAAY,EACVhO,KAAKgO,UAdKzK,KAgBT1B,GADQ7B,KAAKmO,gBAAgBnO,KAAKgO,UAAY,OAKhDhO,KAAKgO,SAEd,EAAA5J,EAEMsP,iBAAP,SAAyBnI,GACjBvL,KAAK4N,YAAY7E,iBAAmBwC,IACpCvL,KAAK4N,YAAYlE,mBACjB1J,KAAK4N,YAAY7E,eAAiBwC,EAEzC,EAAAnH,EAEMuP,kBAAP,WACI,OAAO3T,KAAK4N,YAAc5N,KAAK4N,YAAY7E,eAAiB,IAC/D,EAAA3E,EAEMwP,cAAP,WACI,OAAO5T,KAAK4N,YAAc5N,KAAK4N,YAAY9E,WAAa,IAC5D,EAAC1E,EAgGMiG,WAAP,WACI,OAAOrK,KAAK0N,QAChB,EAACtJ,EAMMyP,SAAP,WACI,OAAO7T,KAAK6N,MAChB,EAACzJ,EAMM0P,QAAP,WACI,IAAMC,EAAO,IAAIC,EAMjB,OALAD,EAAKjT,EAAId,KAAK6N,OAAO,GAAKhH,EAC1BkN,EAAKhT,EAAIf,KAAK6N,OAAO,GAAKhH,EAC1BkN,EAAKnN,MAAQC,EACbkN,EAAKjN,OAASD,EAEPkN,CACX,EAAC3P,EAMM6P,SAAP,SAAiBvP,EAAewP,GACxBlU,KAAKmS,OAAOzN,KAAWwP,IACvBlU,KAAK0N,SAASyG,cAAcnU,KAAK6N,OAAO,GAAI7N,KAAK6N,OAAO,GAAInJ,EAAOwP,GACnElU,KAAK4N,YAAYlE,mBACjB1J,KAAK6J,iBAAgB,GAE7B,EAACzF,EAMMiO,SAAP,SAAiB3N,GACb,OAAO1E,KAAKmS,OAAOzN,EACvB,EAACN,EAMM6F,YAAP,WACI,OAAIjK,KAAKmS,OAAO,IAAM,EACX,EAEPnS,KAAKmS,OAAO,IAAM,EACX,EAEPnS,KAAKmS,OAAO,IAAM,EACX,EAGJ,CACV,EAAA/N,EAEMoG,oBAAP,SAA4BR,GACxB,IAAIoK,EAAqB,EAMzB,OALIpU,KAAK0N,SAAS1B,MAAQhM,KAAK0N,SAAS1B,KAAKG,OACrCnM,KAAK0N,SAAS1B,KAAKG,MAAMkI,QAAQC,+BACjCF,EAAqB,GAGtB,CACHG,OAAQvK,EAAU,EAClBwK,gBAAmC,OAAlBxU,KAAK0R,SAAoB0C,EAAqB,EAC/DK,cAAezU,KAAK0N,SAASkE,aAAe,EAAI,EAChD8C,QAAS1U,KAAK0N,SAASmE,OAAS,EAAI,EAG3C,EAAAzN,EAEMsF,iBAAP,WACI1J,KAAK4N,YAAYlE,kBACpB,EAAAtF,EAEMyF,gBAAP,SAAwBE,GAChB/J,KAAK4N,YAAY/D,gBAAgB7J,KAAM+J,KAEjB,OAAlB/J,KAAK0R,UACL1R,KAAK0R,SAASiD,YAAYC,EAASC,gBAAiBD,EAASC,iBAGjE7U,KAAK4N,YAAY5C,mBAAmBhL,KAAK0R,SAAU1R,KAAK2R,iBAE/D,EAAAvN,EAEMoN,cAAP,WACI,GAAkC,MAA9BxR,KAAK4N,YAAY/E,UAArB,CAIA,IAAMqG,EAAa,IAAIC,aAAaC,EAA4BC,EAAkCA,GAClGrP,KAAKsP,iBAAiBJ,GACtBlP,KAAK4N,YAAY/E,UAAUiM,cAAc,GAAG9E,OAAOd,GAEnDlP,KAAKiQ,oBACLjQ,KAAK4N,YAAYhF,OAAQoI,oBAAoBhR,KAAKoO,OAAQpO,KAAKsO,QAC/DtO,KAAK4N,YAAYhF,OAAQmM,mBAEzB/U,KAAKqR,iBAAiBnC,GAEtBlP,KAAKsR,oBAZJ,CAaJ,EAAAlN,EAEM+M,iBAAP,WAGI,GAAgB,IAFAnR,KAAKiK,cAErB,CASuB,MAAnBjK,KAAK8N,aACL9N,KAAK8N,WAAa,IAAIkH,EACtBhV,KAAK8N,WAAWmH,OAAOjV,KAAK0N,SAASrH,cAAerG,KAAK0N,SAASrH,cAAe6O,EAAYC,UAC7FnV,KAAK8N,WAAWsH,WAAWC,EAAcC,OAAQD,EAAcC,QAC/DtV,KAAK8N,WAAW6G,YAAYC,EAASW,cAAeX,EAASW,gBAKjE,IAFA,IAAMC,EAAa,IAAIC,WAAWzV,KAAK0N,SAASrH,cAAgBrG,KAAK0N,SAASrH,cAAgB,GAC1FqP,EAAc,EACTlV,EAAI,EAAGA,EAAIR,KAAK0N,SAASrH,gBAAiB7F,EAC/C,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAK0N,SAASrH,gBAAiBlG,EAAG,CAClD,IAAMW,EAAId,KAAK6N,OAAO,GAAK7N,KAAK0N,SAASrH,cAAgBlG,EACnDY,EAAIf,KAAK6N,OAAO,GAAK7N,KAAK0N,SAASrH,cAAgB7F,EACnDV,EAAIE,KAAK0N,SAASiI,UAAU7U,EAAGC,GAErCyU,EAAyB,EAAdE,EAAkB,GAAKvU,KAAKC,MAAY,IAANtB,EAAEgB,GAC/C0U,EAAyB,EAAdE,EAAkB,GAAKvU,KAAKC,MAAY,IAANtB,EAAEiB,GAC/CyU,EAAyB,EAAdE,EAAkB,GAAKvU,KAAKC,MAAY,IAANtB,EAAE2S,GAC/C+C,EAAyB,EAAdE,EAAkB,GAAKvU,KAAKC,MAAY,IAANtB,EAAEA,GAE/C4V,GAAe,CAClB,CAEL1V,KAAK8N,WAAW8H,WAAWJ,EAzB1B,MAN0B,MAAnBxV,KAAK8N,aACL9N,KAAK8N,WAAW1E,UAChBpJ,KAAK8N,WAAa,KA8B9B,EAAC1J,EAKMyR,gBAAP,SAAwBC,GACpB9V,KAAK+N,cAAgB+H,EACrB9V,KAAK0J,kBACT,EAACtF,EAKM2R,WAAP,WACI,IAAMlT,EAAM,IAAIZ,GAOhB,GANAY,EAAIX,MAAQlC,KAAKgO,UACjBnL,EAAIV,MAAQnC,KAAKgO,UACjBnL,EAAIT,MAAQpC,KAAKgO,UACjBnL,EAAIR,KAAOrC,KAAKgO,UAChBnL,EAAIP,KAAOtC,KAAKgO,UAEZhO,KAAK6N,OAAO,GAAK,EAAG,CACpB,IAAM7J,EAAIhE,KAAKqK,aAAa2L,SAAShW,KAAK6N,OAAO,GAAK,EAAG7N,KAAK6N,OAAO,IACrEhL,EAAIR,KAAO2B,EAAEgK,UACTnL,EAAIR,KAAOrC,KAAKgO,YAChBnL,EAAIR,KAAOrC,KAAKgO,UAEvB,CAED,GAAIhO,KAAK6N,OAAO,GAAK7N,KAAK0N,SAASoI,KAAK3P,WAAW,GAAK,EAAG,CACvD,IAAMnC,EAAIhE,KAAKqK,aAAa2L,SAAShW,KAAK6N,OAAO,GAAK,EAAG7N,KAAK6N,OAAO,IACrEhL,EAAIP,KAAO0B,EAAEgK,UACTnL,EAAIP,KAAOtC,KAAKgO,YAChBnL,EAAIP,KAAOtC,KAAKgO,UAEvB,CAED,GAAIhO,KAAK6N,OAAO,GAAK,EAAG,CACpB,IAAM7J,EAAIhE,KAAKqK,aAAa2L,SAAShW,KAAK6N,OAAO,GAAI7N,KAAK6N,OAAO,GAAK,GACtEhL,EAAIV,MAAQ6B,EAAEgK,UACVnL,EAAIV,MAAQnC,KAAKgO,YACjBnL,EAAIV,MAAQnC,KAAKgO,UAExB,CAED,GAAIhO,KAAK6N,OAAO,GAAK7N,KAAK0N,SAASoI,KAAK3P,WAAW,GAAK,EAAG,CACvD,IAAMnC,EAAIhE,KAAKqK,aAAa2L,SAAShW,KAAK6N,OAAO,GAAI7N,KAAK6N,OAAO,GAAK,GACtEhL,EAAIT,MAAQ4B,EAAEgK,UACVnL,EAAIT,MAAQpC,KAAKgO,YACjBnL,EAAIT,MAAQpC,KAAKgO,UAExB,CAEGhO,KAAKiO,QAAQ1L,OAAOM,KAIxB7C,KAAKiO,QAAUpL,EACf7C,KAAKsR,qBACT,EAAClN,EAKM6R,UAAP,WACI,IAAMpT,EAAM,IAAIZ,GAChBY,EAAIX,MAAQ,EACZW,EAAIV,MAAQ,EACZU,EAAIT,MAAQ,EACZS,EAAIR,KAAO,EACXQ,EAAIP,KAAO,EAEPtC,KAAKiO,QAAQ1L,OAAOM,KAIxB7C,KAAKiO,QAAUpL,EACf7C,KAAKsR,qBACT,EAAClN,EAKMkN,mBAAP,WACI,GAAmC,OAA/BtR,KAAK4N,YAAY/E,WAGW,OAA5B7I,KAAK4N,YAAYhF,QAG4B,IAA7C5I,KAAK4N,YAAYhF,OAAOsN,UAAU5R,OAAtC,CAIA,IAAM6R,EAAYnW,KAAK0N,SAAS0I,cAAcpW,KAAKiO,SACnD,GAAkB,OAAdkI,EAAJ,CAIA,IAAME,EAAQrW,KAAK4N,YAAYhF,OAAOsN,UAAU,GAChDG,EAAMC,eAAeC,WAAaJ,EAAUrT,MAC5CuT,EAAMC,eAAeE,WAAaL,EAAUzT,IAJ3C,CALA,CAUJ,EAAA0B,EAEOqS,WAAR,SAAoB3V,EAAWC,EAAW2V,GAEtC,OAAOA,GADKrH,EAAkCtO,EAAID,GAC/BsO,EAA4B,EAClD,EAAAhL,EAEOiN,iBAAR,SAA0BsF,GACtB3W,KAAKgO,UAAY,EACjBhO,KAAKiO,QAAU,IAAIhM,GACnBjC,KAAK4W,kBAAkBD,GACvB3W,KAAK6W,oBAAoBF,EAC5B,EAAAvS,EAEOwS,kBAAR,SAA2BD,GACvB3W,KAAKkO,cAAc,GAAK,EAExB,IAAK,IAAI/N,EAAI,EAAGA,EDxhCU,ICwhCgBA,EACtCH,KAAKkO,cAAc/N,GAAKH,KAAK8W,iBAAiB3W,EAAGwW,GAGrD,IAAK,IAAIxW,EAAI,EAAGA,ED5hCU,IC4hCgBA,EACtCH,KAAKkO,cAAc/N,GAAKgB,KAAK4V,IAAI/W,KAAKkO,cAAc/N,GAAKH,KAAKkO,cAAc/N,EAAI,GAEvF,EAAAiE,EAEO0S,iBAAR,SAA0B5U,EAAeyU,GAQrC,IAPA,IAAIK,EAAM,EACJzS,EAAO,GAAKrC,EACZ+U,EAAmB5H,EACnB6H,EAAmB7H,EACnB8H,EAAUF,EAAmB,GAAM/U,EACnCkV,EAAUF,EAAmB,GAAMhV,EAEhCnB,EAAI,EAAGA,EAAImW,EAAkBnW,GAAKwD,EACvC,IAAK,IAAIzD,EAAI,EAAGA,EAAIqW,IAAUrW,EAAI,CAC9B,IAAMwE,EAAKxE,EAAIyD,EACTW,EAAKI,EAAKf,EACV8S,GAAMnS,EAAKI,GAAM,EAEjBgS,EAAKtX,KAAKyW,WAAWnR,EAAIvE,EAAG4V,GAC5BY,EAAKvX,KAAKyW,WAAWvR,EAAInE,EAAG4V,GAC5Ba,EAAKxX,KAAKyW,WAAWY,EAAItW,EAAG4V,GAC5Bc,GAAOH,EAAKC,GAAM,EAElBG,EAAQvW,KAAKwW,IAAIH,EAAKC,GAE5BT,EAAM7V,KAAK4V,IAAIC,EAAKU,EACvB,CAGL,IAAK,IAAI5W,EAAI,EAAGA,EAAImW,EAAkBnW,GAAKyD,EACvC,IAAK,IAAIxD,EAAI,EAAGA,EAAIqW,IAAUrW,EAAG,CAC7B,IAAMwE,EAAKxE,EAAIwD,EACTqT,EAAKrS,EAAKhB,EACVsT,GAAMtS,EAAKqS,GAAM,EAEjBN,EAAKtX,KAAKyW,WAAW3V,EAAGyE,EAAIoR,GAC5BY,EAAKvX,KAAKyW,WAAW3V,EAAG8W,EAAIjB,GAC5Ba,EAAKxX,KAAKyW,WAAW3V,EAAG+W,EAAIlB,GAC5Bc,GAAOH,EAAKC,GAAM,EAElBG,EAAQvW,KAAKwW,IAAIH,EAAKC,GAE5BT,EAAM7V,KAAK4V,IAAIC,EAAKU,EACvB,CAGL,IAAK,IAAI3W,EAAI,EAAGA,EAAIqW,IAAUrW,EAK1B,IAJA,IAAMwE,EAAKxE,EAAIwD,EACTqT,EAAKrS,EAAKhB,EACVsT,GAAMtS,EAAKqS,GAAM,EAEd9W,EAAI,EAAGA,EAAIqW,IAAUrW,EAAG,CAC7B,IAAMwE,EAAKxE,EAAIyD,EACTW,EAAKI,EAAKf,EACV8S,GAAM/R,EAAKJ,GAAM,EAEjBoS,EAAKtX,KAAKyW,WAAWnR,EAAIC,EAAIoR,GAC7BY,EAAKvX,KAAKyW,WAAWvR,EAAI0S,EAAIjB,GAC7Ba,EAAKxX,KAAKyW,WAAWY,EAAIQ,EAAIlB,GAC7Bc,GAAOH,EAAKC,GAAM,EAElBG,EAAQvW,KAAKwW,IAAIH,EAAKC,GAE5BT,EAAM7V,KAAK4V,IAAIC,EAAKU,EACvB,CAGL,OAAOV,CACV,EAAA5S,EAEOyS,oBAAR,WAKI,IAJA,IAIS1W,EAAI,EAAGA,EDxmCU,ICwmCgBA,EAAG,CACzC,IACM0B,EAJA,GAGI7B,KAAKkO,cAAc/N,GAE7BH,KAAKmO,gBAAgBhO,GAAK0B,CAC7B,CACJ,EAAAuC,EAEOkL,iBAAR,SAA0BJ,GAEtB,IADA,IAAIxK,EAAQ,EACHlE,EAAI,EAAGA,EAAI6O,IAAmC7O,EACnD,IAAK,IAAIL,EAAI,EAAGA,EAAIkP,IAAmClP,EAAG,CACtD,IAAMW,EAAId,KAAK6N,OAAO,GAAKhH,EAAgC1G,EACrDY,EAAIf,KAAK6N,OAAO,GAAKhH,EAAgCrG,EACrDsX,EAAW9X,KAAK0N,SAASqK,YAAYjX,EAAGC,GACxCiX,EAAShY,KAAK0N,SAASuK,UAAUnX,EAAGC,GACpCmX,EAAK,IAAIC,EAAKhY,EAAI0G,EAA+BrG,EAAIqG,GAC3DqI,EAAWxK,KAAWoT,EAAShX,EAC/BoO,EAAWxK,KAAWoT,EAAS/W,EAC/BmO,EAAWxK,KAAWoT,EAASrF,EAC/BvD,EAAWxK,KAAWsT,EAAOlX,EAC7BoO,EAAWxK,KAAWsT,EAAOjX,EAC7BmO,EAAWxK,KAAWsT,EAAOvF,EAC7BvD,EAAWxK,KAAWwT,EAAGpX,EACzBoO,EAAWxK,KAAWwT,EAAGnX,CAC5B,CAER,EAAAqD,EAEO6L,kBAAR,WACIjQ,KAAKoO,OAAO7N,IAAI6X,OAAOC,UAAWD,OAAOC,UAAWD,OAAOC,WAC3DrY,KAAKsO,OAAO/N,IAAI6X,OAAOE,UAAWF,OAAOE,UAAWF,OAAOE,WAC3D,IAAK,IAAI9X,EAAI,EAAGA,EAAI6O,IAAmC7O,EACnD,IAAK,IAAIL,EAAI,EAAGA,EAAIkP,IAAmClP,EAAG,CACtD,IAAMW,EAAId,KAAK6N,OAAO,GAAKhH,EAAgC1G,EACrDY,EAAIf,KAAK6N,OAAO,GAAKhH,EAAgCrG,EACrDsX,EAAW9X,KAAK0N,SAASqK,YAAYjX,EAAGC,GAC9CmS,EAAKM,IAAIxT,KAAKoO,OAAQpO,KAAKoO,OAAQ0J,GACnC5E,EAAK6D,IAAI/W,KAAKsO,OAAQtO,KAAKsO,OAAQwJ,EACtC,CAER,EAAArR,EAAA+G,EAAA,CAAA,CAAA3K,IAAA,QAAAnC,IA9dD,WACI,GAAsB,OAAlBV,KAAK0N,SACL,OAAO,EAIX,IADA,IAAM6K,EAASvY,KAAK0N,SAAS8K,YACpBrY,EAAI,EAAGA,EAAIoY,EAAOjU,SAAUnE,EACjC,GAAIoY,EAAOpY,KAAOH,KACd,OAAO,EAIf,OAAO,CACX,GAAC,CAAA6C,IAAA,WAAAnC,IAMD,WACI,OAAOV,KAAK4N,YAAc5N,KAAK4N,YAAY5E,iBAAmB,IAClE,GAAC,CAAAnG,IAAA,SAAAnC,IAMD,WACI,OAAOV,KAAK0N,SAAS+K,eAAezY,KAAK6N,OAAO,GAAI7N,KAAK6N,OAAO,GACpE,GAAC,CAAAhL,IAAA,YAAAnC,IAMD,WACI,OAAOV,KAAK8N,UAChB,GAAC,CAAAjL,IAAA,WAAAnC,IAMD,WACI,OAAOV,KAAK+N,cAAgB/N,KAAK+N,cAAc9C,QAAU,IAC7D,GAAC,CAAApI,IAAA,kBAAAnC,IAMD,WACI,OAA0B,MAAtBV,KAAK+N,cACE,IAAImE,EAAKlS,KAAK+N,cAAchB,KAAM/M,KAAK+N,cAAcd,KAAMjN,KAAK+N,cAAcZ,OAAQnN,KAAK+N,cAAcV,QAG7G,IAAI6E,EAAK,EAAG,EAAG,EAAG,EAC7B,GAAC,CAAArP,IAAA,UAAAnC,IAqBD,WACI,OAAgC,OAA5BV,KAAK4N,YAAYhF,QACwB,OAAlC5I,KAAK4N,YAAYhF,OAAOuD,KAIvC,EAAC5L,IArBD,SAAamY,GACuB,OAA5B1Y,KAAK4N,YAAYhF,SACb8P,EAC0B,MAAtB1Y,KAAK0N,SAAS1B,MACiB,MAA5BhM,KAAK0N,SAAS1B,KAAKG,OACqB,MAAxCnM,KAAK0N,SAAS1B,KAAKG,MAAMC,aACQ,MAAjCpM,KAAK4N,YAAYhF,OAAOuD,OAC3BnM,KAAK0N,SAAS1B,KAAKG,MAAMC,YAAYuM,SAAS3Y,KAAK4N,YAAYhF,QAE1B,OAAlC5I,KAAK4N,YAAYhF,OAAOuD,OAC/BnM,KAAK4N,YAAYhF,OAAOuD,MAAMyM,YAAY5Y,KAAK4N,YAAYhF,QAGvE,KAAC4E,CAAA,CAxYoB,IAsyBJ3H,EAAA,WALpBC,GAAAA,EAAQ,iBAMJ+S,EAAKC,GAAaC,GAKlBF,EAAKG,GAMLH,GAAAA,EAAKlM,IAqBLkM,GAAAA,EAAKI,MA8BLJ,EAAKC,GAAaI,GAyDlBL,EAAKG,GAoNLH,GAAAA,EAAKjT,UA7UTuT,GAAgBC,GAAA,SAAAC,GAuDb,SAAAC,IAAA,IAAAC,GACIA,EAAOF,EAAA5Q,KAAAzI,OAAAA,MAACwZ,QAAAC,IAAAA,KAAAF,EAAAG,aAAAC,IAAAA,KAAAJ,EAAAK,eAAAC,IAAAA,KAAAN,EAAAO,eAAAC,IAAAA,KAAAR,EAAAS,cAAAC,IAAAA,KAAAV,EAAAW,QAAAC,IAAAA,KAAAZ,EAAAa,WAAAC,IAAAA,KAAAd,EAAAe,SAAAC,IAAAA,KAAAhB,EAhBFiB,aAAkC,KAAIjB,EACtCkB,UAAY,EAAClB,EACbmB,YAAwB,CAAC,EAAG,GAAEnB,EAC9BoB,eAAiB,IAAGpB,EACpBqB,cAAgB,IAAGrB,EACnBsB,SAAwB,IAAI3a,YAAaqZ,EACzCuB,SAAuB,IAAIrF,WAAY8D,EACvCwB,SAAyB,IAAI5L,aAAcoK,EAC3CyB,WAAoC,GAAEzB,EACtC0B,aAAyB,GAAE1B,EAC3B2B,QAA0B,GAAE3B,EAC5B4B,KAAwB,KAAI5B,EAC5B6B,mBAAkC,KAAI7B,EACtC8B,sBAAqC,KAM3C,IAAK,IAAIlb,EAAI,EAAGA,EAAImb,IAA2Bnb,EAC3CoZ,EAAKyB,WAAWtV,KAAK,MACxB,OAAA6T,CACL,CA9DapQ,EAAAmQ,EAAAD,GA8DZ,IAAAkC,EAAAjC,EAAAhZ,UAyRA,OAzRAib,EA+RMxM,MAAP,SAAc+G,GAOV,OANA9V,KAAKya,UAAY3E,EAAK7P,SACtBjG,KAAK0a,YAAY,GAAK5E,EAAK3P,WAAW,GACtCnG,KAAK0a,YAAY,GAAK5E,EAAK3P,WAAW,GACtCnG,KAAK2a,eAAiB7E,EAAKzP,cAC3BrG,KAAK4a,cAAgB9E,EAAKvP,aAEnBvG,KAAKwb,WAChB,EAACD,EAMMhK,QAAP,SAAgBuE,GACZ,IAAK,IAAI3V,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGiJ,UAEpBpJ,KAAKkb,QAAU,GAGflb,KAAKyb,gBAAe,GAGpBzb,KAAK0b,oBAAoB5F,GAGzB,IAAM6F,EAAiB3b,KAAK4b,gBAAgB9F,GAG5C9V,KAAK6b,gBAAgB/F,GAGrB9V,KAAKya,UAAY3E,EAAK7P,SACtBjG,KAAK0a,YAAY,GAAK5E,EAAK3P,WAAW,GACtCnG,KAAK0a,YAAY,GAAK5E,EAAK3P,WAAW,GACtCnG,KAAK2a,eAAiB7E,EAAKzP,cAC3BrG,KAAK4a,cAAgB9E,EAAKvP,aAGtBoV,IACA3b,KAAK+a,SAAW,IAAI5L,aAAmC,EAAtBnP,KAAK8b,QAAQxX,QAC9CtE,KAAK+b,iBAIT,IAAK,IAAIvb,EAAI,EAAGA,EAAIR,KAAK0a,YAAY,KAAMla,EACvC,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAK0a,YAAY,KAAMva,EACvCH,KAAKkb,QAAQxV,KAAK,IAAI8H,GAAaxN,KAAMG,EAAGK,IAIpD,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG4O,OAExB,EAACwM,EAMMS,kBAAP,SAA0BC,EAAiBC,GAEvC,IADA,IAAIxX,EAAQ,EACHlE,EAAI,EAAGA,EAAIR,KAAKmc,YAAY,KAAM3b,EACvC,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAKmc,YAAY,KAAMhc,EAAG,CAC1C,IAAMic,EAAIjc,EAAIH,KAAKiH,UAAU,GACvBoV,EAAI7b,EAAIR,KAAKiH,UAAU,GAEvBlH,EAAIkc,EAAGpb,MAAMub,EAAIH,EAAGnc,EAAGuc,EAAIJ,EAAGlc,GAAKmc,EAEzClc,KAAK6a,SAASnW,KAAW3E,CAC5B,CAGLC,KAAK+b,gBAGL,IAAK,IAAI5b,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGqR,eAExB,EAAC+J,EAMMe,kBAAP,SAA0BL,EAAiBC,GAEvC,IADA,IAAIxX,EAAQ,EACHlE,EAAI,EAAGA,EAAIyb,EAAGlc,IAAKS,EACxB,IAAK,IAAIL,EAAI,EAAGA,EAAI8b,EAAGnc,IAAKK,EAAG,CAC3B,IAAMic,EAAIjc,GAAK8b,EAAGnc,EAAI,GAChBuc,EAAI7b,GAAKyb,EAAGlc,EAAI,GAEhBe,EAAIsb,EAAIpc,KAAK0C,KAAKkE,MAClB7F,EAAIsb,EAAIrc,KAAK0C,KAAKoE,OAElB/G,EAAIC,KAAKuc,YAAYzb,EAAGC,GACrB,MAALhB,IACAkc,EAAGhc,KAAKyE,KAAW3E,EAAImc,EAE9B,CAER,EAAAX,EAEMiB,YAAP,WACI,IAAMC,EAAQ,IAAI3D,EAElB2D,EAAMxW,SAAWjG,KAAKiG,SACtBwW,EAAMtW,WAAanG,KAAKmG,WACxBsW,EAAMlW,aAAevG,KAAKuG,aAC1BkW,EAAMpW,cAAgBrG,KAAKqG,cAC3BoW,EAAMX,QAAU9b,KAAK8b,QACrBW,EAAMC,QAAU1c,KAAK0c,QAErBD,EAAME,YAAc,IAAIrZ,MAAoC,EAAtBtD,KAAKkb,QAAQ5W,QACnD,IAAK,IAAInE,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCsc,EAAME,YAAgB,EAAJxc,EAAQ,GAAKH,KAAKkb,QAAQ/a,GAAGgS,OAAO,GACtDsK,EAAME,YAAgB,EAAJxc,EAAQ,GAAKH,KAAKkb,QAAQ/a,GAAGgS,OAAO,GACtDsK,EAAME,YAAgB,EAAJxc,EAAQ,GAAKH,KAAKkb,QAAQ/a,GAAGgS,OAAO,GACtDsK,EAAME,YAAgB,EAAJxc,EAAQ,GAAKH,KAAKkb,QAAQ/a,GAAGgS,OAAO,GAK1D,OAFAnS,KAAK4c,uBAAuBH,GAErBA,CACV,EAAAlB,EAEMqB,uBAAP,SAA+BH,GAC3BA,EAAMI,WAAWvY,OAAS,EAC1B,IAAK,IAAInE,EAAI,EAAGA,EAAIH,KAAKgb,WAAW1W,SAAUnE,EAAG,CAC7C,IAAMwF,EAAO3F,KAAKgb,WAAW7a,GAC7B,GAAIwF,GAAQA,EAAK6B,WAAaiK,EAAQ9L,EAAK6B,WAAY,CACnD,IAAMyE,EAAQ,IAAI6Q,EAClB7Q,EAAM8Q,KAAO5c,EACb8L,EAAMhG,SAAWN,EAAKM,SACtBgG,EAAMzE,UAAY7B,EAAK6B,UACvByE,EAAMvE,UAAY/B,EAAK+B,UACvBuE,EAAMpE,SAAWlC,EAAKkC,SACtBoE,EAAMlE,UAAYpC,EAAKoC,UACvB0U,EAAMI,WAAWnX,KAAKuG,EACzB,CACJ,CACJ,EAAAsP,EAEMjR,eAAP,WACI,OAA0B,OAAtBtK,KAAK0Z,aACErQ,EAAS2P,YAAYtY,IAhnDZ,wCAmnDbV,KAAK0Z,YACf,EAAA6B,EAEMyB,SAAP,WACgC,IAAxBhd,KAAKkb,QAAQ5W,QACbtE,KAAKwb,YAGT,IAAK,IAAIrb,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG+Q,SAAU,EAG7B7H,EAASC,SAASC,KAAc0T,cAAcC,GAAGC,EAAkBC,oBAAqBpd,KAAKqd,mBAAoBrd,KACrH,EAAAub,EAEM+B,UAAP,WACKjU,EAASC,SAASC,KAAc0T,cAAcM,IAAIJ,EAAkBC,oBAAqBpd,KAAKqd,mBAAoBrd,MAEnH,IAAK,IAAIG,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG+Q,SAAU,CAEjC,EAAAqK,EAEMiC,UAAP,WACI,IAAK,IAAIrd,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGiJ,UAEpBpJ,KAAKkb,QAAU,GAEf,IAAK,IAAI/a,EAAI,EAAGA,EAAIH,KAAKgb,WAAW1W,SAAUnE,EAC1CH,KAAKgb,WAAW7a,GAAK,KAGM,MAA3BH,KAAKob,oBACLpb,KAAKob,mBAAmBhS,UAEM,MAA9BpJ,KAAKqb,uBACLrb,KAAKqb,sBAAsBjS,SAElC,EAAAmS,EAEMkC,UAAP,WACIzd,KAAKgd,WACLhd,KAAKwb,WAAU,EAClB,EAAAD,EAEMvL,OAAP,WACI,IAAK,IAAI7P,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG6P,QAEvB,EAAAuL,EAEM8B,mBAAP,SAA2BK,GACvB,GAAK1d,KAAKoR,WAA2C,MAA9BpR,KAAKqb,uBAGxBqC,EAAIvR,QAAUnM,KAAK2d,kBAAvB,CAIA,IAAK,IAAIxd,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGyS,aAAa8K,EAAI5F,UAGrC,IAAK,IAAI3X,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG4V,YAPnB,CASL,EAACwF,EAMMqC,SAAP,SAAiB3R,GACb,IAAK,IAAI9L,EAAI,EAAGA,EAAIH,KAAKgb,WAAW1W,SAAUnE,EAAG,CAAA,IAAA0d,EAC7C,GAA2B,OAAvB7d,KAAKgb,WAAW7a,IAAgBH,KAAKgb,WAAW7a,IAAwC,QAAhB,OAAlB0d,EAAA7d,KAAKgb,WAAW7a,SAAE,EAAlB0d,EAAoBrW,WAK1E,OAJAxH,KAAKgb,WAAW7a,GAAK8L,EACjBjM,KAAK8d,QACL9d,KAAK4c,uBAAuB5c,KAAK8d,QAE9B3d,CAEd,CAED,OAAQ,CACZ,EAACob,EAMMtH,SAAP,SAAiB9T,EAAW8L,GACxBjM,KAAKgb,WAAW7a,GAAK8L,EACjBjM,KAAK8d,QACL9d,KAAK4c,uBAAuB5c,KAAK8d,OAEzC,EAACvC,EAMMwC,YAAP,SAAoBC,GAChBhe,KAAKgb,WAAWgD,GAAM,KAClBhe,KAAK8d,QACL9d,KAAK4c,uBAAuB5c,KAAK8d,OAEzC,EAACvC,EAMMlJ,SAAP,SAAiB2L,GACb,OAAY,IAARA,EACO,KAGJhe,KAAKgb,WAAWgD,EAC3B,EAACzC,EAMMxD,YAAP,SAAoB5X,EAAWK,GAC3B,IAAMM,EAAIX,EAAIH,KAAKya,UACbhI,EAAIjS,EAAIR,KAAKya,UACb1Z,EAAIf,KAAKie,UAAU9d,EAAGK,GAE5B,OAAO6N,EAAGvN,EAAGC,EAAG0R,EACnB,EAAA8I,EAEM2C,eAAP,WACI,OAAOle,KAAK6a,QAChB,EAACU,EAMM4C,UAAP,SAAkBhe,EAAWK,EAAWT,GACpCA,EAAIa,EAAMb,EAAGqe,GAAqBC,GAClCre,KAAK6a,SAASra,EAAIR,KAAKmc,YAAY,GAAKhc,GAAKme,EAAsBve,EAAIwe,CAI3E,EAAChD,EAMM0C,UAAP,SAAkB9d,EAAWK,GACzB,OAAQR,KAAK6a,SAASra,EAAIR,KAAKmc,YAAY,GAAKhc,GAAKme,GAAuBC,CAChF,EAAChD,EAMMiD,eAAP,SAAuBre,EAAWK,GAI9B,OAHAL,EAAIS,EAAMT,EAAG,EAAGH,KAAKmc,YAAY,GAAK,GACtC3b,EAAII,EAAMJ,EAAG,EAAGR,KAAKmc,YAAY,GAAK,GAE/Bnc,KAAKie,UAAU9d,EAAGK,EAC7B,EAAC+a,EAMMgB,YAAP,SAAoBzb,EAAWC,GAC3B,IAAMC,EAAKF,EAAId,KAAKiG,SACdhF,EAAKF,EAAIf,KAAKiG,SAEhB/E,EAAMC,KAAKC,MAAMJ,GACjBK,EAAMF,KAAKC,MAAMH,GACjBK,EAAMJ,EAAM,EACZK,EAAMF,EAAM,EACVG,EAAKR,EAAKE,EACVO,EAAKR,EAAKI,EAEhB,GAAIH,EAAM,GAAKA,EAAMlB,KAAKmc,YAAY,GAAK,GAAK9a,EAAM,GAAKA,EAAMrB,KAAKmc,YAAY,GAAK,EACnF,OAAO,KAGXjb,EAAMN,EAAMM,EAAK,EAAGlB,KAAKmc,YAAY,GAAK,GAC1C9a,EAAMT,EAAMS,EAAK,EAAGrB,KAAKmc,YAAY,GAAK,GAC1C7a,EAAMV,EAAMU,EAAK,EAAGtB,KAAKmc,YAAY,GAAK,GAC1C5a,EAAMX,EAAMW,EAAK,EAAGvB,KAAKmc,YAAY,GAAK,GAE1C,IAAIza,EAAI1B,KAAKie,UAAU/c,EAAKG,GACtBM,EAAI3B,KAAKie,UAAU3c,EAAKD,GACxBO,EAAI5B,KAAKie,UAAU/c,EAAKK,GAC1BM,EAAI7B,KAAKie,UAAU3c,EAAKC,GACtBO,EAAc,IAATH,EAAIC,GAaf,OAXIJ,EAAKC,GAAM,EACXI,EAAIC,GAAKA,EAAIJ,GAEbA,EAAII,GAAKA,EAAID,IAGNH,GAAK,EAAMF,GAAMG,EAAIH,IAGhB,EAAMC,IAFXG,GAAK,EAAMJ,GAAMK,EAAIL,GAECC,CAGrC,EAAC8Z,EAKMkD,WAAP,SAAmBte,EAAWK,EAAWwD,GACrC,IAAMU,EAAQlE,EAAIR,KAAKmc,YAAY,GAAKhc,EAExCH,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAElD,EACjCd,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAEjD,EACjCf,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAEyO,CACrC,EAAC8I,EAMMtD,UAAP,SAAkB9X,EAAWK,GACzB,IAAMkE,EAAQlE,EAAIR,KAAKmc,YAAY,GAAKhc,EAElC6D,EAAIqK,IAKV,OAJArK,EAAElD,EAAId,KAAK+a,SAAiB,EAARrW,EAAY,GAChCV,EAAEjD,EAAIf,KAAK+a,SAAiB,EAARrW,EAAY,GAChCV,EAAEyO,EAAIzS,KAAK+a,SAAiB,EAARrW,EAAY,GAEzBV,CACX,EAACuX,EAMMmD,YAAP,SAAoB5d,EAAWC,GAC3B,IAAMC,EAAKF,EAAId,KAAKiG,SACdhF,EAAKF,EAAIf,KAAKiG,SAEhB/E,EAAMC,KAAKC,MAAMJ,GACjBK,EAAMF,KAAKC,MAAMH,GACjBK,EAAMJ,EAAM,EACZK,EAAMF,EAAM,EACVG,EAAKR,EAAKE,EACVO,EAAKR,EAAKI,EAEhB,GAAIH,EAAM,GAAKA,EAAMlB,KAAKmc,YAAY,GAAK,GAAK9a,EAAM,GAAKA,EAAMrB,KAAKmc,YAAY,GAAK,EACnF,OAAO,KAGXjb,EAAMN,EAAMM,EAAK,EAAGlB,KAAKmc,YAAY,GAAK,GAC1C9a,EAAMT,EAAMS,EAAK,EAAGrB,KAAKmc,YAAY,GAAK,GAC1C7a,EAAMV,EAAMU,EAAK,EAAGtB,KAAKmc,YAAY,GAAK,GAC1C5a,EAAMX,EAAMW,EAAK,EAAGvB,KAAKmc,YAAY,GAAK,GAE1C,IAAMza,EAAI1B,KAAKiY,UAAU/W,EAAKG,GACxBM,EAAI3B,KAAKiY,UAAU3W,EAAKD,GACxBO,EAAI5B,KAAKiY,UAAU/W,EAAKK,GACxBM,EAAI7B,KAAKiY,UAAU3W,EAAKC,GACxBO,EAAIuM,IACV6E,EAAKC,IAAIrR,EAAGH,EAAGC,GAAG+c,eAAe,IAE7Bnd,EAAKC,GAAM,GAEXI,EAAEtB,IAAIuB,GACND,EAAE+c,SAASld,GACXG,EAAEsR,IAAIrR,KAGNJ,EAAEnB,IAAIuB,GACNJ,EAAEkd,SAAS/c,GACXH,EAAEyR,IAAIrR,IAGV,IAAM+c,EAAKxQ,IACLyQ,EAAKzQ,IACLrK,EAAIqK,IAKV,OAJA6E,EAAK6L,KAAKF,EAAInd,EAAGC,EAAGH,GACpB0R,EAAK6L,KAAKD,EAAIld,EAAGC,EAAGL,GACpB0R,EAAK6L,KAAK/a,EAAG6a,EAAIC,EAAIrd,GAEduC,CACX,EAACuX,EAMMyD,UAAP,SAAkB7e,EAAWK,EAAWV,GACpC,IAAM4E,EAAQlE,EAAIR,KAAK2a,eAAiB3a,KAAK0a,YAAY,GAAKva,EAE9DH,KAAK8a,SAAiB,EAARpW,EAAY,GAAW,IAAN5E,EAAEgB,EACjCd,KAAK8a,SAAiB,EAARpW,EAAY,GAAW,IAAN5E,EAAEiB,EACjCf,KAAK8a,SAAiB,EAARpW,EAAY,GAAW,IAAN5E,EAAE2S,EACjCzS,KAAK8a,SAAiB,EAARpW,EAAY,GAAW,IAAN5E,EAAEA,CAOrC,EAACyb,EAMM5F,UAAP,SAAkBxV,EAAWK,GACzB,IAAMkE,EAAQlE,EAAIR,KAAK2a,eAAiB3a,KAAK0a,YAAY,GAAKva,EAExDL,EAAI,IAAIoS,EAMd,OALApS,EAAEgB,EAAId,KAAK8a,SAAiB,EAARpW,EAAY,GAAK,IACrC5E,EAAEiB,EAAIf,KAAK8a,SAAiB,EAARpW,EAAY,GAAK,IACrC5E,EAAE2S,EAAIzS,KAAK8a,SAAiB,EAARpW,EAAY,GAAK,IACrC5E,EAAEA,EAAIE,KAAK8a,SAAiB,EAARpW,EAAY,GAAK,IAE9B5E,CACX,EAACyb,EAMM0D,YAAP,SAAoBne,EAAWC,GAC3B,IAAMme,EAAoBlf,KAAKqG,cAAgBrG,KAAKmG,WAAW,GACzDgZ,EAAoBnf,KAAKqG,cAAgBrG,KAAKmG,WAAW,GAC/D,GAA0B,IAAtB+Y,GAAiD,IAAtBC,EAC3B,OAAO,KAGX,IAAMne,EAAKF,EAAIoe,EACTje,EAAKF,EAAIoe,EAEXje,EAAMC,KAAKC,MAAMJ,GACjBK,EAAMF,KAAKC,MAAMH,GACjBK,EAAMJ,EAAM,EACZK,EAAMF,EAAM,EACVG,EAAKR,EAAKE,EACVO,EAAKR,EAAKI,EAEhB,GAAIH,EAAM,GAAKA,EAAMge,EAAoB,GAAK7d,EAAM,GAAKA,EAAM8d,EAAoB,EAC/E,OAAO,KAGXje,EAAMN,EAAMM,EAAK,EAAGge,EAAoB,GACxC7d,EAAMT,EAAMS,EAAK,EAAG8d,EAAoB,GACxC7d,EAAMV,EAAMU,EAAK,EAAG4d,EAAoB,GACxC3d,EAAMX,EAAMW,EAAK,EAAG4d,EAAoB,GAExC,IAAIzd,EAAI1B,KAAK2V,UAAUzU,EAAKG,GACtBM,EAAI3B,KAAK2V,UAAUrU,EAAKD,GACxBO,EAAI5B,KAAK2V,UAAUzU,EAAKK,GAC1BM,EAAI7B,KAAK2V,UAAUrU,EAAKC,GACtBO,EAAI,IAAIoQ,EACdA,EAAKiB,IAAIrR,EAAGH,EAAGC,GAAG+c,eAAe,IAE7Bnd,EAAKC,GAAM,GACXI,EAAI,IAAIqQ,EACRA,EAAK0M,SAAS/c,EAAGC,EAAGJ,GAAGyR,IAAIrR,KAE3BJ,EAAI,IAAIwQ,EACRA,EAAK0M,SAASld,EAAGI,EAAGD,GAAGsR,IAAIrR,IAG/B,IAAM+c,EAAK,IAAI3M,EACT4M,EAAK,IAAI5M,EACTlO,EAAI,IAAIkO,EAKd,OAJAA,EAAK6M,KAAKF,EAAInd,EAAGC,EAAGH,GACpB0Q,EAAK6M,KAAKD,EAAIld,EAAGC,EAAGL,GACpB0Q,EAAK6M,KAAK/a,EAAG6a,EAAIC,EAAIrd,GAEduC,CACX,EAACuX,EAMM6D,oBAAP,SAA4Bte,EAAWC,GACnC,IAAMme,EAAoBlf,KAAKqG,cAAgBrG,KAAKmG,WAAW,GACzDgZ,EAAoBnf,KAAKqG,cAAgBrG,KAAKmG,WAAW,GAC/D,GAA0B,IAAtB+Y,GAAiD,IAAtBC,EAC3B,OAAO,KAGX,IAAMne,EAAKF,EAAIoe,EACTje,EAAKF,EAAIoe,EACTje,EAAMC,KAAKC,MAAMJ,GACjBK,EAAMF,KAAKC,MAAMH,GAEvB,GAAIC,EAAM,GAAKA,EAAMge,EAAoB,GAAK7d,EAAM,GAAKA,EAAM8d,EAAoB,EAC/E,OAAO,KAGX,IAAMrf,EAAIE,KAAK2V,UAAUzU,EAAKG,GACxBge,EAAKle,KAAKC,MAAMN,EAAId,KAAKqG,eACzBiZ,EAAKne,KAAKC,MAAML,EAAIf,KAAKqG,eACzByD,EAAQ9J,KAAKgW,SAASqJ,EAAIC,GAE5Bnf,EAAI,EAaR,OAZIL,EAAEiB,EAAIjB,EAAEK,KAA6B,IAAvB2J,EAAMuI,SAAS,KAC7BlS,EAAI,GAEJL,EAAEiB,EAAIjB,EAAEK,KAA6B,IAAvB2J,EAAMuI,SAAS,KAC7BlS,EAAI,GAEJL,EAAE2S,EAAI3S,EAAEK,KAA6B,IAAvB2J,EAAMuI,SAAS,KAC7BlS,EAAI,GAGRA,EAAI2J,EAAMuI,SAASlS,GAEZH,KAAKqS,SAASlS,EACzB,EAACob,EAMM9C,eAAP,SAAuBtY,EAAWK,GAC9B,IAAM+e,GAAc/e,EAAIR,KAAK0a,YAAY,GAAKva,GAAKqf,EAEnD,MAAO,CACHxf,KAAKib,aAAasE,GAClBvf,KAAKib,aAAasE,EAAa,GAC/Bvf,KAAKib,aAAasE,EAAa,GAC/Bvf,KAAKib,aAAasE,EAAa,GAEvC,EAAChE,EAMMkE,cAAP,SAAsBtf,EAAWK,EAAWkE,GACxC,IAAM6a,GAAc/e,EAAIR,KAAK0a,YAAY,GAAKva,GAAKqf,EACnD,OAAOxf,KAAKib,aAAasE,EAAa7a,EAC1C,EAAC6W,EAMMpH,cAAP,SAAsBhU,EAAWK,EAAWkE,EAAewP,GACvD,IAAMqL,GAAc/e,EAAIR,KAAK0a,YAAY,GAAKva,GAAKqf,EACnDxf,KAAKib,aAAasE,EAAa7a,GAASwP,CAC5C,EAACqH,EAMMvF,SAAP,SAAiB7V,EAAWK,GACxB,OAAOR,KAAKkb,QAAQ1a,EAAIR,KAAK0a,YAAY,GAAKva,EAClD,EAACob,EAMM/C,UAAP,WACI,OAAOxY,KAAKkb,OAChB,EAACK,EAUMmE,SAAP,SAAiB5c,EAAa6c,EAAWpb,EAAcqb,QAAU,IAAVA,IAAAA,GAAa,GAChE,IAEMC,EAAQ/c,EACV8c,GACA1M,EAAK0L,SAASiB,EAAO/c,EAAO9C,KAAKgM,KAAKoH,eAG1C,IAAMsE,EAAQrJ,IACdqJ,EAAMnX,IAAIof,GACVjI,EAAMiH,eAAepa,GAErB,IAAIuT,EAAsB,KAE1B,GAAI6H,EAAIpd,OAAO8L,EAAG,EAAG,EAAG,IAAK,CACzB,IAAMtN,EAAIf,KAAKuc,YAAYsD,EAAM/e,EAAG+e,EAAMpN,GACjC,MAAL1R,GAAa8e,EAAM9e,GAAKA,IACxB+W,EAAWzJ,EAAGwR,EAAM/e,EAAGC,EAAG8e,EAAMpN,GAEvC,MAAM,GAAIkN,EAAIpd,OAAO8L,EAAG,GAAI,EAAG,IAAK,CACjC,IAAMtN,EAAIf,KAAKuc,YAAYsD,EAAM/e,EAAG+e,EAAMpN,GACjC,MAAL1R,GAAa8e,EAAM9e,GAAKA,IACxB+W,EAAWzJ,EAAGwR,EAAM/e,EAAGC,EAAG8e,EAAMpN,GAEvC,KAAM,CAIH,IAHA,IAAItS,EAAI,EAGDA,IA3BO,KA2BU,CACpB,IAAMY,EAAIf,KAAKuc,YAAYsD,EAAM/e,EAAG+e,EAAMpN,GAC1C,GAAS,MAAL1R,GAAa8e,EAAM9e,GAAKA,EACxB,MAGJ8e,EAAM1M,IAAIwM,EACb,CAGD,KAAOxf,IArCO,KAqCU,CACpB,IAAMY,EAAIf,KAAKuc,YAAYsD,EAAM/e,EAAG+e,EAAMpN,GAC1C,GAAS,MAAL1R,GAAa8e,EAAM9e,GAAKA,EAAG,CAC3B+W,EAAWzJ,EAAGwR,EAAM/e,EAAGC,EAAG8e,EAAMpN,GAChC,KACH,CAEDoN,EAAM1M,IAAIuE,EACb,CACJ,CAED,OAAOI,CACX,EAACyD,EAKMuE,yBAAP,WAEI,IAAM9Q,EAAY+Q,EAAc/Q,UAEhC,GAAkB,OAAdhP,KAAKmb,KAAe,CACpB,IAAM6E,EAAYhR,EAAUQ,aAAa,IAAIC,EACzCC,EAAeuQ,MAAQvQ,EAAeE,aACtCC,EAAeC,OACf5P,YAAY6P,kBAAoB/P,KAAKmb,KAAK9X,aAAaiB,OACvDpE,YAAY6P,oBAGhB,OADAiQ,EAAUhQ,OAAOhQ,KAAKmb,KAAK9X,cACpB2c,CACV,CAIG,IAHA,IAAM7J,EAAY,IAAIjW,YAAY2G,EAAgCA,EAAgC,GAE9FnC,EAAQ,EACHlE,EAAI,EAAGA,EAAIqG,IAAiCrG,EACjD,IAAK,IAAIL,EAAI,EAAGA,EAAI0G,IAAiC1G,EAAG,CACpD,IAAMuB,EAAIlB,EAAI6O,EAAkClP,EAC1CwB,EAAInB,EAAI6O,EAAkClP,EAAI,EAC9CyB,GAAKpB,EAAI,GAAK6O,EAAkClP,EAChD0B,GAAKrB,EAAI,GAAK6O,EAAkClP,EAAI,EAG1DgW,EAAUzR,KAAWhD,EACrByU,EAAUzR,KAAW9C,EACrBuU,EAAUzR,KAAW/C,EAErBwU,EAAUzR,KAAW/C,EACrBwU,EAAUzR,KAAW9C,EACrBuU,EAAUzR,KAAW7C,CACxB,CAGL,IAAMme,EAAYhR,EAAUQ,aAAa,IAAIC,EACzCC,EAAeuQ,MAAQvQ,EAAeE,aACtCC,EAAeC,OACf5P,YAAY6P,kBAAoBoG,EAAU7R,OAC1CpE,YAAY6P,oBAGhB,OADAiQ,EAAUhQ,OAAOmG,GACV6J,CAEf,EAACzE,EAKMzK,sBAAP,WACI,OAAmC,OAA/B9Q,KAAKqb,sBACErb,KAAKqb,sBAGgB,OAA5Brb,KAAKob,mBACEpb,KAAKob,oBAGZpb,KAAKoR,WAA2B,OAAdpR,KAAKmb,OACvBnb,KAAKmb,KAAO,IAAIlY,IAGF,OAAdjD,KAAKmb,MACLnb,KAAKqb,sBAAwBrb,KAAK8f,2BAC3B9f,KAAKqb,wBAEZrb,KAAKob,mBAAqBpb,KAAK8f,2BACxB9f,KAAKob,oBAEpB,EAACG,EAKMnF,cAAP,SAAsBvT,GAClB,OAAmC,OAA/B7C,KAAKqb,uBAAgD,OAAdrb,KAAKmb,KACrCnb,KAAKmb,KAAK9W,aAAaxB,GAG3B,IACX,EAAC0Y,EAKME,eAAP,SAAuByE,GAEnB,GADAlgB,KAAK4Z,eAAetV,OAAS,EACzB4b,EACA,IAAK,IAAI/f,EAAI,EAAGA,EAAIH,KAAK0a,YAAY,GAAK1a,KAAK0a,YAAY,KAAMva,EAC7DH,KAAK4Z,eAAelU,KAAK,IAAIiH,GAGzC,EAAC4O,EAKM1F,gBAAP,SAAwBsK,EAAiBC,EAAqBC,EAAcC,EAAcC,EAAgBC,GACtG,GAAIJ,GAEA,GAAmC,IAA/BpgB,KAAK4Z,eAAetV,OACpB,IAAK,IAAInE,EAAI,EAAGA,EAAIH,KAAK0a,YAAY,GAAK1a,KAAK0a,YAAY,KAAMva,EAC7DH,KAAK4Z,eAAelU,KAAK,IAAIiH,SAGlC,GAAmC,IAA/B3M,KAAK4Z,eAAetV,OAC3B,OAGJtE,KAAK4Z,eAAeuG,GAASlV,QAAUmV,EACvCpgB,KAAK4Z,eAAeuG,GAASpT,KAAOsT,EACpCrgB,KAAK4Z,eAAeuG,GAASlT,KAAOqT,EACpCtgB,KAAK4Z,eAAeuG,GAAShT,OAASoT,EACtCvgB,KAAK4Z,eAAeuG,GAAS9S,OAASmT,EACtCxgB,KAAKkb,QAAQiF,GAAStK,gBAAgB7V,KAAK4Z,eAAeuG,GAC9D,EAAC5E,EAKMhN,iBAAP,SAAyBpO,EAAWK,GAChC,IAAMkE,EAAQlE,EAAIR,KAAK0a,YAAY,GAAKva,EACxC,OAAOuE,EAAQ1E,KAAK4Z,eAAetV,OAAStE,KAAK4Z,eAAelV,GAAS,IAC7E,EAAC6W,EAKMkF,YAAP,SAAoB3f,EAAW2R,GAC3B,IAEIiO,EACAC,EAHAC,EAAO,EACLC,EAAO7gB,KAAK+X,YAAYjX,EAAG2R,GAI7B3R,EAAId,KAAKmc,YAAY,GAAK,EAC1BuE,EAAQ1gB,KAAK+X,YAAYjX,EAAI,EAAG2R,IAEhCmO,IAAS,EACTF,EAAQ1gB,KAAK+X,YAAYjX,EAAI,EAAG2R,IAGhCA,EAAIzS,KAAKmc,YAAY,GAAK,EAC1BwE,EAAK3gB,KAAK+X,YAAYjX,EAAG2R,EAAI,IAE7BmO,IAAS,EACTD,EAAK3gB,KAAK+X,YAAYjX,EAAG2R,EAAI,IAGjCiO,EAAM9B,SAASiC,GACfF,EAAG/B,SAASiC,GAEZ,IAAM7I,EAAS3J,IAMf,OALA2J,EAAOzX,IAAIogB,GACX3I,EAAO8I,MAAMJ,GACb1I,EAAO2G,eAAeiC,GACtB5I,EAAO+I,YAEA/I,CACX,EAACuD,EAKMQ,cAAP,WAEI,IADA,IAAIrX,EAAQ,EACH3D,EAAI,EAAGA,EAAIf,KAAKmc,YAAY,KAAMpb,EACvC,IAAK,IAAID,EAAI,EAAGA,EAAId,KAAKmc,YAAY,KAAMrb,EAAG,CAC1C,IAAMkD,EAAIhE,KAAKygB,YAAY3f,EAAGC,GAE9Bf,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAElD,EACjCd,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAEjD,EACjCf,KAAK+a,SAAiB,EAARrW,EAAY,GAAKV,EAAEyO,EACjC/N,GAAS,CACZ,CAER,EAAA6W,EAEOC,UAAR,SAAmBwF,GAAsB,IAAAC,EAAAjhB,KACrC,QADsB,IAAPghB,IAAAA,GAAU,IACrBhhB,KAAKkhB,MAAT,CAIA,IAAMC,EAAenhB,KAAKwZ,QAK1B,GAJIxZ,KAAKwa,eAAiB2G,IACtBnhB,KAAKwa,aAAe2G,IAGnBH,GAA4B,OAAjBG,EAAuB,CACnCnhB,KAAKya,UAAY0G,EAAalb,SAC9BjG,KAAK0a,YAAcyG,EAAahb,WAChCnG,KAAK2a,eAAiBwG,EAAa9a,cACnCrG,KAAK4a,cAAgBuG,EAAa5a,aAClCvG,KAAK6a,SAAWsG,EAAarF,QAC7B9b,KAAK+a,SAAWoG,EAAaC,QAC7BphB,KAAK8a,SAAWqG,EAAazE,QAC7B1c,KAAKib,aAAekG,EAAaxE,YAGjC,IAAK,IAAIxc,EAAI,EAAGA,EAAIH,KAAKgb,WAAW1W,SAAUnE,EAC1CH,KAAKgb,WAAW7a,GAAK,KAGzB,GAAIghB,EAAaE,QAAUC,EACvB,IAD8C,IACiBC,EAAA,WAC3D,IAAMtV,EAAQ,IAAI5E,GACZma,EAAYL,EAAaM,iBAAiBthB,MAChD8L,EAAMhG,SAAWub,EAAUvb,SAC3BoD,EAASqY,aAAaC,QAAQH,EAAUI,aAAa,SAAC5K,EAAKyF,GACvDxQ,EAAMzE,UAAYiV,CACtB,IAE8B,KAA1B+E,EAAUK,aACVxY,EAASqY,aAAaC,QAAQH,EAAUK,aAAa,SAAC7K,EAAKyF,GACvDxQ,EAAMvE,UAAY+U,CACtB,IAGJxQ,EAAMlE,UAAYyZ,EAAUzZ,UAC5BkE,EAAMpE,SAAW2Z,EAAU3Z,SAE3BoZ,EAAKjG,WAAWwG,EAAUzE,MAAQ9Q,CACrC,EAlBQ9L,EAAI,EAAGA,EAAIghB,EAAaM,iBAAiBnd,SAAUnE,EAACohB,SAoB7D,IAAK,IAAIphB,EAAI,EAAGA,EAAIghB,EAAatE,WAAWvY,SAAUnE,EAAG,CACrD,IAAM8L,EAAQ,IAAI5E,GACZma,EAAYL,EAAatE,WAAW1c,GAC1C8L,EAAMhG,SAAWub,EAAUvb,SAC3BgG,EAAMzE,UAAYga,EAAUha,UAC5ByE,EAAMvE,UAAY8Z,EAAU9Z,UAC5BuE,EAAMlE,UAAYyZ,EAAUzZ,UAC5BkE,EAAMpE,SAAW2Z,EAAU3Z,SAE3B7H,KAAKgb,WAAWwG,EAAUzE,MAAQ9Q,CACrC,CAER,CAED,GAA4B,IAAxBjM,KAAK0a,YAAY,IAAoC,IAAxB1a,KAAK0a,YAAY,GAAlD,CAKA,IAAMyB,EAAcnc,KAAKmc,YAAY,GAAKnc,KAAKmc,YAAY,GAC3D,GAAsB,OAAlBnc,KAAK6a,UAAqB7a,KAAK6a,SAASvW,SAAW6X,EAAa,CAChEnc,KAAK6a,SAAW,IAAI3a,YAAYic,GAChCnc,KAAK+a,SAAW,IAAI5L,aAA2B,EAAdgN,GACjC,IAAK,IAAIhc,EAAI,EAAGA,EAAIgc,IAAehc,EAC/BH,KAAK6a,SAAS1a,GAAKme,EACnBte,KAAK+a,SAAa,EAAJ5a,EAAQ,GAAK,EAC3BH,KAAK+a,SAAa,EAAJ5a,EAAQ,GAAK,EAC3BH,KAAK+a,SAAa,EAAJ5a,EAAQ,GAAK,EAE3BghB,IACAA,EAAarF,QAAU9b,KAAK6a,SAC5BsG,EAAaC,QAAUphB,KAAK+a,SAEnC,CAEqB,OAAlB/a,KAAK+a,UAAqB/a,KAAK+a,SAASzW,SAAyB,EAAd6X,IACnDnc,KAAK+a,SAAW,IAAI5L,aAA2B,EAAdgN,GACjCnc,KAAK+b,iBAIT,IAAM+F,EAAkB9hB,KAAKmG,WAAW,GAAKnG,KAAKmG,WAAW,GAAKqZ,EAClE,GAA0B,OAAtBxf,KAAKib,cAAyBjb,KAAKib,aAAa3W,SAAWwd,EAAiB,CAC5E9hB,KAAKib,aAAe,IAAI3X,MAAcwe,GACtC,IAAK,IAAI3hB,EAAI,EAAGA,EAAI2hB,IAAmB3hB,EACnCH,KAAKib,aAAa9a,IAAM,EAExBghB,IACAA,EAAaxE,YAAc3c,KAAKib,aAEvC,CAGD,IAAM8G,EAAuB/hB,KAAK2a,eAAiB3a,KAAK0a,YAAY,GAC9DsH,EAAuBhiB,KAAK2a,eAAiB3a,KAAK0a,YAAY,GACpE,GAAI1a,KAAK8a,SAASxW,SAAWyd,EAAuBC,EAAuB,EAAG,CAC1EhiB,KAAK8a,SAAW,IAAIrF,WAAWsM,EAAuBC,EAAuB,GAC7E,IAAK,IAAI7hB,EAAI,EAAGA,EAAI4hB,EAAuBC,IAAwB7hB,EAC/DH,KAAK8a,SAAa,EAAJ3a,EAAQ,GAAK,IAC3BH,KAAK8a,SAAa,EAAJ3a,EAAQ,GAAK,EAC3BH,KAAK8a,SAAa,EAAJ3a,EAAQ,GAAK,EAC3BH,KAAK8a,SAAa,EAAJ3a,EAAQ,GAAK,EAE3BghB,IACAA,EAAazE,QAAU1c,KAAK8a,SAEnC,CAGD,IAAK,IAAIta,EAAI,EAAGA,EAAIR,KAAK0a,YAAY,KAAMla,EACvC,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAK0a,YAAY,KAAMva,EACvCH,KAAKkb,QAAQxV,KAAK,IAAI8H,GAAaxN,KAAMG,EAAGK,IAIpD,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG4O,OA5DnB,CA3DA,CAyHJ,EAAAwM,EAEOK,gBAAR,SAAyB9F,GACrB,GAAI9V,KAAKmc,YAAY,KAAOrG,EAAKqG,YAAY,IAAMnc,KAAKmc,YAAY,KAAOrG,EAAKqG,YAAY,GACxF,OAAO,EAIX,IADA,IAAML,EAAU,IAAI5b,YAAY4V,EAAKqG,YAAY,GAAKrG,EAAKqG,YAAY,IAC9Dhc,EAAI,EAAGA,EAAI2b,EAAQxX,SAAUnE,EAClC2b,EAAQ3b,GAAKme,EAMjB,IAHA,IAAMxe,EAAIqB,KAAKqS,IAAIxT,KAAKmc,YAAY,GAAIrG,EAAKqG,YAAY,IACnDpc,EAAIoB,KAAKqS,IAAIxT,KAAKmc,YAAY,GAAIrG,EAAKqG,YAAY,IAEhD3b,EAAI,EAAGA,EAAIT,IAAKS,EACrB,IAAK,IAAIL,EAAI,EAAGA,EAAIL,IAAKK,EAAG,CACxB,IAAMgF,EAAS3E,EAAIsV,EAAKqG,YAAY,GAAKhc,EACnCiF,EAAS5E,EAAIR,KAAKmc,YAAY,GAAKhc,EAEzC2b,EAAQ3W,GAAUnF,KAAK6a,SAASzV,EACnC,CAKL,OAFApF,KAAK6a,SAAWiB,GAET,CACV,EAAAP,EAEOG,oBAAR,SAA6B5F,GACzB,GAAI9V,KAAKmG,WAAW,KAAO2P,EAAK3P,WAAW,IAAMnG,KAAKmG,WAAW,KAAO2P,EAAK3P,WAAW,GACpF,OAAO,EAGX,IAAMwW,EAAwB,GAC9BA,EAAYrY,OAASwR,EAAK3P,WAAW,GAAK2P,EAAK3P,WAAW,GAAKqZ,EAC/D,IAAK,IAAIrf,EAAI,EAAGA,EAAIwc,EAAYrY,SAAUnE,EACtCwc,EAAYxc,IAAM,EAKtB,IAFA,IAAML,EAAIqB,KAAKqS,IAAIxT,KAAKmG,WAAW,GAAI2P,EAAK3P,WAAW,IACjDpG,EAAIoB,KAAKqS,IAAIxT,KAAKmG,WAAW,GAAI2P,EAAK3P,WAAW,IAC9C3F,EAAI,EAAGA,EAAIT,IAAKS,EACrB,IAAK,IAAIL,EAAI,EAAGA,EAAIL,IAAKK,EAIrB,IAHA,IAAMgF,EAAS3E,EAAIsV,EAAK3P,WAAW,GAAKhG,EAClCiF,EAAS5E,EAAIR,KAAKmG,WAAW,GAAKhG,EAE/B4D,EAAI,EAAGA,EAAIyb,IAA4Bzb,EAC5C4Y,EAAYxX,EAASqa,EAA2Bzb,GAAK/D,KAAKib,aAAa7V,EAASoa,EAA2Bzb,GAOvH,OAFA/D,KAAKib,aAAe0B,GAEb,CACV,EAAApB,EAEOM,gBAAR,SAAyB/F,GAA2B,IAAAmM,EAAAjiB,KAC1CkiB,EAAmBliB,KAAK2a,eACxBwH,EAA0BniB,KAAK2a,eAAiB3a,KAAK0a,YAAY,GACjE0H,EAA0BpiB,KAAK2a,eAAiB3a,KAAK0a,YAAY,GAEjEqH,EAAuBjM,EAAKzP,cAAgByP,EAAK3P,WAAW,GAC5D6b,EAAuBlM,EAAKzP,cAAgByP,EAAK3P,WAAW,GAElE,GAAI4b,IAAyBI,GAA2BH,IAAyBI,EAC7E,OAAO,EAKX,IAFA,IAAM1F,EAAU,IAAIjH,WAAWsM,EAAuBC,EAAuB,GAEpE7hB,EAAI,EAAGA,EAAI4hB,EAAuBC,IAAwB7hB,EAC/Duc,EAAY,EAAJvc,EAAQ,GAAK,IACrBuc,EAAY,EAAJvc,EAAQ,GAAK,EACrBuc,EAAY,EAAJvc,EAAQ,GAAK,EACrBuc,EAAY,EAAJvc,EAAQ,GAAK,EAwDzB,IArDA,IAAML,EAAIqB,KAAKqS,IAAIsC,EAAK3P,WAAW,GAAInG,KAAK0a,YAAY,IAClD3a,EAAIoB,KAAKqS,IAAIsC,EAAK3P,WAAW,GAAInG,KAAK0a,YAAY,IAGlD2H,EAAe,SAACC,EAAYC,EAAYzH,GAC1C,IAAMpW,EAAQ6d,EAAKJ,EAA0BG,EAEvCE,EAAS,IAAItQ,EAMnB,OALAsQ,EAAO1hB,EAAIga,EAAiB,EAARpW,EAAY,GAAK,IACrC8d,EAAOzhB,EAAI+Z,EAAiB,EAARpW,EAAY,GAAK,IACrC8d,EAAO/P,EAAIqI,EAAiB,EAARpW,EAAY,GAAK,IACrC8d,EAAO1iB,EAAIgb,EAAiB,EAARpW,EAAY,GAAK,IAE9B8d,CACV,EAGKC,EAAkB,SAACC,EAAYC,EAAYC,EAAeC,GAC5D,IAAM3hB,EAAMC,KAAKC,MAAMshB,GACjBrhB,EAAMF,KAAKC,MAAMuhB,GACjBrhB,EAAMH,KAAKqS,IAAItS,EAAM,EAAGghB,EAAmB,GAC3C3gB,EAAMJ,KAAKqS,IAAInS,EAAM,EAAG6gB,EAAmB,GAC3C1gB,EAAKkhB,EAAKxhB,EACVO,EAAKkhB,EAAKthB,EAEVK,EAAI2gB,EAAanhB,EAAM0hB,EAAOvhB,EAAMwhB,EAAOZ,EAAKnH,UAChDnZ,EAAI0gB,EAAa/gB,EAAMshB,EAAOvhB,EAAMwhB,EAAOZ,EAAKnH,UAChDlZ,EAAIygB,EAAanhB,EAAM0hB,EAAOrhB,EAAMshB,EAAOZ,EAAKnH,UAChDjZ,EAAIwgB,EAAa/gB,EAAMshB,EAAOrhB,EAAMshB,EAAOZ,EAAKnH,UAChDhZ,EAAI,IAAIoQ,EACdA,EAAKiB,IAAIrR,EAAGH,EAAGC,GAAG+c,eAAe,IAE7Bnd,EAAKC,GAAM,GACXI,EAAEtB,IAAIuB,GACND,EAAE+c,SAASld,GACXG,EAAEsR,IAAIrR,KAENJ,EAAEnB,IAAIuB,GACNJ,EAAEkd,SAAS/c,GACXH,EAAEyR,IAAIrR,IAGV,IAAM+c,EAAK,IAAI3M,EACT4M,EAAK,IAAI5M,EACTlO,EAAI,IAAIkO,EAKd,OAJAA,EAAK6M,KAAKF,EAAInd,EAAGC,EAAGH,GACpB0Q,EAAK6M,KAAKD,EAAIld,EAAGC,EAAGL,GACpB0Q,EAAK6M,KAAK/a,EAAG6a,EAAIC,EAAIrd,GAEduC,CACV,EAGQxD,EAAI,EAAGA,EAAIT,IAAKS,EACrB,IAAK,IAAIL,EAAI,EAAGA,EAAIL,IAAKK,EAIrB,IAHA,IAAMkgB,EAAOlgB,EAAI+hB,EACX5B,EAAO9f,EAAI0hB,EAER7F,EAAI,EAAGA,EAAIvG,EAAKzP,gBAAiBgW,EACtC,IAAK,IAAID,EAAI,EAAGA,EAAItG,EAAKzP,gBAAiB+V,EAAG,CACzC,IAAItc,OAAO,EAEPA,EADAgW,EAAKzP,gBAAkB6b,EACnBG,EAAajG,EAAIiE,EAAMhE,EAAIiE,EAAMtgB,KAAK8a,UAItC2H,EAFMrG,GAAKtG,EAAKzP,cAAgB,IAAM6b,EAAmB,GACnD7F,GAAKvG,EAAKzP,cAAgB,IAAM6b,EAAmB,GACnC7B,EAAMC,EAAMtgB,KAAK8a,UAG/C,IAAMgI,EAAK3iB,EAAI2V,EAAKzP,cAAgB+V,EAE9B1X,GADKlE,EAAIsV,EAAKzP,cAAgBgW,GACjB0F,EAAuBe,EAE1CpG,EAAgB,EAARhY,EAAY,GAAW,IAAN5E,EAAEgB,EAC3B4b,EAAgB,EAARhY,EAAY,GAAW,IAAN5E,EAAEiB,EAC3B2b,EAAgB,EAARhY,EAAY,GAAW,IAAN5E,EAAE2S,EAC3BiK,EAAgB,EAARhY,EAAY,GAAW,IAAN5E,EAAEA,CAC9B,CAOb,OAFAE,KAAK8a,SAAW4B,GAET,CACV,EAAAjW,EAAA6S,EAAA,CAAA,CAAAzW,IAAA,SAAAnC,IAx2CD,WACI,OAAOV,KAAKwZ,OAChB,EAACjZ,IAnDD,SAEmBE,GAGf,GAFAT,KAAKwZ,QAAU/Y,EAEXT,KAAKwa,eAAiBxa,KAAKwZ,QAAS,CACpCxZ,KAAKwa,aAAexa,KAAKwZ,QAGzB,IAAK,IAAIrZ,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGiJ,UAKpB,GAHApJ,KAAKkb,QAAU,GAGM,OAAjBlb,KAAKwZ,QAAkB,CACvBxZ,KAAK0Z,aAAe,KACpB1Z,KAAK4Z,eAAiB,GACtB5Z,KAAK8Z,gBAAiB,EACtB9Z,KAAKga,eAAgB,EACrBha,KAAKka,SAAU,EACfla,KAAKya,UAAY,EACjBza,KAAK0a,YAAc,CAAC,EAAG,GACvB1a,KAAK2a,eAAiB,IACtB3a,KAAK4a,cAAgB,IACrB5a,KAAK6a,SAAW,IAAI3a,YACpBF,KAAK8a,SAAW,IAAIrF,WACpBzV,KAAK+a,SAAW,IAAI5L,aACpBnP,KAAKib,aAAe,GACpBjb,KAAKkb,QAAU,GAGflb,KAAKgb,WAAa,GAClB,IAAK,IAAI7a,EAAI,EAAGA,EAAImb,IAA2Bnb,EAC3CH,KAAKgb,WAAWtV,KAAK,KAE5B,CAGGqa,EAAc/Q,WAEdhP,KAAKwb,WAEZ,CACL,GAAC,CAAA3Y,IAAA,cAAAnC,IA0BD,WACI,OAAOV,KAAK0Z,YAChB,EAACnZ,IAfD,SAEwBE,GACpB,GAAIT,KAAK0Z,eAAiBjZ,EAA1B,CAIAT,KAAK0Z,aAAejZ,EACpB,IAAK,IAAIN,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGuJ,kBAJnB,CAML,GAAC,CAAA7G,IAAA,gBAAAnC,IAUD,WAEI,OAAOV,KAAK8Z,cACf,EAAAvZ,IAED,SAAmBmY,GACf1Y,KAAK8Z,eAAiBpB,EACtB,IAAK,IAAIvY,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,OAAQnE,IACrCH,KAAKkb,QAAQ/a,GAAGuJ,kBAExB,GAAC,CAAA7G,IAAA,eAAAnC,IAMD,WAEI,OAAOV,KAAKga,aACf,EAAAzZ,IAED,SAAkBmY,GACd1Y,KAAKga,cAAgBtB,EACrB,IAAK,IAAIvY,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,OAAQnE,IACrCH,KAAKkb,QAAQ/a,GAAGuJ,kBAExB,GAAC,CAAA7G,IAAA,SAAAnC,IAMD,WAEI,OAAOV,KAAKka,OACf,EAAA3Z,IAED,SAAYmY,GACR1Y,KAAKka,QAAUxB,EACf,IAAK,IAAIvY,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,OAAQnE,IACrCH,KAAKkb,QAAQ/a,GAAGuJ,kBAExB,GAAC,CAAA7G,IAAA,YAAAnC,IAMD,WAEI,OAAOV,KAAKoa,UACf,EAAA7Z,IAED,SAAemY,GAGX,GAFA1Y,KAAKoa,WAAa1B,EAEd1Y,KAAKoa,YAA4B,OAAdpa,KAAKmb,KAAe,CACvCnb,KAAKmb,KAAO,IAAIlY,GAEmB,OAA/BjD,KAAKqb,wBACLrb,KAAKqb,sBAAwBrb,KAAK8f,4BAItC,IAAK,IAAI3f,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAGiJ,UAEpBpJ,KAAKkb,QAAU,GAEf,IAAK,IAAI1a,EAAI,EAAGA,EAAIR,KAAK0a,YAAY,KAAMla,EACvC,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAK0a,YAAY,KAAMva,EACvCH,KAAKkb,QAAQxV,KAAK,IAAI8H,GAAaxN,KAAMG,EAAGK,IAIpD,IAAK,IAAIL,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,SAAUnE,EACvCH,KAAKkb,QAAQ/a,GAAG4O,OAEvB,CAED,IAAK/O,KAAKoa,WACN,IAAK,IAAIja,EAAI,EAAGA,EAAIH,KAAKkb,QAAQ5W,OAAQnE,IACrCH,KAAKkb,QAAQ/a,GAAG8V,WAG5B,GAAC,CAAApT,IAAA,UAAAnC,IAMD,WAEI,OAAOV,KAAKsa,QACf,EAAA/Z,IAED,SAAamY,GACT1Y,KAAKsa,SAAW5B,CACpB,GAAC,CAAA7V,IAAA,OAAAnC,IAMD,WACI,IAAMgG,EAAK,IAAIC,EAAK,EAAG,GAGvB,OAFAD,EAAGE,MAAQ5G,KAAKmG,WAAW,GAAKU,EAAgC7G,KAAKiG,SACrES,EAAGI,OAAS9G,KAAKmG,WAAW,GAAKU,EAAgC7G,KAAKiG,SAC/DS,CACX,GAAC,CAAA7D,IAAA,WAAAnC,IAMD,WACI,OAAOV,KAAKya,SAChB,GAAC,CAAA5X,IAAA,YAAAnC,IAMD,WACI,MAAO,CAACV,KAAKmG,WAAW,GAAKU,EAA+B7G,KAAKmG,WAAW,GAAKU,EACrF,GAAC,CAAAhE,IAAA,cAAAnC,IAMD,WACI,IAAMsG,EAAehH,KAAKiH,UAI1B,OAHAD,EAAa,IAAM,EACnBA,EAAa,IAAM,EAEZA,CACX,GAAC,CAAAnE,IAAA,aAAAnC,IAMD,WACI,OAAOV,KAAK0a,WAChB,GAAC,CAAA7X,IAAA,eAAAnC,IAMD,WACI,OAAOV,KAAK4a,aAChB,GAAC,CAAA/X,IAAA,gBAAAnC,IAMD,WACI,OAAOV,KAAK2a,cAChB,GAAC,CAAA9X,IAAA,UAAAnC,IAMD,WACI,OAAOV,KAAK6a,QAChB,GAAC,CAAAhY,IAAA,UAAAnC,IAMD,WACI,OAAOV,KAAK8a,QAChB,GAAC,CAAAjY,IAAA,QAAAnC,IAMD,WACI,OAAOV,KAAKkb,QAAQ5W,OAAS,CACjC,GAAC,CAAAzB,IAAA,OAAAnC,IAMD,WAEI,IAAMqiB,EAAK,IAAInd,GAOf,OANAmd,EAAG9c,SAAWjG,KAAKiG,SACnB8c,EAAG5c,WAAW,GAAKnG,KAAKmG,WAAW,GACnC4c,EAAG5c,WAAW,GAAKnG,KAAKmG,WAAW,GACnC4c,EAAG1c,cAAgBrG,KAAKqG,cACxB0c,EAAGxc,aAAevG,KAAKuG,aAEhBwc,CACX,KAACzJ,CAAA,CAvVY,CACY0J,mCAExB7b,IAAY,WAAA,OAE0B,IAAI,IAAAwS,GAAAzS,EAAAkS,GAAA9Y,UAAA,eAAA,CAAAyY,GAG1C5R,IAAY,WAAA,OAG8B,IAAI,IAAA0S,GAAA3S,EAAAkS,GAAA9Y,UAAA,iBAAA,CAAA2iB,GAG9C9b,IAAY,WAAA,MAE0C,EAAE,IAAA4S,GAAA7S,EAAAkS,GAAA9Y,UAAA,iBAAA,CAExD6G,IAAY,WAAA,OAEc,CAAK,IAAA8S,GAAA/S,EAAAkS,GAAA9Y,UAAA,gBAAA,CAE/B6G,IAAY,WAAA,OAEa,CAAK,IAAAgT,GAAAjT,EAAAkS,GAAA9Y,UAAA,UAAA,CAE9B6G,IAAY,WAAA,OAEO,CAAK,IAAAkT,GAAAnT,EAAAkS,GAAA9Y,UAAA,aAAA,CAExB6G,IAAY,WAAA,OAEU,CAAK,IAAAoT,GAAArT,EAAAkS,GAAA9Y,UAAA,WAAA,CAAA4iB,GAG3B/b,IAAY,WAAA,OAEQ,CAAC,IAAAgc,EAAA/J,GAAA9Y,UAAA,SAAA,CAAA8iB,IAAAC,OAAAC,yBAAAlK,GAAA9Y,UAAA,UAAA8Y,GAAA9Y,WAAA6iB,EAAA/J,GAAA9Y,UAAA,cAAA,CAAA4Y,IAAAmK,OAAAC,yBAAAlK,GAAA9Y,UAAA,eAAA8Y,GAAA9Y,WAAA6iB,EAAA/J,GAAA9Y,UAAA,OAAA,CAAAijB,IAAAF,OAAAC,yBAAAlK,GAAA9Y,UAAA,QAAA8Y,GAAA9Y,WArCTkjB,GAqCSpK,MAAAoK,KAAAA"}