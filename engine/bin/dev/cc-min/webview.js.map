{"version":3,"file":"webview.js","sources":["../../../cocos/web-view/web-view-enums.ts","../../../cocos/web-view/web-view-impl.ts","../../../cocos/web-view/web-view-impl-web.ts","../../../cocos/web-view/web-view-impl-manager.ts","../../../cocos/web-view/web-view.ts"],"sourcesContent":["/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nexport enum WebViewEventType {\r\n    /**\r\n     * @en None.\r\n     * @zh 无。\r\n     */\r\n    NONE = 'none',\r\n    /**\r\n     * @en Web page is loading.\r\n     * @zh 网页加载中。\r\n     */\r\n    LOADING = 'loading',\r\n    /**\r\n     * @en Web page Load completed.\r\n     * @zh 网页加载完成。\r\n     */\r\n    LOADED = 'loaded',\r\n    /**\r\n     * @en Web page error occurs when loading.\r\n     * @zh 网页加载出错。\r\n     */\r\n    ERROR = 'error',\r\n}\r\n","/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { legacyCC } from '../core/global-exports';\r\nimport { WebView } from './web-view';\r\nimport { WebViewEventType } from './web-view-enums';\r\nimport { UITransform } from '../2d/framework';\r\nimport { director } from '../game/director';\r\nimport { Node } from '../scene-graph';\r\nimport type { Camera } from '../render-scene/scene';\r\n\r\nexport abstract class WebViewImpl {\r\n    protected _componentEventList: Map<WebViewEventType, (...args: any[any]) => void> = new Map();\r\n    protected _state = WebViewEventType.NONE;\r\n    protected _wrapper: any; // Fix iframe display problem in ios.\r\n    protected _webview: HTMLIFrameElement | null = null;\r\n\r\n    protected _loaded = false;\r\n    protected _forceUpdate = false;\r\n\r\n    protected _component: WebView | null = null;\r\n    protected _uiTrans: UITransform | null = null;\r\n    protected _node: Node | null = null;\r\n\r\n    protected _w = 0;\r\n    protected _h = 0;\r\n    protected _m00 = 0;\r\n    protected _m01 = 0;\r\n    protected _m04 = 0;\r\n    protected _m05 = 0;\r\n    protected _m12 = 0;\r\n    protected _m13 = 0;\r\n\r\n    constructor (component: WebView) {\r\n        this._component = component;\r\n        this._node = component.node;\r\n        this._uiTrans = component.node.getComponent(UITransform);\r\n        this.reset();\r\n        this.createWebView();\r\n    }\r\n\r\n    public reset (): void {\r\n        this._wrapper = null;\r\n        this._webview = null;\r\n        this._loaded = false;\r\n        this._w = 0;\r\n        this._h = 0;\r\n        this._m00 = 0;\r\n        this._m01 = 0;\r\n        this._m04 = 0;\r\n        this._m05 = 0;\r\n        this._m12 = 0;\r\n        this._m13 = 0;\r\n        this._state = WebViewEventType.NONE;\r\n        this._forceUpdate = false;\r\n    }\r\n\r\n    public abstract loadURL(url: string): void;\r\n    public abstract createWebView(): void;\r\n    public abstract removeWebView(): void;\r\n    public abstract enable(): void;\r\n    public abstract disable(): void;\r\n    public abstract syncMatrix(): void;\r\n\r\n    public abstract evaluateJS(str: string): void;\r\n    public abstract setOnJSCallback(callback: () => void): void;\r\n    public abstract setJavascriptInterfaceScheme(scheme: string): void;\r\n\r\n    get loaded (): boolean { return this._loaded; }\r\n    get componentEventList (): Map<WebViewEventType, (...args: any) => void> { return this._componentEventList; }\r\n    get webview (): HTMLIFrameElement | null { return this._webview; }\r\n    get state (): WebViewEventType { return this._state; }\r\n    get UICamera (): Camera | null {\r\n        return director.root!.batcher2D.getFirstRenderCamera(this._node!);\r\n    }\r\n\r\n    protected dispatchEvent (key: WebViewEventType, ...args: any[any]): void {\r\n        const callback = this._componentEventList.get(key);\r\n        if (callback) {\r\n            this._state = key;\r\n            callback.call(this, args);\r\n        }\r\n    }\r\n\r\n    public destroy (): void {\r\n        this.removeWebView();\r\n        this._wrapper = null;\r\n        this._webview = null;\r\n        this._loaded = false;\r\n        this._component = null;\r\n        this._uiTrans = null;\r\n        this._forceUpdate = false;\r\n        this._componentEventList.clear();\r\n    }\r\n}\r\n\r\nlegacyCC.internal.WebViewImpl = WebViewImpl;\r\n","/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { screenAdapter } from 'pal/screen-adapter';\r\nimport { WebViewEventType } from './web-view-enums';\r\nimport { error, warn } from '../core/platform';\r\nimport { WebViewImpl } from './web-view-impl';\r\nimport { game } from '../game';\r\nimport { mat4 } from '../core/math';\r\nimport { contains } from '../core/utils/misc';\r\nimport { ccwindow } from '../core/global-exports';\r\nimport type { WebView } from './web-view';\r\n\r\nconst ccdocument = ccwindow.document;\r\n\r\nconst _mat4_temp = mat4();\r\n\r\n/** @mangle */\r\nexport class WebViewImplWeb extends WebViewImpl {\r\n    constructor (component: WebView) {\r\n        super(component);\r\n    }\r\n\r\n    _bindDomEvent (): void {\r\n        if (!this.webview) {\r\n            return;\r\n        }\r\n        const onLoaded = (e: Event): void => {\r\n            this._forceUpdate = true;\r\n            this.dispatchEvent(WebViewEventType.LOADED);\r\n\r\n            const iframe = e.target as HTMLIFrameElement;\r\n            const body = iframe.contentDocument && iframe.contentDocument.body;\r\n            if (body && body.innerHTML.includes('404')) {\r\n                this.dispatchEvent(WebViewEventType.ERROR, body.innerHTML);\r\n            }\r\n        };\r\n\r\n        this.webview.addEventListener('load', onLoaded);\r\n    }\r\n\r\n    public loadURL (url: string): void {\r\n        if (this.webview) {\r\n            this.webview.src = url;\r\n            // emit loading event\r\n            this.dispatchEvent(WebViewEventType.LOADING);\r\n        }\r\n    }\r\n\r\n    public createWebView (): void {\r\n        const wrapper = ccdocument.createElement('div');\r\n        this._wrapper = wrapper;\r\n        wrapper.id = 'webview-wrapper';\r\n        const wrapperStyle = wrapper.style;\r\n        wrapperStyle['-webkit-overflow'] = 'auto';\r\n        wrapperStyle['-webkit-overflow-scrolling'] = 'touch';\r\n        wrapperStyle.position = 'absolute';\r\n        wrapperStyle.bottom = '0px';\r\n        wrapperStyle.left = '0px';\r\n        wrapperStyle.transformOrigin = '0px 100% 0px';\r\n        wrapperStyle['-webkit-transform-origin'] = '0px 100% 0px';\r\n        game.container!.appendChild(wrapper);\r\n\r\n        const webview = ccdocument.createElement('iframe');\r\n        this._webview = webview;\r\n        const webviewStyle = webview.style;\r\n        webview.id = 'webview';\r\n        webviewStyle.border = 'none';\r\n        webviewStyle.width = '100%';\r\n        webviewStyle.height = '100%';\r\n        wrapper.appendChild(webview);\r\n        this._bindDomEvent();\r\n    }\r\n\r\n    public removeWebView (): void {\r\n        const wrapper = this._wrapper;\r\n        if (contains(game.container, wrapper)) {\r\n            game.container!.removeChild(wrapper);\r\n        }\r\n        this.reset();\r\n    }\r\n\r\n    public enable (): void {\r\n        if (this._wrapper) {\r\n            this._wrapper.style.visibility = 'visible';\r\n        }\r\n    }\r\n\r\n    public disable (): void {\r\n        if (this._wrapper) {\r\n            this._wrapper.style.visibility = 'hidden';\r\n        }\r\n    }\r\n\r\n    public evaluateJS (str: string): void {\r\n        if (this.webview) {\r\n            const win = this.webview.contentWindow;\r\n            if (win) {\r\n                try {\r\n                    win.eval(str);\r\n                } catch (e) {\r\n                    this.dispatchEvent(WebViewEventType.ERROR, e);\r\n                    error(e);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public setOnJSCallback (callback: () => void): void {\r\n        warn('The platform does not support');\r\n    }\r\n\r\n    public setJavascriptInterfaceScheme (scheme: string): void {\r\n        warn('The platform does not support');\r\n    }\r\n\r\n    public syncMatrix (): void {\r\n        if (!this._wrapper || !this._uiTrans || !this._component || this._wrapper.style.visibility === 'hidden') return;\r\n\r\n        const camera = this.UICamera;\r\n        if (!camera) {\r\n            return;\r\n        }\r\n\r\n        this._component.node.getWorldMatrix(_mat4_temp);\r\n        camera.update(true);\r\n        camera.worldMatrixToScreen(_mat4_temp, _mat4_temp, game.canvas!.width, game.canvas!.height);\r\n\r\n        const { width, height } = this._uiTrans.contentSize;\r\n        if (!this._forceUpdate\r\n            && this._m00 === _mat4_temp.m00 && this._m01 === _mat4_temp.m01\r\n            && this._m04 === _mat4_temp.m04 && this._m05 === _mat4_temp.m05\r\n            && this._m12 === _mat4_temp.m12 && this._m13 === _mat4_temp.m13\r\n            && this._w === width && this._h === height) {\r\n            return;\r\n        }\r\n\r\n        // update matrix cache\r\n        this._m00 = _mat4_temp.m00;\r\n        this._m01 = _mat4_temp.m01;\r\n        this._m04 = _mat4_temp.m04;\r\n        this._m05 = _mat4_temp.m05;\r\n        this._m12 = _mat4_temp.m12;\r\n        this._m13 = _mat4_temp.m13;\r\n        this._w = width;\r\n        this._h = height;\r\n\r\n        // TODO: implement webView in PAL\r\n        const dpr = screenAdapter.devicePixelRatio;\r\n        const scaleX = 1 / dpr;\r\n        const scaleY = 1 / dpr;\r\n\r\n        const container = game.container!;\r\n        const sx = _mat4_temp.m00 * scaleX;\r\n        const b = _mat4_temp.m01;\r\n        const c = _mat4_temp.m04;\r\n        const sy = _mat4_temp.m05 * scaleY;\r\n\r\n        this._wrapper.style.width = `${width}px`;\r\n        this._wrapper.style.height = `${height}px`;\r\n        const w = this._w * scaleX;\r\n        const h = this._h * scaleY;\r\n\r\n        const appx = (w * _mat4_temp.m00) * this._uiTrans.anchorX;\r\n        const appy = (h * _mat4_temp.m05) * this._uiTrans.anchorY;\r\n\r\n        const offsetX = container && container.style.paddingLeft ? parseInt(container.style.paddingLeft) : 0;\r\n        const offsetY = container && container.style.paddingBottom ? parseInt(container.style.paddingBottom) : 0;\r\n        const tx = _mat4_temp.m12 * scaleX - appx + offsetX;\r\n        const ty = _mat4_temp.m13 * scaleY - appy + offsetY;\r\n\r\n        const matrix = `matrix(${sx},${-b},${-c},${sy},${tx},${-ty})`;\r\n        this._wrapper.style.transform = matrix;\r\n        this._wrapper.style['-webkit-transform'] = matrix;\r\n        this._forceUpdate = false;\r\n    }\r\n}\r\n","/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { legacyCC } from '../core/global-exports';\r\nimport type { WebView } from './web-view';\r\nimport { WebViewImplWeb } from './web-view-impl-web';\r\n\r\nexport class WebViewImplManager {\r\n    // default web\r\n    static getImpl (component: WebView): WebViewImplWeb {\r\n        return new WebViewImplWeb(component);\r\n    }\r\n}\r\n\r\nlegacyCC.internal.WebViewImplManager = WebViewImplManager;\r\n","/*\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { ccclass, help, executeInEditMode, menu, tooltip, type, displayOrder, serializable, requireComponent } from 'cc.decorator';\r\nimport { EDITOR_NOT_IN_PREVIEW } from 'internal:constants';\r\nimport { UITransform } from '../2d/framework';\r\nimport { Component, EventHandler as ComponentEventHandler } from '../scene-graph';\r\nimport { WebViewImplManager } from './web-view-impl-manager';\r\nimport { WebViewEventType } from './web-view-enums';\r\nimport { legacyCC } from '../core/global-exports';\r\nimport type { WebViewImpl  } from './web-view-impl';\r\n\r\n/**\r\n * @en\r\n * WebView component, used to display web pages in the game.\r\n * Since different platforms have different authorizations, APIs, and control methods for WebView components, there is no unified standard yet.\r\n * So currently only Web, iOS, and Android platforms are supported.\r\n * @zh\r\n * WebView 组件，用于在游戏中显示网页。\r\n * 由于不同平台对于 WebView 组件的授权、API、控制方式都不同，还没有形成统一的标准，所以目前只支持 Web、iOS 和 Android 平台。\r\n */\r\n@ccclass('cc.WebView')\r\n@help('i18n:cc.WebView')\r\n@menu('Miscellaneous/WebView')\r\n@requireComponent(UITransform)\r\n@executeInEditMode\r\nexport class WebView extends Component {\r\n    @serializable\r\n    protected _url = 'https://cocos.com';\r\n\r\n    protected _impl: WebViewImpl | null = null;\r\n\r\n    /**\r\n     * @en WebView event type.\r\n     * @zh 网页视图事件类型。\r\n     */\r\n    public static EventType = WebViewEventType;\r\n\r\n    constructor () {\r\n        super();\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * A given URL to be loaded by the WebView, it should have a http or https prefix.\r\n     * @zh\r\n     * 指定 WebView 加载的网址，它应该是一个 http 或者 https 开头的字符串。\r\n     */\r\n    @tooltip('i18n:webview.url')\r\n    get url (): string {\r\n        return this._url;\r\n    }\r\n    set url (val: string) {\r\n        this._url = val;\r\n        if (this._impl) {\r\n            this._impl.loadURL(val);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * The webview's event callback, it will be triggered after the loading is completed or when the loading error occurs.\r\n     * @zh\r\n     * WebView 的回调事件，当网页加载过程中，加载完成后或者加载出错时都会回调此函数。\r\n     */\r\n    @serializable\r\n    @type([ComponentEventHandler])\r\n    @displayOrder(20)\r\n    @tooltip('i18n:webview.webviewEvents')\r\n    public webviewEvents: ComponentEventHandler[] = [];\r\n\r\n    /**\r\n     * @en\r\n     * Raw webview objects for user customization.\r\n     * @zh\r\n     * 原始网页对象，用于用户定制。\r\n     */\r\n    get nativeWebView (): HTMLIFrameElement | null {\r\n        return (this._impl && this._impl.webview) || null;\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * Gets the current webview state.\r\n     * @zh\r\n     * 获取当前网页视图状态。\r\n     */\r\n    get state (): WebViewEventType {\r\n        if (!this._impl) { return WebViewEventType.NONE; }\r\n        return this._impl.state;\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * Sets javascript interface scheme (see also setOnJSCallback).\r\n     * Note: Supports only on the Android and iOS. For HTML5, please refer to the official documentation.\r\n     * Please refer to the official documentation for more details.\r\n     * @zh\r\n     * 设置 JavaScript 接口方案（与 'setOnJSCallback' 配套使用）。\r\n     * 注意：只支持 Android 和 iOS ，Web 端用法请前往官方文档查看。\r\n     * 详情请参阅官方文档\r\n     * @method setJavascriptInterfaceScheme\r\n     * @param {String} scheme\r\n     */\r\n    public setJavascriptInterfaceScheme (scheme: string): void {\r\n        if (this._impl) {\r\n            this._impl.setJavascriptInterfaceScheme(scheme);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * This callback called when load URL that start with javascript\r\n     * interface scheme (see also setJavascriptInterfaceScheme).\r\n     * Note: Supports only on the Android and iOS. For HTML5, please refer to the official documentation.\r\n     * Please refer to the official documentation for more details.\r\n     * @zh\r\n     * 当加载 URL 以 JavaScript 接口方案开始时调用这个回调函数。\r\n     * 注意：只支持 Android 和 iOS，Web 端用法请前往官方文档查看。\r\n     * 详情请参阅官方文档。\r\n     * @method setOnJSCallback\r\n     * @param {Function} callback\r\n     */\r\n    public setOnJSCallback (callback: () => void): void {\r\n        if (this._impl) {\r\n            this._impl.setOnJSCallback(callback);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en\r\n     * Evaluates JavaScript in the context of the currently displayed page.\r\n     * Please refer to the official document for more details\r\n     * Note: Cross domain issues need to be resolved by yourself\r\n     * @zh\r\n     * 执行 WebView 内部页面脚本（详情请参阅官方文档）。\r\n     * 注意：需要自行解决跨域问题。\r\n     * @method evaluateJS\r\n     * @param {String} str\r\n     */\r\n    public evaluateJS (str: string): void {\r\n        if (this._impl) {\r\n            this._impl.evaluateJS(str);\r\n        }\r\n    }\r\n\r\n    public __preload (): void {\r\n        if (EDITOR_NOT_IN_PREVIEW) {\r\n            return;\r\n        }\r\n        this._impl = WebViewImplManager.getImpl(this);\r\n        const { componentEventList } = this._impl;\r\n        // must be register the event listener\r\n        componentEventList.set(WebViewEventType.LOADING, this.onLoading.bind(this));\r\n        componentEventList.set(WebViewEventType.LOADED, this.onLoaded.bind(this));\r\n        componentEventList.set(WebViewEventType.ERROR, this.onError.bind(this));\r\n        this._impl.loadURL(this._url);\r\n    }\r\n\r\n    private onLoading (): void {\r\n        ComponentEventHandler.emitEvents(this.webviewEvents, this, WebViewEventType.LOADING);\r\n        this.node.emit(WebViewEventType.LOADING, this);\r\n    }\r\n\r\n    private onLoaded (): void {\r\n        ComponentEventHandler.emitEvents(this.webviewEvents, this, WebViewEventType.LOADED);\r\n        this.node.emit(WebViewEventType.LOADED, this);\r\n    }\r\n\r\n    private onError (...args: any[any]): void {\r\n        ComponentEventHandler.emitEvents(this.webviewEvents, this, WebViewEventType.ERROR, args);\r\n        this.node.emit(WebViewEventType.ERROR, this, args);\r\n    }\r\n\r\n    public onEnable (): void {\r\n        if (this._impl) {\r\n            this._impl.enable();\r\n        }\r\n    }\r\n\r\n    public onDisable (): void {\r\n        if (this._impl) {\r\n            this._impl.disable();\r\n        }\r\n    }\r\n\r\n    public onDestroy (): void {\r\n        if (this._impl) {\r\n            this._impl.destroy();\r\n            this._impl = null;\r\n        }\r\n    }\r\n\r\n    public update (dt: number): void {\r\n        if (this._impl) {\r\n            this._impl.syncMatrix();\r\n        }\r\n    }\r\n}\r\n\r\n// TODO Since jsb adapter does not support import cc, put it on internal first and adjust it later.\r\nlegacyCC.internal.WebView = WebView;\r\n"],"names":["WebViewEventType","WebViewImpl","component","this","_componentEventList","Map","_state","NONE","_wrapper","_webview","_loaded","_forceUpdate","_component","_uiTrans","_node","_w","_h","_m00","_m01","_m04","_m05","_m12","_m13","node","getComponent","UITransform","reset","createWebView","_proto","prototype","dispatchEvent","key","callback","get","_len","arguments","length","args","Array","_key","call","destroy","removeWebView","clear","_createClass","director","root","batcher2D","getFirstRenderCamera","legacyCC","internal","ccdocument","ccwindow","document","_mat4_temp","mat4","WebViewImplWeb","_WebViewImpl","_inheritsLoose","_bindDomEvent","_this","webview","addEventListener","e","LOADED","iframe","target","body","contentDocument","innerHTML","includes","ERROR","loadURL","url","src","LOADING","wrapper","createElement","id","wrapperStyle","style","position","bottom","left","transformOrigin","game","container","appendChild","webviewStyle","border","width","height","contains","removeChild","enable","visibility","disable","evaluateJS","str","win","contentWindow","eval","error","setOnJSCallback","warn","setJavascriptInterfaceScheme","syncMatrix","camera","UICamera","getWorldMatrix","update","worldMatrixToScreen","canvas","_this$_uiTrans$conten","contentSize","m00","m01","m04","m05","m12","m13","dpr","screenAdapter","devicePixelRatio","scaleX","scaleY","sx","b","c","sy","w","h","appx","anchorX","appy","anchorY","offsetX","paddingLeft","parseInt","offsetY","paddingBottom","matrix","tx","transform","WebViewImplManager","getImpl","WebView","ccclass","requireComponent","type","ComponentEventHandler","_dec","_class","_dec2","_class3","_Component","_url","_initializer","_impl","webviewEvents","_initializer2","scheme","__preload","componentEventList","set","onLoading","bind","onLoaded","onError","emitEvents","emit","onEnable","onDisable","onDestroy","val","state","Component","EventType","_class2","serializable","_applyDecoratedInitializer","_dec3"],"mappings":"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"}